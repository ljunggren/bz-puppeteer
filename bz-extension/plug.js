window.extensionContent=chrome.runtime.id;document.documentElement.setAttribute('bz-id',chrome.runtime.id);var _compressJSON={
  _version:"BZ-0.001",
  _CHAR:"",
  _string:"",
  // _isBZCompressedData:function(o){
  //   if(_compressJSON._chkDataType(o,String)){
  //     return o.indexOf(this._version)==0;
  //   }
  //   return false;
  // },
  // _newKey:function(){
  //   var c="";
  //   for(var i=0;i<this._len;i++){
  //     c+=this._CHAR[this._idx[i]];
  //     if (i+1==this._len) { 
  //       this._idx[i]++;
  //     }
  //   }
  //   for(var i=this._len-1;i>=0;i--){
  //     if (this._idx[i]>=this._CHAR.length) {
  //       this._idx[i]=0;
  //       if (i==0) {
  //         this._idx.push(0);
  //         this._len++;
  //       }else{
  //         this._idx[i-1]++;
  //       }
  //     }else{
  //       break;
  //     }
  //   }
  //   return c;
  // },
  _unConvert:function(o){
    if(!o){
      return o;
    }
    var t=JSON.stringify(o);
    var rs=t.match(/&#[0-9]+;/g);
    if (rs) {
      for(var i=0;i<rs.length;i++){
        t=t.replace(rs[i],String.fromCharCode(parseInt(rs[i].substring(2))));
      }
      try{
        eval("t="+t);
      }catch(e){
        console.log(t)
      }
      return t;
    }else{
      return o;
    }
  },
  _convertToEntities:function(tstr) {
    if(!tstr||tstr.constructor!=String){
      return tstr;
    }
    var bstr = "";
    for(i = 0; i < tstr.length; ++i){
      if(tstr.charCodeAt(i) > 127){
        bstr += "&#" + tstr.charCodeAt(i) + ";";
      }else{
        bstr += tstr.charAt(i);
      }
    }
    return bstr;
  },
  // _init:function(o){
  //   var _CHAR="0123456789ABCDEFGHIJKLMNOPQRSTUVWXZYabcdefghijklmnopqrstuvwxzy-_";
  //   var _MARK="`~!@#$%^&*()|;<>?/ +";
  //   //var _MARK="";
  //   this._string=_compressJSON._convertToEntities(JSON.stringify(o));
  //   for(var i=0;i<_MARK.length;i++){
  //     var v=_MARK[i];
  //     if (this._string.indexOf(v)>=0) {
  //       _MARK=_MARK.replace(v,"")
  //       i--;
  //     }
  //   }
  //   this._words=this._getWords(o);
  //   this._CHAR=_CHAR+_MARK;

  //   this._WS_REGEXP=new RegExp("[^a-zA-Z0-9-_"+_MARK+"]+");
  //   this._MS_REGEXP=new RegExp("[a-zA-Z0-9-_"+_MARK+"]+");
  //   this._idx=[0];
  //   this._len=1;
  // },
  // _getWords:function(o){
  //   var ws=[];
  //   if(_compressJSON._chkDataType(o,Object)){
  //     for(var k in o){
  //       ws.push(k);
  //       var nws=this._getWords(o[k]);
  //       for(var i=0;i<nws.length;i++){
  //         ws.push(nws[i]);
  //       }
  //     }
  //   }else if(_compressJSON._chkDataType(o,Array)){
  //     for(var n=0;n<o.length;n++){
  //       var nws=this._getWords(o[n]);
  //       for(var i=0;i<nws.length;i++){
  //         ws.push(nws[i]);
  //       }
  //     }
  //   }else{
  //     if(o){
  //       o=o.toString();
  //       return o.split(/[^a-zA-Z0-9-_]+/);
  //     }else if(o==false){
  //       return ["false"];
  //     }
  //     return ["null"];
  //   }
  //   return ws;
  // },
  // _pareparyCompressKeys:function(){
  //   var _keys={};
  //   var vs=this._words;
  //   for(var i=0;i<vs.length;i++){
  //     var v=vs[i];
  //     if (!_keys[v]) {
  //       _keys[v]=0;
  //     }
  //     if (v!="null") {
  //       _keys[v]++;
  //     }
  //   }
  //   var ks=[];
  //   for(var k in _keys){
  //     var i=k.length;
  //     var n=_keys[k];
  //     var v=n*i-1-i-n-1;
  //     if(v>0){
  //       ks.push({k:k,v:v,n:n});
  //     }
  //   }

  //   ks.sort(function(a,b){
  //     if(a.v<b.v){
  //       return 1;
  //     }else{
  //       return -1;
  //     }
  //   });
  //   for(var l=0;l<ks.length;l++){
  //     var k=ks[l];
  //     while (true) {
  //       var c=this._newKey();
  //       if (!_keys[c]) {
  //         k.nk=c;
  //         break;
  //       }
  //     }
  //     var m=k.nk.length;
  //     var i=k.k.length;
  //     var n=k.n;
  //     var v=n*i-m-i-n*m-1;
      
  //     if (v<0) {
  //       ks.splice(l);
  //       break;
  //     }
  //     k.v=v;
  //   }
  //   this._keys={};
  //   var v="";
  //   var l=1;
  //   for(var i=0;i<ks.length;i++){
  //     var k=ks[i];
  //     this._keys[k.k]=k.nk;
  //     if (k.nk.length>l) {
  //       l=k.nk.length;
  //       v+=":";
  //     }
  //     v+=k.nk+k.k+",";
  //   }
  //   this._keyString=v.substring(0,v.length-1);
  // },
  // _buildString:function(o,_bKey){
  //   var _string="";
  //   if (_compressJSON._chkDataType(o,Array)) {
  //     _string+="["
  //     for(var i=0;i<o.length;i++){
  //       var v=o[i];
  //       if(v!==undefined){
  //         _string+=this._buildString(v);
  //         if (i+1<o.length) {
  //           _string+=",";
  //         }
  //       }
  //     }
  //     _string+="]";
  //   }else if (_compressJSON._chkDataType(o,Object)) {
  //     _string+="{"
  //     for(var k in o){
  //       var v=o[k];
  //       if(v!==undefined){
  //         _string+=this._buildString(k,true);
  //         v=this._buildString(v);
  //         if (v[0]!="{" && v[0]!="[") {
  //           _string+=":";
  //         }
  //         _string+=v+",";
  //       }
  //     }
  //     if(_string[_string.length-1]==","){
  //       _string=_string.substring(0,_string.length-1);
  //     }
  //     _string+="}";
  //   }else if (o=="null" && !_bKey) {
  //     _string= "'null'";
  //   }else if (JSON.stringify(o)=="null") {
  //     _string= "null";
  //   }else if (JSON.stringify(o)=="\"\"") {
  //     _string= "''";
  //   }else if (JSON.stringify(o)=="0") {
  //     _string=0;
  //   }else if (o=="''") {
  //     _string= "\\'\\'";
  //   }else if (o=="\\'\\'") {
  //     _string= "\\\\'\\\\'";
  //   }else if(typeof o=="string" || (o=="object" && JSON.stringify(o)[0]=='"')){
  //     if (o=="object" && JSON.stringify(o)[0]=='"') {
  //       o=JSON.stringify(o);
  //     }
  //     o=_compressJSON._convertToEntities(o);
  //     var ws=o.split(this._WS_REGEXP);
  //     var ms=null;
  //     if (_bKey) {
  //       ms=o.match(/[^\.\[\]a-zA-Z0-9_\u4E00-\u9FCC]+/);
  //       // if (ms){
  //         // ms=o.match(/(\&\#[0-9]+\;)+/g)
  //         // if(!ms||ms[0]!=o){
  //           // throw new Error(_bzMessage._system._error._keyFormat);
  //         // }
  //       // }
  //       ms=[];
  //     }else{
  //       ms=o.split(this._MS_REGEXP);
  //     }
  //     for(var i=0;i<ws.length;i++){
  //       var w=this._keys[ws[i]];
  //       if (w) {
  //         ws[i]=w;
  //       }
  //     }
  //     for(var i=0;i<ms.length;i++){
  //       var w=ms[i];
  //       var ww="";
  //       if (w) {
  //         for(var n=0;n<w.length;n++){
  //           if ("\\{}[],".indexOf(w[n])>=0) {
  //             ww+="\\";
  //           }
  //           ww+=w[n];
  //         }
  //         ms[i]=ww;
  //       }
  //     }
  //     var s1=ws;
  //     var s2=ms;
  //     if (s2.length>s1.length) {
  //       s1=ms;
  //       s2=ws;
  //     }else if (s2.length==s1.length && !s2[0]) {
  //       s1=ms;
  //       s2=ws;
  //     }
  //     for(var i=0;i<s1.length;i++){
  //       _string+=s1[i];
  //       if (s2.length>i) {
  //         _string+=s2[i];
  //       }
  //     }

  //     if (!_bKey) {
  //       if (parseFloat(o)+""==o) {
  //         _string="'"+_string+"'";
  //       }else if (o=="true" || o=="false") {
  //         _string="'"+_string+"'";
  //       }else if (Date.parse(o)) {
  //         if(JSON.stringify(new Date(o)).indexOf(o)>=0){
  //           _string="'"+_string+"'";
  //         }
  //       }
  //     }
  //   }else if(_compressJSON._isNumber(o)){
  //     o=JSON.stringify(o);
      
  //     var w=this._buildString(o);
  //     o=w.replace(/'/g,"");
  //     _string= o;
  //   }else if(_compressJSON._chkDataType(o,Date)){
  //     eval("o="+JSON.stringify(o));
  //     var w=this._buildString(o);
  //     o=w.replace(/'/g,"");
  //     _string= o;
  //   }else if(_compressJSON._chkDataType(o,Boolean)){
  //     _string=o.toString();
  //   }
  //   return _string;
  // },
  _chkDataType:function(o,t){
    return o!==undefined&&o!=null&&o.constructor==t
  },
  // _isNumber:function(o){
  //   return o!==undefined&&o!=null&&(o.constructor==Number||(o.constructor==String&&o.match(/^[-0-9\.]+$/)))
  // },
  // _isStringOnlyObject:function(o){
  //   for(var k in o){
  //     var v=o[k];
  //     if(_compressJSON._chkDataType(o,Object) || _compressJSON._chkDataType(o,Array)){
  //       if(!this._isStringOnlyObject(v)){
  //         return false;
  //       }
  //     }else if(!_compressJSON._chkDataType(o,String)){
  //       return false;
  //     }
  //   }
  //   return true;
  // },
  _compress:function(o){
    return JSON.stringify(o)
//     var t=Date.now();
//     if (!_compressJSON._chkDataType(o,Object) && !_compressJSON._chkDataType(o,Array)) {
//       if(this._isBZCompressedData(o)){
//         return o;
//       }
//       return JSON.stringify(o);
//     }

//     this._init(o);
//     this._pareparyCompressKeys();
//     var v=this._keyString;
    
//     try{
//       v=this._version+":"+v+this._buildString(o);
//       if(this._string.length<v.length){
//         return this._string;
//       }
//       var t1=Date.now();
//       var no=this._unCompress(v);
//       /* debug *
// //      console.log("Compress time: "+(t1-t));
// //      console.log("UnCompress time: "+(Date.now()-t1));
// //      console.log("Result: "+(this._string==_compressJSON._convertToEntities(JSON.stringify(no))));
// //      console.log("old length: "+this._string.length);
// //      console.log("new length: "+v.length);
// //      console.log("%: "+(this._string.length-v.length)/this._string.length);
// //      console.log(v);
// //      console.log(this._keys);
//       /**/
//       if(this._string!=_compressJSON._convertToEntities(JSON.stringify(no))){
//         return this._string;
//       }
//       return v;
//     }catch(e){
//       _Util._alertMessage(e.message,e);
//     }
  },
  _pareparyUnCompressKeys:function(ks){
    ks=ks.split(":");
    this._keys={};
    var _MARK="";
    for(var i=0;i<ks.length;i++){
      var k=ks[i];
      var ii=i+1;
      var ws=k.split(",");
      for(var n=0;n<ws.length;n++){
        var w=ws[n];
        this._keys[w.substring(0,ii)]=w.substring(ii);
        if(ii==1 && w.substring(0,ii).match(/[^a-zA-Z0-9-_]/)){
          _MARK+=w.substring(0,ii);
        }
      }
    }
    this._WS_REGEXP=new RegExp("[^a-zA-Z0-9-_"+_MARK+"]+");
    this._MS_REGEXP=new RegExp("[a-zA-Z0-9-_"+_MARK+"]+");
  },
  _handleObjValue:function(v){
    if(v){
      if(v.constructor==Object && v.constructor==Array){
        for(var k in v){
          v[k]=this._handleObjValue(v[k]);
        }
      }else{
        return _compressJSON._unConvert(v);
      }
    }
    return v;
  },
  _unCompress:function(v){
    if(!v || _compressJSON._chkDataType(v,Object)|| _compressJSON._chkDataType(v,Array)){
      return v;
    }
    var o=null;
    if(v.indexOf(this._version)==0){
      v=v.substring(this._version.length+1);
    }else{
      try{
        var _toTranslate=v.includes("&#");
        eval("v="+v);
        if(_toTranslate){
          v=this._handleObjValue(v);
        }
        return v;
      }catch(e){
        if(_Util && _Util._alertMessage){
          _Util._alertMessage(_bzMessage._system._error._dataFormat);
        }
        return;
      }
    }
    if (v && v[0]=='"') {
      eval("o="+v);
      return o;
    }else{
      var i=v.indexOf("{");
      var ii=v.indexOf("[");
      if ((i>ii && ii>=0) || i==-1) {
        i=ii;
      }
      this._pareparyUnCompressKeys(v.substring(0,i));
      var ws=v.substring(i);
      o=this._buildObj(ws);
      return o;
    }
  },
  _getOldWord:function(k){
    var v=this._keys[k];
    if (v) {
      return v;
    }else{
      return k;
    }
  },
  _insertNewObj:function(_objs,_key,o){
    var _obj=_objs[0];
    if (!_obj) {
      _objs.unshift(o);
    }else if (_key+"") {
      _key=this._getOldWord(_key);
      _obj[_key]=o;
      _objs.unshift(_obj[_key]);
    }else{
      _obj.push(o);
      _objs.unshift(o);
    }
  },
  _handleValue:function(v){
    if (v=="'null'") {
      return "null";
    }else if (v=="null") {
      return null;
    }else if (v=="''") {
      return ""
    }else if (v=="\\'\\'") {
      return "''";
    }else if (v=="\\\\'\\\\'") {
      return "\\'\\'";
    }else{
      var ws=v.split(this._WS_REGEXP);
      var ms=v.split(this._MS_REGEXP);
      v="";
      for(var i=0;i<ws.length;i++){
        ws[i]=this._getOldWord(ws[i]);
      }
      var s1=ws;
      var s2=ms;
      
      if (s2.length>s1.length) {
        s1=ms;
        s2=ws;
      }else if (s2.length==s1.length && !s2[0]) {
        s1=ms;
        s2=ws;
      }
      
      for(var i=0;i<s1.length;i++){
        v+=s1[i];
        if (s2.length>i) {
          v+=s2[i];
        }
      }

      if (v[0]=="'") {
        try{
          var w="";
          eval("w="+v);
          v=w;
        }catch(e){}
      }else if (parseFloat(v)+""==v) {
        return parseFloat(v);
      }else if (v=="true") {
        return true;
      }else if (v=="false") {
        return false;
      }else if(Date.parse(v)){
        if(JSON.stringify(new Date(v)).indexOf(v)>=0){
          return new Date(v);
        }
      }
    }
    v=_compressJSON._unConvert(v);
    return v;
  },
  _buildObj:function(ws){
    var _lastObj=null;
    var _objs=[];
    var _key="";
    var _value=undefined;
    var _braces=[];
    var _brackets=[];
    var _afterBack=false;
    var _inKey=false;
    for(var i=0;i<ws.length;i++){
      var w=ws[i];
      if (w=="\\") {
        _afterBack=!_afterBack;
        if (_afterBack) {
          continue;
        }
      }else if (w=="{") {
        if (!_afterBack) {
          this._insertNewObj(_objs,_key,{});
          _key="";
          _value=undefined;
          _inKey=true;
          continue;
        }
      }else if (w=="[") {
        if (!_afterBack) {
          this._insertNewObj(_objs,_key,[]);
          _key="";
          _value=undefined;
          _inKey=false;
          continue;
        }
      }else if (w==":") {
        if (_inKey) {
          _inKey=false;
          _value=undefined;
          continue;
        }
      }else if (w=="}") {
        if (!_afterBack) {
          if (_key && _value!==undefined) {
            _key=this._getOldWord(_key);
            _objs[0][_key]=this._handleValue(_value);
          }
          _lastObj=_objs.shift();
          _key="";
          _value=undefined;
          if (_compressJSON._chkDataType(_objs[0],Array)) {
            _inKey=false;
          }else{
            _inKey=true;
          }
          continue;
        }
      }else if (w=="]") {
        if (!_afterBack) {
          if (_value!=undefined) {
            _objs[0].push(this._handleValue(_value));
            _value=undefined;
          }
          _lastObj=_objs.shift();
          if (_compressJSON._chkDataType(_objs[0],Array)) {
            _inKey=false;
          }else{
            _inKey=true;
          }
          continue;
        }
      }else if (w==",") {
        if (!_afterBack) {
          if (_value&&_compressJSON._chkDataType(_objs[0],Array)) {
            if (_value!=undefined) {
              _objs[0].push(this._handleValue(_value));
            }
          }else if(_key && _value!==undefined){
            _key=this._getOldWord(_key);
            _objs[0][_key]=this._handleValue(_value);
            _inKey=true;
          }
          _key="";
          _value=undefined;
          continue;
        }
      }
      if (_inKey) {
        _key+=w;
      }else if(_value!=undefined){
        _value+=w;
      }else{
        _value=w;
      }
      if (_afterBack) {
        _afterBack=false;
      }
    }
    return _lastObj;
  }
}

try{
  exports._compress =_compressJSON;
}catch(e){};/*jQuery*/
!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=[],d=a.document,e=c.slice,f=c.concat,g=c.push,h=c.indexOf,i={},j=i.toString,k=i.hasOwnProperty,l={},m="1.12.4",n=function(a,b){return new n.fn.init(a,b)},o=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,p=/^-ms-/,q=/-([\da-z])/gi,r=function(a,b){return b.toUpperCase()};n.fn=n.prototype={jquery:m,constructor:n,selector:"",length:0,toArray:function(){return e.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:e.call(this)},pushStack:function(a){var b=n.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a){return n.each(this,a)},map:function(a){return this.pushStack(n.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(e.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor()},push:g,sort:c.sort,splice:c.splice},n.extend=n.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||n.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(e=arguments[h]))for(d in e)a=g[d],c=e[d],g!==c&&(j&&c&&(n.isPlainObject(c)||(b=n.isArray(c)))?(b?(b=!1,f=a&&n.isArray(a)?a:[]):f=a&&n.isPlainObject(a)?a:{},g[d]=n.extend(j,f,c)):void 0!==c&&(g[d]=c));return g},n.extend({expando:"jQuery"+(m+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray||function(a){return"array"===n.type(a)},isWindow:function(a){return null!=a&&a==a.window},isNumeric:function(a){var b=a&&a.toString();return!n.isArray(a)&&b-parseFloat(b)+1>=0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},isPlainObject:function(a){var b;if(!a||"object"!==n.type(a)||a.nodeType||n.isWindow(a))return!1;try{if(a.constructor&&!k.call(a,"constructor")&&!k.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}if(!l.ownFirst)for(b in a)return k.call(a,b);for(b in a);return void 0===b||k.call(a,b)},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?i[j.call(a)]||"object":typeof a},globalEval:function(b){b&&n.trim(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},camelCase:function(a){return a.replace(p,"ms-").replace(q,r)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b){var c,d=0;if(s(a)){for(c=a.length;c>d;d++)if(b.call(a[d],d,a[d])===!1)break}else for(d in a)if(b.call(a[d],d,a[d])===!1)break;return a},trim:function(a){return null==a?"":(a+"").replace(o,"")},makeArray:function(a,b){var c=b||[];return null!=a&&(s(Object(a))?n.merge(c,"string"==typeof a?[a]:a):g.call(c,a)),c},inArray:function(a,b,c){var d;if(b){if(h)return h.call(b,a,c);for(d=b.length,c=c?0>c?Math.max(0,d+c):c:0;d>c;c++)if(c in b&&b[c]===a)return c}return-1},merge:function(a,b){var c=+b.length,d=0,e=a.length;while(c>d)a[e++]=b[d++];if(c!==c)while(void 0!==b[d])a[e++]=b[d++];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,e,g=0,h=[];if(s(a))for(d=a.length;d>g;g++)e=b(a[g],g,c),null!=e&&h.push(e);else for(g in a)e=b(a[g],g,c),null!=e&&h.push(e);return f.apply([],h)},guid:1,proxy:function(a,b){var c,d,f;return"string"==typeof b&&(f=a[b],b=a,a=f),n.isFunction(a)?(c=e.call(arguments,2),d=function(){return a.apply(b||this,c.concat(e.call(arguments)))},d.guid=a.guid=a.guid||n.guid++,d):void 0},now:function(){return+new Date},support:l}),"function"==typeof Symbol&&(n.fn[Symbol.iterator]=c[Symbol.iterator]),n.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(a,b){i["[object "+b+"]"]=b.toLowerCase()});function s(a){var b=!!a&&"length"in a&&a.length,c=n.type(a);return"function"===c||n.isWindow(a)?!1:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var t=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u="sizzle"+1*new Date,v=a.document,w=0,x=0,y=ga(),z=ga(),A=ga(),B=function(a,b){return a===b&&(l=!0),0},C=1<<31,D={}.hasOwnProperty,E=[],F=E.pop,G=E.push,H=E.push,I=E.slice,J=function(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1},K="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",L="[\\x20\\t\\r\\n\\f]",M="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",N="\\["+L+"*("+M+")(?:"+L+"*([*^$|!~]?=)"+L+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+M+"))|)"+L+"*\\]",O=":("+M+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+N+")*)|.*)\\)|)",P=new RegExp(L+"+","g"),Q=new RegExp("^"+L+"+|((?:^|[^\\\\])(?:\\\\.)*)"+L+"+$","g"),R=new RegExp("^"+L+"*,"+L+"*"),S=new RegExp("^"+L+"*([>+~]|"+L+")"+L+"*"),T=new RegExp("="+L+"*([^\\]'\"]*?)"+L+"*\\]","g"),U=new RegExp(O),V=new RegExp("^"+M+"$"),W={ID:new RegExp("^#("+M+")"),CLASS:new RegExp("^\\.("+M+")"),TAG:new RegExp("^("+M+"|[*])"),ATTR:new RegExp("^"+N),PSEUDO:new RegExp("^"+O),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+L+"*(even|odd|(([+-]|)(\\d*)n|)"+L+"*(?:([+-]|)"+L+"*(\\d+)|))"+L+"*\\)|)","i"),bool:new RegExp("^(?:"+K+")$","i"),needsContext:new RegExp("^"+L+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+L+"*((?:-\\d)?\\d*)"+L+"*\\)|)(?=[^-]|$)","i")},X=/^(?:input|select|textarea|button)$/i,Y=/^h\d$/i,Z=/^[^{]+\{\s*\[native \w/,$=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,_=/[+~]/,aa=/'|\\/g,ba=new RegExp("\\\\([\\da-f]{1,6}"+L+"?|("+L+")|.)","ig"),ca=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)},da=function(){m()};try{H.apply(E=I.call(v.childNodes),v.childNodes),E[v.childNodes.length].nodeType}catch(ea){H={apply:E.length?function(a,b){G.apply(a,I.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function fa(a,b,d,e){var f,h,j,k,l,o,r,s,w=b&&b.ownerDocument,x=b?b.nodeType:9;if(d=d||[],"string"!=typeof a||!a||1!==x&&9!==x&&11!==x)return d;if(!e&&((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,p)){if(11!==x&&(o=$.exec(a)))if(f=o[1]){if(9===x){if(!(j=b.getElementById(f)))return d;if(j.id===f)return d.push(j),d}else if(w&&(j=w.getElementById(f))&&t(b,j)&&j.id===f)return d.push(j),d}else{if(o[2])return H.apply(d,b.getElementsByTagName(a)),d;if((f=o[3])&&c.getElementsByClassName&&b.getElementsByClassName)return H.apply(d,b.getElementsByClassName(f)),d}if(c.qsa&&!A[a+" "]&&(!q||!q.test(a))){if(1!==x)w=b,s=a;else if("object"!==b.nodeName.toLowerCase()){(k=b.getAttribute("id"))?k=k.replace(aa,"\\$&"):b.setAttribute("id",k=u),r=g(a),h=r.length,l=V.test(k)?"#"+k:"[id='"+k+"']";while(h--)r[h]=l+" "+qa(r[h]);s=r.join(","),w=_.test(a)&&oa(b.parentNode)||b}if(s)try{return H.apply(d,w.querySelectorAll(s)),d}catch(y){}finally{k===u&&b.removeAttribute("id")}}}return i(a.replace(Q,"$1"),b,d,e)}function ga(){var a=[];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b[a.shift()],b[c+" "]=e}return b}function ha(a){return a[u]=!0,a}function ia(a){var b=n.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function ja(a,b){var c=a.split("|"),e=c.length;while(e--)d.attrHandle[c[e]]=b}function ka(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||C)-(~a.sourceIndex||C);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function la(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function ma(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function na(a){return ha(function(b){return b=+b,ha(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function oa(a){return a&&"undefined"!=typeof a.getElementsByTagName&&a}c=fa.support={},f=fa.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},m=fa.setDocument=function(a){var b,e,g=a?a.ownerDocument||a:v;return g!==n&&9===g.nodeType&&g.documentElement?(n=g,o=n.documentElement,p=!f(n),(e=n.defaultView)&&e.top!==e&&(e.addEventListener?e.addEventListener("unload",da,!1):e.attachEvent&&e.attachEvent("onunload",da)),c.attributes=ia(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=ia(function(a){return a.appendChild(n.createComment("")),!a.getElementsByTagName("*").length}),c.getElementsByClassName=Z.test(n.getElementsByClassName),c.getById=ia(function(a){return o.appendChild(a).id=u,!n.getElementsByName||!n.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if("undefined"!=typeof b.getElementById&&p){var c=b.getElementById(a);return c?[c]:[]}},d.filter.ID=function(a){var b=a.replace(ba,ca);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(ba,ca);return function(a){var c="undefined"!=typeof a.getAttributeNode&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return"undefined"!=typeof b.getElementsByTagName?b.getElementsByTagName(a):c.qsa?b.querySelectorAll(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return"undefined"!=typeof b.getElementsByClassName&&p?b.getElementsByClassName(a):void 0},r=[],q=[],(c.qsa=Z.test(n.querySelectorAll))&&(ia(function(a){o.appendChild(a).innerHTML="<a id='"+u+"'></a><select id='"+u+"-\r\\' msallowcapture=''><option selected=''></option></select>",a.querySelectorAll("[msallowcapture^='']").length&&q.push("[*^$]="+L+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||q.push("\\["+L+"*(?:value|"+K+")"),a.querySelectorAll("[id~="+u+"-]").length||q.push("~="),a.querySelectorAll(":checked").length||q.push(":checked"),a.querySelectorAll("a#"+u+"+*").length||q.push(".#.+[+~]")}),ia(function(a){var b=n.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&q.push("name"+L+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||q.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),q.push(",.*:")})),(c.matchesSelector=Z.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&ia(function(a){c.disconnectedMatch=s.call(a,"div"),s.call(a,"[s!='']:x"),r.push("!=",O)}),q=q.length&&new RegExp(q.join("|")),r=r.length&&new RegExp(r.join("|")),b=Z.test(o.compareDocumentPosition),t=b||Z.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===n||a.ownerDocument===v&&t(v,a)?-1:b===n||b.ownerDocument===v&&t(v,b)?1:k?J(k,a)-J(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,e=a.parentNode,f=b.parentNode,g=[a],h=[b];if(!e||!f)return a===n?-1:b===n?1:e?-1:f?1:k?J(k,a)-J(k,b):0;if(e===f)return ka(a,b);c=a;while(c=c.parentNode)g.unshift(c);c=b;while(c=c.parentNode)h.unshift(c);while(g[d]===h[d])d++;return d?ka(g[d],h[d]):g[d]===v?-1:h[d]===v?1:0},n):n},fa.matches=function(a,b){return fa(a,null,null,b)},fa.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(T,"='$1']"),c.matchesSelector&&p&&!A[b+" "]&&(!r||!r.test(b))&&(!q||!q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return fa(b,n,null,[a]).length>0},fa.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},fa.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle[b.toLowerCase()],f=e&&D.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},fa.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},fa.uniqueSort=function(a){var b,d=[],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return k=null,a},e=fa.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=fa.selectors={cacheLength:50,createPseudo:ha,match:W,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(ba,ca),a[3]=(a[3]||a[4]||a[5]||"").replace(ba,ca),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||fa.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&fa.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return W.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||"":c&&U.test(c)&&(b=g(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(ba,ca).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y[a+" "];return b||(b=new RegExp("(^|"+L+")"+a+"("+L+"|$)"))&&y(a,function(a){return b.test("string"==typeof a.className&&a.className||"undefined"!=typeof a.getAttribute&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=fa.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e.replace(P," ")+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h,t=!1;if(q){if(f){while(p){m=b;while(m=m[p])if(h?m.nodeName.toLowerCase()===r:1===m.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){m=q,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n&&j[2],m=n&&q.childNodes[n];while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if(1===m.nodeType&&++t&&m===b){k[a]=[w,n,t];break}}else if(s&&(m=b,l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),j=k[a]||[],n=j[0]===w&&j[1],t=n),t===!1)while(m=++n&&m&&m[p]||(t=n=0)||o.pop())if((h?m.nodeName.toLowerCase()===r:1===m.nodeType)&&++t&&(s&&(l=m[u]||(m[u]={}),k=l[m.uniqueID]||(l[m.uniqueID]={}),k[a]=[w,t]),m===b))break;return t-=e,t===d||t%d===0&&t/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||fa.error("unsupported pseudo: "+a);return e[u]?e(b):e.length>1?(c=[a,a,"",b],d.setFilters.hasOwnProperty(a.toLowerCase())?ha(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=J(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:ha(function(a){var b=[],c=[],d=h(a.replace(Q,"$1"));return d[u]?ha(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),b[0]=null,!c.pop()}}),has:ha(function(a){return function(b){return fa(a,b).length>0}}),contains:ha(function(a){return a=a.replace(ba,ca),function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:ha(function(a){return V.test(a||"")||fa.error("unsupported lang: "+a),a=a.replace(ba,ca).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return Y.test(a.nodeName)},input:function(a){return X.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:na(function(){return[0]}),last:na(function(a,b){return[b-1]}),eq:na(function(a,b,c){return[0>c?c+b:c]}),even:na(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:na(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:na(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:na(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=la(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=ma(b);function pa(){}pa.prototype=d.filters=d.pseudos,d.setFilters=new pa,g=fa.tokenize=function(a,b){var c,e,f,g,h,i,j,k=z[a+" "];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){c&&!(e=R.exec(h))||(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=S.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(Q," ")}),h=h.slice(c.length));for(g in d.filter)!(e=W[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?fa.error(a):z(a,i).slice(0)};function qa(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function ra(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=x++;return b.first?function(b,c,f){while(b=b[d])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j,k=[w,f];if(g){while(b=b[d])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b[d])if(1===b.nodeType||e){if(j=b[u]||(b[u]={}),i=j[b.uniqueID]||(j[b.uniqueID]={}),(h=i[d])&&h[0]===w&&h[1]===f)return k[2]=h[2];if(i[d]=k,k[2]=a(b,c,g))return!0}}}function sa(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function ta(a,b,c){for(var d=0,e=b.length;e>d;d++)fa(a,b[d],c);return c}function ua(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(c&&!c(f,d,e)||(g.push(f),j&&b.push(h)));return g}function va(a,b,c,d,e,f){return d&&!d[u]&&(d=va(d)),e&&!e[u]&&(e=va(e,f)),ha(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||ta(b||"*",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:ua(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=ua(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?J(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=ua(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):H.apply(g,r)})}function wa(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],h=g||d.relative[" "],i=g?1:0,k=ra(function(a){return a===b},h,!0),l=ra(function(a){return J(b,a)>-1},h,!0),m=[function(a,c,d){var e=!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d));return b=null,e}];f>i;i++)if(c=d.relative[a[i].type])m=[ra(sa(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;f>e;e++)if(d.relative[a[e].type])break;return va(i>1&&sa(m),i>1&&qa(a.slice(0,i-1).concat({value:" "===a[i-2].type?"*":""})).replace(Q,"$1"),c,e>i&&wa(a.slice(i,e)),f>e&&wa(a=a.slice(e)),f>e&&qa(a))}m.push(c)}return sa(m)}function xa(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,h,i,k){var l,o,q,r=0,s="0",t=f&&[],u=[],v=j,x=f||e&&d.find.TAG("*",k),y=w+=null==v?1:Math.random()||.1,z=x.length;for(k&&(j=g===n||g||k);s!==z&&null!=(l=x[s]);s++){if(e&&l){o=0,g||l.ownerDocument===n||(m(l),h=!p);while(q=a[o++])if(q(l,g||n,h)){i.push(l);break}k&&(w=y)}c&&((l=!q&&l)&&r--,f&&t.push(l))}if(r+=s,c&&s!==r){o=0;while(q=b[o++])q(t,u,g,h);if(f){if(r>0)while(s--)t[s]||u[s]||(u[s]=F.call(i));u=ua(u)}H.apply(i,u),k&&!f&&u.length>0&&r+b.length>1&&fa.uniqueSort(i)}return k&&(w=y,j=v),t};return c?ha(f):f}return h=fa.compile=function(a,b){var c,d=[],e=[],f=A[a+" "];if(!f){b||(b=g(a)),c=b.length;while(c--)f=wa(b[c]),f[u]?d.push(f):e.push(f);f=A(a,xa(e,d)),f.selector=a}return f},i=fa.select=function(a,b,e,f){var i,j,k,l,m,n="function"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||[],1===o.length){if(j=o[0]=o[0].slice(0),j.length>2&&"ID"===(k=j[0]).type&&c.getById&&9===b.nodeType&&p&&d.relative[j[1].type]){if(b=(d.find.ID(k.matches[0].replace(ba,ca),b)||[])[0],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=W.needsContext.test(a)?0:j.length;
jQuery._inHidden=0;
j.sort((a,b)=>{
  if(a.type==b.type){
    if(a.type=="PSEUDO"){
      if(a.matches[0]=="hidden"){
        jQuery._inHidden=1;
        return -1
      }else if(b.matches[0]=="hidden"){
        jQuery._inHidden=1;
        return 1
      }
      if(a.matches[0]=="attr"){
        return -1
      }else if(b.matches[0]=="attr"){
        return 1
      }
    }
  }else if(a.type=="PSEUDO"){
    return 1
  }else if(b.type=="PSEUDO"){
    return -1
  }
  return 0
});
while(i--){if(k=j[i],d.relative[l=k.type])break;if((m=d.find[l])&&(f=m(k.matches[0].replace(ba,ca),_.test(j[0].type)&&oa(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&qa(j),!a)return H.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,!b||_.test(a)&&oa(b.parentNode)||b),e},c.sortStable=u.split("").sort(B).join("")===u,c.detectDuplicates=!!l,m(),c.sortDetached=ia(function(a){return 1&a.compareDocumentPosition(n.createElement("div"))}),ia(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||ja("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&ia(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||ja("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),ia(function(a){return null==a.getAttribute("disabled")})||ja(K,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),fa}(a);n.find=t,n.expr=t.selectors,n.expr[":"]=n.expr.pseudos,n.uniqueSort=n.unique=t.uniqueSort,n.text=t.getText,n.isXMLDoc=t.isXML,n.contains=t.contains;var u=function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&n(a).is(c))break;d.push(a)}return d},v=function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c},w=n.expr.match.needsContext,x=/^<([\w-]+)\s*\/?>(?:<\/\1>|)$/,y=/^.[^:#\[\.,]*$/;function z(a,b,c){if(n.isFunction(b))return n.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return n.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(y.test(b))return n.filter(b,a,c);b=n.filter(b,a)}return n.grep(a,function(a){return n.inArray(a,b)>-1!==c})}n.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?n.find.matchesSelector(d,a)?[d]:[]:n.find.matches(a,n.grep(b,function(a){return 1===a.nodeType}))},n.fn.extend({find:function(a,_panel){jQuery.tmpPanel=_panel;var b,c=[],d=this,e=d.length;if("string"!=typeof a)return this.pushStack(n(a).filter(function(){for(b=0;e>b;b++)if(n.contains(d[b],this))return!0}));for(b=0;e>b;b++)n.find(a,d[b],c);return c=this.pushStack(e>1?n.unique(c):c),c.selector=this.selector?this.selector+" "+a:a,c},filter:function(a){return this.pushStack(z(this,a||[],!1))},not:function(a){return this.pushStack(z(this,a||[],!0))},is:function(a){return!!z(this,"string"==typeof a&&w.test(a)?n(a):a||[],!1).length}});var A,B=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,C=n.fn.init=function(a,b,c){var e,f;if(!a)return this;if(c=c||A,"string"==typeof a){if(e="<"===a.charAt(0)&&">"===a.charAt(a.length-1)&&a.length>=3?[null,a,null]:B.exec(a),!e||!e[1]&&b)return!b||b.jquery?(b||c).find(a):this.constructor(b).find(a);if(e[1]){if(b=b instanceof n?b[0]:b,n.merge(this,n.parseHTML(e[1],b&&b.nodeType?b.ownerDocument||b:d,!0)),x.test(e[1])&&n.isPlainObject(b))for(e in b)n.isFunction(this[e])?this[e](b[e]):this.attr(e,b[e]);return this}if(f=d.getElementById(e[2]),f&&f.parentNode){if(f.id!==e[2])return A.find(a);this.length=1,this[0]=f}return this.context=d,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):n.isFunction(a)?"undefined"!=typeof c.ready?c.ready(a):a(n):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),n.makeArray(a,this))};C.prototype=n.fn,A=n(d);var D=/^(?:parents|prev(?:Until|All))/,E={children:!0,contents:!0,next:!0,prev:!0};n.fn.extend({has:function(a){var b,c=n(a,this),d=c.length;return this.filter(function(){for(b=0;d>b;b++)if(n.contains(this,c[b]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=w.test(a)||"string"!=typeof a?n(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&n.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?n.uniqueSort(f):f)},index:function(a){return a?"string"==typeof a?n.inArray(this[0],n(a)):n.inArray(a.jquery?a[0]:a,this):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(n.uniqueSort(n.merge(this.get(),n(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function F(a,b){do a=a[b];while(a&&1!==a.nodeType);return a}n.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return u(a,"parentNode")},parentsUntil:function(a,b,c){return u(a,"parentNode",c)},next:function(a){return F(a,"nextSibling")},prev:function(a){return F(a,"previousSibling")},nextAll:function(a){return u(a,"nextSibling")},prevAll:function(a){return u(a,"previousSibling")},nextUntil:function(a,b,c){return u(a,"nextSibling",c)},prevUntil:function(a,b,c){return u(a,"previousSibling",c)},siblings:function(a){return v((a.parentNode||{}).firstChild,a)},children:function(a){return v(a.firstChild)},contents:function(a){return n.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:n.merge([],a.childNodes)}},function(a,b){n.fn[a]=function(c,d){var e=n.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=n.filter(d,e)),this.length>1&&(E[a]||(e=n.uniqueSort(e)),D.test(a)&&(e=e.reverse())),this.pushStack(e)}});var G=/\S+/g;function H(a){var b={};return n.each(a.match(G)||[],function(a,c){b[c]=!0}),b}n.Callbacks=function(a){a="string"==typeof a?H(a):n.extend({},a);var b,c,d,e,f=[],g=[],h=-1,i=function(){for(e=a.once,d=b=!0;g.length;h=-1){c=g.shift();while(++h<f.length)f[h].apply(c[0],c[1])===!1&&a.stopOnFalse&&(h=f.length,c=!1)}a.memory||(c=!1),b=!1,e&&(f=c?[]:"")},j={add:function(){return f&&(c&&!b&&(h=f.length-1,g.push(c)),function d(b){n.each(b,function(b,c){n.isFunction(c)?a.unique&&j.has(c)||f.push(c):c&&c.length&&"string"!==n.type(c)&&d(c)})}(arguments),c&&!b&&i()),this},remove:function(){return n.each(arguments,function(a,b){var c;while((c=n.inArray(b,f,c))>-1)f.splice(c,1),h>=c&&h--}),this},has:function(a){return a?n.inArray(a,f)>-1:f.length>0},empty:function(){return f&&(f=[]),this},disable:function(){return e=g=[],f=c="",this},disabled:function(){return!f},lock:function(){return e=!0,c||j.disable(),this},locked:function(){return!!e},fireWith:function(a,c){return e||(c=c||[],c=[a,c.slice?c.slice():c],g.push(c),b||i()),this},fire:function(){return j.fireWith(this,arguments),this},fired:function(){return!!d}};return j},n.extend({Deferred:function(a){var b=[["resolve","done",n.Callbacks("once memory"),"resolved"],["reject","fail",n.Callbacks("once memory"),"rejected"],["notify","progress",n.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return n.Deferred(function(c){n.each(b,function(b,f){var g=n.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&n.isFunction(a.promise)?a.promise().progress(c.notify).done(c.resolve).fail(c.reject):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?n.extend(a,d):d}},e={};return d.pipe=d.then,n.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=e.call(arguments),d=c.length,f=1!==d||a&&n.isFunction(a.promise)?d:0,g=1===f?a:n.Deferred(),h=function(a,b,c){return function(d){b[a]=this,c[a]=arguments.length>1?e.call(arguments):d,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(d>1)for(i=new Array(d),j=new Array(d),k=new Array(d);d>b;b++)c[b]&&n.isFunction(c[b].promise)?c[b].promise().progress(h(b,j,i)).done(h(b,k,c)).fail(g.reject):--f;return f||g.resolveWith(k,c),g.promise()}});var I;n.fn.ready=function(a){return n.ready.promise().done(a),this},n.extend({isReady:!1,readyWait:1,holdReady:function(a){a?n.readyWait++:n.ready(!0)},ready:function(a){(a===!0?--n.readyWait:n.isReady)||(n.isReady=!0,a!==!0&&--n.readyWait>0||(I.resolveWith(d,[n]),n.fn.triggerHandler&&(n(d).triggerHandler("ready"),n(d).off("ready"))))}});function J(){d.addEventListener?(d.removeEventListener("DOMContentLoaded",K),a.removeEventListener("load",K)):(d.detachEvent("onreadystatechange",K),a.detachEvent("onload",K))}function K(){(d.addEventListener||"load"===a.event.type||"complete"===d.readyState)&&(J(),n.ready())}n.ready.promise=function(b){if(!I)if(I=n.Deferred(),"complete"===d.readyState||"loading"!==d.readyState&&!d.documentElement.doScroll)a.setTimeout(n.ready);else if(d.addEventListener)d.addEventListener("DOMContentLoaded",K),a.addEventListener("load",K);else{d.attachEvent("onreadystatechange",K),a.attachEvent("onload",K);var c=!1;try{c=null==a.frameElement&&d.documentElement}catch(e){}c&&c.doScroll&&!function f(){if(!n.isReady){try{c.doScroll("left")}catch(b){return a.setTimeout(f,50)}J(),n.ready()}}()}return I.promise(b)},n.ready.promise();var L;for(L in n(l))break;l.ownFirst="0"===L,l.inlineBlockNeedsLayout=!1,n(function(){var a,b,c,e;c=d.getElementsByTagName("body")[0],c&&c.style&&(b=d.createElement("div"),e=d.createElement("div"),e.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",c.appendChild(e).appendChild(b),"undefined"!=typeof b.style.zoom&&(b.style.cssText="display:inline;margin:0;border:0;padding:1px;width:1px;zoom:1",l.inlineBlockNeedsLayout=a=3===b.offsetWidth,a&&(c.style.zoom=1)),c.removeChild(e))}),function(){var a=d.createElement("div");l.deleteExpando=!0;try{delete a.test}catch(b){l.deleteExpando=!1}a=null}();var M=function(a){var b=n.noData[(a.nodeName+" ").toLowerCase()],c=+a.nodeType||1;return 1!==c&&9!==c?!1:!b||b!==!0&&a.getAttribute("classid")===b},N=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,O=/([A-Z])/g;function P(a,b,c){if(void 0===c&&1===a.nodeType){var d="data-"+b.replace(O,"-$1").toLowerCase();if(c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:N.test(c)?n.parseJSON(c):c}catch(e){}n.data(a,b,c)}else c=void 0;
}return c}function Q(a){var b;for(b in a)if(("data"!==b||!n.isEmptyObject(a[b]))&&"toJSON"!==b)return!1;return!0}function R(a,b,d,e){if(M(a)){var f,g,h=n.expando,i=a.nodeType,j=i?n.cache:a,k=i?a[h]:a[h]&&h;if(k&&j[k]&&(e||j[k].data)||void 0!==d||"string"!=typeof b)return k||(k=i?a[h]=c.pop()||n.guid++:h),j[k]||(j[k]=i?{}:{toJSON:n.noop}),"object"!=typeof b&&"function"!=typeof b||(e?j[k]=n.extend(j[k],b):j[k].data=n.extend(j[k].data,b)),g=j[k],e||(g.data||(g.data={}),g=g.data),void 0!==d&&(g[n.camelCase(b)]=d),"string"==typeof b?(f=g[b],null==f&&(f=g[n.camelCase(b)])):f=g,f}}function S(a,b,c){if(M(a)){var d,e,f=a.nodeType,g=f?n.cache:a,h=f?a[n.expando]:n.expando;if(g[h]){if(b&&(d=c?g[h]:g[h].data)){n.isArray(b)?b=b.concat(n.map(b,n.camelCase)):b in d?b=[b]:(b=n.camelCase(b),b=b in d?[b]:b.split(" ")),e=b.length;while(e--)delete d[b[e]];if(c?!Q(d):!n.isEmptyObject(d))return}(c||(delete g[h].data,Q(g[h])))&&(f?n.cleanData([a],!0):l.deleteExpando||g!=g.window?delete g[h]:g[h]=void 0)}}}n.extend({cache:{},noData:{"applet ":!0,"embed ":!0,"object ":"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"},hasData:function(a){return a=a.nodeType?n.cache[a[n.expando]]:a[n.expando],!!a&&!Q(a)},data:function(a,b,c){return R(a,b,c)},removeData:function(a,b){return S(a,b)},_data:function(a,b,c){return R(a,b,c,!0)},_removeData:function(a,b){return S(a,b,!0)}}),n.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=n.data(f),1===f.nodeType&&!n._data(f,"parsedAttrs"))){c=g.length;while(c--)g[c]&&(d=g[c].name,0===d.indexOf("data-")&&(d=n.camelCase(d.slice(5)),P(f,d,e[d])));n._data(f,"parsedAttrs",!0)}return e}return"object"==typeof a?this.each(function(){n.data(this,a)}):arguments.length>1?this.each(function(){n.data(this,a,b)}):f?P(f,a,n.data(f,a)):void 0},removeData:function(a){return this.each(function(){n.removeData(this,a)})}}),n.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=n._data(a,b),c&&(!d||n.isArray(c)?d=n._data(a,b,n.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=n.queue(a,b),d=c.length,e=c.shift(),f=n._queueHooks(a,b),g=function(){n.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return n._data(a,c)||n._data(a,c,{empty:n.Callbacks("once memory").add(function(){n._removeData(a,b+"queue"),n._removeData(a,c)})})}}),n.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?n.queue(this[0],a):void 0===b?this:this.each(function(){var c=n.queue(this,a,b);n._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&n.dequeue(this,a)})},dequeue:function(a){return this.each(function(){n.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=n.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=n._data(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}}),function(){var a;l.shrinkWrapBlocks=function(){if(null!=a)return a;a=!1;var b,c,e;return c=d.getElementsByTagName("body")[0],c&&c.style?(b=d.createElement("div"),e=d.createElement("div"),e.style.cssText="position:absolute;border:0;width:0;height:0;top:0;left:-9999px",c.appendChild(e).appendChild(b),"undefined"!=typeof b.style.zoom&&(b.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:1px;width:1px;zoom:1",b.appendChild(d.createElement("div")).style.width="5px",a=3!==b.offsetWidth),c.removeChild(e),a):void 0}}();var T=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,U=new RegExp("^(?:([+-])=|)("+T+")([a-z%]*)$","i"),V=["Top","Right","Bottom","Left"],W=function(a,b){return a=b||a,"none"===n.css(a,"display")||!n.contains(a.ownerDocument,a)};function X(a,b,c,d){var e,f=1,g=20,h=d?function(){return d.cur()}:function(){return n.css(a,b,"")},i=h(),j=c&&c[3]||(n.cssNumber[b]?"":"px"),k=(n.cssNumber[b]||"px"!==j&&+i)&&U.exec(n.css(a,b));if(k&&k[3]!==j){j=j||k[3],c=c||[],k=+i||1;do f=f||".5",k/=f,n.style(a,b,k+j);while(f!==(f=h()/i)&&1!==f&&--g)}return c&&(k=+k||+i||0,e=c[1]?k+(c[1]+1)*c[2]:+c[2],d&&(d.unit=j,d.start=k,d.end=e)),e}var Y=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===n.type(c)){e=!0;for(h in c)Y(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,n.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(n(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f},Z=/^(?:checkbox|radio)$/i,$=/<([\w:-]+)/,_=/^$|\/(?:java|ecma)script/i,aa=/^\s+/,ba="abbr|article|aside|audio|bdi|canvas|data|datalist|details|dialog|figcaption|figure|footer|header|hgroup|main|mark|meter|nav|output|picture|progress|section|summary|template|time|video";function ca(a){var b=ba.split("|"),c=a.createDocumentFragment();if(c.createElement)while(b.length)c.createElement(b.pop());return c}!function(){var a=d.createElement("div"),b=d.createDocumentFragment(),c=d.createElement("input");a.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",l.leadingWhitespace=3===a.firstChild.nodeType,l.tbody=!a.getElementsByTagName("tbody").length,l.htmlSerialize=!!a.getElementsByTagName("link").length,l.html5Clone="<:nav></:nav>"!==d.createElement("nav").cloneNode(!0).outerHTML,c.type="checkbox",c.checked=!0,b.appendChild(c),l.appendChecked=c.checked,a.innerHTML="<textarea>x</textarea>",l.noCloneChecked=!!a.cloneNode(!0).lastChild.defaultValue,b.appendChild(a),c=d.createElement("input"),c.setAttribute("type","radio"),c.setAttribute("checked","checked"),c.setAttribute("name","t"),a.appendChild(c),l.checkClone=a.cloneNode(!0).cloneNode(!0).lastChild.checked,l.noCloneEvent=!!a.addEventListener,a[n.expando]=1,l.attributes=!a.getAttribute(n.expando)}();var da={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],area:[1,"<map>","</map>"],param:[1,"<object>","</object>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:l.htmlSerialize?[0,"",""]:[1,"X<div>","</div>"]};da.optgroup=da.option,da.tbody=da.tfoot=da.colgroup=da.caption=da.thead,da.th=da.td;function ea(a,b){var c,d,e=0,f="undefined"!=typeof a.getElementsByTagName?a.getElementsByTagName(b||"*"):"undefined"!=typeof a.querySelectorAll?a.querySelectorAll(b||"*"):void 0;if(!f)for(f=[],c=a.childNodes||a;null!=(d=c[e]);e++)!b||n.nodeName(d,b)?f.push(d):n.merge(f,ea(d,b));return void 0===b||b&&n.nodeName(a,b)?n.merge([a],f):f}function fa(a,b){for(var c,d=0;null!=(c=a[d]);d++)n._data(c,"globalEval",!b||n._data(b[d],"globalEval"))}var ga=/<|&#?\w+;/,ha=/<tbody/i;function ia(a){Z.test(a.type)&&(a.defaultChecked=a.checked)}function ja(a,b,c,d,e){for(var f,g,h,i,j,k,m,o=a.length,p=ca(b),q=[],r=0;o>r;r++)if(g=a[r],g||0===g)if("object"===n.type(g))n.merge(q,g.nodeType?[g]:g);else if(ga.test(g)){i=i||p.appendChild(b.createElement("div")),j=($.exec(g)||["",""])[1].toLowerCase(),m=da[j]||da._default,i.innerHTML=m[1]+n.htmlPrefilter(g)+m[2],f=m[0];while(f--)i=i.lastChild;if(!l.leadingWhitespace&&aa.test(g)&&q.push(b.createTextNode(aa.exec(g)[0])),!l.tbody){g="table"!==j||ha.test(g)?"<table>"!==m[1]||ha.test(g)?0:i:i.firstChild,f=g&&g.childNodes.length;while(f--)n.nodeName(k=g.childNodes[f],"tbody")&&!k.childNodes.length&&g.removeChild(k)}n.merge(q,i.childNodes),i.textContent="";while(i.firstChild)i.removeChild(i.firstChild);i=p.lastChild}else q.push(b.createTextNode(g));i&&p.removeChild(i),l.appendChecked||n.grep(ea(q,"input"),ia),r=0;while(g=q[r++])if(d&&n.inArray(g,d)>-1)e&&e.push(g);else if(h=n.contains(g.ownerDocument,g),i=ea(p.appendChild(g),"script"),h&&fa(i),c){f=0;while(g=i[f++])_.test(g.type||"")&&c.push(g)}return i=null,p}!function(){var b,c,e=d.createElement("div");for(b in{submit:!0,change:!0,focusin:!0})c="on"+b,(l[b]=c in a)||(e.setAttribute(c,"t"),l[b]=e.attributes[c].expando===!1);e=null}();var ka=/^(?:input|select|textarea)$/i,la=/^key/,ma=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,na=/^(?:focusinfocus|focusoutblur)$/,oa=/^([^.]*)(?:\.(.+)|)/;function pa(){return!0}function qa(){return!1}function ra(){try{return d.activeElement}catch(a){}}function sa(a,b,c,d,e,f){var g,h;if("object"==typeof b){"string"!=typeof c&&(d=d||c,c=void 0);for(h in b)sa(a,h,c,d,b[h],f);return a}if(null==d&&null==e?(e=c,d=c=void 0):null==e&&("string"==typeof c?(e=d,d=void 0):(e=d,d=c,c=void 0)),e===!1)e=qa;else if(!e)return a;return 1===f&&(g=e,e=function(a){return n().off(a),g.apply(this,arguments)},e.guid=g.guid||(g.guid=n.guid++)),a.each(function(){n.event.add(this,b,e,d,c)})}n.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=n._data(a);if(r){c.handler&&(i=c,c=i.handler,e=i.selector),c.guid||(c.guid=n.guid++),(g=r.events)||(g=r.events={}),(k=r.handle)||(k=r.handle=function(a){return"undefined"==typeof n||a&&n.event.triggered===a.type?void 0:n.event.dispatch.apply(k.elem,arguments)},k.elem=a),b=(b||"").match(G)||[""],h=b.length;while(h--)f=oa.exec(b[h])||[],o=q=f[1],p=(f[2]||"").split(".").sort(),o&&(j=n.event.special[o]||{},o=(e?j.delegateType:j.bindType)||o,j=n.event.special[o]||{},l=n.extend({type:o,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&n.expr.match.needsContext.test(e),namespace:p.join(".")},i),(m=g[o])||(m=g[o]=[],m.delegateCount=0,j.setup&&j.setup.call(a,d,p,k)!==!1||(a.addEventListener?a.addEventListener(o,k,!1):a.attachEvent&&a.attachEvent("on"+o,k))),j.add&&(j.add.call(a,l),l.handler.guid||(l.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,l):m.push(l),n.event.global[o]=!0);a=null}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=n.hasData(a)&&n._data(a);if(r&&(k=r.events)){b=(b||"").match(G)||[""],j=b.length;while(j--)if(h=oa.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o){l=n.event.special[o]||{},o=(d?l.delegateType:l.bindType)||o,m=k[o]||[],h=h[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),i=f=m.length;while(f--)g=m[f],!e&&q!==g.origType||c&&c.guid!==g.guid||h&&!h.test(g.namespace)||d&&d!==g.selector&&("**"!==d||!g.selector)||(m.splice(f,1),g.selector&&m.delegateCount--,l.remove&&l.remove.call(a,g));i&&!m.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||n.removeEvent(a,o,r.handle),delete k[o])}else for(o in k)n.event.remove(a,o+b[j],c,d,!0);n.isEmptyObject(k)&&(delete r.handle,n._removeData(a,"events"))}},trigger:function(b,c,e,f){var g,h,i,j,l,m,o,p=[e||d],q=k.call(b,"type")?b.type:b,r=k.call(b,"namespace")?b.namespace.split("."):[];if(i=m=e=e||d,3!==e.nodeType&&8!==e.nodeType&&!na.test(q+n.event.triggered)&&(q.indexOf(".")>-1&&(r=q.split("."),q=r.shift(),r.sort()),h=q.indexOf(":")<0&&"on"+q,b=b[n.expando]?b:new n.Event(q,"object"==typeof b&&b),b.isTrigger=f?2:3,b.namespace=r.join("."),b.rnamespace=b.namespace?new RegExp("(^|\\.)"+r.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=e),c=null==c?[b]:n.makeArray(c,[b]),l=n.event.special[q]||{},f||!l.trigger||l.trigger.apply(e,c)!==!1)){if(!f&&!l.noBubble&&!n.isWindow(e)){for(j=l.delegateType||q,na.test(j+q)||(i=i.parentNode);i;i=i.parentNode)p.push(i),m=i;m===(e.ownerDocument||d)&&p.push(m.defaultView||m.parentWindow||a)}o=0;while((i=p[o++])&&!b.isPropagationStopped())b.type=o>1?j:l.bindType||q,g=(n._data(i,"events")||{})[b.type]&&n._data(i,"handle"),g&&g.apply(i,c),g=h&&i[h],g&&g.apply&&M(i)&&(b.result=g.apply(i,c),b.result===!1&&b.preventDefault());if(b.type=q,!f&&!b.isDefaultPrevented()&&(!l._default||l._default.apply(p.pop(),c)===!1)&&M(e)&&h&&e[q]&&!n.isWindow(e)){m=e[h],m&&(e[h]=null),n.event.triggered=q;try{e[q]()}catch(s){}n.event.triggered=void 0,m&&(e[h]=m)}return b.result}},dispatch:function(a){a=n.event.fix(a);var b,c,d,f,g,h=[],i=e.call(arguments),j=(n._data(this,"events")||{})[a.type]||[],k=n.event.special[a.type]||{};if(i[0]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=n.event.handlers.call(this,a,j),b=0;while((f=h[b++])&&!a.isPropagationStopped()){a.currentTarget=f.elem,c=0;while((g=f.handlers[c++])&&!a.isImmediatePropagationStopped())a.rnamespace&&!a.rnamespace.test(g.namespace)||(a.handleObj=g,a.data=g.data,d=((n.event.special[g.origType]||{}).handle||g.handler).apply(f.elem,i),void 0!==d&&(a.result=d)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&("click"!==a.type||isNaN(a.button)||a.button<1))for(;i!=this;i=i.parentNode||this)if(1===i.nodeType&&(i.disabled!==!0||"click"!==a.type)){for(d=[],c=0;h>c;c++)f=b[c],e=f.selector+" ",void 0===d[e]&&(d[e]=f.needsContext?n(e,this).index(i)>-1:n.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},fix:function(a){if(a[n.expando])return a;var b,c,e,f=a.type,g=a,h=this.fixHooks[f];h||(this.fixHooks[f]=h=ma.test(f)?this.mouseHooks:la.test(f)?this.keyHooks:{}),e=h.props?this.props.concat(h.props):this.props,a=new n.Event(g),b=e.length;while(b--)c=e[b],a[c]=g[c];return a.target||(a.target=g.srcElement||d),3===a.target.nodeType&&(a.target=a.target.parentNode),a.metaKey=!!a.metaKey,h.filter?h.filter(a,g):a},props:"altKey bubbles cancelable ctrlKey currentTarget detail eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,e,f,g=b.button,h=b.fromElement;return null==a.pageX&&null!=b.clientX&&(e=a.target.ownerDocument||d,f=e.documentElement,c=e.body,a.pageX=b.clientX+(f&&f.scrollLeft||c&&c.scrollLeft||0)-(f&&f.clientLeft||c&&c.clientLeft||0),a.pageY=b.clientY+(f&&f.scrollTop||c&&c.scrollTop||0)-(f&&f.clientTop||c&&c.clientTop||0)),!a.relatedTarget&&h&&(a.relatedTarget=h===a.target?b.toElement:h),a.which||void 0===g||(a.which=1&g?1:2&g?3:4&g?2:0),a}},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==ra()&&this.focus)try{return this.focus(),!1}catch(a){}},delegateType:"focusin"},blur:{trigger:function(){return this===ra()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return n.nodeName(this,"input")&&"checkbox"===this.type&&this.click?(this.click(),!1):void 0},_default:function(a){return n.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c){var d=n.extend(new n.Event,c,{type:a,isSimulated:!0});n.event.trigger(d,null,b),d.isDefaultPrevented()&&c.preventDefault()}},n.removeEvent=d.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c)}:function(a,b,c){var d="on"+b;a.detachEvent&&("undefined"==typeof a[d]&&(a[d]=null),a.detachEvent(d,c))},n.Event=function(a,b){return this instanceof n.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?pa:qa):this.type=a,b&&n.extend(this,b),this.timeStamp=a&&a.timeStamp||n.now(),void(this[n.expando]=!0)):new n.Event(a,b)},n.Event.prototype={constructor:n.Event,isDefaultPrevented:qa,isPropagationStopped:qa,isImmediatePropagationStopped:qa,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=pa,a&&(a.preventDefault?a.preventDefault():a.returnValue=!1)},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=pa,a&&!this.isSimulated&&(a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0)},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=pa,a&&a.stopImmediatePropagation&&a.stopImmediatePropagation(),this.stopPropagation()}},n.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(a,b){n.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return e&&(e===d||n.contains(d,e))||(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),l.submit||(n.event.special.submit={setup:function(){return n.nodeName(this,"form")?!1:void n.event.add(this,"click._submit keypress._submit",function(a){var b=a.target,c=n.nodeName(b,"input")||n.nodeName(b,"button")?n.prop(b,"form"):void 0;c&&!n._data(c,"submit")&&(n.event.add(c,"submit._submit",function(a){a._submitBubble=!0}),n._data(c,"submit",!0))})},postDispatch:function(a){a._submitBubble&&(delete a._submitBubble,this.parentNode&&!a.isTrigger&&n.event.simulate("submit",this.parentNode,a))},teardown:function(){return n.nodeName(this,"form")?!1:void n.event.remove(this,"._submit")}}),l.change||(n.event.special.change={setup:function(){return ka.test(this.nodeName)?("checkbox"!==this.type&&"radio"!==this.type||(n.event.add(this,"propertychange._change",function(a){"checked"===a.originalEvent.propertyName&&(this._justChanged=!0)}),n.event.add(this,"click._change",function(a){this._justChanged&&!a.isTrigger&&(this._justChanged=!1),n.event.simulate("change",this,a)})),!1):void n.event.add(this,"beforeactivate._change",function(a){var b=a.target;ka.test(b.nodeName)&&!n._data(b,"change")&&(n.event.add(b,"change._change",function(a){!this.parentNode||a.isSimulated||a.isTrigger||n.event.simulate("change",this.parentNode,a)}),n._data(b,"change",!0))})},handle:function(a){var b=a.target;return this!==b||a.isSimulated||a.isTrigger||"radio"!==b.type&&"checkbox"!==b.type?a.handleObj.handler.apply(this,arguments):void 0},teardown:function(){return n.event.remove(this,"._change"),!ka.test(this.nodeName)}}),l.focusin||n.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){n.event.simulate(b,a.target,n.event.fix(a))};n.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=n._data(d,b);e||d.addEventListener(a,c,!0),n._data(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=n._data(d,b)-1;e?n._data(d,b,e):(d.removeEventListener(a,c,!0),n._removeData(d,b))}}}),n.fn.extend({on:function(a,b,c,d){return sa(this,a,b,c,d)},one:function(a,b,c,d){return sa(this,a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,n(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return b!==!1&&"function"!=typeof b||(c=b,b=void 0),c===!1&&(c=qa),this.each(function(){n.event.remove(this,a,c,b)})},trigger:function(a,b){return this.each(function(){n.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?n.event.trigger(a,b,c,!0):void 0}});var ta=/ jQuery\d+="(?:null|\d+)"/g,ua=new RegExp("<(?:"+ba+")[\\s/>]","i"),va=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:-]+)[^>]*)\/>/gi,wa=/<script|<style|<link/i,xa=/checked\s*(?:[^=]|=\s*.checked.)/i,ya=/^true\/(.*)/,za=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,Aa=ca(d),Ba=Aa.appendChild(d.createElement("div"));function Ca(a,b){return n.nodeName(a,"table")&&n.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function Da(a){return a.type=(null!==n.find.attr(a,"type"))+"/"+a.type,a}function Ea(a){var b=ya.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function Fa(a,b){if(1===b.nodeType&&n.hasData(a)){var c,d,e,f=n._data(a),g=n._data(b,f),h=f.events;if(h){delete g.handle,g.events={};for(c in h)for(d=0,e=h[c].length;e>d;d++)n.event.add(b,c,h[c][d])}g.data&&(g.data=n.extend({},g.data))}}function Ga(a,b){var c,d,e;if(1===b.nodeType){if(c=b.nodeName.toLowerCase(),!l.noCloneEvent&&b[n.expando]){e=n._data(b);for(d in e.events)n.removeEvent(b,d,e.handle);b.removeAttribute(n.expando)}"script"===c&&b.text!==a.text?(Da(b).text=a.text,Ea(b)):"object"===c?(b.parentNode&&(b.outerHTML=a.outerHTML),l.html5Clone&&a.innerHTML&&!n.trim(b.innerHTML)&&(b.innerHTML=a.innerHTML)):"input"===c&&Z.test(a.type)?(b.defaultChecked=b.checked=a.checked,b.value!==a.value&&(b.value=a.value)):"option"===c?b.defaultSelected=b.selected=a.defaultSelected:"input"!==c&&"textarea"!==c||(b.defaultValue=a.defaultValue)}}function Ha(a,b,c,d){b=f.apply([],b);var e,g,h,i,j,k,m=0,o=a.length,p=o-1,q=b[0],r=n.isFunction(q);if(r||o>1&&"string"==typeof q&&!l.checkClone&&xa.test(q))return a.each(function(e){var f=a.eq(e);r&&(b[0]=q.call(this,e,f.html())),Ha(f,b,c,d)});if(o&&(k=ja(b,a[0].ownerDocument,!1,a,d),e=k.firstChild,1===k.childNodes.length&&(k=e),e||d)){for(i=n.map(ea(k,"script"),Da),h=i.length;o>m;m++)g=k,m!==p&&(g=n.clone(g,!0,!0),h&&n.merge(i,ea(g,"script"))),c.call(a[m],g,m);if(h)for(j=i[i.length-1].ownerDocument,n.map(i,Ea),m=0;h>m;m++)g=i[m],_.test(g.type||"")&&!n._data(g,"globalEval")&&n.contains(j,g)&&(g.src?n._evalUrl&&n._evalUrl(g.src):n.globalEval((g.text||g.textContent||g.innerHTML||"").replace(za,"")));k=e=null}return a}function Ia(a,b,c){for(var d,e=b?n.filter(b,a):a,f=0;null!=(d=e[f]);f++)c||1!==d.nodeType||n.cleanData(ea(d)),d.parentNode&&(c&&n.contains(d.ownerDocument,d)&&fa(ea(d,"script")),d.parentNode.removeChild(d));return a}n.extend({htmlPrefilter:function(a){return a.replace(va,"<$1></$2>")},clone:function(a,b,c){var d,e,f,g,h,i=n.contains(a.ownerDocument,a);if(l.html5Clone||n.isXMLDoc(a)||!ua.test("<"+a.nodeName+">")?f=a.cloneNode(!0):(Ba.innerHTML=a.outerHTML,Ba.removeChild(f=Ba.firstChild)),!(l.noCloneEvent&&l.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||n.isXMLDoc(a)))for(d=ea(f),h=ea(a),g=0;null!=(e=h[g]);++g)d[g]&&Ga(e,d[g]);if(b)if(c)for(h=h||ea(a),d=d||ea(f),g=0;null!=(e=h[g]);g++)Fa(e,d[g]);else Fa(a,f);return d=ea(f,"script"),d.length>0&&fa(d,!i&&ea(a,"script")),d=h=e=null,f},cleanData:function(a,b){for(var d,e,f,g,h=0,i=n.expando,j=n.cache,k=l.attributes,m=n.event.special;null!=(d=a[h]);h++)if((b||M(d))&&(f=d[i],g=f&&j[f])){if(g.events)for(e in g.events)m[e]?n.event.remove(d,e):n.removeEvent(d,e,g.handle);j[f]&&(delete j[f],k||"undefined"==typeof d.removeAttribute?d[i]=void 0:d.removeAttribute(i),c.push(f))}}}),n.fn.extend({domManip:Ha,detach:function(a){return Ia(this,a,!0)},remove:function(a){return Ia(this,a)},text:function(a){return Y(this,function(a){return void 0===a?n.text(this):this.empty().append((this[0]&&this[0].ownerDocument||d).createTextNode(a))},null,a,arguments.length)},append:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.appendChild(a)}})},prepend:function(){return Ha(this,arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=Ca(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return Ha(this,arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},empty:function(){for(var a,b=0;null!=(a=this[b]);b++){1===a.nodeType&&n.cleanData(ea(a,!1));while(a.firstChild)a.removeChild(a.firstChild);a.options&&n.nodeName(a,"select")&&(a.options.length=0)}return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return n.clone(this,a,b)})},html:function(a){return Y(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a)return 1===b.nodeType?b.innerHTML.replace(ta,""):void 0;if("string"==typeof a&&!wa.test(a)&&(l.htmlSerialize||!ua.test(a))&&(l.leadingWhitespace||!aa.test(a))&&!da[($.exec(a)||["",""])[1].toLowerCase()]){a=n.htmlPrefilter(a);try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(n.cleanData(ea(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=[];return Ha(this,arguments,function(b){var c=this.parentNode;n.inArray(this,a)<0&&(n.cleanData(ea(this)),c&&c.replaceChild(b,this))},a)}}),n.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){n.fn[a]=function(a){for(var c,d=0,e=[],f=n(a),h=f.length-1;h>=d;d++)c=d===h?this:this.clone(!0),n(f[d])[b](c),g.apply(e,c.get());return this.pushStack(e)}});var Ja,Ka={HTML:"block",BODY:"block"};function La(a,b){var c=n(b.createElement(a)).appendTo(b.body),d=n.css(c[0],"display");return c.detach(),d}function Ma(a){var b=d,c=Ka[a];return c||(c=La(a,b),"none"!==c&&c||(Ja=(Ja||n("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=(Ja[0].contentWindow||Ja[0].contentDocument).document,b.write(),b.close(),c=La(a,b),Ja.detach()),Ka[a]=c),c}var Na=/^margin/,Oa=new RegExp("^("+T+")(?!px)[a-z%]+$","i"),Pa=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e},Qa=d.documentElement;!function(){var b,c,e,f,g,h,i=d.createElement("div"),j=d.createElement("div");if(j.style){j.style.cssText="float:left;opacity:.5",l.opacity="0.5"===j.style.opacity,l.cssFloat=!!j.style.cssFloat,j.style.backgroundClip="content-box",j.cloneNode(!0).style.backgroundClip="",l.clearCloneStyle="content-box"===j.style.backgroundClip,i=d.createElement("div"),i.style.cssText="border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute",j.innerHTML="",i.appendChild(j),l.boxSizing=""===j.style.boxSizing||""===j.style.MozBoxSizing||""===j.style.WebkitBoxSizing,n.extend(l,{reliableHiddenOffsets:function(){return null==b&&k(),f},boxSizingReliable:function(){return null==b&&k(),e},pixelMarginRight:function(){return null==b&&k(),c},pixelPosition:function(){return null==b&&k(),b},reliableMarginRight:function(){return null==b&&k(),g},reliableMarginLeft:function(){return null==b&&k(),h}});function k(){var k,l,m=d.documentElement;m.appendChild(i),j.style.cssText="-webkit-box-sizing:border-box;box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%",b=e=h=!1,c=g=!0,a.getComputedStyle&&(l=a.getComputedStyle(j),b="1%"!==(l||{}).top,h="2px"===(l||{}).marginLeft,e="4px"===(l||{width:"4px"}).width,j.style.marginRight="50%",c="4px"===(l||{marginRight:"4px"}).marginRight,k=j.appendChild(d.createElement("div")),k.style.cssText=j.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",k.style.marginRight=k.style.width="0",j.style.width="1px",g=!parseFloat((a.getComputedStyle(k)||{}).marginRight),j.removeChild(k)),j.style.display="none",f=0===j.getClientRects().length,f&&(j.style.display="",j.innerHTML="<table><tr><td></td><td>t</td></tr></table>",j.childNodes[0].style.borderCollapse="separate",k=j.getElementsByTagName("td"),k[0].style.cssText="margin:0;border:0;padding:0;display:none",f=0===k[0].offsetHeight,f&&(k[0].style.display="",k[1].style.display="none",f=0===k[0].offsetHeight)),m.removeChild(i)}}}();var Ra,Sa,Ta=/^(top|right|bottom|left)$/;a.getComputedStyle?(Ra=function(b){var c=b.ownerDocument.defaultView;return c&&c.opener||(c=a),c.getComputedStyle(b)},Sa=function(a,b,c){var d,e,f,g,h=a.style;return c=c||Ra(a),g=c?c.getPropertyValue(b)||c[b]:void 0,""!==g&&void 0!==g||n.contains(a.ownerDocument,a)||(g=n.style(a,b)),c&&!l.pixelMarginRight()&&Oa.test(g)&&Na.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f),void 0===g?g:g+""}):Qa.currentStyle&&(Ra=function(a){return a.currentStyle},Sa=function(a,b,c){var d,e,f,g,h=a.style;return c=c||Ra(a),g=c?c[b]:void 0,null==g&&h&&h[b]&&(g=h[b]),Oa.test(g)&&!Ta.test(b)&&(d=h.left,e=a.runtimeStyle,f=e&&e.left,f&&(e.left=a.currentStyle.left),h.left="fontSize"===b?"1em":g,g=h.pixelLeft+"px",h.left=d,f&&(e.left=f)),void 0===g?g:g+""||"auto"});function Ua(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}var Va=/alpha\([^)]*\)/i,Wa=/opacity\s*=\s*([^)]*)/i,Xa=/^(none|table(?!-c[ea]).+)/,Ya=new RegExp("^("+T+")(.*)$","i"),Za={position:"absolute",visibility:"hidden",display:"block"},$a={letterSpacing:"0",fontWeight:"400"},_a=["Webkit","O","Moz","ms"],ab=d.createElement("div").style;function bb(a){if(a in ab)return a;var b=a.charAt(0).toUpperCase()+a.slice(1),c=_a.length;while(c--)if(a=_a[c]+b,a in ab)return a}function cb(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=n._data(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&W(d)&&(f[g]=n._data(d,"olddisplay",Ma(d.nodeName)))):(e=W(d),(c&&"none"!==c||!e)&&n._data(d,"olddisplay",e?c:n.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}function db(a,b,c){var d=Ya.exec(b);return d?Math.max(0,d[1]-(c||0))+(d[2]||"px"):b}function eb(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=n.css(a,c+V[f],!0,e)),d?("content"===c&&(g-=n.css(a,"padding"+V[f],!0,e)),"margin"!==c&&(g-=n.css(a,"border"+V[f]+"Width",!0,e))):(g+=n.css(a,"padding"+V[f],!0,e),"padding"!==c&&(g+=n.css(a,"border"+V[f]+"Width",!0,e)));return g}function fb(a,b,c){var d=!0,e="width"===b?a.offsetWidth:a.offsetHeight,f=Ra(a),g=l.boxSizing&&"border-box"===n.css(a,"boxSizing",!1,f);if(0>=e||null==e){if(e=Sa(a,b,f),(0>e||null==e)&&(e=a.style[b]),Oa.test(e))return e;d=g&&(l.boxSizingReliable()||e===a.style[b]),e=parseFloat(e)||0}return e+eb(a,b,c||(g?"border":"content"),d,f)+"px"}n.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=Sa(a,"opacity");return""===c?"1":c}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":l.cssFloat?"cssFloat":"styleFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=n.camelCase(b),i=a.style;if(b=n.cssProps[h]||(n.cssProps[h]=bb(h)||h),g=n.cssHooks[b]||n.cssHooks[h],void 0===c)return g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b];if(f=typeof c,"string"===f&&(e=U.exec(c))&&e[1]&&(c=X(a,b,e),f="number"),null!=c&&c===c&&("number"===f&&(c+=e&&e[3]||(n.cssNumber[h]?"":"px")),l.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),!(g&&"set"in g&&void 0===(c=g.set(a,c,d)))))try{i[b]=c}catch(j){}}},css:function(a,b,c,d){var e,f,g,h=n.camelCase(b);return b=n.cssProps[h]||(n.cssProps[h]=bb(h)||h),g=n.cssHooks[b]||n.cssHooks[h],g&&"get"in g&&(f=g.get(a,!0,c)),void 0===f&&(f=Sa(a,b,d)),"normal"===f&&b in $a&&(f=$a[b]),""===c||c?(e=parseFloat(f),c===!0||isFinite(e)?e||0:f):f}}),n.each(["height","width"],function(a,b){n.cssHooks[b]={get:function(a,c,d){return c?Xa.test(n.css(a,"display"))&&0===a.offsetWidth?Pa(a,Za,function(){return fb(a,b,d)}):fb(a,b,d):void 0},set:function(a,c,d){var e=d&&Ra(a);return db(a,c,d?eb(a,b,d,l.boxSizing&&"border-box"===n.css(a,"boxSizing",!1,e),e):0)}}}),l.opacity||(n.cssHooks.opacity={get:function(a,b){return Wa.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle,e=n.isNumeric(b)?"alpha(opacity="+100*b+")":"",f=d&&d.filter||c.filter||"";c.zoom=1,(b>=1||""===b)&&""===n.trim(f.replace(Va,""))&&c.removeAttribute&&(c.removeAttribute("filter"),""===b||d&&!d.filter)||(c.filter=Va.test(f)?f.replace(Va,e):f+" "+e)}}),n.cssHooks.marginRight=Ua(l.reliableMarginRight,function(a,b){return b?Pa(a,{display:"inline-block"},Sa,[a,"marginRight"]):void 0}),n.cssHooks.marginLeft=Ua(l.reliableMarginLeft,function(a,b){return b?(parseFloat(Sa(a,"marginLeft"))||(n.contains(a.ownerDocument,a)?a.getBoundingClientRect().left-Pa(a,{
marginLeft:0},function(){return a.getBoundingClientRect().left}):0))+"px":void 0}),n.each({margin:"",padding:"",border:"Width"},function(a,b){n.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+V[d]+b]=f[d]||f[d-2]||f[0];return e}},Na.test(a)||(n.cssHooks[a+b].set=db)}),n.fn.extend({css:function(a,b){return Y(this,function(a,b,c){var d,e,f={},g=0;if(n.isArray(b)){for(d=Ra(a),e=b.length;e>g;g++)f[b[g]]=n.css(a,b[g],!1,d);return f}return void 0!==c?n.style(a,b,c):n.css(a,b)},a,b,arguments.length>1)},show:function(){return cb(this,!0)},hide:function(){return cb(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){W(this)?n(this).show():n(this).hide()})}});function gb(a,b,c,d,e){return new gb.prototype.init(a,b,c,d,e)}n.Tween=gb,gb.prototype={constructor:gb,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||n.easing._default,this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(n.cssNumber[c]?"":"px")},cur:function(){var a=gb.propHooks[this.prop];return a&&a.get?a.get(this):gb.propHooks._default.get(this)},run:function(a){var b,c=gb.propHooks[this.prop];return this.options.duration?this.pos=b=n.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):this.pos=b=a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):gb.propHooks._default.set(this),this}},gb.prototype.init.prototype=gb.prototype,gb.propHooks={_default:{get:function(a){var b;return 1!==a.elem.nodeType||null!=a.elem[a.prop]&&null==a.elem.style[a.prop]?a.elem[a.prop]:(b=n.css(a.elem,a.prop,""),b&&"auto"!==b?b:0)},set:function(a){n.fx.step[a.prop]?n.fx.step[a.prop](a):1!==a.elem.nodeType||null==a.elem.style[n.cssProps[a.prop]]&&!n.cssHooks[a.prop]?a.elem[a.prop]=a.now:n.style(a.elem,a.prop,a.now+a.unit)}}},gb.propHooks.scrollTop=gb.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},n.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2},_default:"swing"},n.fx=gb.prototype.init,n.fx.step={};var hb,ib,jb=/^(?:toggle|show|hide)$/,kb=/queueHooks$/;function lb(){return a.setTimeout(function(){hb=void 0}),hb=n.now()}function mb(a,b){var c,d={height:a},e=0;for(b=b?1:0;4>e;e+=2-b)c=V[e],d["margin"+c]=d["padding"+c]=a;return b&&(d.opacity=d.width=a),d}function nb(a,b,c){for(var d,e=(qb.tweeners[b]||[]).concat(qb.tweeners["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function ob(a,b,c){var d,e,f,g,h,i,j,k,m=this,o={},p=a.style,q=a.nodeType&&W(a),r=n._data(a,"fxshow");c.queue||(h=n._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,m.always(function(){m.always(function(){h.unqueued--,n.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[p.overflow,p.overflowX,p.overflowY],j=n.css(a,"display"),k="none"===j?n._data(a,"olddisplay")||Ma(a.nodeName):j,"inline"===k&&"none"===n.css(a,"float")&&(l.inlineBlockNeedsLayout&&"inline"!==Ma(a.nodeName)?p.zoom=1:p.display="inline-block")),c.overflow&&(p.overflow="hidden",l.shrinkWrapBlocks()||m.always(function(){p.overflow=c.overflow[0],p.overflowX=c.overflow[1],p.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],jb.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(q?"hide":"show")){if("show"!==e||!r||void 0===r[d])continue;q=!0}o[d]=r&&r[d]||n.style(a,d)}else j=void 0;if(n.isEmptyObject(o))"inline"===("none"===j?Ma(a.nodeName):j)&&(p.display=j);else{r?"hidden"in r&&(q=r.hidden):r=n._data(a,"fxshow",{}),f&&(r.hidden=!q),q?n(a).show():m.done(function(){n(a).hide()}),m.done(function(){var b;n._removeData(a,"fxshow");for(b in o)n.style(a,b,o[b])});for(d in o)g=nb(q?r[d]:0,d,m),d in r||(r[d]=g.start,q&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function pb(a,b){var c,d,e,f,g;for(c in a)if(d=n.camelCase(c),e=b[d],f=a[c],n.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=n.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function qb(a,b,c){var d,e,f=0,g=qb.prefilters.length,h=n.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=hb||lb(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:n.extend({},b),opts:n.extend(!0,{specialEasing:{},easing:n.easing._default},c),originalProperties:b,originalOptions:c,startTime:hb||lb(),duration:c.duration,tweens:[],createTween:function(b,c){var d=n.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?(h.notifyWith(a,[j,1,0]),h.resolveWith(a,[j,b])):h.rejectWith(a,[j,b]),this}}),k=j.props;for(pb(k,j.opts.specialEasing);g>f;f++)if(d=qb.prefilters[f].call(j,a,k,j.opts))return n.isFunction(d.stop)&&(n._queueHooks(j.elem,j.opts.queue).stop=n.proxy(d.stop,d)),d;return n.map(k,nb,j),n.isFunction(j.opts.start)&&j.opts.start.call(a,j),n.fx.timer(n.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}n.Animation=n.extend(qb,{tweeners:{"*":[function(a,b){var c=this.createTween(a,b);return X(c.elem,a,U.exec(b),c),c}]},tweener:function(a,b){n.isFunction(a)?(b=a,a=["*"]):a=a.match(G);for(var c,d=0,e=a.length;e>d;d++)c=a[d],qb.tweeners[c]=qb.tweeners[c]||[],qb.tweeners[c].unshift(b)},prefilters:[ob],prefilter:function(a,b){b?qb.prefilters.unshift(a):qb.prefilters.push(a)}}),n.speed=function(a,b,c){var d=a&&"object"==typeof a?n.extend({},a):{complete:c||!c&&b||n.isFunction(a)&&a,duration:a,easing:c&&b||b&&!n.isFunction(b)&&b};return d.duration=n.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in n.fx.speeds?n.fx.speeds[d.duration]:n.fx.speeds._default,null!=d.queue&&d.queue!==!0||(d.queue="fx"),d.old=d.complete,d.complete=function(){n.isFunction(d.old)&&d.old.call(this),d.queue&&n.dequeue(this,d.queue)},d},n.fn.extend({fadeTo:function(a,b,c,d){return this.filter(W).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=n.isEmptyObject(a),f=n.speed(b,c,d),g=function(){var b=qb(this,n.extend({},a),f);(e||n._data(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=n.timers,g=n._data(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&kb.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));!b&&c||n.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=n._data(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=n.timers,g=d?d.length:0;for(c.finish=!0,n.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),n.each(["toggle","show","hide"],function(a,b){var c=n.fn[b];n.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(mb(b,!0),a,d,e)}}),n.each({slideDown:mb("show"),slideUp:mb("hide"),slideToggle:mb("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){n.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),n.timers=[],n.fx.tick=function(){var a,b=n.timers,c=0;for(hb=n.now();c<b.length;c++)a=b[c],a()||b[c]!==a||b.splice(c--,1);b.length||n.fx.stop(),hb=void 0},n.fx.timer=function(a){n.timers.push(a),a()?n.fx.start():n.timers.pop()},n.fx.interval=13,n.fx.start=function(){ib||(ib=a.setInterval(n.fx.tick,n.fx.interval))},n.fx.stop=function(){a.clearInterval(ib),ib=null},n.fx.speeds={slow:600,fast:200,_default:400},n.fn.delay=function(b,c){return b=n.fx?n.fx.speeds[b]||b:b,c=c||"fx",this.queue(c,function(c,d){var e=a.setTimeout(c,b);d.stop=function(){a.clearTimeout(e)}})},function(){var a,b=d.createElement("input"),c=d.createElement("div"),e=d.createElement("select"),f=e.appendChild(d.createElement("option"));c=d.createElement("div"),c.setAttribute("className","t"),c.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",a=c.getElementsByTagName("a")[0],b.setAttribute("type","checkbox"),c.appendChild(b),a=c.getElementsByTagName("a")[0],a.style.cssText="top:1px",l.getSetAttribute="t"!==c.className,l.style=/top/.test(a.getAttribute("style")),l.hrefNormalized="/a"===a.getAttribute("href"),l.checkOn=!!b.value,l.optSelected=f.selected,l.enctype=!!d.createElement("form").enctype,e.disabled=!0,l.optDisabled=!f.disabled,b=d.createElement("input"),b.setAttribute("value",""),l.input=""===b.getAttribute("value"),b.value="t",b.setAttribute("type","radio"),l.radioValue="t"===b.value}();var rb=/\r/g,sb=/[\x20\t\r\n\f]+/g;n.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=n.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,n(this).val()):a,null==e?e="":"number"==typeof e?e+="":n.isArray(e)&&(e=n.map(e,function(a){return null==a?"":a+""})),b=n.valHooks[this.type]||n.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=n.valHooks[e.type]||n.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(rb,""):null==c?"":c)}}}),n.extend({valHooks:{option:{get:function(a){var b=n.find.attr(a,"value");return null!=b?b:n.trim(n.text(a)).replace(sb," ")}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],(c.selected||i===e)&&(l.optDisabled?!c.disabled:null===c.getAttribute("disabled"))&&(!c.parentNode.disabled||!n.nodeName(c.parentNode,"optgroup"))){if(b=n(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=n.makeArray(b),g=e.length;while(g--)if(d=e[g],n.inArray(n.valHooks.option.get(d),f)>-1)try{d.selected=c=!0}catch(h){d.scrollHeight}else d.selected=!1;return c||(a.selectedIndex=-1),e}}}}),n.each(["radio","checkbox"],function(){n.valHooks[this]={set:function(a,b){return n.isArray(b)?a.checked=n.inArray(n(a).val(),b)>-1:void 0}},l.checkOn||(n.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})});var tb,ub,vb=n.expr.attrHandle,wb=/^(?:checked|selected)$/i,xb=l.getSetAttribute,yb=l.input;n.fn.extend({attr:function(a,b){return Y(this,n.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){n.removeAttr(this,a)})}}),n.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return"undefined"==typeof a.getAttribute?n.prop(a,b,c):(1===f&&n.isXMLDoc(a)||(b=b.toLowerCase(),e=n.attrHooks[b]||(n.expr.match.bool.test(b)?ub:tb)),void 0!==c?null===c?void n.removeAttr(a,b):e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:(a.setAttribute(b,c+""),c):e&&"get"in e&&null!==(d=e.get(a,b))?d:(d=n.find.attr(a,b),null==d?void 0:d))},attrHooks:{type:{set:function(a,b){if(!l.radioValue&&"radio"===b&&n.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(G);if(f&&1===a.nodeType)while(c=f[e++])d=n.propFix[c]||c,n.expr.match.bool.test(c)?yb&&xb||!wb.test(c)?a[d]=!1:a[n.camelCase("default-"+c)]=a[d]=!1:n.attr(a,c,""),a.removeAttribute(xb?c:d)}}),ub={set:function(a,b,c){return b===!1?n.removeAttr(a,c):yb&&xb||!wb.test(c)?a.setAttribute(!xb&&n.propFix[c]||c,c):a[n.camelCase("default-"+c)]=a[c]=!0,c}},n.each(n.expr.match.bool.source.match(/\w+/g),function(a,b){var c=vb[b]||n.find.attr;yb&&xb||!wb.test(b)?vb[b]=function(a,b,d){var e,f;return d||(f=vb[b],vb[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,vb[b]=f),e}:vb[b]=function(a,b,c){return c?void 0:a[n.camelCase("default-"+b)]?b.toLowerCase():null}}),yb&&xb||(n.attrHooks.value={set:function(a,b,c){return n.nodeName(a,"input")?void(a.defaultValue=b):tb&&tb.set(a,b,c)}}),xb||(tb={set:function(a,b,c){var d=a.getAttributeNode(c);return d||a.setAttributeNode(d=a.ownerDocument.createAttribute(c)),d.value=b+="","value"===c||b===a.getAttribute(c)?b:void 0}},vb.id=vb.name=vb.coords=function(a,b,c){var d;return c?void 0:(d=a.getAttributeNode(b))&&""!==d.value?d.value:null},n.valHooks.button={get:function(a,b){var c=a.getAttributeNode(b);return c&&c.specified?c.value:void 0},set:tb.set},n.attrHooks.contenteditable={set:function(a,b,c){tb.set(a,""===b?!1:b,c)}},n.each(["width","height"],function(a,b){n.attrHooks[b]={set:function(a,c){return""===c?(a.setAttribute(b,"auto"),c):void 0}}})),l.style||(n.attrHooks.style={get:function(a){return a.style.cssText||void 0},set:function(a,b){return a.style.cssText=b+""}});var zb=/^(?:input|select|textarea|button|object)$/i,Ab=/^(?:a|area)$/i;n.fn.extend({prop:function(a,b){return Y(this,n.prop,a,b,arguments.length>1)},removeProp:function(a){return a=n.propFix[a]||a,this.each(function(){try{this[a]=void 0,delete this[a]}catch(b){}})}}),n.extend({prop:function(a,b,c){var d,e,f=a.nodeType;if(3!==f&&8!==f&&2!==f)return 1===f&&n.isXMLDoc(a)||(b=n.propFix[b]||b,e=n.propHooks[b]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){var b=n.find.attr(a,"tabindex");return b?parseInt(b,10):zb.test(a.nodeName)||Ab.test(a.nodeName)&&a.href?0:-1}}},propFix:{"for":"htmlFor","class":"className"}}),l.hrefNormalized||n.each(["href","src"],function(a,b){n.propHooks[b]={get:function(a){return a.getAttribute(b,4)}}}),l.optSelected||(n.propHooks.selected={get:function(a){var b=a.parentNode;return b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex),null},set:function(a){var b=a.parentNode;b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex)}}),n.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){n.propFix[this.toLowerCase()]=this}),l.enctype||(n.propFix.enctype="encoding");var Bb=/[\t\r\n\f]/g;function Cb(a){return n.attr(a,"class")||""}n.fn.extend({addClass:function(a){var b,c,d,e,f,g,h,i=0;if(n.isFunction(a))return this.each(function(b){n(this).addClass(a.call(this,b,Cb(this)))});if("string"==typeof a&&a){b=a.match(G)||[];while(c=this[i++])if(e=Cb(c),d=1===c.nodeType&&(" "+e+" ").replace(Bb," ")){g=0;while(f=b[g++])d.indexOf(" "+f+" ")<0&&(d+=f+" ");h=n.trim(d),e!==h&&n.attr(c,"class",h)}}return this},removeClass:function(a){var b,c,d,e,f,g,h,i=0;if(n.isFunction(a))return this.each(function(b){n(this).removeClass(a.call(this,b,Cb(this)))});if(!arguments.length)return this.attr("class","");if("string"==typeof a&&a){b=a.match(G)||[];while(c=this[i++])if(e=Cb(c),d=1===c.nodeType&&(" "+e+" ").replace(Bb," ")){g=0;while(f=b[g++])while(d.indexOf(" "+f+" ")>-1)d=d.replace(" "+f+" "," ");h=n.trim(d),e!==h&&n.attr(c,"class",h)}}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):n.isFunction(a)?this.each(function(c){n(this).toggleClass(a.call(this,c,Cb(this),b),b)}):this.each(function(){var b,d,e,f;if("string"===c){d=0,e=n(this),f=a.match(G)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else void 0!==a&&"boolean"!==c||(b=Cb(this),b&&n._data(this,"__className__",b),n.attr(this,"class",b||a===!1?"":n._data(this,"__className__")||""))})},hasClass:function(a){var b,c,d=0;b=" "+a+" ";while(c=this[d++])if(1===c.nodeType&&(" "+Cb(c)+" ").replace(Bb," ").indexOf(b)>-1)return!0;return!1}}),n.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){n.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),n.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}});var Db=a.location,Eb=n.now(),Fb=/\?/,Gb=/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g;n.parseJSON=function(b){if(a.JSON&&a.JSON.parse)return a.JSON.parse(b+"");var c,d=null,e=n.trim(b+"");return e&&!n.trim(e.replace(Gb,function(a,b,e,f){return c&&b&&(d=0),0===d?a:(c=e||b,d+=!f-!e,"")}))?Function("return "+e)():n.error("Invalid JSON: "+b)},n.parseXML=function(b){var c,d;if(!b||"string"!=typeof b)return null;try{a.DOMParser?(d=new a.DOMParser,c=d.parseFromString(b,"text/xml")):(c=new a.ActiveXObject("Microsoft.XMLDOM"),c.async="false",c.loadXML(b))}catch(e){c=void 0}return c&&c.documentElement&&!c.getElementsByTagName("parsererror").length||n.error("Invalid XML: "+b),c};var Hb=/#.*$/,Ib=/([?&])_=[^&]*/,Jb=/^(.*?):[ \t]*([^\r\n]*)\r?$/gm,Kb=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Lb=/^(?:GET|HEAD)$/,Mb=/^\/\//,Nb=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,Ob={},Pb={},Qb="*/".concat("*"),Rb=Db.href,Sb=Nb.exec(Rb.toLowerCase())||[];function Tb(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(G)||[];if(n.isFunction(c))while(d=f[e++])"+"===d.charAt(0)?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function Ub(a,b,c,d){var e={},f=a===Pb;function g(h){var i;return e[h]=!0,n.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e["*"]&&g("*")}function Vb(a,b){var c,d,e=n.ajaxSettings.flatOptions||{};for(d in b)void 0!==b[d]&&((e[d]?a:c||(c={}))[d]=b[d]);return c&&n.extend(!0,a,c),a}function Wb(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("*"===i[0])i.shift(),void 0===e&&(e=a.mimeType||b.getResponseHeader("Content-Type"));if(e)for(g in h)if(h[g]&&h[g].test(e)){i.unshift(g);break}if(i[0]in c)f=i[0];else{for(g in c){if(!i[0]||a.converters[g+" "+i[0]]){f=g;break}d||(d=g)}f=f||d}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function Xb(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}n.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Rb,type:"GET",isLocal:Kb.test(Sb[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":Qb,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":n.parseJSON,"text xml":n.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?Vb(Vb(a,n.ajaxSettings),b):Vb(n.ajaxSettings,a)},ajaxPrefilter:Tb(Ob),ajaxTransport:Tb(Pb),ajax:function(b,c){"object"==typeof b&&(c=b,b=void 0),c=c||{};var d,e,f,g,h,i,j,k,l=n.ajaxSetup({},c),m=l.context||l,o=l.context&&(m.nodeType||m.jquery)?n(m):n.event,p=n.Deferred(),q=n.Callbacks("once memory"),r=l.statusCode||{},s={},t={},u=0,v="canceled",w={readyState:0,getResponseHeader:function(a){var b;if(2===u){if(!k){k={};while(b=Jb.exec(g))k[b[1].toLowerCase()]=b[2]}b=k[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===u?g:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return u||(a=t[c]=t[c]||a,s[a]=b),this},overrideMimeType:function(a){return u||(l.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>u)for(b in a)r[b]=[r[b],a[b]];else w.always(a[w.status]);return this},abort:function(a){var b=a||v;return j&&j.abort(b),y(0,b),this}};if(p.promise(w).complete=q.add,w.success=w.done,w.error=w.fail,l.url=((b||l.url||Rb)+"").replace(Hb,"").replace(Mb,Sb[1]+"//"),l.type=c.method||c.type||l.method||l.type,l.dataTypes=n.trim(l.dataType||"*").toLowerCase().match(G)||[""],null==l.crossDomain&&(d=Nb.exec(l.url.toLowerCase()),l.crossDomain=!(!d||d[1]===Sb[1]&&d[2]===Sb[2]&&(d[3]||("http:"===d[1]?"80":"443"))===(Sb[3]||("http:"===Sb[1]?"80":"443")))),l.data&&l.processData&&"string"!=typeof l.data&&(l.data=n.param(l.data,l.traditional)),Ub(Ob,l,c,w),2===u)return w;i=n.event&&l.global,i&&0===n.active++&&n.event.trigger("ajaxStart"),l.type=l.type.toUpperCase(),l.hasContent=!Lb.test(l.type),f=l.url,l.hasContent||(l.data&&(f=l.url+=(Fb.test(f)?"&":"?")+l.data,delete l.data),l.cache===!1&&(l.url=Ib.test(f)?f.replace(Ib,"$1_="+Eb++):f+(Fb.test(f)?"&":"?")+"_="+Eb++)),l.ifModified&&(n.lastModified[f]&&w.setRequestHeader("If-Modified-Since",n.lastModified[f]),n.etag[f]&&w.setRequestHeader("If-None-Match",n.etag[f])),(l.data&&l.hasContent&&l.contentType!==!1||c.contentType)&&w.setRequestHeader("Content-Type",l.contentType),w.setRequestHeader("Accept",l.dataTypes[0]&&l.accepts[l.dataTypes[0]]?l.accepts[l.dataTypes[0]]+("*"!==l.dataTypes[0]?", "+Qb+"; q=0.01":""):l.accepts["*"]);for(e in l.headers)w.setRequestHeader(e,l.headers[e]);if(l.beforeSend&&(l.beforeSend.call(m,w,l)===!1||2===u))return w.abort();v="abort";for(e in{success:1,error:1,complete:1})w[e](l[e]);if(j=Ub(Pb,l,c,w)){if(w.readyState=1,i&&o.trigger("ajaxSend",[w,l]),2===u)return w;l.async&&l.timeout>0&&(h=a.setTimeout(function(){w.abort("timeout")},l.timeout));try{u=1,j.send(s,y)}catch(x){if(!(2>u))throw x;y(-1,x)}}else y(-1,"No Transport");function y(b,c,d,e){var k,s,t,v,x,y=c;2!==u&&(u=2,h&&a.clearTimeout(h),j=void 0,g=e||"",w.readyState=b>0?4:0,k=b>=200&&300>b||304===b,d&&(v=Wb(l,w,d)),v=Xb(l,v,w,k),k?(l.ifModified&&(x=w.getResponseHeader("Last-Modified"),x&&(n.lastModified[f]=x),x=w.getResponseHeader("etag"),x&&(n.etag[f]=x)),204===b||"HEAD"===l.type?y="nocontent":304===b?y="notmodified":(y=v.state,s=v.data,t=v.error,k=!t)):(t=y,!b&&y||(y="error",0>b&&(b=0))),w.status=b,w.statusText=(c||y)+"",k?p.resolveWith(m,[s,y,w]):p.rejectWith(m,[w,y,t]),w.statusCode(r),r=void 0,i&&o.trigger(k?"ajaxSuccess":"ajaxError",[w,l,k?s:t]),q.fireWith(m,[w,y]),i&&(o.trigger("ajaxComplete",[w,l]),--n.active||n.event.trigger("ajaxStop")))}return w},getJSON:function(a,b,c){return n.get(a,b,c,"json")},getScript:function(a,b){return n.get(a,void 0,b,"script")}}),n.each(["get","post"],function(a,b){n[b]=function(a,c,d,e){return n.isFunction(c)&&(e=e||d,d=c,c=void 0),n.ajax(n.extend({url:a,type:b,dataType:e,data:c,success:d},n.isPlainObject(a)&&a))}}),n._evalUrl=function(a){return n.ajax({url:a,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,"throws":!0})},n.fn.extend({wrapAll:function(a){if(n.isFunction(a))return this.each(function(b){n(this).wrapAll(a.call(this,b))});if(this[0]){var b=n(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstChild&&1===a.firstChild.nodeType)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){return n.isFunction(a)?this.each(function(b){n(this).wrapInner(a.call(this,b))}):this.each(function(){var b=n(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=n.isFunction(a);return this.each(function(c){n(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){n.nodeName(this,"body")||n(this).replaceWith(this.childNodes)}).end()}});function Yb(a){return a.style&&a.style.display||n.css(a,"display")}function Zb(a){if(!n.contains(a.ownerDocument||d,a))return!0;while(a&&1===a.nodeType){if("none"===Yb(a)||"hidden"===a.type)return!0;a=a.parentNode}return!1}n.expr.filters.hidden=function(a){return l.reliableHiddenOffsets()?a.offsetWidth<=0&&a.offsetHeight<=0&&!a.getClientRects().length:Zb(a)},n.expr.filters.visible=function(a){return!n.expr.filters.hidden(a)};var $b=/%20/g,_b=/\[\]$/,ac=/\r?\n/g,bc=/^(?:submit|button|image|reset|file)$/i,cc=/^(?:input|select|textarea|keygen)/i;function dc(a,b,c,d){var e;if(n.isArray(b))n.each(b,function(b,e){c||_b.test(a)?d(a,e):dc(a+"["+("object"==typeof e&&null!=e?b:"")+"]",e,c,d)});else if(c||"object"!==n.type(b))d(a,b);else for(e in b)dc(a+"["+e+"]",b[e],c,d)}n.param=function(a,b){var c,d=[],e=function(a,b){b=n.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=n.ajaxSettings&&n.ajaxSettings.traditional),n.isArray(a)||a.jquery&&!n.isPlainObject(a))n.each(a,function(){e(this.name,this.value)});else for(c in a)dc(c,a[c],b,e);return d.join("&").replace($b,"+")},n.fn.extend({serialize:function(){return n.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=n.prop(this,"elements");return a?n.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!n(this).is(":disabled")&&cc.test(this.nodeName)&&!bc.test(a)&&(this.checked||!Z.test(a))}).map(function(a,b){var c=n(this).val();return null==c?null:n.isArray(c)?n.map(c,function(a){return{name:b.name,value:a.replace(ac,"\r\n")}}):{name:b.name,value:c.replace(ac,"\r\n")}}).get()}}),n.ajaxSettings.xhr=void 0!==a.ActiveXObject?function(){return this.isLocal?ic():d.documentMode>8?hc():/^(get|post|head|put|delete|options)$/i.test(this.type)&&hc()||ic()}:hc;var ec=0,fc={},gc=n.ajaxSettings.xhr();a.attachEvent&&a.attachEvent("onunload",function(){for(var a in fc)fc[a](void 0,!0)}),l.cors=!!gc&&"withCredentials"in gc,gc=l.ajax=!!gc,gc&&n.ajaxTransport(function(b){if(!b.crossDomain||l.cors){var c;return{send:function(d,e){var f,g=b.xhr(),h=++ec;if(g.open(b.type,b.url,b.async,b.username,b.password),b.xhrFields)for(f in b.xhrFields)g[f]=b.xhrFields[f];b.mimeType&&g.overrideMimeType&&g.overrideMimeType(b.mimeType),b.crossDomain||d["X-Requested-With"]||(d["X-Requested-With"]="XMLHttpRequest");for(f in d)void 0!==d[f]&&g.setRequestHeader(f,d[f]+"");g.send(b.hasContent&&b.data||null),c=function(a,d){var f,i,j;if(c&&(d||4===g.readyState))if(delete fc[h],c=void 0,g.onreadystatechange=n.noop,d)4!==g.readyState&&g.abort();else{j={},f=g.status,"string"==typeof g.responseText&&(j.text=g.responseText);try{i=g.statusText}catch(k){i=""}f||!b.isLocal||b.crossDomain?1223===f&&(f=204):f=j.text?200:404}j&&e(f,i,j,g.getAllResponseHeaders())},b.async?4===g.readyState?a.setTimeout(c):g.onreadystatechange=fc[h]=c:c()},abort:function(){c&&c(void 0,!0)}}}});function hc(){try{return new a.XMLHttpRequest}catch(b){}}function ic(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}n.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(a){return n.globalEval(a),a}}}),n.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),n.ajaxTransport("script",function(a){if(a.crossDomain){var b,c=d.head||n("head")[0]||d.documentElement;return{send:function(e,f){b=d.createElement("script"),b.async=!0,a.scriptCharset&&(b.charset=a.scriptCharset),b.src=a.url,b.onload=b.onreadystatechange=function(a,c){(c||!b.readyState||/loaded|complete/.test(b.readyState))&&(b.onload=b.onreadystatechange=null,b.parentNode&&b.parentNode.removeChild(b),b=null,c||f(200,"success"))},c.insertBefore(b,c.firstChild)},abort:function(){b&&b.onload(void 0,!0)}}}});var jc=[],kc=/(=)\?(?=&|$)|\?\?/;n.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=jc.pop()||n.expando+"_"+Eb++;return this[a]=!0,a}}),n.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(kc.test(b.url)?"url":"string"==typeof b.data&&0===(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&kc.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=n.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(kc,"$1"+e):b.jsonp!==!1&&(b.url+=(Fb.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||n.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){void 0===f?n(a).removeProp(e):a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,jc.push(e)),g&&n.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),n.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||d;var e=x.exec(a),f=!c&&[];return e?[b.createElement(e[1])]:(e=ja([a],b,f),f&&f.length&&n(f).remove(),n.merge([],e.childNodes))};var lc=n.fn.load;n.fn.load=function(a,b,c){if("string"!=typeof a&&lc)return lc.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>-1&&(d=n.trim(a.slice(h,a.length)),a=a.slice(0,h)),n.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(e="POST"),g.length>0&&n.ajax({url:a,type:e||"GET",dataType:"html",data:b}).done(function(a){f=arguments,g.html(d?n("<div>").append(n.parseHTML(a)).find(d):a)}).always(c&&function(a,b){g.each(function(){c.apply(this,f||[a.responseText,b,a])})}),this},n.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){n.fn[b]=function(a){return this.on(b,a)}}),n.expr.filters.animated=function(a){return n.grep(n.timers,function(b){return a===b.elem}).length};function mc(a){return n.isWindow(a)?a:9===a.nodeType?a.defaultView||a.parentWindow:!1}n.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=n.css(a,"position"),l=n(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=n.css(a,"top"),i=n.css(a,"left"),j=("absolute"===k||"fixed"===k)&&n.inArray("auto",[f,i])>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),n.isFunction(b)&&(b=b.call(a,c,n.extend({},h))),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},n.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){n.offset.setOffset(this,a,b)});var b,c,d={top:0,left:0},e=this[0],f=e&&e.ownerDocument;if(f)return b=f.documentElement,n.contains(b,e)?("undefined"!=typeof e.getBoundingClientRect&&(d=e.getBoundingClientRect()),c=mc(f),{top:d.top+(c.pageYOffset||b.scrollTop)-(b.clientTop||0),left:d.left+(c.pageXOffset||b.scrollLeft)-(b.clientLeft||0)}):d},position:function(){if(this[0]){var a,b,c={top:0,left:0},d=this[0];return"fixed"===n.css(d,"position")?b=d.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),n.nodeName(a[0],"html")||(c=a.offset()),c.top+=n.css(a[0],"borderTopWidth",!0),c.left+=n.css(a[0],"borderLeftWidth",!0)),{top:b.top-c.top-n.css(d,"marginTop",!0),left:b.left-c.left-n.css(d,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent;while(a&&!n.nodeName(a,"html")&&"static"===n.css(a,"position"))a=a.offsetParent;return a||Qa})}}),n.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,b){var c=/Y/.test(b);n.fn[a]=function(d){return Y(this,function(a,d,e){var f=mc(a);return void 0===e?f?b in f?f[b]:f.document.documentElement[d]:a[d]:void(f?f.scrollTo(c?n(f).scrollLeft():e,c?e:n(f).scrollTop()):a[d]=e)},a,d,arguments.length,null)}}),n.each(["top","left"],function(a,b){n.cssHooks[b]=Ua(l.pixelPosition,function(a,c){return c?(c=Sa(a,b),Oa.test(c)?n(a).position()[b]+"px":c):void 0})}),n.each({Height:"height",Width:"width"},function(a,b){n.each({
padding:"inner"+a,content:b,"":"outer"+a},function(c,d){n.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return Y(this,function(b,c,d){var e;return n.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?n.css(b,c,g):n.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),n.fn.extend({bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}}),n.fn.size=function(){return this.length},n.fn.andSelf=n.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return n});var nc=a.jQuery,oc=a.$;return n.noConflict=function(b){return a.$===n&&(a.$=oc),b&&a.jQuery===n&&(a.jQuery=nc),n},b||(a.jQuery=a.$=n),n});var hex_chr = "0123456789abcdef";function rhex(num){str = "";for(j = 0; j <= 3; j++){str += hex_chr.charAt((num >> (j * 8 + 4)) & 0x0F) + hex_chr.charAt((num >> (j * 8)) & 0x0F);}return str;}function str2blks_MD5(str){nblk = ((str.length + 8) >> 6) + 1;blks = new Array(nblk * 16);for(i = 0; i < nblk * 16; i++) blks[i] = 0;for(i = 0; i < str.length; i++){blks[i >> 2] |= str.charCodeAt(i) << ((i % 4) * 8);}blks[i >> 2] |= 0x80 << ((i % 4) * 8);blks[nblk * 16 - 2] = str.length * 8;return blks;}function add(x, y){var lsw = (x & 0xFFFF) + (y & 0xFFFF);var msw = (x >> 16) + (y >> 16) + (lsw >> 16);return (msw << 16) | (lsw & 0xFFFF);}function rol(num, cnt){return (num << cnt) | (num >>> (32 - cnt));}function cmn(q, a, b, x, s, t){return add(rol(add(add(a, q), add(x, t)), s), b);}function ff(a, b, c, d, x, s, t){return cmn((b & c) | ((~b) & d), a, b, x, s, t);}function gg(a, b, c, d, x, s, t){return cmn((b & d) | (c & (~d)), a, b, x, s, t);}function hh(a, b, c, d, x, s, t){return cmn(b ^ c ^ d, a, b, x, s, t);}function ii(a, b, c, d, x, s, t){return cmn(c ^ (b | (~d)), a, b, x, s, t);}function _calcMD5(str){str=str===0?"0":str?str+"":"";x = str2blks_MD5(str);a =  1732584193;b = -271733879;c = -1732584194;d =  271733878;for(i = 0; i < x.length; i += 16){olda = a;oldb = b;oldc = c;oldd = d;a = ff(a, b, c, d, x[i+ 0], 7 , -680876936);d = ff(d, a, b, c, x[i+ 1], 12, -389564586);c = ff(c, d, a, b, x[i+ 2], 17,  606105819);b = ff(b, c, d, a, x[i+ 3], 22, -1044525330);a = ff(a, b, c, d, x[i+ 4], 7 , -176418897);d = ff(d, a, b, c, x[i+ 5], 12,  1200080426);c = ff(c, d, a, b, x[i+ 6], 17, -1473231341);b = ff(b, c, d, a, x[i+ 7], 22, -45705983);a = ff(a, b, c, d, x[i+ 8], 7 ,  1770035416);d = ff(d, a, b, c, x[i+ 9], 12, -1958414417);c = ff(c, d, a, b, x[i+10], 17, -42063);b = ff(b, c, d, a, x[i+11], 22, -1990404162);a = ff(a, b, c, d, x[i+12], 7 ,  1804603682);d = ff(d, a, b, c, x[i+13], 12, -40341101);c = ff(c, d, a, b, x[i+14], 17, -1502002290);b = ff(b, c, d, a, x[i+15], 22,  1236535329);a = gg(a, b, c, d, x[i+ 1], 5 , -165796510);d = gg(d, a, b, c, x[i+ 6], 9 , -1069501632);c = gg(c, d, a, b, x[i+11], 14,  643717713);b = gg(b, c, d, a, x[i+ 0], 20, -373897302);a = gg(a, b, c, d, x[i+ 5], 5 , -701558691);d = gg(d, a, b, c, x[i+10], 9 ,  38016083);c = gg(c, d, a, b, x[i+15], 14, -660478335);b = gg(b, c, d, a, x[i+ 4], 20, -405537848);a = gg(a, b, c, d, x[i+ 9], 5 ,  568446438);d = gg(d, a, b, c, x[i+14], 9 , -1019803690);c = gg(c, d, a, b, x[i+ 3], 14, -187363961);b = gg(b, c, d, a, x[i+ 8], 20,  1163531501);a = gg(a, b, c, d, x[i+13], 5 , -1444681467);d = gg(d, a, b, c, x[i+ 2], 9 , -51403784);c = gg(c, d, a, b, x[i+ 7], 14,  1735328473);b = gg(b, c, d, a, x[i+12], 20, -1926607734);a = hh(a, b, c, d, x[i+ 5], 4 , -378558);d = hh(d, a, b, c, x[i+ 8], 11, -2022574463);c = hh(c, d, a, b, x[i+11], 16,  1839030562);b = hh(b, c, d, a, x[i+14], 23, -35309556);a = hh(a, b, c, d, x[i+ 1], 4 , -1530992060);d = hh(d, a, b, c, x[i+ 4], 11,  1272893353);c = hh(c, d, a, b, x[i+ 7], 16, -155497632);b = hh(b, c, d, a, x[i+10], 23, -1094730640);a = hh(a, b, c, d, x[i+13], 4 ,  681279174);d = hh(d, a, b, c, x[i+ 0], 11, -358537222);c = hh(c, d, a, b, x[i+ 3], 16, -722521979);b = hh(b, c, d, a, x[i+ 6], 23,  76029189);a = hh(a, b, c, d, x[i+ 9], 4 , -640364487);d = hh(d, a, b, c, x[i+12], 11, -421815835);c = hh(c, d, a, b, x[i+15], 16,  530742520);b = hh(b, c, d, a, x[i+ 2], 23, -995338651);a = ii(a, b, c, d, x[i+ 0], 6 , -198630844);d = ii(d, a, b, c, x[i+ 7], 10,  1126891415);c = ii(c, d, a, b, x[i+14], 15, -1416354905);b = ii(b, c, d, a, x[i+ 5], 21, -57434055);a = ii(a, b, c, d, x[i+12], 6 ,  1700485571);d = ii(d, a, b, c, x[i+ 3], 10, -1894986606);c = ii(c, d, a, b, x[i+10], 15, -1051523);b = ii(b, c, d, a, x[i+ 1], 21, -2054922799);a = ii(a, b, c, d, x[i+ 8], 6 ,  1873313359);d = ii(d, a, b, c, x[i+15], 10, -30611744);c = ii(c, d, a, b, x[i+ 6], 15, -1560198380);b = ii(b, c, d, a, x[i+13], 21,  1309151649);a = ii(a, b, c, d, x[i+ 4], 6 , -145523070);d = ii(d, a, b, c, x[i+11], 10, -1120210379);c = ii(c, d, a, b, x[i+ 2], 15,  718787259);b = ii(b, c, d, a, x[i+ 9], 21, -343485551);a = add(a, olda);b = add(b, oldb);c = add(c, oldc);d = add(d, oldd);}return rhex(a) + rhex(b) + rhex(c) + rhex(d);}try{exports.md5 =_calcMD5;}catch(e){};/*!
 * html2canvas 1.0.0-rc.5 <https://html2canvas.hertzen.com>
 * Copyright (c) 2019 Niklas von Hertzen <https://hertzen.com>
 * Released under MIT License
 */
!function(A,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(A=A||self).html2canvas=e()}(this,function(){"use strict";var r=function(A,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(A,e){A.__proto__=e}||function(A,e){for(var t in e)e.hasOwnProperty(t)&&(A[t]=e[t])})(A,e)};function A(A,e){function t(){this.constructor=A}r(A,e),A.prototype=null===e?Object.create(e):(t.prototype=e.prototype,new t)}var K=function(){return(K=Object.assign||function(A){for(var e,t=1,r=arguments.length;t<r;t++)for(var n in e=arguments[t])Object.prototype.hasOwnProperty.call(e,n)&&(A[n]=e[n]);return A}).apply(this,arguments)};function a(B,s,o,i){return new(o||(o=Promise))(function(A,e){function t(A){try{n(i.next(A))}catch(A){e(A)}}function r(A){try{n(i.throw(A))}catch(A){e(A)}}function n(e){e.done?A(e.value):new o(function(A){A(e.value)}).then(t,r)}n((i=i.apply(B,s||[])).next())})}function S(t,r){var n,B,s,A,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return A={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(A[Symbol.iterator]=function(){return this}),A;function e(e){return function(A){return function(e){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,B&&(s=2&e[0]?B.return:e[0]?B.throw||((s=B.return)&&s.call(B),0):B.next)&&!(s=s.call(B,e[1])).done)return s;switch(B=0,s&&(e=[2&e[0],s.value]),e[0]){case 0:case 1:s=e;break;case 4:return o.label++,{value:e[1],done:!1};case 5:o.label++,B=e[1],e=[0];continue;case 7:e=o.ops.pop(),o.trys.pop();continue;default:if(!(s=0<(s=o.trys).length&&s[s.length-1])&&(6===e[0]||2===e[0])){o=0;continue}if(3===e[0]&&(!s||e[1]>s[0]&&e[1]<s[3])){o.label=e[1];break}if(6===e[0]&&o.label<s[1]){o.label=s[1],s=e;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(e);break}s[2]&&o.ops.pop(),o.trys.pop();continue}e=r.call(t,o)}catch(A){e=[6,A],B=0}finally{n=s=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,A])}}}var I=(n.prototype.add=function(A,e,t,r){return new n(this.left+A,this.top+e,this.width+t,this.height+r)},n.fromClientRect=function(A){return new n(A.left,A.top,A.width,A.height)},n);function n(A,e,t,r){this.left=A,this.top=e,this.width=t,this.height=r}for(var T=function(A){return I.fromClientRect(A.getBoundingClientRect())},c=function(A){for(var e=[],t=0,r=A.length;t<r;){var n=A.charCodeAt(t++);if(55296<=n&&n<=56319&&t<r){var B=A.charCodeAt(t++);56320==(64512&B)?e.push(((1023&n)<<10)+(1023&B)+65536):(e.push(n),t--)}else e.push(n)}return e},l=function(){for(var A=[],e=0;e<arguments.length;e++)A[e]=arguments[e];if(String.fromCodePoint)return String.fromCodePoint.apply(String,A);var t=A.length;if(!t)return"";for(var r=[],n=-1,B="";++n<t;){var s=A[n];s<=65535?r.push(s):(s-=65536,r.push(55296+(s>>10),s%1024+56320)),(n+1===t||16384<r.length)&&(B+=String.fromCharCode.apply(String,r),r.length=0)}return B},e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Q="undefined"==typeof Uint8Array?[]:new Uint8Array(256),t=0;t<e.length;t++)Q[e.charCodeAt(t)]=t;function B(A,e,t){return A.slice?A.slice(e,t):new Uint16Array(Array.prototype.slice.call(A,e,t))}var s=(o.prototype.get=function(A){var e;if(0<=A){if(A<55296||56319<A&&A<=65535)return e=((e=this.index[A>>5])<<2)+(31&A),this.data[e];if(A<=65535)return e=((e=this.index[2048+(A-55296>>5)])<<2)+(31&A),this.data[e];if(A<this.highStart)return e=2080+(A>>11),e=this.index[e],e+=A>>5&63,e=((e=this.index[e])<<2)+(31&A),this.data[e];if(A<=1114111)return this.data[this.highValueIndex]}return this.errorValue},o);function o(A,e,t,r,n,B){this.initialValue=A,this.errorValue=e,this.highStart=t,this.highValueIndex=r,this.index=n,this.data=B}function C(A,e,t,r){var n=r[t];if(Array.isArray(A)?-1!==A.indexOf(n):A===n)for(var B=t;B<=r.length;){if((i=r[++B])===e)return!0;if(i!==H)break}if(n===H)for(B=t;0<B;){var s=r[--B];if(Array.isArray(A)?-1!==A.indexOf(s):A===s)for(var o=t;o<=r.length;){var i;if((i=r[++o])===e)return!0;if(i!==H)break}if(s!==H)break}return!1}function g(A,e){for(var t=A;0<=t;){var r=e[t];if(r!==H)return r;t--}return 0}function w(A,e,t,r,n){if(0===t[r])return Y;var B=r-1;if(Array.isArray(n)&&!0===n[B])return Y;var s=B-1,o=1+B,i=e[B],a=0<=s?e[s]:0,c=e[o];if(2===i&&3===c)return Y;if(-1!==j.indexOf(i))return"!";if(-1!==j.indexOf(c))return Y;if(-1!==$.indexOf(c))return Y;if(8===g(B,e))return"÷";if(11===q.get(A[B])&&(c===X||c===P||c===x))return Y;if(7===i||7===c)return Y;if(9===i)return Y;if(-1===[H,d,f].indexOf(i)&&9===c)return Y;if(-1!==[p,N,m,O,y].indexOf(c))return Y;if(g(B,e)===v)return Y;if(C(23,v,B,e))return Y;if(C([p,N],L,B,e))return Y;if(C(12,12,B,e))return Y;if(i===H)return"÷";if(23===i||23===c)return Y;if(16===c||16===i)return"÷";if(-1!==[d,f,L].indexOf(c)||14===i)return Y;if(36===a&&-1!==rA.indexOf(i))return Y;if(i===y&&36===c)return Y;if(c===R&&-1!==Z.concat(R,m,D,X,P,x).indexOf(i))return Y;if(-1!==Z.indexOf(c)&&i===D||-1!==Z.indexOf(i)&&c===D)return Y;if(i===M&&-1!==[X,P,x].indexOf(c)||-1!==[X,P,x].indexOf(i)&&c===b)return Y;if(-1!==Z.indexOf(i)&&-1!==AA.indexOf(c)||-1!==AA.indexOf(i)&&-1!==Z.indexOf(c))return Y;if(-1!==[M,b].indexOf(i)&&(c===D||-1!==[v,f].indexOf(c)&&e[1+o]===D)||-1!==[v,f].indexOf(i)&&c===D||i===D&&-1!==[D,y,O].indexOf(c))return Y;if(-1!==[D,y,O,p,N].indexOf(c))for(var Q=B;0<=Q;){if((w=e[Q])===D)return Y;if(-1===[y,O].indexOf(w))break;Q--}if(-1!==[M,b].indexOf(c))for(Q=-1!==[p,N].indexOf(i)?s:B;0<=Q;){var w;if((w=e[Q])===D)return Y;if(-1===[y,O].indexOf(w))break;Q--}if(J===i&&-1!==[J,G,V,z].indexOf(c)||-1!==[G,V].indexOf(i)&&-1!==[G,k].indexOf(c)||-1!==[k,z].indexOf(i)&&c===k)return Y;if(-1!==tA.indexOf(i)&&-1!==[R,b].indexOf(c)||-1!==tA.indexOf(c)&&i===M)return Y;if(-1!==Z.indexOf(i)&&-1!==Z.indexOf(c))return Y;if(i===O&&-1!==Z.indexOf(c))return Y;if(-1!==Z.concat(D).indexOf(i)&&c===v||-1!==Z.concat(D).indexOf(c)&&i===N)return Y;if(41===i&&41===c){for(var u=t[B],U=1;0<u&&41===e[--u];)U++;if(U%2!=0)return Y}return i===P&&c===x?Y:"÷"}function u(t,A){A||(A={lineBreak:"normal",wordBreak:"normal"});var e=function(A,n){void 0===n&&(n="strict");var B=[],s=[],o=[];return A.forEach(function(A,e){var t=q.get(A);if(50<t?(o.push(!0),t-=50):o.push(!1),-1!==["normal","auto","loose"].indexOf(n)&&-1!==[8208,8211,12316,12448].indexOf(A))return s.push(e),B.push(16);if(4!==t&&11!==t)return s.push(e),31===t?B.push("strict"===n?L:X):t===W?B.push(_):29===t?B.push(_):43===t?131072<=A&&A<=196605||196608<=A&&A<=262141?B.push(X):B.push(_):void B.push(t);if(0===e)return s.push(e),B.push(_);var r=B[e-1];return-1===eA.indexOf(r)?(s.push(s[e-1]),B.push(r)):(s.push(e),B.push(_))}),[s,B,o]}(t,A.lineBreak),r=e[0],n=e[1],B=e[2];return"break-all"!==A.wordBreak&&"break-word"!==A.wordBreak||(n=n.map(function(A){return-1!==[D,_,W].indexOf(A)?X:A})),[r,n,"keep-all"===A.wordBreak?B.map(function(A,e){return A&&19968<=t[e]&&t[e]<=40959}):void 0]}var i,U,E,F,h,H=10,d=13,f=15,p=17,N=18,m=19,R=20,L=21,v=22,O=24,D=25,b=26,M=27,y=28,_=30,P=32,x=33,V=34,z=35,X=37,J=38,G=39,k=40,W=42,Y="×",q=(i=function(A){var e,t,r,n,B,s=.75*A.length,o=A.length,i=0;"="===A[A.length-1]&&(s--,"="===A[A.length-2]&&s--);var a="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array&&void 0!==Uint8Array.prototype.slice?new ArrayBuffer(s):new Array(s),c=Array.isArray(a)?a:new Uint8Array(a);for(e=0;e<o;e+=4)t=Q[A.charCodeAt(e)],r=Q[A.charCodeAt(e+1)],n=Q[A.charCodeAt(e+2)],B=Q[A.charCodeAt(e+3)],c[i++]=t<<2|r>>4,c[i++]=(15&r)<<4|n>>2,c[i++]=(3&n)<<6|63&B;return a}("KwAAAAAAAAAACA4AIDoAAPAfAAACAAAAAAAIABAAGABAAEgAUABYAF4AZgBeAGYAYABoAHAAeABeAGYAfACEAIAAiACQAJgAoACoAK0AtQC9AMUAXgBmAF4AZgBeAGYAzQDVAF4AZgDRANkA3gDmAOwA9AD8AAQBDAEUARoBIgGAAIgAJwEvATcBPwFFAU0BTAFUAVwBZAFsAXMBewGDATAAiwGTAZsBogGkAawBtAG8AcIBygHSAdoB4AHoAfAB+AH+AQYCDgIWAv4BHgImAi4CNgI+AkUCTQJTAlsCYwJrAnECeQKBAk0CiQKRApkCoQKoArACuALAAsQCzAIwANQC3ALkAjAA7AL0AvwCAQMJAxADGAMwACADJgMuAzYDPgOAAEYDSgNSA1IDUgNaA1oDYANiA2IDgACAAGoDgAByA3YDfgOAAIQDgACKA5IDmgOAAIAAogOqA4AAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAK8DtwOAAIAAvwPHA88D1wPfAyAD5wPsA/QD/AOAAIAABAQMBBIEgAAWBB4EJgQuBDMEIAM7BEEEXgBJBCADUQRZBGEEaQQwADAAcQQ+AXkEgQSJBJEEgACYBIAAoASoBK8EtwQwAL8ExQSAAIAAgACAAIAAgACgAM0EXgBeAF4AXgBeAF4AXgBeANUEXgDZBOEEXgDpBPEE+QQBBQkFEQUZBSEFKQUxBTUFPQVFBUwFVAVcBV4AYwVeAGsFcwV7BYMFiwWSBV4AmgWgBacFXgBeAF4AXgBeAKsFXgCyBbEFugW7BcIFwgXIBcIFwgXQBdQF3AXkBesF8wX7BQMGCwYTBhsGIwYrBjMGOwZeAD8GRwZNBl4AVAZbBl4AXgBeAF4AXgBeAF4AXgBeAF4AXgBeAGMGXgBqBnEGXgBeAF4AXgBeAF4AXgBeAF4AXgB5BoAG4wSGBo4GkwaAAIADHgR5AF4AXgBeAJsGgABGA4AAowarBrMGswagALsGwwbLBjAA0wbaBtoG3QbaBtoG2gbaBtoG2gblBusG8wb7BgMHCwcTBxsHCwcjBysHMAc1BzUHOgdCB9oGSgdSB1oHYAfaBloHaAfaBlIH2gbaBtoG2gbaBtoG2gbaBjUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHbQdeAF4ANQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQd1B30HNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1B4MH2gaKB68EgACAAIAAgACAAIAAgACAAI8HlwdeAJ8HpweAAIAArwe3B14AXgC/B8UHygcwANAH2AfgB4AA6AfwBz4B+AcACFwBCAgPCBcIogEYAR8IJwiAAC8INwg/CCADRwhPCFcIXwhnCEoDGgSAAIAAgABvCHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIfQh3CHgIeQh6CHsIfAh9CHcIeAh5CHoIewh8CH0Idwh4CHkIegh7CHwIhAiLCI4IMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlggwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAANQc1BzUHNQc1BzUHNQc1BzUHNQc1B54INQc1B6II2gaqCLIIugiAAIAAvgjGCIAAgACAAIAAgACAAIAAgACAAIAAywiHAYAA0wiAANkI3QjlCO0I9Aj8CIAAgACAAAIJCgkSCRoJIgknCTYHLwk3CZYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiWCJYIlgiAAIAAAAFAAXgBeAGAAcABeAHwAQACQAKAArQC9AJ4AXgBeAE0A3gBRAN4A7AD8AMwBGgEAAKcBNwEFAUwBXAF4QkhCmEKnArcCgAHHAsABz4LAAcABwAHAAd+C6ABoAG+C/4LAAcABwAHAAc+DF4MAAcAB54M3gweDV4Nng3eDaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAEeDqABVg6WDqABoQ6gAaABoAHXDvcONw/3DvcO9w73DvcO9w73DvcO9w73DvcO9w73DvcO9w73DvcO9w73DvcO9w73DvcO9w73DvcO9w73DvcO9w73DncPAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcAB7cPPwlGCU4JMACAAIAAgABWCV4JYQmAAGkJcAl4CXwJgAkwADAAMAAwAIgJgACLCZMJgACZCZ8JowmrCYAAswkwAF4AXgB8AIAAuwkABMMJyQmAAM4JgADVCTAAMAAwADAAgACAAIAAgACAAIAAgACAAIAAqwYWBNkIMAAwADAAMADdCeAJ6AnuCR4E9gkwAP4JBQoNCjAAMACAABUK0wiAAB0KJAosCjQKgAAwADwKQwqAAEsKvQmdCVMKWwowADAAgACAALcEMACAAGMKgABrCjAAMAAwADAAMAAwADAAMAAwADAAMAAeBDAAMAAwADAAMAAwADAAMAAwADAAMAAwAIkEPQFzCnoKiQSCCooKkAqJBJgKoAqkCokEGAGsCrQKvArBCjAAMADJCtEKFQHZCuEK/gHpCvEKMAAwADAAMACAAIwE+QowAIAAPwEBCzAAMAAwADAAMACAAAkLEQswAIAAPwEZCyELgAAOCCkLMAAxCzkLMAAwADAAMAAwADAAXgBeAEELMAAwADAAMAAwADAAMAAwAEkLTQtVC4AAXAtkC4AAiQkwADAAMAAwADAAMAAwADAAbAtxC3kLgAuFC4sLMAAwAJMLlwufCzAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAApwswADAAMACAAIAAgACvC4AAgACAAIAAgACAALcLMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAvwuAAMcLgACAAIAAgACAAIAAyguAAIAAgACAAIAA0QswADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAANkLgACAAIAA4AswADAAMAAwADAAMAAwADAAMAAwADAAMAAwAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACJCR4E6AswADAAhwHwC4AA+AsADAgMEAwwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMACAAIAAGAwdDCUMMAAwAC0MNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQw1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHPQwwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADUHNQc1BzUHNQc1BzUHNQc2BzAAMAA5DDUHNQc1BzUHNQc1BzUHNQc1BzUHNQdFDDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAgACAAIAATQxSDFoMMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAF4AXgBeAF4AXgBeAF4AYgxeAGoMXgBxDHkMfwxeAIUMXgBeAI0MMAAwADAAMAAwAF4AXgCVDJ0MMAAwADAAMABeAF4ApQxeAKsMswy7DF4Awgy9DMoMXgBeAF4AXgBeAF4AXgBeAF4AXgDRDNkMeQBqCeAM3Ax8AOYM7Az0DPgMXgBeAF4AXgBeAF4AXgBeAF4AXgBeAF4AXgBeAF4AXgCgAAANoAAHDQ4NFg0wADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAeDSYNMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAIAAgACAAIAAgACAAC4NMABeAF4ANg0wADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAD4NRg1ODVYNXg1mDTAAbQ0wADAAMAAwADAAMAAwADAA2gbaBtoG2gbaBtoG2gbaBnUNeg3CBYANwgWFDdoGjA3aBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gaUDZwNpA2oDdoG2gawDbcNvw3HDdoG2gbPDdYN3A3fDeYN2gbsDfMN2gbaBvoN/g3aBgYODg7aBl4AXgBeABYOXgBeACUG2gYeDl4AJA5eACwO2w3aBtoGMQ45DtoG2gbaBtoGQQ7aBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gZJDjUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1B1EO2gY1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQdZDjUHNQc1BzUHNQc1B2EONQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHaA41BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1B3AO2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gY1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1BzUHNQc1B2EO2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gZJDtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBtoG2gbaBkkOeA6gAKAAoAAwADAAMAAwAKAAoACgAKAAoACgAKAAgA4wADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAD//wQABAAEAAQABAAEAAQABAAEAA0AAwABAAEAAgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAKABMAFwAeABsAGgAeABcAFgASAB4AGwAYAA8AGAAcAEsASwBLAEsASwBLAEsASwBLAEsAGAAYAB4AHgAeABMAHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAFgAbABIAHgAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABYADQARAB4ABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAUABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAkAFgAaABsAGwAbAB4AHQAdAB4ATwAXAB4ADQAeAB4AGgAbAE8ATwAOAFAAHQAdAB0ATwBPABcATwBPAE8AFgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAB4AUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAFAATwBAAE8ATwBPAEAATwBQAFAATwBQAB4AHgAeAB4AHgAeAB0AHQAdAB0AHgAdAB4ADgBQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgBQAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAkACQAJAAkACQAJAAkABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAFAAHgAeAB4AKwArAFAAUABQAFAAGABQACsAKwArACsAHgAeAFAAHgBQAFAAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUAAeAB4AHgAeAB4AHgArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAYAA0AKwArAB4AHgAbACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAB4ABAAEAB4ABAAEABMABAArACsAKwArACsAKwArACsAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAKwArACsAKwArAFYAVgBWAB4AHgArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AGgAaABoAGAAYAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQAEwAEACsAEwATAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABLAEsASwBLAEsASwBLAEsASwBLABoAGQAZAB4AUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABMAUAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABABQAFAABAAEAB4ABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUAAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAFAABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQAUABQAB4AHgAYABMAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAFAABAAEAAQABAAEAFAABAAEAAQAUAAEAAQABAAEAAQAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArACsAHgArAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAABAAEAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAAQABAANAA0ASwBLAEsASwBLAEsASwBLAEsASwAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQAKwBQAFAAUABQAFAAUABQAFAAKwArAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAKwArACsAUABQAFAAUAArACsABABQAAQABAAEAAQABAAEAAQAKwArAAQABAArACsABAAEAAQAUAArACsAKwArACsAKwArACsABAArACsAKwArAFAAUAArAFAAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAGgAaAFAAUABQAFAAUABMAB4AGwBQAB4AKwArACsABAAEAAQAKwBQAFAAUABQAFAAUAArACsAKwArAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAUAArAFAAUAArAFAAUAArACsABAArAAQABAAEAAQABAArACsAKwArAAQABAArACsABAAEAAQAKwArACsABAArACsAKwArACsAKwArAFAAUABQAFAAKwBQACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwAEAAQAUABQAFAABAArACsAKwArACsAKwArACsAKwArACsABAAEAAQAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAUAArAFAAUABQAFAAUAArACsABABQAAQABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQAKwArAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwAeABsAKwArACsAKwArACsAKwBQAAQABAAEAAQABAAEACsABAAEAAQAKwBQAFAAUABQAFAAUABQAFAAKwArAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQAKwArAAQABAArACsABAAEAAQAKwArACsAKwArACsAKwArAAQABAArACsAKwArAFAAUAArAFAAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwAeAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwAEAFAAKwBQAFAAUABQAFAAUAArACsAKwBQAFAAUAArAFAAUABQAFAAKwArACsAUABQACsAUAArAFAAUAArACsAKwBQAFAAKwArACsAUABQAFAAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAAQABAAEAAQAKwArACsABAAEAAQAKwAEAAQABAAEACsAKwBQACsAKwArACsAKwArAAQAKwArACsAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAB4AHgAeAB4AHgAeABsAHgArACsAKwArACsABAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQABAArACsAKwArACsAKwArAAQABAArAFAAUABQACsAKwArACsAKwBQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAB4AUAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQABAArACsAKwArACsAKwArAAQABAArACsAKwArACsAKwArAFAAKwBQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAFAABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQABABQAB4AKwArACsAKwBQAFAAUAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQABoAUABQAFAAUABQAFAAKwArAAQABAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQACsAUAArACsAUABQAFAAUABQAFAAUAArACsAKwAEACsAKwArACsABAAEAAQABAAEAAQAKwAEACsABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArAAQABAAeACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAXAAqACoAKgAqACoAKgAqACsAKwArACsAGwBcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAeAEsASwBLAEsASwBLAEsASwBLAEsADQANACsAKwArACsAKwBcAFwAKwBcACsAKwBcAFwAKwBcACsAKwBcACsAKwArACsAKwArAFwAXABcAFwAKwBcAFwAXABcAFwAXABcACsAXABcAFwAKwBcACsAXAArACsAXABcACsAXABcAFwAXAAqAFwAXAAqACoAKgAqACoAKgArACoAKgBcACsAKwBcAFwAXABcAFwAKwBcACsAKgAqACoAKgAqACoAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArAFwAXABcAFwAUAAOAA4ADgAOAB4ADgAOAAkADgAOAA0ACQATABMAEwATABMACQAeABMAHgAeAB4ABAAEAB4AHgAeAB4AHgAeAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUAANAAQAHgAEAB4ABAAWABEAFgARAAQABABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAANAAQABAAEAAQABAANAAQABABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsADQANAB4AHgAeAB4AHgAeAAQAHgAeAB4AHgAeAB4AKwAeAB4ADgAOAA0ADgAeAB4AHgAeAB4ACQAJACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqAFwASwBLAEsASwBLAEsASwBLAEsASwANAA0AHgAeAB4AHgBcAFwAXABcAFwAXAAqACoAKgAqAFwAXABcAFwAKgAqACoAXAAqACoAKgBcAFwAKgAqACoAKgAqACoAKgBcAFwAXAAqACoAKgAqAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAKgAqACoAKgAqACoAKgAqACoAXAAqAEsASwBLAEsASwBLAEsASwBLAEsAKgAqACoAKgAqACoAUABQAFAAUABQAFAAKwBQACsAKwArACsAKwBQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQACsAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwAEAAQABAAeAA0AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQACsAKwANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABYAEQArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAADQANAA0AUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAABAAEAAQAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAA0ADQArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQACsABAAEACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoADQANABUAXAANAB4ADQAbAFwAKgArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArAB4AHgATABMADQANAA4AHgATABMAHgAEAAQABAAJACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAUABQAFAAUABQAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABABQACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwAeACsAKwArABMAEwBLAEsASwBLAEsASwBLAEsASwBLAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAKwBcAFwAXABcAFwAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBcACsAKwArACoAKgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEACsAKwAeAB4AXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAKgAqACoAKgAqACoAKgArACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgArACsABABLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKgAqACoAKgAqACoAKgBcACoAKgAqACoAKgAqACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQAUABQAFAAUABQAFAAUAArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsADQANAB4ADQANAA0ADQAeAB4AHgAeAB4AHgAeAB4AHgAeAAQABAAEAAQABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeACsAKwArAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAUABQAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAHgAeAB4AHgBQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwANAA0ADQANAA0ASwBLAEsASwBLAEsASwBLAEsASwArACsAKwBQAFAAUABLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAA0AUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsABAAEAAQAHgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAUABQAFAABABQAFAAUABQAAQABAAEAFAAUAAEAAQABAArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwAEAAQABAAEAAQAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUAArAFAAKwBQACsAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAHgAeAB4AHgAeAB4AHgAeAFAAHgAeAB4AUABQAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAKwArAB4AHgAeAB4AHgAeACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAUABQAFAAKwAeAB4AHgAeAB4AHgAeAA4AHgArAA0ADQANAA0ADQANAA0ACQANAA0ADQAIAAQACwAEAAQADQAJAA0ADQAMAB0AHQAeABcAFwAWABcAFwAXABYAFwAdAB0AHgAeABQAFAAUAA0AAQABAAQABAAEAAQABAAJABoAGgAaABoAGgAaABoAGgAeABcAFwAdABUAFQAeAB4AHgAeAB4AHgAYABYAEQAVABUAFQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgANAB4ADQANAA0ADQAeAA0ADQANAAcAHgAeAB4AHgArAAQABAAEAAQABAAEAAQABAAEAAQAUABQACsAKwBPAFAAUABQAFAAUAAeAB4AHgAWABEATwBQAE8ATwBPAE8AUABQAFAAUABQAB4AHgAeABYAEQArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAGwAbABsAGwAbABsAGwAaABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAaABsAGwAbABsAGgAbABsAGgAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgBQABoAHgAdAB4AUAAeABoAHgAeAB4AHgAeAB4AHgAeAB4ATwAeAFAAGwAeAB4AUABQAFAAUABQAB4AHgAeAB0AHQAeAFAAHgBQAB4AUAAeAFAATwBQAFAAHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAB4AUABQAFAAUABPAE8AUABQAFAAUABQAE8AUABQAE8AUABPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBQAFAAUABQAE8ATwBPAE8ATwBPAE8ATwBPAE8AUABQAFAAUABQAFAAUABQAFAAHgAeAFAAUABQAFAATwAeAB4AKwArACsAKwAdAB0AHQAdAB0AHQAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAeAB0AHQAeAB4AHgAdAB0AHgAeAB0AHgAeAB4AHQAeAB0AGwAbAB4AHQAeAB4AHgAeAB0AHgAeAB0AHQAdAB0AHgAeAB0AHgAdAB4AHQAdAB0AHQAdAB0AHgAdAB4AHgAeAB4AHgAdAB0AHQAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAdAB4AHgAeAB4AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB4AHgAdAB0AHQAdAB4AHgAdAB0AHgAeAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAeAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHQAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABQAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAlACUAHgAeAB4AHgAeAB4AHgAeAB4AFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBQAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB4AHgAeAB4AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAdAB0AHQAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAeAB0AHQAeAB4AHgAeAB0AHQAeAB4AHgAeAB0AHQAdAB4AHgAdAB4AHgAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB0AHQAeAB4AHQAeAB4AHgAeAB0AHQAeAB4AHgAeACUAJQAdAB0AJQAeACUAJQAlACAAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAHgAeAB4AHgAdAB4AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB4AHQAdAB0AHgAdACUAHQAdAB4AHQAdAB4AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAHQAdAB0AHQAlAB4AJQAlACUAHQAlACUAHQAdAB0AJQAlAB0AHQAlAB0AHQAlACUAJQAeAB0AHgAeAB4AHgAdAB0AJQAdAB0AHQAdAB0AHQAlACUAJQAlACUAHQAlACUAIAAlAB0AHQAlACUAJQAlACUAJQAlACUAHgAeAB4AJQAlACAAIAAgACAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHgAeABcAFwAXABcAFwAXAB4AEwATACUAHgAeAB4AFgARABYAEQAWABEAFgARABYAEQAWABEAFgARAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARABYAEQAWABEAFgARABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAEAAQABAAeAB4AKwArACsAKwArABMADQANAA0AUAATAA0AUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUAANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAA0ADQANAA0ADQANAA0ADQAeAA0AFgANAB4AHgAXABcAHgAeABcAFwAWABEAFgARABYAEQAWABEADQANAA0ADQATAFAADQANAB4ADQANAB4AHgAeAB4AHgAMAAwADQANAA0AHgANAA0AFgANAA0ADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArAA0AEQARACUAJQBHAFcAVwAWABEAFgARABYAEQAWABEAFgARACUAJQAWABEAFgARABYAEQAWABEAFQAWABEAEQAlAFcAVwBXAFcAVwBXAFcAVwBXAAQABAAEAAQABAAEACUAVwBXAFcAVwA2ACUAJQBXAFcAVwBHAEcAJQAlACUAKwBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBRAFcAUQBXAFEAVwBXAFcAVwBXAFcAUQBXAFcAVwBXAFcAVwBRAFEAKwArAAQABAAVABUARwBHAFcAFQBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBRAFcAVwBXAFcAVwBXAFEAUQBXAFcAVwBXABUAUQBHAEcAVwArACsAKwArACsAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwArACUAJQBXAFcAVwBXACUAJQAlACUAJQAlACUAJQAlACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArACsAKwArACUAJQAlACUAKwArACsAKwArACsAKwArACsAKwArACsAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACsAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAE8ATwBPAE8ATwBPAE8ATwAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlACUAJQAlACUAJQAlACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADQATAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABLAEsASwBLAEsASwBLAEsASwBLAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAABAAEAAQABAAeAAQABAAEAAQABAAEAAQABAAEAAQAHgBQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAeAA0ADQANAA0ADQArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAAQAUABQAFAABABQAFAAUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAeAB4AHgAeACsAKwArACsAUABQAFAAUABQAFAAHgAeABoAHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADgAOABMAEwArACsAKwArACsAKwArACsABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwANAA0ASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUAAeAB4AHgBQAA4AUAArACsAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArAB4AWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYACsAKwArAAQAHgAeAB4AHgAeAB4ADQANAA0AHgAeAB4AHgArAFAASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArAB4AHgBcAFwAXABcAFwAKgBcAFwAXABcAFwAXABcAFwAXABcAEsASwBLAEsASwBLAEsASwBLAEsAXABcAFwAXABcACsAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAFAAUABQAAQAUABQAFAAUABQAFAAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAHgANAA0ADQBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAXAAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAKgAqACoAXABcACoAKgBcAFwAXABcAFwAKgAqAFwAKgBcACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcACoAKgBQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAA0ADQBQAFAAUAAEAAQAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQADQAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAVABVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBUAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVACsAKwArACsAKwArACsAKwArACsAKwArAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAKwArACsAKwBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAKwArACsAKwAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAKwArACsAKwArAFYABABWAFYAVgBWAFYAVgBWAFYAVgBWAB4AVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgArAFYAVgBWAFYAVgArAFYAKwBWAFYAKwBWAFYAKwBWAFYAVgBWAFYAVgBWAFYAVgBWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAEQAWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAaAB4AKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAGAARABEAGAAYABMAEwAWABEAFAArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACUAJQAlACUAJQAWABEAFgARABYAEQAWABEAFgARABYAEQAlACUAFgARACUAJQAlACUAJQAlACUAEQAlABEAKwAVABUAEwATACUAFgARABYAEQAWABEAJQAlACUAJQAlACUAJQAlACsAJQAbABoAJQArACsAKwArAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAcAKwATACUAJQAbABoAJQAlABYAEQAlACUAEQAlABEAJQBXAFcAVwBXAFcAVwBXAFcAVwBXABUAFQAlACUAJQATACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXABYAJQARACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAWACUAEQAlABYAEQARABYAEQARABUAVwBRAFEAUQBRAFEAUQBRAFEAUQBRAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcARwArACsAVwBXAFcAVwBXAFcAKwArAFcAVwBXAFcAVwBXACsAKwBXAFcAVwBXAFcAVwArACsAVwBXAFcAKwArACsAGgAbACUAJQAlABsAGwArAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAAQAB0AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsADQANAA0AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsADQBQAFAAUABQACsAKwArACsAUABQAFAAUABQAFAAUABQAA0AUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUAArACsAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQACsAKwArAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgBQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwBQAFAAUABQAFAABAAEAAQAKwAEAAQAKwArACsAKwArAAQABAAEAAQAUABQAFAAUAArAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsABAAEAAQAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsADQANAA0ADQANAA0ADQANAB4AKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AUABQAFAAUABQAFAAUABQAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwArACsAUABQAFAAUABQAA0ADQANAA0ADQANABQAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwANAA0ADQANAA0ADQANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwBQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAA0ADQAeAB4AHgAeAB4AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsASwBLAEsASwBLAEsASwBLAEsASwANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAeAA4AUAArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAADQANAB4ADQAeAAQABAAEAB4AKwArAEsASwBLAEsASwBLAEsASwBLAEsAUAAOAFAADQANAA0AKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAANAA0AHgANAA0AHgAEACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAA0AKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsABAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAUAArACsAKwArACsAKwAEACsAKwArACsAKwBQAFAAUABQAFAABAAEACsAKwAEAAQABAAEAAQABAAEACsAKwArAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAQABABQAFAAUABQAA0ADQANAA0AHgBLAEsASwBLAEsASwBLAEsASwBLACsADQArAB4AKwArAAQABAAEAAQAUABQAB4AUAArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEACsAKwAEAAQABAAEAAQABAAEAAQABAAOAA0ADQATABMAHgAeAB4ADQANAA0ADQANAA0ADQANAA0ADQANAA0ADQANAA0AUABQAFAAUAAEAAQAKwArAAQADQANAB4AUAArACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAKwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAXABcAA0ADQANACoASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAFAABAAEAAQABAAOAB4ADQANAA0ADQAOAB4ABAArACsAKwArACsAKwArACsAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAUABQAFAAUAArACsAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAA0ADQANACsADgAOAA4ADQANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAAQABAAEAFAADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAOABMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAArACsAKwAEACsABAAEACsABAAEAAQABAAEAAQABABQAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABIAEgAQwBDAEMAUABQAFAAUABDAFAAUABQAEgAQwBIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABDAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwANAA0AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAANACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAA0ADQANAB4AHgAeAB4AHgAeAFAAUABQAFAADQAeACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAEcARwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwArACsAKwArACsAKwArACsAKwArACsAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQACsAKwAeAAQABAANAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAB4AHgAeAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAHgAeAAQABAAEAAQABAAEAAQAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAEAAQABAAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAFAAUAArACsAUAArACsAUABQACsAKwBQAFAAUABQACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQACsAUABQAFAAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAKwAeAB4AUABQAFAAUABQACsAUAArACsAKwBQAFAAUABQAFAAUABQACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AKwArAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAEAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAeAB4ADQANAA0ADQAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABAArAAQABAArAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAEAAQABAAEAAQABAAEACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAFgAWAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArAFAAKwArAFAAKwBQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUAArAFAAKwBQACsAKwArACsAKwArAFAAKwArACsAKwBQACsAUAArAFAAKwBQAFAAUAArAFAAUAArAFAAKwArAFAAKwBQACsAUAArAFAAKwBQACsAUABQACsAUAArACsAUABQAFAAUAArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQACsAUABQAFAAUAArAFAAKwBQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwBQAFAAUAArAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAlACUAJQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeACUAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeACUAJQAlACUAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQAlACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeACUAJQAlACUAJQAeACUAJQAlACUAJQAgACAAIAAlACUAIAAlACUAIAAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAIQAhACEAIQAhACUAJQAgACAAJQAlACAAIAAgACAAIAAgACAAIAAgACAAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAIAAgACAAIAAlACUAJQAlACAAJQAgACAAIAAgACAAIAAgACAAIAAlACUAJQAgACUAJQAlACUAIAAgACAAJQAgACAAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeACUAHgAlAB4AJQAlACUAJQAlACAAJQAlACUAJQAeACUAHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAIAAgACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAIAAlACUAJQAlACAAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAIAAgACAAJQAlACUAIAAgACAAIAAgAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFwAXABcAFQAVABUAHgAeAB4AHgAlACUAJQAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAIAAgACAAJQAlACUAJQAlACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACAAIAAlACAAIAAlACUAJQAlACUAJQAgACUAJQAlACUAJQAlACUAJQAlACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAIAAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACsAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsA"),U=Array.isArray(i)?function(A){for(var e=A.length,t=[],r=0;r<e;r+=4)t.push(A[r+3]<<24|A[r+2]<<16|A[r+1]<<8|A[r]);return t}(i):new Uint32Array(i),E=Array.isArray(i)?function(A){for(var e=A.length,t=[],r=0;r<e;r+=2)t.push(A[r+1]<<8|A[r]);return t}(i):new Uint16Array(i),F=B(E,12,U[4]/2),h=2===U[5]?B(E,(24+U[4])/2):function(A,e,t){return A.slice?A.slice(e,t):new Uint32Array(Array.prototype.slice.call(A,e,t))}(U,Math.ceil((24+U[4])/4)),new s(U[0],U[1],U[2],U[3],F,h)),Z=[_,36],j=[1,2,3,5],$=[H,8],AA=[M,b],eA=j.concat($),tA=[J,G,k,V,z],rA=[f,d],nA=(BA.prototype.slice=function(){return l.apply(void 0,this.codePoints.slice(this.start,this.end))},BA);function BA(A,e,t,r){this.codePoints=A,this.required="!"===e,this.start=t,this.end=r}var sA,oA;(oA=sA||(sA={}))[oA.STRING_TOKEN=0]="STRING_TOKEN",oA[oA.BAD_STRING_TOKEN=1]="BAD_STRING_TOKEN",oA[oA.LEFT_PARENTHESIS_TOKEN=2]="LEFT_PARENTHESIS_TOKEN",oA[oA.RIGHT_PARENTHESIS_TOKEN=3]="RIGHT_PARENTHESIS_TOKEN",oA[oA.COMMA_TOKEN=4]="COMMA_TOKEN",oA[oA.HASH_TOKEN=5]="HASH_TOKEN",oA[oA.DELIM_TOKEN=6]="DELIM_TOKEN",oA[oA.AT_KEYWORD_TOKEN=7]="AT_KEYWORD_TOKEN",oA[oA.PREFIX_MATCH_TOKEN=8]="PREFIX_MATCH_TOKEN",oA[oA.DASH_MATCH_TOKEN=9]="DASH_MATCH_TOKEN",oA[oA.INCLUDE_MATCH_TOKEN=10]="INCLUDE_MATCH_TOKEN",oA[oA.LEFT_CURLY_BRACKET_TOKEN=11]="LEFT_CURLY_BRACKET_TOKEN",oA[oA.RIGHT_CURLY_BRACKET_TOKEN=12]="RIGHT_CURLY_BRACKET_TOKEN",oA[oA.SUFFIX_MATCH_TOKEN=13]="SUFFIX_MATCH_TOKEN",oA[oA.SUBSTRING_MATCH_TOKEN=14]="SUBSTRING_MATCH_TOKEN",oA[oA.DIMENSION_TOKEN=15]="DIMENSION_TOKEN",oA[oA.PERCENTAGE_TOKEN=16]="PERCENTAGE_TOKEN",oA[oA.NUMBER_TOKEN=17]="NUMBER_TOKEN",oA[oA.FUNCTION=18]="FUNCTION",oA[oA.FUNCTION_TOKEN=19]="FUNCTION_TOKEN",oA[oA.IDENT_TOKEN=20]="IDENT_TOKEN",oA[oA.COLUMN_TOKEN=21]="COLUMN_TOKEN",oA[oA.URL_TOKEN=22]="URL_TOKEN",oA[oA.BAD_URL_TOKEN=23]="BAD_URL_TOKEN",oA[oA.CDC_TOKEN=24]="CDC_TOKEN",oA[oA.CDO_TOKEN=25]="CDO_TOKEN",oA[oA.COLON_TOKEN=26]="COLON_TOKEN",oA[oA.SEMICOLON_TOKEN=27]="SEMICOLON_TOKEN",oA[oA.LEFT_SQUARE_BRACKET_TOKEN=28]="LEFT_SQUARE_BRACKET_TOKEN",oA[oA.RIGHT_SQUARE_BRACKET_TOKEN=29]="RIGHT_SQUARE_BRACKET_TOKEN",oA[oA.UNICODE_RANGE_TOKEN=30]="UNICODE_RANGE_TOKEN",oA[oA.WHITESPACE_TOKEN=31]="WHITESPACE_TOKEN",oA[oA.EOF_TOKEN=32]="EOF_TOKEN";function iA(A){return 48<=A&&A<=57}function aA(A){return iA(A)||65<=A&&A<=70||97<=A&&A<=102}function cA(A){return 10===A||9===A||32===A}function QA(A){return function(A){return function(A){return 97<=A&&A<=122}(A)||function(A){return 65<=A&&A<=90}(A)}(A)||function(A){return 128<=A}(A)||95===A}function wA(A){return QA(A)||iA(A)||45===A}function uA(A,e){return 92===A&&10!==e}function UA(A,e,t){return 45===A?QA(e)||uA(e,t):!!QA(A)||!(92!==A||!uA(A,e))}function lA(A,e,t){return 43===A||45===A?!!iA(e)||46===e&&iA(t):iA(46===A?e:A)}var CA={type:sA.LEFT_PARENTHESIS_TOKEN},gA={type:sA.RIGHT_PARENTHESIS_TOKEN},EA={type:sA.COMMA_TOKEN},FA={type:sA.SUFFIX_MATCH_TOKEN},hA={type:sA.PREFIX_MATCH_TOKEN},HA={type:sA.COLUMN_TOKEN},dA={type:sA.DASH_MATCH_TOKEN},fA={type:sA.INCLUDE_MATCH_TOKEN},pA={type:sA.LEFT_CURLY_BRACKET_TOKEN},NA={type:sA.RIGHT_CURLY_BRACKET_TOKEN},KA={type:sA.SUBSTRING_MATCH_TOKEN},IA={type:sA.BAD_URL_TOKEN},TA={type:sA.BAD_STRING_TOKEN},mA={type:sA.CDO_TOKEN},RA={type:sA.CDC_TOKEN},LA={type:sA.COLON_TOKEN},vA={type:sA.SEMICOLON_TOKEN},OA={type:sA.LEFT_SQUARE_BRACKET_TOKEN},DA={type:sA.RIGHT_SQUARE_BRACKET_TOKEN},bA={type:sA.WHITESPACE_TOKEN},SA={type:sA.EOF_TOKEN},MA=(yA.prototype.write=function(A){this._value=this._value.concat(c(A))},yA.prototype.read=function(){for(var A=[],e=this.consumeToken();e!==SA;)A.push(e),e=this.consumeToken();return A},yA.prototype.consumeToken=function(){var A=this.consumeCodePoint();switch(A){case 34:return this.consumeStringToken(34);case 35:var e=this.peekCodePoint(0),t=this.peekCodePoint(1),r=this.peekCodePoint(2);if(wA(e)||uA(t,r)){var n=UA(e,t,r)?2:1,B=this.consumeName();return{type:sA.HASH_TOKEN,value:B,flags:n}}break;case 36:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),FA;break;case 39:return this.consumeStringToken(39);case 40:return CA;case 41:return gA;case 42:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),KA;break;case 43:if(lA(A,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(A),this.consumeNumericToken();break;case 44:return EA;case 45:var s=A,o=this.peekCodePoint(0),i=this.peekCodePoint(1);if(lA(s,o,i))return this.reconsumeCodePoint(A),this.consumeNumericToken();if(UA(s,o,i))return this.reconsumeCodePoint(A),this.consumeIdentLikeToken();if(45===o&&62===i)return this.consumeCodePoint(),this.consumeCodePoint(),RA;break;case 46:if(lA(A,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(A),this.consumeNumericToken();break;case 47:if(42===this.peekCodePoint(0))for(this.consumeCodePoint();;){var a=this.consumeCodePoint();if(42===a&&47===(a=this.consumeCodePoint()))return this.consumeToken();if(-1===a)return this.consumeToken()}break;case 58:return LA;case 59:return vA;case 60:if(33===this.peekCodePoint(0)&&45===this.peekCodePoint(1)&&45===this.peekCodePoint(2))return this.consumeCodePoint(),this.consumeCodePoint(),mA;break;case 64:var c=this.peekCodePoint(0),Q=this.peekCodePoint(1),w=this.peekCodePoint(2);if(UA(c,Q,w))return B=this.consumeName(),{type:sA.AT_KEYWORD_TOKEN,value:B};break;case 91:return OA;case 92:if(uA(A,this.peekCodePoint(0)))return this.reconsumeCodePoint(A),this.consumeIdentLikeToken();break;case 93:return DA;case 61:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),hA;break;case 123:return pA;case 125:return NA;case 117:case 85:var u=this.peekCodePoint(0),U=this.peekCodePoint(1);return 43!==u||!aA(U)&&63!==U||(this.consumeCodePoint(),this.consumeUnicodeRangeToken()),this.reconsumeCodePoint(A),this.consumeIdentLikeToken();case 124:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),dA;if(124===this.peekCodePoint(0))return this.consumeCodePoint(),HA;break;case 126:if(61===this.peekCodePoint(0))return this.consumeCodePoint(),fA;break;case-1:return SA}return cA(A)?(this.consumeWhiteSpace(),bA):iA(A)?(this.reconsumeCodePoint(A),this.consumeNumericToken()):QA(A)?(this.reconsumeCodePoint(A),this.consumeIdentLikeToken()):{type:sA.DELIM_TOKEN,value:l(A)}},yA.prototype.consumeCodePoint=function(){var A=this._value.shift();return void 0===A?-1:A},yA.prototype.reconsumeCodePoint=function(A){this._value.unshift(A)},yA.prototype.peekCodePoint=function(A){return A>=this._value.length?-1:this._value[A]},yA.prototype.consumeUnicodeRangeToken=function(){for(var A=[],e=this.consumeCodePoint();aA(e)&&A.length<6;)A.push(e),e=this.consumeCodePoint();for(var t=!1;63===e&&A.length<6;)A.push(e),e=this.consumeCodePoint(),t=!0;if(t){var r=parseInt(l.apply(void 0,A.map(function(A){return 63===A?48:A})),16),n=parseInt(l.apply(void 0,A.map(function(A){return 63===A?70:A})),16);return{type:sA.UNICODE_RANGE_TOKEN,start:r,end:n}}var B=parseInt(l.apply(void 0,A),16);if(45===this.peekCodePoint(0)&&aA(this.peekCodePoint(1))){this.consumeCodePoint(),e=this.consumeCodePoint();for(var s=[];aA(e)&&s.length<6;)s.push(e),e=this.consumeCodePoint();return n=parseInt(l.apply(void 0,s),16),{type:sA.UNICODE_RANGE_TOKEN,start:B,end:n}}return{type:sA.UNICODE_RANGE_TOKEN,start:B,end:B}},yA.prototype.consumeIdentLikeToken=function(){var A=this.consumeName();return"url"===A.toLowerCase()&&40===this.peekCodePoint(0)?(this.consumeCodePoint(),this.consumeUrlToken()):40===this.peekCodePoint(0)?(this.consumeCodePoint(),{type:sA.FUNCTION_TOKEN,value:A}):{type:sA.IDENT_TOKEN,value:A}},yA.prototype.consumeUrlToken=function(){var A=[];if(this.consumeWhiteSpace(),-1===this.peekCodePoint(0))return{type:sA.URL_TOKEN,value:""};var e,t=this.peekCodePoint(0);if(39===t||34===t){var r=this.consumeStringToken(this.consumeCodePoint());return r.type===sA.STRING_TOKEN&&(this.consumeWhiteSpace(),-1===this.peekCodePoint(0)||41===this.peekCodePoint(0))?(this.consumeCodePoint(),{type:sA.URL_TOKEN,value:r.value}):(this.consumeBadUrlRemnants(),IA)}for(;;){var n=this.consumeCodePoint();if(-1===n||41===n)return{type:sA.URL_TOKEN,value:l.apply(void 0,A)};if(cA(n))return this.consumeWhiteSpace(),-1===this.peekCodePoint(0)||41===this.peekCodePoint(0)?(this.consumeCodePoint(),{type:sA.URL_TOKEN,value:l.apply(void 0,A)}):(this.consumeBadUrlRemnants(),IA);if(34===n||39===n||40===n||0<=(e=n)&&e<=8||11===e||14<=e&&e<=31||127===e)return this.consumeBadUrlRemnants(),IA;if(92===n){if(!uA(n,this.peekCodePoint(0)))return this.consumeBadUrlRemnants(),IA;A.push(this.consumeEscapedCodePoint())}else A.push(n)}},yA.prototype.consumeWhiteSpace=function(){for(;cA(this.peekCodePoint(0));)this.consumeCodePoint()},yA.prototype.consumeBadUrlRemnants=function(){for(;;){var A=this.consumeCodePoint();if(41===A||-1===A)return;uA(A,this.peekCodePoint(0))&&this.consumeEscapedCodePoint()}},yA.prototype.consumeStringSlice=function(A){for(var e="";0<A;){var t=Math.min(6e4,A);e+=l.apply(void 0,this._value.splice(0,t)),A-=t}return this._value.shift(),e},yA.prototype.consumeStringToken=function(A){for(var e="",t=0;;){var r=this._value[t];if(-1===r||void 0===r||r===A)return e+=this.consumeStringSlice(t),{type:sA.STRING_TOKEN,value:e};if(10===r)return this._value.splice(0,t),TA;if(92===r){var n=this._value[t+1];-1!==n&&void 0!==n&&(10===n?(e+=this.consumeStringSlice(t),t=-1,this._value.shift()):uA(r,n)&&(e+=this.consumeStringSlice(t),e+=l(this.consumeEscapedCodePoint()),t=-1))}t++}},yA.prototype.consumeNumber=function(){var A=[],e=4,t=this.peekCodePoint(0);for(43!==t&&45!==t||A.push(this.consumeCodePoint());iA(this.peekCodePoint(0));)A.push(this.consumeCodePoint());t=this.peekCodePoint(0);var r=this.peekCodePoint(1);if(46===t&&iA(r))for(A.push(this.consumeCodePoint(),this.consumeCodePoint()),e=8;iA(this.peekCodePoint(0));)A.push(this.consumeCodePoint());t=this.peekCodePoint(0),r=this.peekCodePoint(1);var n=this.peekCodePoint(2);if((69===t||101===t)&&((43===r||45===r)&&iA(n)||iA(r)))for(A.push(this.consumeCodePoint(),this.consumeCodePoint()),e=8;iA(this.peekCodePoint(0));)A.push(this.consumeCodePoint());return[function(A){var e=0,t=1;43!==A[e]&&45!==A[e]||(45===A[e]&&(t=-1),e++);for(var r=[];iA(A[e]);)r.push(A[e++]);var n=r.length?parseInt(l.apply(void 0,r),10):0;46===A[e]&&e++;for(var B=[];iA(A[e]);)B.push(A[e++]);var s=B.length,o=s?parseInt(l.apply(void 0,B),10):0;69!==A[e]&&101!==A[e]||e++;var i=1;43!==A[e]&&45!==A[e]||(45===A[e]&&(i=-1),e++);for(var a=[];iA(A[e]);)a.push(A[e++]);var c=a.length?parseInt(l.apply(void 0,a),10):0;return t*(n+o*Math.pow(10,-s))*Math.pow(10,i*c)}(A),e]},yA.prototype.consumeNumericToken=function(){var A=this.consumeNumber(),e=A[0],t=A[1],r=this.peekCodePoint(0),n=this.peekCodePoint(1),B=this.peekCodePoint(2);if(UA(r,n,B)){var s=this.consumeName();return{type:sA.DIMENSION_TOKEN,number:e,flags:t,unit:s}}return 37===r?(this.consumeCodePoint(),{type:sA.PERCENTAGE_TOKEN,number:e,flags:t}):{type:sA.NUMBER_TOKEN,number:e,flags:t}},yA.prototype.consumeEscapedCodePoint=function(){var A=this.consumeCodePoint();if(aA(A)){for(var e=l(A);aA(this.peekCodePoint(0))&&e.length<6;)e+=l(this.consumeCodePoint());cA(this.peekCodePoint(0))&&this.consumeCodePoint();var t=parseInt(e,16);return 0===t||function(A){return 55296<=A&&A<=57343}(t)||1114111<t?65533:t}return-1===A?65533:A},yA.prototype.consumeName=function(){for(var A="";;){var e=this.consumeCodePoint();if(wA(e))A+=l(e);else{if(!uA(e,this.peekCodePoint(0)))return this.reconsumeCodePoint(e),A;A+=l(this.consumeEscapedCodePoint())}}},yA);function yA(){this._value=[]}var _A=(PA.create=function(A){var e=new MA;return e.write(A),new PA(e.read())},PA.parseValue=function(A){return PA.create(A).parseComponentValue()},PA.parseValues=function(A){return PA.create(A).parseComponentValues()},PA.prototype.parseComponentValue=function(){for(var A=this.consumeToken();A.type===sA.WHITESPACE_TOKEN;)A=this.consumeToken();if(A.type===sA.EOF_TOKEN)throw new SyntaxError("Error parsing CSS component value, unexpected EOF");this.reconsumeToken(A);for(var e=this.consumeComponentValue();(A=this.consumeToken()).type===sA.WHITESPACE_TOKEN;);if(A.type===sA.EOF_TOKEN)return e;throw new SyntaxError("Error parsing CSS component value, multiple values found when expecting only one")},PA.prototype.parseComponentValues=function(){for(var A=[];;){var e=this.consumeComponentValue();if(e.type===sA.EOF_TOKEN)return A;A.push(e),A.push()}},PA.prototype.consumeComponentValue=function(){var A=this.consumeToken();switch(A.type){case sA.LEFT_CURLY_BRACKET_TOKEN:case sA.LEFT_SQUARE_BRACKET_TOKEN:case sA.LEFT_PARENTHESIS_TOKEN:return this.consumeSimpleBlock(A.type);case sA.FUNCTION_TOKEN:return this.consumeFunction(A)}return A},PA.prototype.consumeSimpleBlock=function(A){for(var e={type:A,values:[]},t=this.consumeToken();;){if(t.type===sA.EOF_TOKEN||Be(t,A))return e;this.reconsumeToken(t),e.values.push(this.consumeComponentValue()),t=this.consumeToken()}},PA.prototype.consumeFunction=function(A){for(var e={name:A.value,values:[],type:sA.FUNCTION};;){var t=this.consumeToken();if(t.type===sA.EOF_TOKEN||t.type===sA.RIGHT_PARENTHESIS_TOKEN)return e;this.reconsumeToken(t),e.values.push(this.consumeComponentValue())}},PA.prototype.consumeToken=function(){var A=this._tokens.shift();return void 0===A?SA:A},PA.prototype.reconsumeToken=function(A){this._tokens.unshift(A)},PA);function PA(A){this._tokens=A}function xA(A){return A.type===sA.DIMENSION_TOKEN}function VA(A){return A.type===sA.NUMBER_TOKEN}function zA(A){return A.type===sA.IDENT_TOKEN}function XA(A){return A.type===sA.STRING_TOKEN}function JA(A,e){return zA(A)&&A.value===e}function GA(A){return A.type!==sA.WHITESPACE_TOKEN}function kA(A){return A.type!==sA.WHITESPACE_TOKEN&&A.type!==sA.COMMA_TOKEN}function WA(A){var e=[],t=[];return A.forEach(function(A){if(A.type===sA.COMMA_TOKEN){if(0===t.length)throw new Error("Error parsing function args, zero tokens for arg");return e.push(t),void(t=[])}A.type!==sA.WHITESPACE_TOKEN&&t.push(A)}),t.length&&e.push(t),e}function YA(A){return A.type===sA.NUMBER_TOKEN||A.type===sA.DIMENSION_TOKEN}function qA(A){return A.type===sA.PERCENTAGE_TOKEN||YA(A)}function ZA(A){return 1<A.length?[A[0],A[1]]:[A[0]]}function jA(A,e,t){var r=A[0],n=A[1];return[ae(r,e),ae(void 0!==n?n:r,t)]}function $A(A){return A.type===sA.DIMENSION_TOKEN&&("deg"===A.unit||"grad"===A.unit||"rad"===A.unit||"turn"===A.unit)}function Ae(A){switch(A.filter(zA).map(function(A){return A.value}).join(" ")){case"to bottom right":case"to right bottom":case"left top":case"top left":return[se,se];case"to top":case"bottom":return Qe(0);case"to bottom left":case"to left bottom":case"right top":case"top right":return[se,ie];case"to right":case"left":return Qe(90);case"to top left":case"to left top":case"right bottom":case"bottom right":return[ie,ie];case"to bottom":case"top":return Qe(180);case"to top right":case"to right top":case"left bottom":case"bottom left":return[ie,se];case"to left":case"right":return Qe(270)}return 0}function ee(A){return 0==(255&A)}function te(A){var e=255&A,t=255&A>>8,r=255&A>>16,n=255&A>>24;return e<255?"rgba("+n+","+r+","+t+","+e/255+")":"rgb("+n+","+r+","+t+")"}function re(A,e){if(A.type===sA.NUMBER_TOKEN)return A.number;if(A.type!==sA.PERCENTAGE_TOKEN)return 0;var t=3===e?1:255;return 3===e?A.number/100*t:Math.round(A.number/100*t)}function ne(A){var e=A.filter(kA);if(3===e.length){var t=e.map(re),r=t[0],n=t[1],B=t[2];return ue(r,n,B,1)}if(4!==e.length)return 0;var s=e.map(re),o=(r=s[0],n=s[1],B=s[2],s[3]);return ue(r,n,B,o)}var Be=function(A,e){return e===sA.LEFT_CURLY_BRACKET_TOKEN&&A.type===sA.RIGHT_CURLY_BRACKET_TOKEN||(e===sA.LEFT_SQUARE_BRACKET_TOKEN&&A.type===sA.RIGHT_SQUARE_BRACKET_TOKEN||e===sA.LEFT_PARENTHESIS_TOKEN&&A.type===sA.RIGHT_PARENTHESIS_TOKEN)},se={type:sA.NUMBER_TOKEN,number:0,flags:4},oe={type:sA.PERCENTAGE_TOKEN,number:50,flags:4},ie={type:sA.PERCENTAGE_TOKEN,number:100,flags:4},ae=function(A,e){if(A.type===sA.PERCENTAGE_TOKEN)return A.number/100*e;if(xA(A))switch(A.unit){case"rem":case"em":return 16*A.number;case"px":default:return A.number}return A.number},ce=function(A){if(A.type===sA.DIMENSION_TOKEN)switch(A.unit){case"deg":return Math.PI*A.number/180;case"grad":return Math.PI/200*A.number;case"rad":return A.number;case"turn":return 2*Math.PI*A.number}throw new Error("Unsupported angle type")},Qe=function(A){return Math.PI*A/180},we=function(A){if(A.type===sA.FUNCTION){var e=he[A.name];if(void 0===e)throw new Error('Attempting to parse an unsupported color function "'+A.name+'"');return e(A.values)}if(A.type===sA.HASH_TOKEN){if(3===A.value.length){var t=A.value.substring(0,1),r=A.value.substring(1,2),n=A.value.substring(2,3);return ue(parseInt(t+t,16),parseInt(r+r,16),parseInt(n+n,16),1)}if(4===A.value.length){t=A.value.substring(0,1),r=A.value.substring(1,2),n=A.value.substring(2,3);var B=A.value.substring(3,4);return ue(parseInt(t+t,16),parseInt(r+r,16),parseInt(n+n,16),parseInt(B+B,16)/255)}if(6===A.value.length){t=A.value.substring(0,2),r=A.value.substring(2,4),n=A.value.substring(4,6);return ue(parseInt(t,16),parseInt(r,16),parseInt(n,16),1)}if(8===A.value.length){t=A.value.substring(0,2),r=A.value.substring(2,4),n=A.value.substring(4,6),B=A.value.substring(6,8);return ue(parseInt(t,16),parseInt(r,16),parseInt(n,16),parseInt(B,16)/255)}}if(A.type===sA.IDENT_TOKEN){var s=He[A.value.toUpperCase()];if(void 0!==s)return s}return He.TRANSPARENT},ue=function(A,e,t,r){return(A<<24|e<<16|t<<8|Math.round(255*r)<<0)>>>0};function Ue(A,e,t){return t<0&&(t+=1),1<=t&&(t-=1),t<1/6?(e-A)*t*6+A:t<.5?e:t<2/3?6*(e-A)*(2/3-t)+A:A}function le(A){var e=A.filter(kA),t=e[0],r=e[1],n=e[2],B=e[3],s=(t.type===sA.NUMBER_TOKEN?Qe(t.number):ce(t))/(2*Math.PI),o=qA(r)?r.number/100:0,i=qA(n)?n.number/100:0,a=void 0!==B&&qA(B)?ae(B,1):1;if(0==o)return ue(255*i,255*i,255*i,1);var c=i<=.5?i*(1+o):i+o-i*o,Q=2*i-c,w=Ue(Q,c,s+1/3),u=Ue(Q,c,s),U=Ue(Q,c,s-1/3);return ue(255*w,255*u,255*U,a)}var Ce,ge,Ee,Fe,he={hsl:le,hsla:le,rgb:ne,rgba:ne},He={ALICEBLUE:4042850303,ANTIQUEWHITE:4209760255,AQUA:16777215,AQUAMARINE:2147472639,AZURE:4043309055,BEIGE:4126530815,BISQUE:4293182719,BLACK:255,BLANCHEDALMOND:4293643775,BLUE:65535,BLUEVIOLET:2318131967,BROWN:2771004159,BURLYWOOD:3736635391,CADETBLUE:1604231423,CHARTREUSE:2147418367,CHOCOLATE:3530104575,CORAL:4286533887,CORNFLOWERBLUE:1687547391,CORNSILK:4294499583,CRIMSON:3692313855,CYAN:16777215,DARKBLUE:35839,DARKCYAN:9145343,DARKGOLDENROD:3095837695,DARKGRAY:2846468607,DARKGREEN:6553855,DARKGREY:2846468607,DARKKHAKI:3182914559,DARKMAGENTA:2332068863,DARKOLIVEGREEN:1433087999,DARKORANGE:4287365375,DARKORCHID:2570243327,DARKRED:2332033279,DARKSALMON:3918953215,DARKSEAGREEN:2411499519,DARKSLATEBLUE:1211993087,DARKSLATEGRAY:793726975,DARKSLATEGREY:793726975,DARKTURQUOISE:13554175,DARKVIOLET:2483082239,DEEPPINK:4279538687,DEEPSKYBLUE:12582911,DIMGRAY:1768516095,DIMGREY:1768516095,DODGERBLUE:512819199,FIREBRICK:2988581631,FLORALWHITE:4294635775,FORESTGREEN:579543807,FUCHSIA:4278255615,GAINSBORO:3705462015,GHOSTWHITE:4177068031,GOLD:4292280575,GOLDENROD:3668254975,GRAY:2155905279,GREEN:8388863,GREENYELLOW:2919182335,GREY:2155905279,HONEYDEW:4043305215,HOTPINK:4285117695,INDIANRED:3445382399,INDIGO:1258324735,IVORY:4294963455,KHAKI:4041641215,LAVENDER:3873897215,LAVENDERBLUSH:4293981695,LAWNGREEN:2096890111,LEMONCHIFFON:4294626815,LIGHTBLUE:2916673279,LIGHTCORAL:4034953471,LIGHTCYAN:3774873599,LIGHTGOLDENRODYELLOW:4210742015,LIGHTGRAY:3553874943,LIGHTGREEN:2431553791,LIGHTGREY:3553874943,LIGHTPINK:4290167295,LIGHTSALMON:4288707327,LIGHTSEAGREEN:548580095,LIGHTSKYBLUE:2278488831,LIGHTSLATEGRAY:2005441023,LIGHTSLATEGREY:2005441023,LIGHTSTEELBLUE:2965692159,LIGHTYELLOW:4294959359,LIME:16711935,LIMEGREEN:852308735,LINEN:4210091775,MAGENTA:4278255615,MAROON:2147483903,MEDIUMAQUAMARINE:1724754687,MEDIUMBLUE:52735,MEDIUMORCHID:3126187007,MEDIUMPURPLE:2473647103,MEDIUMSEAGREEN:1018393087,MEDIUMSLATEBLUE:2070474495,MEDIUMSPRINGGREEN:16423679,MEDIUMTURQUOISE:1221709055,MEDIUMVIOLETRED:3340076543,MIDNIGHTBLUE:421097727,MINTCREAM:4127193855,MISTYROSE:4293190143,MOCCASIN:4293178879,NAVAJOWHITE:4292783615,NAVY:33023,OLDLACE:4260751103,OLIVE:2155872511,OLIVEDRAB:1804477439,ORANGE:4289003775,ORANGERED:4282712319,ORCHID:3664828159,PALEGOLDENROD:4008225535,PALEGREEN:2566625535,PALETURQUOISE:2951671551,PALEVIOLETRED:3681588223,PAPAYAWHIP:4293907967,PEACHPUFF:4292524543,PERU:3448061951,PINK:4290825215,PLUM:3718307327,POWDERBLUE:2967529215,PURPLE:2147516671,REBECCAPURPLE:1714657791,RED:4278190335,ROSYBROWN:3163525119,ROYALBLUE:1097458175,SADDLEBROWN:2336560127,SALMON:4202722047,SANDYBROWN:4104413439,SEAGREEN:780883967,SEASHELL:4294307583,SIENNA:2689740287,SILVER:3233857791,SKYBLUE:2278484991,SLATEBLUE:1784335871,SLATEGRAY:1887473919,SLATEGREY:1887473919,SNOW:4294638335,SPRINGGREEN:16744447,STEELBLUE:1182971135,TAN:3535047935,TEAL:8421631,THISTLE:3636451583,TOMATO:4284696575,TRANSPARENT:0,TURQUOISE:1088475391,VIOLET:4001558271,WHEAT:4125012991,WHITE:4294967295,WHITESMOKE:4126537215,YELLOW:4294902015,YELLOWGREEN:2597139199};(ge=Ce||(Ce={}))[ge.VALUE=0]="VALUE",ge[ge.LIST=1]="LIST",ge[ge.IDENT_VALUE=2]="IDENT_VALUE",ge[ge.TYPE_VALUE=3]="TYPE_VALUE",ge[ge.TOKEN_VALUE=4]="TOKEN_VALUE",(Fe=Ee||(Ee={}))[Fe.BORDER_BOX=0]="BORDER_BOX",Fe[Fe.PADDING_BOX=1]="PADDING_BOX";function de(A){var e=we(A[0]),t=A[1];return t&&qA(t)?{color:e,stop:t}:{color:e,stop:null}}function fe(A,t){var e=A[0],r=A[A.length-1];null===e.stop&&(e.stop=se),null===r.stop&&(r.stop=ie);for(var n=[],B=0,s=0;s<A.length;s++){var o=A[s].stop;if(null!==o){var i=ae(o,t);B<i?n.push(i):n.push(B),B=i}else n.push(null)}var a=null;for(s=0;s<n.length;s++){var c=n[s];if(null===c)null===a&&(a=s);else if(null!==a){for(var Q=s-a,w=(c-n[a-1])/(1+Q),u=1;u<=Q;u++)n[a+u-1]=w*u;a=null}}return A.map(function(A,e){return{color:A.color,stop:Math.max(Math.min(1,n[e]/t),0)}})}function pe(A,e,t){var r="number"==typeof A?A:function(A,e,t){var r=e/2,n=t/2,B=ae(A[0],e)-r,s=n-ae(A[1],t);return(Math.atan2(s,B)+2*Math.PI)%(2*Math.PI)}(A,e,t),n=Math.abs(e*Math.sin(r))+Math.abs(t*Math.cos(r)),B=e/2,s=t/2,o=n/2,i=Math.sin(r-Math.PI/2)*o,a=Math.cos(r-Math.PI/2)*o;return[n,B-a,B+a,s-i,s+i]}function Ne(A,e){return Math.sqrt(A*A+e*e)}function Ke(A,e,B,s,o){return[[0,0],[0,e],[A,0],[A,e]].reduce(function(A,e){var t=e[0],r=e[1],n=Ne(B-t,s-r);return(o?n<A.optimumDistance:n>A.optimumDistance)?{optimumCorner:e,optimumDistance:n}:A},{optimumDistance:o?1/0:-1/0,optimumCorner:null}).optimumCorner}function Ie(A){var n=Qe(180),B=[];return WA(A).forEach(function(A,e){if(0===e){var t=A[0];if(t.type===sA.IDENT_TOKEN&&-1!==["top","left","right","bottom"].indexOf(t.value))return void(n=Ae(A));if($A(t))return void(n=(ce(t)+Qe(270))%Qe(360))}var r=de(A);B.push(r)}),{angle:n,stops:B,type:xe.LINEAR_GRADIENT}}function Te(A){return 0===A[0]&&255===A[1]&&0===A[2]&&255===A[3]}var me={name:"background-clip",initialValue:"border-box",prefix:!(Fe[Fe.CONTENT_BOX=2]="CONTENT_BOX"),type:Ce.LIST,parse:function(A){return A.map(function(A){if(zA(A))switch(A.value){case"padding-box":return Ee.PADDING_BOX;case"content-box":return Ee.CONTENT_BOX}return Ee.BORDER_BOX})}},Re={name:"background-color",initialValue:"transparent",prefix:!1,type:Ce.TYPE_VALUE,format:"color"},Le=function(A,e,t,r,n){var B="http://www.w3.org/2000/svg",s=document.createElementNS(B,"svg"),o=document.createElementNS(B,"foreignObject");return s.setAttributeNS(null,"width",A.toString()),s.setAttributeNS(null,"height",e.toString()),o.setAttributeNS(null,"width","100%"),o.setAttributeNS(null,"height","100%"),o.setAttributeNS(null,"x",t.toString()),o.setAttributeNS(null,"y",r.toString()),o.setAttributeNS(null,"externalResourcesRequired","true"),s.appendChild(o),o.appendChild(n),s},ve=function(r){return new Promise(function(A,e){var t=new Image;t.onload=function(){return A(t)},t.onerror=e,t.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent((new XMLSerializer).serializeToString(r))})},Oe={get SUPPORT_RANGE_BOUNDS(){var A=function(A){if(A.createRange){var e=A.createRange();if(e.getBoundingClientRect){var t=A.createElement("boundtest");t.style.height="123px",t.style.display="block",A.body.appendChild(t),e.selectNode(t);var r=e.getBoundingClientRect(),n=Math.round(r.height);if(A.body.removeChild(t),123===n)return!0}}return!1}(document);return Object.defineProperty(Oe,"SUPPORT_RANGE_BOUNDS",{value:A}),A},get SUPPORT_SVG_DRAWING(){var A=function(A){var e=new Image,t=A.createElement("canvas"),r=t.getContext("2d");if(!r)return!1;e.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{r.drawImage(e,0,0),t.toDataURL()}catch(A){return!1}return!0}(document);return Object.defineProperty(Oe,"SUPPORT_SVG_DRAWING",{value:A}),A},get SUPPORT_FOREIGNOBJECT_DRAWING(){var A="function"==typeof Array.from&&"function"==typeof window.fetch?function(r){var A=r.createElement("canvas"),n=100;A.width=n,A.height=n;var B=A.getContext("2d");if(!B)return Promise.reject(!1);B.fillStyle="rgb(0, 255, 0)",B.fillRect(0,0,n,n);var e=new Image,s=A.toDataURL();e.src=s;var t=Le(n,n,0,0,e);return B.fillStyle="red",B.fillRect(0,0,n,n),ve(t).then(function(A){B.drawImage(A,0,0);var e=B.getImageData(0,0,n,n).data;B.fillStyle="red",B.fillRect(0,0,n,n);var t=r.createElement("div");return t.style.backgroundImage="url("+s+")",t.style.height="100px",Te(e)?ve(Le(n,n,0,0,t)):Promise.reject(!1)}).then(function(A){return B.drawImage(A,0,0),Te(B.getImageData(0,0,n,n).data)}).catch(function(){return!1})}(document):Promise.resolve(!1);return Object.defineProperty(Oe,"SUPPORT_FOREIGNOBJECT_DRAWING",{value:A}),A},get SUPPORT_CORS_IMAGES(){var A=void 0!==(new Image).crossOrigin;return Object.defineProperty(Oe,"SUPPORT_CORS_IMAGES",{value:A}),A},get SUPPORT_RESPONSE_TYPE(){var A="string"==typeof(new XMLHttpRequest).responseType;return Object.defineProperty(Oe,"SUPPORT_RESPONSE_TYPE",{value:A}),A},get SUPPORT_CORS_XHR(){var A="withCredentials"in new XMLHttpRequest;return Object.defineProperty(Oe,"SUPPORT_CORS_XHR",{value:A}),A}},De=(be.prototype.debug=function(){for(var A=[],e=0;e<arguments.length;e++)A[e]=arguments[e];this.enabled&&("undefined"!=typeof window&&window.console&&"function"==typeof console.debug?console.debug.apply(console,[this.id,this.getTime()+"ms"].concat(A)):this.info.apply(this,A))},be.prototype.getTime=function(){return Date.now()-this.start},be.create=function(A){be.instances[A.id]=new be(A)},be.destroy=function(A){delete be.instances[A]},be.getInstance=function(A){var e=be.instances[A];if(void 0===e)throw new Error("No logger instance found with id "+A);return e},be.prototype.info=function(){for(var A=[],e=0;e<arguments.length;e++)A[e]=arguments[e];this.enabled&&"undefined"!=typeof window&&window.console&&"function"==typeof console.info&&console.info.apply(console,[this.id,this.getTime()+"ms"].concat(A))},be.prototype.error=function(){for(var A=[],e=0;e<arguments.length;e++)A[e]=arguments[e];this.enabled&&("undefined"!=typeof window&&window.console&&"function"==typeof console.error?console.error.apply(console,[this.id,this.getTime()+"ms"].concat(A)):this.info.apply(this,A))},be.instances={},be);function be(A){var e=A.id,t=A.enabled;this.id=e,this.enabled=t,this.start=Date.now()}var Se=(Me.create=function(A,e){return Me._caches[A]=new ye(A,e)},Me.destroy=function(A){delete Me._caches[A]},Me.open=function(A){var e=Me._caches[A];if(void 0!==e)return e;throw new Error('Cache with key "'+A+'" not found')},Me.getOrigin=function(A){var e=Me._link;return e?(e.href=A,e.href=e.href,e.protocol+e.hostname+e.port):"about:blank"},Me.isSameOrigin=function(A){return Me.getOrigin(A)===Me._origin},Me.setContext=function(A){Me._link=A.document.createElement("a"),Me._origin=Me.getOrigin(A.location.href)},Me.getInstance=function(){var A=Me._current;if(null===A)throw new Error("No cache instance attached");return A},Me.attachInstance=function(A){Me._current=A},Me.detachInstance=function(){Me._current=null},Me._caches={},Me._origin="about:blank",Me._current=null,Me);function Me(){}var ye=(_e.prototype.addImage=function(A){var e=Promise.resolve();return this.has(A)||(Ye(A)||Ge(A))&&(this._cache[A]=this.loadImage(A)),e},_e.prototype.match=function(A){return this._cache[A]},_e.prototype.loadImage=function(s){return a(this,void 0,void 0,function(){var e,r,t,n,B=this;return S(this,function(A){switch(A.label){case 0:return e=Se.isSameOrigin(s),r=!ke(s)&&!0===this._options.useCORS&&Oe.SUPPORT_CORS_IMAGES&&!e,t=!ke(s)&&!e&&"string"==typeof this._options.proxy&&Oe.SUPPORT_CORS_XHR&&!r,e||!1!==this._options.allowTaint||ke(s)||t||r?(n=s,t?[4,this.proxy(n)]:[3,2]):[2];case 1:n=A.sent(),A.label=2;case 2:return De.getInstance(this.id).debug("Added image "+s.substring(0,256)),[4,new Promise(function(A,e){var t=new Image;t.onload=function(){return A(t)},t.onerror=e,(We(n)||r)&&(t.crossOrigin="anonymous"),t.src=n,!0===t.complete&&setTimeout(function(){return A(t)},500),0<B._options.imageTimeout&&setTimeout(function(){return e("Timed out ("+B._options.imageTimeout+"ms) loading image")},B._options.imageTimeout)})];case 3:return[2,A.sent()]}})})},_e.prototype.has=function(A){return void 0!==this._cache[A]},_e.prototype.keys=function(){return Promise.resolve(Object.keys(this._cache))},_e.prototype.proxy=function(B){var s=this,o=this._options.proxy;if(!o)throw new Error("No proxy defined");var i=B.substring(0,256);return new Promise(function(e,t){var r=Oe.SUPPORT_RESPONSE_TYPE?"blob":"text",n=new XMLHttpRequest;if(n.onload=function(){if(200===n.status)if("text"==r)e(n.response);else{var A=new FileReader;A.addEventListener("load",function(){return e(A.result)},!1),A.addEventListener("error",function(A){return t(A)},!1),A.readAsDataURL(n.response)}else t("Failed to proxy resource "+i+" with status code "+n.status)},n.onerror=t,n.open("GET",o+"?url="+encodeURIComponent(B)+"&responseType="+r),"text"!=r&&n instanceof XMLHttpRequest&&(n.responseType=r),s._options.imageTimeout){var A=s._options.imageTimeout;n.timeout=A,n.ontimeout=function(){return t("Timed out ("+A+"ms) proxying "+i)}}n.send()})},_e);function _e(A,e){this.id=A,this._options=e,this._cache={}}function Pe(A){var n=rt.CIRCLE,B=Bt.FARTHEST_CORNER,s=[],o=[];return WA(A).forEach(function(A,e){var t=!0;if(0===e?t=A.reduce(function(A,e){if(zA(e))switch(e.value){case"center":return o.push(oe),!1;case"top":case"left":return o.push(se),!1;case"right":case"bottom":return o.push(ie),!1}else if(qA(e)||YA(e))return o.push(e),!1;return A},t):1===e&&(t=A.reduce(function(A,e){if(zA(e))switch(e.value){case"circle":return n=rt.CIRCLE,!1;case et:return n=rt.ELLIPSE,!1;case tt:case Ze:return B=Bt.CLOSEST_SIDE,!1;case je:return B=Bt.FARTHEST_SIDE,!1;case $e:return B=Bt.CLOSEST_CORNER,!1;case"cover":case At:return B=Bt.FARTHEST_CORNER,!1}else if(YA(e)||qA(e))return Array.isArray(B)||(B=[]),B.push(e),!1;return A},t)),t){var r=de(A);s.push(r)}}),{size:B,shape:n,stops:s,position:o,type:xe.RADIAL_GRADIENT}}var xe,Ve,ze=/^data:image\/svg\+xml/i,Xe=/^data:image\/.*;base64,/i,Je=/^data:image\/.*/i,Ge=function(A){return Oe.SUPPORT_SVG_DRAWING||!qe(A)},ke=function(A){return Je.test(A)},We=function(A){return Xe.test(A)},Ye=function(A){return"blob"===A.substr(0,4)},qe=function(A){return"svg"===A.substr(-3).toLowerCase()||ze.test(A)},Ze="closest-side",je="farthest-side",$e="closest-corner",At="farthest-corner",et="ellipse",tt="contain";(Ve=xe||(xe={}))[Ve.URL=0]="URL",Ve[Ve.LINEAR_GRADIENT=1]="LINEAR_GRADIENT",Ve[Ve.RADIAL_GRADIENT=2]="RADIAL_GRADIENT";var rt,nt,Bt,st;(nt=rt||(rt={}))[nt.CIRCLE=0]="CIRCLE",nt[nt.ELLIPSE=1]="ELLIPSE",(st=Bt||(Bt={}))[st.CLOSEST_SIDE=0]="CLOSEST_SIDE",st[st.FARTHEST_SIDE=1]="FARTHEST_SIDE",st[st.CLOSEST_CORNER=2]="CLOSEST_CORNER",st[st.FARTHEST_CORNER=3]="FARTHEST_CORNER";var ot=function(A){if(A.type===sA.URL_TOKEN){var e={url:A.value,type:xe.URL};return Se.getInstance().addImage(A.value),e}if(A.type!==sA.FUNCTION)throw new Error("Unsupported image type");var t=ct[A.name];if(void 0===t)throw new Error('Attempting to parse an unsupported image function "'+A.name+'"');return t(A.values)};var it,at,ct={"linear-gradient":function(A){var n=Qe(180),B=[];return WA(A).forEach(function(A,e){if(0===e){var t=A[0];if(t.type===sA.IDENT_TOKEN&&"to"===t.value)return void(n=Ae(A));if($A(t))return void(n=ce(t))}var r=de(A);B.push(r)}),{angle:n,stops:B,type:xe.LINEAR_GRADIENT}},"-moz-linear-gradient":Ie,"-ms-linear-gradient":Ie,"-o-linear-gradient":Ie,"-webkit-linear-gradient":Ie,"radial-gradient":function(A){var B=rt.CIRCLE,s=Bt.FARTHEST_CORNER,o=[],i=[];return WA(A).forEach(function(A,e){var t=!0;if(0===e){var r=!1;t=A.reduce(function(A,e){if(r)if(zA(e))switch(e.value){case"center":return i.push(oe),A;case"top":case"left":return i.push(se),A;case"right":case"bottom":return i.push(ie),A}else(qA(e)||YA(e))&&i.push(e);else if(zA(e))switch(e.value){case"circle":return B=rt.CIRCLE,!1;case et:return B=rt.ELLIPSE,!1;case"at":return!(r=!0);case Ze:return s=Bt.CLOSEST_SIDE,!1;case"cover":case je:return s=Bt.FARTHEST_SIDE,!1;case tt:case $e:return s=Bt.CLOSEST_CORNER,!1;case At:return s=Bt.FARTHEST_CORNER,!1}else if(YA(e)||qA(e))return Array.isArray(s)||(s=[]),s.push(e),!1;return A},t)}if(t){var n=de(A);o.push(n)}}),{size:s,shape:B,stops:o,position:i,type:xe.RADIAL_GRADIENT}},"-moz-radial-gradient":Pe,"-ms-radial-gradient":Pe,"-o-radial-gradient":Pe,"-webkit-radial-gradient":Pe,"-webkit-gradient":function(A){var e=Qe(180),s=[],o=xe.LINEAR_GRADIENT,t=rt.CIRCLE,r=Bt.FARTHEST_CORNER;return WA(A).forEach(function(A,e){var t=A[0];if(0===e){if(zA(t)&&"linear"===t.value)return void(o=xe.LINEAR_GRADIENT);if(zA(t)&&"radial"===t.value)return void(o=xe.RADIAL_GRADIENT)}if(t.type===sA.FUNCTION)if("from"===t.name){var r=we(t.values[0]);s.push({stop:se,color:r})}else if("to"===t.name)r=we(t.values[0]),s.push({stop:ie,color:r});else if("color-stop"===t.name){var n=t.values.filter(kA);if(2===n.length){r=we(n[1]);var B=n[0];VA(B)&&s.push({stop:{type:sA.PERCENTAGE_TOKEN,number:100*B.number,flags:B.flags},color:r})}}}),o===xe.LINEAR_GRADIENT?{angle:(e+Qe(180))%Qe(360),stops:s,type:o}:{size:r,shape:t,stops:s,position:[],type:o}}},Qt={name:"background-image",initialValue:"none",type:Ce.LIST,prefix:!1,parse:function(A){if(0===A.length)return[];var e=A[0];return e.type===sA.IDENT_TOKEN&&"none"===e.value?[]:A.filter(function(A){return kA(A)&&function(A){return A.type!==sA.FUNCTION||ct[A.name]}(A)}).map(ot)}},wt={name:"background-origin",initialValue:"border-box",prefix:!1,type:Ce.LIST,parse:function(A){return A.map(function(A){if(zA(A))switch(A.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},ut={name:"background-position",initialValue:"0% 0%",type:Ce.LIST,prefix:!1,parse:function(A){return WA(A).map(function(A){return A.filter(qA)}).map(ZA)}};(at=it||(it={}))[at.REPEAT=0]="REPEAT",at[at.NO_REPEAT=1]="NO_REPEAT",at[at.REPEAT_X=2]="REPEAT_X";var Ut,lt,Ct={name:"background-repeat",initialValue:"repeat",prefix:!(at[at.REPEAT_Y=3]="REPEAT_Y"),type:Ce.LIST,parse:function(A){return WA(A).map(function(A){return A.filter(zA).map(function(A){return A.value}).join(" ")}).map(gt)}},gt=function(A){switch(A){case"no-repeat":return it.NO_REPEAT;case"repeat-x":case"repeat no-repeat":return it.REPEAT_X;case"repeat-y":case"no-repeat repeat":return it.REPEAT_Y;case"repeat":default:return it.REPEAT}};(lt=Ut||(Ut={})).AUTO="auto",lt.CONTAIN="contain";function Et(A){return{name:"border-"+A+"-color",initialValue:"transparent",prefix:!1,type:Ce.TYPE_VALUE,format:"color"}}function Ft(A){return{name:"border-radius-"+A,initialValue:"0 0",prefix:!1,type:Ce.LIST,parse:function(A){return ZA(A.filter(qA))}}}var ht,Ht,dt={name:"background-size",initialValue:"0",prefix:!(lt.COVER="cover"),type:Ce.LIST,parse:function(A){return WA(A).map(function(A){return A.filter(ft)})}},ft=function(A){return zA(A)||qA(A)},pt=Et("top"),Nt=Et("right"),Kt=Et("bottom"),It=Et("left"),Tt=Ft("top-left"),mt=Ft("top-right"),Rt=Ft("bottom-right"),Lt=Ft("bottom-left");(Ht=ht||(ht={}))[Ht.NONE=0]="NONE",Ht[Ht.SOLID=1]="SOLID";function vt(A){return{name:"border-"+A+"-style",initialValue:"solid",prefix:!1,type:Ce.IDENT_VALUE,parse:function(A){switch(A){case"none":return ht.NONE}return ht.SOLID}}}function Ot(A){return{name:"border-"+A+"-width",initialValue:"0",type:Ce.VALUE,prefix:!1,parse:function(A){return xA(A)?A.number:0}}}var Dt,bt,St=vt("top"),Mt=vt("right"),yt=vt("bottom"),_t=vt("left"),Pt=Ot("top"),xt=Ot("right"),Vt=Ot("bottom"),zt=Ot("left"),Xt={name:"color",initialValue:"transparent",prefix:!1,type:Ce.TYPE_VALUE,format:"color"},Jt={name:"display",initialValue:"inline-block",prefix:!1,type:Ce.LIST,parse:function(A){return A.filter(zA).reduce(function(A,e){return A|Gt(e.value)},0)}},Gt=function(A){switch(A){case"block":return 2;case"inline":return 4;case"run-in":return 8;case"flow":return 16;case"flow-root":return 32;case"table":return 64;case"flex":case"-webkit-flex":return 128;case"grid":case"-ms-grid":return 256;case"ruby":return 512;case"subgrid":return 1024;case"list-item":return 2048;case"table-row-group":return 4096;case"table-header-group":return 8192;case"table-footer-group":return 16384;case"table-row":return 32768;case"table-cell":return 65536;case"table-column-group":return 131072;case"table-column":return 262144;case"table-caption":return 524288;case"ruby-base":return 1048576;case"ruby-text":return 2097152;case"ruby-base-container":return 4194304;case"ruby-text-container":return 8388608;case"contents":return 16777216;case"inline-block":return 33554432;case"inline-list-item":return 67108864;case"inline-table":return 134217728;case"inline-flex":return 268435456;case"inline-grid":return 536870912}return 0};(bt=Dt||(Dt={}))[bt.NONE=0]="NONE",bt[bt.LEFT=1]="LEFT",bt[bt.RIGHT=2]="RIGHT",bt[bt.INLINE_START=3]="INLINE_START";var kt,Wt,Yt,qt,Zt={name:"float",initialValue:"none",prefix:!(bt[bt.INLINE_END=4]="INLINE_END"),type:Ce.IDENT_VALUE,parse:function(A){switch(A){case"left":return Dt.LEFT;case"right":return Dt.RIGHT;case"inline-start":return Dt.INLINE_START;case"inline-end":return Dt.INLINE_END}return Dt.NONE}},jt={name:"letter-spacing",initialValue:"0",prefix:!1,type:Ce.VALUE,parse:function(A){return A.type===sA.IDENT_TOKEN&&"normal"===A.value?0:A.type===sA.NUMBER_TOKEN?A.number:A.type===sA.DIMENSION_TOKEN?A.number:0}},$t={name:"line-break",initialValue:(Wt=kt||(kt={})).NORMAL="normal",prefix:!(Wt.STRICT="strict"),type:Ce.IDENT_VALUE,parse:function(A){switch(A){case"strict":return kt.STRICT;case"normal":default:return kt.NORMAL}}},Ar={name:"line-height",initialValue:"normal",prefix:!1,type:Ce.TOKEN_VALUE},er={name:"list-style-image",initialValue:"none",type:Ce.VALUE,prefix:!1,parse:function(A){return A.type===sA.IDENT_TOKEN&&"none"===A.value?null:ot(A)}};(qt=Yt||(Yt={}))[qt.INSIDE=0]="INSIDE";var tr,rr,nr={name:"list-style-position",initialValue:"outside",prefix:!(qt[qt.OUTSIDE=1]="OUTSIDE"),type:Ce.IDENT_VALUE,parse:function(A){switch(A){case"inside":return Yt.INSIDE;case"outside":default:return Yt.OUTSIDE}}};(rr=tr||(tr={}))[rr.NONE=-1]="NONE",rr[rr.DISC=0]="DISC",rr[rr.CIRCLE=1]="CIRCLE",rr[rr.SQUARE=2]="SQUARE",rr[rr.DECIMAL=3]="DECIMAL",rr[rr.CJK_DECIMAL=4]="CJK_DECIMAL",rr[rr.DECIMAL_LEADING_ZERO=5]="DECIMAL_LEADING_ZERO",rr[rr.LOWER_ROMAN=6]="LOWER_ROMAN",rr[rr.UPPER_ROMAN=7]="UPPER_ROMAN",rr[rr.LOWER_GREEK=8]="LOWER_GREEK",rr[rr.LOWER_ALPHA=9]="LOWER_ALPHA",rr[rr.UPPER_ALPHA=10]="UPPER_ALPHA",rr[rr.ARABIC_INDIC=11]="ARABIC_INDIC",rr[rr.ARMENIAN=12]="ARMENIAN",rr[rr.BENGALI=13]="BENGALI",rr[rr.CAMBODIAN=14]="CAMBODIAN",rr[rr.CJK_EARTHLY_BRANCH=15]="CJK_EARTHLY_BRANCH",rr[rr.CJK_HEAVENLY_STEM=16]="CJK_HEAVENLY_STEM",rr[rr.CJK_IDEOGRAPHIC=17]="CJK_IDEOGRAPHIC",rr[rr.DEVANAGARI=18]="DEVANAGARI",rr[rr.ETHIOPIC_NUMERIC=19]="ETHIOPIC_NUMERIC",rr[rr.GEORGIAN=20]="GEORGIAN",rr[rr.GUJARATI=21]="GUJARATI",rr[rr.GURMUKHI=22]="GURMUKHI",rr[rr.HEBREW=22]="HEBREW",rr[rr.HIRAGANA=23]="HIRAGANA",rr[rr.HIRAGANA_IROHA=24]="HIRAGANA_IROHA",rr[rr.JAPANESE_FORMAL=25]="JAPANESE_FORMAL",rr[rr.JAPANESE_INFORMAL=26]="JAPANESE_INFORMAL",rr[rr.KANNADA=27]="KANNADA",rr[rr.KATAKANA=28]="KATAKANA",rr[rr.KATAKANA_IROHA=29]="KATAKANA_IROHA",rr[rr.KHMER=30]="KHMER",rr[rr.KOREAN_HANGUL_FORMAL=31]="KOREAN_HANGUL_FORMAL",rr[rr.KOREAN_HANJA_FORMAL=32]="KOREAN_HANJA_FORMAL",rr[rr.KOREAN_HANJA_INFORMAL=33]="KOREAN_HANJA_INFORMAL",rr[rr.LAO=34]="LAO",rr[rr.LOWER_ARMENIAN=35]="LOWER_ARMENIAN",rr[rr.MALAYALAM=36]="MALAYALAM",rr[rr.MONGOLIAN=37]="MONGOLIAN",rr[rr.MYANMAR=38]="MYANMAR",rr[rr.ORIYA=39]="ORIYA",rr[rr.PERSIAN=40]="PERSIAN",rr[rr.SIMP_CHINESE_FORMAL=41]="SIMP_CHINESE_FORMAL",rr[rr.SIMP_CHINESE_INFORMAL=42]="SIMP_CHINESE_INFORMAL",rr[rr.TAMIL=43]="TAMIL",rr[rr.TELUGU=44]="TELUGU",rr[rr.THAI=45]="THAI",rr[rr.TIBETAN=46]="TIBETAN",rr[rr.TRAD_CHINESE_FORMAL=47]="TRAD_CHINESE_FORMAL",rr[rr.TRAD_CHINESE_INFORMAL=48]="TRAD_CHINESE_INFORMAL",rr[rr.UPPER_ARMENIAN=49]="UPPER_ARMENIAN",rr[rr.DISCLOSURE_OPEN=50]="DISCLOSURE_OPEN";function Br(A){return{name:"margin-"+A,initialValue:"0",prefix:!1,type:Ce.TOKEN_VALUE}}var sr,or,ir={name:"list-style-type",initialValue:"none",prefix:!(rr[rr.DISCLOSURE_CLOSED=51]="DISCLOSURE_CLOSED"),type:Ce.IDENT_VALUE,parse:function(A){switch(A){case"disc":return tr.DISC;case"circle":return tr.CIRCLE;case"square":return tr.SQUARE;case"decimal":return tr.DECIMAL;case"cjk-decimal":return tr.CJK_DECIMAL;case"decimal-leading-zero":return tr.DECIMAL_LEADING_ZERO;case"lower-roman":return tr.LOWER_ROMAN;case"upper-roman":return tr.UPPER_ROMAN;case"lower-greek":return tr.LOWER_GREEK;case"lower-alpha":return tr.LOWER_ALPHA;case"upper-alpha":return tr.UPPER_ALPHA;case"arabic-indic":return tr.ARABIC_INDIC;case"armenian":return tr.ARMENIAN;case"bengali":return tr.BENGALI;case"cambodian":return tr.CAMBODIAN;case"cjk-earthly-branch":return tr.CJK_EARTHLY_BRANCH;case"cjk-heavenly-stem":return tr.CJK_HEAVENLY_STEM;case"cjk-ideographic":return tr.CJK_IDEOGRAPHIC;case"devanagari":return tr.DEVANAGARI;case"ethiopic-numeric":return tr.ETHIOPIC_NUMERIC;case"georgian":return tr.GEORGIAN;case"gujarati":return tr.GUJARATI;case"gurmukhi":return tr.GURMUKHI;case"hebrew":return tr.HEBREW;case"hiragana":return tr.HIRAGANA;case"hiragana-iroha":return tr.HIRAGANA_IROHA;case"japanese-formal":return tr.JAPANESE_FORMAL;case"japanese-informal":return tr.JAPANESE_INFORMAL;case"kannada":return tr.KANNADA;case"katakana":return tr.KATAKANA;case"katakana-iroha":return tr.KATAKANA_IROHA;case"khmer":return tr.KHMER;case"korean-hangul-formal":return tr.KOREAN_HANGUL_FORMAL;case"korean-hanja-formal":return tr.KOREAN_HANJA_FORMAL;case"korean-hanja-informal":return tr.KOREAN_HANJA_INFORMAL;case"lao":return tr.LAO;case"lower-armenian":return tr.LOWER_ARMENIAN;case"malayalam":return tr.MALAYALAM;case"mongolian":return tr.MONGOLIAN;case"myanmar":return tr.MYANMAR;case"oriya":return tr.ORIYA;case"persian":return tr.PERSIAN;case"simp-chinese-formal":return tr.SIMP_CHINESE_FORMAL;case"simp-chinese-informal":return tr.SIMP_CHINESE_INFORMAL;case"tamil":return tr.TAMIL;case"telugu":return tr.TELUGU;case"thai":return tr.THAI;case"tibetan":return tr.TIBETAN;case"trad-chinese-formal":return tr.TRAD_CHINESE_FORMAL;case"trad-chinese-informal":return tr.TRAD_CHINESE_INFORMAL;case"upper-armenian":return tr.UPPER_ARMENIAN;case"disclosure-open":return tr.DISCLOSURE_OPEN;case"disclosure-closed":return tr.DISCLOSURE_CLOSED;case"none":default:return tr.NONE}}},ar=Br("top"),cr=Br("right"),Qr=Br("bottom"),wr=Br("left");(or=sr||(sr={}))[or.VISIBLE=0]="VISIBLE",or[or.HIDDEN=1]="HIDDEN",or[or.SCROLL=2]="SCROLL";function ur(A){return{name:"padding-"+A,initialValue:"0",prefix:!1,type:Ce.TYPE_VALUE,format:"length-percentage"}}var Ur,lr,Cr,gr,Er={name:"overflow",initialValue:"visible",prefix:!(or[or.AUTO=3]="AUTO"),type:Ce.LIST,parse:function(A){return A.filter(zA).map(function(A){switch(A.value){case"hidden":return sr.HIDDEN;case"scroll":return sr.SCROLL;case"auto":return sr.AUTO;case"visible":default:return sr.VISIBLE}})}},Fr={name:"overflow-wrap",initialValue:(lr=Ur||(Ur={})).NORMAL="normal",prefix:!(lr.BREAK_WORD="break-word"),type:Ce.IDENT_VALUE,parse:function(A){switch(A){case"break-word":return Ur.BREAK_WORD;case"normal":default:return Ur.NORMAL}}},hr=ur("top"),Hr=ur("right"),dr=ur("bottom"),fr=ur("left");(gr=Cr||(Cr={}))[gr.LEFT=0]="LEFT",gr[gr.CENTER=1]="CENTER";var pr,Nr,Kr={name:"text-align",initialValue:"left",prefix:!(gr[gr.RIGHT=2]="RIGHT"),type:Ce.IDENT_VALUE,parse:function(A){switch(A){case"right":return Cr.RIGHT;case"center":case"justify":return Cr.CENTER;case"left":default:return Cr.LEFT}}};(Nr=pr||(pr={}))[Nr.STATIC=0]="STATIC",Nr[Nr.RELATIVE=1]="RELATIVE",Nr[Nr.ABSOLUTE=2]="ABSOLUTE",Nr[Nr.FIXED=3]="FIXED";var Ir,Tr,mr={name:"position",initialValue:"static",prefix:!(Nr[Nr.STICKY=4]="STICKY"),type:Ce.IDENT_VALUE,parse:function(A){switch(A){case"relative":return pr.RELATIVE;case"absolute":return pr.ABSOLUTE;case"fixed":return pr.FIXED;case"sticky":return pr.STICKY}return pr.STATIC}},Rr={name:"text-shadow",initialValue:"none",type:Ce.LIST,prefix:!1,parse:function(A){return 1===A.length&&JA(A[0],"none")?[]:WA(A).map(function(A){for(var e={color:He.TRANSPARENT,offsetX:se,offsetY:se,blur:se},t=0,r=0;r<A.length;r++){var n=A[r];YA(n)?(0===t?e.offsetX=n:1===t?e.offsetY=n:e.blur=n,t++):e.color=we(n)}return e})}};(Tr=Ir||(Ir={}))[Tr.NONE=0]="NONE",Tr[Tr.LOWERCASE=1]="LOWERCASE",Tr[Tr.UPPERCASE=2]="UPPERCASE";var Lr,vr,Or={name:"text-transform",initialValue:"none",prefix:!(Tr[Tr.CAPITALIZE=3]="CAPITALIZE"),type:Ce.IDENT_VALUE,parse:function(A){switch(A){case"uppercase":return Ir.UPPERCASE;case"lowercase":return Ir.LOWERCASE;case"capitalize":return Ir.CAPITALIZE}return Ir.NONE}},Dr={name:"transform",initialValue:"none",prefix:!0,type:Ce.VALUE,parse:function(A){if(A.type===sA.IDENT_TOKEN&&"none"===A.value)return null;if(A.type!==sA.FUNCTION)return null;var e=br[A.name];if(void 0===e)throw new Error('Attempting to parse an unsupported transform function "'+A.name+'"');return e(A.values)}},br={matrix:function(A){var e=A.filter(function(A){return A.type===sA.NUMBER_TOKEN}).map(function(A){return A.number});return 6===e.length?e:null},matrix3d:function(A){var e=A.filter(function(A){return A.type===sA.NUMBER_TOKEN}).map(function(A){return A.number}),t=e[0],r=e[1],n=(e[2],e[3],e[4]),B=e[5],s=(e[6],e[7],e[8],e[9],e[10],e[11],e[12]),o=e[13];e[14],e[15];return 16===e.length?[t,r,n,B,s,o]:null}},Sr={type:sA.PERCENTAGE_TOKEN,number:50,flags:4},Mr=[Sr,Sr],yr={name:"transform-origin",initialValue:"50% 50%",prefix:!0,type:Ce.LIST,parse:function(A){var e=A.filter(qA);return 2!==e.length?Mr:[e[0],e[1]]}};(vr=Lr||(Lr={}))[vr.VISIBLE=0]="VISIBLE",vr[vr.HIDDEN=1]="HIDDEN";var _r,Pr,xr={name:"visible",initialValue:"none",prefix:!(vr[vr.COLLAPSE=2]="COLLAPSE"),type:Ce.IDENT_VALUE,parse:function(A){switch(A){case"hidden":return Lr.HIDDEN;case"collapse":return Lr.COLLAPSE;case"visible":default:return Lr.VISIBLE}}};(Pr=_r||(_r={})).NORMAL="normal",Pr.BREAK_ALL="break-all";var Vr,zr,Xr={name:"word-break",initialValue:"normal",prefix:!(Pr.KEEP_ALL="keep-all"),type:Ce.IDENT_VALUE,parse:function(A){switch(A){case"break-all":return _r.BREAK_ALL;case"keep-all":return _r.KEEP_ALL;case"normal":default:return _r.NORMAL}}},Jr={name:"z-index",initialValue:"auto",prefix:!1,type:Ce.VALUE,parse:function(A){if(A.type===sA.IDENT_TOKEN)return{auto:!0,order:0};if(VA(A))return{auto:!1,order:A.number};throw new Error("Invalid z-index number parsed")}},Gr={name:"opacity",initialValue:"1",type:Ce.VALUE,prefix:!1,parse:function(A){return VA(A)?A.number:1}},kr={name:"text-decoration-color",initialValue:"transparent",prefix:!1,type:Ce.TYPE_VALUE,format:"color"},Wr={name:"text-decoration-line",initialValue:"none",prefix:!1,type:Ce.LIST,parse:function(A){return A.filter(zA).map(function(A){switch(A.value){case"underline":return 1;case"overline":return 2;case"line-through":return 3;case"none":return 4}return 0}).filter(function(A){return 0!==A})}},Yr={name:"font-family",initialValue:"",prefix:!1,type:Ce.LIST,parse:function(A){return A.filter(qr).map(function(A){return A.value})}},qr=function(A){return A.type===sA.STRING_TOKEN||A.type===sA.IDENT_TOKEN},Zr={name:"font-size",initialValue:"0",prefix:!1,type:Ce.TYPE_VALUE,format:"length"},jr={name:"font-weight",initialValue:"normal",type:Ce.VALUE,prefix:!1,parse:function(A){if(VA(A))return A.number;if(zA(A))switch(A.value){case"bold":return 700;case"normal":default:return 400}return 400}},$r={name:"font-variant",initialValue:"none",type:Ce.LIST,prefix:!1,parse:function(A){return A.filter(zA).map(function(A){return A.value})}};(zr=Vr||(Vr={})).NORMAL="normal",zr.ITALIC="italic";function An(A,e){return 0!=(A&e)}function en(A,e,t){if(!A)return"";var r=A[Math.min(e,A.length-1)];return r?t?r.open:r.close:""}var tn={name:"font-style",initialValue:"normal",prefix:!(zr.OBLIQUE="oblique"),type:Ce.IDENT_VALUE,parse:function(A){switch(A){case"oblique":return Vr.OBLIQUE;case"italic":return Vr.ITALIC;case"normal":default:return Vr.NORMAL}}},rn={name:"content",initialValue:"none",type:Ce.LIST,prefix:!1,parse:function(A){if(0===A.length)return[];var e=A[0];return e.type===sA.IDENT_TOKEN&&"none"===e.value?[]:A}},nn={name:"counter-increment",initialValue:"none",prefix:!0,type:Ce.LIST,parse:function(A){if(0===A.length)return null;var e=A[0];if(e.type===sA.IDENT_TOKEN&&"none"===e.value)return null;for(var t=[],r=A.filter(GA),n=0;n<r.length;n++){var B=r[n],s=r[n+1];if(B.type===sA.IDENT_TOKEN){var o=s&&VA(s)?s.number:1;t.push({counter:B.value,increment:o})}}return t}},Bn={name:"counter-reset",initialValue:"none",prefix:!0,type:Ce.LIST,parse:function(A){if(0===A.length)return[];for(var e=[],t=A.filter(GA),r=0;r<t.length;r++){var n=t[r],B=t[r+1];if(zA(n)&&"none"!==n.value){var s=B&&VA(B)?B.number:0;e.push({counter:n.value,reset:s})}}return e}},sn={name:"quotes",initialValue:"none",prefix:!0,type:Ce.LIST,parse:function(A){if(0===A.length)return null;var e=A[0];if(e.type===sA.IDENT_TOKEN&&"none"===e.value)return null;var t=[],r=A.filter(XA);if(r.length%2!=0)return null;for(var n=0;n<r.length;n+=2){var B=r[n].value,s=r[n+1].value;t.push({open:B,close:s})}return t}},on={name:"box-shadow",initialValue:"none",type:Ce.LIST,prefix:!1,parse:function(A){return 1===A.length&&JA(A[0],"none")?[]:WA(A).map(function(A){for(var e={color:255,offsetX:se,offsetY:se,blur:se,spread:se,inset:!1},t=0,r=0;r<A.length;r++){var n=A[r];JA(n,"inset")?e.inset=!0:YA(n)?(0===t?e.offsetX=n:1===t?e.offsetY=n:2===t?e.blur=n:e.spread=n,t++):e.color=we(n)}return e})}},an=(cn.prototype.isVisible=function(){return 0<this.display&&0<this.opacity&&this.visibility===Lr.VISIBLE},cn.prototype.isTransparent=function(){return ee(this.backgroundColor)},cn.prototype.isTransformed=function(){return null!==this.transform},cn.prototype.isPositioned=function(){return this.position!==pr.STATIC},cn.prototype.isPositionedWithZIndex=function(){return this.isPositioned()&&!this.zIndex.auto},cn.prototype.isFloating=function(){return this.float!==Dt.NONE},cn.prototype.isInlineLevel=function(){return An(this.display,4)||An(this.display,33554432)||An(this.display,268435456)||An(this.display,536870912)||An(this.display,67108864)||An(this.display,134217728)},cn);function cn(A){this.backgroundClip=Un(me,A.backgroundClip),this.backgroundColor=Un(Re,A.backgroundColor),this.backgroundImage=Un(Qt,A.backgroundImage),this.backgroundOrigin=Un(wt,A.backgroundOrigin),this.backgroundPosition=Un(ut,A.backgroundPosition),this.backgroundRepeat=Un(Ct,A.backgroundRepeat),this.backgroundSize=Un(dt,A.backgroundSize),this.borderTopColor=Un(pt,A.borderTopColor),this.borderRightColor=Un(Nt,A.borderRightColor),this.borderBottomColor=Un(Kt,A.borderBottomColor),this.borderLeftColor=Un(It,A.borderLeftColor),this.borderTopLeftRadius=Un(Tt,A.borderTopLeftRadius),this.borderTopRightRadius=Un(mt,A.borderTopRightRadius),this.borderBottomRightRadius=Un(Rt,A.borderBottomRightRadius),this.borderBottomLeftRadius=Un(Lt,A.borderBottomLeftRadius),this.borderTopStyle=Un(St,A.borderTopStyle),this.borderRightStyle=Un(Mt,A.borderRightStyle),this.borderBottomStyle=Un(yt,A.borderBottomStyle),this.borderLeftStyle=Un(_t,A.borderLeftStyle),this.borderTopWidth=Un(Pt,A.borderTopWidth),this.borderRightWidth=Un(xt,A.borderRightWidth),this.borderBottomWidth=Un(Vt,A.borderBottomWidth),this.borderLeftWidth=Un(zt,A.borderLeftWidth),this.boxShadow=Un(on,A.boxShadow),this.color=Un(Xt,A.color),this.display=Un(Jt,A.display),this.float=Un(Zt,A.cssFloat),this.fontFamily=Un(Yr,A.fontFamily),this.fontSize=Un(Zr,A.fontSize),this.fontStyle=Un(tn,A.fontStyle),this.fontVariant=Un($r,A.fontVariant),this.fontWeight=Un(jr,A.fontWeight),this.letterSpacing=Un(jt,A.letterSpacing),this.lineBreak=Un($t,A.lineBreak),this.lineHeight=Un(Ar,A.lineHeight),this.listStyleImage=Un(er,A.listStyleImage),this.listStylePosition=Un(nr,A.listStylePosition),this.listStyleType=Un(ir,A.listStyleType),this.marginTop=Un(ar,A.marginTop),this.marginRight=Un(cr,A.marginRight),this.marginBottom=Un(Qr,A.marginBottom),this.marginLeft=Un(wr,A.marginLeft),this.opacity=Un(Gr,A.opacity);var e=Un(Er,A.overflow);this.overflowX=e[0],this.overflowY=e[1<e.length?1:0],this.overflowWrap=Un(Fr,A.overflowWrap),this.paddingTop=Un(hr,A.paddingTop),this.paddingRight=Un(Hr,A.paddingRight),this.paddingBottom=Un(dr,A.paddingBottom),this.paddingLeft=Un(fr,A.paddingLeft),this.position=Un(mr,A.position),this.textAlign=Un(Kr,A.textAlign),this.textDecorationColor=Un(kr,A.textDecorationColor||A.color),this.textDecorationLine=Un(Wr,A.textDecorationLine),this.textShadow=Un(Rr,A.textShadow),this.textTransform=Un(Or,A.textTransform),this.transform=Un(Dr,A.transform),this.transformOrigin=Un(yr,A.transformOrigin),this.visibility=Un(xr,A.visibility),this.wordBreak=Un(Xr,A.wordBreak),this.zIndex=Un(Jr,A.zIndex)}var Qn,wn=function(A){this.content=Un(rn,A.content),this.quotes=Un(sn,A.quotes)},un=function(A){this.counterIncrement=Un(nn,A.counterIncrement),this.counterReset=Un(Bn,A.counterReset)},Un=function(A,e){var t=new MA,r=null!=e?e.toString():A.initialValue;t.write(r);var n=new _A(t.read());switch(A.type){case Ce.IDENT_VALUE:var B=n.parseComponentValue();return A.parse(zA(B)?B.value:A.initialValue);case Ce.VALUE:return A.parse(n.parseComponentValue());case Ce.LIST:return A.parse(n.parseComponentValues());case Ce.TOKEN_VALUE:return n.parseComponentValue();case Ce.TYPE_VALUE:switch(A.format){case"angle":return ce(n.parseComponentValue());case"color":return we(n.parseComponentValue());case"image":return ot(n.parseComponentValue());case"length":var s=n.parseComponentValue();return YA(s)?s:se;case"length-percentage":var o=n.parseComponentValue();return qA(o)?o:se}}throw new Error("Attempting to parse unsupported css format type "+A.format)},ln=function(A){this.styles=new an(window.getComputedStyle(A,null)),this.textNodes=[],this.elements=[],null!==this.styles.transform&&uB(A)&&(A.style.transform="none"),this.bounds=T(A),this.flags=0},Cn=function(A,e){this.text=A,this.bounds=e},gn=function(A){var e=A.ownerDocument;if(e){var t=e.createElement("html2canvaswrapper");t.appendChild(A.cloneNode(!0));var r=A.parentNode;if(r){r.replaceChild(t,A);var n=T(t);return t.firstChild&&r.replaceChild(t.firstChild,t),n}}return new I(0,0,0,0)},En=function(A,e,t){var r=A.ownerDocument;if(!r)throw new Error("Node has no owner document");var n=r.createRange();return n.setStart(A,e),n.setEnd(A,e+t),I.fromClientRect(n.getBoundingClientRect())},Fn=function(A,e){return 0!==e.letterSpacing?c(A).map(function(A){return l(A)}):hn(A,e)},hn=function(A,e){for(var t,r=function(A,e){var t=c(A),r=u(t,e),n=r[0],B=r[1],s=r[2],o=t.length,i=0,a=0;return{next:function(){if(o<=a)return{done:!0,value:null};for(var A=Y;a<o&&(A=w(t,B,n,++a,s))===Y;);if(A===Y&&a!==o)return{done:!0,value:null};var e=new nA(t,A,i,a);return i=a,{value:e,done:!1}}}}(A,{lineBreak:e.lineBreak,wordBreak:e.overflowWrap===Ur.BREAK_WORD?"break-word":e.wordBreak}),n=[];!(t=r.next()).done;)t.value&&n.push(t.value.slice());return n},Hn=function(A,e){this.text=dn(A.data,e.textTransform),this.textBounds=function(A,t,r){var e=Fn(A,t),n=[],B=0;return e.forEach(function(A){if(t.textDecorationLine.length||0<A.trim().length)if(Oe.SUPPORT_RANGE_BOUNDS)n.push(new Cn(A,En(r,B,A.length)));else{var e=r.splitText(A.length);n.push(new Cn(A,gn(r))),r=e}else Oe.SUPPORT_RANGE_BOUNDS||(r=r.splitText(A.length));B+=A.length}),n}(this.text,e,A)},dn=function(A,e){switch(e){case Ir.LOWERCASE:return A.toLowerCase();case Ir.CAPITALIZE:return A.replace(fn,pn);case Ir.UPPERCASE:return A.toUpperCase();default:return A}},fn=/(^|\s|:|-|\(|\))([a-z])/g,pn=function(A,e,t){return 0<A.length?e+t.toUpperCase():A},Nn=(A(Kn,Qn=ln),Kn);function Kn(A){var e=Qn.call(this,A)||this;return e.src=A.currentSrc||A.src,e.intrinsicWidth=A.naturalWidth,e.intrinsicHeight=A.naturalHeight,Se.getInstance().addImage(e.src),e}var In,Tn=(A(mn,In=ln),mn);function mn(A){var e=In.call(this,A)||this;return e.canvas=A,e.intrinsicWidth=A.width,e.intrinsicHeight=A.height,e}var Rn,Ln=(A(vn,Rn=ln),vn);function vn(A){var e=Rn.call(this,A)||this,t=new XMLSerializer;return e.svg="data:image/svg+xml,"+encodeURIComponent(t.serializeToString(A)),e.intrinsicWidth=A.width.baseVal.value,e.intrinsicHeight=A.height.baseVal.value,Se.getInstance().addImage(e.svg),e}var On,Dn=(A(bn,On=ln),bn);function bn(A){var e=On.call(this,A)||this;return e.value=A.value,e}var Sn,Mn=(A(yn,Sn=ln),yn);function yn(A){var e=Sn.call(this,A)||this;return e.start=A.start,e.reversed="boolean"==typeof A.reversed&&!0===A.reversed,e}var _n,Pn=[{type:sA.DIMENSION_TOKEN,flags:0,unit:"px",number:3}],xn=[{type:sA.PERCENTAGE_TOKEN,flags:0,number:50}],Vn="checkbox",zn="radio",Xn="password",Jn=707406591,Gn=(A(kn,_n=ln),kn);function kn(A){var e=_n.call(this,A)||this;switch(e.type=A.type.toLowerCase(),e.checked=A.checked,e.value=function(A){var e=A.type===Xn?new Array(A.value.length+1).join("•"):A.value;return 0===e.length?A.placeholder||"":e}(A),e.type!==Vn&&e.type!==zn||(e.styles.backgroundColor=3739148031,e.styles.borderTopColor=e.styles.borderRightColor=e.styles.borderBottomColor=e.styles.borderLeftColor=2779096575,e.styles.borderTopWidth=e.styles.borderRightWidth=e.styles.borderBottomWidth=e.styles.borderLeftWidth=1,e.styles.borderTopStyle=e.styles.borderRightStyle=e.styles.borderBottomStyle=e.styles.borderLeftStyle=ht.SOLID,e.styles.backgroundClip=[Ee.BORDER_BOX],e.styles.backgroundOrigin=[0],e.bounds=function(A){return A.width>A.height?new I(A.left+(A.width-A.height)/2,A.top,A.height,A.height):A.width<A.height?new I(A.left,A.top+(A.height-A.width)/2,A.width,A.width):A}(e.bounds)),e.type){case Vn:e.styles.borderTopRightRadius=e.styles.borderTopLeftRadius=e.styles.borderBottomRightRadius=e.styles.borderBottomLeftRadius=Pn;break;case zn:e.styles.borderTopRightRadius=e.styles.borderTopLeftRadius=e.styles.borderBottomRightRadius=e.styles.borderBottomLeftRadius=xn}return e}var Wn,Yn=(A(qn,Wn=ln),qn);function qn(A){var e=Wn.call(this,A)||this,t=A.options[A.selectedIndex||0];return e.value=t&&t.text||"",e}var Zn,jn=(A($n,Zn=ln),$n);function $n(A){var e=Zn.call(this,A)||this;return e.value=A.value,e}function AB(A){return we(_A.create(A).parseComponentValue())}var eB,tB=(A(rB,eB=ln),rB);function rB(A){var e=eB.call(this,A)||this;e.src=A.src,e.width=parseInt(A.width,10)||0,e.height=parseInt(A.height,10)||0,e.backgroundColor=e.styles.backgroundColor;try{if(A.contentWindow&&A.contentWindow.document&&A.contentWindow.document.documentElement){e.tree=iB(A.contentWindow.document.documentElement);var t=A.contentWindow.document.documentElement?AB(getComputedStyle(A.contentWindow.document.documentElement).backgroundColor):He.TRANSPARENT,r=A.contentWindow.document.body?AB(getComputedStyle(A.contentWindow.document.body).backgroundColor):He.TRANSPARENT;e.backgroundColor=ee(t)?ee(r)?e.styles.backgroundColor:r:t}}catch(A){}return e}function nB(A){return"STYLE"===A.tagName}var BB=["OL","UL","MENU"],sB=function(A,e,t){for(var r=A.firstChild,n=void 0;r;r=n)if(n=r.nextSibling,QB(r)&&0<r.data.trim().length)e.textNodes.push(new Hn(r,e.styles));else if(wB(r)){var B=oB(r);B.styles.isVisible()&&(aB(r,B,t)?B.flags|=4:cB(B.styles)&&(B.flags|=2),-1!==BB.indexOf(r.tagName)&&(B.flags|=8),e.elements.push(B),dB(r)||gB(r)||fB(r)||sB(r,B,t))}},oB=function(A){return hB(A)?new Nn(A):FB(A)?new Tn(A):gB(A)?new Ln(A):UB(A)?new Dn(A):lB(A)?new Mn(A):CB(A)?new Gn(A):fB(A)?new Yn(A):dB(A)?new jn(A):HB(A)?new tB(A):new ln(A)},iB=function(A){var e=oB(A);return e.flags|=4,sB(A,e,e),e},aB=function(A,e,t){return e.styles.isPositionedWithZIndex()||e.styles.opacity<1||e.styles.isTransformed()||EB(A)&&t.styles.isTransparent()},cB=function(A){return A.isPositioned()||A.isFloating()},QB=function(A){return A.nodeType===Node.TEXT_NODE},wB=function(A){return A.nodeType===Node.ELEMENT_NODE},uB=function(A){return void 0!==A.style},UB=function(A){return"LI"===A.tagName},lB=function(A){return"OL"===A.tagName},CB=function(A){return"INPUT"===A.tagName},gB=function(A){return"svg"===A.tagName},EB=function(A){return"BODY"===A.tagName},FB=function(A){return"CANVAS"===A.tagName},hB=function(A){return"IMG"===A.tagName},HB=function(A){return"IFRAME"===A.tagName},dB=function(A){return"TEXTAREA"===A.tagName},fB=function(A){return"SELECT"===A.tagName},pB=(NB.prototype.getCounterValue=function(A){var e=this.counters[A];return e&&e.length?e[e.length-1]:1},NB.prototype.getCounterValues=function(A){var e=this.counters[A];return e||[]},NB.prototype.pop=function(A){var e=this;A.forEach(function(A){return e.counters[A].pop()})},NB.prototype.parse=function(A){var t=this,e=A.counterIncrement,r=A.counterReset,n=!0;null!==e&&e.forEach(function(A){var e=t.counters[A.counter];e&&0!==A.increment&&(n=!1,e[Math.max(0,e.length-1)]+=A.increment)});var B=[];return n&&r.forEach(function(A){var e=t.counters[A.counter];B.push(A.counter),e||(e=t.counters[A.counter]=[]),e.push(A.reset)}),B},NB);function NB(){this.counters={}}function KB(r,A,e,n,t,B){return r<A||e<r?yB(r,t,0<B.length):n.integers.reduce(function(A,e,t){for(;e<=r;)r-=e,A+=n.values[t];return A},"")+B}function IB(A,e,t,r){for(var n="";t||A--,n=r(A)+n,e<=(A/=e)*e;);return n}function TB(A,e,t,r,n){var B=t-e+1;return(A<0?"-":"")+(IB(Math.abs(A),B,r,function(A){return l(Math.floor(A%B)+e)})+n)}function mB(A,e,t){void 0===t&&(t=". ");var r=e.length;return IB(Math.abs(A),r,!1,function(A){return e[Math.floor(A%r)]})+t}function RB(A,e,t,r,n,B){if(A<-9999||9999<A)return yB(A,tr.CJK_DECIMAL,0<n.length);var s=Math.abs(A),o=n;if(0===s)return e[0]+o;for(var i=0;0<s&&i<=4;i++){var a=s%10;0==a&&An(B,1)&&""!==o?o=e[a]+o:1<a||1==a&&0===i||1==a&&1===i&&An(B,2)||1==a&&1===i&&An(B,4)&&100<A||1==a&&1<i&&An(B,8)?o=e[a]+(0<i?t[i-1]:"")+o:1==a&&0<i&&(o=t[i-1]+o),s=Math.floor(s/10)}return(A<0?r:"")+o}var LB,vB,OB={integers:[1e3,900,500,400,100,90,50,40,10,9,5,4,1],values:["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"]},DB={integers:[9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["Ք","Փ","Ւ","Ց","Ր","Տ","Վ","Ս","Ռ","Ջ","Պ","Չ","Ո","Շ","Ն","Յ","Մ","Ճ","Ղ","Ձ","Հ","Կ","Ծ","Խ","Լ","Ի","Ժ","Թ","Ը","Է","Զ","Ե","Դ","Գ","Բ","Ա"]},bB={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,400,300,200,100,90,80,70,60,50,40,30,20,19,18,17,16,15,10,9,8,7,6,5,4,3,2,1],values:["י׳","ט׳","ח׳","ז׳","ו׳","ה׳","ד׳","ג׳","ב׳","א׳","ת","ש","ר","ק","צ","פ","ע","ס","נ","מ","ל","כ","יט","יח","יז","טז","טו","י","ט","ח","ז","ו","ה","ד","ג","ב","א"]},SB={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["ჵ","ჰ","ჯ","ჴ","ხ","ჭ","წ","ძ","ც","ჩ","შ","ყ","ღ","ქ","ფ","ჳ","ტ","ს","რ","ჟ","პ","ო","ჲ","ნ","მ","ლ","კ","ი","თ","ჱ","ზ","ვ","ე","დ","გ","ბ","ა"]},MB="마이너스",yB=function(A,e,t){var r=t?". ":"",n=t?"、":"",B=t?", ":"",s=t?" ":"";switch(e){case tr.DISC:return"•"+s;case tr.CIRCLE:return"◦"+s;case tr.SQUARE:return"◾"+s;case tr.DECIMAL_LEADING_ZERO:var o=TB(A,48,57,!0,r);return o.length<4?"0"+o:o;case tr.CJK_DECIMAL:return mB(A,"〇一二三四五六七八九",n);case tr.LOWER_ROMAN:return KB(A,1,3999,OB,tr.DECIMAL,r).toLowerCase();case tr.UPPER_ROMAN:return KB(A,1,3999,OB,tr.DECIMAL,r);case tr.LOWER_GREEK:return TB(A,945,969,!1,r);case tr.LOWER_ALPHA:return TB(A,97,122,!1,r);case tr.UPPER_ALPHA:return TB(A,65,90,!1,r);case tr.ARABIC_INDIC:return TB(A,1632,1641,!0,r);case tr.ARMENIAN:case tr.UPPER_ARMENIAN:return KB(A,1,9999,DB,tr.DECIMAL,r);case tr.LOWER_ARMENIAN:return KB(A,1,9999,DB,tr.DECIMAL,r).toLowerCase();case tr.BENGALI:return TB(A,2534,2543,!0,r);case tr.CAMBODIAN:case tr.KHMER:return TB(A,6112,6121,!0,r);case tr.CJK_EARTHLY_BRANCH:return mB(A,"子丑寅卯辰巳午未申酉戌亥",n);case tr.CJK_HEAVENLY_STEM:return mB(A,"甲乙丙丁戊己庚辛壬癸",n);case tr.CJK_IDEOGRAPHIC:case tr.TRAD_CHINESE_INFORMAL:return RB(A,"零一二三四五六七八九","十百千萬","負",n,14);case tr.TRAD_CHINESE_FORMAL:return RB(A,"零壹貳參肆伍陸柒捌玖","拾佰仟萬","負",n,15);case tr.SIMP_CHINESE_INFORMAL:return RB(A,"零一二三四五六七八九","十百千萬","负",n,14);case tr.SIMP_CHINESE_FORMAL:return RB(A,"零壹贰叁肆伍陆柒捌玖","拾佰仟萬","负",n,15);case tr.JAPANESE_INFORMAL:return RB(A,"〇一二三四五六七八九","十百千万","マイナス",n,0);case tr.JAPANESE_FORMAL:return RB(A,"零壱弐参四伍六七八九","拾百千万","マイナス",n,7);case tr.KOREAN_HANGUL_FORMAL:return RB(A,"영일이삼사오육칠팔구","십백천만",MB,B,7);case tr.KOREAN_HANJA_INFORMAL:return RB(A,"零一二三四五六七八九","十百千萬",MB,B,0);case tr.KOREAN_HANJA_FORMAL:return RB(A,"零壹貳參四五六七八九","拾百千",MB,B,7);case tr.DEVANAGARI:return TB(A,2406,2415,!0,r);case tr.GEORGIAN:return KB(A,1,19999,SB,tr.DECIMAL,r);case tr.GUJARATI:return TB(A,2790,2799,!0,r);case tr.GURMUKHI:return TB(A,2662,2671,!0,r);case tr.HEBREW:return KB(A,1,10999,bB,tr.DECIMAL,r);case tr.HIRAGANA:return mB(A,"あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわゐゑをん");case tr.HIRAGANA_IROHA:return mB(A,"いろはにほへとちりぬるをわかよたれそつねならむうゐのおくやまけふこえてあさきゆめみしゑひもせす");case tr.KANNADA:return TB(A,3302,3311,!0,r);case tr.KATAKANA:return mB(A,"アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤユヨラリルレロワヰヱヲン",n);case tr.KATAKANA_IROHA:return mB(A,"イロハニホヘトチリヌルヲワカヨタレソツネナラムウヰノオクヤマケフコエテアサキユメミシヱヒモセス",n);case tr.LAO:return TB(A,3792,3801,!0,r);case tr.MONGOLIAN:return TB(A,6160,6169,!0,r);case tr.MYANMAR:return TB(A,4160,4169,!0,r);case tr.ORIYA:return TB(A,2918,2927,!0,r);case tr.PERSIAN:return TB(A,1776,1785,!0,r);case tr.TAMIL:return TB(A,3046,3055,!0,r);case tr.TELUGU:return TB(A,3174,3183,!0,r);case tr.THAI:return TB(A,3664,3673,!0,r);case tr.TIBETAN:return TB(A,3872,3881,!0,r);case tr.DECIMAL:default:return TB(A,48,57,!0,r)}},_B="data-html2canvas-ignore",PB=(xB.prototype.toIFrame=function(A,t){var e=this,r=XB(A,t);if(!r.contentWindow)return Promise.reject("Unable to find iframe window");var n=A.defaultView.pageXOffset,B=A.defaultView.pageYOffset,s=r.contentWindow,o=s.document,i=JB(r).then(function(){return a(e,void 0,void 0,function(){var e;return S(this,function(A){switch(A.label){case 0:return this.scrolledElements.forEach(YB),s&&(s.scrollTo(t.left,t.top),!/(iPad|iPhone|iPod)/g.test(navigator.userAgent)||s.scrollY===t.top&&s.scrollX===t.left||(o.documentElement.style.top=-t.top+"px",o.documentElement.style.left=-t.left+"px",o.documentElement.style.position="absolute")),e=this.options.onclone,void 0===this.clonedReferenceElement?[2,Promise.reject("Error finding the "+this.referenceElement.nodeName+" in the cloned document")]:o.fonts&&o.fonts.ready?[4,o.fonts.ready]:[3,2];case 1:A.sent(),A.label=2;case 2:return"function"==typeof e?[2,Promise.resolve().then(function(){return e(o)}).then(function(){return r})]:[2,r]}})})});return o.open(),o.write(kB(document.doctype)+"<html></html>"),WB(this.referenceElement.ownerDocument,n,B),o.replaceChild(o.adoptNode(this.documentElement),o.documentElement),o.close(),i},xB.prototype.createElementClone=function(A){return FB(A)?this.createCanvasClone(A):nB(A)?this.createStyleClone(A):A.cloneNode(!1)},xB.prototype.createStyleClone=function(A){try{var e=A.sheet;if(e&&e.cssRules){var t=[].slice.call(e.cssRules,0).reduce(function(A,e){return e&&"string"==typeof e.cssText?A+e.cssText:A},""),r=A.cloneNode(!1);return r.textContent=t,r}}catch(A){if(De.getInstance(this.options.id).error("Unable to access cssRules property",A),"SecurityError"!==A.name)throw A}return A.cloneNode(!1)},xB.prototype.createCanvasClone=function(A){if(this.options.inlineImages&&A.ownerDocument){var e=A.ownerDocument.createElement("img");try{return e.src=A.toDataURL(),e}catch(A){De.getInstance(this.options.id).info("Unable to clone canvas contents, canvas is tainted")}}var t=A.cloneNode(!1);try{t.width=A.width,t.height=A.height;var r=A.getContext("2d"),n=t.getContext("2d");return n&&(r?n.putImageData(r.getImageData(0,0,A.width,A.height),0,0):n.drawImage(A,0,0)),t}catch(A){}return t},xB.prototype.cloneNode=function(A){if(QB(A))return document.createTextNode(A.data);if(!A.ownerDocument)return A.cloneNode(!1);var e=A.ownerDocument.defaultView;if(uB(A)&&e){var t=this.createElementClone(A),r=e.getComputedStyle(A),n=e.getComputedStyle(A,":before"),B=e.getComputedStyle(A,":after");this.referenceElement===A&&(this.clonedReferenceElement=t),EB(t)&&$B(t);for(var s=this.counters.parse(new un(r)),o=this.resolvePseudoContent(A,t,n,LB.BEFORE),i=A.firstChild;i;i=i.nextSibling)wB(i)&&("SCRIPT"===i.tagName||i.hasAttribute(_B)||"function"==typeof this.options.ignoreElements&&this.options.ignoreElements(i))||this.options.copyStyles&&wB(i)&&nB(i)||t.appendChild(this.cloneNode(i));o&&t.insertBefore(o,t.firstChild);var a=this.resolvePseudoContent(A,t,B,LB.AFTER);return a&&t.appendChild(a),this.counters.pop(s),r&&this.options.copyStyles&&!HB(A)&&GB(r,t),0===A.scrollTop&&0===A.scrollLeft||this.scrolledElements.push([t,A.scrollLeft,A.scrollTop]),(dB(A)||fB(A))&&(dB(t)||fB(t))&&(t.value=A.value),t}return A.cloneNode(!1)},xB.prototype.resolvePseudoContent=function(U,A,e,t){var l=this;if(e){var r=e.content,C=A.ownerDocument;if(C&&r&&"none"!==r&&"-moz-alt-content"!==r&&"none"!==e.display){this.counters.parse(new un(e));var g=new wn(e),E=C.createElement("html2canvaspseudoelement");GB(e,E),g.content.forEach(function(A){if(A.type===sA.STRING_TOKEN)E.appendChild(C.createTextNode(A.value));else if(A.type===sA.URL_TOKEN){var e=C.createElement("img");e.src=A.value,e.style.opacity="1",E.appendChild(e)}else if(A.type===sA.FUNCTION){if("attr"===A.name){var t=A.values.filter(zA);t.length&&E.appendChild(C.createTextNode(U.getAttribute(t[0].value)||""))}else if("counter"===A.name){var r=A.values.filter(kA),n=r[0],B=r[1];if(n&&zA(n)){var s=l.counters.getCounterValue(n.value),o=B&&zA(B)?ir.parse(B.value):tr.DECIMAL;E.appendChild(C.createTextNode(yB(s,o,!1)))}}else if("counters"===A.name){var i=A.values.filter(kA),a=(n=i[0],i[1]);if(B=i[2],n&&zA(n)){var c=l.counters.getCounterValues(n.value),Q=B&&zA(B)?ir.parse(B.value):tr.DECIMAL,w=a&&a.type===sA.STRING_TOKEN?a.value:"",u=c.map(function(A){return yB(A,Q,!1)}).join(w);E.appendChild(C.createTextNode(u))}}}else if(A.type===sA.IDENT_TOKEN)switch(A.value){case"open-quote":E.appendChild(C.createTextNode(en(g.quotes,l.quoteDepth++,!0)));break;case"close-quote":E.appendChild(C.createTextNode(en(g.quotes,--l.quoteDepth,!1)));break;default:E.appendChild(C.createTextNode(A.value))}}),E.className=qB+" "+ZB;var n=t===LB.BEFORE?" "+qB:" "+ZB;return function(A){return"object"==typeof A.className}(A)?A.className.baseValue+=n:A.className+=n,E}}},xB.destroy=function(A){return!!A.parentNode&&(A.parentNode.removeChild(A),!0)},xB);function xB(A,e){if(this.options=e,this.scrolledElements=[],this.referenceElement=A,this.counters=new pB,this.quoteDepth=0,!A.ownerDocument)throw new Error("Cloned element does not have an owner document");this.documentElement=this.cloneNode(A.ownerDocument.documentElement)}(vB=LB||(LB={}))[vB.BEFORE=0]="BEFORE",vB[vB.AFTER=1]="AFTER";var VB,zB,XB=function(A,e){var t=A.createElement("iframe");return t.className="html2canvas-container",t.style.visibility="hidden",t.style.position="fixed",t.style.left="-10000px",t.style.top="0px",t.style.border="0",t.width=e.width.toString(),t.height=e.height.toString(),t.scrolling="no",t.setAttribute(_B,"true"),A.body.appendChild(t),t},JB=function(n){return new Promise(function(e,A){var t=n.contentWindow;if(!t)return A("No window assigned for iframe");var r=t.document;t.onload=n.onload=r.onreadystatechange=function(){t.onload=n.onload=r.onreadystatechange=null;var A=setInterval(function(){0<r.body.childNodes.length&&"complete"===r.readyState&&(clearInterval(A),e(n))},50)}})},GB=function(A,e){for(var t=A.length-1;0<=t;t--){var r=A.item(t);"content"!==r&&e.style.setProperty(r,A.getPropertyValue(r))}return e},kB=function(A){var e="";return A&&(e+="<!DOCTYPE ",A.name&&(e+=A.name),A.internalSubset&&(e+=A.internalSubset),A.publicId&&(e+='"'+A.publicId+'"'),A.systemId&&(e+='"'+A.systemId+'"'),e+=">"),e},WB=function(A,e,t){A&&A.defaultView&&(e!==A.defaultView.pageXOffset||t!==A.defaultView.pageYOffset)&&A.defaultView.scrollTo(e,t)},YB=function(A){var e=A[0],t=A[1],r=A[2];e.scrollLeft=t,e.scrollTop=r},qB="___html2canvas___pseudoelement_before",ZB="___html2canvas___pseudoelement_after",jB='{\n    content: "" !important;\n    display: none !important;\n}',$B=function(A){As(A,"."+qB+":before"+jB+"\n         ."+ZB+":after"+jB)},As=function(A,e){var t=A.ownerDocument;if(t){var r=t.createElement("style");r.textContent=e,A.appendChild(r)}};(zB=VB||(VB={}))[zB.VECTOR=0]="VECTOR",zB[zB.BEZIER_CURVE=1]="BEZIER_CURVE";function es(A,t){return A.length===t.length&&A.some(function(A,e){return A===t[e]})}var ts=(rs.prototype.add=function(A,e){return new rs(this.x+A,this.y+e)},rs);function rs(A,e){this.type=VB.VECTOR,this.x=A,this.y=e}function ns(A,e,t){return new ts(A.x+(e.x-A.x)*t,A.y+(e.y-A.y)*t)}var Bs=(ss.prototype.subdivide=function(A,e){var t=ns(this.start,this.startControl,A),r=ns(this.startControl,this.endControl,A),n=ns(this.endControl,this.end,A),B=ns(t,r,A),s=ns(r,n,A),o=ns(B,s,A);return e?new ss(this.start,t,B,o):new ss(o,s,n,this.end)},ss.prototype.add=function(A,e){return new ss(this.start.add(A,e),this.startControl.add(A,e),this.endControl.add(A,e),this.end.add(A,e))},ss.prototype.reverse=function(){return new ss(this.end,this.endControl,this.startControl,this.start)},ss);function ss(A,e,t,r){this.type=VB.BEZIER_CURVE,this.start=A,this.startControl=e,this.endControl=t,this.end=r}function os(A){return A.type===VB.BEZIER_CURVE}var is,as,cs=function(A){var e=A.styles,t=A.bounds,r=jA(e.borderTopLeftRadius,t.width,t.height),n=r[0],B=r[1],s=jA(e.borderTopRightRadius,t.width,t.height),o=s[0],i=s[1],a=jA(e.borderBottomRightRadius,t.width,t.height),c=a[0],Q=a[1],w=jA(e.borderBottomLeftRadius,t.width,t.height),u=w[0],U=w[1],l=[];l.push((n+o)/t.width),l.push((u+c)/t.width),l.push((B+U)/t.height),l.push((i+Q)/t.height);var C=Math.max.apply(Math,l);1<C&&(n/=C,B/=C,o/=C,i/=C,c/=C,Q/=C,u/=C,U/=C);var g=t.width-o,E=t.height-Q,F=t.width-c,h=t.height-U,H=e.borderTopWidth,d=e.borderRightWidth,f=e.borderBottomWidth,p=e.borderLeftWidth,N=ae(e.paddingTop,A.bounds.width),K=ae(e.paddingRight,A.bounds.width),I=ae(e.paddingBottom,A.bounds.width),T=ae(e.paddingLeft,A.bounds.width);this.topLeftBorderBox=0<n||0<B?us(t.left,t.top,n,B,is.TOP_LEFT):new ts(t.left,t.top),this.topRightBorderBox=0<o||0<i?us(t.left+g,t.top,o,i,is.TOP_RIGHT):new ts(t.left+t.width,t.top),this.bottomRightBorderBox=0<c||0<Q?us(t.left+F,t.top+E,c,Q,is.BOTTOM_RIGHT):new ts(t.left+t.width,t.top+t.height),this.bottomLeftBorderBox=0<u||0<U?us(t.left,t.top+h,u,U,is.BOTTOM_LEFT):new ts(t.left,t.top+t.height),this.topLeftPaddingBox=0<n||0<B?us(t.left+p,t.top+H,Math.max(0,n-p),Math.max(0,B-H),is.TOP_LEFT):new ts(t.left+p,t.top+H),this.topRightPaddingBox=0<o||0<i?us(t.left+Math.min(g,t.width+p),t.top+H,g>t.width+p?0:o-p,i-H,is.TOP_RIGHT):new ts(t.left+t.width-d,t.top+H),this.bottomRightPaddingBox=0<c||0<Q?us(t.left+Math.min(F,t.width-p),t.top+Math.min(E,t.height+H),Math.max(0,c-d),Q-f,is.BOTTOM_RIGHT):new ts(t.left+t.width-d,t.top+t.height-f),this.bottomLeftPaddingBox=0<u||0<U?us(t.left+p,t.top+h,Math.max(0,u-p),U-f,is.BOTTOM_LEFT):new ts(t.left+p,t.top+t.height-f),this.topLeftContentBox=0<n||0<B?us(t.left+p+T,t.top+H+N,Math.max(0,n-(p+T)),Math.max(0,B-(H+N)),is.TOP_LEFT):new ts(t.left+p+T,t.top+H+N),this.topRightContentBox=0<o||0<i?us(t.left+Math.min(g,t.width+p+T),t.top+H+N,g>t.width+p+T?0:o-p+T,i-(H+N),is.TOP_RIGHT):new ts(t.left+t.width-(d+K),t.top+H+N),this.bottomRightContentBox=0<c||0<Q?us(t.left+Math.min(F,t.width-(p+T)),t.top+Math.min(E,t.height+H+N),Math.max(0,c-(d+K)),Q-(f+I),is.BOTTOM_RIGHT):new ts(t.left+t.width-(d+K),t.top+t.height-(f+I)),this.bottomLeftContentBox=0<u||0<U?us(t.left+p+T,t.top+h,Math.max(0,u-(p+T)),U-(f+I),is.BOTTOM_LEFT):new ts(t.left+p+T,t.top+t.height-(f+I))};(as=is||(is={}))[as.TOP_LEFT=0]="TOP_LEFT",as[as.TOP_RIGHT=1]="TOP_RIGHT",as[as.BOTTOM_RIGHT=2]="BOTTOM_RIGHT",as[as.BOTTOM_LEFT=3]="BOTTOM_LEFT";function Qs(A){return[A.topLeftBorderBox,A.topRightBorderBox,A.bottomRightBorderBox,A.bottomLeftBorderBox]}function ws(A){return[A.topLeftPaddingBox,A.topRightPaddingBox,A.bottomRightPaddingBox,A.bottomLeftPaddingBox]}var us=function(A,e,t,r,n){var B=(Math.sqrt(2)-1)/3*4,s=t*B,o=r*B,i=A+t,a=e+r;switch(n){case is.TOP_LEFT:return new Bs(new ts(A,a),new ts(A,a-o),new ts(i-s,e),new ts(i,e));case is.TOP_RIGHT:return new Bs(new ts(A,e),new ts(A+s,e),new ts(i,a-o),new ts(i,a));case is.BOTTOM_RIGHT:return new Bs(new ts(i,e),new ts(i,e+o),new ts(A+s,a),new ts(A,a));case is.BOTTOM_LEFT:default:return new Bs(new ts(i,a),new ts(i-s,a),new ts(A,e+o),new ts(A,e))}},Us=function(A,e,t){this.type=0,this.offsetX=A,this.offsetY=e,this.matrix=t,this.target=6},ls=function(A,e){this.type=1,this.target=e,this.path=A},Cs=function(A){this.element=A,this.inlineLevel=[],this.nonInlineLevel=[],this.negativeZIndex=[],this.zeroOrAutoZIndexOrTransformedOrOpacity=[],this.positiveZIndex=[],this.nonPositionedFloats=[],this.nonPositionedInlineLevel=[]},gs=(Es.prototype.getParentEffects=function(){var A=this.effects.slice(0);if(this.container.styles.overflowX!==sr.VISIBLE){var e=Qs(this.curves),t=ws(this.curves);es(e,t)||A.push(new ls(t,6))}return A},Es);function Es(A,e){if(this.container=A,this.effects=e.slice(0),this.curves=new cs(A),null!==A.styles.transform){var t=A.bounds.left+A.styles.transformOrigin[0].number,r=A.bounds.top+A.styles.transformOrigin[1].number,n=A.styles.transform;this.effects.push(new Us(t,r,n))}if(A.styles.overflowX!==sr.VISIBLE){var B=Qs(this.curves),s=ws(this.curves);es(B,s)?this.effects.push(new ls(B,6)):(this.effects.push(new ls(B,2)),this.effects.push(new ls(s,4)))}}function Fs(A){var e=A.bounds,t=A.styles;return e.add(t.borderLeftWidth,t.borderTopWidth,-(t.borderRightWidth+t.borderLeftWidth),-(t.borderTopWidth+t.borderBottomWidth))}function hs(A){var e=A.styles,t=A.bounds,r=ae(e.paddingLeft,t.width),n=ae(e.paddingRight,t.width),B=ae(e.paddingTop,t.width),s=ae(e.paddingBottom,t.width);return t.add(r+e.borderLeftWidth,B+e.borderTopWidth,-(e.borderRightWidth+e.borderLeftWidth+r+n),-(e.borderTopWidth+e.borderBottomWidth+B+s))}function Hs(A,e,t){var r=function(A,e){return 0===A?e.bounds:2===A?hs(e):Fs(e)}(Ts(A.styles.backgroundOrigin,e),A),n=function(A,e){return A===Ee.BORDER_BOX?e.bounds:A===Ee.CONTENT_BOX?hs(e):Fs(e)}(Ts(A.styles.backgroundClip,e),A),B=Is(Ts(A.styles.backgroundSize,e),t,r),s=B[0],o=B[1],i=jA(Ts(A.styles.backgroundPosition,e),r.width-s,r.height-o);return[ms(Ts(A.styles.backgroundRepeat,e),i,B,r,n),Math.round(r.left+i[0]),Math.round(r.top+i[1]),s,o]}function ds(A){return zA(A)&&A.value===Ut.AUTO}function fs(A){return"number"==typeof A}var ps=function(c,Q,w,u){c.container.elements.forEach(function(A){var e=An(A.flags,4),t=An(A.flags,2),r=new gs(A,c.getParentEffects());An(A.styles.display,2048)&&u.push(r);var n=An(A.flags,8)?[]:u;if(e||t){var B=e||A.styles.isPositioned()?w:Q,s=new Cs(r);if(A.styles.isPositioned()||A.styles.opacity<1||A.styles.isTransformed()){var o=A.styles.zIndex.order;if(o<0){var i=0;B.negativeZIndex.some(function(A,e){return o>A.element.container.styles.zIndex.order?(i=e,!1):0<i}),B.negativeZIndex.splice(i,0,s)}else if(0<o){var a=0;B.positiveZIndex.some(function(A,e){return o>A.element.container.styles.zIndex.order?(a=e+1,!1):0<a}),B.positiveZIndex.splice(a,0,s)}else B.zeroOrAutoZIndexOrTransformedOrOpacity.push(s)}else A.styles.isFloating()?B.nonPositionedFloats.push(s):B.nonPositionedInlineLevel.push(s);ps(r,s,e?s:w,n)}else A.styles.isInlineLevel()?Q.inlineLevel.push(r):Q.nonInlineLevel.push(r),ps(r,Q,w,n);An(A.flags,8)&&Ns(A,n)})},Ns=function(A,e){for(var t=A instanceof Mn?A.start:1,r=A instanceof Mn&&A.reversed,n=0;n<e.length;n++){var B=e[n];B.container instanceof Dn&&"number"==typeof B.container.value&&0!==B.container.value&&(t=B.container.value),B.listValue=yB(t,B.container.styles.listStyleType,!0),t+=r?-1:1}},Ks=function(A,e,t,r){var n=[];return os(A)?n.push(A.subdivide(.5,!1)):n.push(A),os(t)?n.push(t.subdivide(.5,!0)):n.push(t),os(r)?n.push(r.subdivide(.5,!0).reverse()):n.push(r),os(e)?n.push(e.subdivide(.5,!1).reverse()):n.push(e),n},Is=function(A,e,t){var r=e[0],n=e[1],B=e[2],s=A[0],o=A[1];if(qA(s)&&o&&qA(o))return[ae(s,t.width),ae(o,t.height)];var i=fs(B);if(zA(s)&&(s.value===Ut.CONTAIN||s.value===Ut.COVER))return fs(B)?t.width/t.height<B!=(s.value===Ut.COVER)?[t.width,t.width/B]:[t.height*B,t.height]:[t.width,t.height];var a=fs(r),c=fs(n),Q=a||c;if(ds(s)&&(!o||ds(o)))return a&&c?[r,n]:i||Q?Q&&i?[a?r:n*B,c?n:r/B]:[a?r:t.width,c?n:t.height]:[t.width,t.height];if(i){var w=0,u=0;return qA(s)?w=ae(s,t.width):qA(o)&&(u=ae(o,t.height)),ds(s)?w=u*B:o&&!ds(o)||(u=w/B),[w,u]}var U=null,l=null;if(qA(s)?U=ae(s,t.width):o&&qA(o)&&(l=ae(o,t.height)),null===U||o&&!ds(o)||(l=a&&c?U/r*n:t.height),null!==l&&ds(s)&&(U=a&&c?l/n*r:t.width),null!==U&&null!==l)return[U,l];throw new Error("Unable to calculate background-size for element")},Ts=function(A,e){var t=A[e];return void 0===t?A[0]:t},ms=function(A,e,t,r,n){var B=e[0],s=e[1],o=t[0],i=t[1];switch(A){case it.REPEAT_X:return[new ts(Math.round(r.left),Math.round(r.top+s)),new ts(Math.round(r.left+r.width),Math.round(r.top+s)),new ts(Math.round(r.left+r.width),Math.round(i+r.top+s)),new ts(Math.round(r.left),Math.round(i+r.top+s))];case it.REPEAT_Y:return[new ts(Math.round(r.left+B),Math.round(r.top)),new ts(Math.round(r.left+B+o),Math.round(r.top)),new ts(Math.round(r.left+B+o),Math.round(r.height+r.top)),new ts(Math.round(r.left+B),Math.round(r.height+r.top))];case it.NO_REPEAT:return[new ts(Math.round(r.left+B),Math.round(r.top+s)),new ts(Math.round(r.left+B+o),Math.round(r.top+s)),new ts(Math.round(r.left+B+o),Math.round(r.top+s+i)),new ts(Math.round(r.left+B),Math.round(r.top+s+i))];default:return[new ts(Math.round(n.left),Math.round(n.top)),new ts(Math.round(n.left+n.width),Math.round(n.top)),new ts(Math.round(n.left+n.width),Math.round(n.height+n.top)),new ts(Math.round(n.left),Math.round(n.height+n.top))]}},Rs="Hidden Text",Ls=(vs.prototype.parseMetrics=function(A,e){var t=this._document.createElement("div"),r=this._document.createElement("img"),n=this._document.createElement("span"),B=this._document.body;t.style.visibility="hidden",t.style.fontFamily=A,t.style.fontSize=e,t.style.margin="0",t.style.padding="0",B.appendChild(t),r.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",r.width=1,r.height=1,r.style.margin="0",r.style.padding="0",r.style.verticalAlign="baseline",n.style.fontFamily=A,n.style.fontSize=e,n.style.margin="0",n.style.padding="0",n.appendChild(this._document.createTextNode(Rs)),t.appendChild(n),t.appendChild(r);var s=r.offsetTop-n.offsetTop+2;t.removeChild(n),t.appendChild(this._document.createTextNode(Rs)),t.style.lineHeight="normal",r.style.verticalAlign="super";var o=r.offsetTop-t.offsetTop+2;return B.removeChild(t),{baseline:s,middle:o}},vs.prototype.getMetrics=function(A,e){var t=A+" "+e;return void 0===this._data[t]&&(this._data[t]=this.parseMetrics(A,e)),this._data[t]},vs);function vs(A){this._data={},this._document=A}var Os=(Ds.prototype.applyEffects=function(A,e){for(var t=this;this._activeEffects.length;)this.popEffect();A.filter(function(A){return An(A.target,e)}).forEach(function(A){return t.applyEffect(A)})},Ds.prototype.applyEffect=function(A){this.ctx.save(),function(A){return 0===A.type}(A)&&(this.ctx.translate(A.offsetX,A.offsetY),this.ctx.transform(A.matrix[0],A.matrix[1],A.matrix[2],A.matrix[3],A.matrix[4],A.matrix[5]),this.ctx.translate(-A.offsetX,-A.offsetY)),function(A){return 1===A.type}(A)&&(this.path(A.path),this.ctx.clip()),this._activeEffects.push(A)},Ds.prototype.popEffect=function(){this._activeEffects.pop(),this.ctx.restore()},Ds.prototype.renderStack=function(t){return a(this,void 0,void 0,function(){var e;return S(this,function(A){switch(A.label){case 0:return(e=t.element.container.styles).isVisible()?(this.ctx.globalAlpha=e.opacity,[4,this.renderStackContent(t)]):[3,2];case 1:A.sent(),A.label=2;case 2:return[2]}})})},Ds.prototype.renderNode=function(e){return a(this,void 0,void 0,function(){return S(this,function(A){switch(A.label){case 0:return e.container.styles.isVisible()?[4,this.renderNodeBackgroundAndBorders(e)]:[3,3];case 1:return A.sent(),[4,this.renderNodeContent(e)];case 2:A.sent(),A.label=3;case 3:return[2]}})})},Ds.prototype.renderTextWithLetterSpacing=function(t,A){var r=this;0===A?this.ctx.fillText(t.text,t.bounds.left,t.bounds.top+t.bounds.height):c(t.text).map(function(A){return l(A)}).reduce(function(A,e){return r.ctx.fillText(e,A,t.bounds.top+t.bounds.height),A+r.ctx.measureText(e).width},t.bounds.left)},Ds.prototype.createFontStyle=function(A){var e=A.fontVariant.filter(function(A){return"normal"===A||"small-caps"===A}).join(""),t=A.fontFamily.join(", "),r=xA(A.fontSize)?""+A.fontSize.number+A.fontSize.unit:A.fontSize.number+"px";return[[A.fontStyle,e,A.fontWeight,r,t].join(" "),t,r]},Ds.prototype.renderTextNode=function(r,o){return a(this,void 0,void 0,function(){var e,t,n,B,s=this;return S(this,function(A){return e=this.createFontStyle(o),t=e[0],n=e[1],B=e[2],this.ctx.font=t,r.textBounds.forEach(function(r){s.ctx.fillStyle=te(o.color),s.renderTextWithLetterSpacing(r,o.letterSpacing);var A=o.textShadow;A.length&&r.text.trim().length&&(A.slice(0).reverse().forEach(function(A){s.ctx.shadowColor=te(A.color),s.ctx.shadowOffsetX=A.offsetX.number*s.options.scale,s.ctx.shadowOffsetY=A.offsetY.number*s.options.scale,s.ctx.shadowBlur=A.blur.number,s.ctx.fillText(r.text,r.bounds.left,r.bounds.top+r.bounds.height)}),s.ctx.shadowColor="",s.ctx.shadowOffsetX=0,s.ctx.shadowOffsetY=0,s.ctx.shadowBlur=0),o.textDecorationLine.length&&(s.ctx.fillStyle=te(o.textDecorationColor||o.color),o.textDecorationLine.forEach(function(A){switch(A){case 1:var e=s.fontMetrics.getMetrics(n,B).baseline;s.ctx.fillRect(r.bounds.left,Math.round(r.bounds.top+e),r.bounds.width,1);break;case 2:s.ctx.fillRect(r.bounds.left,Math.round(r.bounds.top),r.bounds.width,1);break;case 3:var t=s.fontMetrics.getMetrics(n,B).middle;s.ctx.fillRect(r.bounds.left,Math.ceil(r.bounds.top+t),r.bounds.width,1)}}))}),[2]})})},Ds.prototype.renderReplacedElement=function(A,e,t){if(t&&0<A.intrinsicWidth&&0<A.intrinsicHeight){var r=hs(A),n=ws(e);this.path(n),this.ctx.save(),this.ctx.clip(),this.ctx.drawImage(t,0,0,A.intrinsicWidth,A.intrinsicHeight,r.left,r.top,r.width,r.height),this.ctx.restore()}},Ds.prototype.renderNodeContent=function(l){return a(this,void 0,void 0,function(){var e,t,r,n,B,s,o,i,a,c,Q,w,u,U;return S(this,function(A){switch(A.label){case 0:this.applyEffects(l.effects,4),e=l.container,t=l.curves,r=e.styles,n=0,B=e.textNodes,A.label=1;case 1:return n<B.length?(s=B[n],[4,this.renderTextNode(s,r)]):[3,4];case 2:A.sent(),A.label=3;case 3:return n++,[3,1];case 4:if(!(e instanceof Nn))return[3,8];A.label=5;case 5:return A.trys.push([5,7,,8]),[4,this.options.cache.match(e.src)];case 6:return w=A.sent(),this.renderReplacedElement(e,t,w),[3,8];case 7:return A.sent(),De.getInstance(this.options.id).error("Error loading image "+e.src),[3,8];case 8:if(e instanceof Tn&&this.renderReplacedElement(e,t,e.canvas),!(e instanceof Ln))return[3,12];A.label=9;case 9:return A.trys.push([9,11,,12]),[4,this.options.cache.match(e.svg)];case 10:return w=A.sent(),this.renderReplacedElement(e,t,w),[3,12];case 11:return A.sent(),De.getInstance(this.options.id).error("Error loading svg "+e.svg.substring(0,255)),[3,12];case 12:return e instanceof tB&&e.tree?[4,new Ds({id:this.options.id,scale:this.options.scale,backgroundColor:e.backgroundColor,x:0,y:0,scrollX:0,scrollY:0,width:e.width,height:e.height,cache:this.options.cache,windowWidth:e.width,windowHeight:e.height}).render(e.tree)]:[3,14];case 13:o=A.sent(),e.width&&e.height&&this.ctx.drawImage(o,0,0,e.width,e.height,e.bounds.left,e.bounds.top,e.bounds.width,e.bounds.height),A.label=14;case 14:if(e instanceof Gn&&(i=Math.min(e.bounds.width,e.bounds.height),e.type===Vn?e.checked&&(this.ctx.save(),this.path([new ts(e.bounds.left+.39363*i,e.bounds.top+.79*i),new ts(e.bounds.left+.16*i,e.bounds.top+.5549*i),new ts(e.bounds.left+.27347*i,e.bounds.top+.44071*i),new ts(e.bounds.left+.39694*i,e.bounds.top+.5649*i),new ts(e.bounds.left+.72983*i,e.bounds.top+.23*i),new ts(e.bounds.left+.84*i,e.bounds.top+.34085*i),new ts(e.bounds.left+.39363*i,e.bounds.top+.79*i)]),this.ctx.fillStyle=te(Jn),this.ctx.fill(),this.ctx.restore()):e.type===zn&&e.checked&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(e.bounds.left+i/2,e.bounds.top+i/2,i/4,0,2*Math.PI,!0),this.ctx.fillStyle=te(Jn),this.ctx.fill(),this.ctx.restore())),bs(e)&&e.value.length){switch(this.ctx.font=this.createFontStyle(r)[0],this.ctx.fillStyle=te(r.color),this.ctx.textBaseline="middle",this.ctx.textAlign=Ms(e.styles.textAlign),U=hs(e),a=0,e.styles.textAlign){case Cr.CENTER:a+=U.width/2;break;case Cr.RIGHT:a+=U.width}c=U.add(a,0,0,-U.height/2+1),this.ctx.save(),this.path([new ts(U.left,U.top),new ts(U.left+U.width,U.top),new ts(U.left+U.width,U.top+U.height),new ts(U.left,U.top+U.height)]),this.ctx.clip(),this.renderTextWithLetterSpacing(new Cn(e.value,c),r.letterSpacing),this.ctx.restore(),this.ctx.textBaseline="bottom",this.ctx.textAlign="left"}if(!An(e.styles.display,2048))return[3,20];if(null===e.styles.listStyleImage)return[3,19];if((Q=e.styles.listStyleImage).type!==xe.URL)return[3,18];w=void 0,u=Q.url,A.label=15;case 15:return A.trys.push([15,17,,18]),[4,this.options.cache.match(u)];case 16:return w=A.sent(),this.ctx.drawImage(w,e.bounds.left-(w.width+10),e.bounds.top),[3,18];case 17:return A.sent(),De.getInstance(this.options.id).error("Error loading list-style-image "+u),[3,18];case 18:return[3,20];case 19:l.listValue&&e.styles.listStyleType!==tr.NONE&&(this.ctx.font=this.createFontStyle(r)[0],this.ctx.fillStyle=te(r.color),this.ctx.textBaseline="middle",this.ctx.textAlign="right",U=new I(e.bounds.left,e.bounds.top+ae(e.styles.paddingTop,e.bounds.width),e.bounds.width,function(A,e){return zA(A)&&"normal"===A.value?1.2*e:A.type===sA.NUMBER_TOKEN?e*A.number:qA(A)?ae(A,e):e}(r.lineHeight,r.fontSize.number)/2+1),this.renderTextWithLetterSpacing(new Cn(l.listValue,U),r.letterSpacing),this.ctx.textBaseline="bottom",this.ctx.textAlign="left"),A.label=20;case 20:return[2]}})})},Ds.prototype.renderStackContent=function(C){return a(this,void 0,void 0,function(){var e,t,r,n,B,s,o,i,a,c,Q,w,u,U,l;return S(this,function(A){switch(A.label){case 0:return[4,this.renderNodeBackgroundAndBorders(C.element)];case 1:A.sent(),e=0,t=C.negativeZIndex,A.label=2;case 2:return e<t.length?(l=t[e],[4,this.renderStack(l)]):[3,5];case 3:A.sent(),A.label=4;case 4:return e++,[3,2];case 5:return[4,this.renderNodeContent(C.element)];case 6:A.sent(),r=0,n=C.nonInlineLevel,A.label=7;case 7:return r<n.length?(l=n[r],[4,this.renderNode(l)]):[3,10];case 8:A.sent(),A.label=9;case 9:return r++,[3,7];case 10:B=0,s=C.nonPositionedFloats,A.label=11;case 11:return B<s.length?(l=s[B],[4,this.renderStack(l)]):[3,14];case 12:A.sent(),A.label=13;case 13:return B++,[3,11];case 14:o=0,i=C.nonPositionedInlineLevel,A.label=15;case 15:return o<i.length?(l=i[o],[4,this.renderStack(l)]):[3,18];case 16:A.sent(),A.label=17;case 17:return o++,[3,15];case 18:a=0,c=C.inlineLevel,A.label=19;case 19:return a<c.length?(l=c[a],[4,this.renderNode(l)]):[3,22];case 20:A.sent(),A.label=21;case 21:return a++,[3,19];case 22:Q=0,w=C.zeroOrAutoZIndexOrTransformedOrOpacity,A.label=23;case 23:return Q<w.length?(l=w[Q],[4,this.renderStack(l)]):[3,26];case 24:A.sent(),A.label=25;case 25:return Q++,[3,23];case 26:u=0,U=C.positiveZIndex,A.label=27;case 27:return u<U.length?(l=U[u],[4,this.renderStack(l)]):[3,30];case 28:A.sent(),A.label=29;case 29:return u++,[3,27];case 30:return[2]}})})},Ds.prototype.mask=function(A){this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.canvas.width,0),this.ctx.lineTo(this.canvas.width,this.canvas.height),this.ctx.lineTo(0,this.canvas.height),this.ctx.lineTo(0,0),this.formatPath(A.slice(0).reverse()),this.ctx.closePath()},Ds.prototype.path=function(A){this.ctx.beginPath(),this.formatPath(A),this.ctx.closePath()},Ds.prototype.formatPath=function(A){var r=this;A.forEach(function(A,e){var t=os(A)?A.start:A;0===e?r.ctx.moveTo(t.x,t.y):r.ctx.lineTo(t.x,t.y),os(A)&&r.ctx.bezierCurveTo(A.startControl.x,A.startControl.y,A.endControl.x,A.endControl.y,A.end.x,A.end.y)})},Ds.prototype.renderRepeat=function(A,e,t,r){this.path(A),this.ctx.fillStyle=e,this.ctx.translate(t,r),this.ctx.fill(),this.ctx.translate(-t,-r)},Ds.prototype.resizeImage=function(A,e,t){if(A.width===e&&A.height===t)return A;var r=this.canvas.ownerDocument.createElement("canvas");return r.width=e,r.height=t,r.getContext("2d").drawImage(A,0,0,A.width,A.height,0,0,e,t),r},Ds.prototype.renderBackgroundImage=function(b){return a(this,void 0,void 0,function(){var O,e,D,t,r,n;return S(this,function(A){switch(A.label){case 0:O=b.styles.backgroundImage.length-1,e=function(e){var t,r,n,B,s,o,i,a,c,Q,w,u,U,l,C,g,E,F,h,H,d,f,p,N,K,I,T,m,R,L,v;return S(this,function(A){switch(A.label){case 0:if(e.type!==xe.URL)return[3,5];t=void 0,r=e.url,A.label=1;case 1:return A.trys.push([1,3,,4]),[4,D.options.cache.match(r)];case 2:return t=A.sent(),[3,4];case 3:return A.sent(),De.getInstance(D.options.id).error("Error loading background-image "+r),[3,4];case 4:return t&&(n=Hs(b,O,[t.width,t.height,t.width/t.height]),g=n[0],f=n[1],p=n[2],h=n[3],H=n[4],l=D.ctx.createPattern(D.resizeImage(t,h,H),"repeat"),D.renderRepeat(g,l,f,p)),[3,6];case 5:!function(A){return A.type===xe.LINEAR_GRADIENT}(e)?function(A){return A.type===xe.RADIAL_GRADIENT}(e)&&(C=Hs(b,O,[null,null,null]),g=C[0],E=C[1],F=C[2],h=C[3],H=C[4],d=0===e.position.length?[oe]:e.position,f=ae(d[0],h),p=ae(d[d.length-1],H),N=function(A,e,t,r,n){var B=0,s=0;switch(A.size){case Bt.CLOSEST_SIDE:A.shape===rt.CIRCLE?B=s=Math.min(Math.abs(e),Math.abs(e-r),Math.abs(t),Math.abs(t-n)):A.shape===rt.ELLIPSE&&(B=Math.min(Math.abs(e),Math.abs(e-r)),s=Math.min(Math.abs(t),Math.abs(t-n)));break;case Bt.CLOSEST_CORNER:if(A.shape===rt.CIRCLE)B=s=Math.min(Ne(e,t),Ne(e,t-n),Ne(e-r,t),Ne(e-r,t-n));else if(A.shape===rt.ELLIPSE){var o=Math.min(Math.abs(t),Math.abs(t-n))/Math.min(Math.abs(e),Math.abs(e-r)),i=Ke(r,n,e,t,!0),a=i[0],c=i[1];s=o*(B=Ne(a-e,(c-t)/o))}break;case Bt.FARTHEST_SIDE:A.shape===rt.CIRCLE?B=s=Math.max(Math.abs(e),Math.abs(e-r),Math.abs(t),Math.abs(t-n)):A.shape===rt.ELLIPSE&&(B=Math.max(Math.abs(e),Math.abs(e-r)),s=Math.max(Math.abs(t),Math.abs(t-n)));break;case Bt.FARTHEST_CORNER:if(A.shape===rt.CIRCLE)B=s=Math.max(Ne(e,t),Ne(e,t-n),Ne(e-r,t),Ne(e-r,t-n));else if(A.shape===rt.ELLIPSE){o=Math.max(Math.abs(t),Math.abs(t-n))/Math.max(Math.abs(e),Math.abs(e-r));var Q=Ke(r,n,e,t,!1);a=Q[0],c=Q[1],s=o*(B=Ne(a-e,(c-t)/o))}}return Array.isArray(A.size)&&(B=ae(A.size[0],r),s=2===A.size.length?ae(A.size[1],n):B),[B,s]}(e,f,p,h,H),K=N[0],I=N[1],0<K&&0<K&&(T=D.ctx.createRadialGradient(E+f,F+p,0,E+f,F+p,K),fe(e.stops,2*K).forEach(function(A){return T.addColorStop(A.stop,te(A.color))}),D.path(g),D.ctx.fillStyle=T,K!==I?(m=b.bounds.left+.5*b.bounds.width,R=b.bounds.top+.5*b.bounds.height,v=1/(L=I/K),D.ctx.save(),D.ctx.translate(m,R),D.ctx.transform(1,0,0,L,0,0),D.ctx.translate(-m,-R),D.ctx.fillRect(E,v*(F-R)+R,h,H*v),D.ctx.restore()):D.ctx.fill())):(B=Hs(b,O,[null,null,null]),g=B[0],f=B[1],p=B[2],h=B[3],H=B[4],s=pe(e.angle,h,H),o=s[0],i=s[1],a=s[2],c=s[3],Q=s[4],(w=document.createElement("canvas")).width=h,w.height=H,u=w.getContext("2d"),U=u.createLinearGradient(i,c,a,Q),fe(e.stops,o).forEach(function(A){return U.addColorStop(A.stop,te(A.color))}),u.fillStyle=U,u.fillRect(0,0,h,H),0<h&&0<H&&(l=D.ctx.createPattern(w,"repeat"),D.renderRepeat(g,l,f,p))),A.label=6;case 6:return O--,[2]}})},D=this,t=0,r=b.styles.backgroundImage.slice(0).reverse(),A.label=1;case 1:return t<r.length?(n=r[t],[5,e(n)]):[3,4];case 2:A.sent(),A.label=3;case 3:return t++,[3,1];case 4:return[2]}})})},Ds.prototype.renderBorder=function(e,t,r){return a(this,void 0,void 0,function(){return S(this,function(A){return this.path(function(A,e){switch(e){case 0:return Ks(A.topLeftBorderBox,A.topLeftPaddingBox,A.topRightBorderBox,A.topRightPaddingBox);case 1:return Ks(A.topRightBorderBox,A.topRightPaddingBox,A.bottomRightBorderBox,A.bottomRightPaddingBox);case 2:return Ks(A.bottomRightBorderBox,A.bottomRightPaddingBox,A.bottomLeftBorderBox,A.bottomLeftPaddingBox);case 3:default:return Ks(A.bottomLeftBorderBox,A.bottomLeftPaddingBox,A.topLeftBorderBox,A.topLeftPaddingBox)}}(r,t)),this.ctx.fillStyle=te(e),this.ctx.fill(),[2]})})},Ds.prototype.renderNodeBackgroundAndBorders=function(c){return a(this,void 0,void 0,function(){var e,t,r,n,B,s,o,i,a=this;return S(this,function(A){switch(A.label){case 0:return this.applyEffects(c.effects,2),e=c.container.styles,t=!ee(e.backgroundColor)||e.backgroundImage.length,r=[{style:e.borderTopStyle,color:e.borderTopColor},{style:e.borderRightStyle,color:e.borderRightColor},{style:e.borderBottomStyle,color:e.borderBottomColor},{style:e.borderLeftStyle,color:e.borderLeftColor}],n=Ss(Ts(e.backgroundClip,0),c.curves),t||e.boxShadow.length?(this.ctx.save(),this.path(n),this.ctx.clip(),ee(e.backgroundColor)||(this.ctx.fillStyle=te(e.backgroundColor),this.ctx.fill()),[4,this.renderBackgroundImage(c.container)]):[3,2];case 1:A.sent(),this.ctx.restore(),e.boxShadow.slice(0).reverse().forEach(function(A){a.ctx.save();var e=Qs(c.curves),t=A.inset?0:1e4,r=function(A,t,r,n,B){return A.map(function(A,e){switch(e){case 0:return A.add(t,r);case 1:return A.add(t+n,r);case 2:return A.add(t+n,r+B);case 3:return A.add(t,r+B)}return A})}(e,-t+(A.inset?1:-1)*A.spread.number,(A.inset?1:-1)*A.spread.number,A.spread.number*(A.inset?-2:2),A.spread.number*(A.inset?-2:2));A.inset?(a.path(e),a.ctx.clip(),a.mask(r)):(a.mask(e),a.ctx.clip(),a.path(r)),a.ctx.shadowOffsetX=A.offsetX.number+t,a.ctx.shadowOffsetY=A.offsetY.number,a.ctx.shadowColor=te(A.color),a.ctx.shadowBlur=A.blur.number,a.ctx.fillStyle=A.inset?te(A.color):"rgba(0,0,0,1)",a.ctx.fill(),a.ctx.restore()}),A.label=2;case 2:s=B=0,o=r,A.label=3;case 3:return s<o.length?(i=o[s]).style===ht.NONE||ee(i.color)?[3,5]:[4,this.renderBorder(i.color,B,c.curves)]:[3,7];case 4:A.sent(),A.label=5;case 5:B++,A.label=6;case 6:return s++,[3,3];case 7:return[2]}})})},Ds.prototype.render=function(t){return a(this,void 0,void 0,function(){var e;return S(this,function(A){switch(A.label){case 0:return this.options.backgroundColor&&(this.ctx.fillStyle=te(this.options.backgroundColor),this.ctx.fillRect(this.options.x-this.options.scrollX,this.options.y-this.options.scrollY,this.options.width,this.options.height)),e=function(A){var e=new gs(A,[]),t=new Cs(e),r=[];return ps(e,t,t,r),Ns(e.container,r),t}(t),[4,this.renderStack(e)];case 1:return A.sent(),this.applyEffects([],2),[2,this.canvas]}})})},Ds);function Ds(A){this._activeEffects=[],this.canvas=A.canvas?A.canvas:document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),(this.options=A).canvas||(this.canvas.width=Math.floor(A.width*A.scale),this.canvas.height=Math.floor(A.height*A.scale),this.canvas.style.width=A.width+"px",this.canvas.style.height=A.height+"px"),this.fontMetrics=new Ls(document),this.ctx.scale(this.options.scale,this.options.scale),this.ctx.translate(-A.x+A.scrollX,-A.y+A.scrollY),this.ctx.textBaseline="bottom",this._activeEffects=[],De.getInstance(A.id).debug("Canvas renderer initialized ("+A.width+"x"+A.height+" at "+A.x+","+A.y+") with scale "+A.scale)}var bs=function(A){return A instanceof jn||(A instanceof Yn||A instanceof Gn&&A.type!==zn&&A.type!==Vn)},Ss=function(A,e){switch(A){case Ee.BORDER_BOX:return Qs(e);case Ee.CONTENT_BOX:return function(A){return[A.topLeftContentBox,A.topRightContentBox,A.bottomRightContentBox,A.bottomLeftContentBox]}(e);case Ee.PADDING_BOX:default:return ws(e)}},Ms=function(A){switch(A){case Cr.CENTER:return"center";case Cr.RIGHT:return"right";case Cr.LEFT:default:return"left"}},ys=(_s.prototype.render=function(r){return a(this,void 0,void 0,function(){var e,t;return S(this,function(A){switch(A.label){case 0:return e=Le(Math.max(this.options.windowWidth,this.options.width)*this.options.scale,Math.max(this.options.windowHeight,this.options.height)*this.options.scale,this.options.scrollX*this.options.scale,this.options.scrollY*this.options.scale,r),[4,xs(e)];case 1:return t=A.sent(),this.options.backgroundColor&&(this.ctx.fillStyle=te(this.options.backgroundColor),this.ctx.fillRect(0,0,this.options.width*this.options.scale,this.options.height*this.options.scale)),this.ctx.drawImage(t,-this.options.x*this.options.scale,-this.options.y*this.options.scale),[2,this.canvas]}})})},_s);function _s(A){this.canvas=A.canvas?A.canvas:document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.options=A,this.canvas.width=Math.floor(A.width*A.scale),this.canvas.height=Math.floor(A.height*A.scale),this.canvas.style.width=A.width+"px",this.canvas.style.height=A.height+"px",this.ctx.scale(this.options.scale,this.options.scale),this.ctx.translate(-A.x+A.scrollX,-A.y+A.scrollY),De.getInstance(A.id).debug("EXPERIMENTAL ForeignObject renderer initialized ("+A.width+"x"+A.height+" at "+A.x+","+A.y+") with scale "+A.scale)}function Ps(A){return we(_A.create(A).parseComponentValue())}var xs=function(r){return new Promise(function(A,e){var t=new Image;t.onload=function(){A(t)},t.onerror=e,t.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent((new XMLSerializer).serializeToString(r))})};"undefined"!=typeof window&&Se.setContext(window);var Vs=function(p,N){return a(void 0,void 0,void 0,function(){var e,t,r,n,B,s,o,i,a,c,Q,w,u,U,l,C,g,E,F,h,H,d,f;return S(this,function(A){switch(A.label){case 0:if(!(e=p.ownerDocument))throw new Error("Element is not attached to a Document");if(!(t=e.defaultView))throw new Error("Document is not attached to a Window");return r=(Math.round(1e3*Math.random())+Date.now()).toString(16),n=EB(p)||function(A){return"HTML"===A.tagName}(p)?function(A){var e=A.body,t=A.documentElement;if(!e||!t)throw new Error("Unable to get document size");var r=Math.max(Math.max(e.scrollWidth,t.scrollWidth),Math.max(e.offsetWidth,t.offsetWidth),Math.max(e.clientWidth,t.clientWidth)),n=Math.max(Math.max(e.scrollHeight,t.scrollHeight),Math.max(e.offsetHeight,t.offsetHeight),Math.max(e.clientHeight,t.clientHeight));return new I(0,0,r,n)}(e):T(p),B=n.width,s=n.height,o=n.left,i=n.top,a=K({},{allowTaint:!1,imageTimeout:15e3,proxy:void 0,useCORS:!1},N),c={backgroundColor:"#ffffff",cache:N.cache?N.cache:Se.create(r,a),logging:!0,removeContainer:!0,foreignObjectRendering:!1,scale:t.devicePixelRatio||1,windowWidth:t.innerWidth,windowHeight:t.innerHeight,scrollX:t.pageXOffset,scrollY:t.pageYOffset,x:o,y:i,width:Math.ceil(B),height:Math.ceil(s),id:r},Q=K({},c,a,N),w=new I(Q.scrollX,Q.scrollY,Q.windowWidth,Q.windowHeight),De.create({id:r,enabled:Q.logging}),De.getInstance(r).debug("Starting document clone"),u=new PB(p,{id:r,onclone:Q.onclone,ignoreElements:Q.ignoreElements,inlineImages:Q.foreignObjectRendering,copyStyles:Q.foreignObjectRendering}),(U=u.clonedReferenceElement)?[4,u.toIFrame(e,w)]:[2,Promise.reject("Unable to find element in cloned iframe")];case 1:return l=A.sent(),C=e.documentElement?Ps(getComputedStyle(e.documentElement).backgroundColor):He.TRANSPARENT,g=e.body?Ps(getComputedStyle(e.body).backgroundColor):He.TRANSPARENT,E=N.backgroundColor,F="string"==typeof E?Ps(E):null===E?He.TRANSPARENT:4294967295,h=p===e.documentElement?ee(C)?ee(g)?F:g:C:F,H={id:r,cache:Q.cache,canvas:Q.canvas,backgroundColor:h,scale:Q.scale,x:Q.x,y:Q.y,scrollX:Q.scrollX,scrollY:Q.scrollY,width:Q.width,height:Q.height,windowWidth:Q.windowWidth,windowHeight:Q.windowHeight},Q.foreignObjectRendering?(De.getInstance(r).debug("Document cloned, using foreign object rendering"),[4,new ys(H).render(U)]):[3,3];case 2:return d=A.sent(),[3,5];case 3:return De.getInstance(r).debug("Document cloned, using computed rendering"),Se.attachInstance(Q.cache),De.getInstance(r).debug("Starting DOM parsing"),f=iB(U),Se.detachInstance(),h===f.styles.backgroundColor&&(f.styles.backgroundColor=He.TRANSPARENT),De.getInstance(r).debug("Starting renderer"),[4,new Os(H).render(f)];case 4:d=A.sent(),A.label=5;case 5:return!0===Q.removeContainer&&(PB.destroy(l)||De.getInstance(r).error("Cannot detach cloned iframe as it is not in the DOM anymore")),De.getInstance(r).debug("Finished rendering"),De.destroy(r),Se.destroy(r),[2,d]}})})};return function(A,e){return void 0===e&&(e={}),Vs(A,e)}});!function(){var e=function(){return function e(t,n,r){function o(s,i){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!i&&u)return u(s,!0);if(a)return a(s,!0);var p=new Error("Cannot find module '"+s+"'");throw p.code="MODULE_NOT_FOUND",p}var h=n[s]={exports:{}};t[s][0].call(h.exports,function(e){var n=t[s][1][e];return o(n||e)},h,h.exports,e,t,n,r)}return n[s].exports}for(var a="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(e,t,n){function r(e){return e+(97<=e&&e<=122?-32:65<=e&&e<=90?32:0)}function o(){return!this.randInt(0,1)}function a(e){return e instanceof h?e.index(this.randInt(0,e.length-1)):e[this.randInt(0,e.length-1)]}function s(e){if(e.type===p.types.CHAR)return new h(e.value);if(e.type===p.types.RANGE)return new h(e.from,e.to);for(var t=new h,n=0;n<e.set.length;n++){var o=s.call(this,e.set[n]);if(t.add(o),this.ignoreCase)for(var a=0;a<o.length;a++){var i=o.index(a),u=r(i);i!==u&&t.add(u)}}return e.not?this.defaultRange.clone().subtract(t):t}function i(e,t){"number"==typeof t.max&&(e.max=t.max),t.defaultRange instanceof h&&(e.defaultRange=t.defaultRange),"function"==typeof t.randInt&&(e.randInt=t.randInt)}function u(e,t){var n,i,p,h,c;switch(e.type){case l.ROOT:case l.GROUP:if(e.followedBy||e.notFollowedBy)return"";for(e.remember&&void 0===e.groupNumber&&(e.groupNumber=t.push(null)-1),i="",h=0,c=(n=e.options?a.call(this,e.options):e.stack).length;h<c;h++)i+=u.call(this,n[h],t);return e.remember&&(t[e.groupNumber]=i),i;case l.POSITION:return"";case l.SET:var f=s.call(this,e);return f.length?String.fromCharCode(a.call(this,f)):"";case l.REPETITION:for(p=this.randInt(e.min,e.max===1/0?e.min+this.max:e.max),i="",h=0;h<p;h++)i+=u.call(this,e.value,t);return i;case l.REFERENCE:return t[e.value-1]||"";case l.CHAR:var g=this.ignoreCase&&o.call(this)?r(e.value):e.value;return String.fromCharCode(g)}}var p=e("ret"),h=e("discontinuous-range"),l=p.types,c=t.exports=function(e,t){if(this.defaultRange=this.defaultRange.clone(),e instanceof RegExp)this.ignoreCase=e.ignoreCase,this.multiline=e.multiline,i(this,e),e=e.source;else{if("string"!=typeof e)throw new Error("Expected a regexp or string");this.ignoreCase=t&&-1!==t.indexOf("i"),this.multiline=t&&-1!==t.indexOf("m")}this.tokens=p(e)};c.prototype.max=20,c.prototype.gen=function(){return u.call(this,this.tokens,[])},c.randexp=function(e,t){var n;return void 0===e._randexp?(n=new c(e,t),e._randexp=n):n=e._randexp,i(n,e),n.gen()},c.sugar=function(){RegExp.prototype.gen=function(){return c.randexp(this)}},c.prototype.defaultRange=new h(32,126),c.prototype.randInt=function(e,t){return e+Math.floor(Math.random()*(1+t-e))}},{"discontinuous-range":2,ret:3}],2:[function(e,t,n){function r(e,t){this.low=e,this.high=t,this.length=1+t-e}function o(e,t){if(!(this instanceof o))return new o(e,t);this.ranges=[],this.length=0,void 0!==e&&this.add(e,t)}function a(e){e.length=e.ranges.reduce(function(e,t){return e+t.length},0)}r.prototype.overlaps=function(e){return!(this.high<e.low||this.low>e.high)},r.prototype.touches=function(e){return!(this.high+1<e.low||this.low-1>e.high)},r.prototype.add=function(e){return this.touches(e)&&new r(Math.min(this.low,e.low),Math.max(this.high,e.high))},r.prototype.subtract=function(e){return!!this.overlaps(e)&&(e.low<=this.low&&e.high>=this.high?[]:e.low>this.low&&e.high<this.high?[new r(this.low,e.low-1),new r(e.high+1,this.high)]:e.low<=this.low?[new r(e.high+1,this.high)]:[new r(this.low,e.low-1)])},r.prototype.toString=function(){return this.low==this.high?this.low.toString():this.low+"-"+this.high},r.prototype.clone=function(){return new r(this.low,this.high)},o.prototype.add=function(e,t){function n(e){for(var t=[],n=0;n<s.ranges.length&&!e.touches(s.ranges[n]);)t.push(s.ranges[n].clone()),n++;for(;n<s.ranges.length&&e.touches(s.ranges[n]);)e=e.add(s.ranges[n]),n++;for(t.push(e);n<s.ranges.length;)t.push(s.ranges[n].clone()),n++;s.ranges=t,a(s)}var s=this;return e instanceof o?e.ranges.forEach(n):e instanceof r?n(e):(void 0===t&&(t=e),n(new r(e,t))),this},o.prototype.subtract=function(e,t){function n(e){for(var t=[],n=0;n<s.ranges.length&&!e.overlaps(s.ranges[n]);)t.push(s.ranges[n].clone()),n++;for(;n<s.ranges.length&&e.overlaps(s.ranges[n]);)t=t.concat(s.ranges[n].subtract(e)),n++;for(;n<s.ranges.length;)t.push(s.ranges[n].clone()),n++;s.ranges=t,a(s)}var s=this;return e instanceof o?e.ranges.forEach(n):e instanceof r?n(e):(void 0===t&&(t=e),n(new r(e,t))),this},o.prototype.index=function(e){for(var t=0;t<this.ranges.length&&this.ranges[t].length<=e;)e-=this.ranges[t].length,t++;return t>=this.ranges.length?null:this.ranges[t].low+e},o.prototype.toString=function(){return"[ "+this.ranges.join(", ")+" ]"},o.prototype.clone=function(){return new o(this)},t.exports=o},{}],3:[function(e,t,n){var r=e("./util"),o=e("./types"),a=e("./sets"),s=e("./positions");t.exports=function(e){var t,n,i=0,u={type:o.ROOT,stack:[]},p=u,h=u.stack,l=[],c=function(t){r.error(e,"Nothing to repeat at column "+(t-1))},f=r.strToChars(e);for(t=f.length;i<t;)switch(n=f[i++]){case"\\":switch(n=f[i++]){case"b":h.push(s.wordBoundary());break;case"B":h.push(s.nonWordBoundary());break;case"w":h.push(a.words());break;case"W":h.push(a.notWords());break;case"d":h.push(a.ints());break;case"D":h.push(a.notInts());break;case"s":h.push(a.whitespace());break;case"S":h.push(a.notWhitespace());break;default:/\d/.test(n)?h.push({type:o.REFERENCE,value:parseInt(n,10)}):h.push({type:o.CHAR,value:n.charCodeAt(0)})}break;case"^":h.push(s.begin());break;case"$":h.push(s.end());break;case"[":var g;"^"===f[i]?(g=!0,i++):g=!1;var y=r.tokenizeClass(f.slice(i),e);i+=y[1],h.push({type:o.SET,set:y[0],not:g});break;case".":h.push(a.anyChar());break;case"(":var d={type:o.GROUP,stack:[],remember:!0};"?"===(n=f[i])&&(n=f[i+1],i+=2,"="===n?d.followedBy=!0:"!"===n?d.notFollowedBy=!0:":"!==n&&r.error(e,"Invalid group, character '"+n+"' after '?' at column "+(i-1)),d.remember=!1),h.push(d),l.push(p),p=d,h=d.stack;break;case")":0===l.length&&r.error(e,"Unmatched ) at column "+(i-1)),h=(p=l.pop()).options?p.options[p.options.length-1]:p.stack;break;case"|":p.options||(p.options=[p.stack],delete p.stack);var v=[];p.options.push(v),h=v;break;case"{":var R,C,w=/^(\d+)(,(\d+)?)?\}/.exec(f.slice(i));null!==w?(0===h.length&&c(i),R=parseInt(w[1],10),C=w[2]?w[3]?parseInt(w[3],10):1/0:R,i+=w[0].length,h.push({type:o.REPETITION,min:R,max:C,value:h.pop()})):h.push({type:o.CHAR,value:123});break;case"?":0===h.length&&c(i),h.push({type:o.REPETITION,min:0,max:1,value:h.pop()});break;case"+":0===h.length&&c(i),h.push({type:o.REPETITION,min:1,max:1/0,value:h.pop()});break;case"*":0===h.length&&c(i),h.push({type:o.REPETITION,min:0,max:1/0,value:h.pop()});break;default:h.push({type:o.CHAR,value:n.charCodeAt(0)})}return 0!==l.length&&r.error(e,"Unterminated group"),u},t.exports.types=o},{"./positions":4,"./sets":5,"./types":6,"./util":7}],4:[function(e,t,n){var r=e("./types");n.wordBoundary=function(){return{type:r.POSITION,value:"b"}},n.nonWordBoundary=function(){return{type:r.POSITION,value:"B"}},n.begin=function(){return{type:r.POSITION,value:"^"}},n.end=function(){return{type:r.POSITION,value:"$"}}},{"./types":6}],5:[function(e,t,n){var r=e("./types"),o=function(){return[{type:r.RANGE,from:48,to:57}]},a=function(){return[{type:r.CHAR,value:95},{type:r.RANGE,from:97,to:122},{type:r.RANGE,from:65,to:90}].concat(o())},s=function(){return[{type:r.CHAR,value:9},{type:r.CHAR,value:10},{type:r.CHAR,value:11},{type:r.CHAR,value:12},{type:r.CHAR,value:13},{type:r.CHAR,value:32},{type:r.CHAR,value:160},{type:r.CHAR,value:5760},{type:r.CHAR,value:6158},{type:r.CHAR,value:8192},{type:r.CHAR,value:8193},{type:r.CHAR,value:8194},{type:r.CHAR,value:8195},{type:r.CHAR,value:8196},{type:r.CHAR,value:8197},{type:r.CHAR,value:8198},{type:r.CHAR,value:8199},{type:r.CHAR,value:8200},{type:r.CHAR,value:8201},{type:r.CHAR,value:8202},{type:r.CHAR,value:8232},{type:r.CHAR,value:8233},{type:r.CHAR,value:8239},{type:r.CHAR,value:8287},{type:r.CHAR,value:12288},{type:r.CHAR,value:65279}]},i=function(){return[{type:r.CHAR,value:10},{type:r.CHAR,value:13},{type:r.CHAR,value:8232},{type:r.CHAR,value:8233}]};n.words=function(){return{type:r.SET,set:a(),not:!1}},n.notWords=function(){return{type:r.SET,set:a(),not:!0}},n.ints=function(){return{type:r.SET,set:o(),not:!1}},n.notInts=function(){return{type:r.SET,set:o(),not:!0}},n.whitespace=function(){return{type:r.SET,set:s(),not:!1}},n.notWhitespace=function(){return{type:r.SET,set:s(),not:!0}},n.anyChar=function(){return{type:r.SET,set:i(),not:!0}}},{"./types":6}],6:[function(e,t,n){t.exports={ROOT:0,GROUP:1,POSITION:2,SET:3,RANGE:4,REPETITION:5,REFERENCE:6,CHAR:7}},{}],7:[function(e,t,n){var r=e("./types"),o=e("./sets"),a={0:0,t:9,n:10,v:11,f:12,r:13};n.strToChars=function(e){var t=/(\[\\b\])|(\\)?\\(?:u([A-F0-9]{4})|x([A-F0-9]{2})|(0?[0-7]{2})|c([@A-Z\[\\\]\^?])|([0tnvfr]))/g;return e=e.replace(t,function(e,t,n,r,o,s,i,u){if(n)return e;var p=t?8:r?parseInt(r,16):o?parseInt(o,16):s?parseInt(s,8):i?"@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^ ?".indexOf(i):a[u],h=String.fromCharCode(p);return/[\[\]{}\^$.|?*+()]/.test(h)&&(h="\\"+h),h})},n.tokenizeClass=function(e,t){for(var a,s,i=[],u=/\\(?:(w)|(d)|(s)|(W)|(D)|(S))|((?:(?:\\)(.)|([^\]\\]))-(?:\\)?([^\]]))|(\])|(?:\\)?(.)/g;null!=(a=u.exec(e));)if(a[1])i.push(o.words());else if(a[2])i.push(o.ints());else if(a[3])i.push(o.whitespace());else if(a[4])i.push(o.notWords());else if(a[5])i.push(o.notInts());else if(a[6])i.push(o.notWhitespace());else if(a[7])i.push({type:r.RANGE,from:(a[8]||a[9]).charCodeAt(0),to:a[10].charCodeAt(0)});else{if(!(s=a[12]))return[i,u.lastIndex];i.push({type:r.CHAR,value:s.charCodeAt(0)})}n.error(t,"Unterminated character class")},n.error=function(e,t){throw new SyntaxError("Invalid regular expression: /"+e+"/: "+t)}},{"./sets":5,"./types":6}]},{},[1])}()(1);"function"==typeof define&&"object"==typeof define.amd?define("RandExp",function(){return e}):"undefined"!=typeof window&&(window.RandExp=e)}();//bz-ignore
window._Util={
  _attrRegex:/\[(.+)\=('|)(\$label|\$header)('|)\]/,
  _bzJQFun:/\:(near|input|data|panel|Contains|textElement|after|before|endContains|contains|endEqual|equal|RowCol|rowcol|text)\((\$label|\$header)\)/,
  _allLetterAndNumber:/[\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC]+/,
  _allPrintableChr:/[\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC !"#$%&'()*+,.\/:;<=>?@\[\] ^_`{|}~-]+/,
  _allSign:/[^\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC]+/,
  _jsNameRegex:/[\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC\_\$]/,
  _jsData:/([\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC\_\$]+|\.|\[\"|\[\'|\'\]|\"\])+/g,
  _matchAllLetterAndNumber:/[\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC]+/g,
  _matchAllSign:/[^\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC]+/g,
  _trimSign:/(^[^\(\[\{\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC]+|[^\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC\)\]\}]+$)/g,
  _dataRegex:/(((\$(project|module|test|loop|data|group|action|parameter)((\.|\[|$)([a-zA-Z0-9\u4E00-\u9FCC_\$\'\"\(\)]+[\.|\[|\]]*)*)*|(\'|\").*(\'|\"))+( *(\+|\-|\*|\/) *)*)+)/g,
  _eval:function(v,_map){
    if(_eval._isBzData(v)||bzTwComm._isExtension()){
      return _eval._exeCode(v,_map)
    }else{
      try{
        _map=_map||{}
        let ks=Object.keys(_map)
        for(let i=0;i<ks.length;i++){
            let k=ks[i]
            eval("var "+k+"=_map."+k)
        }
    
        return eval(v)
      }catch(ex){
        if(ex.message.includes("unsafe-eval")){
          console.log("BZ-LOG: "+v)
          return _eval._exeCode(v,_map);
        }
        throw ex;
      }
    }
  },
  _getColorByName:function(v){
    while(v.length<6){
      v+=v
    }
    let c="#"
    for(let i=0;i<6;i++){
      c+=(v.charCodeAt(i)%10)
    }
    return c
  },
  _getBrowserTime:function(){
    return performance.now()
  },
  _animateDownUp:function(b){
    if(!b){
      return
    }
    let p=b.style.position,t=b.style.top;

    b.style.position="relative";
    $(b).animate({top: "10px"});
    BZ._setTimeout(()=>{
      $(b).animate({top: 0});
    },200)
  },
  _isAPISucessStatus:function(v){
    return v!="0"&&v&&v<400
  },
  _toRegExp:function(v){
    try{
      if(_ideDataManagement._isRegexData(v)){
        v=eval(v)
      }
      if(v&&v.constructor==RegExp){
        return v
      }
    }catch(ex){}
  },
  _isXMLData:function(v){
    return v&&v.constructor==String&&v.trim().match(/^<([^ ]+).+<([^>]+)>$/s);
  },
  _parseToExeCode:function(d,_toFunOnly){
    d=(d||"").trim()
    if(_Util._isFunction(d)){
      if(d.match(/\)$/)){
        return d
      }
    }else{
      d=d.split("\n")
      if(d.length==1){
        d=`()=>{\n  return ${d[0]}\n}`
      }else{
        d=`()=>{\n${d.map(x=>"  "+x).join("\n")}\n}`
      }
    }

    if(!_toFunOnly){
      d=`(${d})()`
    }
    return d
  },
  _isFileData:function(v){
    try{
      if(v && v.constructor==String&&v.includes("base64Link")){
        v=_Util._eval("v="+v);
        v=v[0]
      }
      return v.base64Link
    }catch(e){}
  },
  _isRegexData:function(s){
    if(s && s.constructor==String){
      return !!s.match(/^[\/](.+)[\/][igs]*$/)
    }
  },
  _joinMessage:function(a){
    a=[...a]
    a=a.filter(x=>x)
    let v=a.pop()
    a=a.join(", ")
    if(a){
      return _Util._formatMessage(_bzMessage._common._andMessage,[a,v])
    }
    return v
  },
  _log:function(){
    let ps=[]
    for(var i=0;i<arguments.length;i++){
      let v=arguments[i]
      if([Object,Array].includes(v.constructor)){
        v=JSON.stringify(v,0,2)
      }
      ps.push(v+"")
    }
    let p=ps.shift()
    if(p.match(/\{[0-9]\}/)){
      p=_Util._formatMessage(p,ps)
    }else{
      ps.unshift(p)
      p=ps.join("\n")
    }
    if(!bzTwComm._isIDE()){
      bzTwComm._postToIDE({_scope:"_Util",_fun:"_log",_args:[p]});
      return p
    }
    if(p.startsWith("video-img:")){
      if(!BZ._isPlaying()){
        return
      }
    }else if(p.includes("miss-element-screenshot-md5")){
      _ideTask._setLastScreenshotMd5(p.split(":")[1].trim())
    }
    console.log("BZ-LOG: "+p)
    if(p&&p.length>1000&&BZ._isAutoRunning()){
      console.clear()
    }
    return p
  },
  _getElementSimplePath:function(o){
    let os=document.getElementsByTagName(o.tagName)
    for(var i=0;i<os.length;i++){
      if(os[i]==o){
        return ["BZ.TW.document",o.tagName,i]
      }
    }
  },
  _highlightKeywordsInHTML:function(w,k,_match){
    k=(k||"").trim()
    if(!k){
      return "<div></div>"
    }

    if(_match){
      let g=_Util._eval(_match._regex+"g"),
      s=_Util._eval(_match._regex)
      w=w.split("\n")
      w=w.map(x=>{
        let xx=x.match(g)
        x=x.replace(g,"\n").split("\n")
        return x.map((z,i)=>{
          let n=0
          if(!i){
            n=1
          }else if(x[i+1]){
            n=2
          }
          z=_Util._getStringBySize(z,30,n);
          if(xx[i]){
            let vs=xx[i].match(s)
            return z+xx[i].replace(vs[_match._idx],`<span class='bz-search-word'>${vs[_match._idx]}</span>`)
          }else{
            return z
          }
        }).join("")
      }).join("\n")
    }else{
      var fw=w.toLowerCase(),
          fd=k.toLowerCase().split(" ")
      let ws=[{w:w,fw:fw}]

      fd.forEach(y=>{
        let x=ws[ws.length-1]
        let ww=x.fw.indexOf(y)
        if(ww>=0){
          let nw=x.w.substring(ww+y.length)
          let nfw=x.fw.substring(ww+y.length)
          x.w=x.w.substring(0,ww)
          x.fw=x.fw.substring(0,ww)
          ws.push({k:y})
          ws.push({w:nw,fw:nfw})
        }
      })

      w=ws.map((x,i)=>{
        if(x.w){
          if(!i){
            i=1
          }else if(ws[i+1]){
            i=2
          }else{
            i=0
          }
          return _Util._getStringBySize(x.w,30,i)
        }else if(x.k){
          return `<span class="bz-search-word">${x.k}</span>`
        }
      }).join("")
    }
    return `<div>${w}</div>`
  },
  _waitElement:function(e,_fun){
    if($(e)[0]){
      return _fun($(e)[0])
    }
    setTimeout(()=>{
      _Util._waitElement(e,_fun)
    },100)
  },
  _findLabel:function(f,v,_removeSign){
    let o=_cssHandler._findNodeByTxt(f,v,_removeSign);

    let os=$(f).find(":hidden").toArray()
    os.forEach(x=>{
      x=_cssHandler._findNodeByTxt(x,v,_removeSign);
      if(x.length){
        o.push(...x)
      }
    })

    if(o.length>1){
      o.sort((a,b)=>{
        return a.w.length-b.w.length
      })
      if(o[1].w.length>o[0].w.length){
        return [o[0]]
      }
      let oo=o.filter(x=>{
        if(x.e.tagName=="LABEL"){
          return 1
        }else if(x.e.parentElement&&x.e.parentElement.tagName=="LABEL"){
          let p=x.e.parentElement
          if(p.children.length>1){
            for(let n of p.children){
              if(n!=x.e){
                if(_cssHandler._lookLikeInput(x.e,n)){
                  x.ks.push(n)
                }
              }
            }
          }
          x.e=p
          return 1
        }
      });
      if(oo.length){
        o=oo
      }
    }
    if(o.length>1&&!v.includes("|")){
      o.sort((a,b)=>a.w.length-b.w.length)
      o=o.filter(x=>x.w.length==o[0].w.length)
    }
    
    o.forEach(x=>{
      while(x.e.tagName!="LABEL"&&x.e.parentElement.children.length==1&&!x.ks.length){
        x.e=x.e.parentElement
      }
    })
    
    return o
  },
  _afterAppReady:function(_fun,_chkElement){
    if(!document.body.innerText){
      return setTimeout(()=>{
        _Util._afterAppReady(_fun)
      },100)
    }
    if($.isNumeric(_domActionTask._getLoadingFun())){
      return setTimeout(()=>{
        _Util._afterAppReady(_fun)
      },10)
    }
    _domActionTask._isLoading(function(){
      _chk(_chkElement,0)
    })
    function _chk(e,i){
      if(e&&!$util.findDom(e)){
        if(i>20){
          _fun()
        }else{
          setTimeout(()=>{
            _chk(e,i+1)
          },100)
        }
      }else{
        _fun()
      }
    }
  },
  _getInputValue:function(o){
    let v=o.value
    if(["INPUT","SELECT","TEXTAREA"].includes(o.tagName)){
      if(o.type=="radio"){
        v=$("input[name="+o.name+"]").val()
      }else if(o.type=="checkbox"){
        v=o.checked
      }
    }else{
      v=$util.getElementText(o)
    }
    return v
  },
  _getTargetElement:function(os){
    os=os.toArray?os.toArray():os;
    let i=1
    while(os.length>i){
      if($(os[i-1]).find(os[i])[0]){
        os.splice(i-1,1)
      }else{
        i++
      }
    }
    return os
  },
  _testPerformance:function(_fun){
    let t=Date.now()
    _fun()
    console.log(Date.now()-t)
  },
  _getDataKeyMap:function(d){
    let m={};
    for(let k in d){
      let kk=_Util._toCamelWords(_Util._toSingularWord(_Util._parseCamelWords(_Util._toCamelWords(k))))
      m[kk]=k
    }
    return m
  },
  _isInMenu:function(o,p){
    while(!$(o).find(p)[0]){
      if(["fixed","absolute"].includes($(o).css("position"))){
        return 1
      }
      o=o.parentElement
    }
  },
  _getDiffWords:function(w1,w2,_splitRegex,_inSensitive,_noIgnoreNumber){
    w1=_initWordds(w1)
    w2=_initWordds(w2)
    let ds=[],ws1=w1.length,ws2=w2.length
    _chkEnd(w1,w2)
    while(w1.length&&w2.length){
      let p1=w1.shift(),
          p2=w2.shift()
      if(p1!=p2){
        let i1=w1.indexOf(p2),
            i2=w2.indexOf(p1)
        if(i1==-1){
          ds.push(p2)
          if(i2==-1){
            ds.push(p1)
          }else{
            w1.unshift(p1)
          }
        }else if(i2==-1){
          ds.push(p1)
          w2.unshift(p2)
        }else if(w1.length-i1>w2.length-i2){
          w2.unshift(p2)
          ds.push(p1)
        }else if(w1.length-i1<w2.length-i2){
          w1.unshift(p1)
          ds.push(p2)
        }else if(w1.length>w2.length){
          ds.push(p1)
          w2.unshift(p2)
        }else if(w1.length<w2.length){
          ds.push(p2)
          w1.unshift(p1)
        }else{
          ds.push(p1,p2)
        }
      }
    }
    ds.push(...w1)
    ds.push(...w2)
    return {ds:ds,p1:ds.length/ws1,p2:ds.length/ws2}
    
    function _chkEnd(_pop){
      while(w1.length&&w2.length){
        let p1=w1.pop(),
            p2=w2.pop()
        if(p1!=p2){
          w1.push(p1)
          w2.push(p2)
          return
        }
      }
    }
    
    function _initWordds(w){
      if(_inSensitive){
        w=w.toLowerCase()
      }
      if(!_noIgnoreNumber){
        w=w.replace(/[0-9]/g,"")
      }
      w=w.replace(_splitRegex||/ +/g," ").split(" ").filter(x=>x)
      return w
    }
  },
  _isSameElement:function(a,b,_simple){
    if(a==b){
      return 1
    }else if(!_Util._isHidden(a)&&!_Util._isHidden(b)){
      return
    }
    if(a.tagName==b.tagName&&a.type==b.type&&a.innerText==b.innerText){
      if(a.parentElement&&b.parentElement&&!a.innerText){
        if(!_Util._isSameElement(a.parentElement,b.parentElement,_simple)){
          return
        }
      }
      if(_simple){
        return 1
      }
      let d=0,s=0;
      for(let k in a.attributes){
        let av=k.value,
            bv=b.attributes[k.name];
        if(av!=bv){
          if(av&&bv){
            av=av.replace(/[0-9 ]/g,"")
            bv=bv.replace(/[0-9 ]/g,"")
            if(av!=bv){
              d++
              continue
            }
          }else if(k.name!="value"){
            d++
            continue
          }
        }
        s++
      }
      return d==0||s>d
    }
  },
  _filterEndElementList:function(_list){
    let n=0
    for(let i=n+1;i<_list.length;i++){
      let io=_list[i],no=_list[n]
      if(io.tagName!=no.tagName){
        if($(io).find(no).length){
          _list.splice(i--,1)
        }else if($(no).find(io).length){
          _list.splice(n,1)
          i--
        }
      }
    }
  },
  _drawArrow:function(c,x1,y1,x2,y2,_headlen,z){
    _headlen=_headlen||10;
    z=z||1
    var _angle = Math.atan2(y2-y1,x2-x1);
    c.moveTo(x1,y1);
    c.lineTo(x2,y2);
    c.moveTo(x2-_headlen*Math.cos(_angle-Math.PI/6)*z,y2-_headlen*Math.sin(_angle-Math.PI/6)*z);
    c.lineTo(x2,y2);
    c.lineTo(x2-_headlen*Math.cos(_angle+Math.PI/6)*z,y2-_headlen*Math.sin(_angle+Math.PI/6)*z);
    c.stroke();
  },
  _showLargeImgOnMouseover:function(o){
    o._overTime=setTimeout(()=>{
      let s=o.style;
      if(o.clicked){
        o.clicked=0
        return
      }
      if(s.position!="absolute"){
        s.position="absolute";
        let r=o.getBoundingClientRect();
        if(r.right>window.innerWidth){
          s.right="10px"
        }else if(r.left>50){
          s.marginLeft="-40px";
        }

        let c=document.createElement("div")
        document.body.append(c)
        c.style="background-color: transparent;z-index: 2147483647;position: fixed;top: 0;left: 0;width: 100%;height: 100%;"
        c.onclick=function(){
          s.position=s.marginLeft=s.right="";
          c.remove();
          o.clicked=Date.now()
          setTimeout(()=>{
            o.clicked=0
          },500)
        }
      }
    },300)
  },
  _getListSum:function(_list){
    if(_list.length){
      return _list.reduce((a,b)=>a+b)
    }
    return 0
  },
  _getListAvg:function(_list){
    if(_list.length){
      return _list.reduce((a,b)=>a+b)/_list.length
    }
    return 0
  },
  _toSingularWord:function(w){
    w=w||""
    w=w.trim().plural().replace(/\s+/g," ").split(" ")
    return w.map(x=>x.plural(1)).join(" ")
  },
  _getPageRootNode:function(){
    let o=document.body.parentElement,os=[]
    for(let x of o.children){
      if(!_Util._isHidden(x)){
        os.push(x)
      }
    }
    return os
  },
  _getSysObj:function(k){
    let d=window
    let ks=k.split(".")
    ks.forEach(x=>{
      d=d[x]
    })

    return d
  },
  _setSysObj:function(k,v){
    let ks=k.split(".")
    k=ks.pop()
    let d=window
    if(ks[0]){
      if(!d[ks[0]]){
        return setTimeout(()=>{
          console.log("Delay set data")
          _Util._setSysObj(k,v)
        },100)
      }
    }
    ks.forEach(x=>{
      d=d[x]
    })
    d[k]=v
  },
  _assign:function(f,t,ks){
    for(let k in f){
      if(!ks||ks.includes(k)){
        t[k]=f[k]
      }
    }
    return t
  },
  _overwriteObj:function(c,n){
    $.extend(true,c,n);
    _cleanData(c,n)
    function _cleanData(c,n){
      for(let k in c){
        if(n[k]===undefined){
          delete c[k]
        }else if(n[k].constructor==Object){
          _cleanData(c[k],n[k])
        }
      }
    }
  },
  _getEllipsisText:function(d,s){
    if(d){
      s=s||100
      if([Array,Object].includes(d.constructor)){
        d=JSON.stringify(d)
      }
      if(d.length>s){
        d=d.substring(0,s)+" ..."
      }
    }
    return d
  },
  _toErgodicList:function(o){
    let _list=[],d={}
    if(_Util._isEmpty(o)){
      return _list[o]
    }
    for(let k in o){
      let vs=o[k],_tmpList=_list
      _list=[]
      if(!vs||vs.constructor!=Array){
        vs=[vs]
      }
      let _init=!_tmpList.length
      vs.forEach(x=>{
        if(_init){
          d={}
          d[k]=x
          _tmpList.push(d)
        }else{
          _tmpList.forEach(y=>{
            y[k]=x
          })
          _list=_list.concat(_tmpList)
          _tmpList=_Util._clone(_tmpList)
        }
      })
      if(_init){
        _list=_tmpList
      }
    }
    return _list
  },
  _getDataByPath:function(d,p){
    p=p.split(".")
    p.find(x=>{
      try{
        d=d[x]
      }catch(e){
        d=undefined
        return 1
      }
    })
    return d
  },
  _setDataByPath:function(d,p,v,_initOnly){
    p=p.split(".")
    while(p.length){
      let k=p.shift()
      if(p.length){
        if(d[k]===undefined){
          if($.isNumeric(p[0])){
            d[k]=[]
          }else{
            d[k]={}
          }
        }
        d=d[k]
      }else{
        if(_initOnly){
          if(d[k]===undefined){
            d[k]=v
          }
        }else{
          d[k]=v
          if(d.list){
            d.list.find((x,i)=>{
              if(x==v){
                d.list.splice(i,1)
                return 1
              }
            })
            d.list.unshift(v)
          }
        }
      }
    }
    p.find((x,i)=>{
      try{
        if(d[x]===undefined){
          
        }
        d=d[x]
      }catch(e){
        d=undefined
        return 1
      }
    })
    return d
  },
  _generateNewName:function(n){
    let nn=n.match(/(.+)\(?([0-9]+)\)?$/)
    if(nn){
      n=nn[1].replace(/\($/,"")
      nn=parseInt(nn[2])+1
    }else{
      nn=1
    }
    return n+"("+nn+")"
  },
  _getSameTextDom:function(os,w){
    if(os.length<2){
      return os
    }
    let vs=[],ws=[]
    w=w.replace(/\s+/g," ").toLowerCase().trim()
    os.forEach(x=>{
      ws.push(x.innerText.replace(/\s+/g," ").toLowerCase().trim())
    })
    ws.forEach((x,i)=>{
      if(x==w){
        vs.push(os[i])
      }
    })
    if(vs.length){
      return vs
    }
    
    ws.forEach((x,i)=>{
      if(x.includes(w)){
        vs.push(os[i])
      }
    })
    if(vs.length){
      return vs
    }
    return vs
  },
  _getCeilDom:function(_list){
    let os=[],_last
    while(_list.length){
      let o=_list.pop()
      if(_last){
        if(!$(o).find(_last)[0]){
          os.unshift(o)
        }
      }else{
        os.unshift(o)
      }
      _last=o
    }
    return os
  },
  _queryToObj:function(_url){
    if(_url){
      _url=_url.split("?")[1]
      if(_url){
        _url=_url.split("#")[0]
        if(_url){
          _url=_url.split("&")
          let v={}
          _url.forEach(x=>{
            x=x.split("=")
            if(x[1]){
              x[1]=decodeURIComponent(x[1])
            }
            v[x[0]]=x[1]
          })
          return v
        }
      }
    }
  },
  _randomList:function(ts){
    ts.forEach((x,i)=>{
      ts.splice(i,1)
      if(Math.random()>0.5){
        ts.unshift(x)
      }else{
        ts.push(x)
      }
    })
  },
  _isBlankIFrame:function(x){
    try{
      return x.contentWindow.location.href=="about:blank"||x.contentWindow.location.href==location.href
    }catch(e){}
  },
  //JSON style but include ref-data, like: $test.name ...
  _isSameMissJSON:function(v1,v2){
    v1=v1.replace(/ *\: */g,":")
    let s1=v1.match(/\:\"[^\"]+\"/g)
    let s2=v2.match(/\:\"[^\"]+\"/g)
    if(s1==s2){
    }else if(!s1||!s2){
      return
    }else{
      s1=s1.sort().join("\t")
      s2=s2.sort().join("\t")
      if(s1!=s2){
        return
      }
    }
    s1=v1.replace(/\:\"[^\"]+\"/g,":")
    s2=v2.replace(/\:\"[^\"]+\"/g,":")
    v1=s1
    v2=s2

    s1=v1.match(/[^\{\,]+\:/g)
    s2=v2.match(/[^\{\,]+\:/g)
    
    if(s1==s2){
    }else if(!s1||!s2){
      return
    }else{
      s1=s1.map(x=>{return x.trim().replace(/\"/g,"")}).sort().join("\t")
      s2=s2.map(x=>{return x.trim().replace(/\"/g,"")}).sort().join("\t")
      if(s1!=s2){
        return
      }
    }
    s1=v1.replace(/[^\{\,]+\:/g,"").replace(/[\{\}]/g,"").replace(/\s/g,"").split(",").sort().join(",")
    s2=v2.replace(/[^\{\,]+\:/g,"").replace(/[\{\}]/g,"").replace(/\s/g,"").split(",").sort().join(",")
    return s1==s2
  },
  //atob
  _b64DecodeUnicode:function(str) {
    // Going backwards: from bytestream, to percent-encoding, to original string.
    try{
      return atob(str)
    }catch(e){
      return decodeURIComponent(atob(str).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
    }
  },
  //btoa
  _b64EncodeUnicode:function (str) {
    // first we use encodeURIComponent to get percent-encoded UTF-8,
    // then we convert the percent encodings into raw bytes which
    // can be fed into btoa.
    try{
      return btoa(str)
    }catch(e){
      return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,
          function toSolidBytes(match, p1) {
              return String.fromCharCode('0x' + p1);
      }));
    }
  },
  _t36String:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
  _to36:function(v){
    let i=_Util._t36String.length
    let x=_Util._t36String[v%i]
    v=Math.round(v/i)||""
    if(v){
      v=_Util._to36(v)
    }
    return v+x
  },
  _t62String:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",
  _to62:function(v){
    let i=_Util._t62String.length
    let x=_Util._t62String[v%i]
    v=Math.round(v/i)||""
    if(v){
      v=_Util._to62(v)
    }
    return v+x
  },
  _formatJQSelection:function(v){
    if(v&&"#.".includes(v[0])){
      v=v[0]+v.substring(1).replace(/([^0-9a-z-_])/gi,"\\$1")
    }
    return v
  },
  //update css before/after 
  _updateCssContent:function(k,v){
    document.styleSheets[0]&&(document.styleSheets[0].addRule(k,v))
  },
  //For check _bzMessage data
  _getKeyList:function(d,p,w){
    w=w||[],p=p||""
    for(let k in d){
      w.push(k)
      if(d[k].constructor==Object){
        _getKeyList(d[k],p+"  ")
      }
    }
    return w
  },
  _getJSONErrorPosition:function(v,_startLine){
    v=v.split("\n")
    let w=[],_followKey;
    v.forEach((x,i)=>{
      x=x.trim()
      if(x.match(/^[\,\{\}\[\]]$/)){
        _followKey=0
        return
      }
      x=x.replace(/[\[ ]+$/,"")
      
      if(x.length>1&&!_followKey&&!x.endsWith(",")&&!x.endsWith("{")){
        if(!v[i+1]||!v[i+1].trim().match(/[\}\]]/)){
          _addErr(i)
          return
        }
      }

      x=x.replace(/[\, \{\[]+$/,"")

      if(x.endsWith(":")){
        _followKey=1
        x+="0"
      }
      if(x.endsWith("}")){
        if(x.length==1){
          if(_followKey){
            _addErr(i-1)
          }
          return
        }else if(x[0]!="{"){
          x="{"+x
        }
      }else if(x.includes(":")){
        if(x[0]=="{"){
          x+="}"
        }else if(x[0]=="["){
          if(x.length>1){
            x+="}]"
          }
        }else{
          x="{"+x+"}"
        }
      }else if(_followKey){
        if(x.match(/^[\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC\_\$]+$/)&&$.isNumeric(x)){
          _addErr(i)
        }else if(_isErr(x)){
          _addErr(i)
        }
        return
      }
      if(_isErr(x)){
        _addErr(i)
      }
    })
    return w
    function _addErr(i){
      let vv=v[i]
      if(_startLine!==undefined){
        vv=_startLine+i+": "+vv
      }
      w.push(vv)
    }
    function _isErr(v){
      try{
        let x;
        x=_Util._eval("x="+v)
      }catch(ex){
        return 1
      }
    }
  },
  _flashElement:function(o,i){
    if(o){
      i=i||200
      $(o).fadeOut(i/2).fadeIn(i/2)
    }
  },
  _inSelectOption:function(v){
    return v.tagName=="OPTION"&& (v.parentElement.tagName=="SELECT"||(v.parentElement.parentElement&&v.parentElement.parentElement.tagName=="SELECT"))
  },
  _isIgnoreElement:function(v){
    return ["HTML","SCRIPT","LINK","HEAD","META","BASE","STYLE","BR","HR"].includes(v.tagName)||_Util._inSelectOption(v)
  },
  _isObjOrArray:function(v){
    return v&&[Array,Object].includes(v.constructor)
  },
  _handleRequestData:function(v){
    if(v&&[Object,Array].includes(v.constructor)){
      for(let k in v){
        if(v[k]=="bz-skip"){
          delete v[k]
        }else if(v[k]=="true"){
          v[k]=true
        }else if(v[k]=="false"){
          v[k]=false
        }else{
          _Util._handleRequestData(v[k])
        }
      }
    }
  },
  /*
  like: 
    s="lws ok"
    m=" "
    w="oo"
    result:"lwsoo ok"
  */
  _ajax:function(a,_proxy){
    a.async=!!a.async
    _Util._handleRequestData(a.data)
    let _jsonData
    $util.generateDataByRegex(a.query,0,(v)=>{
      a.query=v
      $util.generateDataByRegex(a.data,0,(v)=>{
        a.data=v
        if(_proxy){
          a={
            url:_proxy,
            method:"POST",
            headers:{
              "content-type":"application/json"
            },
            data:{
              method:a.method,
              url:a.url,
              data:a.data,
              headers:a.headers
            },
            complete:a.complete,
            async:a.async
          }
          return _doIt()
        }
        _doIt()
      })
    })
    
    function _doIt(){
      _jsonData=a.data
      if(Object.keys(a.headers||{}).find(x=>{
        if(x.toLowerCase()=="origin"){
          return 1
        }
      })){
        if(!BZ.TW||BZ.TW.closed){
          BZ._launchCurEnvUrl(_IDE._data._setting.curEnvironment,function(){
            _Util._originAJax(a,a.complete)
          })
        }else{
          _Util._originAJax(a,a.complete)
        }
        return
      }
      try{
        if(_jsonData){
          if(!a.contentType||a.contentType.toLowerCase().includes("json")){
            a.data=JSON.stringify(a.data)
          }else if(a.contentType.toLowerCase().includes("form")&&_Util._isJsonValueString(_jsonData)){
            _jsonData=_Util._strToJson(_jsonData)
            if(_jsonData.constructor==Object){
              _jsonData=a.data=_Util._objToAPIParameter(_jsonData)
            }
          }
        }
      }catch(ex){
        a.complete({message:ex.stack})
      }
      
      if(bzTwComm._isIDE()){
        XMLHttpRequest.prototype._XMLHttpRequestSend=XMLHttpRequest.prototype.send
        XMLHttpRequest.prototype.send=function(v){
          a.data=v||a.data
          if(a.headers&&a.headers["Content-Type"]){
            delete a.contentType
          }
          this.abort()
          XMLHttpRequest.prototype.send=XMLHttpRequest.prototype._XMLHttpRequestSend
          delete XMLHttpRequest.prototype._XMLHttpRequestSend
          _callExtensionBackgroud()
        }
      }
      // if(a.contentType){
        // a.headers=a.headers||{}
        // a.headers["Content-Type"]=a.contentType
        // delete a.contentType
      // }
      $.ajax(a)
    }
    function _showInfo(_status,_msg){
      _msg=_msg||""
      if(_msg.constructor!=String){
        _msg=JSON.stringify(_msg,0,2)
      }
      _msg=_Util._formatMessage(_bzMessage._system._error._ajaxFailed,[
        _status,
        a.url,
        a.headers?JSON.stringify(a.headers,0,2):"",
        a.query?JSON.stringify(a.query,0,2):"",
        a.body?JSON.stringify(a.body,0,2):"",
        _msg])
      alert(_msg)
    }
    function _callExtensionBackgroud(){
      if(!a.url.match(/^http/)){
        a.url="http:"+a.url
      }

      _extensionComm._callBackground(function(r){
        let ad={}
        for(var k in a){
          if(!["async","cache"].includes(k)||(a[k]!==null&&a[k]!==undefined&&!a[k].constructor==Function)){
            ad[k]=a[k]
          }
        }
        r.request={
          data:_jsonData,
          method:a.method,
          url:a.url,
          headers:a.headers
        }

        if(r.status!="error"&&_Util._isAPISucessStatus(r.status)){
          r.responseText=r.data
          _toData(r.data,function(ro){
            if(ro){
              if(ro.constructor==Blob){
                r.data=ro
              }else if([Object,Array].includes(ro.constructor)){
                r.responseJSON=ro
              }
            }
            
            if(a.complete){
              a.complete(r)
            }else{
              a.success(r)
            }
          })
        }else{
          if(a.error){
            a.error(r)
          }else if(a.complete){
            a.complete(r)
          }
          if(!BZ._isAutoRunning()){
            _showInfo(r.status,r.message||r.data)
            BZ._data._uiSwitch._apiResultTab="_result"
          }
        }
      },"ajax",a)
    }
    
    function _toData(v,_fun){
      if(a.responseType){
        _fun(new Blob([v.constructor==String?_stringToBinaryArray(v):v]))
      }else{
        try{
          if(v&&"[{".includes(v.trim()[0])){
            v=JSON.parse(v)
          }
          _fun(v)
        }catch(e){}
      }
    }

    function _stringToBinaryArray(str) {
      var buf = new ArrayBuffer(str.length*1); // 2 bytes for each char
      var bufView = new Uint8Array(buf);
      for (var i=0, strLen=str.length; i < strLen; i++) {
        bufView[i] = str.charCodeAt(i);
      }
      return buf;
    }
  },
  _originAJax:function(d,_fun){
    if(bzTwComm._isIDE()){
      bzTwComm._postToIDE({_fun:"_originAJax",_scope:"_Util",_args:[d,_fun]});
      return
    }
    if(Object.keys(d.headers||{}).find(x=>{
      if(x.toLowerCase()=="origin"){
        if(d.headers[x].includes(location.host)){
          return 1
        }
      }
    })){
      let _jsonData=d.data
      d.request=_Util._clone(d)
      if(_jsonData){
        d.data=JSON.stringify(d.data)
      }
      d.complete=function(r){
        r.headers=d.headers
        r.request=d.request
        if(_jsonData){
          d.request.data=_jsonData
        }

        _fun(d)
      }
      $.ajax(d)
    }
  },
  _removeValueFromArray:function(a,v){
    while(1){
      let i=a.indexOf(v)
      if(i==-1){
        return
      }
      a.splice(i,1)
    }
  },
  _toggleArray:function(a,v){
    let i=a.indexOf(v)
    if(i>=0){
      a.splice(i,1)
    }else{
      a.push(v)
    }
  },
  _isSysButton:function(o){
    return o.tagName=="BUTTON"||(o.tagName=="INPUT"&&["submit","button","reset","image"].includes(o.type))
  },
  _getRandomSelection:function(p){
    let rv=_descAnalysis._retrieveTextForElementPathItem(p),ps=[],vv;
    if(rv.startsWith("/{random")){
      p.find(v=>{
        if(v.includes(rv)){
          vv=v
          return 1
        }
        ps.push(v)
      })
      if(ps.length){
        ps.push(0)
        ps=_Util._findDoms(ps)[0]
        if(ps){
          let e=rv.split(":")[1],f;
          if(e){
            e=e.split("|")
            f=e[0]
            e=e[1]
            if(e){
              e=e.substring(0,e.length-2).split(",")
            }else if(f){
              f=f.substring(0,f.length-2)
            }
          }
          if(!f){
            vv=vv.replace(rv,"")
            f=vv.replace(/(\:|\[)(near|input|data|text|panel|contains|Contains|textElement|after|before|endContains|endEqual|equal|RowCol|rowcol|name|title|placeholder)(\(|\"|\'|\=|)(\)|\"|\')?/,"")
            if(f==vv){
              f=vv.replace(/\:attr\([^=]+\=\)/,"")
            }
          }

          let pps=[]
          if(f&&f[0]=="!"){
            ps=$(ps).find("*").not(f.substring(1)).toArray()
          }else{
            ps=$(ps).find(f).toArray()
          }
          ps.forEach(x=>{
            let w=$util.getElementText(x)
            if(w&&(!e||!e.includes(w))){
              pps.push(x)
            }
          })

          let o=$util.randomItem(pps)
          if(o){
            p.find((v,i)=>{
              if(v.includes&&v.includes(rv)){
                p[i]=v.replace(rv,$util.getElementText(o.value))
                return
              }
            })
            return o.value
          }
          return
        }
      }
    }
  },
  //o: element
  //c: box css selector
  _getBox:function(o,c){
    c=$(c).toArray()
    return c.find(v=>{
      return $(v).find(o).length
    })
  },
  _csvToObj:function(c,_msg){
    c=c||""
    var rs=c.trim().split("\n");
    rs[0]=_Util._toSBC(rs[0])
    var cs=rs[0].split("\t");
    var _data=[];
    var _start=0;
    if(cs[0]=="_key"){
      _data={};
      _start=1;
    }
    cs=cs.map(k=>{
      return _toKeyName(k,1)
    })

    if (rs.length>1) {
      for(var i=1;i<rs.length;i++){
        var d={};
        
        if (!rs[i]&&rs.length==i+1&&!_Util._isEmpty(_data)) {
          continue;
        }
        var vs=rs[i].split("\t");
        if (_start) {
          vs[0]=_toKeyName(vs[0],1);
          if (!_data[vs[0]]) {
            _data[vs[0]]=d;
          }else{
            _Util._alertMessage(_Util._formatMessage(_bzMessage._system._error._switchCsvToObjError,[(_msg||"")+" row: '"+d[cs[ii]]+"'"]));
            return;
          }
        }else{
          _data.push(d);
        }
        for(var ii=_start;ii<cs.length;ii++){
          if (d[cs[ii]]!=undefined) {
            _Util._alertMessage(_Util._formatMessage(_bzMessage._system._error._switchCsvToObjError,[(_msg||"")+" column: '"+d[cs[ii]]+"'"]));
            return;
          }
          let v=vs[ii]
          if (v) {
            d[cs[ii]]=_parseValue(v);
          }else{
            d[cs[ii]]="";
          }
        }
      }
    }
    return _data;
    
    function _parseValue(v){
      try{
        if(v.match(/^[\{\[].+[\}\]]$/)){
          v=JSON.parse(v)
          return v
        }
      }catch(ex){}
      try{
        if(v.match(_Util._dataRegex)){
          v=_Util._eval("v="+v)
        }
      }catch(ex){}
      return v
    }
    function _toKeyName(v){
      v=v.replace(/[ \-\;\@\#\&\^\$]/g,"_")
      if($.isNumeric(v)){
        v="_"+v
      }
      v=v.replace(/_+/g,"_").replace(/_$/g,"")

      return v
    }
  },
  _stringToData:function(v,_bkData,_bkKey){
    if(!v||[Object,Array].includes(v.constructor)){
      return _return(v)
    }
    let n=parseFloat(v);
    if(n==v){
      return _return(n)
    }
    if(v.constructor==String&&v.includes("\t")){
      n=_Util._csvToObj(v)
    }else{
      try{
        if(v.constructor==Function){
          n=v()
        }else if(v.constructor==String&&v.trim().match(/^[\{\[].+[\}\]]$/s)){
          n=_Util._strToJson(v)
        }else{
          if(_Util._isFunction(v)){
            n=_Util._eval("n="+v)
          }else{
            let vv=v.trim().split("\n")
            while(vv.length&&!vv[vv.length-1].trim().replace(/;/g,"")){
              vv.pop()
            }
            if(!_Util._isEmpty(vv)){
              let vvv=vv[vv.length-1].trim()
              if(!vvv.match(/^(var|let|const) /)){
                vv[vv.length-1]="return "+vv[vv.length-1]
              }
              vv=vv.join("\n")
              n=_Util._eval("n=(()=>{\n"+vv+"\n})()")
            }
          }
        }
        if(n===undefined||n===null){
          return _return(n)
        }else if($.isNumeric(n)){
          if(v.includes(",")){
            v=v.split(",")
            if($.isNumeric(v[0])){
              //This is a number array
              n=v.map(a=>{return a.trim()})
            }
          }
        }else if(n.constructor==RegExp){
          if(v.includes("/,/")){
            n=v.split(",")
            n=n.map(a=>{return a.trim()})
          }
        }else if(n&&n.constructor==Function){
          n=n()
        }
      }catch(e){
        if(e.message.includes("debugger")&&v.includes("debugger")){
          v=v.replace(/debugger;?/,"").trim()
          if(!BZ._isAutoRunning()){
            alert(_bzMessage._task._debuggerError+v)
          }
          return _Util._stringToData(v,_bkData,_bkKey)
        }
        if(v&&v.constructor==String&&_Util._hasCode(v)){
          console.error(e.stack)
        }

        if(v.includes(",")){
          n=v.split(",")
          n=n.map(a=>{return a.trim()})
        }else{
          n=v
        }
      }
    }
    n=$util.generateDataByRegex(n,0,_return)
    if($.isNumeric(n)){
      n=parseFloat(n)
    }
    return n
    
    function _return(v){
      if($.isNumeric(v)){
        n=parseFloat(v)
      }
      if(_bkData){
        if(_bkData.constructor==Function){
          _bkData(v)
        }else if(_bkKey){
          _bkData[_bkKey]=v
        }
      }
      return v
    }
  },
  _stringToJSONString:function(v){
    v=_Util._stringToData(v)
    if(v&&v.constructor!=String){
      v=JSON.stringify(v,0,2)
    }
    return v
  },
  async _asyncTimeout(v) {
    return new Promise(_fun=> {
      setTimeout(()=>{
        _fun()
      },v)
    });
  },
  async _asyncFun(_fun,_time,_bkFun){
    while(1){
      if(_fun()){
        return _bkFun&&_bkFun()
      }
      await _Util._asyncTimeout(_time)
    }
  },
  _getMixDataLevel:function(v,i){
    i=i||0
    var dp=i,_max=0;
    if(v&&[Object,Array].includes(v.constructor)){
      for(var k in v){
        var pp=_Util._getMixDataLevel(v[k],i+1)
        if(pp>_max){
          _max=pp
        }
      }
      return _max
    }else{
      return i
    }
  },
  _hasDeepArray:function(d){
    if(d&&[Object,Array].includes(d.constructor)){
      for(var k in d){
        var v=d[k]
        if(v&&v.constructor==Array){
          return 1
        }else if(v&&v.constructor==Object){
          var vv=_Util._hasDeepArray(v)
          if(vv){
            return 1
          }
        }
      }
    }
  },
  _toFileCSV:function(s){
    return s.split("\n").map(w=>{
      w=w.trim().split("\t")
      return w.map(v=>{
        if(v.includes(",")){
          return '"'+v.replace(/\"/g,'""')+'"'
        }else{
          return v
        }
      }).join(",")
    }).join("\n")
  },
  _spliceAll:function(vs,_fun){
    let _found=[]
    for(var i=0;vs&&i<vs.length;i++){
      var o=_fun(vs[i],i)
      if(o){
        _found.push(vs[i])
        vs.splice(i--,1)
      }
    }
    return _found
  },
  _findInObj:function(o,_fun){
    if(o&&[Object,Array].includes(o.constructor)){
      for(var k in o){
        if(_fun(o[k],k)){
          return {_value:o[k],_key:k}
        }
      }
    }
  },
  _findDeepObj:function(o,_fun,_stop,pk,ps){
    ps=ps||[]
    for(var k in o){
      ps.push(o[k])
      if(_fun(o[k],k,pk,ps,o)){
        if(_stop){
          ps.pop()
          return o[k]
        }
      }else if(_Util._isObjOrArray(o[k])){
        let v=_Util._findDeepObj(o[k],_fun,_stop,k,ps)!==undefined
        if(v){
          if(_stop){
            ps.pop()
            return v
          }
        }
      }
      ps.pop()
    }
  },
  _loopObj:function(o,_fun){
    if(o&&[Object,Array].includes(o.constructor)){
      for(var k in o){
        _fun(o[k],k)
      }
    }
  },
  _findAll:function(vs,_fun){
    var os=[]
    vs.forEach((v,i)=>{
      if(_fun(v,i)){
        os.push(v)
      }
    })
    return os
  },
  _handlePrePanel:function(d){
    $(d).on("mousedown",".bz-pre-box",function(e){
      let p=e.target

      _Util._copyText(p.children[0]||p,this.ownerDocument)
    })
  },
  _loadTextFromFile:function(_file,_fun){
    let _reader = new FileReader();

    _reader.readAsText(_file);

    _reader.onload = function() {
      _fun(_reader.result)
    };

    _reader.onerror = function() {
      alert(_bzMessage._system._error._importFileError,_reader.error);
    };
  },
  _loadTextFromFiles:function(_files,_fun){
    let _reader = new FileReader(),
        rs=[];
    

    function _readFile(i) {
      if( i >= _files.length ) {
        return _fun(rs);
      }
      var _file = _files[i];
      _reader.onload = function(e) {  
        rs.push(e.target.result);
        _readFile(i+1)
      }
      _reader.readAsText(_file);
    }
    _readFile(0);

    _reader.onerror = function() {
      alert(_bzMessage._system._error._importFileError,_reader.error);
    };
  },
  _getZipFileContent:function(v,f){
    zip.createReader(new zip.BlobReader(v), function(zipReader) {
      zipReader.getEntries(function(_entries) {
        f(_entries)
			});
    }, function(a){alert(a)});
  },
  _extendViewDef:function(e,ex){
    var o=_Util._clone(e)
    for(var k in ex){
      if(k=="_jqext"){
        for(var kk in ex._jqext){
          o._jqext[kk]=ex._jqext[kk];
        }
      }else{
        o[k]=ex[k];
      }
    }
    return o;
  },
  // _insertTxtToEditor:function(o,w,_idx,_event){
  //   if($(o).hasClass("bz-js-editor")){
  //     return o._replaceSelectedText(o,w)
  //   }
  //   var start = o.selectionStart;
  //   var end = o.selectionEnd;
  //   _idx=_idx||w.length

  //   var $this = $(o);
  //   var value = $this.val();
    
  //   if(_idx<0){
  //     start+=_idx;
  //     _idx=w.length
  //   }

  //   $this.val(value.substring(0, start)+ w+ value.substring(end));

  //   o.selectionStart = o.selectionEnd = start + _idx;
  //   $(o).change();
  //   if(_event){
  //     _event.preventDefault()
  //   }
  //   if($(":focus")[0]!=o){
  //     $(o).focus();
  //   }
  // },
  _repeatLetter:function(w,i){
    let ws=""
    while(i--){
      ws+=w
    }
    return ws
  },
  _stringToObj:function(s){
    if(s&&s.constructor==String){
      try{
        s=_Util._eval("s="+s)
      }catch(e){}
    }
    return s
  },
  _getShareParent:function(o1,o2){
    if(o1.constructor==Array){
      return _getIn2(o1[0],o1[o1.length-1])
      let i1=parseInt((o1.length-1)/2)
    }else{
      return _getIn2(o1,o2)
    }
    
    function _getIn2(o1,o2){
      if($(o2).find(o1)[0]){
        return o2
      }
      while(o1.parentElement&&o1.tagName!="BODY"){
        if($(o1).find(o2).length||o1.tagName=="BODY"){
          return o1
        }
        o1=o1.parentElement
      }
    }
  },
  _getPathFromUrl:function(v){
    let h=_Util._retrieveHostFromUrl(v)
    if(h){
      v=v.replace(h,"")
    }
    v=v.replace(/^[\/]/,"").split(/[\?\#]/)[0].split("/")
    _Util._spliceAll(v,x=>{return !x})
    return v
  },
  _retrieveHostFromUrl:function(v){
    if(!v){
      return
    }

    v=v.url||v
    v=v.match(/^(https*|wss):\/\/[^\/]+/)
    return v&&v[0]
  },
  _formatStrAsJson:function(w){
    try{
      v=_Util._eval("v="+w)
      if(JSON.stringify(v)==w){
        return JSON.stringify(v,0,2)
      }
    }catch(e){}
    return w
  },
  _jsonToStr:function(s){
    if(s&&(s.constructor==Object||s.constructor==Array)){
      s=JSON.stringify(s,0,2)
    }else if(s&&$.isNumeric(s)){
      s=s+""
    }
    return s
  },
  _strToJson:function(s,_parameter){
    let $parameter=_parameter||window.$parameter
    if(s&&s.constructor==String&&(_Util._hasCode(s)||s.match(/^[\{\[].*[\]\}]$/s))){
      try{
        if(s.constructor==String){
          if(bzTwComm._isExtension()){
            s=JSON.parse(s)
          }else{
            s=_Util._eval("s="+s)
          }
          if(s&&s.constructor==RegExp){
            s=s.toString()
          }
        }
        if(s&&[Object,Array].includes(s.constructor)){
          _Util._findDeepObj(s,(v,k,ps,pk,o)=>{
            if(v&&v.constructor==String){
              o[k]=_JSHandler._prepareData(v,0,0,_parameter)
            }
          })
        }
      }catch(e){
        _domActionTask._doLog(e.message)
        s=_JSHandler._prepareData(s,0,0,_parameter)||s
      }
    }
    return s
  },
  _hasCode:function(v){
    return v&&v.match&&v.match(/\$(loop|parameter|parentModule|test|module|project|data|util|script|group|action)([^a-zA-Z0-9\u4E00-\u9FCC_\$]|$)/)
  },
  _hasInsertCode:function(v){
    return v&&v.match&&v.match(/\{\{[^\{]*\$(parameter|test|module|project|loop|parentModule|data|loop|util|script|control|group|action).*\}\}/)
  },
  _hasInsertCodeOnly:function(v){
    if(_Util._hasCode(v)){
      return !_Util._hasCode(v.replace(/\{\{[^\{]*\$(parameter|test|module|project|loop|parentModule|data|loop|util|script|control|group|action).*\}\}/g,""))
    }
  },
  _parseCode:function(s){
    let vs=[]
    s=s.match(/\{\{[^}]+\}\}/g)||[]
    s.forEach(c=>{
      c=c.match(/\$(loop|parameter|test|module|project|group|action)[.\[]?[a-zA-Z0-9\u4E00-\u9FCC_\$\.\[\]]*/g)||[]
      vs=vs.concat(c)
    })
    return [...new Set(vs)]
  },
  _formatObjectToFinalData:function(o,_parameter){
    if(o&&[Object,Array].includes(o.constructor)){
      for(var k in o){
        if([Array,Object].includes(o[k].constructor)){
          _Util._formatObjectToFinalData(o[k])
        }else{
          let v= _ideDataManagement._initRandomValue(_JSHandler._prepareData(o[k]))
          let kk=_JSHandler._prepareData(k,0,0,_parameter)
          if(kk!=k&&kk){
            delete o[k]
            k=kk
          }
          o[k]=v
        }
      }
    }else{
      o=_JSHandler._prepareData(o+"",0,0,_parameter)
      o=_Util._strToJson(o,_parameter)
    }
    return o
  },
  _objToAPIParameter:function(v){
    if(v&&(_Util._isObjOrArray(v))){
      var ds=[]

      _getDataList(v,"",ds)
      return ds.join("&")
    }else{
      return v
    }

    function _getDataList(v,ks,ds){
      if(v&&_Util._isObjOrArray(v)){
        for(let k in v){
          _getDataList(v[k],ks?ks+"["+k+"]":k,ds)
        }
      }else{
        ds.push(encodeURIComponent(ks)+"="+encodeURIComponent(v))
      }
    }
  },
  _parameterToObj:function(v){
    if(v&&v.constructor==String){
      v=v.trim()
      try{
        v=_Util._eval("v="+v)
      }catch(e){
        if(v.includes("=")){
          v=v.split("&")
          var o={}
          v.forEach((a,i)=>{
            a=a.replace(/\+/g," ")
            a=a.split("=")
            let k=decodeURIComponent(a[0])
            let ks=k.split("[")
            if(ks.length>1){
              ks=ks.map(x=>x.replace("]",""))
              let oo=o
              ks.forEach((x,i)=>{
                oo[x]=oo[x]||{}
                if(i==ks.length-1){
                  oo[x]=decodeURIComponent(a[1])
                }else{
                  oo=oo[x]
                }
              })
            }else{
              o[k]=decodeURIComponent(a[1])
            }
          })
          v=o
        }
      }
    }
    return v
  },
  _speakCurWords:function(w){
    if(_Util.speakingWords){
      window.speechSynthesis.cancel()
    }
    _Util.speakingWords = new SpeechSynthesisUtterance(w);
    if(curUser.language=="cn"){
      _Util.speakingWords.lang="zh-CN"
    }
    _Util.speakingWords.onend=()=>{
      _Util.speakingWords=0
    };
    window.speechSynthesis.speak(_Util.speakingWords);
  },
  _focusNextByTab:function(_curElement){
    var os=$(BZ.TW.document).find("*"),_found=0;
    var _idx=os.index(_curElement)
    var _tIdx=_curElement.tabIndex
    while(!_found){
      for(var i=_idx+1;i<os.length;i++){
        var o=os[i]
        if(o==os[i]){
          if(_tIdx>0){
            _tIdx=0
            _idx=0
          }
        }
        if($(o).css("display")!="none"&&$(o).css("visibility")!="hidden"){
          if(["INPUT","SELECT","A","BUTTON","TEXTAREA"].includes(o.tagName)&&o.type!="hidden"){
            if(_tIdx<0){
              if(o.tabIndex==0){
                return o.focus()
              }
            }else if(_tIdx==0){
              if(o.tabIndex==0||o.tabIndex==1){
                return o.focus()
              }
            }else{
              if(o.tabIndex==_tIdx+1){
                return o.focus()
              }
            }
          }
        }
      }
      if(!_found){
        if(_idx>=0){
          _idx=-1
        }else{
          break
        }
      }
    }
  },
  _formatTimeInMinSecond2:function(t){
    let h=Math.floor(t/60/60)||""
    if(h){
      h+=":"
    }
    t=t%3600
    let m=_Util._formatNumberLength(Math.floor(t/60),2)+":"
    let s=_Util._formatNumberLength(t%60,2)
    return h+m+s
  },
  _toOneLevelJson:function(d){
    let ds=[]
    _findPath(d)
    return ds;
    function _findPath(d,p){
      if(!d||![Object,Array].includes(d.constructor)){
        let o={}
        o[p]=d
        ds.push(o)
      }else{
        if(d.constructor==Object){
          for(let k in d){
            let ks=k.split(",")
            ks.forEach(kk=>{
              let pp=p?p+"."+kk:kk
              _findPath(d[k],pp)
            })
          }
        }else{
          d.forEach(e => {
            _findPath(e,p)
          });
        }
      }
    }
  },
  _formatTimeInMinSecond:function(tt,_ignoreMs){
    tt=parseInt(tt)
    let p=""
    if(tt<0){
      p="- "
      tt=0-tt
    }
    var t=Math.floor(tt/1000)
    var s=Math.floor(t%60)
    var m=Math.floor(t/60)
    var h=Math.floor(m/60)
    m=m%60
    if(h){
      h+=":"
    }else{
      h=""
    }
    if(m){
      m+=":"
    }else{
      m=""
    }
    if(!s){
      s=0
    }
    if(!_ignoreMs){
      tt=tt%1000
    }else{
      tt=0
    }
    return p+h+m+s+(!h&&!m&&s<10&&tt?"."+tt:"")+(!h&&!m?"s":"")
  },
  _formatTimer:function(t){
    let h="",m=""
    if(t>3600000){
      h=parseInt(t/3600000)+"h "
      t=t%3600000
    }
    if(t>60000){
      m=parseInt(t/60000)+"m "
      t=t%60000
    }
    if(t>10000||m){
      t= (Math.floor(t/1000)||0)+"s"
    }else{
      t= (Math.round(t/100)/10||0)+"s"
    }
    return h+m+t
  },
  _changeFavicon:function(src) {
    src=location.protocol+"/"+"/"+location.host+"/"+src;
    document.head = document.head || document.getElementsByTagName('head')[0];
    var link = document.createElement('link'),
        oldLink = document.getElementById('dynamic-favicon');
    link.id = 'dynamic-favicon';
    link.rel = 'shortcut icon';
    link.href = src;
    if (oldLink) {
      document.head.removeChild(oldLink);
    }
    document.head.appendChild(link);
  },  
  _copyText:function(w,_doc,ui){
    _doc=_doc||document
    let _isInput=["INPUT","TEXTAREA"].includes(w.tagName)
    let el =_isInput?w:$("<textarea readonly style='position:absolute;left:-9999px'></textarea>").appendTo(_doc.body);
    if(!_isInput){
      w=w.innerText||w
      if([Object,Array].includes(w.constructor)){
        w=JSON.stringify(w,0,2)
      }
      el.val(w)
    }
    el.select();
    _doc.execCommand('copy');
    if(!_isInput){
      el.remove();
    }
    w=ui||w
    if(w.constructor!=String){
      if(_isInput){
        w.select();
        w.focus()
      }else{
        let pu=w.parentElement||w,
            c="bz-enable-select"
        if(!$(pu).hasClass(c)){
          $(pu).addClass(c)
        }else{
          c=0
        }
        let _range = new Range(),
            _sel = w.ownerDocument.defaultView.getSelection();
            _sel.removeAllRanges();
            _range.collapse(true);
        _range.setStart(w, 0);
        _range.setEnd(w, 1);
        _sel.addRange(_range);
        setTimeout(()=>{
          _sel.removeAllRanges();
          if(c){
            $(pu).removeClass(c)
          }
        },100)
      }
    }
    _infoManagement._addBZInfo(_bzMessage._method._copiedText)
  },
  
  _copyData:function(o,_doc){
    _doc=_doc||document
    let d=$("<textarea readonly style='position:absolute;left:-9999px'></textarea>")
    d.appendTo(_doc.body);
    d.val(JSON.stringify(o))
    _Util._copyText(d[0],_doc)
    d.remove()
  },
  _getClipboardValue:function(_fun){
    try{
      let x=navigator.clipboard.readText();
      x.then(text => {
        try{
          _fun(text);
        }catch(ex){}
      })
    }catch(e){}
  },
  _objToURI:function(d){
    let q;
    for(let k in d){
      let w;
      if(d[k]&&[Object,Array].includes(d[k].constructor)){
        w=JSON.stringify(d[k]).replace(/\"/g,"")
      }else{
        w=(d[k]+"").replace(/^[\'\"]([^\'\"]+)[\'\"]$/,"$1")
      }
      if(w=="bz-skip"){
        continue
      }
      if(q){
        q+="&"
      }else{
        q="?"
      }
      if(!_Util._hasCode(w)){
        w=encodeURIComponent(w)
      }
      q+=k+'='+w;
    }
    return q
  },
  //d: data, t: with tab?
  _formatDataWithVariable:function(d,t){
    if(d){
      let w=d.trim()
      if(w.includes("\n")){
        return w
      }
      if(!("{[".includes(w[0])&&"}]".includes(w[w.length-1]))){
        return d
      }
      try{
        d=_Util._parseJSONWithRefDataToObj(d,1)
        d=_Util._refDataToJSON(d)
      }catch(ex){
      }
      return d
    }else{
      return d
    }
  },
  _isFocusable:function(o){
    return ["A","BUTTON","INPUT","SELECT","TEXTAREA"].includes(o.tagName)||o.contenteditable
  },
  _replaceObjValue:function(o,w,r){
    if(o&&[Object,Array].includes(o.constructor)){
      for(var k in o){
        o[k]=_Util._replaceObjValue(o[k],w,r)
      }
    }else if(o){
      o=o+""
      return (o+"").replace(w,r)
    }
    return o
  },
  _getExistItemInList:function(o,a,_list){
    for(var i=0;i<_list.length;i++){
      var v=_list[i]
      if(v[a]==o[a]){
        return v
      }
    }
  },
  _isEmpty:function(v){
    return !v||[Array,Object].includes(v.constructor)&&$.isEmptyObject(v)
  },
  _findValueInObj:function(o,_fun){
    if(o){
      for(var k in o){
        if(_fun(o[k],k)){
          return o[k]
        }
      }
    }
  },
  _findKeyInObj:function(o,_fun){
    for(var k in o){
      if(_fun(o[k],k)){
        return k
      }
    }
  },
  _findIFrames:function(doc,fs){
    $(doc).find("*").each(function(i,v){
      if(v.tagName=="IFRAME"){
        fs.push(v)
        if(v.contentDocument){
          _Util._findIFrames(v.contentDocument,fs)
        }
      }else if(v.shadowRoot){
        _Util._findIFrames(v.shadowRoot,fs)
      }
    })
  },
  _getAllRadioValues:function( r ) {
    let _radios = document.getElementsByName( r.name ),vs=[];
    
    for( i = 0; i < _radios.length; i++ ) {
      vs.push(_radios[i].value);
    }
    return vs;
  },
  _getQuickPath:function(e){
    if(!e){
      return
    }
    var t=$util.getElementText(e)||""
    t=t.trim()
    if(t){
      t=t.split("\n")[0].substring(0,50)
      t=":Contains("+t+")"
    }

    while(e.parentElement){
      t=">"+_Util._getCurPath(e)+t
      e=e.parentElement
      if(e.tagName=="BODY"){
        return "BODY"+t
      }
    }
    return "BODY"
  },
  _filterOutHidden:function(os,_result){
    os=os||[]
    for(var i=0;i<os.length;i++){
      if(_Util._isHidden(os[i])){
        if(!_result){
          os.splice(i--,1)
        }
      }else if(_result){
        _result.push(os[i])
      }
    }
    
  },
  _elementTxtToPath:function(os){
    if(os.constructor==String){
      os=[os]
    }
    for(var i=0;i<os.length;i++){
      var v=(""+os[i]).trim();
      if(v===""){
        os.splice(i,1);
        i--;
      }else if(os[i].constructor==String && v.includes(" ")){
        var b=[],_map={"(":")","[":"]"};
        var vs="",vv=[];
        for(var n=0;n<v.length;n++){
          var c=v[n];
          if(c==" " && !b.length){
            vv.push(vs);
            vs="";
          }else if("([".includes(c)){
            b.unshift(_map[c]);
          }else if(c==b[0]){
            b.shift();
          }
          vs+=c;
        }
        vs=vs.trim()
        if(vs){
          vv.push(vs);
        }
        if(vv.length>1){
          os.splice(i,1)
          for(var n=0;n<vv.length;n++){
            os.splice(i+n,0,vv[n]);
          }
        }
      }
    }
    return os;
  },
  _getElementByQuickPath:function(p){
    if(p.constructor==Array){
      return $util.findDom(p)
    }
    p=p.split(">")
    if(p[0]=="BODY"){
      p.shift()
    }
    var o=document.body
    p.forEach(function(v){
      v=v.split(":")
      var vv=v[1]
      if(vv&&vv.match(/[0-9]+/)){
        vv=parseInt(vv.match(/[0-9]+/)[0])
      }else{
        vv=0
      }
      for(var i=0;i<o.children.length;i++){
        var t=o.children[i]
        if(t.tagName==v[0]){
          if(!vv){
            o=t;
            return
          }else{
            vv--
          }
        }
      }
    })
    return o
  },
  _getCurPath:function(e){
    var i=0,t=e.tagName;
    while((e = e.previousSibling)!=null){
      if(e.tagName==t){
        i++;
      }
    }
    return i?t+":eq("+i+")":t
  },
  _toCompareableWord:function(w,splitChar){
    if(w){
      w=w.replace(/([^A-Z]+)([A-Z][^A-Z]+)/,"$1_$2").trim().toLowerCase().replace(/\s+/g,' ').replace(/[^0-9a-zA-Z\u4E00-\u9FCC]+/g,'_').replace(/[_]+/g,'_')
      w=w.split("_").map(x=>{return x.plural()}).join(splitChar||"_");
    }
    return w
  },
  _parseCamelWords:function(w){
    if(w){
      w=w.replace(/([^A-Z]*|[A-Z]+)([A-Z][^A-Z]+)/g,"$1 $2").replace(/([^A-Z ]+)([A-Z]+)/g,"$1 $2").replace(/( [A-Z][^A-Z])/g,function(v){return v.toLowerCase()});
      w=w.trim().replace(/\s+/g," ")
    }
    return w
  },
  _toCamelWords:function(w,_chkUpperCase){
    w=(w||"").toString().trim()
    if(w){
      w= w.split(/[^\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC]]|_+| +|-+/).map((v,i)=>{
        if(i){
          return _Util._toCapitalWord(v)
        }else{
          return v
        }
      }).join("")
      if(_chkUpperCase&&w[0]==w[0].toUpperCase()&&w[1]&&w[1]==w[1].toUpperCase()){
        return w
      }
      w=w[0].toLowerCase()+w.substring(1)
      return w
    }
    return ""
      
  },
  _idToName:function(w){
    return _Util._toCapitalWord(_Util._parseCamelWords(w).plural(1))
  },
  _getTagNameFromElementPath:function(p){
    for(var i=p.length-1;i>0;i--){
      if(!$.isNumeric(p[i])){
        return p[i]
      }
    }
  },
  _isDotableKey:function(k){
    return !k.match(/^[0-9]|[^_$a-zA-Z0-9\u4E00-\u9FCC]/)
  },
  //m:property map, o: object data, p: path
  _objToProperties:function(m,o,p,_noFunStr){
    if(o&&(o.constructor==Object||o.constructor==Array)){
      for(var k in o){
        _Util._objToProperties(m,o[k],_Util._mergeDataPath(p,k),_noFunStr)
      }
    }else if(!o||o.constructor!=Function){
      if(o&&o.constructor==String){
        if(o.trim().startsWith("function")&&_noFunStr){
          return m
        }else if(o.length>100){
          o=o.trim().substring(0,100)
        }
      }
      if(p){
        m[p]=o
      }else{
        m=o
      }
    }
    return m
  },
  _mergeDataPath:function(p,k){
    var pk;
    if(!p){
      pk=k
    }else if(_Util._isDotableKey(k)){
      pk=p+"."+k
    }else if($.isNumeric(k)){
      pk=p+"["+k+"]"
    }else{
      pk=p+"['"+k+"']"
    }
    return pk
  },
  _hasChinese:function(w){
    return w.match(/[\u4E00-\u9FCC]/g)
  },
  _countWords:function(w){
    let ws=w.match(/[\u4E00-\u9FCC]/)
    if(ws){
      return ws.length
    }
    return w.split(/[^A-Za-z]/).length
  },
  _getDiffWord:function (o,n){
    o=o.replace(/\s/g," ")
    n=n.replace(/\s/g," ")
    if(BZ._data._curProject.language=="cn"){
      s=""
    }else{
      s=" "
    }

    o=o.split(s)
    n=n.split(s)

    while(o.length&&n.length&&o[0]==n[0]){
      o.shift()
      n.shift()
    }
    if(o.length&&n.length){
      o=o.join(s)
      n=n.join(s)
      return {
        o:o,n:n
      }
    }
  },
  //s:soure words
  //r:remove word
  //ex. s="abc abcd xabc 中国abc abc中国", x="abc", y=" ", --> "abcd xabc 中国 中国"
  //ex. s="abc abcd xabc 中国abc abc中国", w="中", --> "abc abcd xabc 国abc abc国"
  _removeWord:function(s,r,_handleStar,i){
    var re,rr,ss=s,rs;
    if(!s){
      return s
    }
    if(BZ._data._curProject.language=="cn"){
      if(!r.match(/[a-z0-9] [0-9a-z]/)&&r.match(/\s/)){
        r=r.replace(/ /g,"")
        s=s.replace(/ /g,"")
      }
    }
    if(!i){
      r=r.replace(/([\+\?\$\^\(\)\[\]\{\}\|\\])/g,"\\$1")
      if(_handleStar){
        
      }else{
        r=r.replace(/([\*\.])/g,"\\$1")
      }
    }
    if(_Util._hasChinese(r)){
      re=new RegExp(r,"gi")
      rr=" "
    }else{
      re=new RegExp("(^|[^0-9a-z])"+r+"([^0-9a-z]|$)","gi")
      rr="$1 $2"
    }
    rs=s.replace(re,rr).trim()
    if(rs==s){
      return i?ss:_Util._removeWord(ss,r,_handleStar,1)
    }else{
      return i?rs:_Util._removeWord(rs,r,_handleStar,1)
    }
  },
  _getVisibleElements:function(_area,_css){
    if(_css&&_css.constructor==Array){
      _css=_css.join(",")
    }
    _css=_area.find(_css).toArray()
    _Util._filterOutHidden(_css)
    return _css
  },
  _includesWord:function(s,r,_handleStar){
    return s!=_Util._removeWord(s,r,_handleStar)
  },
  _includesWordWithoutSign:function(s,i){
    s=_Util._removeSign(s," ")
    i=_Util._removeSign(i," ")
    return s!=_Util._removeWord(s,i)
  },
  _generateIndentation:function(v){
    var s="";
    for(var i=0;i<v;i++){
      s+=" ... "
    }
    return s;
  },
  _strToRegex:function(v){
    if(v){
      if(!v.match(/^[\/].+[\/]$/)){
        v="/"+v+"/"
      }
      try{
        v=_Util._eval("v="+v)
        return v
      }catch(e){
        alert(e.message)
      }
    }
  },
  _replaceWord:function(w,x,y){
    if(!x || !y || !w){
      return w;
    }
    var x1=x[0],x2=x[x.length-1],r=x.replace(/([\(\)\{\}\[\].\$])/g,"\\$1");
    var c1=_Util._hasChinese(x1),c2=_Util._hasChinese(x2);
    
    if(c1&&c2){
      return w.replace(new RegExp(x,"g"),y).trim()
    }else if(c1){
      r=new RegExp("(.|^)"+r+"([^a-zA-Z0-9]|$)","g");
    }else if(c2){
      r=new RegExp("([^a-zA-Z0-9]|^)"+r+"(.|$)","g")
    }else{
      r=new RegExp("([^a-zA-Z0-9]|^)"+r+"([^a-zA-Z0-9]|$)","g")
    }
    return w.replace(r,"$1"+y+"$2")
  },
  //_nodes:childNodes, i: the first text node idx
  _pickTextFromNode:function(_nodes,i){
    var e=_nodes[i];
    var n,tw=e.textContent.trim();
    while(n=_nodes[i+1]){
      if(n.nodeType==3){
        var t=n.textContent.trim()
        if(t){
          tw+=" "+t
        }
      }else if(n.nodeType==1){
        break
      }
      i++
    }
    tw=_Util._filterTxt(tw)
    return {t:tw,i:i}
  },
  _pickAttrFromObj:function(o,ps){
    var oo={};
    if(ps.constructor==Object){
      ps=Object.keys(ps)
    }
    ps.forEach(function(v){
      try{
        v=v.split(".")
        let ood=oo,od=o;
        v.find((x,i)=>{
          if(i+1==v.length){
            ood[x]=od[x]
          }else{
            if(od[x]){
              ood[x]={}
              ood=ood[x]
              od=od[x]
            }else{
              return 1
            }
          }
        })
      }catch(e){}
    })
    return oo
  },
  _filterTxt:function(tw){
    return tw.replace(/[\(\)\[\]\{\}]/g," ").replace(/\s+/g," ").trim()
  },
  _insertInString:function(s,m,w){
    var i=s.indexOf(m);
    if(i>=0){
      return s.substring(0,i)+w+s.substring(i);
    }
  },
  _findCellElement:function(e,_parent){
    var k=_IDE._data._curVersion.setting.content.clickableElements;
    k=k?k+",":""
    k+="INPUT,TEXTAREA,SELECT,A,BUTTON,[contenteditable=true],[draggable=true]"
    var $e=$(e)
    try{
      if($e.is(k)){
        return e
      }
      if($e.find(k).length){
        return _parent?0:e
      }
      return _Util._findCellElement(e.parentElement,1)||(_parent?0:e)
    }catch(ee){}
  },
  _handleCodePoints:function(array) {
    var CHUNK_SIZE = 0x8000; // arbitrary number here, not too small, not too big
    var index = 0;
    var length = array.length;
    var result = '';
    var slice;
    while (index < length) {
      slice = array.slice(index, Math.min(index + CHUNK_SIZE, length)); // `Math.min` is not really necessary here I think
      result += String.fromCharCode.apply(null, slice);
      index += CHUNK_SIZE;
    }
    return result;
  },
  _getParentElementByCss:function(p,o){
    p=$(p).toArray()
    return p.find(a=>{
      return $(a).find(o).length
    })
  },
  _findParentElementByCss:function(p,o){
    p=$(p).toArray();
    let oo=0
    while(!oo){
      oo= p.find(a=>{
        return $(a).find(o)[0]
      })
      if(oo){
        return oo
      }
      p=p[0].parentElement
      if(!p){
        return
      }
      p=$(p).toArray();
    }
    return oo
  },
  _getParentByTagName:function(o,_name){
    while(o.parentElement && o.tagName!="BODY"){
      o=o.parentElement
      if(o.tagName==_name){
        return o
      }
    }
  },
  _focusNextInput:function(e){
    var _org=e, os=$(e.ownerDocument).find("INPUT,BUTTON,SELECT,TEXTAREA,SELECT,[contenteditable=true]");
    var i=os.index(e)+1,b;
    while(e){
      e=os[i++];
      
      if(e && !$(BZ.TW.document).find(".BZIgnore").find(e).length && !["file","hidden"].includes(e.type)&&!$(e).attr("disabled")&&!$(e).attr("readonly")){
        if(e.type=="radio" &&_org.type=="radio"&&e.name==_org.name){
          continue
        }
        if(e.tagName!="BUTTON"&&!["button","reset","submit"].includes(e.type)){
          break
        }else if(!b){
          b=e;
        }
      }
    }
    e=e||b
    if(e){
      e.focus()
    }
    return e
  },
  _formatTextToHTML:function(w){
    w=(w||"").toString()
    
    return w.replace(/\</g,"&lt;").replace(/\>/g,"&gt")
  },
  _isSameObj:function(a,b,ks){
    let av,bv;
    if(ks){
      return !ks.find(x=>!_Util._isSameObj(a[x],b[x]))
    }
    if(a&&b&&[Object,Array].includes(a.constructor)&&a.constructor==b.constructor){
      for(var k in a){
        av=a[k];
        bv=b[k]
        if(av&&[Object,Array].includes(av.constructor)&&bv&&bv.constructor==av.constructor){
          if(!_Util._isSameObj(av,bv)){
            return
          }
          continue
        }
        if(av!=bv){
          return
        }
      }
      for(var k in b){
        if(a[k]===undefined&&a[k]!=b[k]){
          return
        }
      }
      return 1
    }
    return a==b
  },
  _isSameArray:function(a,b,_key){
    if(a==b||(!a&&!b)){
      return 1
    }else if(!a||!b||a.constructor!=Array||b.constructor!=Array||a.length!=b.length){
      return 
    }
    for(var i=0;i<a.length;i++){
      if(!b.includes(a[i])){
        if(_key){
          var _found=0
          for(var j=0;j<b.length;j++){
            if(b[j][_key]==a[i][_key]){
              _found=1
              continue
            }
          }
          if(_found){
            continue
          }
        }
        return
      }
    }
    return 1
  },
  _isSameHost:function(u1,u2){
    u1=u1.split("/"+"/")
    u2=u2.split("/"+"/")
    
    if(u1[0]&&u2[0]){
      if(u1[0]!=u2[0]){
        return
      }
    }
    if(u1.length>1){
      u1=u1[1]
    }
    if(u2.length>1){
      u2=u2[1]
    }

    u1=u1.split(/[\/#]/)
    u2=u2.split(/[\/#]/)
    if(!u1[0]){
      u1.shift()
    }
    if(!u2[0]){
      u2.shift()
    }
    return u1[0]==u2[0]
  },
  _findBackground:function(d){
    var os=[];
    $(d).find("*").filter(function(i,v){
      if($(v).css("position")=="fixed" && !_Util._isHidden(v)){
        r=v.getBoundingClientRect();
        if(window.innerWidth-r.width<40 && window.innerHeight-r.height<40){
          os.push(v)
        }
      }
    })
    os.sort(function(a,b){
      return $(a).css("z-index")>=$(b).css("z-index")
    });

    return os.length?os[os.length-1]:d
  },
  _getBackgroundColor:function(e){
    var c=$(e).css("background-color");
    if((c.startsWith("rgba") && !c.endsWith(", 0)") && !c.startsWith("rgba(255, 255, 255, 0.")) || c!=="transparent"){
      return c;
    }
    
    if(e.tagName!="BODY"){
      return _Util._getBackgroundColor(e.parentElement)
    }
  },
  _toCapitalWord:function(w,_revert){
    if(w){
      if(_revert&&w.length>1&&w[1].toLowerCase()==w[1]){
        return w[0].toLowerCase()+w.substring(1)
      }else{
        return w[0].toUpperCase()+w.substring(1)
      }
    }else{
      return ""
    }
  },
  _isNoTextElement:function(e){
    return ["TEXTAREA","SELECT","IFRAME","SVG","LINK","TITLE","META","SCRIPT","STYLE","HEAD","HTML"].includes(e.tagName.toUpperCase())||_Util._inSelectOption(e)
  },
  _isNoVisibleElement:function(e){
    return ["OPTION","IFRAME","SVG","LINK","TITLE","META","SCRIPT","STYLE","HTML","HEAD"].includes(e.tagName.toUpperCase())
  },
  _isInContentEditable:function(e){
    if($(e).attr("contenteditable")){
      return 1;
    }
    if(e && e.tagName!="BODY"){
      return this._isInContentEditable(e.parentNode);
    }
  },
  _isInputObj:function(e,_chkReadonly){
    if(e.nodeType!=1){
      return
    }
    if((!_chkReadonly||!$(e).attr("readonly")||e.type=="file")&&this._isStdInputElement(e)||this._isInContentEditable(e)){
      return 1
    }
    let z=(e.dataset.bz||"").includes("$field")
    if(z){
      return $(":bz($form)").toArray().find(x=>{
        if($(x).find(e)[0]){
          return 1
        }
      })
    }
  },
  _isForm:function(c){
    return _Util._findInputs(c).length>1
  },
  _getElementContentText:function(e){
    if(e){
      let t=e.innerText||e.textContent
      if(!_Util._isInputObj(e)){
        e=_Util._findInputs(e)[0]
      }
      if(e){
        t=e.value||t
      }
      return t||""
    }
    return ""
  },
  _getAcceptFileType:function(f){
    return ((f.accept||"").split(",")[0]||"").split("/").pop().toLowerCase()
  },
  _isUrl:function(s){
    return s&&s.match(/^(https?:)?\/\/.+/)&&!s.includes("\n")
  },
  _findInputs:function(e,_inBz){
    let bz=e&&e.dataset&&e.dataset.bz,
        _css=_cssHandler._getInputCss(),
        os=[]
    if(_inBz||bz&&bz.includes("$form")){
      for(let o of e.children){
        if($(o).is(_css)){
          if(!_Util._isHidden(o)){
            os.push(o)
          }
        }else{
          let ob=o.dataset.bz
          if(ob&&ob.includes("$field")){
            os.push(o)
          }else if(ob&&ob.includes("$skip")){
            continue
          }else{
            os.push(..._Util._findInputs(o,1))
          }
        }
      }
      return os
    }else{
      return $(e).find(_css).toArray().filter(x=>{
        return !_Util._isHidden(x)||["radio","checkbox"].includes(x.type)
      });
    }
  },
  _isInputButton:function(e){
    return e.tagName=="INPUT" && ["image","button","submit","reset"].includes(e.type)
  },
  _setTabSize:function(v,ts){
    var vs=v.split(/[\t\n\r]/);
    var m=0;
    for(var i=0;i<vs.length;i++){
      if(m<vs[i].length){
        m=vs[i].length
      }
    }
    if(m<10){
      m=9;
    }
    m++;
    for(var i=0;ts&&i<ts.length;i++){
      var t=ts[i];
      if(t.tagName=="TEXTAREA" && t.value==v){
        t.style.tabSize=m;
      }else if(t.tagName=="PRE" && t.innerText==v){
        t.style.tabSize=m;
      }
    }
    return m
  },
  _getNewClass:function(v1,nv){
    v1=v1||"";
    v1=v1.split(" ");
    if(!nv || nv.constructor!=String){
      nv="";
    }

    nv=nv.split(" ");
    for(var n=0;n<v1.length;n++){
      var i=nv.indexOf(v1[n]);
      if(i>=0){
        nv.splice(i,1);
      }
    }
    return nv;
  },
  _formatAgo:function(t){
    t=Math.round((Date.now()-t)/1000);
    var m=_bzMessage._system._info
    if(t<60){
      m=m._secondAgo
    }else{
      t=Math.round(t/60)
      if(t<60){
        m=m._minuteAgo
      }else{
        t=Math.round(t/60)
        if(t<24){
          m=m._hourAgo
        }else{
          t=Math.round(t/24)
          if(t<7){
            m=m._dayAgo
          }else{
            if(t<30){
              t=Math.round(t/7)
              m=m._weekAgo
            }else if(t<365){
              t=Math.round(t/30)
              m=m._monthAgo
            }else{
              t=Math.round(t/365)
              m=m._yearAgo
            }
          }
        }
      }
    }
    return _Util._formatMessage(m,[t,t>1?"s":""])
  },
  _formatTimestamp:function(t,f){
    t=t||Date.now()
    if(t.constructor==String&&!$.isNumeric(t)){
      f=t
      t=Date.now()
    }
    t=parseInt(t)
    f=f||"MM-dd hh:mm";
    var d=new Date(t);
    var mp={
      y:d.getFullYear()+"",
      M:_Util._formatNumberLength(d.getMonth()+1),
      d:_Util._formatNumberLength(d.getDate()),
      h:_Util._formatNumberLength(d.getHours()),
      m:_Util._formatNumberLength(d.getMinutes()),
      s:_Util._formatNumberLength(d.getSeconds())
    }
    for(var k in mp){
      var r= new RegExp("["+k+"]+"),
          v=mp[k]
      
      r=f.match(r)
      if(r){
        r=r[0]
        if(k=="y"){
          v=v.substring(v.length-r.length)
        }else if(r.length==1){
          v=parseInt(v)+""
        }
        f=f.replace(r,v)
      }
    }
    return f
  },
  _selectText:function(o) {
    if (document.selection) {
      var range = document.body.createTextRange();
      range.moveToElementText(o);
      range.select();
    } else if (window.getSelection) {
      var range = document.createRange();
      range.selectNode(o);
      window.getSelection().removeAllRanges();
      window.getSelection().addRange(range);
    }
  },
  _getTopZIndex:function(_curDom){
    _curDom=_curDom||document.body
    var os=$(_curDom.ownerDocument).find("*"),zz=100;
    for(var i=0;i<os.length;i++){
      var o=os[i];
      try{
        var z=parseInt($(o).css("z-index"))||0;
        if(z>=zz && z<100000 && !$(o).hasClass("bz-modal-bg")){
          zz=z+1;
        }
      }catch(e){}
    }
    if(zz<=100){
      zz=200;
    }
    return zz;
  },
  _setToTop:function(_curDom){
    // if($(".bz-bg").find(_curDom).length){
      // return
    // }
    var z=this._getTopZIndex(_curDom)||200;
    var zz=parseInt($(_curDom).css("z-index"))||200;
    if(!zz || z>zz){
      $(_curDom).css({"z-index":z})
    }
  },
  _findTextBox:function(v,_fun){
    v=v.trim()
    v=v.split(":")
    let _tag="",_content=v[1]||v[0],vs;
    if(v[1]){
      _tag=v[0]
    }
    
    vs=$(_tag+":Contains("+_content+")").toArray()
    if(!_tag){
      let os=[]
      vs.forEach((x,i)=>{
        if(!x.children.length||!vs[i+1]||!$(x).find(vs[i+1])[0]){
          os.push(x)
        }
      })
      vs=os.map(x=>{
        while(x.parentElement){
          p=x.parentElement
          if(_fun($util.getElementText(p).replace(/\:/g," ").trim(),_content)){
            x=p
          }else{
            break
          }
        }
        return x
      })
    }

    return vs
  },
  _setDrag:function(_handlers,_curDom, _except,_fun){
    _curDom._position=$(_curDom).css("position")
    let _nsSlider=$(_curDom).css("cursor")=="row-resize"
    let _ewSlider=$(_curDom).css("cursor")=="col-resize"
    var _dPos,_mPos,_dSize,_tmpMouseMove,_tmpMouseUp,_tmpSelect,
        _uiSwitch=BZ._data._uiSwitch;
    for(var i=0;i<_handlers.length;i++){
      var h=_handlers[i];
      if(!h){
        continue;
      }
      h.onmousedown=function(e){
        _Util._setToTop(_curDom);
        if($("[draggable]").find(e.target)[0]){
          return
        }
        let c=this.parentElement.getBoundingClientRect(),
            r=this.getBoundingClientRect()
        // $(this).css({position:"fixed"})
        if(_ewSlider){
          $(this).css({top:c.top+"px",height:c.height+"px",left:r.left+"px"})
        }else if(_nsSlider){
          console.log("left:"+c.left+", top:"+r.top)
          $(this).css({left:c.left+"px",width:c.width+"px",top:r.top+"px"})
        }

        if(_curDom._data&&_curDom._data._noMoveable){
          return
        }
        if(_Util._isEventElement(e.target)){
          return;
        }
        if(_except){
          if(_except.constructor==String){
            if($(_except).find(e.target).length||$(_except).is(e.target)){
              return;
            }
          }else{
            for(var i=0;i<_except.length;i++){
              if(_except[i]==e.target || $(_except[i]).find("*").is(e.target)){
                return;
              }
            }
          }
        }
        _uiSwitch._inHandleSize=1
        
        
        _mPos=_Util._getMouseXY(e);
        _dPos=_Util._getDomXYForDrag(_curDom);
        _dSize=_Util._getDomSize(_curDom);
        
        if(this.ownerDocument.onmousemove!=_mousemove){
          _tmpMouseMove=this.ownerDocument.onmousemove;
        }
        
        if(this.ownerDocument.onmouseup!=_mouseup){
          _tmpMouseUp=this.ownerDocument.onmouseup;
        }
        if(this.ownerDocument.body.onselectstart!=_selectText){
          _tmpSelect=this.ownerDocument.body.onselectstart;
        }
        
        this.ownerDocument.onmousemove=_mousemove;
        this.ownerDocument.onmouseup=_mouseup;
        this.ownerDocument.body.onselectstart=_selectText;
      }
    }
    var _mousemove=function(e){
      if(_uiSwitch._inHandleSize && e.buttons){
        var _newMPos=_Util._getMouseXY(e);
        var x=_newMPos.x-_mPos.x+_dPos.x
        var y=_newMPos.y-_mPos.y+_dPos.y
        var _hSize=50;
        var ww=_curDom.ownerDocument.defaultView.innerWidth;
        var wh=_curDom.ownerDocument.defaultView.innerHeight;
        $(_curDom).css({transform:"unset"})
        if(x>0 && x+_hSize<ww&& y>0 && y+_hSize<wh){
          return _setNewPos(_curDom,x,y)
        }
        if(x>0 && x+_hSize>ww){
          x=ww-_hSize;
        }
        if(y>0 && y+_hSize>wh){
          y=wh-_hSize;
        }
        if(x<0){
          x=0;
        }
        if(y<0){
          y=0;
        }
        return _setNewPos(_curDom,x,y)
      }else if(_uiSwitch._inHandleSize){
        this.onmouseup()
      }
    };
    var _mouseup=function(e){
      _uiSwitch._inHandleSize=0;
      this.onmousemove=_tmpMouseMove;
      this.onmouseup=_tmpMouseUp;
      this.body.onselectstart=_tmpSelect;
      
      $(_curDom).css({position:_curDom._position})
      if(_nsSlider){
        $(_curDom).css({width:"100%"})
      }
      var _newMPos=_Util._getMouseXY(e);
      _fun&&_fun(_newMPos.x,_newMPos.y,_curDom,1)
    }
    
    function _setNewPos(o,x,y){
      if(!_fun||_fun(x,y,o)){
        if(_nsSlider){
          $(o).css({top:y+"px"});
        }else if(_ewSlider){
          $(o).css({left:x+"px"});
        }else{
          $(o).css({left:x+"px",top:y+"px"});
        }
      }
    }
    
    var _selectText=function(){return false};
    setTimeout(function(){
      _Util._setToTop(_curDom);
    },100)
  },
  _setDragDrop:function(_curDom,_selector,_area,_befFun,_AftFun,_diff){
    if(!_curDom){
      return;
    }
    var _mPos,_dPos,_inDraging,_scrollTop;
    var _tmpDiv;
    _diff=_diff||0;
    _curDom.onmousedown=function(e){
      if(["INPUT","TEXTAREA","BUTTON","PRE"].includes(e.target.tagName)){
        return
      }
      if((!_tmpDiv || !_tmpDiv.length || !_tmpDiv[0].children.length) && this.childNodes[0]){
        _tmpDiv=$(_curDom.childNodes[0].outerHTML);
        _tmpDiv.css({border:"1px dashed blue","background-color":"rgba(0, 50, 255, 0.07) !important;"});
        _tmpDiv.find("*").css({border:"1px dashed blue","background-color":"rgba(0, 50, 255, 0.07) !important;"});
        _tmpDiv.find("*").text("")
      }
      _mPos=_Util._getMouseXY(e);
      _scrollTop=_area.scrollTop-_diff;
      _dPos=_Util._getDomXYForDrag(_curDom);
      _curDom.onmousemove=function(e){
        if(!e.buttons){
          _inDraging=0
          return;
        }
        if(!_inDraging){
          if(_befFun){
            _befFun(this)
          }
//            $(this).on("selectstart","*",function(){return false});
        }
        var _curPos=_Util._getMouseXY(e);
        var dx=_mPos.x-_curPos.x;
        var dy=_mPos.y-_curPos.y;
        var os=$(_curDom).find(_selector);
        if(os.length && (dx>5 || dx<-5 || dy>5 || dy<-5 || _inDraging)){
          _inDraging=true;
          
          os.css({position:"fixed",width:os.parent().css("width")});
          _tmpDiv.css({position:""});
          var _last=null;
          var _moveItems=[];
          for(var i=0;i<os.length;i++){
            var o=os[i];
            _moveItems.push(o)
            if(i==0){
              _last=o;
              $(o).css({top:_curPos.y-10,left:_curPos.x-_mPos.x});
            }else{
              _size=_Util._getDomSize(_last);
              $(o).css({
                top:parseInt(_last.style.top)+_size._height,
                left:parseInt(_last.style.left)
              });
              _last=o;
            }
          }
          
          for(var i=0;i<_curDom.childNodes.length;i++){
            var o=_curDom.childNodes[i];
            if(!_moveItems.includes(o)){
              var _oPos=_Util._getDomXYForDrag(o);
              var _oSize=_Util._getDomSize(o);
              if((_oPos.y<_curPos.y && _oPos.y+_oSize._height>_curPos.y) || (i==_curDom.childNodes.length-1 && _oPos.y+_oSize._height<_curPos.y)){
                if(_oPos.y+_oSize._height/2>_curPos.y){
                  _tmpDiv.insertBefore(o);
                }else{
                  _tmpDiv.insertAfter(o);
                }
//                console.log("------------------------")
//                console.log(_moveItems[0]);
//                console.log(_tmpDiv[0]);
//                console.log(o)
//                console.log("========================")
                return;
              }
            }
          }
        }
      }
      var _tmpDocMouseUp=_curDom.ownerDocument.onmouseup;
      _curDom.ownerDocument.onmouseup=function(e){
        if(_inDraging){
          _inDraging=0;
          if($(_curDom).find(_tmpDiv).length){
            $(_curDom).find(_selector).insertAfter(_tmpDiv);
            $(_curDom).find(_selector).css({position:""});
            _tmpDiv.remove();
          }
          if(_AftFun){
            _AftFun(this)
          }
        }
        _curDom.ownerDocument.onmouseup=_tmpDocMouseUp;
        _curDom.onmousemove=null;
      }
    };
  },
  _checkJQueryEvent:function(e){
    try{
      return $["_"+"data"](e,"events") || {};
    }catch(e){}
    return {};
  },
  _loadInHash:function(_url,_location){
    /*
    var _list=[_location.protocol,"/"+"/",_location.host,_location.pathname];
    for(var i=0;i<_list.length;i++){
      var v=_list[i];
      if(_url.startsWith(v)){
        _url=_url.substring(v.length);
      }
    }
    */
    return _url.startsWith(_location.origin+_location.pathname+"#");
  },
  _getStackTrace:function() {
    var obj = {};
    Error.captureStackTrace(obj, _Util._getStackTrace);
    return obj.stack;
  },
  _clone:function(o){
    if($.type(o)=="array"){
      return $.extend(true,[],o);
    }else if($.type(o)=="object"){
      return $.extend(true,{},o);
    }
    return o;
  },
  _simpleClone:function(o){
    if(o){
      let n={}
      if(o.constructor==Array){
        n=[]
      }else if(o.cloneNode){
        return o.cloneNode()
      }else if(o.constructor!=Object){
        return o
      }

      for(var k in o){
        n[k]=o[k]
      }
      return n
    }
    return o
  },
  _getSimpleJson:function(o){
    var d;
    if(o!==null&&o!==undefined){
      if(o.constructor==Object){
        d=Object.keys(o).length&&{}||undefined
      }else if(o.constructor==Array){
        d=o.length&&[]||undefined
      }else{
        return o===""?undefined:o
      }
      
      for(var i in o){
        var v=_Util._getSimpleJson(o[i])
        if(v!==undefined&&v!==null){
          d[i]=v
        }
      }
    }
    return d
  },
  _cloneSelectData:function(d,_ignore,_only){
    var dd={}
    for(var k in d){
      if(_only && k.match("^("+_only+")$")){
        dd[k]=d[k]
      }else if(_ignore && k.match("^("+_ignore+"$)")){
        
      }else if(!_only){
        dd[k]=d[k]
      }
    }
    return dd;
  },
  _setEscWindow:function(w){
    if(_Util._checkBrowserType().name=="ie"){
      if(w.document){
        w.document.onkeydown=_Util._escCloseWindow;
        w.document.tagWin=w;
      }else{
        this.tmpPopWin=w;
        setTimeout("_Util._setEscWindow(_Util.tmpPopWin)",100);
      }
    }else{
      w.onkeydown=_Util._escCloseWindow;
      w.tagWin=w;
    }
  },
  _formatMessage:function(_msg,_value){
    if(_value&&_value.constructor!=Array){
      _value=[_value]
    }
    _msg=(_msg||"")+""
    for(var i=0;_value && i<_value.length;i++){
      var s=new RegExp("\\{"+i+"\\}","g");
      _msg=_msg.replace(s,_value[i])
    }
    return _msg;
  },
  _escCloseWindow:function(e){
    if(e==undefined){
      e=null;
    }
    var k = _Util._checkKeycode(e);
    if(k==27){
      let os=$(e.srcElement.ownerDocument).find(".bz-modal-window .btn-cancel:last")
      if(os.length){
        os.click()
        return
      }
      try{
        this.tagWin.close();
      }catch(e){
      }
    }
  },
  _setFindDomJS:function(o){
    let s="document"
    let _bzPath=_Util._clone(o.bzTmp)
    
    if(_bzPath.find(x=>x=="shadowRoot")){
      while(_bzPath.length){
        let v=_bzPath.shift()
        if(!v||$.isNumeric(v)||v.includes("BZ.TW.document")){
          continue
        }
        if(v=="shadowRoot"){
          s+=_findShadowPath(_bzPath,document,o)
        }else{
          let t=v.split(/[:\[\.\#]/)[0]
          s+=_findElementPath(t,_bzPath,document,o)
        }
        break
      }
    }else{
      let os=document.getElementsByTagName(o.tagName)
      for(let i=0;i<os.length;i++){
        if(os[i]==o){
          s=`document.getElementsByTagName('${o.tagName}')[${i}]`
          break
        }
      }
    }

    o._jsPath=s

    function _findShadowPath(p,_root,o){
      let t=p.shift()
      t=t.split(/[:\[\.\#]/)[0]
      for(let i=0;i<_root.children.length;i++){
        let oo=_root.children[i]
        if(oo.getElementsByTagName(t).length){
          let s=_findElementPath(t,_Util._clone(p),oo,o)
          if(s){
            return ".children["+i+"]"+s
          }
        }
      }
    }
    
    function _findElementPath(_tagName,p,_root,o){
      let os=_root.getElementsByTagName(_tagName)
      let tt=p.shift(),s=`.getElementsByTagName("${_tagName}")`
      
      for(let i=0;i<os.length;i++){
        let oo=os[i]
        if(tt){
          if(tt=="shadowRoot"){
            if(oo.shadowRoot){
              let ss=_findShadowPath(_Util._clone(p),oo.shadowRoot,o)
              if(ss){
                return `${s}[${i}].shadowRoot${ss}`
              }
            }
          }else{
            tt=tt.split(/[:\[\.\#]/)[0]
            let ss=_findElementPath(tt,_Util._clone(p),oo,o)
            if(ss){
              return `${s}[${i}].getElementsByTagName("${_tagName}")[${i}]${ss}`
            }
          }
        }else if(o==oo){
          return `${s}[${i}]`
        }
      }
    }
  },
  _swapKeyValue:function(_json){
    var _result = {};
    for(var _key in _json){
      _result[_json[_key]] = _key;
    }
    return _result;
  },
  _isHidden:function(o,_bParent,_chkBZElement){
    if(!o){
      return 1;
    }
    if($(o).is(".BZIgnore")||$(".BZIgnore").find(o)[0]){
      if(!_chkBZElement){
        return 1
      }
    }
    var n=o.tagName;
    if(n){
      if(n=="INPUT" && o.type=="hidden"){
        return 1;
      }else if(n=="INPUT" && o.type=="file"){
        return _Util._isHidden(o.parentElement,1);
      }else if($(o).css("display")=="none" || (($(o).css("visibility")=="hidden"||$(o).css("opacity")==0) && !_bParent)){
        if(o.tagName=="INPUT"&&["checkbox","radio"].includes(o.type)){
          
        }else{
          return 1;
        }
      }
      if(!_bParent){
        var a=o.getBoundingClientRect();
        if(o.offsetLeft+o.offsetWidth<0 || o.offsetTop+o.offsetHeight<0){
          return 1
        }
        if(a.width<2 || a.height<2){
          if(o.innerText!=undefined && !o.innerText.trim()){
            for(var i=0;i<o.children.length;i++){
              if(!_Util._isHidden(o.children[i])){
                return 0
              }
            }
            return 1
          }
        }
      }
      /*
      var _rect=o.getBoundingClientRect();
      var _minOffsetLeft=_minOffsetTop=0;
      while(o!=o.ownerDocument.body){
        if(_minOffsetLeft>o.offsetLeft){
          _minOffsetLeft=o.offsetLeft;
        }
        if(_minOffsetTop>o.offsetTop){
          _minOffsetTop=o.offsetTop;
        }
        o=o.parentElement;
        if(!o){
          return 1;
        }
      }
      
      if(_minOffsetTop+_rect.height<=0 || _minOffsetLeft+_rect.width<=0){
        return true;
      }
      */
      if(o.tagName!="BODY"){
        return _Util._isHidden(o.parentElement,1)
      }
      return !o.ownerDocument || !o.ownerDocument.defaultView;
    }
    return 1;
  },
  _isTooSmall:function(o){
    o=o.getBoundingClientRect()
    return o.width<10||o.height<10
  },
  _moveMenu:function(v,_from){
    let r=v.getBoundingClientRect();
    if(r.bottom>window.innerHeight){
      if(r.top>r.height){
        $(v).css({top:r.top-r.height+"px"})
      }else{
        $(v).css({top:0})
      }
    }
  },
  _setTabStyle:function(o){
    if(o&&o.parentElement){
      $(o.parentElement).css({display:"unset"})
      $(o).css({width:"unset"})
      let w=o.getBoundingClientRect().width+30
      $(o).css({width:w})
      o._width=w
      $(o.parentElement).css({display:"flex"})
    }
  },
  _isOpacity:function(o){
    while(o&&o.tagName!="BODY"&&$(o).css("opacity")!=0){
      o=o.parentElement
    }
    return o.tagName!="BODY"
  },
  _scrollToTop:function(o){
    while(o.parentElement){
      o=o.parentElement
      o.scrollTop=0
      o.scrollLeft=0
    }
  },
  _focusElement:function(o){
    var r1=o.getBoundingClientRect()
    o.focus()
    var r2=o.getBoundingClientRect()
    if(r1.x==r2.x&&r1.y==r2.y){
      
      window.scrollTo(r1.x+window.scrollX-window.innerWidth/2,r1.y+window.scrollY-window.innerHeight/2)
    }
  },
  _getBackgroundColor:function(e){
    var c=$(e).css("background-color");
    if(c=="rgba(0, 0, 0, 0)"){
      return _Util._getBackgroundColor(e.parentElement)
    }
    return c
  },
  _isEqualData:function(d1,d2,_ignoreKeys,_sameKey){
    d1=d1||"";
    d2=d2||""
    if(d1.constructor==Object&&!Object.keys(d1).length){
      d1=""
    }
    if(d2.constructor==Object&&!Object.keys(d2).length){
      d2=""
    }
    if(d1.constructor==Array&&!d1.length){
      d1=""
    }
    if(d2.constructor==Array&&!d2.length){
      d2=""
    }
    if(d1&&d2&&d1.constructor==d2.constructor&&[Object,Array].includes(d1.constructor)){
      var ks=[],kk=new Set()
      if(_sameKey&&d1[_sameKey]==d2[_sameKey]){
        return 1
      }
      for(var k in d1){
        if(_ignoreKeys&&_ignoreKeys.includes(k)){
          continue
        }else if(k=="key"&&!_sameKey&&!d2.key){
          continue
        }
        kk.add(k)
        if(!_Util._isEqualData(d1[k],d2[k],_ignoreKeys)){
          return
        }
        ks.push(k)
      }
      for(var k in d2){
        if(_ignoreKeys&&_ignoreKeys.includes(k)){
          continue
        }else if(k=="key"&&!_sameKey&&!d1.key){
          continue
        }
        if(!kk.has(k)){
          if(!_Util._isEqualData(d1[k],d2[k],_ignoreKeys)){
            return
          }
        }
      }
      return 1
    }else{
      return d1==d2
    }
  },
  //check whether o1 after o2;
  _positionAfterElement:function(o1,o2){
    o1=o1.getBoundingClientRect();
    o2=o2.getBoundingClientRect();
    return o1.top>=o2.bottom || (o1.bottom>o2.top && o1.left+o1.width>=o2.right);
  },
  _getWindowFromDom:function(o){
    return o.ownerDocument.defaultView;
  },
  _scrollUpSelectedItem:function(_uiBox,_selectedUI,_diffHeight,_maxMove){
    _diffHeight=_diffHeight||0;
    if(!_uiBox || !_selectedUI){return;}
    _uiBox=$(_uiBox)[0]
    var uiBoxHeight = _uiBox.offsetHeight;
    let d1 = _selectedUI.offsetTop,
        d2=d1+_selectedUI.offsetHeight,
        d3=_uiBox.scrollTop,
        d4=d3+uiBoxHeight;
    if(d1-_diffHeight<d3||d2>d4){
      d1-=_diffHeight
      if(d1>_maxMove){
        d1=_maxMove;
      }
      _uiBox.scrollTop=d1;
      return;
    }
  },
  _selectKeyWordsInInput:function(o){
    var i1=o.value.indexOf("{")
    if(i1>=0){
      o.selectionStart=i1
      var i2=o.value.indexOf("}")+1
      if(i2){
        o.selectionEnd=i2
      }
    }
  },
  _searchValueInJSON:function(j,v,p,ks){
    p=p||""
    ks=ks||[]
    if(j&&[Object,Array].includes(j.constructor)){
      for(var k in j){
        let pk=p?p+"."+k:k
        if(j[k]==v){
          ks.push(pk)
        }else{
          _Util._searchValueInJSON(j[k],v,pk,ks)
        }
      }
    }
    return ks
  },
  _alertMessage:function(_msg){
    if(_msg.includes("The data was updated/locked by other team member")){
      debugger
    }
    if(BZ._isAutoRunning()){
      console.log("BZ-LOG:"+_msg)
      return
    }
    
    if(_bzMessage._system._error[_msg]){
      _msg=_bzMessage._system._error[_msg];
    }

    if($(".alert-msg").toArray().find(a=>{
      if(a.innerText==_msg){
        let v=$(a).attr("repeat")
        if(v){
          v=parseInt(v.split(":")[1])+1
        }else{
          v=1
        }
        $(a).attr("repeat","("+_bzMessage._api._repeat+": "+v+")")
        return 1
      }
    })){
      return
    }
    
    _msg="<div class='alert-msg'>"+_msg+"</div>"


    var _extraPara={};
    for(var i=1;i<arguments.length;i++) {
      var o=arguments[i];
      if ($.isFunction(o)) {
        _extraPara._fun=o;
      }else{
        _extraPara._exception=o;
      }
    }
    var d=_Util._clone(_Dialog),
        _winTagClass="bz-alert-window";
    d._viewDef._items[0]._attr.class+=" "+_winTagClass

    var _dialog={
      _title:_bzMessage._common._message,
      // _modal:true,
      _moveable:true,
      _destroyOnClose:true,
      _buttons:[
        {
          _title:_bzMessage._common._ok,
          _class:"btn btn-primary bz-alert-btn",
          _click:function(){
            d._close()
          }
        }
      ],
      _afterClose:function(){
        _Util._alertContent=""
        if (_extraPara._fun) {
          _extraPara._fun();
        }
      }
    };
    _msg+=_extraPara._exception?"\n\nStack:"+_extraPara._exception.stack:"";
    
    if(!BZ.TW || BZ.TW.closed || BZ.TW.focus || !BZ.TW.document.hasFocus() || _msg.indexOf("</")>0){
      if(_msg.indexOf("</")<0 && _msg.length<=50){
        _msg="<nobr>"+_msg+"</nobr>";
      }
      if(_Util._alertContent && _Util._alertContent!=_msg){
        _msg=_Util._alertContent+"\n<hr/>\n"+_msg
      }
      
      _Util._alertContent=_msg;
      var o=$("<div style='min-width:150px;max-width:100%;word-break:break-all;margin:0;float:left;white-space: pre-wrap;'></div>")
      if(_msg.includes("</html>")){
        o=o.text(_msg);
      }else{
        o=o.html(_msg);
      }
      try{
        d._showMe(o[0],_dialog,window.document.body,_winTagClass);
      }catch(e){}
    }else{
      BZ.TW.alert(_msg);
    }
  },
  _attachResize:function(o,h){
    setTimeout(()=>{
      o=$(o)[0];
      $(o).css({"min-height":"unset"});
      o=_Util._findParentElementByCss(".bz-modal-window",o);
      $(o).css({"max-height":"unset"});
      if(h){
        $(o).css({height:h+"px"})
      }
      _Util._attachResizeWindow(o)
    },100)
  },
  _attachResizeWindow:function(w){
    let o=$("<div class='bz-corner-resize'></div>").appendTo(w)
    let p,wr=w.getBoundingClientRect();
    $(w).css({"max-width":"unset",left:wr.left+"px",top:wr.top+"px",transform:"unset"})
    o.mousedown(function(e){
      let x=this
      o.p=_Util._getMouseXY(e)
      wr=w.getBoundingClientRect()
      e.preventDefault()
      e.stopPropagation()


      let _onmousemove=document.body.onmousemove
      document.body.onmousemove=function(e){
        if(o.p&&e.buttons){
          if(!$(document.body).hasClass("prevent-select")){
            $(document.body).addClass("prevent-select")
          }
          let q=_Util._getMouseXY(e)
          let wl=(q.x-o.p.x),
              wh=(q.y-o.p.y)

          wl+=wr.width
          wh+=wr.height
          $(w).css({width:wl+"px",height:wh+"px"})
        }else{
          o.p=0
          document.body.onmousemove=_onmousemove
          $(document.body).removeClass("prevent-select")
        }
      }
    })
  },
  _confirmMessage:function(_msg,_btns,_title,_width,_noCancel,_cancelFun,_noModal,_body,_noMoreAsk){
    let _loading=_msg
    var d=_Util._clone(_Dialog),
        _winTagClass="bz-confirm-window";
    d._viewDef._items[0]._attr.class+=" "+_winTagClass
    let ww=window.innerWidth*0.618
    if(ww<400){
      ww=400
    }else if(_msg&&_msg.constructor==String){
      ww=Math.min(_msg.split("\n").filter(x=>x).sort((a,b)=>b.length-a.length)[0].length*8,ww)
      if(curUser.language=="cn"){
        ww*=1.5
      }
    }
    _width=(_width||Math.min(ww,600))+"";
    if(!_width.match(/\%/)){
      _width+="px"
    }
    _btns=_btns||[]
    _btns.forEach(b=>{
      b._class=b._class||"btn-primary "+(b._exClass||"")
      b._class+=" bz-left-space-10 btn pull-right"
      b._title=b._title||_bzMessage._method._save
    })
    var _dialog=_CtrlDriver._buildProxy({
      _title:_title?_title:_bzMessage._common._confirm,
      _width:400,
      _height:200,
      _modal:!_noModal,
      _moveable:1,
      _destroyOnClose:true,
      _buttons:_noCancel&&_noCancel!='_close'?[]:[
        {
          _title:_btns.length?_bzMessage._method[_noCancel||!_btns.length?"_close":'_cancel']:_bzMessage._common._close,
          _class:"btn-cancel btn btn-secondary bz-pull-right",
          _style:function(d){
            return "margin-right:5px;"
          },
          _click:function(_this){
            if(_cancelFun){
              if(_cancelFun()===0){
                return
              }
            }
            _this._ctrl._close();
          }
        }
      ]
    });

    var _content=$("<pre class='pull-left bz-dlg-content' style='word-break: break-word;white-space: pre-wrap;max-width:100%;width:100%;margin: 0;'></pre>")
    
    try{
      if(!_body&&window.event&&window.event.target){
        _body=window.event.target.ownerDocument.body
      }
    }catch(e){}
    if(!_body){
      _body=window.document.body
    }
  
    if(_msg.constructor==String){
      _content.html(_msg); 
    }else if(_msg.constructor==Object){
      _msg=_CtrlDriver._execute({},{},_msg,_body);
      _content.append(_msg); 
    }else{
      _content.append(_msg); 
    }
    if(_noMoreAsk){
      _content.append("<label style='display:block;margin:20px 0;'><input type='checkbox' onclick='this.checked?localStorage.setItem(\"BZ:"+_noMoreAsk+"\",1):localStorage.clear()'/>"+_bzMessage._system._info._noMoreAsk+"</label>")
    }
    _content.css({opacity:0,position:"fixed"})
    $(_body).append(_content[0]);
    // $(document.body).append(_content[0]);
    var dm=_Util._getDomSize(_content[0]);
    _dialog._width=_width
    
    _dialog._height=parseInt(dm._height)+150;
    if(_dialog._height>700){
      _dialog._height-=10
    }
    _btns.forEach(b=>{
      b&&_dialog._buttons.unshift(b);
    })
    _dialog=d._showMe(_content[0],_dialog,_body,_winTagClass);
    _content.css({opacity:1,position:"unset"})
    //_Util._resizeModelWindow(_dialog,_body.ownerDocument)
    _waitExe()
    _chkSize()
    function _waitExe(i){
      var _timer=$(_body).find(".bz-dlg-timmer-btn")
      if(_timer[0]){
        var s=_timer.find(".bz-second-num")[0]
        if(!s){
          s=$(_body).find("<span class='bz-second-num'> (31 s)</span>")[0];
          _timer.append(s)
        }
        var v=parseInt(s.innerText.substring(2))-1
        if(!v){
          return _timer.click()
        }
        s.innerText=" ("+v+" s)"
        setTimeout(_waitExe,1000)
      }
    }

    function _chkSize(){
      if(_loading&&_loading._load){
        return setTimeout(()=>{
          _chkSize()
        },100)
      }
      _Util._resizeModelWindow(_dialog,_body.ownerDocument)
    }
  },
  _setMoveWindow:function(_noMove){
    $(".bz-modal-window").toArray().forEach(o=>{
      if(o._data){
        o._data._noMoveable=_noMove
      }
    })
  },
  _closeModelWindow:function(e){
     setTimeout(function(){
      if($(".bz-large-editor")[0]){
        $(".bz-textarea-ctr").click()
      }else if($(".bz-large")[0]){
        $(".bz-ui-switch").click()
      }else{
        while(_dialogList.find((v,i)=>{
          if(v&&!v._noEsc){
            if(!e||(e.target&&(e.target==document.body||v._isSameDlg(e.target)))||$(v).find(e)){
              v._close()
              return v
            }
          }
        })&&Date.now()-_lastCloseDlgTime<50){}
        _lastCloseDlgTime=Date.now()
     }
   },10)
  },
  _gotoPageFromModelWindow:function(v,o){
    BZ._setHash(v)
    _Util._closeModelWindow(o)
  },
  _gotoPageFromModelWindow:function(v,o){
    BZ._setHash(v)
    _Util._closeModelWindow(o)
  },
  _resizeModelWindow:function(o,_doc){
    clearTimeout(_Util._resizeWindowTimer)
    _Util._resizeWindowTimer=setTimeout(function(){
      _doc=_doc||window.document
      let os=$(_doc).find(".bz-modal-window").toArray()
      if(o){
        o=os.find(oi=>{
          return $(oi).find(o).length
        })
        _doIt(o)
      }else if(os.length){
        _doIt(os.pop())
      }
    },10)
    
    function _doIt(o,i){
      i=i||0
      o=$(o)
      let v=o.find(".bz-dlg-content")[0]
      if(v){
        let r=o[0].getBoundingClientRect(),
            wh=_doc.defaultView.innerHeight,_resize;

        if(r.top>wh-r.bottom){
          _resize=wh-r.bottom>20
        }

        o.css({height:"100px"})
        o.css({height:100+v.scrollHeight-v.getBoundingClientRect().height+40+"px"})
        if(!v.innerText&&i<10&&v.getBoundingClientRect().height<10){
          return setTimeout(()=>{
            _doIt(o,i+1)
          },100)
        }
        if(_resize){
          r=o[0].getBoundingClientRect()
          if(r.top>wh-r.bottom){
            if(wh-r.bottom<20){
              o.css({top:r.top-20+wh-r.bottom+"px"})
            }
          }
        }
      }
    }
  },
  _getEndElementsByWord:function(_judgeFun,o,_inHidden,_checkingElement){
    o=$(document.body).find(o).toArray()
    let _last,_hiddens=[];;

    for(let i=0;i<o.length;i++){
      let x=o[i]
      if(_last&&$(_last).find(x)[0]){
        if(_hiddens.includes(_last)){
          if(_judgeFun(x.innerText)){
            _hiddens.push(x)
          }
        }
        o.splice(i--,1)
      }else if(!_judgeFun(x.innerText)){
        o.splice(i--,1)
        _last=x
      }else if(_Util._isHidden(x)){
        _hiddens.push(x)
        o.splice(i--,1)
        _last=x
      }else{
        _last=0
      }
    }
    if(_inHidden){
      _doIt(_hiddens)
      return _hiddens
    }else{
      _doIt(o)
      if(o.length){
        return o
      }
      _doIt(_hiddens)
      return _hiddens
    }
    function _doIt(o){
      _last=o[o.length-1]

      for(let i=o.length-2;i>=0;i--){
        if(!_Util._isCellElement(o[i])&&$(o[i]).find(_last)[0]){
          o.splice(i,1)
        }else{
          _last=o[i]
        }
      }
      // _Util._spliceAll(o,x=>{
        // if(!_Util._isCellElement(x)){
          // for(let i=0;i<x.childNodes.length;i++){
            // let n=x.childNodes[i]
            // if(n.nodeType==3&&_judgeFun(n.textContent||"")){
              // return
            // }
          // }
          // return 1
        // }
      // })
    }
    return o
  },
  //for shadowRoot
  _getRootDom:function(o){
    while(o.parentElement&&o.tagName!="BODY"){
      o=o.parentElement
    }
    return o
  },
  _getElementsByWord:function(_judgeFun,o,_inHidden,_root){
    if(o=="BODY"){
      o=[_root||document.body]
    }else{
      o=$(_root||document.body).find(o).toArray()
    }
    let _last,_hiddens=[];

    for(let i=0;i<o.length;i++){
      let x=o[i]
      if(_last&&$(_last).find(x)[0]){
        if(_hiddens.includes(_last)){
          if(_judgeFun(x.innerText)){
            _hiddens.push(x)
          }
        }
        o.splice(i--,1)
      }else if(!_judgeFun(x.innerText)){
        o.splice(i--,1)
        _last=x
      }else if(_Util._isHidden(x)){
        _hiddens.push(x)
        o.splice(i--,1)
        _last=x
      }else{
        _last=0
      }
    }
    if(_inHidden||!o.length){
      return _hiddens
    }
    return o
  },
  _isStdInputElement:function(v){
    return this._isInputTag(v.tagName) && !["image","button","reset","submit","hidden"].includes(v.type);
  },
  _isEventElement:function(v){
    return _Util._isInputObj(v)||$("[contenteditable=true]").find(v)[0]|| ["OPTION","BUTTON","A"].includes(v.tagName)
  },
  _isCellElement:function(v){
    return _Util._isEventElement(v)
  },
  _isInputTag:function(v){
    return ["INPUT","SELECT","TEXTAREA"].includes(v);
  },
  _popWin:function(url,name,_win,_width,_height,_viewDef,_title){
    var w=_width || screen.availWidth*0.50;
    var h=_height || screen.availHeight*0.50;
    var l=(screen.availWidth-w)/2;
    var t=(screen.availHeight-h)/2;
    if(!_win){
      _win=window;
    }
    w=_win.open(url,name,"width="+w+",height="+h+",left="+l+",top="+t+",resizable=yes");
    
    var d=w.document;
    w.focus();
    var _host=SERVER_HOST;
    if(bzTwComm._isExtension()&&_host.match(/^\/\/[0-9\.]+$/)){
      _host="/"+"/ai.boozang.com"
    }

    

    //Setup css
    if(_Util._style){
      d.write("<style>"+_Util._style+"</style>")
    }else{
      d.write("<link rel='stylesheet' type='text/css' href='"+_host+"/ide/css/js-editor.css'>");
      d.write("<link rel='stylesheet' type='text/css' href='"+_host+"/ide/css/main.max.css'>");
    }
    d.write("<link rel='stylesheet' type='text/css' href='"+_host+"/ide/css/main.icons.css'>");
    d.write("<style>input{font-family: Courier;}\n#_content span{color:blue;}\nul input{border: 0;margin: 2px;}</style>");

    d.write("<link type='image/x-icon' href='"+_host+"/favicon.ico'>");
    d.write("<body style='min-width:unset;overflow:hidden;' class='bz-pop-win'></body>");

    w.BZ=BZ;

    w._IDE=_IDE;
    w._Util=_Util;
    w.$util=$util
    w.root=null;    
    w.$=$;
    
    _Util._handlePrePanel(d)
    
    _Util._setEscWindow(w);
    d.title="BZ - "+_title

    _CtrlDriver._execute({},{},_viewDef,d.body);

    d.insertBefore(d.implementation.createDocumentType('html','',''), d.childNodes[0]);
    setTimeout(function(){
      if(curUser.uiModel){
        $(w.document.body.parentElement).addClass("bz-in-"+curUser.uiModel)
      }
    },10)
    return w
  },
  _checkKeycode:function(e) {
    var _keycode;
    if (window.event) {
      _keycode = window.event.keyCode;
    }else if (e) {
      _keycode = e.which;
    }
    return _keycode;
  },
  _checkCharcode:function(e) {
    e=e||window.event;
    var _keycode=0;
    if (e) {
      _keycode = e.charCode;
    }
    if(!_keycode && e && e.key && e.key.length==1){
      _keycode=e.key.charCodeAt(0)
    }
    return _keycode;
  },
  _getDomXYForDrag:function(obj){
    let _nsSlider=$(obj).css("cursor")=="row-resize"
    let _ewSlider=$(obj).css("cursor")=="col-resize"
    if(obj.defaultView){
      return {x:0,y:0};
    }
    var o=obj.getBoundingClientRect()
    var x=o.x,
        y=o.y,
        t=$(obj).css("transform");
    if(!t||t=="none"){
      if(_nsSlider){
        $(obj).css({top:y+"px"})
      }else if(_ewSlider){
        $(obj).css({left:x+"px"})
      }else{
        $(obj).css({left:x+"px",top:y+"px"})
      }
      o=obj.getBoundingClientRect()
      var x1=o.x,
          y1=o.y;
      
      if(x1!=x||y1!=y){
        x=x+x-x1
        y=y+y-y1
        if(_nsSlider){
          $(obj).css({top:y+"px"})
        }else if(_ewSlider){
          $(obj).css({left:x+"px"})
        }else{
          $(obj).css({left:x+"px",top:y+"px"})
        }
      }
    }
    return {"x":x, "y":y};    
  },
  _getDomXY:function(obj){
    if(obj.defaultView){
      return {x:0,y:0};
    }
    
    var _box = obj.getBoundingClientRect();
    
    if((_box.width==0||_box.height==0)&&(_box.left==0&&_box.top==0)){
      if(_cssHandler._isInShadowDom(obj)){
        _box=obj.parentElement.getBoundingClientRect()
      }
    }
    return {"x":_box.left, "y":_box.top};
  },
  _trimSpace:function(v){
    return v.trim().replace(/\s+/g," ");
  },
  _BZContentToFormatedHtml:function(_view,_step){
    if(_view.tag){
      var _attr=""
      if(_view.id){
        _attr=" id=\""+_view.id+"\"";
      }
      if(_view.tagAttr){
        for(var k in _view.tagAttr){
          _attr+=" "+k+"=\""+_view.tagAttr[k]+"\"";
        }
      }
      var s=_step+"<"+_view.tag+_attr+">\r";
      var v="";
      if(_view.items){
        for(var i=0;i<_view.items.length;i++){
          var vv=_view.items[i];
          v += _Util._BZContentToFormatedHtml(vv,_step+"  ");
        }
      }
      var e=_step+"</"+_view.tag+">\r";
      return s+v+e;
    }else{
      return _step+_view.html+"\r";
    }    
  },  
  _getParentNode:function(_dom,_tag){
    while(_dom.parentNode){
      _dom=_dom.parentNode;
      if(_dom.tagName==_tag){
        return _dom;
      }else if(_dom.tagName=="HTML"){
        return null;
      }
    }
  },
  _objToArray:function(o){
    let a=[];
    Object.keys(o||{}).forEach(x=>{
      a.push({key:x,value:o[x]})
    })
    return a
  },
  _arrayToObj:function(a,k,v){
    let o={};
    k=k||"key";
    v=v||"value";
    (a||[]).forEach(x=>{
      let kk=x[k]
      if(kk===undefined&&!_Util._isObjOrArray(x)){
        kk=x
      }
      o[kk]=x[v]
    });
    return o
  },
  _getMouseOnChild:function(e,_pos){
    var os=e.children,o;
    for(var i=0;i<os.length;i++){
      o=os[i]
      if(!_Util._isHidden(os[i])){
        var e=o.getBoundingClientRect()
        if(_pos.x>=e.left&&_pos.y>=e.top&&_pos.x<=e.right&&_pos.y<=e.bottom){
          if(!$(o).hasClass("BZIgnore")){
            return o
          }
        }else if(o.children){
          var oo=_Util._getMouseOnChild(o,_pos)
          if(oo){
            return oo
          }
        }
      }
    }
  },
  _getMouseOnParent:function(e,_pos){
    while(e.parentElement){
      var o=e.getBoundingClientRect()
      if(_pos.x>=o.left&&_pos.y>=o.top&&_pos.x<=o.right&&_pos.y<=o.bottom){
        return e
      }
      e=e.parentElement
    }
  },
  _getMouseXY:function(e) {
    var _posx = 0;
    var _posy = 0;
    var _doc=e.target.ownerDocument;
    if (e.pageX || e.pageY)   {
      _posx = e.pageX;
      _posy = e.pageY;
    }else if (e.clientX || e.clientY)   {
      _posx = e.clientX;
      _posy = e.clientY;
    }
    _posx -= _doc.scrollingElement.scrollLeft;
    _posy -= _doc.scrollingElement.scrollTop;
    return {x:_posx,y:_posy};
  },
  _convertObj:function(v){
    if(!v){
      return v;
    }
    v=JSON.stringify(v);
    v=_compressJSON._convertToEntities(v);
    return JSON.parse(v);
  },
  _unConvertObj:function(v){
    if(!v){
      return v;
    }
    v=JSON.stringify(v);
    v=_compressJSON._unConvert(v);
    return JSON.parse(v);
  },
  _chkExistDataAttr:function(d,as){
    as.find(a=>{
      if(d[a]){
        if(d[a].constructor==Array){
          return d[a].length
        }else if(d[a].constructor==Object){
          return Object.keys(d[a]).length
        }
        return 1
      }
    })
  },
  _getDomSize:function(_dom){
    var _tmp=false;
    if(!_dom.parentElement){
      _tmp=$("<div></div>").appendTo(document.body)
      $(_dom).appendTo(_tmp);
    }
    var _size={_width:_dom.offsetWidth,_height:_dom.offsetHeight};
    if(_tmp){
      $(_tmp).remove();
    }
    return _size;
  },
  _isNumber:function(v){
    try{
      if(!isNaN(parseFloat(v))){
        return v+""==parseFloat(v)+"";
      }
    }catch(e){
    }
    return false;
  },
  _getScreenXYByClientXY:function(w,x,y){
    x+=4;
    y+=54;
    return {x:x,y:y};
  },
  _getSouElementFromEvent:function(_event,_window){
    if(!_event){
      _event=_window.event;
    }
    if(_event){
      if(_event.srcElement){
        return _event.srcElement;
      }else{
        return _event.target;
      }
    }
    return null;
  },
  _formatInnerText:function(v){
    v=v.replace("\r","\n");
    var vs=v.split("\n");
    var rv="";
    for(var i=0;i<vs.length;i++){
      v=this._replaceAll(vs[i].trim(),/  /g," ");
      if (v) {
        rv+=v+"\n";
      }
    }
    return rv.trim();
  },
  _replaceLast:function(w,r,s){
    if(s=="."){
      s="\\."
    }
    return w.replace(new RegExp(s+"[^"+s+"]+$"),r)
  },
  _replaceAll:function(w,r,v){
    var ww =w.replace(r,v);
    if (ww!=w) {
      return this._replaceAll(ww,r,v);
    }else{
      return ww;
    }
  },
  _isFunIgnoreInBrowser:function(n){
    for(var i=0;i<n.length;i++){
      if(_Util._checkBrowserType().name.includes(n)){
        return 1
      }
    }
  },
  _checkBrowserType:function(){
    var ua= navigator.userAgent, tem,
    M= ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
    if(/trident/i.test(M[1])){
        tem=  /\brv[ :]+(\d+)/g.exec(ua) || [];
        return {name:"ie",version:(tem[1] || "")};
    }
    if(M[1]=== "Chrome"){
        tem= ua.match(/\b(OPR|Edge)\/(\d+)/);
        if(tem!= null) return {name:tem.slice(1).join(" ").replace("OPR", "Opera")};
    }
    M= M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, "-?"];
    if((tem= ua.match(/version\/(\d+)/i))!= null) M.splice(1, 1, tem[1]);
    return {name:M[0],version:M[1],letterWidth:M[0]=="firefox"?9:8};
  },
  _downloadFile:function(_name,_content,_type){
    if(_Util._checkBrowserType().name=="ie"){
      var blobObject = new Blob([_content],_type?{type:_type}:undefined); 
      
      window.navigator.msSaveBlob(blobObject, _name);
    }else{
      var a=$("<a></a>");
      $(document.body).append(a[0]);
      a.attr("download",_name).attr("href","data:application/octet-stream," + encodeURIComponent(_content))[0].click();
      a.remove();
    }
  },
  _downloadAsHtmlFile:function(_name,_content){
    if(!_content.startsWith("<!DOCTYPE html>")){
      _content="<!DOCTYPE html><html><header><meta http-equiv='Content-Type' content='text/html; charset=UTF-8'></header><body>"+_content+"</body></html>"
    }
    if(_Util._checkBrowserType().name=="ie"){
      var blobObject = new Blob([_content]); 
      
      window.navigator.msSaveBlob(blobObject, _name);
    }else{
      var a=$("<a></a>");
      $(document.body).append(a[0]);
      a.attr("download",_name).attr("href","data:application/octet-stream," + encodeURIComponent(_content))[0].click();
      a.remove();
    }
  },
  //w: doc content 
  //n: file name
  _downloadAsWordFile:function(_name,_content){
    let w1="http:/"+"/schemas.microsoft.com/office/2004/12/omml"
    let w2="http:/"+"/www.w3.org/TR/REC-html40"
    let _sourceHTML = `<html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns:m="${w1}" xmlns="${w2}">

      <head>
          <!--[if gte mso 9]><xml><w:WordDocument><w:View>Print</w:View><w:TrackMoves>false</w:TrackMoves><w:TrackFormatting/><w:ValidateAgainstSchemas/><w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid><w:IgnoreMixedContent>false</w:IgnoreMixedContent><w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText><w:DoNotPromoteQF/><w:LidThemeOther>EN-US</w:LidThemeOther><w:LidThemeAsian>ZH-CN</w:LidThemeAsian><w:LidThemeComplexScript>X-NONE</w:LidThemeComplexScript><w:Compatibility><w:BreakWrappedTables/><w:SnapToGridInCell/><w:WrapTextWithPunct/><w:UseAsianBreakRules/><w:DontGrowAutofit/><w:SplitPgBreakAndParaMark/><w:DontVertAlignCellWithSp/><w:DontBreakConstrainedForcedTables/><w:DontVertAlignInTxbx/><w:Word11KerningPairs/><w:CachedColBalance/><w:UseFELayout/></w:Compatibility><w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel><m:mathPr><m:mathFont m:val="Cambria Math"/><m:brkBin m:val="before"/><m:brkBinSub m:val="--"/><m:smallFrac m:val="off"/><m:dispDef/><m:lMargin m:val="0"/> <m:rMargin m:val="0"/><m:defJc m:val="centerGroup"/><m:wrapIndent m:val="1440"/><m:intLim m:val="subSup"/><m:naryLim m:val="undOvr"/></m:mathPr></w:WordDocument></xml><![endif]-->

          <meta charset='utf-8'/>
          <title>${_name}</title>
          <style>
          @page {
            size: 4in 6in landscape;
          }
          @media print {
            html, body {
              width: 210mm;height: 297mm;
            }
          }
          page[size="A4"] {
            background: white;
            width: 21cm;
            height: 29.7cm;
            display: block;
            margin: 0 auto;
            margin-bottom: 0.5cm;
            box-shadow: 0 0 0.5cm rgba(0,0,0,0.5);
          }
tbody td:first-child,tbody td:last-child{
  text-align:center;
}
          </style>
      </head>
      <body>${_content}</body></html>`;
     
     var source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(_sourceHTML);
     var _fileDownload = document.createElement("a");
     document.body.appendChild(_fileDownload);
     _fileDownload.href = source;
     _fileDownload.download = _name;
     _fileDownload.click();
     document.body.removeChild(_fileDownload);
  },
  _downloadAsPdfFile:function(title,o) {
    let w= window.open('', 'PRINT', 'height=650,width=900,top=100,left=150');
    let d=w.document,
        _txt=`<html><head><title>${title}</title></head><body>${o}</body></html>`;
    d.write(_txt);

    d.close(); // necessary for IE >= 10
    w.focus(); // necessary for IE >= 10
    setTimeout(function(){
      w.print();
      w.close();
    },100)

    return true;
  },
  _downloadAsZip:function(_files,_zipFileName,_fun){
    zip.createWriter(new zip.BlobWriter("application/zip"), function(_zipWriter) {
      _addFile(_zipWriter,0)
    }, function(_msg){
      alert(_msg)
    });

    function _addFile(_zipWriter,i){
      let f=_files[i]
      if(f){
        _zipWriter.add(f._name, new zip.BlobReader(f._data), function() {
          _addFile(_zipWriter,i+1)
        });
      }else{
        _zipWriter.close(function(blob) {
					var blobURL =URL.createObjectURL(blob);
          var _clickEvent = document.createEvent("MouseEvent");
          _clickEvent.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
          let _downloadButton=$("<a></a>").appendTo(document.body)[0]
          
          _downloadButton.href = blobURL;
          _downloadButton.download = _zipFileName;
          _downloadButton.dispatchEvent(_clickEvent);
					zipWriter = null;
          $(_downloadButton).remove()
				});
      }
    }
  },
  _getDomsByTagAndName:function(tag,name){
    if(BZ._autoRecording){
      return []
    }
    return BZ._documents?BZ._documents.find(tag+"[name='"+name+"']"):[];
  },
  _removeAllLinkTarget:function(){
    $("A").toArray().forEach(a=>{
      _Util._removeLinkTarget(a)
    })
  },
  _setUrlFileToInput:function(_url,e){
    _domActionTask._fetchFileDataFromURL(_url,function(v){
      BZ._setTimeout(function(){
        $util.triggerChangeEvent(e,v,1);
      },100)
    })
  },
  _removeLinkTarget:function(e){
    while(e){
      if(e.tagName=="A"){
        if($(".BZIgnore").find(e)[0]){
          return
        }
        var _target=$(e).attr("target");
        if(_target){
          if(_target!='_'+'parent'&&_target!='_'+'top'&&!_Util._getDomsByTagAndName("IFRAME",_target).length){
            $(e).attr("target","_"+"self")
          }
        }else{
          $(e).attr("target","_"+"self")
        }
        /*
        if(e.href.startsWith(location.protocol){
          var n=e.href.split("/"+"/")[1];
          var c=location.hostname;
          if(e.href.split("/"+"/")[1]!=location.hostname){
            e.href=e.href.replace("/"+"/"+e.href.split("/"+"/")[1],"/"+"/"+location.hostname)
          }
        }
        */
      }
      if(e!=e.parentElement){
        e=e.parentElement;
      }else{
        return;
      }
    }
  },
  _toKey:function(v){
    v= v?v.replace(/[^a-zA-Z0-9_.]/g,"_"):"";
    if(v && v.match(/^[0-9.]/)){
      v="_"+v;
    }
    while(v.indexOf("..")>=0){
      v=v.replace("..",".");
    }
    if(v && v[v.length-1]=="."){
      v=v.substring(0,v.length-1);
    }
    return v.toLowerCase();
  },
  /*
  _formatPeriod:function(v){
    v=parseInt(v/1000);
    var h=parseInt(v/3600);
    v-=h*3600;
    var m=parseInt(v/60);
    v-=m*60;
    
    m=m<10?"0"+m:m;
    v=v<10?"0"+v:v;
    return h?h+":"+m+":"+v:parseInt(m)?parseInt(m)+":"+v:parseInt(v)+" s";
  },
  */
  _formatNumberLength:function(v,l){
    return (v+"").padStart(l||2,0);
  },
  _getAngularModelAttr:function(o){
    var _tmp=null;
    var _curWin=_Util._getWindowFromDom(o);
    if(_curWin.angular){
      var _scope=_curWin.angular.element(o).scope();
      if(_scope){
        for(var n=0;n<o.attributes.length;n++){
          var a=o.attributes[n];
          try{
            var _model=a.value.split(".");
            var _variable=_scope;
            for(var x=0;x<_model.length;x++){
              _variable=_variable[_model[x]];
            }
            if(_variable!=undefined || x>1){
              _tmp= a;
              if(a.name.indexOf("-model")>=0){
                break;
              }
            }
          }catch(e){}
        }
      }
    }
    return _tmp;
  },
  _retrieveFileName:function(v){
    v=v.replace(/[^-_ a-zA-Z0-9]/g,"\t").trim();
    v=v.split("\t");
    return v[v.length-2];
  },
  _retrieveCssProperty:function(e,_extra,_name){
    return window.getComputedStyle(e,_extra).getPropertyValue(_name);
  },
  _retrieveCssProperties:function(e,_extra,_names){
    if(_extra==true){
      _extra=":before"
    }else if(_extra){
      _extra=":after"
    }
    var c=window.getComputedStyle(e,_extra);
    var vs=[];
    for(var i=0;i<_names.length;i++){
      vs.push(c.getPropertyValue(_names[i]));
    }
    if(!_extra || _extra==":after"){
      return vs;
    }else{
      return vs.concat(this._retrieveCssProperties(e,_extra,_names));
    }
  },
  _pickAttrFromArray:function(vs,_name){
    var ps=[];
    for(var i=0;i<vs.length;i++){
      ps.push(vs[i][_name]);
    }
    return ps;
  },
  _getRealWord:function(o,v){
    if(o.maxLength<0){
      return v;
    }else{
      return v.substring(0,o.maxLength);
    }
  },
  _buildRefPath:function(n,k){
    var m=k.match(/[a-z_$][a-z0-9_$]*/i);
    if(m && m[0]==k){
      return n+"."+k;
    }else{
      return n+"['"+k+"']";
    }
  },
  _pickValuePath:function(d,_name){
    var ps=[];
    _name=_name||"";
    for(var k in d){
      var v=d[k];
      if(v){
        if(v.constructor==Object){
          ps.concat(this._pickObjPath(v,_name+"."+k))
        }else if(v.constructor==Array){
          
        }else{
          ps.push(_name+"['"+k+"']")
        }
      }
    }
    return ps;
  },
  _toSBC:function(v){
    var s = "",_len = (v||"").length;
    for(var i=0;i<_len;i++){
        var c = v.charCodeAt(i);
        if("“”".includes(v[i])){
          c=34;
        }else if("‘’".includes(v[i])){
          c=39;
        }
        c = (c>=0xFF01 && c<=0xFF5E)?(c - 65248) : c;
        c = (c==0x03000)?0x0020:c;
        s += String.fromCharCode(c);
    }
    return s;
  },
  _cleanObj:function(o){
    if(o){
      for(let k in o){
        delete o[k]
      }
    }
  },
  _cleanArray:function(vs){
    var v="";
    if(vs){
      for(var i=0;i<vs.length;i++){
        var v=vs[i].trim();
        if(v){
          vs[i]=v;
        }else{
          vs.splice(i,1)
        }
      }
    }
    return vs;
  },
  _clearEmptyAttr:function(o){
    let ks=Object.keys(o);
    ks.forEach(k=>{
      if(!o[k]&&o[k]!==0){
        delete o[k];
      }else if(_Util._isObjOrArray(o[k])){
        this._clearEmptyAttr(o[k])
      }
    })
  },
  _getAttributeCss:function(e,v,bv){
    if(!e.attributes){
      return ""
    }
    var o;
    for(var i=0;i<e.attributes.length;i++){
      var a=e.attributes[i];
      
      if(a.value.trim() && (!v || a.value.toLowerCase().includes(v.toLowerCase()))){
        var n=a.name.toLowerCase();
        if(n.match(/title|label/)){
          o=a;
          break;
        }else if(n.includes("alt")){
          o=a;
        }else if(n=="placeholder" && !o){
          o=a;
        }else if(n=="name" && !o){
          o=a;
        }
      }
    }
    if(o && !v){
      v=o.value.split("\n")[0].trim().substring(0,50)
    }else if(o && bv){
      v=bv;
    }
    return o && v?_Util._getAttrPath(o.name,v):""
  },
  _getDataPathByValue:function(d,v){
    var r,t;
    for(var k in d){
      t=d[k];
      if([Object].includes(t.constructor)){
        r=this._getDataPathByValue(t,v);
        if(r){
          return k+"."+r
        }
      }else if(t==v){
        return k;
      }
    }
  },
  _getAllVisableElements:function(){
    let hs=[]
    let os=($(document.body).find("*").toArray().filter(x=>{
      if(["file","checkbox","radio"].includes(x.type)){
        return 1
      }
      let r=x.getBoundingClientRect()
      if(r.width&&r.height&&$(x).css("visibility")!="hidden"&&$(x).css("opacity")!=0){
        if(r.left+r.width>0&&r.top+r.height>0){
          return 1
        }else{
          let p=$(x).css("position")
          if(p=="fixed"||p=="absolute"){
            hs.push(p)
            return
          }else{
            return !$(hs).find(p)[0]
          }
        }
      }
      //&&!$(x).hasClass("BZIgnore")//&&!bs.has(x)
    }));
    return os
  },
  _clearPreEventElements:function(){
    delete _Util.preEventElements
  },
  _getAllVisableElementsInJQ:function(){
    return $(_Util._getAllVisableElements())
  },
  _preTriggerEvent:function(){
    _Util.preEventElements=new Set(_Util._getAllVisableElements())
  },
  _getDiffAfterTriggerEvent:function(_continuePreTriggerEvent,_keepPreEventElements){
    let os=_Util._getAllVisableElements();
    let ps=_Util.preEventElements
    if(_continuePreTriggerEvent){
      if(!_keepPreEventElements||!ps){
        _Util.preEventElements=new Set(os)
      }
    }else{
      delete _Util.preEventElements
    }
    if(ps){
      os=os.filter(x=>!ps.has(x))
    }else{
      return []
    }
    return os
  },
  _getNewPanelFromNewElements:function(os){
    return os.find(o=>{
      return $(o).find(os).length>os.length/2
    })
  },
  _removeEndSign:function(v){
    var w="";
    for(var i=0;i<v.length;i++){
      var vv=v[i];
      var x=this._removeSign(vv,"");
      if(x){
        v=v.substring(i)
        break;
      }
    }
    if(i==v.length){
      return v;
    }
    for(var i=v.length-1;i>=0;i--){
      var vv=v[i];
      var x=this._removeSign(vv,"");
      if(x){
        v=v.substring(0,i+1);
        break;
      }
    }
    return v;
  },
  //v: words, it will be handle
  //r: replace word
  //k: keep sign
  //like: _removeSign("abc,xyz-网站  é#è&^êë"," ","-") --> "abc xyz-网站 é è  êë"
  _removeSign:function(v,r,k,_removeUnderscroe){
    r=r||"";
    k=k||"";
    v=this._toSBC(v);
    v= v.replace(/[^\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC\s$-]/g,r); 
    if(_removeUnderscroe){
      v=v.replace("_",r)
    }
    if(!k.includes("-")){
      v=v.replace(/\-/g,r)
    }
    if(!k.includes("$")){
      v=v.replace(/\$/g,r)
    }
    if(!k.includes(" ")&&r!=" "){
      v=v.replace(/ /g,r)
    }
    
    if(r==" "){
      v=v.replace(/\s+/g,r)
    }

    return v.trim()
  },
  //output function code
  _toString:function(os,n,_mini){
    var s="{";
    for(var k in os){
      var o=os[k];
      s+=k+":"
      if(!o){
        s+=o;
      }else if(o.constructor==Function){
        s+=o.toString()
      }else{
        try{
          s+=JSON.stringify(o)
        }catch(e){
          throw e;
        }
      }
      s+=","
    }
    s=s.substring(0,s.length-1)+"};";
    if(_mini){
      s=_JSHandler._cleanCode(s)
    }
    if(n){
      s="var "+n+"="+s;
    }
    return s;
  },
  _setFun:function(o,e,f){
    o=$(window.document).find(o);
    for(var i=0;i<o.length;i++){
      o[i][e]=f;
    }
  },
  _shareArray:function(a1,a2){
    a1=a1||[];
    a2=a2||[];
    if(a1.constructor!=Array){
      a1=[a1];
    }
    if(a2.constructor!=Array){
      a2=[a2];
    }
    var a=[];
    a1.forEach(function(v){
      if(a2.includes(v)){
        a.push(v);
      }
    });
    return a;
  },
  //o: old data, n: new data
  //_ignore: ignore data function
  //p: data key path
  _getSimpleDiffInJson:function(o,n,_ignore,_diffs,p){
    _diffs=_diffs||[]
    p=p||""
    let _found;
    if(o&&n&&o.constructor==n.constructor&&[Array,Object].includes(o.constructor)){
      if(o.constructor==Array){
        if(!o.length){
          if(n.length){
            _diffs.push({
              key:p,
              from:o,
              to:n
            })
          }
        }else if(!n.length){
          _diffs.push({
            key:p,
            from:o,
            to:n
          })
        }else if(o[0].code||o[0].key){
          if(o.length==n.length){
            o.forEach((x,i)=>{
              if(!n.find((y,yi)=>{
                if((y.code&&y.code==x.code)||(y.key&&y.key==x.key)){
                  if(i!=yi){
                    _diffs.push({
                      key:p,
                      from:i,
                      to:yi,
                      order:1
                    })
                  }else{
                    _Util._getSimpleDiffInJson(x,y,_ignore,_diffs,p+"."+i)
                  }
                  return 1
                }
              })){
                _diffs.push({
                  key:p+"."+i,
                  from:x
                })
              }
            })
          }else if(o.length>n.length){
            let ds=[]
            o.forEach((x,i)=>{
              if(!n.find(y=>{
                if((y.code&&y.code==x.code)||(y.key&&y.key==x.key)){
                  _Util._getSimpleDiffInJson(x,y,_ignore,ds,p+"."+i)
                  return 1
                }
              })){
                ds.push({
                  key:p+"."+i,
                  from:x
                })
              }
            })
            ds.reverse()
            _diffs.push(...ds)
          }else{
            let ds=[]
            n.forEach((x,i)=>{
              if(!o.find(y=>{
                if((y.code&&y.code==x.code)||(y.key&&y.key==x.key)){
                  _Util._getSimpleDiffInJson(y,x,_ignore,ds,p+"."+i)
                  return 1
                }
              })){
                ds.push({
                  key:p+"."+i,
                  to:x
                })
              }
            })
            ds.reverse()
            _diffs.push(...ds)
          }
        }else if(o.length!=n.length){
          let no=o[0]||n[0]
          if(!no.key||!no.code){
            _diffs.push({
              key:p,
              from:o,
              to:n
            })
          }else{
            let _dIdx=0
            if(o.length>n.length){
              for(let k in o){
                let ds=[]
                _Util._getSimpleDiffInJson(o[k],n[parseInt(k)+_dIdx],_ignore,ds,p+"."+k)
                if(ds.length){
                  _diffs.push({
                    key:p+"."+k,
                    from:o[k]
                  })
                  _dIdx++
                  if(o.length==n.length+_dIdx+1){
                    break
                  }
                }
              }
            }else{
              for(let k in n){
                let ds=[]
                _Util._getSimpleDiffInJson(n[k],o[parseInt(k)+_dIdx],_ignore,ds,p+"."+k)
                if(ds.length){
                  _diffs.push({
                    key:p+"."+k,
                    to:n[k]
                  })
                  _dIdx++
                  if(o.length==n.length+_dIdx+1){
                    break
                  }
                }
              }
            }
          }
        }else{
          o.forEach((x,i)=>{
            _Util._getSimpleDiffInJson(x,n[i],_ignore,_diffs,p+"."+i)
          })
        }
      }else{
        for(let k in n){
          if(_ignore&&_ignore(k,p,o[k],n[k])){
            continue
          }
          _Util._getSimpleDiffInJson(o[k],n[k],_ignore,_diffs,p+"."+k)
        }
        for(let k in o){
          if(_ignore&&_ignore(k,p,n[k],o[k])){
            continue
          }
          if(!Object.keys(n).includes(k)){
            _diffs.push({
              key:p+"."+k,
              from:o[k]
            })
          }
        }
      }
    }else if(o!=n){
      _diffs.push({
        key:p,
        from:o,
        to:n
      })
    }
    return _diffs
  },
  _formatDiffJson:function(v1,v2,s){
    let w1="",w2="";
    s=s||""
    let ss=s+"  "

    if(v1&&v2&&v1.constructor==v2.constructor){
      if(v1.constructor==Object){
        w1+="{\n";w2+="{\n";
      }else if(v1.constructor==Array){
        w1+="[\n";w2+="[\n";
      }else{
        v1=JSON.stringify(v1);
        v2=JSON.stringify(v2);
        if(v1!==v2){
          v1=_highlight(v1);
          v2=_highlight(v2);
        }

        return {w1:v1,w2:v2}
      }
      Object.keys(v1).forEach(k=>{
        if(v1[k]!==undefined){
          let v=_Util._formatDiffJson(v1[k],v2[k],ss)
          w1+=ss;
          w2+=ss;
          if(v1.constructor==Object){
            w1+='"'+k+'": '
            w2+='"'+k+'": '
          }
          w1+=v.w1+",\n";
          w2+=v.w2+",\n";
          w1=_addLine(w1,w2);
          w2=_addLine(w2,w1);
        }
      })
      Object.keys(v2).forEach(k=>{
        if(v1[k]===undefined){
          let v=_Util._formatDiffJson(v1[k],v2[k],ss)
          w1+=ss;
          w2+=ss;
          if(v1.constructor==Object){
            w1+='"'+k+'": '
            w2+='"'+k+'": '
          }
          w1+=v.w1+",\n";
          w2+=v.w2+",\n";
          w1=_addLine(w1,w2);
          w2=_addLine(w2,w1);
        }
      })
      w1=w1.replace(/(,)(\n*)$/,"$2")
      w2=w2.replace(/(,)(\n*)$/,"$2")
      w1+=s;
      w2+=s;
      if(v1.constructor==Object){
        w1+="}";
        w2+="}";
      }else{
        w1+="]";
        w2+="]";
      }
    }else{
      w1=_formatJsonWithIndent(v1,ss);
      w2=_formatJsonWithIndent(v2,ss);
      if(v1!==v2){
        w1=_highlight(w1);
        w2=_highlight(w2);
      }
    }
    return {w1:w1,w2:w2}

    function _addLine(w1,w2){
      return w1+"\n".repeat(Math.max(w2.split("\n").length-w1.split("\n").length,0))
    }

    function _highlight(v){
      return `<span style="background-color:var(--bz-warning);color:#000;">${v}</span>`
    }
    function _formatJsonWithIndent(v,s){
      v=JSON.stringify(v,0,2)||""
      return v.replace(/^/gm,s).trim()
    }

  },
  _strToObj:function(vv){
    let v=vv||""
    if(v.constructor==String){
      v=v.trim()
      if(v.match(/(^\[.*\]$)|(^\{.*\}$)/s)){
        try{
          v=_Util._eval("v="+v)
          return v
        }catch(e){}
      }
    }
    return vv
  },
  _getDiffArray:function(a1,a2){
    var vs=[]
    for(var i=0;i<a1.length;i++){
      if(!a2.includes(a1[i])){
        vs.push(a1[i])
      }
    }
    for(var i=0;i<a2.length;i++){
      if(!a1.includes(a2[i])){
        vs.push(a2[i])
      }
    }
    return vs;
  },
  fetchBlob:function(uri, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', uri, true);
    xhr.responseType = 'arraybuffer';

    xhr.onload = function(e) {
      if (_Util._isAPISucessStatus(this.status)) {
        var blob = this.response;
        if (callback) {
          callback(blob);
        }
      }
    };
    xhr.send();
  },
  _mergeURL:function(r,_url){
    _url= _url||"";
    r=r.trim()
    if(r && !_url.startsWith(r) && !_url.startsWith("http") && !_url.startsWith("/"+"/")){
      if(!_url){
        _url=r
      }else if(r.endsWith("/") && _url[0]=="/"){
        _url=r+_url.substring(1);
      }else if(!r.endsWith("/") && _url[0]!="/"){
        _url=r+"/"+_url;
      }else{
        _url=r+_url;
      }
    }
    return _url
  },
  _mergeDeep:function(_target, ..._sources) {
    if (!_sources.length) return _target;
    const _source = _sources.shift();

    if ((_target&&_target.constructor==Object) && (_source&&_source.constructor==Object)) {
      for (const _key in _source) {
        var o=_source[_key]
        if (o&&o.constructor==Object) {
          if(!_target[_key]||_target[_key].constructor!=Object){
            _target[_key]={}
          }
          _Util._mergeDeep(_target[_key], _source[_key]);
        } else if(!_target[_key]||_target[_key].constructor!=Function){
          _target[_key]=_source[_key];
        }
      }
    }

    return _Util._mergeDeep(_target, ..._sources);
  },
  _mergeDeepWithArray:function(_target, ..._sources) {
    if (!_sources.length) return _target;
    const _source = _sources.shift();

    if ((_target&&_target.constructor==Object) && (_source&&_source.constructor==Object)) {
      for (const _key in _source) {
        var o=_source[_key]
        if(o&&o.constructor==Array&&_target[_key]&&_target[_key].constructor==Array){
          _target[_key].push(...o)
        }else if (o&&o.constructor==Object) {
          if(!_target[_key]||_target[_key].constructor!=Object){
            _target[_key]={}
          }
          _Util._mergeDeepWithArray(_target[_key], _source[_key]);
        } else if(!_target[_key]||_target[_key].constructor!=Function){
          _target[_key]=_source[_key];
        }
      }
    }

    return _Util._mergeDeepWithArray(_target, ..._sources);
  },
  _clearAttributes:function(o){
    for(var k in o){
      if(!o[k]){
        delete o[k]
      }
    }
  },
  _findInInsensitive:function(r,p,_tmpPanel){
    try{
      if(_tmpPanel&&_tmpPanel.includes("BZ.TW")){
        _tmpPanel=0
      }
      return r&&r.find(p,_tmpPanel)
    }catch(e){
      _domActionTask._reportAppInfo("Error on findInInsensitive: "+e.message)
      return r.find(_Util._updateAttrSelector(p))
    }
  },
  _getAttrPath:function(n,v){
    return ":attr("+n+"="+_Util._trimSpace(v.replace(/[\(\)\{\}\[\]]/g," "))+")"
  },
  _updateAttrSelector:function(v){
    return v.replace?v.replace(/(\[)([^=]+)(\=)([\"\']*)([^\]\"\']+)([\"\']*)( *)(i*)(\])/g,":attr($2$3$5)"):v
  },
  _getElementByXY:function(b,x,y,_ignoreElement){
    var _last;
    for(var i=0;i<b.children.length;i++){
      var o=b.children[i];
      var r=o.getBoundingClientRect();
      if(r.x<=x && r.x+r.width>=x && r.y<=y && r.y+r.height>=y){
        if(o!=_ignoreElement){
          _last=o;
        }
      }
      _last=this._getElementByXY(o,x,y,_ignoreElement)||_last;
    }
    return _last;
  },
  _isBetweenWords:function(w,i){
    if(w){
      if(i){
        w=w[0]
      }else{
        w=w[w.length-1]
      }
      return !w.match(/[a-z0-9]/i)
    }
    return 1
  },
  _splitWords:function(w,s){
    w=w.trim()
    s=s||"\n;,"
    for(var i=0;i<s.length;i++){
      if(w.includes(s[i])){
        s= w.split(s[i]);
        w=[]
        for(var i=0;i<s.length;i++){
          var ss=s[i].trim()
          if(ss){
            w.push(s)
          }
        }
        return w
      }
    }
    return [w]
  },
  _isDynamicValue:function(v){
    v=v.match(/[0-9]+/g);
    return !(!v || (v.length==1 && parseInt(v[0])<3))
  },
  _setBlankIFramePath:function(p,e){
    if(e.ownerDocument!=document){
      for(var i=0;i<window.frames.length;i++){
        if(window.frames[i]==e.ownerDocument.defaultView){
          p[0]="$(BZ.TW.document.body).find('IFRAME:eq("+i+")')[0].contentDocument"
        }
      }
    }
  },
  _findDomsWithSimplySolution:function(ps){
    let o=document.body,os,_lastX;
    try{
      ps.find(x=>{
        x=x||0
        if(x!="BZ.TW.document"){
          if(os&&os.toArray()){
            os=os.toArray()
            _Util._spliceAll(os,x=>_Util._isHidden(x))
            os=$(os)
          }
          if(os===undefined){
            if(x.match(/^body\>/i)){
              o=document
            }
            let xs=_matchTRTD(x,$(BZ.TW.document.body))
            if(xs){
              os=xs
              _lastX=x
              return
            }
            os=$(o).find(x)
          }else if(x&&!$.isNumeric(x)){
            let xos=[],_idx
            
            let xs=_matchTRTD(x,os)
            if(xs){
              os=xs
              _lastX=x
              return
            }
            if(x.match(/\:(eq\([0-9]+\)|last|first)$/)){
              x=x.split(":")
              _idx=x.pop()
              x=x.join(":")
            }
            if(_lastX.match(/contains/i)){
              os=os.toArray()
              let rs=[]
              while(os.length){
                let oo=os.pop();
                rs.push(oo)
                let xo=$(oo).find(x).toArray()
                if(xo.length){
                  xo.reverse()
                  xo.forEach(y=>{
                    xos.unshift(y)
                  })

                  _Util._spliceAll(os,xx=>$(xx).find(oo).length)
                }
              }
              while(!xos.length&&rs.length&&rs[0]&&rs[0].tagName!="BODY"){
                rs=rs.map(r=>r.parentElement)
                rs.forEach(r=>{
                  if(r){
                    let xo=$(r).find(x)
                    if(xo.length){
                      xo.reverse()
                      xo.forEach(y=>{
                        xos.unshift(y)
                      })
                    }
                  }
                })
              }
              os=$(xos)
            }else{
              os=os.find(x)
            }
            if(os.length){
              if(_idx=="first"){
                os=[os[0]]
              }else if(_idx=="last"){
                os=[os[os.length-1]]
              }else if(_idx){
                os=[os[_idx.match(/[0-9]+/)]]
              }
              if(_idx){
                os=$(os)
              }
            }
          }else if(os.length){
            if(_lastX.match(/contains/i)){
              os=os.toArray()
              let xo=[],lo
              while(os.length){
                let oo=os.pop();
                xo.unshift(oo)
                
                _Util._spliceAll(os,xx=>$(xx).find(oo).length)
              }
              os=xo
            }
            if(os[x]){
              os=[os[x]]
            }else{
              os=0
              return 1
            }
          }
          _lastX=x
        }
      })
    }catch(e){}
    return _Util._isEmpty(os)?0:os
    
    function _matchTRTD(x,os){
      if(x.match(/\>[a-zA-Z]+\:(eq\(|last|first|Contains|attr|endContains|equal)/)||x.match(/\>[a-zA-Z]+$/)||x.match(/\>[a-zA-Z]+[.#]/)){
        x=x.split(">")
        let ss=os
        x.forEach(y=>{
          ss=ss.find(y)
        })
        os=ss.toArray()
        return os
      }
      
    }
  },
  _formatFun:function(s,t){
    t=t||""
    let f="\"'`/",b,fs=[],w="",
        k={
          "(":")",
          "[":"]",
          "{":"}"
        },ks=[],_newLine;
    for(let i=0;i<s.length;i++){
      let c=s[i]
      if(c=="\\"){
        b=1
      }else if(b){
        b=0
      }else if(c=="\r"){
        continue
      }else if((c==" "||c=="\t")&&_newLine){
        continue
      }else if(f.includes(c)){
        if(fs[0]==c){
          fs.shift()
        }else{
          fs.unshift(c)
        }
      }else if(!fs.length){
        if(k[c]){
          ks.unshift({k:c,i:i})
          if(c=="{"){
            w+=c+"\n"
            _newLine=1
            t+="  "
            w+=t
            while(s[i+1]&&s[i+1].match(/\s/)){
              i++
            }
            continue
          }
        }else if(ks[0]&&k[ks[0].k]==c){
          let ck=ks.shift()
          if(c=="}"){
            t=t.substring(2)
            if(_newLine){
              w=w.trim()
            }
            w+="\n"+t+c
            while(s[i+1]&&s[i+1].match(/\s/)){
              i++
            }
            continue
          }
        }else if(c==";"&&(!ks[0]||ks[0].k=="{")){
          w+=c+"\n"+t
          _newLine=1
          while(s[i+1]&&s[i+1].match(/\s/)){
            i++
          }
          continue
        }
      }
      w+=c
      _newLine=c=="\n"
      if(_newLine){
        w+=t
      }
    }
    return w
  },
  _isFunction:function(s){
    s=s.trim()
    return s.match(/^\(?(function|\([^\)]*\) *=> *)/)
  },
  _newFindDom:function(){
    document._Contains=document._input=document._link=document._near=document._after=document._before=document._endContains=document._rowcol=0
  },
  _findDoms:function(_paths,_errOnHidden,_bRetry,_toShow){
    _extendJQuery()
    _Util._newFindDom()
    if(_paths.constructor==String){
      _paths=_paths.split("\n")
    }
    if(bzTwComm._isExtension()){
      let p=_paths[0]
      if(p&&p.constructor==String&&p.includes("frame")){
        _paths[0]="BZ.TW.document"
      }else if(p&&p.constructor==String&&!p.includes("BZ.TW.document")){
        _paths.unshift("BZ.TW.document")
      }
    }
    _paths=_JSHandler._prepareData(_Util._clone(_paths));
    if(!_paths){
      return
    }
    let _showIdx=_toShow?-1:_paths.findIndex(x=>x&&x.match&&x.match(/:show([\:\.\[\#]|$)/))
    if(_showIdx!=-1){
      let xs=_paths.splice(_showIdx+1)
      let oo=_Util._findDoms(_paths,_errOnHidden,_bRetry,1)
      oo.forEach(y=>{
        if(_Util._isHidden(y)&&!y.getBoundingClientRect().width){
          y._bzShow=1
          $(y).show()
        }
      })
      _paths.push(...xs)
      let o=_Util._findDoms(_paths,_errOnHidden,_bRetry,1)
      
      oo.forEach(y=>{
        if(y._bzShow){
          delete y._bzShow
          $(y).css({display:""})
        }
      })
      return o
    }

    let _orgPath=_Util._clone(_paths)
    
    var os,_root,_cells,_osInHidden=[]
    if(!_paths.find(x=>{
      return !$.isNumeric(x)&&(x.includes("shadowRoot")||x.match(/^canvas:/i))
    })&&_paths.find(x=>{
      return !$.isNumeric(x)&&x.match(/\:(first|last|eq)/)
    })){
      os=_Util._findDomsWithSimplySolution(_paths)
      if(os&&os.length){
        if(os.toArray){
          os=os.toArray()
        }
        return os
      }
      os=0
    }

    // let _idx=_paths.pop()||0;
    // if(!$.isNumeric(_idx)){
      // _paths.push(_idx)
      // _idx=null
    // }

    let _idx=null;
    _paths=_paths.filter(x=>{
      if($.isNumeric(x)){
        _idx=parseInt(x)
      }else{
        return 1
      }
    })

    let _sufIdx=_paths[_paths.length-1]
    if(!$.isNumeric(_sufIdx)){
      //for :input
      if(_paths.length>2&&_sufIdx.match(/:input\(/)){
        _paths.pop()
        _paths=_Util._findDoms(_paths);
        let os=[]
        _paths.forEach(x=>{
          $util._tmpFormForSearchingInput=x
          os.push(...$(x).find(_sufIdx).toArray())
        })
        if(os.length&&_idx!==undefined){
          os=[os[_idx||0]]
        }
        return os
      }
      //for quick path
      if(_sufIdx.match(/^body\>[^\>]+\>/i)){
        return [_Util._getElementByQuickPath(_sufIdx)]
      }
      _sufIdx=_sufIdx.split(":").pop()
      
      if(!_sufIdx.match(/last|first/)){
        _sufIdx=0
      }else{
        _paths[_paths.length-1]=_paths[_paths.length-1].replace(/[:](last|first)$/,"")
      }
    }

    try{
      if (_paths && _paths.length>0 && (!window.BZ || BZ._documents || BZ._autoRecording)) {
        //for shadowRoot
        while(_paths.includes("shadowRoot")){
          if(os){
            let tmp=_paths.shift();
            if(tmp=="shadowRoot"){
              for(var i=0;i<os.length;i++){
                if(os[i].shadowRoot){
                  os=_root=$(os[i].shadowRoot)
                  break
                }
              }
            }else{
              os=_root=os.find(tmp)
            }
          }else{
            let ps=_paths.splice(0,_paths.indexOf("shadowRoot"))
            os=_Util._findDoms(ps)
            for(var i=0;i<os.length;i++){
              if(os[i].shadowRoot){
                os=_root=$(os[i].shadowRoot)
                break
              }
            }
            _paths.shift()
          }
        }
        if(!os){
          os=_paths[0];
          if(os.constructor==String){
            if(os=="BZ.TW.document"){
              os=_root=$(document);
            }else{
              os=_root=$(_Util._eval(os))
            }
            if(_paths[1]&&_paths[1].toUpperCase().startsWith("IFRAME")){
              os=_root=$(os).find(_paths[1])
              if(os.length){
                os=_root=$(os.toArray().map(x=>{
                  return x.contentWindow.document
                }))
                _paths.splice(1,1)
              }else{
                return
              }
              
            }
          }else{
            os=_root=$(os)
          }
          if (_paths.length==1 || !_paths[1].toUpperCase) {
            return [os[0]];
          }else if(_paths[1]=="defaultView"){
            return [window.BZ?BZ.TW:window];
          }
        }
        /*
        var _cell=_Util._findElementFromParent(_root,_paths,_idx)
        if(_cell){
          return [_cell]
        }
        */
        
        let _curPath=_paths[_paths.length-1]

        _cells=_Util._findInInsensitive(_root,_curPath,_paths[_paths.length-2]);

        if(_curPath.includes(":before")){
          _cells=_cells.toArray?_cells.toArray():_cells
          _cells.reverse()
        }
        _cells=_Util._findChildrenDomFromList(_cells)
        for(var i=0;i<_cells.length;i++){
          var o=_cells[i];
          if(_Util._isHidden(o)){
            _osInHidden.push(o)
            _cells.splice(i--,1)
          }
        }
        if(!_errOnHidden){
          _cells.push(..._osInHidden)
        }
        if(!_cells.length){
          return []
        }
        if(_paths.length>2){
          for(var i=1;i<_paths.length-1;i++){
            os=os.find(_Util._findInInsensitive(_root,_paths[i],_paths[i-1]));
            os=_getOffset(_paths[i],os)
          }
          if(!os.length){
            os=_root;
            for(var i=1;i<_paths.length-1;i++){
              os=os.find(_Util._findInInsensitive(_root,_paths[i].replace(/\:endContains\(/g,":Contains("),_paths[i-1]));
            }
          }
          if(!os.length){
            return []
          }else if(_cells.length==1&&$(os).find(_cells).length){
            return _getOffset(_curPath,_cells)
          }
          if(os.length>1&&_paths.find(x=>x&&x.match&&x.match(/\:(contains|endcontains|equal|endequal)\(/i))){
          // if(os.length>1&&$.isNumeric(_idx)){
            var nos=_Util._findChildrenDomFromList(os,_cells)
            if(!nos.length){
              return []
            }
            var oo=$(_root).find("*");
            var ii=oo.index(nos[0])
            for(var i=0;i<_cells.length;i++){
              if(oo.index(_cells[i])<ii && _cells.length){
                _cells.splice(i--,1)
              }
            }
            _cells.sort(function(a,b){
              var ba=Boolean(nos.find(a)[0]);
              var bb=Boolean(nos.find(b)[0]);
              if(ba==bb){
                return oo.index(a)-oo.index(b)
              }
              return ba?-1:1
            })
          }else{
            _cells=os.find(_cells)
          }
        }
        
        if(_cells){
          if(_cells.constructor!=Array){
            _cells=_cells.toArray()
          }
        }
        
        if(_cells&&_cells[0]&&_cells[0].tagName=="CANVAS"&&_orgPath.join(" ").includes(":textElement")){
          let _txt=_descAnalysis._retrieveTextForElementPathItem(_orgPath)
          if(_idx===null){
            let n=0
            _cells.forEach((c,i)=>{
              c.bzTxtElement=c.bzTxtElement||_TWHandler._getCanvasTextElement(c,_txt,0)
            })
            return _getOffset(_curPath,_cells)
          }else{
            let i=0;
            let cc=_cells.find(c=>{
              let cs=_TWHandler._getCanvasTextElement(c,_txt)
              if(cs.length+i>_idx){
                c.bzTxtElement=cs[_idx-i]
                return 1
              }else{
                i+=cs.length
              }
            })
            if(!cc){
              cc=_cells[_cells.length-1]
              let cs=_TWHandler._getCanvasTextElement(cc,_txt)
              cc.bzTxtElement=cs[cs.length-1]
            }
            return _getOffset(_curPath,[cc])
          }
        }else{
          if(_sufIdx=="first"){
            return _getOffset(_curPath,[_cells[0]])
          }else if(_sufIdx=="last"){
            return _getOffset(_curPath,[_cells.pop()])
          }else if(_idx===null){
            return _getOffset(_curPath,_cells)
          }else{
            return _getOffset(_curPath,[_cells[_idx]||_cells[_cells.length-1]])
          }
        }
      }
    }catch(e){
      _domActionTask._reportAppInfo("Error on findDoms: "+e.message)
      console.log(e.stack)
      if(os && os.constructor==String && !_bRetry){
        BZ._prepareDocument();
        return this._findDoms(_paths,_errOnHidden,1);
      }
    }
    return null;
    
    function _getOffset(v,os){
      let _toArray
      if(os&&os.toArray){
        _toArray=1
        os=os.toArray()
      }
      v=v.match(/(\[[^\]]+\])|(\:[^\(\.\#\[]+(\([^\)]*\)+([^:\.\#]+\))*)?)|([\.\#][^\:\[\.\#]+)/g)
      if(!v||!os){
        if(_toArray){
          os=$(os)
        }
        return os
      }
      os=os.filter(x=>x).map(o=>{
        v.forEach(x=>{
          if(o){
            if(x==":next"){
              o=o.nextElementSibling
            }else if(x==":previous"){
              o=o.previousElementSibling
            }else if(x==":parent"){
              o=o.parentElement
            }
          }
        })
        return o
      })
      if(_toArray){
        os=$(os)
      }
      return os
    }
  },
  _findDomWithPanels:function(d,ps,pp){
    var _idx=d.pop()
    if(!$.isNumeric(_idx)){
      d.push(_idx)
      _idx=0
    }
    var ds=_Util._findDoms(d,pp)
    if(!ds||!ds.length){
      return
    }else if(ds.length==1){
      return ds[0]
    }
    for(var i=ps.length-1;i>=0;i--){
      var p=ps[i]
      if(!p){
        continue
      }
      var pps=_Util._findDoms(p)
      var dds=$(pps).find(ds)
      if(!dds||!dds.length){
      }else if(dds.length==1){
        return dds[0]
      }else{
        ds=dds
      }
    }
    if(ds){
      return ds[_idx]||ds[0]
    }
  },
  _findAfterDoms:function(o){
    var os=[o];
    while(o.parentElement&&o.tagName!="BODY"){
      $(o).nextAll().each(function(i,oo){
        os.push(oo)
      })
      o=o.parentElement
    }
    return $(os)
  },
  _findChildrenDomFromList:function(os,_cells){
    var ns=[],_last;
    for(var i=os.length-1;i>=0;i--){
      if(_cells && !$(os[i]).find(_cells).length){
        continue
      }else if(!ns.length||!$(os[i]).find(ns).length){
        ns.unshift(os[i])
      }
    }
    return $(ns)
  },
  _findTextElement:function(e){
    while(e && !$(e).text().trim() && e.tagName!="BODY"){
      e=e.parentElement
    }
    return e
  },
  _mergeSummary:function(sd,d,k){
    if(d){
      if(!sd[k]){
        sd[k]=d
      }else if(sd[k]!=d){
        Object.keys(d).forEach(x=>{
          sd[k][x]+=d[x]
        })
      }
    }
  },
  _getClosestElement:function(p,o,c){
    if($(p).is(c)){
      return p
    }
    let e=$(p).find(c).toArray()
    if(e.length){
      let os=$(p).find("*")
      let oi=os.index(o),mi=0,mo;
      for(let i=0;i<e.length;i++){
        let ee=e[i]
        let x=Math.abs(oi-os.index(ee))
        if(x<mi||!mi){
          mi=x
          mo=ee
        }
      }
      return mo;
    }else if(p&&p.tagName!="BODY"){
      return _Util._getClosestElement(p.parentElement,o,c)
    }
  },
  // _findNearTxt:function(a,_compareWord){
    // let ar=a.getBoundingClientRect(),_org=a,_hide
    // _compareWord=(_compareWord||"").toLowerCase()
    // var _right=["radio","checkbox"].includes(a.type),_stop=0,_bkLabel="";
    
    // var match=0,_txt="";
    // while(a.tagName!="BODY" && a.parentNode&&!_stop){
      // var p=a.parentNode,
          // _start=!_right;
      // let w=(p.innerText||"").trim()
      // if(w){
        // for(let i=0;i<p.childNodes.length;i++){
          // let o=p.childNodes[i]
          // if(o==a){
            // _start=!_start
            // continue
          // }
          // if(_start){
            // if(o.nodeType==1){
              // _txt+=" "+_formatTxt($util.getElementText(o))
            // }else if(o.nodeType==3){
              // _txt+=" "+_formatTxt(o.textContent)
            // }
            // _txt=_txt.trim()
            // if(_txt==_compareWord||_txt.match(new RegExp(_compareWord))){
              // _txt=_compareWord
            // }
          // }else if(!_txt&&o.nodeType==1){
            // w=_formatTxt($util.getElementText(o))||""
            // if(w==_compareWord||w.match(new RegExp(_compareWord))&&_Util._positionAfterElement(a,o)){
              // _txt=w
              // break
            // }else if(w){
              // break
            // }
          // }else if(o.nodeType==3&&(o.textContent+"").trim()){
            // break
          // }
        // }
        // if(_txt){
          // break
        // }
      // }
      
      // a=p;
    // }
    
    // return _txt
    
    // function _formatTxt(w){
      // return _Util._trimSpace(_Util._filterTxt(w.toLowerCase()))
    // }
  // },
  _findNearTxt:function(a,_compareWord){
    let ar=a.getBoundingClientRect(),_org=a
    _compareWord=(_compareWord||"").toLowerCase()
    var _right=["radio","checkbox"].includes(a.type),_stop=0,_bkLabel="";

    var _start=!_right,_match=0,_txt;
    while(a.tagName!="BODY" && a.parentNode&&!_stop){
      var p=a.parentNode;
      let os=$(p).find(_org.tagName)
      if(!_bkLabel){
        let w=$util.getElementText(p)
        if(w){
          w=_Util._filterTxt(w.toLowerCase());
          w=_Util._trimSpace(w)
          if((w==_compareWord||w.match(new RegExp(_compareWord)))&&os.length==1){
            _txt=w
            break
          }
        }else{
          a=p
          continue
        }
      }
      let _first=os[0]
      if(_bkLabel&&_first!=_org&&!_Util._isHidden(_first)){
        _txt=_bkLabel
        break 
      }
      for(var i=0;i<p.childNodes.length;i++){
        var n=p.childNodes[i];
        if(n.nodeType==1&&_Util._isHidden(n)){
          continue
        }
        if(n==a){
          if(_start){
            break
          }else{
            _start=1
          }
        }else if(!_start){
          continue
        // }else if(n.nodeType==1&& _cssHandler._isInput(n)){
          // break
        }else if((n.nodeType==1||n.nodeType==3)){
//          _stop=1
          
          var v1=_Util._filterTxt($util.getElementText(n).toLowerCase()).trim();
          if(v1&&v1!=_bkLabel){
            _stop=_txt=v1
            if(!_right&&v1.length>50){
              _stop=0
            }
          }
          if(_right && _txt){
            break
          }
        }
      }

      if(!_bkLabel&&_compareWord&&_stop&&_txt&&_txt!=_compareWord&&!v1.includes(_compareWord)&&["INPUT","TEXTAREA"].includes(_org.tagName)&&!["radio","checkbox","submit","butt","image","reset"].includes(_org.type)){
        let nr=p.getBoundingClientRect()
        
        if(ar.top-nr.top<15&&ar.left-nr.left<20){
          _bkLabel=_txt
          _stop=_txt=""
          continue
        }
      }

      
      a=p;
    }

    return (_txt||"").replace(/\*+$/,"").replace(/\s+/g," ").trim()
  },
  _toTrimSign:function(v,n){
    v=(v||"").replace(_Util._trimSign,"")
    if(n){
      v=_Util._retrieveTopWords(v,n)
    }
    return (v||"").replace(_Util._trimSign,"")
  },
  //
  _match:function(d,r){
    if(d!=r){
      if(_Util._isRegexData(r)){
        let _std=r.match(/\{data\:(.+)\}/)
        try{
          if(_std){
            return _Util._eval("d"+_std)
          }else if(r){
            return _Util._eval("d.match("+r+")")
          }
        }catch(e){}
      }
    }else{
      return 1
    }
  },
  /*
  d:data, pick attribute name from data
  {
    Name:$project.data,
    Age:15,
    data:{
      value:"abc"
    }
  }
  ==>
  ["Name","Age","data"]
  */
  _pickAttrFromStringJSON:function(d){
    if(d){
      if(d.constructor==String){
        let vs=[]
        d=d.trim()
        if(d[0]=="{"&&d[d.length-1]=="}"){
          d=d.substring(1,d.length-1).trim()
          let p=d.match(/$args\: *\[[^.]+\]/)
          if(p){
            d=d.replace(p[0],"")
          }
          while(d.includes("{")&&d.indexOf("{")<d.indexOf("}")){
            d=d.replace(/\{[^\{\}]*\}/g,"''")
          }
          while(d.includes("[")&&d.indexOf("[")<d.indexOf("]")){
            d=d.replace(/\[[^\[\]]*\]/g,"''")
          }
          d=d.replace(/\:[^,]*(,|$)/g,":''$1")
          d=d.replace(/:''/g,"")
          d=d.replace(/\s/g,"")
          d=d.split(",")
          
          _Util._spliceAll(d,v=>{return !v})

          vs=d
        }
        return vs
      }else{
        return Object.keys(d)
      }
    }
  },
  _retrieveTopWords:function(w,_size){
    if(w && w.length>_size){
      w=w.split(" ");
      var ww=w[0],i=1
      while(ww.length<_size){
        ww+=" "+w[i++]
      }
      w=ww
    }
    return w
  },
  _getElementRoot:function(e){
    let r=0;
    while(e.parentNode){
      e=e.parentNode;
      if(e.constructor==ShadowRoot){
        return e
      }else if(e.tagName=="BODY"){
        r=e
      }
    }
    return r||e
  },
  _hasDeepContent:function(e){
    var _hasNone=0
    for(var i=0;i<e.children.length;i++){
      var o=e.children[i];
      if($(o).css("pointer-events")=="none"){
        _hasNone=1
      }else if(!["STYLE","SCRIPT","OPTION"].includes(o.tagName)){
        return 1
      }
    }
    return 0
  },
  _getStringBySize:function(v,i,_back){
    i=i||30
    if(v&&v.length>i){
      if(_back==1){
        return "... "+ v.substring(v.length-i)
      }else if(_back){
        i=parseInt(i/2)
        return v.substring(0,i)+"... "+ v.substring(v.length-i)
      }

      return v.substring(0,i)+" ..."
    }
    return v
  },
  getEONumList:function(n){
    let ls=[];
    for(let i=0;i<n;i++){
      ls.push(i)
    }
    let ns=[],w=0;
    while(ls.length){
      if(ls.length==1){
        ns.push(ls.pop())
      }else{
        let i=Math.ceil(ls.length/2)
        if(!w){
          ns.push(ls.splice(i,1).pop())
        }else if(w==1){
          ns.push(ls.splice(Math.ceil(parseInt(ls.length/2)/2),1).pop())
        }else if(w==2){
          ns.push(ls.splice(parseInt((ls.length+Math.ceil(ls.length/2))/2),1).pop())
        }
        w++
        if(w==3){
          w=0
        }
      }
    }
    return ns
  },  
  _compressBase64:function(bs){
    var q=9,_best;
    bs=bs.substring(22);
    
    while(1){
      var h="",hh="",k=0,j=0;
      s=bs
      while(s){
        var v=s.substring(0,q)
        var sss=s.substring(q)
        var ss=_Util._replaceAll(sss,v,"*"+j)
        if(sss!=ss){
          k+=(sss.length-ss.length)
          h+=v
          s=ss
          j++
        }else{
          hh+=s[0]
          s=s.substring(1)
        }
      }
      q++;
      if(!_best || _best>k){
        _best=k
        _bestQ=q
      }else{
        return _bestQ+"\n"+h+"\n"+hh
      }
    }
  },
  _isOverlapping:function(a,b){
    let ar=a.getBoundingClientRect()
    let br=b.getBoundingClientRect()
    if(ar.left<=br.left+10 && ar.right>=br.right-10 && ar.top<=br.top+10&&ar.bottom>=br.bottom-10){
      return 1
    }
    return br.left<=ar.left+10 && br.right>=ar.right-10 && br.top<=ar.top+10&&br.bottom>=ar.bottom-10
  },
  _unCompressBase64:function(s){
    
  },
  _removeNoJSONData:function(a){
    if(a&&![Number,String,Object,Array].includes(a.constructor)){
      return 
    }
    if(a&&[Array,Object].includes(a.constructor)){
      for(var k in a){
        if(!_Util._removeNoJSONData(a[k])){
          delete a[k]
        }
      }
    }
    return 1
  },
  _removeStringSign:function(v){
    return v?v.replace(/(^["'`])|(["'`]$)/,""):v
  },
  _refDataToJSON:function(vs,p){
    p=p||""
    let w=""
    vs.forEach(x=>{
      if(w){
        w+=",\n"
      }
      if(x._key){
        if(x._value.constructor==Array){
          w+=p+"  \""+x._key+"\" : "+_Util._refDataToJSON(x._value,p+"  ")
        }else{
          w+=p+"  \""+x._key+"\" : "+x._value
        }
      }else{
        if(x._value.constructor==Array){
          w+=p+_Util._refDataToJSON(x._value,p+"  ")
        }else{
          w+=p+"  "+x._value
        }
      }
    })
    if(vs[0]){
      if(vs[0]._key){
        w=p+"{\n"+w+"\n"+p+"}"
      }else{
        w=p+"[\n"+w+"\n"+p+"]"
      }
    }else{
      return "{}"
    }
    return w
  },
  _isJsonKey:function(s){
    return s&&(s.match(/^[0-9]*[.]?[0-9]*$/))||(!s.match(/^[0-9]/)&&s.match(/(^"[^"]*"$)|(^`[^`]*`$)|(^`[^`]*`$)|[\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC]+/))
  },
  _isJsonValueString:function(v){
    if(v&&v.constructor!=String){
      return
    }
    v=(v||"").trim()
    if(!v){
      return
    }else if(v.match(/(^".+"$)|(^'.+'$)|(^`.+`$)/)){
      let k=v[0]
      v=v.substring(1,v.length-1).replace(/[\\][\\]/g,"").replace(/[\\]['"`]/g,"")
      
      return !v.includes(k)
    }else if(v.match(/(^\{.+\}$)|(^\[.+\]$)/s)){
      return 1
    }else if(v.match(/(^\(.+\)$)/)){
      return _Util._isJsonValueString(v.substring(1,v.length-1))
    }else if(v.match(/(^["].*["]$)|(^['].*[']$)|(^[`].*[`]$)/)||$.isNumeric(v)){
    //}else if(v.match(/[^\?]+\:/)){
    }else{
      return
    }
    return 1
  },
  _parseJSONWithRefDataToObj:function(v,_throwError){
    v=v||""
    if(v.constructor!=String){
      v=JSON.stringify(v,0,2)
    }
    v=v.trim()
    if(!v){
      return [];
    }
    
    if(v.replace(/\s/g,"")=="{}"){
      return []
    }
    let vs=[],
        _left=_eval.bd,
        _right=_eval.db,
        _key,_value,lc=[],rc=[],s="",b,_startIdx
    
    for(let i=0;i<v.length;i++){
      let c=v[i]
      if(c=="\\"){
        b=!b
      }else if(b){
        b=0
      }else if(c.match(/\s/)&&!s){
        continue
      }else if(c==':'&&lc[0]=="{"){
        let ss=s.trim()
        if(ss&&!_key){
          if(_Util._isJsonKey(ss)){
            _key=ss
            s=""
            continue
          }else{
            return _throw(v,i)
          }
        }else if(!ss){
          return _throw(v,i)
        }else if(!ss.includes("?")&&lc.length==1){
          return _throw(v,i)
        }
      }else if((c==","||c==_left[lc[0]])&&lc.length==1){
        s=s.trim()||""
        if(!_Util._isJsonValueString(s)&&!_Util._hasCode(s)&&!$.isNumeric(s)&&!s.match(/^(true|false)$/)){
          return _throw(v,i)
        }
        if(_key){
          vs.push({
            _key:_key,
            _value:s
          })
        }else if(lc[0]=="["){
          vs.push({_value:s})
        }else{
          return _throw(v,i)
        }
        _key=_value=s=""
        if(c!=","){
          lc.pop()
        }
        continue
      }else if(!lc[0]&&(c=="{"||c=="[")&&!vs.length){ //start
        lc.unshift(c)
        continue
      }else if(!lc[0]){ //not start { and [
        return _throw(v,i)
      }else if(c==_left[lc[0]]){
        lc.shift()
      // }else if(lc[0]=="{"&&!_key&&!s&&!c.match(/["'a-zA-ZÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC\$\_]/)){
        // return _throw(v,i)
      }else if(_left[c]){
        lc.unshift(c)
      }
      s+=c
    }
    if(s){
      return _throw(v,v.length-s.length)
    }
    if(vs.find(x=>{
      if(x._key&&"'\"`".includes(x._key[0])){
        x._key=x._key.substring(1,x._key.length-1)
      }
      if(x._value.match(/^[\{\[]/)){
        try{
          x._value=_Util._parseJSONWithRefDataToObj(x._value,1)
        }catch(ex){
          v=ex.message
          return 1
        }
      }
    })){
      return _throw(v,0)
    }
    return vs
    function _throw(v,i){
      if(i){
        i-=25
        if(i<0){
          i=0
        }
      }
      let _msg=_bzMessage._system._error._parseParameterError+": "+v.substring(i,i+50)
      if(_throwError){
        throw new Error(_msg)
      }
      alert(_msg)
    }
  },
  _showLabelMenu:function(k,e,x,y,t,w){
    let o=$("#"+k)[0]
    if(!o){
      o=$(`<div id='${k}' class='bz-menu-with-arrow-${w}'><div class='bz-menu-with-arrow-out-${w}'></div><div class='bz-menu-with-arrow-in-${w}'></div><pre class='bz-menu-with-arrow-box'></pre></div>`)[0]
    }
    if(o._curData&&o._curData.x==x&&o._curData.y==y&&o._curData.t==t){
      return
    }
    o._curData={x:x,y:y,t:t}
    o=$(o)
    o.css({opacity:0})
    o.appendTo(document.body)
    o.find(".bz-menu-with-arrow-box").text(t)
    let r=o[0].getBoundingClientRect()
    o.find(".bz-menu-with-arrow-out-"+w).css({top:r.height-5+"px",left:r.width/2-2+"px"})
    o.find(".bz-menu-with-arrow-in-"+w).css({top:r.height-6+"px",left:r.width/2-2+"px"})
    o.css({opacity:1,left:x-r.width/2+"px",top:y-r.height-7+"px"})
    return o[0]
  },
  _isCompleteBlock:function(w){
    w=w.replace(/\\\\/g,"").replace(/(\\\"|\\\'|\\\(|\\\)|\\\[|\\\]|\\\{|\\\})/g,"").replace(/(\"[^\"]*\"|\'[^\']*\')/g,"")
    let ks=_eval._leftKeys;
    return !w.match(/[\"\']/)&&!['[','{','('].find(x=>{
      m1=w.match(new RegExp("[\\"+x+"]","g"))||[]
      m2=w.match(new RegExp("[\\"+ks[x]+"]","g"))||[]
      return m1.length!=m2.length
    })
  },
  _getRegexByBZName:function(r,_final){
    while(r&&r[0]=="/"&&r[r.length-1]=="/"){
      r=r.substring(1,r.length-1)
    }
    if(r&&r.startsWith("BZ-")){
      var rr=r.toUpperCase()
      for(var i=0;i<_IDE._data._curVersion.setting.attributeMap.length;i++){
        var v=_IDE._data._curVersion.setting.attributeMap[i]
        if(rr=="BZ-"+v.key.toUpperCase()){
          r=v.regex
          r=r.substring(1,r.length-1)
          break
        }
      }
    }
    if(_final&&_IDE._data._curModule){
      r=r.replace("{module}",_IDE._data._curModule._data.name).replace("{num}","[0-9]+").replace("{timestamp}","[0-9]{13}").replace("{time}","[0-9]{6}")
    }
    return r
  },
  _readyExecute:function(_ckFun,_exeFun,_time){
    setTimeout(()=>{
      if(_ckFun()){
        _exeFun()
      }else{
        _Util._readyExecute(_ckFun,_exeFun,_time)
      }
    },_time||100);
  },
  _parseExpression:function(s,_headerSplit,_logic){
    let w="",b,p=[],g,gs=[],hs=[],pml={
      "'":"'",
      '"':'"',
      "{":"}",
      "(":")",
      "[":"]",
      "/":"/",
      "`":"`"
    },pmr=_Util._swapKeyValue(pml),_split=""
    
    for(let i=0;i<s.length;i++){
      let c=s[i]
      if(b){
        w+=c
        b=0
      }else if(c=="\\"){
        b=1
      }else if(p.length){
        w+=c
        if(pml[p[p.length-1]]==c){
          p.pop()
        }else if(pml[c]){
          p.push(c)
        }
      }else if(_headerSplit&&c.match(_headerSplit)){
        if(gs.length||w){
          hs=hs.concat(gs)
          w=w.trim()
          if(w){
            hs.push(w)
            w=""
          }
          gs=[]
          if(_split){
            continue
          }
        }
        _split+=c.match(_headerSplit)[0]
        _split=_split.replace("==","=")
      }else if(pml[c]){
        p.push(c)
        w+=c
      }else if(_logic&&(c=="|"||c=="&")){
        if(w){
          gs.push(w)
        }
        gs.push(c)
        w=""
      }else if(!c.match(/\s/)||w){
        w+=c
      } 
    }
    if(w){
      gs.push(w)
    }
    gs=gs.map(x=>{
      while(x.match(/^[\(](.+)[\)]$/)){
        x=x.substring(1,x.length-1)
      }
      return x
    })
    if(_headerSplit){
      if(hs.length){
        return {_headers:hs,_groups:gs,_split:_split}
      }else{
        return {_headers:gs,_groups:[],_split:_split}
      }
    }else{
      return gs
    }
  }
};var _DialogViewDef={
  //modal cover
  id:"_dialog",
  _tag:"div",
  _attr:{
    "class":function(d){
      var c=bzTwComm._isExtension()?"BZIgnore":""
      return d._modal?"bz-modal-bg "+c:"bz-bg "+c
    }
  },
  _animation:{
    _hide:function(e,_fun){$(e).fadeOut("slow",_fun)}
  },
  _items:[
    {
      //Main window
      _tag:"div", 
      _attr:{
        "class":"bz-modal-window",
        style:function(d,c){
          //if(1||d._moveable&&!d._modal){
          //}
          var _innerSize=_Util._getDomSize(d._content);
          if(!d._width){
            d._width=_innerSize._width+30+"px";
          }else if(!(d._width+"").match(/(\%|px)/)){
            d._width+="px"
          }
          if(!d._height){
            d._height=_innerSize._height+165;
          }
          s=d._inMax?"width:90% !important;height:90% !important;":"width:"+d._width+" !important;max-width:90%;height:"+d._height+"px !important;min-width:450px;";
          if(d._moveable&&!d._modal&&_Dialog._position){
            s+="top:"+_Dialog._position.top+"px;left:"+_Dialog._position.left+"px;transform:unset;"
          }
          return "max-height:80%;"+s;
        }
      },
      _after:function(o){
        // var oo=".bz-modal-header";
        if(!o._dragDefined){
          o._dragDefined=true;
          setTimeout(function(){
            _Util._setDrag($(o).find(".bz-modal-header,.bz-modal-footer").toArray(),o);
          },100);
        }
      },
      _items:[
        {
          _tag:"div",
          _attr:{
            "class":"bz-modal-header",
          },
          _text:function(d){
            return d._title
          },
        },
        {
          _tag:"div",
          _attr:{
            "class":"bz-modal-body disable-select"
          },
          _html:function(d){
            return d._content
          }
        },
        {
          _tag:"div",
          _attr:{
            "class":"bz-modal-footer",
            style:function(d){
              if(d._buttons.length==1){
                return "text-align:center;"
              }
              return "";
            }
          },
          _items:[
            {
              _if:"_data._buttons.find(x=>x._options)",
              _tag:"span",
              _attr:{
                class:"pull-left"
              },
              _items:[
                {
                  _tag:"select",
                  _attr:{
                    class:"form-control",
                    style:"width:150px;"
                  },
                  _items:[
                    {
                      _tag:"option",
                      _attr:{
                        value:"_data._item._value||_data._key"
                      },
                      _text:function(d){
                        return d._item._text||d._item
                      },
                      _dataRepeat:function(d){
                        return d._item._dataRepeat
                      }
                    }
                  ],
                  _dataModel:function(d){
                    return d._item._dataModel
                  },
                  _dataRepeat:function(d){
                    return d._buttons.filter(x=>x._options).map(x=>x._options)
                  },
                  _jqext:function(d){
                    return d._item._jqext
                  }
                }
              ]
            },
            {
              _tag:"button",
              _dataRepeat:function(d){
                return d._buttons
              },
              _attr:{
                disabled:function(d){
                  if(d._item._if){
                    if(d._item._if.constructor==Function){
                      return !d._item._if()
                    }else if(d._item._if.constructor==String){
                      let v=_Util._eval("v="+d._item._if)
                      return !v
                    }
                    return !d._item._if
                  }
                },
                tabindex:function(d){
                  return d._supData._buttons.length-d._idx
                },
                "class":function(d){
                  return (d._item._class||"").constructor==Function?d._item._class(d):d._item._class
                },
                style:function(d){
                  return (d._item._style||"").constructor==Function?d._item._style(d):d._item._style
                }
              },
              _text:function(d){
                return d._item._title
              },
              _jqext:{
                click:function(e){
                  this._data._item._click(this,e);
                }
              }
            }
          ]
        }
      ]
    }
  ],
  _jqext:{
    mousedown:function(e){
      if(e.target==this){
        _Util._closeModelWindow()
      }
    }
  }
};

var _dialogList=[];
var _lastCloseDlgTime=0;
var _Dialog={
  _comps:{},
  _viewDef:_DialogViewDef,
  _showMe:function(_content,_data,_area,_winTagClass){
    this._data=_data;
    this._data._content=_content;
    this._area=_area;
    if(!_data._modal){
      let bg=$(_area).find("."+_winTagClass).toArray().pop()
      if(bg){
        if(_winTagClass=="bz-confirm-window"){
          _Dialog._position=bg.getBoundingClientRect()
          $(".bz-confirm-window .btn-cancel").click()
        }
        $(".bz-alert-window .btn-primary").click()
      }
    }
    this._window=_CtrlDriver._execute(this);
    var _this=this;
    setTimeout(function(){
      _this._initLayout();
      if($(_this._window).hasClass("bz-modal-bg")){
        _this._window.style.zIndex=10000000
      }else{
        _Util._setToTop($(_this._window).find(".bz-modal-window")[0])
      }
    },100);
  },
  _initLayout:function(){
    var d=this._data;
    var o=this._data._content;
    _dialogList.unshift(this)

    var _input=$(".bz-modal-bg:last").find("input,select,.bz-js-editor-box");
    if(_input.is(":focus")){
    }else if(_input.length){
      _input.toArray().find(x=>{
        if(x.getBoundingClientRect().width>10){
          x.focus()
          return 1
        }
      })
    }else{
      var btn=$(".bz-modal-bg:last button.btn-primary:eq(0)");
      if(btn.length){
        btn.focus()
      }else{
        $(".bz-modal-bg button:last").focus();
      }
    }
  },
  _close:function(){
    if (this._data._afterClose) {
      this._data._afterClose();
    }
    $(this._comps._dialog).remove();
    _dialogList.splice(_dialogList.indexOf(this),1)
  },
  _isSameDlg:function(o){
    return $(this._window).find(o).length
  }
};window.$util={
  extractData:function(d,k){
    return _extractData._extract(d,k)
  },
  getLastResult:function(){
    return _ideTask._getLastResult()
  },
  showJsonValidateResult:function(v,d){
    if(!d&&v.valid){
      d=v.valid
      v=v.data
    }
    _extractData._showTools(v,d)
  },
  refreshData:function(m,t,n){
    let d=$data(m,t)
    _ideDataHandler._takeData((_ideDataManagement._curMap[(m||"")+(t||"")]||[]).find(x=>x.name==n),d,m,t)
  },
  validateData:function(v,d){
    let url=location.protocol+"/"+"/"+location.host+location.pathname+"?id="+pId+"#"+_ideLocation._getPath(0,_ideTask._data._curModule||_IDE._data._curModule,_ideTask._data._curTest||_IDE._data._curTest)
    // if(_domActionTask._lastAction){
    //   _domActionTask._lastAction._extractJsonData=v
    //   _domActionTask._lastAction._validJsonData=d
    //   _domActionTask._lastAction._url=url
    // }
    v=_compressJSON._unConvert(v)
    console.log("BZ-LOG: BZ-Start-Validating:"
                +"url: "+url
                +"-- Data --"
                +JSON.stringify(v)
                +"-- Validation --"
                +JSON.stringify(d)
                +"BZ-End-Validating");
    return !!_extractData._checkData(v,d)
  },
  extendExtensionScript:function(c,_pos){
    let d={bz:1}
    if(_pos=="end"){
      _pos="extendEndScript"
    }else{
      _pos="extendTopScript"
    }
    d[_pos]=`try{${c}}catch(ex){alert(ex.message)}`
    chrome.runtime.sendMessage(_extensionComm._bzExtensionId, d)
  },
  extendExceptionScript:function(c,_pos){
    return $util.extendExtensionScript(c,_pos)
  },
  removeDuplicateData:function(d){
    if(d&&d.constructor==Array){
      let v,_idx=d.length-1;
      while(_idx>=0){
        v=d[_idx]
        for(let i=0;i<_idx;i++){
          if(_Util._isSameObj(d[i],v)){
            d.splice(_idx,1)
            break
          }
        }
        _idx--
      }
    }else if(d && d.constructor==Object){
      for(let k in d){
        _cleanEmptyObj(d[k])
      }
    }
  },
  attachScreenshotToReport:function(v){
    v=v||["BZ.TW.document","BODY",0]
    let _curBack
    $util.takeScreenshot(v,(x)=>{
      $util.attachInfoToReport(x)
      _curBack&&_curBack()
    })
    return function(_back){
      _curBack=_back
    }
  },
  attachInfoToReport:function(v){
    window._ideReport&&_ideReport._attachInfo(v)
  },
  jsonToXML:function(_obj,_root) {
    if(!_root||_root===1){
      _root="data"
    }
    let _xml = '';
    for (let _prop in _obj) {
      let v=_obj[_prop]
      if(v&&v.constructor==Function){
        continue
      }
      _xml += v instanceof Array ? '' : "<" + _prop + ">";
      if (v instanceof Array) {
        for (let _array in v) {
          _xml += "<" + _prop + ">";
          _xml += $util.jsonToXML(new Object(v[_array]),1);
          _xml += "</" + _prop + ">";
        }
      } else if (typeof v == "object") {
        _xml += $util.jsonToXML(new Object(v),1);
      } else {
        _xml += v;
      }
      _xml += v instanceof Array ? '' : "</" + _prop + ">";
    }
    _xml=_xml.replace(/<\/?[0-9]{1,}>/g, '');
    if(_root&&_root!==1){
      _xml=`<${_root}>${_xml}</${_root}>`
    }
    return _xml
  },
  xmlToJson:function(x) {
    let j = {},cj,ps=[j],k;
    let xo=x.match(/<[^< \n>]+(>| |\n)/g);

    if(xo){
      xo.forEach(o=>{
        let i=x.indexOf(o)
        if(i){
          let xx=x.substring(0,i).trim();
          x=x.substring(i)
          if(xx[xx.length-1]==">"){
            xx=xx.substring(0,xx.length-1).trim()
            _addNode(k)
            k=""
            if(xx.endsWith("/")){
              xx=xx.substring(0,xx.length-1).trim()
              _parseProperties(xx,j)
              ps.shift()
              j=ps[0]
            }else{
              _parseProperties(xx,j)
            }
          }else{
            if($.isNumeric(xx)){
              j[k]=parseFloat(xx)
            }else{
              j[k]=xx
            }
            k=""
          }
        }
        x=x.substring(o.length).trim()

        if(o[0]=="<"){
          o=o.substring(1)
        }
        if(o[o.length-1]==">"){
          o=o.substring(0,o.length-1)
        }
        if(o[o.length-1]=="/"){
          return
        }
        if(o[0]=="/"){
          o=_glossaryHandler._getVariableName(o.substring(1),0,1)
          if(ps[1]&&(ps[1][o]==j||(ps[1][o]&&ps[1][o].constructor==Array&&ps[1][o].includes(j)))){
            ps.shift()
            j=ps[0]
          }
          return
        }else{
          if(k){
            _addNode(k)
          }
          k=_glossaryHandler._getVariableName(o,0,1)
        }
      })
    }
    return j;

    function _addNode(k){
      let d={}
      if(j[k]){
        if(j[k].constructor!=Array){
          j[k]=[j[k]]
        }
        j[k].push(d)
      }else{
        j[k]=d
      }
      j=d
      ps.unshift(d)
    }

    function _parseProperties(xx,j){
      let xxo=xx.match(/[^\s=]+=\s*"/g)
      if(xxo){
        let k;
        xxo.forEach(o=>{
          if(k){
            let i=xx.indexOf(o)
            let v=xx.substring(0,i)
            xx=xx.substring(i)
            _parseValue(v,j,k)
          }
          xx=xx.substring(o.length)
          o=o.substring(0,o.length-1).trim()
          o=o.substring(0,o.length-1)
          k=o=_glossaryHandler._getVariableName(o,0,1)
        })
        _parseValue(xx,j,k)
      }
    }

    function _parseValue(v,j,k){
      v=v.trim()
      if(v){
        j[k]=v.substring(0,v.length-1)
        if($.isNumeric(j[k])){
          j[k]=parseFloat(j[k])
        }
      }
    }
  },
  getHostIdxByUrl:function(_url){
    _url=_url||location.href
    return _IDE._data._setting.environments[_IDE._data._setting.curEnvironment].items.findIndex(x=>_Util._isSameHost(x.host,_url))
  },
  openApp:function(_url){
    _TWHandler._openUrl(_url)
  },
  toErgodicList:function(v){
    return _Util._toErgodicList(v)
  },
  isMatchParameter:function(p,d){
    return _aiAPI._isMatchParameter(p,d)
  },
  isMatch:function(d1,d2){
    if(d1==d2){
      return !0
    }else if(d1=="bz-skip"||d2=="bz-skip"){
      return !0
    }else if(d1&&d2&&d1.constructor==d2.constructor){
      if(d1.constructor==Array){
        if(d1.length==d2.length){
          for(let i=0;i<d1.length;i++){
            if(!$util.isMatch(d1[i],d2[i])){
              return !1
            }
          }
          return !0
        }
        return !1
      }else if(d1.constructor==Object){
        for(let k in d1){
          if(!$util.isMatch(d1[k],d2[k])){
            return !1
          }
        }
        for(let k in d2){
          if(d1[k]===undefined){
            return !1
          }
        }
        return !0
      }
      return d1==d2
    }else if(d1&&d1.constructor==Array&&d1.length&&d2&&d2.constructor==Object){
      return !d1.find(x=>{
        return !$util.isMatch(x,d2)
      })
    }
    return !1
  },
  noConflictData:function(d1,d2){
    if(d1==d2){
      return true
    }else if(d1&&d2&&d1.constructor==d2.constructor&&d1.constructor==Object){
      for(let k in d1){
        if(d2[k]!==undefined){
          if(!$util.noConflictData(d2[k],d1[k])){
            return false
          }
        }
      }
      return true
    }
    return false
  },
  includes:function(d1,d2){
    if(!d2){
      return d1==d2
    }else if(d2.constructor==Array){
      if(!d1||![Object,Array].includes(d1.constructor)){
        return d2.find(x=>x==d1)
      }else if(d1.constructor==Object){
        return d2.find(x=>$util.includes(d1,x))
      }
      return !d2.find(x=>!$util.includes(x,d1))
    }else if(d2.constructor==Object){
      if(!d1||![Object,Array].includes(d2.constructor)){
        return
      }else if(d1.constructor==Object){
        for(let k in d2){
          if(!$util.includes(d1[k],d2[k])){
            return 
          }
        }
        return 1
      }else{
        return d1.find(x=>$util.includes(x,d2))
      }
    }
    return d1==d2
  },
  getValueFromSetActions:function(){
    let t=BZ._getCurTest()
    if(t){
      t._data.actions.forEach(a=>{
        if(a.type==1&&a.event.type=="change"&&a.element){
          let c=(a.event.value||"").match(_IDE._insertJSOnlyRegex)
          if(c){
            c=c[0]
            _Util._eval("delete "+c)
            let e=$util.findDom(a.element)
            if(e){
              let v=$util.getElementValue(e)
              c=_Util._eval(c+"=v",{v:v})
            }
          }          
        }
      })
    }
    return $parameter
  },
  getElementValue:function(e,fun){
    if(fun){
      return fun(e)
    }
    let os=$(e).find("input,textarea,select").toArray()
    let v;
    if(!os.length){
      if($(e).is("input,textarea,select")){
        os=[e]
      }
    }
    os.forEach(x=>{
      if(x.type=="radio"){
        if(x.selected){
          v=x.value
        }
      }else if(x.type=="checkbox"){
        if(x.checked){
          v=x.value||"on"
        }
      }else if(x.tagName=="SELECT"){
        v=v||""
        for(a of x.selectedOptions){
          v+=","+a.text
        }
        v=v.substring(1)||""
      }else if(x.getBoundingClientRect().width){
        let vv=x.value
        if(!v||vv.length>v.length){
          v=vv
        }
      }
    })
    if(v===undefined){
      v=e.innerText.trim()
    }
    return v
  },
  //getLanguage
  getLanguage:function(){
    return BZ._data._uiSwitch._curAppLanguage
  },
  //translate
  translate:function(v){
    let i=_IDE._data._setting.appLanguages.indexOf(BZ._data._uiSwitch._curAppLanguage)
    if(i){
      let w=_appWordHandler._wordMap[v]
      if(w){
        return w[i-1]||v
      }
    }
    return v
  },
  //randomItem
  randomItem:function(d){
    let i=Math.floor(Math.random()*Object.keys(d).length)
    let k=Object.keys(d)[i]
    return {key:k,value:d[k]}
  },
  //addLogData
  addLogData:function(d){
    _ideTask._logData=_ideTask._logData||[]
    for(var i=0;i<arguments.length;i++){
      _ideTask._logData.push(arguments[0])
    }
  },
  //setLogData
  setLogData:function(d){
    _ideTask._logData=[]
    for(var i=0;i<arguments.length;i++){
      _ideTask._logData.push(arguments[0])
    }
  },
  //cleanLogData
  cleanLogData:function(d){
    _ideTask._logData=[]
  },
  //log
  log:function(){
    let v=_Util._log(...arguments)
    if(!bzTwComm._isIDE()){
      bzTwComm._postToIDE({_scope:"$console",_fun:"output",_args:["App: "+v]});
      return
    }
    $console.output(v)
  },
  //takeScreenshot
  takeScreenshot:function(o,_fun){
    if(bzTwComm._isExtension()&&!o.element){
      return _screenshotHandler._elementImgMd5(o,1,_fun)
    }
    if(!BZ.TW||BZ.TW.closed){
      let _msg=_bzMessage._system._error._missTestWindow
      if(BZ._isAutoRunning()){
        throw new Error(_msg)
      }else{
        return alert(_msg)
      }
    }
    
    if(bzTwComm._isExtension()){
      _domActionTask._takeScreenshot(o,function(v){
        _fun(v)
      })
    }else{
      bzTwComm._postToExt({_fun:"takeScreenshot",_scope:"$util",_args:[{element:o||"BZ.TW.document.body"},_fun],_element:o||["BZ.TW.document"]})
    }

  },
  //findDataInMap
  findDataInMap:function(map,o){
    for(let k in map){
      let v=map[k],found=1
      if(o){
        for(let kk in o){
          if(o[kk]!=v[kk]){
            found=0
            break
          }
        }
      }
      if(found){
        return v
      }
    }
  },
  exeTests:function(ts){
    console.log(ts)
    _ideTask._exeTmpTasks(ts)
  },
  //formatTimestamp
  formatTimestamp:function(t,f){
    return _Util._formatTimestamp(t,f)
  },
  //getScenariosByTag
  getScenariosByTag:function(ts){
    return _ideObjHandler._getItemsByTag(ts,"scenario",1)
  },
  //getTestsBySuite
  getTestsBySuite:function(t,_fun){
    return _ideObjHandler._getRefTests(t,_fun)
  },
  //printScenariosByTag
  printScenariosByTag:function(ts){
    return _ideObjHandler._printItemsByTag(ts,"scenario")
  },
  //downloadFile
  downloadFile:function(_name,_content,_type){
    console.log("BZ-LOG: download-data-file:"+_name)
    _Util._downloadFile(_name,_content,_type)
  },
  //getTestsByTag
  getTestsByTag:function(ts){
    return _ideObjHandler._getItemsByTag(ts,"unit")
  },
  //takeAPPValue
  //for check client app variable value
  takeAPPValue:function(v,_fun){
    try{
      if(bzTwComm._isExtension()){
        if(!$("#bz-val")[0]){
          $("<div id='bz-val' style='display:none'></div>").insertAfter(document.body)
        }
        $("#bz-val").html("")
        //lws
        location.href="javascript:var bzTmpScript=document.createElement('script');"
                     +"bzTmpScript.innerHTML='document.getElementById(\"bz-val\").innerHTML=JSON.stringify(bzTwComm._retrieveData("+v+"))';"
                     +"document.body.append(bzTmpScript)"
        setTimeout(()=>{
          v=$("#bz-val").html()
          try{
            if(v){
              v=JSON.parse(v)
            }
          }catch(ex){}
          _fun(v)
        })
      }else{
        v=_Util._eval("v="+v)
        return v
      }
    }catch(e){
      console.log(e.stack)
    }
  },
  //isEmptyData
  isEmptyData:function(d){
    return d!==0&&(!d||$.isEmptyObject(d))
  },
  //gotoFlag
  gotoFlag:function(s){
    _domActionTask._gotoFlag(s)
  },
  //getRoles
  getRoles:function(){
    try{
      let t=BZ._getCurTest(),
          m=BZ._getCurModule()
      
      return _aiAuthHandler._getRolesByHostId(t?t._data.hostId:m?m._data.defaultHostId:0)
    }catch(e){}
    return []
  },
  //getElementText
  getElementText:function(u,_chkSvg){
    if(u.constructor==Array){
      return u.map(v=>$util.getElementText(v,_chkSvg))
    }
  //    return u.innerText?u.innerText.trim():""
    /*
    if(!_back){
      var _time=Date.now()
    }
    */
    if(u.nodeType==3){
      return (u.textContent||"").trim()
    }else if(u.innerText===undefined){
      if(_chkSvg){
        u=$("<div>"+u.outerHTML+"</div>").appendTo(document.body);
        var v=u[0].innerText;
        u.remove()
        return v.trim()
      }else{
        return ""
      }
    }else if(!u.innerText||!u.innerText.trim()){
      return ""
    }
    if(["SCRIPT","STYLE","SELECT","TEXTAREA"].includes(u.tagName)){
      return ""
    }else if(u.tagName=="BR"){
      return "\n"
    }
    var t="",co=0,lo=0,s,r=u.getBoundingClientRect();
    for(var i=0;i<u.childNodes.length;i++){
      var n=u.childNodes[i],tt="";
      if(n.nodeType==1){
        if(!_Util._isHidden(n)){
          tt=$util.getElementText(n,_chkSvg)
          co=n.getBoundingClientRect()
        }else{
          continue
        }
      }else if(n.nodeType==3){
        tt=n.textContent.trim()
        co=0
      }
      if(tt){
        if(lo){
          if(co){
            if(lo.bottom>co.top){
              s="\n"
            }else{
              s=" "
            }
          }else{
            if(lo.width+lo.left>=r.left+r.width-20){
              s="\n"
            }else{
              s=" "
            }
          }
        }else if(t){
          if(co){
            if(co.left==r.left){
              s="\n"
            }else{
              s=" "
            }
          }else{
            s=" "
          }
        }else{
          s=""
        }
        t+=s+tt
      }
    }
    /*
    if(!_back){
      $util._chkFunTime+=Date.now()-_time
    }
    */
    return t.trim()
  },
  //printDataToFile
  printDataToFile:function(f,d){
    if(f.toLowerCase().endsWith("csv")){
      d=_Util._toFileCSV($util.jsonToCSV(d))
    }else if(f.toLowerCase().endsWith("html")){
      d=_Util._toFileCSV($util.listToHtml(d))
    }else{
      d=JSON.stringify(d,0,2)
    }
    d=f+"\n"+d.trim()+"\n"
    console.log("BZ-OUTPUT-FILE:"+d+"BZ-OUTPUT-FILE-END")
  },
  //jsonToCSV
  jsonToCSV:function(d){
    if(d&&d.constructor==Array&&d.length){
        return Object.keys(d[0]).join(",")+"\n"+
      d.map(o=>{
        let v=""
        for(var k in o){
            let x=o[k]
            v+=x&&x.constructor==String?'"'+o[k].replace(/\"/g,'""')+'",':o[k]+','
        }
        return v.replace(/,(\n|$)/g,"\n").trim()
      }).join("\n")
    }
    return ""
  },
  //listToHtml
  listToHtml:function(d,c){
    if(d&&d.constructor==Array&&d.length){
      let _header="<tr><th>"+Object.keys(d[0]).join("</th><th>")+"</tr>"
      _header=_header.replace("</th><th></tr>","</th></tr>")+"\n"
      c=c||"table{width:100%}table,tr,td,th{border-collapse: collapse;border: 1px solid black;padding: 5px;}"
      return "<!DOCTYPE html><html><head><style>"+c+"</style></head><body><table>"+_header+d.map(o=>{
        let v="<tr>"
        for(var k in o){
          v+="<td>"+(o[k]&&o[k].constructor==String?o[k].replace(/\</g,'&lt;').replace(/\>/g,"$gt;"):o[k])+"</td>"
        }
        return v+"</tr>"
      }).join("\n")+"</table></body></html>"
    }
    return ""
  },
  //clearCookie
  clearCookie:function(_document){
    var cookies = _document.cookie.split("; ");
    for (var c = 0; c < cookies.length; c++) {
      var d = window.location.hostname.split(".");
      var _name=encodeURIComponent(cookies[c].split(";")[0].split("=")[0])
      // console.log(_name)
      _document.cookie = _name + '=; Max-Age=-99999999;';
    }
  //    _document.cookie.split(";").forEach(function(c) { _document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); });
  },
  //p: data path. like: "$test.data"
  //resetData
  resetData:function(pp){
    let d,p=pp.split(".")
    switch(p[0]){
      case "$project":d=$data(0,0,1);break;
      case "$module":d=$data(BZ._getCurModule()._data.code,0,1);break;
      case "$test":d=$data(BZ._getCurModule()._data.code,BZ._getCurTest()._data.code,1);break;
      case "$parameter":d=BZ._getCurTest()._data.defParameter;break;
    }
    if(d){
      try{
        if(d.constructor==String){
          d=_Util._eval("d="+d)
          _ideDataManagement._initRandomValue(d)
        }
        if(p.length>1){
          for(let i=1;i<p.length;i++){
            d=d[p[i]]
          }
          _Util._eval(pp+"=d",{d:d})
        }else{
          _Util._eval("pp="+pp)
          for(var k in d){
            pp[k]=d[k]
          }
        }
      }catch(e){}
    }
  },
  //generateDataByRegex
  generateDataByRegex:function(d,key,dd,kk,_notRoot){
    let _apiData
    d=_handleData(d,key,dd,kk)
    function _handleData(d,_key,dd,kk){
      if(!d){
      }else if([String,RegExp].includes(d.constructor)){
        let s=d.toString()
        if(s.match(/^[\/].+[\/]$/)){
          d= $util.generateWordsByRegex(s,_key,dd,kk)
        }else{
          d=s.match(/\{\{.+\}\}/)?_JSHandler._prepareData(s):s
        }
        if(d&&!bzTwComm._isExtension()&&d.constructor==BZApiDataPicker){
          _apiData=d
        }
      }else if([Object,Array].includes(d.constructor)){
        for(var k in d){
          d[k]= _handleData(d[k],k,d,k,1)
        }
      }
      return d
    }
    
    if(_apiData){
      _apiDataHandler._registerExeFun(function(){
        _doIt(d)
      })
    }else{
      _doIt(d)
    }
    return d
    
    function _doIt(d){
      if(dd){
        if(dd.constructor==Function){
          dd(d)
        }else if(kk){
          dd[kk]=d
        }
      }
    }
  },
    /*
    examples:
    let vs=[
      "[a-z]+[0-9]+",
      "BZ-name",
      "{today}",
      "{today-10}",
      "{today+10|MM/dd/yyyy}",
      "{today-1week|MM/dd/yyyy}",
      "{today+w}",
      "{today-1M}",
      "{today+M|MM/dd/yyyy}",
      "{today-1Y}",
      "{today+Y|MM/dd/yyyy}",
      "{today+10y+2M+1|MM/dd/yyyy}",
      "{this-month-first}",
      "{this-month-first+10|MM/dd/yyyy}",
      "{this-month-first+10M-2}",
      "{date:08/30/2020|MM/dd/yyyy|yyyy-MM-dd}",
      "{date:08/30/2020+y+1|MM/dd/yyyy|yyyy-MM-dd}",
      "{this-month,3}",
      "{date:08/20/2020+y+2M+12+7m+33s+3h|MM/dd/yyyy|yyyy-MM-dd hh:mm:ss}",
      "{last-month-first+y+2M+12+7m+33s+3h|MM/dd/yyyy|yyyy-MM-dd hh:mm:ss}"
    ]
    vs.forEach(v=>{
      console.log(v+": "+$util.generateWordsByRegex("/"+v+"/"))
    })
    */
  //generateWordsByRegex
  generateWordsByRegex(r,_key,_ddd,_kkk){
    try{
      if(!r){
        return _return(r)
      }
      r=r.toString()
      
      if(_Util._hasInsertCode(r)){
        r=_JSHandler._prepareData(r)
        return _return(r)
      }else if(_Util._hasCode(r)){
        r=_Util._eval("r="+r)
        return _return(r)
      }
      
      if(r[0]=="/"&&r[r.length-1]=="/"){
        r=r.substring(1,r.length-1)
      }
      if(r[0]=="/"&&r[r.length-1]=="/"){
        return _return("/"+r+"/")
      }
      r=_Util._getRegexByBZName(r)
      let _std=r.match(/\{(label|random:?|search[\: ]|search-list[\: ]|new[\: ]|exist-new[\: ]|exist[\: ]|exist-list[\: ]|date[\: ]|time[\: ]|num|time|date|module|this|next|last|today|tomorrow|yesterday|timestamp|textstamp|longtextstamp)[^\}]*\}/g)
      if(_std){
        if(_std[0]=="{label}"){
          return _Util._idToName($util.generateWordsByRegex(r.replace("{label}",_key||_bzMessage._common._description)));
        }else if(_std[0]&&_std[0].startsWith("{random")){
          return _return(_getRandom(_std[0]))
        }else if(_std[0]&&_std[0].startsWith("{exist")){
          if(bzTwComm._isExtension()){
            return ""
          }
          let v= _return(_getExist(_std[0]))
          return v
        }else if(_std[0]&&_std[0].startsWith("{new")){
          console.log("BZ-LOG: "+_std[0])
          return _return(_getCreate(_std[0]))
        }else if(_std[0]&&_std[0].startsWith("{search")){
          console.log("BZ-LOG: "+_std[0])
          return _return(_getSearch(_std[0]))
        }
        _std.forEach(s=>{
          let _stdValue=getStandard(s)
          let vs=r.split(s)
          let _result=""
          for(var i=0;i<vs.length;i++){
            _result+=vs[i]
            if(i<vs.length-1){
              _result+=_stdValue
            }
          }
          r=_result
        })
        return $util.generateWordsByRegex(r,_key,_ddd,_kkk)
      }else{
        _std=r.match(/\{data[\: ](.+)\}/)
        if(_std){
          _std=_std[1]
          _std=_std.replace(/[\=\>\<\!]/g,"")
          return _return(_std)
        }else{
          var vs=[];
          var m=1;
          if(m.constructor!=Number){
            m=1
          }
          for(var i=0;i<m;i++){
            vs.push(new RandExp(r).gen())
          }
          vs=vs[0]
          
          return _return(vs)
        }
      }
    }catch(e){}
    
    function _return(v){
      if(_ddd){
        if(_ddd.constructor==Function){
          _ddd(v)
        }else{
          _ddd[_kkk]=v
          if(v&&v.constructor==Promise){
            v.then(x=>_ddd[_kkk]=x)
          }
        }
      }
      return v===null?undefined:v
    }
    function _getRandom(vv){
      let v=vv.split(":")[1]
      if(v){
        v=v.substring(0,v.length-1)
        v=v.split("|")
        if(v[0].match(/^[0-9-\.]+$/)||_Util._hasCode(v[0])){
          return _getRandomNumber(v[0],v[1])
        }else if(v.length>1){
          v=$util.randomItem(v)
          if(v){
            return v.value
          }
        }
      }
      return "/"+vv+"/"
    }
    
    function _getRandomNumber(vv,ee){
      let v1,v2,e,v=vv.split(/[-~]/)
      if(_Util._hasCode(vv)){
        v=vv.split(/~/)
      }
      if(v.length>1){
        v1=parseFloat(_Util._stringToData(v[0]))
        v2=parseFloat(_Util._stringToData(v[1]));
      }else{
        v1=0
        v2=v;
      }
      let vvv=Math.random()*(v2-v1)+v1,l=1;
      if(v[0].match(/[0-9]+\.[0-9]+/)){
        l=v[0].split(".")[1].length
        l=Math.pow(10,l)
      }else if(v[1].match(/[0-9]+\.[0-9]+/)){
        l=v[1].split(".")[1].length
        l=Math.pow(10,l)
      }
      vvv=vvv*l
      v= Math.round(vvv)/l
      if(v>v2){
        v=v2
      }
      if(ee){
        e=ee.split(",")
        if(e.includes(v+"")&&v1!=v2){
          return _getRandomNumber(vv,ee)
        }
      }
      return v
    }
    
    async function _getExist(v){
      let s={};
      if(v.match(/\{exist-list[ :]/)){
        s={_list:1}
        v=v.replace(/\{exist-list[ :](.+)\}/,"$1")
      }else if(v.match(/\{exist-new[ :]/)){
        s={_new:1}
        v=v.replace(/\{exist-new[ :](.+)\}/,"$1")
      }else{
        v=v.replace(/\{exist[ :](.+)\}/,"$1")
      }
      return await _aiAPI._getExistData(v,s,_ddd,_kkk)
    }
    
    async function _getCreate(v){
      let s;
      v=v.replace(/\{new[ \:](.+)\}/,"$1")
      return await _aiAPI._createData(v,_ddd,_kkk)
    }
    async function _getSearch(v){
      let s={};
      if(v.match(/\{search-list[ :]/)){
        s={_list:1}
        v=v.replace(/\{search-list[ :](.+)\}/,"$1")
      }else if(v.match(/\{search-new[ :]/)){
        s={_new:1}
        v=v.replace(/\{search-new[ :](.+)\}/,"$1")
      }else{
        v=v.replace(/\{search[ :](.+)\}/,"$1")
      }
      return await _aiAPI._searchData(v,s,_ddd,_kkk)
    }

    function getStandard(v){
      let now=new Date(),n,d=new Date();
      var y=d.getFullYear(),m=d.getMonth();
      
      v=v.substring(1,v.length-1)
      v=v.split("|")
      if(v.length>1&&v[0].startsWith("date:")){
        return _getDate(v[0],v[1],v[2])
      }
      var w=v[0].match(/[a-z-]+[a-z]/),c;
      if(!w){
        w=v[0]
      }else{
        w=w[0]
        c=v[0].substring(w.length)
      }
      switch(w){
        case "now": 
        case "this":
        case "this-month":
        case "today": 
          break;
        case "num": 
          $project._tmpIdx=$project._tmpIdx||1
          return $project._tmpIdx++
        case "module": 
          let _tmpModule=window._tmpTakeDataModule||BZ._getCurModule()
          if(_tmpModule){
            return _tmpModule._data.name.replace(/[ ,\.-]+/g,"-")
          }
          return "Module"
        case "timestamp": return Date.now();
        case "time": return _Util._formatTimestamp(0,"hh:mm:ss");
        case "date": return _Util._formatTimestamp(0,"yyyy-MM-dd");
        case "this-month-first": 
          d.setDate(1)
          break;
        case "this-month-end":
          d.setDate(_getLastDate(d.getMonth()+1,d.getYear()))
          break;
        case "this-year-first": 
          d.setDate(1)
          d.setMonth(0)
          break;
        case "this-year-end":
          d.setMonth(11)
          d.setDate(31)
          break;
        case "tomorrow": 
          d=new Date(d.getTime()+86400000);
          break;
        case "longtextstamp":
          w=_Util._to62(parseInt(Date.now()/1000))
          if(_cooperatorHandler._data.inService){
            w+=_cooperatorHandler._data.key
          }
          return w
        case "textstamp":
          w=_Util._to36(parseInt(Date.now()/1000))
          if(_cooperatorHandler._data.inService){
            w+=_cooperatorHandler._data.key
          }
          return w
        case "timestamp":
          w=parseInt(Date.now()/1000)+""
          if(_cooperatorHandler._data.inService){
            w+=_cooperatorHandler._data.key
          }
          return w
        case "yesterday":
          d=new Date(d.getTime()-86400000);
          break;
        case "last-year":
          d.setYear(y-1);
          break
        case "last-year-first":
          d.setMonth(0)
          d.setDate(1);
          d.setYear(y-1);
          break
        case "last-year-end":
          d.setMonth(11)
          d.setDate(31);
          d.setYear(y-1);
          break
        case "last-month": 
          if(d.getMonth()){
            d.setMonth(d.getMonth()-1);
          }else{
            d.setMonth(11);
            d.setYear(y-1)
          }
          break
        case "last-month-first": 
          d.setDate(1);
          d.setMonth(d.getMonth()-1);
          break
        case "last-month-end": 
          d.setDate(1);
          if(d.getMonth()){
            d.setMonth(d.getMonth()-1);
          }else{
            d.setMonth(11);
            d.setYear(y-1)
          }
          d.setDate(_getLastDate(d.getMonth()+1,d.getYear()));
          break
        case "last-hour":
          d=new Date(d.getTime()-3600000)
          break
        case "last-minute":
          d=new Date(d.getTime()-60000)
          break
        case "last-second":
          d=new Date(d.getTime()-1000)
          break
        case "last-mon":
          n=6
        case "last-tus":
          n=n||5
        case "last-wed":
          n=n||4
        case "last-thu":
          n=n||3
        case "last-fri":
          n=n||2
        case "last-sat":
          n=n||1
        case "last-sun":
          n=n||7
          d=new Date(d.getTime()-86400000*(n+d.getDay()))
          break
        case "next-year":
          d.setYear(y+1);
          break
        case "next-year-first":
          d.setMonth(0)
          d.setDate(1);
          d.setYear(y+1);
          break
        case "next-year-end":
          d.setMonth(11)
          d.setDate(31);
          d.setYear(y+1);
          break
        case "next-month": 
          d.setMonth(d.getMonth()+1);
          break
        case "next-month-first":
          d.setDate(1);
          d.setMonth(d.getMonth()+1);
          break
        case "next-month-end": 
          d.setMonth(d.getMonth()+1);
          if(d.getMonth()+1==12){
            d.setDate(_getLastDate(0,d.getYear()+1));
          }else{
            d.setDate(_getLastDate(d.getMonth()+1,d.getYear()));
          }
          break
        case "next-hour":
          d=new Date(d.getTime()+3600000)
          break
        case "next-minute":
          d=new Date(d.getTime()+60000)
          break
        case "next-second":
          d=new Date(d.getTime()+1000)
          break
        case "next-mon":
          n=8-now.getDay();
        case "next-tus":
          n=n||9-now.getDay();
        case "next-wed":
          n=n||10-now.getDay();
        case "next-thu":
          n=n||11-now.getDay();
        case "next-fri":
          n=n||12-now.getDay();
        case "next-sat":
          n=n||13-now.getDay();
        case "next-sun":
          n=n||7-now.getDay()
          d=new Date(d.getTime()+86400000*n)
          break
        case "this-mon":
          n=n||1
        case "this-tus":
          n=n||2
        case "this-wed":
          n=n||3
        case "this-thu":
          n=n||4
        case "this-fri":
          n=n||5
        case "this-sat":
          n=n||6
        case "this-sun":
          n=n||0
          if(n){
            d=new Date(now.getTime()+86400000*(n-now.getDay()))
          }else{
            d=new Date(now.getTime()-86400000*now.getDay())
          }
      }
      
      if(c){
        if(c[0]==","){
          //for this month, last month, next month only
          d.setDate(parseInt(c.substring(1)))
        }else{
          d=_countDay(d,c)
        }
      }
      
      
      if(v.length==1){
        v.push("yyyy-MM-dd")
      }
      return _Util._formatTimestamp(d.getTime(),v[1])
      // for(var i=1;i<v.length;i++){
        // if(v[i].match(/^[0-9]+$/)){
          // d.setDate(parseInt(v[1]))
        // }else if(v[i].match(/^[0-9]+-[0-9]+$/)){
          // var vv=v[i].split("-")
          // d.setDate(parseInt(vv[1]))
          // d.setMonth(parseInt(vv[0])-1)
        // }else if(v[i]=="end"){
          // d.setDate(_getLastDate(d.getMonth()+1,d.getFullYear()))
        // }else{
          // return v[i].replace(/yyyy/i,d.getFullYear())
                 // .replace(/yy/i,_Util._formatNumberLength(d.getFullYear()%100))
                 // .replace(/MM/,_Util._formatNumberLength(d.getMonth()+1))
                 // .replace(/dd/i,_Util._formatNumberLength(d.getDate()))
                 // .replace(/hh/i,_Util._formatNumberLength(d.getHours()))
                 // .replace(/mm/,_Util._formatNumberLength(d.getMinutes()))
                 // .replace(/ss/i,_Util._formatNumberLength(d.getSeconds()))
                 // .replace(/M/,d.getMonth()+1)
                 // .replace(/d/i,d.getDate())
                 // .replace(/h/i,d.getHours())
                 // .replace(/m/,d.getMinutes())
                 // .replace(/s/i,d.getSeconds())
        // }
      // }
      
    }
    
    function _getLastDate(m,y){
      if([1,3,5,7,8,10,12].includes(m)){
        return 31
      }else if(m==2){
        return y%4?28:29
      }
      return 30
    }
    
    function _countDay(d,v){
      if(v){
        v=v.match(/[+-]([0-9]*y|[0-9]*M|[0-9]*w|[0-9]*d|[0-9]*h|[0-9]*m|[0-9]*s|[0-9]+)/gi)
        v&&v.forEach(vv=>{
          vv=vv.match(/([-+])([0-9]*)(y|Y|M|w|W|h|H|d|D|m|S|s)*/)
          if(!vv[2]){
            vv[2]=1
          }
          v=parseInt(vv[1]+vv[2])
          
          switch(vv[3]){
            case "Y":
            case "y":d.setYear(d.getFullYear()+v);break;
            case "M":d.setMonth(d.getMonth()+v);break;
            case "W":
            case "w":d.setDate(d.getDate()+v*7);break;
            case "H":
            case "h":d.setHours(d.getHours()+v);break;
            case "m":d.setMinutes(d.getMinutes()+v);break;
            case "S":
            case "s":d.setSeconds(d.getSeconds()+v);break;
            case "d":
            case "D":
            default:
              d.setDate(d.getDate()+v)
          }
        })
      }      
      return d
    }
    //d: date, pf: parse date format, ft: format to
    function _getDate(d,pf,ft){
      d=d.substring(5)
      ft=ft||pf
      let f1=pf.split(_Util._allSign),
          f2=pf.split(_Util._allLetterAndNumber),
          d1=d.split(_Util._allSign),
          d2=d.split(_Util._allLetterAndNumber),c,ii=0,i=0,df={},fd="",
          ff=/yyyy|YYYY|yy|YY|MM|M|DD|dd|D|d|HH|H|hh|h|mm|m|SS|ss|S|s/g,
          di=["yy","yyyy","YY","YYYY","MM","M","DD","dd","D","d","HH","hh","H","h","mm","m","SS","ss","S","s"]
          
      _Util._spliceAll(f1,a=>{return !a})
      _Util._spliceAll(f2,a=>{return !a})
      _Util._spliceAll(d1,a=>{return !a})
      _Util._spliceAll(d2,a=>{return !a})
      d1.splice(f1.length)
      d2.splice(f2.length)
      if(f1.length){
        if(f1.length==1){
          i=f1[0].length
        }else{
          i=f1.reduce((v,o)=>{
            return (v.length||v)+(o?o.length:0)
          })
        }
      }
      if(f2.length){
        if(f2.length==1){
          ii=f2[0].length
        }else{
          ii=f2.reduce((v,o)=>{
            return (v.length||v)+(o?o.length:0)
          })
        }
      }
      i+=ii
      c=d.substring(i)
      d=d.substring(0,i)
      
      f1.forEach((v,j)=>{
        v=v.match(ff)
        v&&v.forEach(vv=>{
          if(v.length==1){
            df[vv]=d1[j]
          }else{
            df[vv]=d1[j].substring(0,vv.length)
            d1[j]=d1[j].substring(vv.length)
          }
        })
      })

      // di.forEach(v=>{
        // fd+=df[v]||""
        // if(
      // })
      d=new Date()
      d.setDate(1)
      for(let kk in df){
        let k=kk[0]
        if(k=="D"||k=="d"){
          let v=df[kk]
          delete df[kk]
          df[kk]=v
        }
      }
      for(let kk in df){
        let k=kk[0],
            v=df[kk]
            v=parseInt(v)||v
        switch(k){
          case "Y":
          case "y":
            if(kk.length==2){
              if(v>70){
                v+=1900
              }else{
                v+=2000
              }
            }
            d.setYear(v);
            break;
          case "M":d.setMonth(v-1); break;
          case "D":
          case "d":d.setDate(v);break;
          case "H":
          case "h":d.setHours(v);break;
          case "m":d.setMinutes(v);break;
          case "S":
          case "s":d.setSeconds(v);
        }
      }
      
      d=_countDay(d,c)
      return _Util._formatTimestamp(d.getTime(),ft)
    }
  },
  //triggerKeyEvents
  triggerKeyEvents:function(o,k,ch,c,a,s,_fun){ //c:ctrl, a:alt, s:shift
        if(_Util._isSysButton(o)&&[13,32].includes(k)){
            return $util.triggerMouseEvents(o,"click",0,0,0,0,0,_fun)
    }
    $(o).focus();
    setTimeout(()=>{
            o._bzSetKeyPress=0;
      try{
        $util.triggerKeyEvent(o,"keydown",k,ch,c,a,s)
      }catch(e){
        _domActionTask._doLog("util: "+1345+" "+e.stack)
      }
      _exe("_keydownDone",function(){
                if((!c && !a) || _Util._checkBrowserType().name=="firefox"){
          if(_Util._isHidden(o)){
            return _finalFun()
          }
          $util.triggerKeyEvent(o,"keypress",k,ch,c,a,s)
                    _exe("_keypressDone",function(){
                        if(_Util._isHidden(o)){
                            return _finalFun()
            }
            $util.triggerKeyEvent(o,"textInput",k,ch,c,a,s);
            if(_Util._isHidden(o)){
                            return _finalFun()
            }
              $util.triggerKeyEvent(o,"input",k,ch,c,a,s);
            if(_Util._isHidden(o)){
              return _finalFun()
            }
            try{
              $util.triggerKeyEvent(o,"keyup",k,ch,c,a,s);
              if(k==9 && ["INPUT","SELECT","A","LINK","BUTTON","TEXTAREA"].includes(o.tagName)){
                _Util._focusNextByTab(o)
              }
            }catch(ex){
            }
            _finalFun()
          })
        }else{
          $util.triggerKeyEvent(o,"keyup",k,ch,c,a,s);
          _finalFun()
        }
      })
    },1)
    function _exe(k,_next,_timer){
      _timer=_timer||Date.now()
      if(o[k]||Date.now()-_timer>50){
        o[k]=0
                return _next()
      }
      setTimeout(function(){
        _exe(k,_next,_timer)
      },1)
    }
    
    function _finalFun(){
            _fun&&_fun()
    }
  },
  //triggerKeyEvent
  triggerKeyEvent:function(o,e,k,ch,c,a,s){
    if(!o){
      return
    }
    $(o).focus()
    o._bzKey=ch
    o._bzKeyCode=k
    if(ch&&o.maxLength&&o.maxLength>0&&o.maxLength<=(o.value+"").length){
      return
    }
    if(!e.startsWith("key")){
      e="key"+e;
    }
    if(e=="keypress"){
      k=ch;
    }
    if(!o._bzSetKeyPress){
      o._bzSetKeyPress=1;
      
      $(o).keydown(function(_event){
        this._keydownDone=1
        this._bCancel=_event.originalEvent.cancelBubble
      });
      $(o).keypress(function(_event){
        this._keypressDone=1
        if(!this._bCancel && !_event.originalEvent.isTrusted){
          if(this._bzKey && (this.tagName=="TEXTAREA" || (this.tagName=="INPUT" && this._bzKey))){
            this.value+=String.fromCharCode(this._bzKey);
          }else if(this._bzKeyCode==13 && ["INPUT","SELECT"].includes(this.tagName)){
            var f=_Util._getParentByTagName(this,"FORM")
            if(f){
              var o=$(f).find("input[type=submit]")[0]
              if(o){
                f.submit()
              }else{
                f.dispatchEvent(new Event("submit"));
              }
            }
          }
        }
        this._bCancel=0
      })
    }
    
    let _jsPath
    o.focus()
    if(document.activeElement!=o){
            o.bzTmp=_cssHandler._findPath(o)
      _Util._setFindDomJS(o)
      _jsPath=o._jsPath
    }else{
      _jsPath="document.activeElement"
    }
    let _key=k==13?"Enter":k==9?"Tab":k==32?"Space":String.fromCharCode(ch),
        _code=k==13?"Enter":k==9?"Tab":k==32?"Space":'Key'+String.fromCharCode("+ch+").toUpperCase()
    var s="setTimeout(function(){var o="+_jsPath+";var k = new KeyboardEvent('"+e+"', {bubbles:true}); "
         +"Object.defineProperty(k, 'charCode', {get:function(){return "+(e=="keypress"?ch:0)+";}});"
         +"Object.defineProperty(k, 'keyCode', {get:function(){return "+k+";}});"
         +"Object.defineProperty(k, 'which', {get:function(){return "+k+";}});"
         +"Object.defineProperty(k, 'key', {get:function(){return '"+_key+"';}});"
         +"Object.defineProperty(k, 'code', {get:function(){return '"+_code+"';}});"
         +"Object.defineProperty(k, 'composed', {get:function(){return true;}});"
         +"k.charCodeVal = "+(ch||0)+";"
         +"o.dispatchEvent(k);},0);"
    bzTwComm._postToApp({c:s})
    setTimeout(()=>{
      o._keydownDone=1
    },10)
    
  },
  //o:element, e:event, b:button, x, y, c:ctrlKey, a:alt, s:shift, t:target,tr:dataTransfer
  //triggerMouseEvent
  triggerMouseEvent:function(o,e,b,x,y,c,a,s,tr,_fun){
    if(!o){
      return
    }else if(o.constructor==Array){
      o.forEach(oo=>{
        $util.triggerMouseEvent(oo,e,b,x,y,c,a,s,tr)
      })
      return _fun&&_fun()
    }
    var _curWin=_Util._getWindowFromDom(o);
    if(o.tagName=="CANVAS"&&o.bzTxtElement&&(["click","mousedown","dblclick"].includes(e)||("mouseup"==e&&x==-1&&y==-1))){
      let r=o.getBoundingClientRect(),
          te=o.bzTxtElement;
      if(o._offset){
        x=o._offset.x
        y=o._offset.y
      }else{
        x=r.left+te.x+te.w/2
        y=r.top+te.y+te.h/2
      }
    }
    b=parseInt(b||1);
    x=parseInt(x||0)
    y=parseInt(y||0)
    if(b==2 && e=="click"){
      e="contextmenu"
    }else if(e=="click"){
      b=0
    }
    var ps={
      'view': _curWin,
      'bubbles': true,
      //composedPath:$util.getComposedPath(o),
      'cancelable': true,
      buttons:parseInt(b),
      ctrlKey:c,
      metaKey:false,
      altKey:a,
      shiftKey:s,
      clientX:x,
      clientY:y,
      pointerX:x,
      pointerY:y,
      relatedTarget:null
    },_event
    if(tr){
      ps.dataTransfer=tr;
      ps.target=o;
      _event = new DragEvent(e, ps);
    }else{
      _event = new MouseEvent(e, ps);
    }
    o.dispatchEvent(_event);
    if(e=="mouseover"){
      o.dispatchEvent(new MouseEvent("mouseenter",ps));
    }else if(e=="mousedown"){
      o.dispatchEvent(new MouseEvent("pointerdown",ps));
    }else if(e=="mouseup"){
      o.dispatchEvent(new MouseEvent("pointerup",ps));
    }else if(e=="mousemove"){
      o.dispatchEvent(new MouseEvent("pointermove",ps));
    }
    if(_fun){
      _fun()
    }
  },
  getComposedPath:function(o){
    
  },
  //triggerFocusEvent
  triggerFocusEvent:function(o){
    var _event=new FocusEvent("focus")
    o.dispatchEvent(_event)
  },
  //triggerWheelEvent
  triggerWheelEvent:function(o,v){
    var _event = new WheelEvent({
      'view': _curWin,
      'bubbles': true,
      'cancelable': true,
      deltaX:v,
      deltaY:v,
      deltaZ:v
    });
    return o.dispatchEvent(_event);
    
    var e = jQuery.Event( "DOMMouseScroll",{delta: v} );
    $(o).trigger(e)
  },
  //triggerDblClickEvents
  triggerDblClickEvents:function(o,b,x,y,c,a,s){
    $util.triggerMouseEvents(o,b,x,y,c,a,s)
    $util.triggerMouseEvents(o,b,x,y,c,a,s)
    $util.triggerMouseEvent(o,"dblclick",b,x,y,c,a,s);
  },
  //triggerMouseEvents
  triggerMouseEvents:function(o,b,x,y,c,a,s,_fun){
    x=x||1
    y=y||1
    this.triggerMouseEvent(o,"mouseenter",0,x,y,c,a,s);
    this.triggerMouseEvent(o,"mouseover",0,x,y,c,a,s);
    this.triggerMouseEvent(o,"mousemove",0,x,y,c,a,s);
    this.triggerMouseEvent(o,"mousedown",b,x,y,c,a,s);
    if(o.tagName=="CANVAS"&&o.bzTxtElement){
      this.triggerMouseEvent(o,"mouseup",b,-1,-1,c,a,s);
    }else{
      this.triggerMouseEvent(o,"mouseup",b,x,y,c,a,s);
    }
    this.triggerMouseEvent(o,"click",b,x,y,c,a,s);
    if(_Util._isFocusable(o)){
      this.triggerFocusEvent(o)
    }
    if(_fun){
      _fun()
    }
  //    this.triggerMouseEvent(o,"mouseout",0,x,y,c,a,s);
  //    $(o).focus();
  },
  //triggerChangeEvent
  triggerChangeEvent:function(o,v,_blur,_result,_withEnter,_withSubmit,_fun,_noAutoSelect){
    if(!_withEnter&&!_withSubmit&&o.tagName=="INPUT"&&o.type!="file"){
      _Util._preTriggerEvent()
    }else{
      _noAutoSelect=1 
    }
    var ff,ov=v;
    o.focus()
    _doIt()
    // $util.triggerMouseEvents(o,1,0,0,0,0,0,function(){
    //   setTimeout(()=>{
    //   },v=="christina@pivohub"?3000:0)
    // })
  //    o.value=this._getRealWord(o,v);
    function _doIt(){
      try{
        if(!_Util._isStdInputElement(o)){
          if(!o.attributes["contenteditable"]&&(!v||$util.getElementText(o).includes(v)||v.startsWith("/{random"))){
            return $util.triggerMouseEvents(o,1,0,0,0,0,0)
          }else if(o.attributes["contenteditable"]){
            o.innerHTML=v;
          }
        }else if(o.tagName=="SELECT"){
          v=v.toLowerCase().trim()
          var _best=0,_found;
          for(var i=0;i<o.options.length;i++){
            var t=o.options[i].text || o.options[i].textContent||"";
            t=t.toLowerCase()
            if(v==t){
              o.options[i].selected=_found=true;
              break
            }else if(v.includes(t)){
              if(t.length>_best){
                _best=t.length
                o.options[i].selected=_found=true;
              }
            }else if(t.includes(v)){
              if(v.length>_best){
                _best=v.length
                o.options[i].selected=_found=true;
              }
            }
          }
          if(!_found&&_result){
            _result._type=2;
            _result._msg=_Util._formatMessage(_bzMessage._action._setValueFailed,[ov])
          }
        }else if(o.type=="file"){
          _uploadHandler._setFileValue(o,v);
    //        ff=_Util._eval("ff="+v);
    //        v=_uploadHandler._buildUploadBold(ff);
        }else if(o.value!=v){
    //        o.value=v;
        }
        
        try{
          if(o.type!="file"){
            //trigger react event
            if(o.tagName=="INPUT"){
              o.value=v
              var nativeInputValueSetter = Object.getOwnPropertyDescriptor(o.ownerDocument.defaultView.HTMLInputElement.prototype, "value").set;
              nativeInputValueSetter.call(o,v);
            }else if(o.tagName=="TEXTAREA"){
              o.value=v
              var nativeInputValueSetter = Object.getOwnPropertyDescriptor(o.ownerDocument.defaultView.HTMLTextAreaElement.prototype, "value").set;
              nativeInputValueSetter.call(o,v);
            }else if(o.tagName!="SELECT"){
              if(o.value!=v){
                o.value=v
              }
            }
          }
          var event = new Event("input", { bubbles: true });
          o.dispatchEvent(event);
        }catch(e){
          _domActionTask._doLog("util 1664: "+e.message)
          _domActionTask._reportAppInfo("error on Set: "+e.stack)
        }
        try{
          var event = new Event("change", { bubbles: true });
          o.dispatchEvent(event);
        }catch(e){
          console.log(e.stack);
        }
        if(_withEnter){
                    return $util.triggerKeyEvents(o,13,0,false,false,false,function(){
                        _doFinal()
          });
        }else if(_withSubmit){
          let _form=_Util._getParentElementByCss("form",o)
          if(_form){
                        _doFinal()
            _form.submit()
            return
          }
                    _doFinal()
        }else if(!_noAutoSelect){
                    return _autoClickMenuAfterSetValue(v,o,_doFinal)
        }else{
                    return _doFinal()
        }
      }catch(eee){
                _domActionTask._doLog("util: "+eee.stack)
        console.log(eee.stack);
        _doFinal()
      }
    }

    // 
    function _doFinal(){
            if(_blur){
                $util.triggerBlurEvent(o);
      }
      _domActionTask._doLog("util: "+1709+(_fun?1:0))
      if(_fun){
        let _tmp=_fun
        _fun=0
        _tmp()
      }
      
    }
    function _autoClickMenuAfterSetValue(v,dom,_afterFun){
            if(!_handleDiff(v,dom,_afterFun)){
        if(!_Util._isHidden(dom)){
                    $util.triggerKeyEvents(dom,null,null,false,false,false,_afterFun);
        }else{
                    _afterFun&&_afterFun()
        }
        setTimeout(()=>{
          if(!_Util._isHidden(dom)){
                        _handleDiff(v,dom)
          }
        },50)
      }else{
              }
    }

    function _handleDiff(v,dom,_afterFun){
      try{
        let _diff=_Util._getDiffAfterTriggerEvent()
        if(_diff){
          _diff=$(_diff).find(`:Contains(${v})`).toArray()
          if(_diff.length){
            _diff=_diff.filter((x,i)=>{
              if(_diff.length-i>1){
                return !$(_diff[i]).find(_diff[i+1])[0]&&x.getBoundingClientRect().width>20
              }else{
                return 1
              }
            })
            if(_diff.length){
              let ds=_diff.filter(x=>x.getBoundingClientRect().width&&x.innerText.trim())
              if(!ds.length){
                return
              }else{
                _diff=ds
              }
              ds=_diff.filter(x=>x.innerText.trim().toLowerCase().startsWith(v.toLowerCase()))
              if(ds.length){
                _diff=ds
              }
              if(_diff.find(x=>{
                if(_Util._isInMenu(x,o)){
                  _domActionTask._doLog("Click menu: "+x.outerHTML)
                  $util.triggerMouseEvents(x,1,0,0,0,0,0,function(){
                                        $util.triggerKeyEvents(dom,null,null,false,false,false,_afterFun);
                  })
                  return 1
                }
              })){
                return 1
              }
            }
          }
        }
      }catch(ex){
        _domActionTask._reportAppInfo("Set input 88: "+ex.message+"\n"+ex.stack)
      }
    }
  },
  //triggerBlurEvent
  triggerBlurEvent:function(o,_fun){
    setTimeout(function(){
      // var a=_IDE._data._curAction;
      // var os=$(o.ownerDocument.body).find("input")
      // for(var i=0;i<os.length;i++){
        // if(os[i]!=o&&!_Util._isHidden(os[i])){
          // $(os[i]).focus()
          // console.log(os[i])
          // return
        // }
      // }
      if(bzTwComm._isExtension()){
        _Util._getWindowFromDom(o).focus();
        var _path=_Util._getQuickPath(o)
        bzTwComm._postToApp({c:"var bzBlur=_Util._getElementByQuickPath('"+_path+"');try{$(bzBlur).blur()}catch(e){bzBlur&&bzBlur.blur()}"})
      }else{
        var _curWin=_Util._getWindowFromDom(o);
        $(o).blur();
        if(_curWin.angular){
          var e=_curWin.angular.element(o);
          if(e.blur){
            e.blur();
          }
          if(e.triggerHandler){
            e.triggerHandler("blur");
          }
        }
      }
      _fun&&_fun()
    },30)
  },
  //outerHTML
  outerHTML:function(o){
    if(o.outerHTML){
      return o.outerHTML;
    }
    var _win = _Util._getWindowFromDom(o);
    var box = _win.document.createElement("div");
    var n = o.nextSibling;
    var p=o.parentNode;
    box.appendChild(o);
    var rv=box.innerHTML;
    if(n){
      p.insertBefore(o,n);
    }else{
      p.appendChild(o);
    }
    
    return rv;
  },
  findDoms:function(p){
    let o=_Util._findDoms(p)
    return o.toArray?o.toArray():o
  },
  //findDom
  findDom:function(paths,_errOnHidden){
    var os=_Util._findDoms(paths,_errOnHidden)
    if(os){
      os=os[0]
    }
    return window.$element=os
  },
  //isDomExist
  isDomExist:function(p){
    return Boolean($util.findDom(p))
  },
  //nextKey
  nextKey:function(d,ck){
    var _bNext=!ck && ck!=0;
    for(var k in d){
      if(k==ck){
        _bNext=true;
      }else if(_bNext){
        return k;
      }
    }
    return null;
  },
  //findIFrame
  findIFrame:function(ii,n,d){
    d=d||BZ.TW;
    var i=0
    while(ii.length>i){
      var v=ii[i++]
      d=d.frames[v]
      if(!d){
        return
      }
    }
    return d.document
  },
  //getCurEnvironment
  getCurEnvironment:function(){
    var v= _Util._clone(BZ._curEnv)
    v.items.forEach((o,i)=>{
      let t=_aiAuthHandler._data[i]
      if(t){
        o.token=t.tokenValue
      }
    })
    return v;
  },
  getTokenByHostId:function(i){
    if(i===undefined){
      i=BZ._getCurTest()
      if(i){
        i=i._data.hostId
        i=_aiAuthHandler._getTokenHostIdxByUIHostIdx(i)
      }
    }
    return _aiAuthHandler._getToken(i||0)
  },
  setToken:function(v,i){
    if(v){
      if(v.constructor==String){
        v=v.trim()
        v.replace(/^authorization[^a-z0-1](.+)/i,"$1");
        v={
          Authorization:v
        }
      }
      if(i===undefined){
        i=_IDE._getDefaultAPIHostIdx()||0
      }
      _aiAuthHandler._setToken({
        tokenValue:v,
        _tokenHost:i
      })
    }
  },
  //removeToken
  removeToken:function(){
    $aiAPI.removeToken()
  },
  //getCurEnvironmentIdx
  getCurEnvironmentIdx:function(){
    return _IDE._data._setting.curEnvironment
  },
  //setEnvironment
  setEnvironment:function(v){
    _IDE._data._setting.curEnvironment=v
    BZ._curEnv=_IDE._data._setting.environments[v];
    _extensionComm._setShareData({"BZ._curEnv":BZ._curEnv,"_IDE._data._setting.curEnvironment":_IDE._data._setting.curEnvironment})
  },
  //getCoopStatus
  getCoopStatus:function(d,n){
    return _cooperatorHandler._getCoopStatus(d,n)
  },
  //getCoopStatus
  getCoopStatus:function(d,n){
    return _cooperatorHandler._getCoopStatus(d,n)
  },
  //getCoopStatus
  getCoopStatus:function(d,n){
    return _cooperatorHandler._getCoopStatus(d,n)
  },
  //getCoopKey
  getCoopKey:function(){
    return _cooperatorHandler._data.inService?_cooperatorHandler._data.key:0
  },
  //getCoopScope
  getCoopScope:function(){
    return _cooperatorHandler._data.inService?_cooperatorHandler._data.scope:""
  },
  //getCoopGroup
  getCoopGroup:function(){
    return _cooperatorHandler._data.inService?_cooperatorHandler._data.group:""
  }
}

//Remove output function content
for(let k in $util){
  $util[k].toString=function(){}
};var _BZDocumentsHandler={
  find:function(_jPath){
    var _result=null;
    this._documents.each(function(i,d){
      try{
        if(!_result){
          _result=$(d).find(_jPath);
        }else{
          _result=_result.add($(d).find(_jPath));
        }
      }catch(e){}
    });
    return _result;
  },
  each:function(_fun){
    if(this._documents && this._documents.each){
      this._documents.each(_fun);
    }
  },
  _buildMe:function(_preDoc){
    if(bzTwComm._isExtension()){
      this._documents=$(window.document);
      return this;
    }
    try{
      if(!BZ.TW || BZ.TW.closed || BZ.TW.bzReloading || !BZ.TW.document || !BZ.TW.document.body || !BZ.TW.document.body.innerHTML){
        return 0;
      }
    }catch(e){
      return 0;
    }
    this._documents=$(BZ.TW.document);
    BZ._data._hasTW=true;
    BZ._insertCSSIntoDoc&&BZ._insertCSSIntoDoc(BZ.TW.document);

    var fs=$(BZ.TW.document).find("IFRAME");
    for(var i=0;i<fs.length;i++){
      var f=fs[i];
      try{
        if(f.src && !_TWHandler._isSameDomain(f.src)){
          continue;
        }else if(f.src && (!f.contentDocument || !f.contentDocument.body)){
          return 0;
        }else{
          BZ._insertCSSIntoDoc(f.contentDocument);
          this._documents=this._documents.add($(f.contentDocument));
        }
      }catch(e){}
    }
    return this;
  },
  _getBodyHtml:function(){
    var _html="";
    this._documents.each(function(i,d){
      try{
        _html+=d.body.outerHTML;
      }catch(e){}
    });
    return _html;
  }
};var _CtrlDriver={
  bd:{"{":"}","[":"]","(":")","'":"'",'"':'"','`':'`'},
  _tmpValue:0,
  _curDomItem:null,
  _curSignedList:[],
  _updateUIList:[],
  _cleanList:new Set(),
  _refershDataList:[],
  _arrayUIList:[],
  _afterUpdateFunList:[],
  _proxyTypes:[Location,Object,Array],
  _delaySet:function(d,k,v){
    setTimeout(()=>{
      d[k]=v
    },10)
  },
  _updateObj:function(o,kk,v){
    if(kk.constructor!=Array){
      kk=[kk]
    }
    kk.forEach(k=>{
      o[k]=0
      if(v===undefined){
        delete o[k]
      }else{
        o[k]=v
      }
    })
  },
  _refreshData:function(d,k,_fun,vv){
    // _CtrlDriver._refershDataList=_CtrlDriver._refershDataList.filter(x=>Date.now()-x._time<100)
    // if(_CtrlDriver._refershDataList.find(x=>x.k==k)){
      // return
    // }
    let v=d[k]
    d[k]=vv===undefined?!v:vv
    setTimeout(()=>{
      d[k]=v
      // _CtrlDriver._refershDataList.push({
        // k:k,
        // _time:Date.now()
      // })
      _fun&&_fun()
    },100)
  },
  _isProxibleObj:function(o){
    return o && !o._isBZProxy && _CtrlDriver._proxyTypes.indexOf(o.constructor)>=0;
  },
  _mergeData:function(_from,_toData){
    for(var k in _from){
      _toData[k]=_from[k]
    }
  },
  _replaceData:function(_from,_toData){
    _CtrlDriver._mergeData(_from,_toData);
    for(var k in _toData){
      if(_from[k]!=_toData[k]){
        _toData[k]=undefined;
      }
    }
  },
  _createBZArea:function(_doc){
    var o=$(_doc).find("#bz-tmp-area");
    if(!o.length){
      $("<div id='bz-tmp-area'></div>").insertAfter(_doc.body);
      o=$(_doc).find("#bz-tmp-area");
    }
    return o;
  },
//support parse html to dom-json
  _findKeyOuterBlock:function(vs,tk,_start,bs,_noRegex){
    bs=bs||_CtrlDriver.bd
    let k,b,c,s;
    _init()
    if(vs.push){
      vs=[...vs]
    }
    if(_start){
      vs=vs.push?vs.splice(_start):vs.substring(_start)
    }
    for(let i=0;i<vs.length;i++){
      c=vs[i]
      if(c=="/"&&vs[i+1]==">"){
        vs=vs.substring(0,i)+"></"+vs.match(/^<([^ \/>]+)/)[1]+">"+vs.substring(i+2)
        c=">"
      }
      if(c=="\\"){
        b=!b
      }else if(b){
        b=0
      }else if(!_noRegex&&k=="/"&&c=="/"){
        _init()
        continue
      }else if(!_noRegex&&!k&&c=="/"&&(!s||s.trim().match(/[\(\[\=\?\:]$/))){
        k="/"
        continue
      }else if(k){
        if(k.r==c){
          if(k.n){
            k.n--
          }else{
            _init()
          }
        }else if(k.l==c){
          k.n++
        }
        continue
      }else if(bs[c]){ //([{
        k={l:c,r:bs[c],n:0,p:{k:c}}
      }
      s.push?s.push(c):s+=c;

      let kk=_isKey(s,c)
      if(kk){
        if(vs.pop){
          return {
            e:vs.splice(i+1),
            p:vs.splice(0,i),
            k:kk
          }
        }
        return {
          p:vs.substring(0,i-kk.length+1),
          k:kk,
          e:vs.substring(i+1)
        }
      }
    }

    function _init(){
      k=0
      s=vs.constructor==Array?[]:"";
    }

    function _isKey(s,c){
      if(tk.constructor==Function){
        return tk(s)
      }else if(tk.constructor==RegExp){
        s=s.match(tk)
        return s&&s[0]
      }
      return (tk==s||tk==c)&&tk
    }
  },
  _parseViewDef:function(s){
    let r= {s:s.trim()}
    let rr=[];
    _parseXML(r.s,rr,[])
    if(rr.length==1){
      rr=rr[0]
    }
    return rr

    function _parseXML(s,rs,ps){

      let p=_CtrlDriver._findKeyOuterBlock(s,">")
      if(p){
        let d={}
        rs.push(d)
        p.p=_parseTag(p.p,d)
        _parseProperties(p.p,d)
        p.e=p.e.trim()
        if(p.p&&p.p.endsWith("/")){
          p=_parseContent(p.e,rs)
          // p=_CtrlDriver._findKeyOuterBlock(p.e,"<")
          // if(p.p){
          //   p.p=p.p.trim()
          // }
          // if(p.p){
          //   let dd={}
            
          // }
          return _parseXML(p,rs,ps)
        }else{
          d._items=d._items||[]
          p=_parseContent(p.e,d._items)
          if(p[0]=="/"){
            let i=0
            while(p[0]=="/"){
              p=p.replace(/^\/[^>]+>/,"")
              p=p?_parseContent(p,rs):p
              if(i){
                rs=ps.shift()
              }
              i++
            }
            return _parseXML("<"+p,rs,ps)
          }else{
            ps.unshift(rs)
            return _parseXML("<"+p,d._items,ps)
          }
        }
      }
    }

    function _parseTag(s,d){
      s=s.substring(1)
      let p=_CtrlDriver._findKeyOuterBlock(s," ")
      if(p){
        d._tag=p.p
        return p.e
      }
      if(s.endsWith("/")){
        d._tag=s.substring(0,s.length-1)
        return "/"
      }else{
        d._tag=s
      }
      return ""
    }

    function _parseProperties(s,d){
      s=s.trim()
      if(!s){
        return
      }
      d._attr=d._attr||{}
      let p=_CtrlDriver._findKeyOuterBlock(s,"=")
      if(p){
        p.p=p.p.split(/\s/).map(x=>x);
        let y=p.p.pop()
        p.p.forEach(x=>{
          d._attr[x]=1
        })
        let pp=_CtrlDriver._findKeyOuterBlock(p.e.trim()," "),dd;
        if(y[0]=="_"){
          dd=d
        }else if(["click","dblclick","change","focus","blur","mouseover","mousedown","mouseup","keydown","keyup","keypress"].includes(y)){
          d._jqext=d._jqext||{}
          dd=d._jqext
        }else{
          dd=d._attr
        }
        if(pp){
          dd[y]=_parseValue(pp.p,1)
          _parseProperties(pp.e,d)
        }else{
          dd[y]=_parseValue(p.e,1)
        }
      }else{
        s.split(/\s/).forEach(x=>{
          d._attr[x]=1
        })
      }
    }

    function _parseContent(s,rs){
      s=_CtrlDriver._findKeyOuterBlock(s,"<")
      if(s){
        s.p=s.p.trim()
        if(s.p){
          rs.push({
            _text:_parseValue(s.p)
          })
        }
        return s.e
      }
    }

    function _parseValue(s,p){
      if(p){
        if(s.match(/["'\[]/)){
          eval("s="+s)
          return s
        }
      }
      if(_CtrlDriver._isFunction(s)){
        eval("s="+s)
        return s
      }
      return s
    }

    function _throwError(){
      throw new Error(_bzMessage._system._error._formatError+s.substring(0,100)+(s.length>100?" ...":""))
    }
  },
  _execute:function(_ctrl,_data,_viewDef,_box){
    _doc=_ctrl._document||document;
    _data = _data || _ctrl._data || {};
    _viewDef=_viewDef || _ctrl._viewDef;
    _box=_box || _ctrl._area || (_doc==document?_doc.body:_CtrlDriver._createBZArea(_doc));
    if(!_ctrl._data){
      _ctrl._data=_data;
    }
    if(_data==_ctrl._data){
      _data=_CtrlDriver._buildProxy(_data);
      _ctrl._data=_data;
    }else if(!_data._isBZProxy){
      throw Error("Data is not build in binding. ('"+JSON.stringify(_data,0,2)+"')")
    }
    _CtrlDriver._initUIBind(_ctrl,_data,_viewDef);
    var _dom = _CtrlDriver._drawView(_ctrl,_data,_viewDef,_box);
    _CtrlDriver._curDomItem = null;
    return _dom;
  },
  _monitorData:function(_target,name,value){
    if(window.BZ&&BZ._debugger){
      if(!_CtrlDriver._lastSet){
        _CtrlDriver._lastSet={}
      }
      if(_CtrlDriver._lastSet._target!==_target || _CtrlDriver._lastSet.name!==name){
        _CtrlDriver._lastSet={_target:_target,name:name,value:value,_repeat:0,_repeatValue:0}
      }else{
        if(_CtrlDriver._lastSet.value!==value){
          _CtrlDriver._lastSet._repeatValue++
        }
        _CtrlDriver._lastSet._repeat++
        // if(_CtrlDriver._lastSet._repeat>BZ._debugger){
        //   debugger
        // }else if(_CtrlDriver._lastSet._repeatValue>10&&_CtrlDriver._lastSet._repeatValue<=BZ._repeat/2){
        //   debugger
        // }
      }
    }
  },
  _buildProxy:function(_data,_parent,_name){
    if(!_data){
      return _data
    }
    if(!_data._isBZProxy){
      return new Proxy(_data, {
        _parent:_parent,
        _name:_name,
        get:function(_target, name){
          if(name=="_isBZProxy"){
            return true;
          }else if(name=="_uiMap"){
            if(!this._uiMap){
              this._uiMap={};
            }
            return this._uiMap;
          }else if(name=="constructor"){
            return _target.constructor;
          }else if(name=="_target"){
            return _target;
          }
          
          var _result=_target[name];
          
          //Add to be refreshed ui setting
          if(!this._uiMap){
            this._uiMap={};
          }
          if(_CtrlDriver._isProxibleObj(_result)){
            _target[name]=_CtrlDriver._buildProxy(_target[name],this,name);
          }
          
          if(_CtrlDriver._curDomItem){
            if(!this._uiMap[name] && (_CtrlDriver._isProxibleObj(_target)) && (!_result || _result.constructor!=Function) && !(_target.constructor==Array && name=="length")){
              this._uiMap[name]=[];
            }
            
            if(_result && _result.constructor==Array && !_target[name]._uiMap.splice){
              _target[name]._uiMap.splice=this._uiMap[name];
              _target[name]._uiMap.push=this._uiMap[name];
              _target[name]._uiMap.unshift=this._uiMap[name];
              _target[name]._uiMap.pop=this._uiMap[name];
              _target[name]._uiMap.shift=this._uiMap[name];
            }

            if(this._uiMap[name]){
              if(_result && _result.constructor==Function){
                _CtrlDriver._updateArrayUI(this._uiMap[_result.name]);
              }else{
                _CtrlDriver._bindUI(this._uiMap[name]);
              }
            }
          }else if(_result && _target.constructor==Array && _result.constructor==Function && ["splice","push","unshift","pop","shift"].indexOf(_result.name)>=0){
            _CtrlDriver._updateArrayUI(this._uiMap[_result.name]);
          }
          
          return _target[name];
        },
        set:function(_target,name,value){
          _CtrlDriver._monitorData(_target,name,value)
          // console.log(name+":"+value)
          var _toUpdate=false;
          if(_CtrlDriver._isProxibleObj(value)){
            value=_CtrlDriver._buildProxy(value,this,name);
          }

          if(!value || !_target[name] || !value._target || !_target[name]._target){
            _toUpdate=_target[name]!==value;
          }else{
            _toUpdate=value._target !==_target[name]._target
          }

          if(_toUpdate){
            var o=this._uiMap?this._uiMap[name]:0;
            if(o && !_CtrlDriver._updateUIList.includes(o)){
              _CtrlDriver._updateUIList.push(o);
              _CtrlDriver._exeUpdateUI();
            // }else if(this._parent){
            //   var o=this._parent._uiMap[this._name]
            //   if(o && !_CtrlDriver._updateUIList.includes(o)){
            //     _CtrlDriver._updateUIList.push(o);
            //     _CtrlDriver._exeUpdateUI();
            //   }
            }
            o=_CtrlDriver._rootUpdateMap
            if(o && !_CtrlDriver._updateUIList.includes(o)){
              _CtrlDriver._updateUIList.push(o);
              _CtrlDriver._exeUpdateUI();
            }
          }
          
          if(_target[name] && _target[name]._uiMap){
            if(value && value._isBZProxy && !value._uiMap){
              value[0];
              delete value._uiMap[0];
            }
            if(value && value._uiMap && value._uiMap!=_target[name]._uiMap){
              for(var k in _target[name]._uiMap){
                var _vList=value._uiMap[k];
                var _tList=_target[name]._uiMap[k];
                
                if(_vList && _vList!=_tList){
                  for(var i=0;i<_tList.length;i++){
                    if(!_vList.includes(_tList[i])){
                      _vList.push(_tList[i]);
                    }
                  }
                }else{
                  value._uiMap[k]=_target[name]._uiMap[k];
                }
                _CtrlDriver._cleanList.add(value._uiMap[k]);
              }
            }
          }
          var _result=(_target[name]=value);
          if(value===undefined && this._uiMap){
            delete this._uiMap[name]
          }
          if(_target.constructor==Array && name=="length" && _result==0){
            return true;
          }else if(_target.constructor==Array && (parseInt(name) || parseInt(name)==0) && !_result){
            return true;
          }
          return _result;
        }
      });
    }else{
      return _data;
    }
  },
  _updateArrayUI:function(_uiList){
    if(_uiList){
      if(_CtrlDriver._arrayUIList.indexOf(_uiList)<0){
        _CtrlDriver._arrayUIList.push(_uiList);
      }
      if(_CtrlDriver._arrayUITimeout){
        clearTimeout(_CtrlDriver._arrayUITimeout);
      }
      _CtrlDriver._arrayUITimeout=setTimeout("_CtrlDriver._updateArrayUI()");
      return;
    }
    var _timer=Date.now();
    _CtrlDriver._inUpdateArrayUIList=true;
    while(_CtrlDriver._arrayUIList.length){
      var u=_CtrlDriver._arrayUIList.shift();
      _CtrlDriver._updateDataUI(u,_timer);
    }
    _CtrlDriver._inUpdateArrayUIList=false;
  },
  _updateDataUI:function(_uiList,_timer){
    if(!_uiList){
      return;
    }
//    var _ignore=0;
//    var _exe=0;
//    console.time("_updateDataUI")
//    console.log("_uiList.length: "+_uiList.length)
    for(var i=0;i<_uiList.length;i++){
      var u=_uiList[i];
      if(i){
        let lu=_uiList[i-1]
        if(u._dom==lu._dom&&u._attr==lu._attr&&u._group==lu._group){
          continue
        }
      }
      if($(u._dom.ownerDocument).find(u._dom).length){
        if(_timer && u._time>_timer){
//          _ignore++;
          continue;
//        Don't remove the comment for chrome debug modal!!!
        }
//        _exe++;
        try{
          _CtrlDriver._curSignedList=[];
          _CtrlDriver._updateCount++;
          _CtrlDriver._curDomItem=u;
          if(u._attr=="_if"){
            if(u._dom._viewDef._if){
              _CtrlDriver._updateIf(u);
            }
          }else if(u._attr=="['load']"){
            if(u._dom._viewDef._load){
              _CtrlDriver._loadContent(u);
            }else{
              _uiList.splice(i,1);
              i--;
            }
          }else if(u._attr=="['html']"){
            _CtrlDriver._updateHtml(u);
          }else if(u._attr=="['text']"){
            if(u._dom._viewDef._text){
              _CtrlDriver._updateText(u);
            }
          }else if(u._attr=="['value']"){
            _CtrlDriver._updateValue(u);
          }else if(u._attr=="rebuild"){
            _CtrlDriver._updateRebuild(u);
          }else if(u._attr=="repeat"){
            _CtrlDriver._updateRepeat(u);
          }else{
            _CtrlDriver._updateAttr(u);
          }
        }catch(e){_CtrlDriver._handleError(e);}
      }else{
//        _ignore++
        _uiList.splice(i,1);
        i--;
      }
    }
//    console.timeEnd("_updateDataUI")
//    console.log("_ignore: "+_ignore)
  },
  _handleError:function(_error){
//    console.clear();
    if(window._inDebugging){
      console.log(_error.stack)
    }
  },
  _initUIBind:function(_ctrl,_data,_viewDef,_hookers){
    _CtrlDriver._curSignedList=[];
    var _doc=_ctrl._document || document;
    _CtrlDriver._curDomItem=_doc.createTextNode("");
    _CtrlDriver._curDomItem._ctrl=_ctrl;
    _CtrlDriver._curDomItem._data=_data;
    _CtrlDriver._curDomItem._viewDef=_viewDef;
    _CtrlDriver._curDomItem._hookers=_hookers?_hookers:[];
    _CtrlDriver._curDomItem={_dom:_CtrlDriver._curDomItem,_attr:"_if"};
  },
  _initUIBindByDom:function(_dom){
    _CtrlDriver._initUIBind(_dom._ctrl,_dom._data,_dom._viewDef,_dom._hookers);
  },
  _changeBindAttr:function(_attr){
    _CtrlDriver._curDomItem={
      _dom:_CtrlDriver._curDomItem._dom,
      _attr:_attr
    };
  },
  _replaceBindDom:function(_newDom,_attr,_clean){
    if(_newDom){
      _newDom._ctrl=_CtrlDriver._curDomItem._dom._ctrl;
      _newDom._data=_CtrlDriver._curDomItem._dom._data;
      _newDom._viewDef=_CtrlDriver._curDomItem._dom._viewDef;
      _newDom._hookers=_CtrlDriver._curDomItem._dom._hookers;
      _CtrlDriver._curDomItem._dom=_newDom;
    }
    if(_attr){
      _CtrlDriver._curDomItem._attr=_attr;
    }
    for(var i=0;i<_CtrlDriver._curSignedList.length;i++){
      var o=_CtrlDriver._curSignedList[i];
      if(_newDom){
        o._dom=_newDom;
      }
      if(_attr){
        o._attr=_attr;
      }
    }
    if(_clean){
      _CtrlDriver._curSignedList=[];
    }
  },
  _retrieveResult:function(_exe,_data,_ctrl,_dom){
    var _result=null;
    try{
      if(_exe && _exe.constructor==Function){
        _result=_exe(_data,_ctrl,_dom);
      }else if(_exe && (_exe.constructor==Array || _exe.constructor==Object)){
        _result=_exe;
      }else if(_exe && _exe.constructor!=String){
        _result=_exe;
      }else{
        try{
          if(_exe && (_exe.includes(".") || (_exe.endsWith("'") && _exe[0]=="'")) && !_exe.endsWith(".")){
            _result=_Util._eval("_result="+_exe,{_data:_data});
          }else{
            _result=_exe;
          }
        }catch(e){
          _result=_exe;
          if(e.message && (e.message.includes("null") || e.message.includes("undefined"))){
            if(_exe.constructor==String){
              _result="";
            }
          }
        }
      }
    }catch(ee){
      _result=""
      console.log(ee.stack)
      if(!ee.message || (!ee.message.endsWith("of null") && !ee.message.endsWith("of undefined"))){
        console.error(ee);
      }
    }
    
    return _result;
  },
  //triggered on get data attributes
  _bindUI:function(_uiList){
    if(!_uiList||_uiList.constructor==Function){
      return;
    }
    for(var i=0;i<_uiList.length;i++){
      var u=_uiList[i];
      if(u._dom==_CtrlDriver._curDomItem._dom && u._attr==_CtrlDriver._curDomItem._attr){
        if(u._attr=="repeat" && u._viewDef._dataRepeat !==_CtrlDriver._curDomItem._viewDef._dataRepeat){
          continue;
        }
        return;
      }
    }

    if(!_uiList.includes(_CtrlDriver._curDomItem)){
      _CtrlDriver._curDomItem._time=Date.now();
      _uiList.push(_CtrlDriver._curDomItem);
      _CtrlDriver._curSignedList.push(_CtrlDriver._curDomItem);
      _CtrlDriver._cleanList.add(_uiList);
      _CtrlDriver._exeCleanList();
    }
  },
  //triggered on set data attributes
  _cleanDom:function(_dom){
    $(_dom).remove();
    if(_dom.children){
      for(var i=0;i<_dom.children.length;i++){
        _CtrlDriver._cleanDom(_dom.children[i])
      }
    }
  },
  _isRemovedElement:function(e){
    while(e.parentElement){
      if(["BODY","HTML"].includes(e.tagName)){
        return
      }
      e=e.parentElement
    }
    return 1
  },
  _cleanData:function(_data){
    if(_data.constructor==Array){
      while(_data.length){
        _data.pop();
      }
    }else{
      for(var k in _data){
        _data[k]=null;
        delete _data[k];
      }
    }
  },
  _exeCleanList:function(_lanuch){
    if(!_lanuch){
      if(_CtrlDriver._curCleanListTimeout){
        clearTimeout(_CtrlDriver._curCleanListTimeout)
      }
      _CtrlDriver._curCleanListTimeout=setTimeout(function(){
        _CtrlDriver._exeCleanList(1)
      },1);
      return;
    }
    var _timer=Date.now(),_count=0,_chk=0,_item=0;
//    console.time("_exeCleanList")
//    console.log("_CtrlDriver._cleanList: "+_CtrlDriver._cleanList.size)
    for(var _uiList of _CtrlDriver._cleanList){
      var _tmpList=[],_tmpAttrList=[],_tmpMap={};
      _item++;
      for(var i=0;i<_uiList.length;i++){
        var u=_uiList[i],os=0;
        _chk++;
        
        if((!u._dom.parentElement || !u._dom.ownerDocument || !u._dom.ownerDocument.defaultView ||(!u._dom.parentElement.getBoundingClientRect().width &&_CtrlDriver._isRemovedElement(u._dom.parentElement))) && u._time<_timer){
          os=_uiList.splice(i--,1);
        }else if(_tmpList.indexOf(u._dom)<0){
          _tmpAttrList.push([u._attr]);
          _tmpList.push(u._dom);
        }else{
          var _idx=_tmpList.indexOf(u._dom);
          if(u._attr=="repeat" || _tmpAttrList[_idx].indexOf(u._attr)<0){
            _tmpAttrList[_idx].push(u._attr);
          }else{
            os=_uiList.splice(i--,1);
          }
        }
        
        if(os){
          _CtrlDriver._cleanDom(os[0])
          _count++;
        }
      }
    }
    _CtrlDriver._cleanList.clear()
//    console.timeEnd("_exeCleanList")
  },
  _assignFunForAfterUpdate:function(f){
    if(!_CtrlDriver._afterUpdateFunList.includes(f)){
      _CtrlDriver._afterUpdateFunList.push(f)
    }
  },
  _exeAfterUpdate:function(){
      while(_CtrlDriver._afterUpdateFunList.length){
        _CtrlDriver._afterUpdateFunList.shift()();
      }
    // clearTimeout(_CtrlDriver._exeAssignTimer)
    // _CtrlDriver._exeAssignTimer=setTimeout(function(){
      // while(_CtrlDriver._afterUpdateFunList.length){
        // _CtrlDriver._afterUpdateFunList.shift()();
      // }
    // },50)
  },
  _exeUpdateUI:function(_lanuch){
    if(!_lanuch){
      if(_CtrlDriver._curUIUpdateTimeout){
        clearTimeout(_CtrlDriver._curUIUpdateTimeout)
      }
      _CtrlDriver._curUIUpdateTimeout=setTimeout(function(){
        _CtrlDriver._exeUpdateUI(1)
      },1);
      return;
    }
    var _timer=Date.now();
    _CtrlDriver._updateCount=0;
    var ul=[];
    // var t1=Date.now()
    while(_CtrlDriver._updateUIList.length){
      var _uiList=_CtrlDriver._updateUIList.shift();
      for(var i=0;i<_uiList.length;i++){
        var u=_uiList[i];
        if(ul.indexOf(u)<0){
          ul.push(u);
        }
      }
      _CtrlDriver._cleanList.add(_uiList);
    }
    _CtrlDriver._updateDataUI(ul,_timer);
    _CtrlDriver._exeCleanList();

    _CtrlDriver._curDomItem=null;
    _CtrlDriver._curSignedList=[];
    if(!_CtrlDriver._updateUIList.length){
      _CtrlDriver._exeAfterUpdate()
    }
  //  console.log("update time: "+(Date.now()-t1))
  },
  _getDataModelValue:function(d,_data){
    if(d.constructor==Function){
      d=d(_data)
    }
    if(d){
      if(d.constructor==String){
        d=_Util._eval("d="+d,{_data:_data})
      }else{
        d=d._data[d._key]
      }
    }
    return d
  },
  _updateValue:function(u){
    var _data=u._dom._data;
    var _viewDef=u._dom._viewDef;
    var _value=null;
    try{
      _value=_CtrlDriver._getDataModelValue(_viewDef._dataModel,_data)

      if(_value===undefined || _value===null){
        _value="";
      }else if(![Object,Array].includes(_value.constructor)){
        _value=_value.toString();
      }
      if(u._dom.contenteditable){
        let fs=$(u._dom.ownerDocument).find(":focus")[0];
        if(fs&&(fs!=u._dom&&!$(u._dom).find(fs)[0])){
          u._dom._refresh&&u._dom._refresh()
        }
      }else if(u._dom.type && u._dom.type=="checkbox"){
        u._dom.checked=_value==u._dom.value;
      }else if(u._dom.type && u._dom.type=="radio"){
        u._dom.checked=(u._dom._orgValue||u._dom.value)==_value;
      }else if(u._dom.tagName=="SELECT"){
        var ps=u._dom.options;
        for(var i=0;i<ps.length;i++){
          var p=ps[i];
          if(p._orgValue == _value || p.value==_value){
            u._dom.value=p.value;
            return;
          }
        }
      }else{
        var _focus=$(u._dom.ownerDocument).find("*:focus")[0]==u._dom;
        if(!_focus){
          if(u._dom._viewDef._formatGet){
            _value=u._dom._viewDef._formatGet(_value,u._dom)
            if(_value===undefined){
              _value=""
            }
          }
          u._dom.value=_value;
        }else{
          _CtrlDriver._inTyping=true;
          if(!u._dom._bzTypingBlur){
            u._dom._bzTypingBlur=true;
            $(u._dom).blur(function(){
              this._bzTypingBlur=false;
              _CtrlDriver._inTyping=false;
            });
          }
        }
      }
    }catch(e){_CtrlDriver._handleError(e);}
  },
  _updateAttr:function(u){
    var _data=u._dom._data;
    var _viewDef=u._dom._viewDef;
    if(!_viewDef._attr){
      return;
    }

    var _value="";
    _value=_Util._eval("_value=_viewDef"+u._attr,{_viewDef:_viewDef,_data:_data});
    var _result=_CtrlDriver._retrieveResult(_value,_data,u._dom._ctrl,u._dom);
    _result=_result===undefined?"":_result;
    if(u._attr=="['_attr']['style']"){
      if(_result){
        _result=_result.split(";");
        for(var i=0;i<_result.length;i++){
          var r=_result[i].split(":");
          r.length>1&&u._dom.style.setProperty(r[0],r[1].replace(" !important",""),r[1]&&r[1].includes("!important")?"important":"")
        }
      }
    }else if(u._attr=="['_attr']['class']"){
      u._dom.className=_result;
    }else{
      var _attr=u._attr.split("]['")[1].split("'")[0];
      if(["disabled","readonly","checked","selected","draggable","droppable"].includes(_attr)){
        _result=Boolean(_result)
      }
      if(_attr=="value"){
        u._dom.value=_result;
      }else{
        u._dom[_attr]=_result;
        $(u._dom).attr(_attr,_result);
      }
    }
  },
  _loadContent:function(u){
    var _dom=_CtrlDriver._curDomItem._dom;
    if(u){
      _CtrlDriver._curDomItem=u;
      _dom=u._dom;
    }else{
      _CtrlDriver._curDomItem={_dom:_dom,_attr:"['load']"};
    }
    var _data=_dom._data;
    var _ctrl=_dom._ctrl;
    var _ajax=_dom._viewDef._load;
    if(!_ajax){
      return
    }else if(_ajax.constructor==Function || _ajax.constructor==String){
      _ajax=_CtrlDriver._retrieveResult(_ajax,_dom._data,_dom._ctrl);
    }
    if(_ajax.constructor==String){
      _ajax={url:_ajax,dataType:"text/plain"};
    }
    //cache last ajax;
    if(_CtrlDriver._equalObj(_dom._viewDef._lastLoad,_ajax) && !_ajax._noCache){
      if(_dom._viewDef._html){
        return _CtrlDriver._updateHtml(u);
      }else if(_dom._viewDef._text){
        return _CtrlDriver._updateText(u);
      }
      return _dom;
    }
    _dom._viewDef._lastLoad=_ajax;
    
    $.ajax(_ajax).fail(function(e){
      if(e.message){
        alert("Load page error: "+e.message);
      }else if(e.responseText){
        _buildDom(e);
      }
    }).done(function(e){
      _buildDom(e);
    });
    function _buildDom(d){
      if(d.responseText){
        d=d.responseText;
      }
      //_handler: customize function
      if(_ajax._handler){
        d=_ajax._handler(d);
      }
      var dd=null;
      var _doc=_dom._ctrl._document || document;
      var _box=_doc==document?_doc.body:_CtrlDriver._createBZArea(_doc);
      try{
        if(_dom.tagName=="SCRIPT"){
          _Util._eval(d);
        }else{
          //The loading file is a viewDef json file
          dd=_Util._eval("dd="+d);
          if(!_dom._viewDef._noCache){
            delete _dom._viewDef._load
            Object.assign(_dom._viewDef,dd)
          }else{
            _dom._viewDef=dd;
          }
          dd=_CtrlDriver._drawView(_dom._ctrl,_dom._data,_dom._viewDef,_box,_dom);
        }
      }catch(e){
        //The loading file is a html file
        var dd=$(d)[0];
        if(!dd){
          dd=_doc.createTextNode(d);
        }
      }
      if(dd){
        dd._ctrl=_dom._ctrl;
        dd._data=_dom._data;
        dd._viewDef=_dom._viewDef;
        if(dd._viewDef._load){
          if(dd.outerHTML){
            dd._viewDef._html=d;
          }else{
            dd._viewDef._text=d;
          }
          if(_dom._resultDom){
            _CtrlDriver._cleanDom(_dom._resultDom);
          }
          $(dd).insertAfter(_dom);
          _dom._resultDom=dd;
          return dd;
        }else{
          $(_dom).replaceWith(dd);
        }
      }
    }
    return _dom;
  },
  _updateHtml:function(u){
    if(u){
      _CtrlDriver._curDomItem=u;
    }else{
      _CtrlDriver._curDomItem={_dom:_CtrlDriver._curDomItem._dom,_attr:"['html']"};
    }
    var _doc=_CtrlDriver._curDomItem._dom._ctrl._document || document;
    var _dom=_CtrlDriver._curDomItem._dom;
    var _tmpResult=_CtrlDriver._retrieveResult(_dom._viewDef._html,_dom._data,_dom._ctrl);
    var _tmpDom=null;
    if(_tmpResult!==null && _tmpResult!==undefined){
      if(_tmpResult.constructor==String){
        _tmpResult=_tmpResult.trim();
      }
      if(_tmpResult.constructor==String && _tmpResult[0]=="<" && _tmpResult[_tmpResult.length-1]==">"){
        _tmpDom=$(_tmpResult)[0]
      }else if(_tmpResult.nodeType){
        _tmpDom=_tmpResult;
      }
      if(!_tmpDom){
        _tmpDom=_doc.createTextNode(_tmpResult);
      }
    }else{
      _tmpDom=_doc.createTextNode("");
    }
    
    if(u){
      $(u._dom).replaceWith(_tmpDom);
    }
    _CtrlDriver._replaceBindDom(_tmpDom,"['html']",true);
    return _tmpDom;
  },
  _updateText:function(u){
    var _dom=_CtrlDriver._curDomItem._dom;
    if(u){
      _CtrlDriver._curDomItem=u;
    }else{
      _CtrlDriver._curDomItem={_dom:_dom,_attr:"['text']"};
    }
    var _doc=_dom._ctrl._document || document;
    
    var _tmp=_CtrlDriver._retrieveResult(_dom._viewDef._text,_dom._data,_dom._ctrl,_dom);
    if(_tmp===null || _tmp===undefined){
      _tmp="";
    }
    _dom.textContent=_tmp;
    if(_dom.innerHTML){
      _dom.innerHTML=_dom.innerHTML.replace(/\&(amp\;)([\#0-9a-z]+\;)/g,"&$2")
    }
    _CtrlDriver._replaceBindDom(null,"['text']",true);
    return _dom;
  },
  _updateRebuild:function(u){
    var _box=u._dom.parentElement;
    var _dom=_CtrlDriver._drawView(u._dom._ctrl, u._dom._data, u._dom._viewDef);
    if(_dom){
      if(_dom.constructor!=Array){
        _dom=[_dom];
      }
      for(var i=0;i<_dom.length;i++){
        $(_dom[i]).insertAfter(u._dom);
      }
    }
    _CtrlDriver._cleanDom(u._dom);
  },
  _updateIf:function(u){
    if(u){
      _CtrlDriver._initUIBindByDom(u._dom);
    }
    var _dom=_CtrlDriver._curDomItem._dom;
    var _value = _CtrlDriver._retrieveResult(_dom._viewDef._if,_dom._data,_dom._ctrl,_dom);
    
    if(!_value || (_value.constructor==String && _value==_dom._viewDef._if)){
      if(u && u._dom.nodeType==_dom.nodeType && !u._dom.textContent){
        _CtrlDriver._curDomItem._dom=u._dom;
        return;
      }else if(!u){
        return null;
      }else{
        var _tmp=_CtrlDriver._curDomItem._dom;
        if(((_dom._viewDef._animation && _dom._viewDef._animation._hide) || _CtrlDriver._animationHideAll) && (!_dom._viewDef._animation || _dom._viewDef._animation._hide!="none")){
          if(_dom._viewDef._animation && _dom._viewDef._animation._hide){
            _dom._viewDef._animation._hide(u._dom,function(){
              _toHide(u,_tmp);
            });
          }else{
            _CtrlDriver._animationHideAll(u._dom,function(){
              _toHide(u,_tmp);
            });
          }
        }else{
          _toHide(u,_tmp);
        }
        return;
      }
    }else if(u && (u._dom.nodeType!=_dom.nodeType || u._dom.textContent)){
      return;
    }else if(!u){
      return _CtrlDriver._curDomItem;
    }
    if(u._dom._viewDef._dataRepeat){
      _CtrlDriver._repeatData(u._dom._ctrl,u._dom._data,u._dom._viewDef,u._dom.parentElement,u._dom);
      _CtrlDriver._cleanDom(u._dom);
    }else{
      
      if(u._dom._viewDef._tag){
        _dom=_CtrlDriver._updateDom(u);
      }else if(u._dom._viewDef._load){
        _dom=_CtrlDriver._loadContent(u);
      }else if(u._dom._viewDef._html){
        _dom=_CtrlDriver._updateHtml(u);
      }else if(u._dom._viewDef._text){
        _dom=_CtrlDriver._updateText(u);
      }
      
      var _doAnimation=((_dom._viewDef._animation && _dom._viewDef._animation._show) || _CtrlDriver._animationShowAll) && (!_dom._viewDef._animation || _dom._viewDef._animation._show!="none");
      if(_doAnimation && _dom.tagName){
        _dom.style.display="none";
      }
      $(u._dom).replaceWith(_dom);
      if(_doAnimation && _dom.tagName){
        if(_dom._viewDef._animation && _dom._viewDef._animation._show){
          _dom._viewDef._animation._show(_dom);
        }else if(_CtrlDriver._animationShowAll){
          _CtrlDriver._animationShowAll(_dom); 
        }
      }
    }
    function _toHide(u,_tmp){
      $(u._dom).replaceWith(_tmp);
      _CtrlDriver._cleanDom(u._dom);
      u._dom=_tmp;
    }
  },
  _buildDom:function(u){
    u=u._dom;
    var _data=u._data;
    if(u._viewDef._data){
      u._data=_data=_CtrlDriver._retrieveResult(u._viewDef._data,u._data,u._ctrl)||_data;
    }
    var _tag=_CtrlDriver._retrieveResult(u._viewDef._tag,u._data,u._ctrl);

    var _html="<"+_tag+" ";
    
    var _body=_CtrlDriver._fillAttrs(u._viewDef,_data,u._ctrl);
    if(_body===null || (_body && (_body.constructor==Object || _body.constructor==Array))){
      _html+=_body._html;
    }else{
      _html+=_body;
    }
    if(["INPUT","IMG","BR","HR"].indexOf(_tag.toUpperCase())>=0){
      _html+="/>";
    }else{
      _html+="></"+_tag+">"
    }
    var _dom= $(_html)[0];
    if(_body===null || (_body && (_body.constructor==Object || _body.constructor==Array))){
      _dom._orgValue=_body._orgValue;
    }
    if(u._viewDef._after){
      setTimeout(function(){
        u._viewDef._after(_dom,_data)
      },u._viewDef._animation?1010:10)
    }
    return _dom;
  },
  _updateDom:function(u,_data){
    var _dom=_CtrlDriver._buildDom(u);
    
    _CtrlDriver._replaceBindDom(_dom,null,true);
    
    _CtrlDriver._bindJqExt(_dom._viewDef._jqext,_dom,_data);
    _CtrlDriver._setBZCommonBehavior(_dom);
    
    var id=null;
    if(_dom._viewDef.id){
      id=_dom._viewDef.id;
    }else if(_dom._viewDef._attr && _dom._viewDef._attr.id){
      id=_dom._viewDef._attr.id;
    }
    if(id){
      if(!_dom._ctrl._comps){
        _dom._ctrl._comps={};
      }
      _dom._ctrl._comps[id]=_dom;
    }
    var _hasItems=0
    if(_dom._viewDef._items){
      var _items=_dom._viewDef._items;
      if(_items.constructor==String || _items.constructor==Function){
        _items=_CtrlDriver._retrieveResult(_items,_dom._data,_dom._ctrl,_dom);
      }
      
      for(var i=0;_items&&i<_items.length;i++){
        _hasItems=1
        var r=_items[i];
        if(r){
          if(r.constructor==String){
            r=_CtrlDriver._parseViewDef(r)
          }
          _CtrlDriver._drawView(_dom._ctrl,_dom._data,r,_dom);
        }
      }
    }
    if(_hasItems){
    }else if(_dom._viewDef._load){
      _dom=_CtrlDriver._loadContent();
    }else if(_dom._viewDef._html){
      $(_dom).append(_CtrlDriver._updateHtml());
    }else if(_dom._viewDef._text){
      $(_dom).append(_CtrlDriver._updateText());
    }

    if(_dom._viewDef._required){
      var _required=_CtrlDriver._retrieveResult(_dom._viewDef._required,_dom._data,_dom._ctrl);
      if(_required){
        if(!$(_dom).val()){
          $(_dom).addClass("required");
        }
        $(_dom).on("input",function(){
          if(!this.value){
            $(this).addClass("required");
          }else{
            $(this).removeClass("required");
          }
        });
      }
    }
    
    if(_dom._viewDef._dataModel){
      var _tag=_CtrlDriver._retrieveResult(_dom._viewDef._tag,_dom._data,_dom._ctrl);
      if(["INPUT","SELECT","TEXTAREA"].includes(_tag.toUpperCase())||(_dom._viewDef._attr&&_dom._viewDef._attr.contenteditable)){
        if(_dom._viewDef._attr && _dom._viewDef._attr.type){
          var type=_CtrlDriver._retrieveResult(_dom._viewDef._attr.type,_dom._data,_dom._ctrl);
        }else{
          type="text";
        }
        
        //_trigger data update by databind
        var _event="change";
        if(["INPUT","TEXTAREA"].indexOf(_dom.tagName)>=0 && type!="checkbox" && type!="radio"){
          _event="input";
        }
        _event=_dom._viewDef._updateEvent || _event;
        $(_dom).on("change",function(){
          this._bzUpdate=1
        })
        $(_dom).on(_event,function(){
          let _this=this;
          try{
            _CtrlDriver._typingBox=_this;
            var _data=_this._data;
            var _bind=_this._viewDef._dataModel;
            if(_bind.constructor==Function){
              _bind=_bind(_data)
            }
            if(_this.type=="checkbox"){
              if(_this.checked){
                if(_bind.constructor==String){
                  _Util._eval(_bind+"=_this._orgValue||_this.value",{_this:_this,_data:_data});
                }else{
                  _bind._data[_bind._key]=_this._orgValue||_this.value
                }
              }else{
                if(_bind.constructor==String){
                  _Util._eval(_bind+"=null;delete "+_bind,{_data:_data});
                }else{
                  _bind._data[_bind._key]=null
                  delete _bind._data[_bind._key]
                }
              }
            }else{
              var _value=null;
              if(_this._viewDef._dataType==Number){
                _value=parseFloat(_this.value);
                if(!_value){
                  _value=0;
                }
              }else{
                _value=_this.value;
              }
              if(_this.tagName=="SELECT"){
                if(_this.selectedOptions[0]._orgValue){
                  _value=_this.selectedOptions[0]._orgValue;
                }
              }else if(_this.type=="radio"){
                _value=_this._orgValue||_this.value;
              }
              if(_this._viewDef._formatSet){
                _value=_this._viewDef._formatSet(_value,_data,_this);
              }
              if(_bind.constructor==String){
                _Util._eval(_bind+"=_value",{_value:_value,_data:_data});
              }else{
                _bind._data[_bind._key]=_value
              }
            }
          }catch(e){}
        });
        $(_dom).on(_event=="input"?"change":_event,function(e){
          let _this=this,_org=this
          _CtrlDriver._chkIgnoreUpdate(_this,function(){
            while(_this&&_this._viewDef&&!_this._viewDef._update){
              if(_this._viewDef._noUpdate||_this.tagName=="BODY"){
                return
              }
              _this=_this.parentElement
            }
            if(!_org._bzUpdate){
              return
            }
            _org._bzUpdate=0
            if(_this&&_this._viewDef){
              setTimeout(function(){
                var _update=_this._viewDef._update
                if(_update.constructor==Function){
                  _update(_data,_dom,_this)
                }else{
                  _Util._eval(_update,{_data:_data})
                }
              },100)
            }
          })
        })
        $(_dom).on("keyup",function(){
          this._bzOldValue=this._bzOldValue===undefined&&this.value
        })
        $(_dom).on("blur",function(){
          this._bzOldValue=undefined
          if(["INPUT","TEXTAREA"].includes(this.tagName)){
            this.value=this.value.trim()
            //$(this).change()
          }
          _CtrlDriver._typingBox=null;
        });

        var _data=_dom._data;
        _CtrlDriver._curDomItem={_dom:_dom,_attr:"['value']"};
        try{
          _value=_CtrlDriver._getDataModelValue(_dom._viewDef._dataModel,_data)
          

          //set value by data bind
          if(type=="checkbox"){
            _dom.checked=_dom.value+""==(_value||_value===0?_value+"":"");
          }else if(type=="radio"){
            _dom.checked=(_dom._orgValue||_dom.value)==(_value||(_value===0?"0":""));
          }else{
            if(_dom._viewDef._formatGet){
              _value=_dom._viewDef._formatGet(_value,_data,_dom);
            }
            $(_dom).val(_value);
            if(_value===null || (_value && (_value.constructor==Object || _value.constructor==Array))){
              _dom._orgValue=_value;
              if(_dom.tagName=="SELECT"){
                for(var i=0;i<_dom.options.length;i++){
                  var op=_dom.options[i];
                  if(op._orgValue==_value || (op._orgValue && _value && _dom._viewDef._key && op._orgValue[_dom._viewDef._key]==_value[_dom._viewDef._key])){
                    op.selected=true;
                    break;
                  }
                }
              }
            }
          }
        }catch(e){
          console.log("BZ-LOG: "+_dom._viewDef._dataModel)
          _CtrlDriver._handleError(e);
        }
        
      }else{
        _CtrlDriver._curDomItem={_dom:_dom,_attr:"rebuild"};
        try{
          var _data=_dom._data;
          _CtrlDriver._getDataModelValue(_dom._viewDef._dataModel,_data)
        }catch(e){_CtrlDriver._handleError(e);}
      }
    }
    
    if(_dom._viewDef._focus){
      var _focus=!_CtrlDriver._inTyping && _CtrlDriver._retrieveResult(_dom._viewDef._focus,_dom._data,_dom._ctrl);
      if(_focus){
        setTimeout(function(){
          if(!_CtrlDriver._inTyping){
            $(_dom).focus();
            if(_dom._viewDef._select){
              $(_dom).select()
            }
          }
        },10);
      }
    }
    _CtrlDriver._curSignedList=[];
    return _dom;
  },
  _triggerUpdateData:function(cd,_from,d){
    _from=_from||cd
    d=d||_from._data
    if(cd._viewDef){
      if(cd._viewDef._update){
        cd._viewDef._update(d,_from,cd)
      }else if(cd.parentElement){
        _CtrlDriver._triggerUpdateData(cd.parentElement,_from,d)
      }
    }
  },
  _chkIgnoreUpdate:function(_this,_doUpdate){
    if(_this._viewDef._ignoreUpdate){
      let _ignoreUpdate=$(_this._viewDef._ignoreUpdate)[0]
      if(_ignoreUpdate&&_ignoreUpdate.getBoundingClientRect().width){
        return
      }
    }else if(_this._viewDef._cancelUpdate){
      return
    }
    _doUpdate()
  },
  _updateRepeat:function(u){
    var _data=u._supData;
    _CtrlDriver._curDomItem=u;
    _data=_CtrlDriver._retrieveResult(u._group,_data,u._ctrl);
    if(_data && _data.constructor==Number){
      _data=new Array(_data).fill(0);
      _CtrlDriver._updateRepeatInArray(u,_data);
    }else if(_data && _data.constructor==Array){
      _CtrlDriver._updateRepeatInArray(u,_data);
    }else{
      _CtrlDriver._updateRepeatInObject(u,_data);
    }
  },
  _updateRepeatInArray:function(u,_data){
    var _idx=0;
    var _last=0,_tmp=0;
    for(var i=0;i<u._dom.childNodes.length;i++){
      var o=u._dom.childNodes[i];
      if(o._data && o._data._group==u._group && o._data._supData==u._supData){
        if(!_tmp){
          _tmp=_last=$("<div></div>").insertBefore(o)[0]
          continue
        }
        if(!$.isNumeric(o._data._idx)){
          _CtrlDriver._cleanDom(o);
          i--;
          continue;
        }else {
          o._data._idx=_idx
          if(!_data || _idx>=_data.length){
            _CtrlDriver._cleanDom(o);
            i--;
          }else if(o._data._item!=_data[_idx]){
            var d=o._data._item;
            var dd=_data[_idx]
            
            try{
              if(_CtrlDriver._typingBox && $(o).find(_CtrlDriver._typingBox).length){
                if(JSON.stringify(d)==JSON.stringify(_data[_idx])){
                  return;
                }
              }
            }catch(e){}

            if(![Object,Array].includes(o._data._item)){
              o._data._item=dd
              // let fs=$(o.ownerDocument).find(":focus")[0]
              // if(fs&&(fs==o||$(o).find(fs)[0])){
              //   _last=o
              // }else{
                var _dom=_CtrlDriver._drawView(o._ctrl,o._data,o._viewDef);
                $(_dom).insertBefore(o);
                _CtrlDriver._cleanDom(o)
                _last=_dom;
              // }
            }else if(_data.includes(d)){
              var _newData=_CtrlDriver._simpleClone(o._data)
              _newData._item=dd
              var _dom=_CtrlDriver._drawView(o._ctrl,_newData,o._viewDef);
              $(_dom).insertBefore(o);
              _last=_dom;
            }else{
              _CtrlDriver._cleanDom(o)
              i--
              continue
            }
          }else if(o._data._idx!=o._data._key){
            o._data._key=o._data._idx
            var _dom=_CtrlDriver._drawView(o._ctrl,o._data,o._viewDef);
            $(_dom).insertBefore(o);
            _last=_dom;
            _CtrlDriver._cleanDom(o)
          }else{
            _last=o
          }
        }
        _idx++;
      }else if(_idx){
        break;
      }
    }
    if(_last!=_tmp){
      _CtrlDriver._cleanDom(_tmp)
      _tmp=0
    }
    var _tmpViewDef=_CtrlDriver._clone(u._viewDef);
    delete _tmpViewDef._dataRepeat;
    for(var n=_idx;_data && n<_data.length;n++){
      var _dom=_CtrlDriver._drawView(u._ctrl,{_item:_data[n],_group:u._group,_supData:u._supData,_idx:n,_key:n},_tmpViewDef);
      if(_last){
        $(_dom).insertAfter(_last);
        if(_last===_tmp){
          _CtrlDriver._cleanDom(_last)
          _tmp=0
        }
      }else{
        $(u._dom).append(_dom);
      }
      _last=_dom;
    }
    if(_last==_tmp && _tmp){
      _CtrlDriver._cleanDom(_last)
    }
  },
  _updateRepeatInObject:function(u,_data){
    if(_data&&_data.constructor==String){
      _data=[_data]
    }else if(_data&&_data.constructor==Number){
      _data=new Array(_data).fill(0)
    }
    var _tmpViewDef=_CtrlDriver._clone(u._viewDef);
    delete _tmpViewDef._dataRepeat;

    var _oth=0;
    var _insertMethod="append";
    var _othDom=null;
    while(u._dom.childNodes.length>_oth){
      var o=u._dom.childNodes[_oth];
      var _equal=false;
      try{
        _equal=JSON.stringify(o._viewDef)==JSON.stringify(_tmpViewDef);
      }catch(e){}
      if(_equal){
        _CtrlDriver._cleanDom(o);
      }else if(_oth){
        _othDom=o;
        _insertMethod="insertBefore";
        break
      }else{
        _oth++;
      }
    }

    for(var n in _data){
      var _dom=_CtrlDriver._drawView(u._ctrl,{_item:_data[n],_group:u._group,_supData:u._supData,_idx:n,_key:n},_tmpViewDef);
      if(_insertMethod=="append"){
        $(u._dom).append(_dom);
      }else{
        $(_dom).insertBefore(_othDom);
      }
    }
  },
  _repeatData:function(_ctrl,_data,_viewDef,_box,_point){
    _CtrlDriver._curDomItem={
      _dom:_box,
      _attr:"repeat",
      _time:Date.now(),
      _group:_viewDef._dataRepeat,
      _supData:_data,
      _ctrl:_ctrl,
      _viewDef:_viewDef
    };
    var value = _CtrlDriver._retrieveResult(_viewDef._dataRepeat,_data,_ctrl);
    var _doms=[];
    if(value){
      if(value.constructor==Number){
        value=new Array(value).fill(0);
      }else if(value.constructor==String){
        value=[value]
      }
      var _tmpViewDef=_CtrlDriver._clone(_viewDef);
      delete _tmpViewDef._dataRepeat;
      for(var k in value){
        if($.isNumeric(k)){
          k=parseInt(k);
        }
        var o={
          _item:value[k],
          _group:_viewDef._dataRepeat,
          _supData:_data,
          _idx:k,
          _key:k,
          _groupValue:value
        }
        if(value.constructor==Array){
          o._size=value.length
        }

        _doms.push(_CtrlDriver._drawView(_ctrl,o,_tmpViewDef,_box,_point));
      }

      _CtrlDriver._curDomItem={
        _dom:_box,
        _attr:"repeat",
        _time:Date.now(),
        _group:_viewDef._dataRepeat,
        _supData:_data,
        _ctrl:_ctrl,
        _viewDef:_viewDef
      };
  
    }
    return _doms;
  },
  _drawView:function(_ctrl,_data,_viewDef,_box,_point){
    _CtrlDriver._initUIBind(_ctrl,_data,_viewDef);
    if(_viewDef._if!==undefined && !_CtrlDriver._updateIf()){
      if(_point){
        $(_CtrlDriver._curDomItem._dom).insertAfter(_point);
      }else{
        $(_box).append(_CtrlDriver._curDomItem._dom);
      }
      return;
    }
    if(_viewDef._dataRepeat){
      return _CtrlDriver._repeatData(_ctrl,_data,_viewDef,_box);
    }
    
    var _dom=null;
    if(_viewDef._tag){
      _dom=_CtrlDriver._updateDom(_CtrlDriver._curDomItem,_data);
    }else if(_viewDef._load){
      _dom=_CtrlDriver._loadContent();
    }else if(_viewDef._html){
      _dom=_CtrlDriver._updateHtml();
    }else if(_viewDef._text){
      _dom=_CtrlDriver._updateText();
    }
    if(_viewDef._dragOrder){
      _CtrlDriver._setDragOrder(_dom,_viewDef._dragOrder)
    }
    if(_point){
      $(_dom).insertAfter(_point);
    }else if(_box){
      $(_box).append(_dom);
    }
    return _dom;
  },
  _setDragOrder:function(_dom,_dragOrder,_retry){
    _retry=_retry||0
    let p=_dragOrder._getBox?_dragOrder._getBox(_dom):_dom.parentElement
    if(!p){
      if(_retry>100){
        return
      }
      return setTimeout(()=>{
        _CtrlDriver._setDragOrder(_dom,_dragOrder,_retry+1)
      },10)
    }
    if(p._dragOrder){
      _dragOrder=p._dragOrder
    }else{
      p._dragOrder=_dragOrder
    }
    $(_dom).css({cursor:"move"})
    _dom.droppable=true
    _dom.draggable=true
    _dom.ondragover=function(e){
      if(_dragOrder._curElement){
        e.preventDefault();
        let os=_dragOrder._curElement.parentElement.children
        _setDragInsertPosMark(os[os.length-1])
        _dragOrder._curOver=this
        if(this!=_dragOrder._curElement){
          for(o of os){
            if(o==this){
              this._insert="top"
              break
            }else if(o==_dragOrder._curElement){
              this._insert="bottom"
              break
            }
          }
          _setDragInsertPosMark(this,this._insert)
        }
      }
    }
    _dom.ondragstart=function(e){
      _dragOrder._curElement=this
      _dragOrder._curItem=_getItemData(this)
      
      if(!p.droppable){
        p.droppable=true
        p.ondragend=function(){
          if(_dragOrder._curElement){
            let _list = _getListData();
            let _idx=_list.indexOf(_dragOrder._curItem)
            if(_idx<_list.length-1){
              _list.splice(_idx,1)
              _list.push(_dragOrder._curItem)
              _dragOrder._after&&_dragOrder._after()
            }
          }
        }
        p.ondragover=function(e){
          if(_dragOrder._curElement&&!_dragOrder._curOver){
            e.preventDefault()
            let os=_dragOrder._curElement.parentElement.children
            _setDragInsertPosMark(os[os.length-1],"bottom")
          }
        }
      }
    }
    _dom.ondragend=function(e){
      console.log("dom - ondragend")

      let _list = _getListData();
      let _item1=_dragOrder._curItem
      if(!_dragOrder._curOver){
        return
      }
      let _item2=_getItemData(_dragOrder._curOver)
      e.preventDefault();
      _dragOrder._curElement=0
      if(_item1==_item2){
        _setDragInsertPosMark(this)
        return
      }
      let _idx=_list.indexOf(_item1)
      _list.splice(_idx,1)
      _idx=_list.indexOf(_item2)
      
      if(_dragOrder._curOver._insert=="top"){
        _list.splice(_idx,0,_item1)
      }else{
        _list.splice(_idx+1,0,_item1)
      }
      if(_list&&_list[0]&&$.isNumeric(_list[0].idx)){
        _list.forEach((x,i)=>{
          x.idx=i
        })
      }
      _setDragInsertPosMark(this)
      _dragOrder._curElement=0
      _dragOrder._after&&_dragOrder._after()
    }
    _dom.ondragleave=function(e){
      _setDragInsertPosMark(this)
    }
    
    function _getListData(){
      return _dragOrder._getListData.constructor==Function?_dragOrder._getListData():_dragOrder._getListData
    }
    
    function _getItemData(o){
      return _dragOrder._getItemData?_dragOrder._getItemData():o._data._item
    }
    function _setDragInsertPosMark(o,t){
      if(!o._topBorder){
        o._topBorder=$(o).css("border-top")
        o._bottomBorder=$(o).css("border-bottom")
      }
      
      $(o).css({"border-top":o._topBorder,"border-bottom":o._bottomBorder})
      _dragOrder._curOver=0
      if(t){
        _dragOrder._curOver=o
        let d={}
        d["border-"+t]="2px dotted var(--active-color)"
        $(o).css(d)
      }
    }
  },
  _fillAttrs:function(_viewDef,_data,_ctrl){
    var _html="";
    var _orgValue=null;
    if(_viewDef._attr){
      for(var k in _viewDef._attr){
        /*
        for event, if value include '"', example:
        to get: onclick="alert(\"1\")", set like: onclick:"alert(\\\"1\\\")"
        to get: onclick="alert(\"abc' xyz\")", set like: onclick:"alert(\\\"abc' xyz\\\")"
        */
        var m=k.match(/^on[a-z]+/);
        var v=_viewDef._attr[k];
        if(!m || m[0]!=k || v.constructor!==String){
          _CtrlDriver._curDomItem={_dom:_CtrlDriver._curDomItem._dom,_attr:"['_attr']['"+k+"']"};
          if(!v){
          }
          v=_CtrlDriver._retrieveResult(v,_data,_ctrl);
          v=v===undefined?"":v;
          if(["disabled","readonly","required","selected","checked","draggable","droppable"].indexOf(k)>=0){
            if(v){
              _html+=" "+k+"=\"true\"";
            }
            continue;
          }
        }
        if(v===null || (v && (v.constructor==Array || v.constructor==Object))){
          _orgValue=v;
          v=_CtrlDriver._tmpValue++;
        }
        if(v.includes){
          if(!v.includes('"')){
            v='"'+v+'"';
          }else if(!v.includes("'")){
            v="'"+v+"'";
          }else{
            v='"'+v.replace(/"/g,"&quot;")+'"';
          }
        }else{
          v='"'+v+'"';
        }
        _html+=" "+k+"="+v;
      }
      
      var _tag=_CtrlDriver._retrieveResult(_viewDef._tag,_data,_ctrl);
      if(_tag.toLowerCase()=="input" && !_viewDef._attr.type){
        _html+=" type=\"text\"";
      }
    }
    if(_orgValue){
      return {_orgValue:_orgValue,_html:_html};
    }
    return _html;
  },
  _bindJqExt:function(_jqext,_jq,_data){
    if(_jqext){
      if(_jqext.constructor==String){
        _jqext=_Util._eval(_jqext,{_data:_data})
      }
      _jq=$(_jq);
      for(var k in _jqext){
        if(!_jqext[k]){
          continue
        }
        if(_jqext[k].constructor==String){
          _jqext[k]=_Util._eval("_jqext[k]="+_jqext[k],{_jqext:_jqext,k:k,_data:_data,_jq:_jq});
        }
        
        if($.isArray(_jqext[k])){
          _jq[k](_jqext[k][0],_jqext[k][1]);
        }else{
          _jq[k](_jqext[k]);
        }
      }
    }
  },
  _isFunction:function(s){
    s=s.trim()
    return s.match(/^\(?(function|\([^\)]*\) *=> *)/)
  },
  _simpleClone:function(o){
    if(o){
      let n={}
      if(o.constructor==Array){
        n=[]
      }else if(o.cloneNode){
        return o.cloneNode()
      }else if(o.constructor!=Object){
        return o
      }

      for(var k in o){
        n[k]=o[k]
      }
      return n
    }
    return o
  },
  _sign:/[^\$\_\-\wÀ-Üà-øoù-ÿŒœ\u4E00-\u9FCC]+/,
  _setBZCommonBehavior:function(jq){
    // if(jq.tagName=="TEXTAREA"
    //   ||(jq.tagName=="INPUT" && (!jq.type || !["checkbox","button","radio"].includes(jq.type)))
    //   ||$(jq).hasClass("ai-select")){
    //   $(jq).mouseup(function(e){
    //     let o=e.target
    //     setTimeout(()=>{
    //       let aa=o._ctrlSelectionStart||0,
    //           bb=o._ctrlSelectionEnd||0,
    //           a=o.selectionStart,
    //           b=o.selectionEnd,
    //           _sel,_range,ac,bc,aac,bbc

    //       if(!["INPUT","TEXTAREA"].includes(e.target.tagName)){
    //         _sel = window.getSelection();
    //         _range = _sel.getRangeAt(0);

    //         a=_range.startOffset
    //         b=_range.endOffset
    //         ac=_range.startContainer
    //         bc=_range.endContainer
    //         aac=o._ctrlContainerStart
    //         bbc=o._ctrlContainerEnd
    //       }
              
    //       if(a==b&&(ac==bc)&&(ac!=aac||aa>a||bb<a)){
    //         let _word=_range?_Util._getElementContentText(_range.startContainer):o.value
    //         if(!_word){
    //           return
    //         }
    //         if(a==_word.length){
    //           a--
    //           b--
    //         }
    //         for(let i=a;i>=0;i--){
    //           let c=_word[i]
    //           if(!c){
    //             break
    //           }
    //           if(!c.match(_CtrlDriver._sign)){
    //             a=i
    //           }else{
    //             break
    //           }
    //         }
    //         for(let i=a;i<_word.length;i++){
    //           let c=_word[i]
    //           if(!c){
    //             break
    //           }
    //           if(!c.match(_CtrlDriver._sign)){
    //             b=i+1
    //           }else{
    //             break
    //           }
    //         }

    //         if(!_range){
    //           if(a!=b){
    //             o.selectionStart=a
    //             o.selectionEnd=b
    //           }else{
    //             a=o.selectionStart
    //             b=o.selectionEnd
    //           }
    //         }else{
    //           if(a!=b){
    //             _range.setStart(_range.startContainer, a);
    //             _range.setEnd(_range.endContainer, b);
    //           }else{
    //             a=o._ctrlSelectionStart
    //             b=o._ctrlSelectionEnd
    //           }
    //         }
    //       }
    //       if(_range){
    //         o._ctrlSelectionStart=a
    //         o._ctrlSelectionEnd=b
    //         o._ctrlContainerStart=ac
    //         o._ctrlContainerEnd=bc
    //       }else{
    //         o._ctrlSelectionStart=o.selectionStart
    //         o._ctrlSelectionEnd=o.selectionEnd
    //       }
    //     })
    //   });
    // }
  },
  _cleanFromData:function(_data){
    var _count=0;
    var _clean=0;
    if(_data && _data._uiMap){
      for(var k in _data._uiMap){
        var _uiList=_data._uiMap[k];
        for(var i=0;i<_uiList.length;i++){
          var u=_uiList[i];
          _count++;
          if(!u._dom || !u._dom.parentElement){
            _uiList.splice(i,1);
            _clean++;
            i--;
          }
        }
        var _result=_CtrlDriver._cleanFromData(_data[k]);
        _count+=_result._count;
        _clean+=_result._clean;
      }
    }
    return {_count:_count,_clean:_clean};
  },
  _clone:function(o){
    if($.type(o)=="array"){
      return $.extend(true,[],o);
    }else if($.type(o)=="object"){
      return $.extend(true,{},o);
    }
    return o;
  },
  _equalObj:function(o1,o2){
    if(o1==o2){
      return 1;
    }else if(!o1 || !o2){
      return 0;
    }
    o1=JSON.stringify(o1);
    o2=JSON.stringify(o2);
    if(o1==o2){
      return 1;
    }else if(o1.constructor!==String || o2.constructor!==String || o1.length!=o2.length){
      return 0;
    }
    o1=JSON.parse(o1);
    o2=JSON.parse(o2);
    return this._sortJson(o1)==this._sortJson(o2);
  },
  _sortJson:function(d,_ignoreNull,tab){
    if(!tab){
      tab="";
    }
    var _result="";
    if(d && d.constructor==Object){
      var _keys=[];
      for(var k in d){
        if(d[k]===undefined || (_ignoreNull && !d[k] && d[k]!==0 && d[k]!==false)){
          continue;
        }
        _keys.push(k);
      }
      _keys.sort();
      _result=tab+"{\n"
      for(var i=0;i<_keys.length;i++){
        k=_keys[i];
        _result+=tab+"  \""+k+"\":"+this._sortJson(d[k],_ignoreNull,tab+"  ");
        if(i<_keys.length-1){
          _result+=",\n";
        }else{
          _result+="\n";
        }
      }
      _result+=tab+"}";
    }else if(d && d.constructor==Array){
      _result=tab+"[\n"
      for(var k in d){
        _result+=this._sortJson(d[k],_ignoreNull,tab+" ");
        if(k<d.length-1){
          _result+=",\n";
        }else{
          _result+="\n";
        }
      }
      _result+=tab+"]";
    }else{
      _result=JSON.stringify(d);
    }
    return _result;
  }
};window._eval={
  _leftKeys:{"{":"}","[":"]","(":")"},
  bd:{"{":"}","[":"]","(":")","'":"'",'"':'"','`':'`'},
  db:{"}":"{","]":"[",")":"(","'":"'",'"':'"','`':'`'},
  _tmpNum:1,
  exeGroupCode:function(d){
    if(!d||![String,Array].includes(d.constructor)){
      return d
    }
    if(d.constructor==String){
      return _eval._exeCode(d)
    }else if(d)
    d.forEach(x=>{
      if(x.f){
        x.ps=x.ps||[]
        let xx=_eval._exeCode(x.f,0,0,1)
        if(xx.n){
          xx.d[xx.n](...x.ps)
        }else{
          xx.v(...x.ps)
        }
      }else if(x.k){
        let xx=_eval._exeCode(x.k,0,0,1)
        if(xx.n){
          xx.d[xx.n]=x.v
        }else{
          window[xx.k]=x.v
        }
      }else{
        _eval._exeCode(x.c)
      }
    })
  },
  _getTmpDataName:function(){
    return "f"+(this._tmpNum++)
  },
  _throwErr:function(s){
    alert(_bzMessage._system._error._syntaxError+s)
  },
  _exeFun:function(f,p,_outMap,_inMap){
    _outMap=_eval._initOutMap(_outMap),_inMap=_inMap||{};
    p=(p||[]).map(x=>_eval._getFinalValue(x))
    if(f.constructor!=Function){
      if(_eval._isFun(f)){
        f={v:f}
      }
      if(f.v.constructor==Function){
        if(f.n){
          p=_buildTF(p)
          return f.d[f.n](...p)
        }else{
          f=f.v
        }
      }else if(f.v&&(f.v.k=="function"||f.v.k=="=>")){
        return _exe(f.v,f.d,p)
      }else{
        _eval._throwErr()
      }
    }
    p=_buildTF(p)
    p= f(...p)
    return p

    function _buildTF(p){
      p=p.map(x=>{
        if(x&&x._bzFun=="_bzFun"){
          return function(){
            return _exe(x,window,[...arguments])
          }
        }
        return x
      })
      return p
    }

    function _exe(f,d,p){
      let _map=_eval._buildScopeDataMap(_outMap,_inMap),
      _tmpMap={}
      f.e.forEach((x,i)=>{
        if(x.ps){
          _tmpMap[x.ps[0]]=p[i]
        }else{
          _tmpMap[x]=p[i]
        }
      })
      _tmpMap.arguments=[...p]
      _tmpMap.this=d
      f=_eval._exeCode(f.c,_map,_tmpMap)
      _eval._mergedataMap(_outMap,_inMap,_map)
      if(f&&f._throw=="_return"){
        f=_eval._getFinalValue(f)
        return f
      }
    }
  },
  _exeIfElse:function(v,vs,_map,_tmpMap){
    let r;
    if(v.k!="else"){
      r=_eval._exeCode(v.e,_map,_tmpMap)
    }
    if(v.k=="else"||r){
      r=_eval._exeCode(v.c,_map,_tmpMap)
      
      while(vs[0]&&["else","else if"].includes(vs[0].k)){
        vs.shift()
      }

    }
    return r
  },
  _exeLoop:function(v,_map,_tmpMap){
    let _first=1,r,rr;
    while(1){
      if(v.k=="for"&&_first){
        _eval._exeCode(v.e[0],_map,_tmpMap)
      }
      if(v.k=="for"){
        rr=_eval._exeCode(v.e[1],_map,_tmpMap)
      }else if(v.k!=="do"||!_first){
        rr=_eval._exeCode(v.e,_map,_tmpMap)
      }
      if((v.k=="do"&&_first)||rr){
        _first=0
        r=_eval._exeCode(v.c,_map,_tmpMap)
        if(r&&r._throw){
          if(r._throw!="_continue"){
            if(r._throw=="_break"){
              r=undefined
            }
            break
          }
          r._throw=0
        }
        if(v.k=="for"){
          _eval._exeCode(v.e[2],_map,_tmpMap)
        }
      }else{
        break
      }
    }
    return r
  },
  _exeTry:function(v,_map,_tmpMap){
    let r;
    try{
      r=_eval._exeCode(v.c,_map,_tmpMap)
      return r
    }catch(e){
      _tmpMap={}
      _tmpMap[v.e[0]]=e
      r=_eval._exeCode(v.ec,_map,_tmpMap)
      return r
    }finally{
      if(v.f){
        _tmpMap={}
        r=_eval._exeCode(v.f,_map,_tmpMap)
      }
      return r
    }
  },
  _exeSwitch:function(v,_map,_tmpMap){
    let vv=_eval._exeCode(v.e,_map,_tmpMap),_continue,r
    v.c.find(x=>{
      if(_continue||x.k=="default"||vv==_eval._getFinalValue(_eval._exeCode(x.v,_map,_tmpMap))){
        r=_eval._exeCode(x.cs,_map,_tmpMap)
        if(r&&_eval._isBzData(r)&&r._throw){
          if(r._throw!="_continue"){
            if(r._throw=="_break"){
              r._throw=0
            }
            return 1
          }
          _eval._throwErr()
        }
        _continue=1
      }
    })
    return r
  },
  _initOutMap:function(_outMap){
    _outMap=_outMap||{
      $parameter:window.$parameter,
      $module:window.$module,
      $project:window.$project,
      $test:window.$test,
      $loop:window.$loop,
      $result:window.$result,
      $element:window.$element
    }
    return _outMap
  },
  exe:function(){
    return _eval._exeCode(...arguments)
  },
  _exeCode:function(vs,_outMap,_inMap,_inBzData){
    _outMap=_eval._initOutMap(_outMap),_inMap=_inMap||{};
    if(vs.constructor==String){
      vs=_eval._parseCode(vs)
    }else if(vs.constructor!=Array){
      vs=[vs]
    }
    let vvs=[],r,d,rs=[],_tmpFun
    vs.forEach(x=>{
      if(x.k=="function"||x.k=="=>"){
        if(x.n){
          _outMap[x.n]=x
        }else{
          _tmpFun=x
        }
        x._bzFun="_bzFun"
      }else{
        vvs.push(x)
      }
    })
    if(!vvs.length&&_tmpFun){
      return _tmpFun
    }
    while(vvs.length){
      let v=vvs.shift()
      if(["let","const","var","=","+=","-=","*=","/=","^=","%=","&=","|=","&&=","||="].includes(v.k)){
        rs=[]
        v.c=v.c||[]
        v.c=v.c.constructor==Array?v.c.map(y=>y.constructor==Array?y[0]:y):v.c;
        let vr=_eval._exeCode(v.c,_outMap,_inMap)
        if(v.k=="var"){
          _eval._setValue(v.n,_outMap,_inMap,_outMap,vr)
        }else if(["let","const"].includes(v.k)){
          _eval._setValue(v.n,_inMap,_inMap,_inMap,vr)
        }else{
          rs=[_eval._setValue(v.n,_outMap,_inMap,0,vr,v.k)]
        }
      }else if(["if","else if","else","for","while","do","try","switch"].includes(v.k)){
        rs=[]
        let _map=_eval._buildScopeDataMap(_outMap,_inMap),
            _tmpMap={}
        if(["if","else if","else"].includes(v.k)){
          r=_eval._exeIfElse(v,vvs,_map,_tmpMap)
        }else if(["for","while","do"].includes(v.k)){
          r=_eval._exeLoop(v,_map,_tmpMap)
        }else if(v.k=="try"){
          r=_eval._exeTry(v,_map,_tmpMap)
        }else{
          r=_eval._exeSwitch(v,_map,_tmpMap)
        }
        _eval._mergedataMap(_outMap,_inMap,_map)
        if(r&&_eval._isBzData(r)&&r._throw){
          return r
        }
        if(r){
          rs.push(r)
        }
      }else if(v.k=="..."){
        r=_eval._getFinalValue(_eval._exeCode(v.c,_outMap,_inMap))
        rs.push([...r])
      }else if(v.k=="return"){
        r=_eval._buildBzData(_eval._exeCode(v.c,_outMap,_inMap))
        r._throw="_return"
        return r
      }else if(v.k=="break"){
        r= _eval._buildBzData()
        r._throw="_break"
        return r
      }else if(v.k=="continue"){
        r= _eval._buildBzData()
        r._throw="_continue"
        return r
      }else if(v.k=="throw"){
        r=_eval._exeCode(v.c,_outMap,_inMap)
        throw r
      }else if(v.k=="delete"){
        r=_eval._exeCode(v.c,_outMap,_inMap,1)
        delete r.d[r.n]
        rs.push(true)
      }else if(v.k=="new"){
        let x=v.c[0],rrs=[...x.cs]
        r=rrs.shift().ps.map(y=>_eval._exeCode(y,_outMap,_inMap))
        
        if(x.dd.includes(".")){
          let dd=x.dd.split(".")
          let rr=window[dd.shift()]
          while(dd.length>1){
            rr=rr[dd.shift()]
          }
          r=new rr[dd[0]](...r)
        }else{
          r=new window[x.dd](...r)
        }

        while(rrs.length){
          let rr=rrs.shift()
          rr=rr.substring(1)
          if(rrs.length){
            let pp=rrs.shift().ps.map(y=>_eval._exeCode(y,_outMap,_inMap))
            
            r=r[rr](...pp)
          }else{
            r-r[rr]
          }
        }
        rs.push(r)
      }else if(v.k=="typeof"){
        r=_eval._exeCode(v.c,_outMap,_inMap,1)
        r=typeof _eval._getFinalValue(r)

        rs.push(r)
      }else if(v.dd){
        let on=v.dd,nn;
        if(v.dd[0]=="."){
          r=_eval._getFinalValue(rs.pop())
          nn=_eval._getTmpDataName()
          _outMap[nn]=r
          v.dd=nn+v.dd
        }
        rs.push(_eval._getRefData(v,_outMap,_inMap))
        if(nn){
          v.dd=on
        }
      }else{
        if(v.k=="["){
          r=[];
          v.ps.forEach(x=>{
            x=x.constructor==Array?x.map(y=>y.constructor==Array?y[0]:y):x;
            let y=_eval._exeCode(x,_outMap,_inMap)
            if(x.k=="..."){
              r.push(...y)
            }else{
              r.push(y)
            }
          })
          if(rs.length){
            let rr=rs[rs.length-1]
            if(!_eval._isSign(rr)){
              r=r.pop()
              if(_eval._isBzData(rr)){
                if(rr.d&&r.n){
                  rr.d=rr.v
                  rr.n=r
                  rr.v=rr.d[rr.n]
                }else{
                  rr.v=rr.v[r]
                }
              }else{
                rr=rr[r]
                rs[rs.length-1]=rr
              }
              continue
            }
          }
          rs.push(_eval._buildBzData(r))
        }else if(v.k=="{"){
          r={}
          v.ps.forEach(x=>{
            Object.keys(x).forEach(y=>r[y]=_eval._exeCode(x[y],_outMap,_inMap))
          })
          rs.push(_eval._buildBzData(r))
        }else if(v.k=="("){
          if(rs.length){
            let rr=rs[rs.length-1]
            let fr=_eval._getFinalValue(rr)
            if(_eval._isFun(fr)){
              r=v.ps.map(x=>_eval._exeCode(x,_outMap,_inMap));
              rs[rs.length-1]=_eval._exeFun(rr,r,_outMap,_inMap)
              continue
            }
          }
          r=_eval._exeCode(v.ps,_outMap,_inMap)
          rs.push(_eval._buildBzData(r))
        }else if(v.constructor==Array){
          rs=[_eval._exeCode(v,_outMap,_inMap,1)]
        }else if("'\"\`".includes(v[0])){
          rs.push(_eval._buildBzData(v.substring(1,v.length-1)))
        }else if(v[0]=="/"&&v.length>1){
          let _idx=v.lastIndexOf("/"),op=v.substring(_idx+1)
          r=new RegExp(v.substring(1,_idx),op)
          rs.push(r)
        }else if(_eval._isNumeric(v)){
          rs.push(JSON.parse(v))
        }else if(_eval._isSign(v[0])){
          rs.push(v)
        }else if(v=="undefined"){
          rs.push(_eval._buildBzData(undefined))
        }else if(v=="null"){
          rs.push(_eval._buildBzData(null))
        }else if(v=="true"){
          rs.push(_eval._buildBzData(true))
        }else if(v=="false"){
          rs.push(_eval._buildBzData(false))
        }else if(v[0]=="."){
          v=v.split(".").filter(x=>x)
          r=rs[rs.length-1]
          v.forEach(x=>{
            r.d=_eval._getFinalValue(r.v)
            r.n=x
            r.v=r.d[x]
          })
        }else{
          if(_eval._isBzData(v)){
            rs.push(v)
          }else{
            rs.push(_eval._getValue(v,_outMap,_inMap))
          }
        }
      }
    }
    if(rs.find(x=>_eval._isSign(x))){
      r=_eval._countItems(rs)
    }else{
      r=rs.pop()
    }
    if(_eval._isBzData(r)&&r._throw){
      return r
    }else if(_eval._isFun(r)){
      return r
    }
    return _inBzData?_eval._buildBzData(r):_eval._getFinalValue(r)

  },
  _isFun:function(fr){
    return fr&&(fr.constructor==Function||fr._bzFun=="_bzFun")
  },
  _getRefData:function(v,_outMap,_inMap){
    let r=_eval._getValue(v.dd,_outMap,_inMap)
    v.cs.forEach(x=>{
      if(x.k){
        let d=x.ps.find(y=>_eval._isSign(y)||y[0]==".")?_eval._exeCode(x.ps,_outMap,_inMap):x.ps.map(y=>{
          if(y&&y.constructor==Array){
            y=y.map(z=>z&&z.constructor==Array?_eval._exeCode(z,_outMap,_inMap,1):z)
          }
          return _eval._exeCode(y,_outMap,_inMap)
        })
        if(x.k=="("){
          if(!d||d.constructor!=Array){
            d=[d]
          }
          if(r.n){
            r.v=_eval._exeFun(r,d,_outMap,_inMap)
            r.n=r.d=0
          }else{
            r.v=_eval._exeFun(r,d,_outMap,_inMap)
          }
        }else{
          if(d&&d.constructor==Array){
            d=d.pop()
          }
          r.d=r.v
          r.n=d
          r.v=r.d[d]
        }
      }else{
        x=x.split(".").filter(x=>x)
        x.forEach(y=>{
          r.d=r.v
          r.n=y
          r.v=r.d[y]
        })
      }
    })
    return r
  },
  _countItems:function(ps,c){
    let vs=[],r,s,prs,ss;
    ps.find((x,q)=>{
      if(x=="?"){
        vs=_eval._getFinalValue(_countGroup(vs))
        let qs=_eval._findKeyOuterBlock(ps,":",q+1,{"?":":"})
        if(vs){
          r=_eval._countItems(qs.p)
        }else{
          r=_eval._countItems(qs.e)
        }
        return 1
      }
      if(!["&&","||",">","<",">=","<=","==","===","!=","!==","^","&","|"].includes(x)){
        if(ss){
          if(_eval._isBzData(x)&&x.n){
            if(ss=="++"){
              vs.push(x)
              x.v+=1
              x.d[x.n]=x.v            
            }else if(ss=="--"){
              vs.push(x)
              x.v-=1
              x.d[x.n]=x.v            
            }else if(ss=="!"){
              vs.push(!x.v)
            }else if(ss=="!!"){
              vs.push(!!x.v)
            }else{
              vs.push(~x.v)
            }
            ss=0
          }else{
            if(ss=="!"){
              vs.push(!x)
              ss=0
            }else if(ss=="!!"){
              vs.push(!!x)
              ss=0
            }else if(ss=="~"){
              vs.push(~x)
              ss=0
            }else{
              _eval._throwErr()
            }
          }
          return
        }
        if(x=="*"||x=="/"||x=="%"){
            s=x
        }else if(s){
          vs[vs.length-1]=_eval._count(vs[vs.length-1],s,x)
          s=""
        }else if(x=="++"||x=="--"||x=="!"||x=="~"||x=="!!"){
          if(s||!vs.length||_eval._isSign(vs[vs.length-1])){
            ss=x
          }else{
            let rv=vs[vs.length-1]
            if(x=="++"){
              rv.d[rv.n]+=1
            }else{
              rv.d[rv.n]-=1
            }
          }
        }else{
          vs.push(x)
        }
      }else{
        vs=_eval._getFinalValue(_countGroup(vs))
        if(x=="&&"){
          if(!vs){
            r=_eval._buildBzData(vs)
            return 1
          }
        }else if(x=="||"){
          if(vs){
            r=_eval._buildBzData(vs)
            return 1
          }
        }else{
          prs={v:vs,c:x}
        }
        vs=[]
      }
    })
    if(!r){
      if(vs.length){
        r=_countGroup(vs)
      }
    }
    return _eval._getFinalValue(r)
    function _countGroup(vs){
      [["+","-"],[">>","<<"]].forEach(x=>vs=_countPs(vs,x))
      vs=vs[0]
      if(prs){
        vs=_eval._count(prs.v,prs.c,vs)
        prs=0
      }
      return vs
    }
    function _countPs(vs,c){
      let rs=[],s;
      for(let i=0;i<vs.length;i++){
        let v=vs[i]
        if(c.includes(v)){
          if(!i){
            if("+-".includes(v)){
              rs=[0]
              s=v
            }else if(_eval._isSign(v)){
              _eval._throwErr()
            }
          }else{
            if(s){
              _eval._throwErr()
            }
            s=v
          }
        }else if(s){
          let v1=_eval._getFinalValue(rs[rs.length-1])
          v=_eval._getFinalValue(v)
          rs[rs.length-1]=_eval._count(v1,s,v)
          s=""
        }else{
          rs.push(v)
        }
      }
      return rs
    }
  },
  _buildBzData:function(v,d,n){
    if(_eval._isBzData(v)){
      return v
    }
    return {
      _bzData:"_bzData",
      v:v,
      d:d,
      n:n
    }
  },
  _isBzData:function(v){
    return v&&v._bzData=="_bzData"
  },
  _getFinalValue:function(r){
    if(_eval._isBzData(r)){
      return r.v
    }
    return r
  },
  _isSign:function(c){
    return c&&"~!=><+-*/%^&|?:".includes(c[0])
  },
  _count:function(d1,c,d2){
    d1=_eval._getFinalValue(d1)
    d2=_eval._getFinalValue(d2)
    switch(c){
      case "+": return d1+d2
      case "-": return d1-d2
      case "*": return d1*d2
      case "/": return d1/d2
      case "==": return d1==d2
      case "===": return d1===d2
      case ">": return d1>d2
      case "<": return d1<d2
      case ">>": return d1>>d2
      case "<<": return d1<<d2
      case ">=": return d1>=d2
      case "<=": return d1<=d2
      case "!=": return d1!=d2
      case "!==": return d1!==d2
      case "&": return d1&d2
      case "|": return d1|d2
      case "&&": return d1&&d2
      case "||": return d1||d2
      case "%": return d1%d2
      case "^": return d1^d2
    }
  },
  _mergedataMap:function(_outMap,_inMap,_map){
    Object.keys(_map).forEach(k=>{
      if(Object.keys(_inMap).includes(k)){
        _inMap[k]=_map[k]
      }else{
        _outMap[k]=_map[k]
      }
    })
  },
  _isNumeric:function(a){
    var b = a && a.toString();
    return (!a||a.constructor!=Array) && b - parseFloat(b) + 1 >= 0
  },
  _getValue:function(n,_outMap,_inMap){
    let ns=n.split("."),_map;
    n=ns.shift()
    if(n=="eval"){
      return _eval._buildBzData(_eval._exeCode,_eval,"_exeCode");
    }else if(_eval._isNumeric(n)||n.match(/^['"`].*[`"']$/)){
      let nn=_eval._getTmpDataName()
      _outMap[nn]=_eval._exeCode(n)
      n=nn
    }
    if(Object.keys(_inMap).includes(n)){
      _map=_inMap
    }else if(Object.keys(_outMap).includes(n)){
      _map=_outMap
    }else{
      _map=window
    }
    while(ns.length){
      _map=_map[n]
      n=ns.shift()
    }

    return {
      d:_map,
      n:n,
      v:_map[n],
      _bzData:"_bzData"
    }
  },
  _setValue:function(n,_outMap,_inMap,_defMap,v,_sign){
    let _map,ns;
    if(n.constructor==String){
      ns=n.split(".")
      n=ns.shift()
  
      _map=_eval._getDataMap(n,_outMap,_inMap,_defMap)
    }else{
      _map=_eval._getRefData(n,_outMap,_inMap)
    }
    if(n.constructor!=String||!_defMap||_map==_defMap){
      if(n.constructor==String){
        while(ns.length){
          _map=_map[n]
          n=ns.shift()
        }
      }else{
        n=_map.n
        _map=_map.d
      }
      switch(_sign){
        case "+=":return _map[n]+=v;
        case "-=":return _map[n]-=v;
        case "*=":return _map[n]*=v;
        case "/=":return _map[n]/=v;
        case "%=":return _map[n]%=v;
        case "^=":return _map[n]^=v;
        case "&=":return _map[n]&=v;
        case "|=":return _map[n]|=v;
        case "&&=":return _map[n]&&=v;
        case "||=":return _map[n]||=v;
      }
      return _map[n]=v
    }else{
      throw new Error("")
    }

  },
  _getDataMap:function(n,_outMap,_inMap,_defMap){
    if(Object.keys(_inMap).includes(n)){
      return _inMap
    }
    if(Object.keys(_outMap).includes(n)){
      return _outMap
    }
    return _defMap||window
  },
  _buildScopeDataMap:function(_outMap,_inMap){
    let _map=Object.assign({},_outMap)
    _map=Object.assign(_map,_inMap)
    return _map
  },
  _findKeyOuterBlock:function(vs,tk,_start,bs,_noRegex){
    bs=bs||_eval.bd
    let k,b,c,s;
    _init()
    if(vs.push){
      vs=[...vs]
    }
    if(_start){
      vs=vs.push?vs.splice(_start):vs.substring(_start)
    }
    for(let i=0;i<vs.length;i++){
      c=vs[i]
      if(c=="\\"){
        b=!b
      }else if(b){
        b=0
      }else if(!_noRegex&&k=="/"&&c=="/"){
        _init()
        continue
      }else if(!_noRegex&&!k&&c=="/"&&(!s||s.trim().match(/[\(\[\=\?\:]$/))){
        k="/"
        continue
      }else if(k){
        if(k.r==c){
          if(k.n){
            k.n--
          }else{
            _init()
          }
        }else if(k.l==c){
          k.n++
        }
        continue
      }else if(bs[c]){ //([{
        k={l:c,r:bs[c],n:0,p:{k:c}}
      }
      s.push?s.push(c):s+=c;

      let kk=_isKey(s,c)
      if(kk){
        if(vs.pop){
          return {
            e:vs.splice(i+1),
            p:vs.splice(0,i),
            k:kk
          }
        }
        return {
          p:vs.substring(0,i-kk.length+1),
          k:kk,
          e:vs.substring(i+1)
        }
      }
    }

    function _init(){
      k=0
      s=vs.constructor==Array?[]:"";
    }

    function _isKey(s,c){
      if(tk.constructor==Function){
        return tk(s)
      }else if(tk.constructor==RegExp){
        s=s.match(tk)
        return s&&s[0]
      }
      return (tk==s||tk==c)&&tk
    }
  },
  _parseCode:function(v,_case){
    let vs=_eval._parseLine(v)
    if(_case){
      let ss=[]
      vs.forEach(x=>{
        while(1){
          let k=x.match(/^(case|default)(:|\s|\'\"\`\{)/)
          if(k){
            k=k[1]
            x=x.substring(k.length).trim()
            v=_eval._findKeyOuterBlock(x,":")

            if(v.e.match(/^(case|default)(:|\s|\'\"\`\{)/)){
              x=v.e
              ss.push({k:k,v:v.p.trim(),cs:[]})
              continue
            }
            ss.push({k:k,v:v.p.trim(),cs:[v.e]})
          }else if(ss[0]){
            ss[ss.length-1].cs.push(x)
          }
          break
        }
      })
      ss.forEach(x=>{
        x.cs=x.cs.map(y=>_eval._parseItem(y))
      })

      return ss
    }
    vs=vs.map(x=>_eval._parseItem(x))

    return vs
  },
  _parseItem:function(v){
    let ps=[],pps=[],
        b,p,
        c,cc=[],
        s="",_inpp,
        k,kk,inSingle,
        df, //var, let, const
        ok, //for, if, whilte, do, function,switch
        op; //delete, continue, break

    v=v.trim()

    ok=v.match(/^(if|for|while|function|do|try|switch|else +if|else)(\s|\(|\{)/)
    if(ok){
      ok={
        k:ok[1]
      }
      v=v.substring(ok.k.length).trim()
      if(ok.k=="function"){
        ok.n=v.substring(0,v.indexOf("("))
        v=v.substring(ok.n.length)
        ok.n=ok.n.trim()
      }
    }else{
      ok=v.match(/^\(?([^=,\(\)\{\}\[\]]*)\)?=>/)

      if(ok){
        let vv=v.substring(ok[0].length).trim();
        let e=_eval._findKeyOuterBlock(vv,")")
        if(!e){
          v=vv
          if(v[0]!="{"){
            v="return "+v
          }
          ok={
            k:"=>",
            e:_eval._parseItem(ok[1]||" ")
          }
        }else{
          ok=0
        }
      }else{
        let vv=v.match(/^(let|var|const)\s+([^=,\s]+)(\=|\,|$|;)/)
        if(vv){
          v=v.substring(vv[0].length)
          df={
            k:vv[1],
            n:vv[2]
          }
          ps.push(df)
        }else{
          df=v.match(/^([^=\{\[\("'`\!><\s]+\=)[^>=]/);
          if(df){
            v=v.substring(df[1].length)
            df={
              k:"=",
              n:df[1].replace("=","").trim()
            }
            k=df.n.match(/[\+\-\*\/\%\^]$/)
            if(k){
              k=k[0]
              df.k=k+df.k
              df.n=df.n.replace(k,"").trim()
            }
            ps.push(df)
          }else{
            df=v.match(/^(return|delete|throw|typeof|break|continue|new)(\s|$|\[|\{|\()/)||v.match(/^(\.\.\.)/)
            if(df){
              v=v.substring(df[1].length).trim()
              df={
                k:df[1]
              }
              if(["return","break","continue","throw"].includes(df.k)){
                df.c=_eval._parseCode(v)
                return df
              }
              op=df
              ps.push(op)
              df=0
            }else{
              df=v.match(/^(function)(\s|\()/)
              if(df){
                ok={
                  k:df[1]
                }
                v=v.substring(0,df[1].length).trim()
                df=v.match(/^([^\(]+)/)
                if(df){
                  ok.n=df[1].trim()
                  v=v.substring(0,ok.n.length).trim()
                }
              }
            }
          }
        }
      }
    }
    
    for(let i=0;i<v.length;i++){
      c=v[i]
      let p=ps[ps.length-1]
      if(c=="\\"){
        b=!b
      }else if(b){
        b=0
      }else if(kk){
        if(kk==c){
          kk=0
          if(_inpp){
            _inpp=0
            if(s){
              ps.push("+")
              ps.push('"'+s+'"')
            }
            continue
          }
        }else if(kk=="`"&&s.match(/\$\{$/)){
          let ss=_eval._findKeyOuterBlock(v,"}",i)
          if(ss){
            ps.push('"'+s.substring(1,s.length-2)+'"')
            ps.push("+")
            v=_eval._parseItem(ss.p)
            if(v.constructor==Array){
              v=v[0]
            }
            ps.push(v)
            v=ss.e
            i=-1
            _inpp=1
            s=""
            continue
          }
        }
      }else if("`'\"".includes(c)){
        kk=c
      }else if(k=="/"){
        if(c=="["){
          inSingle=1
        }else if(c=="]"){
          inSingle=0
        }else if(inSingle){
        }else if(c=="/"){
          k=0
        }
      }else if(!k&&!ps.length&&c=="/"&&(!s||s.trim().match(/[\(\[\=\?\:]$/))){
        k="/"
      }else if(!s&&(c==" "||c=="\n")){
        continue
      }else if(k){
        if(k.r==c){
          if(k.n){
            k.n--
          }else{
            if(ok){
              if(ok.k=="do"){
                if(ok.c){
                  ok.e=_eval._parseItem(s)
                  return ok
                }else if(s[0]=="{"){
                  ok.c=_eval._parseCode(s.substring(1))
                }else{
                  k=0
                  s+=c
                  continue
                }
              }else if(ok.k=="try"){
                if(!ok.c){
                  ok.c=_eval._parseCode(s)
                }else if(!ok.e){
                  ok.e=_eval._parseItem(s)
                }else if(!ok.ec){
                  ok.ec=_eval._parseCode(s)
                }else{
                  ok.f=_eval._parseCode(s)
                }
                if(i==v.length-1){
                  return ok
                }
                s=""
                k=0
                continue
              }else if(ok.k=="=>"){
                if(k.l=="{"){
                }else{
                  s+=c
                }
                k=0
                continue
              }else if(k.l=="("){
                if(ok.k=="for"){
                  ok.e=_eval._parseCode(s)
                }else{
                  ok.e=_eval._parseItem(s)
                }
                v=v.substring(i+1).trim()
                if(["for","if","else if"].includes(ok.k)){
                  if(v.match(/^\{.*\}$/s)){
                    v=v.substring(1,v.length-1)
                  }
                  ok.c=_eval._parseCode(v,ok.k=="switch")
                  return ok
                }else{
                  if(v.match(/^\{.*\}$/s)){
                    v=v.substring(1,v.length-1)
                    ok.c=_eval._parseCode(v,ok.k=="switch")
                    return ok
                  }
                }
                i=-1
              }else if(ok.k=="function"){
                k=0
                continue
              }else{
                ok.c=_eval._parseCode(s)
                return ok
              }
            }else if(df||op){
              s+=c
              k=0
              continue
            }else{
              k.p.ps=k.l=="{"?_parseObj(s):s?_eval._parseItem(s):[]
              if(k.p.ps.constructor!=Array){
                k.p.ps=[k.p.ps]
              }
            }
            k=0
            s=""
            continue
          }
        }else if(k.l==c){
          k.n++
        }
      }else if(_eval.bd[c]){ //([{
        k={l:c,r:_eval.bd[c],n:0,p:{k:c}}
        s=s.trim()
        if(ok&&ok.k=="do"){
          if(ok.c){
            s=""
            continue
          }
        }else if(ok&&["=>","function"].includes(ok.k)){
          if(s){
            s+=c
          }
          continue
        }else if(df||op){
        }else if(p&&p.cs){
          if(s){
            p.cs.push(s)
            s=""
          }
          k.p.d=1
          p.cs.push(k.p)
          continue
        }else if(s){
          k.p.d=1
          ps.push({
            dd:s,
            cs:[k.p]
          })
          s=""
          continue
        }else{
          ps.push(k.p)
          continue
        }
      }else if(c=="\n"){
        if(!df||op){
          _init()
          continue
        }
      // }else if(c==";"){
      //   if(df){
      //     df.c=_eval._parseItem(s)
      //     s=""
      //     ps.push(..._eval._parseItem(v.substring(i+1)))
      //     ps=ps.filter(x=>x)
      //     ps.forEach(x=>x.k=ps[0].k)
      //     return ps
      //   }else if(op){
      //     op.c=_eval._parseItem(s)
          
      //   }else if(ok&&(ok.k=="=>"||ok.k=="function")){
      //     ok.c=_eval._parseCode(s)
      //     ps.push(ok)
      //     ps.push(..._eval._parseItem(v.substring(i+1)))
      //     return ps
      //   }
      //   _init()
      //   continue
      }else if(c==","){
        if(df){
          df.c=_eval._parseItem(s)
          _parsePartItem(v.substring(i+1),ps)
          ps=ps.filter(x=>x)
          ps.forEach(x=>x.k=ps[0].k)
          return ps
        }else if(op){
          op.c=_eval._parseItem(s)
          _parsePartItem(v.substring(i+1),ps)
          return ps
        }else if(ok&&(ok.k=="=>"||ok.k=="function")){
          ok.c=_eval._parseCode(s)
          ps.push(ok)
          _parsePartItem(v.substring(i+1),ps)
          return ps
        }else if(!s.trim()){
          if(v.substring(0,i).trim().endsWith(",")){
            ps.push([])
          }
          _parsePartItem(v.substring(i+1),ps)
          return ps
        }else{
          s=`(${s})`
          p=_eval._parseItem(s)
          if(p.constructor==Array&&!ps.length){
            ps=p
          }else{
            ps.push(p)
            ps=[ps]
          }
          v=v.substring(i+1)
          while(1){
            let vv=_eval._findKeyOuterBlock(v,",")
            if(vv){
              ps.push(_eval._parseItem(`(${vv.p})`)[0])
              v=vv.e
            }else{
              ps.push(_eval._parseItem(`(${v})`)[0])
              return ps
            }
          }
        }
      }else if(df||ok||op){
      }else if(_eval._isSign(c)){
        if(df||op){
          s+=c
          continue
        }
        _init()
        p=ps[ps.length-1]
        if(!p||p.constructor!=String){
          ps.push(c)
        }else if("~!==+-*/<>&|".includes(p)){
          p+=c
          if(["--","++","==","===","!=","!==","+=","-=","*=","/=","&&","||",">=","<=",">>","<<","^=","&=","|=","!!","%="].includes(p)){
            ps[ps.length-1]=p
          }else{
            ps.push(c)
          }
        }else{
          ps.push(c)
        }
        p=ps[ps.length-1]
        if(v[i+1]!="="&&["=","+=","-=","/=","*=","^=","%=","&=","|=","&&=","||="].includes(p)){
          ps.pop()
          df={
            k:p,
            n:ps.pop()
          }
          ps.push(df)
        }
        continue
      }
      s+=c
    }
    _init()
    if(pps.length){
      if(!pps.includes(ps)){
        pps.push(ps)
      }
      return pps
    }
    if(!ps.length&&ok){
      return ok
    }
    return ps

    function _parsePartItem(v,ps){
      p=_eval._parseItem(v)
      if(!p||p.constructor!=Array){
        p=[p]
      }
      ps.push(...p)
    }

    function _init(){
      s=s.trim()
      if(s){
        if(ok&&ok.k=="do"){
          ok.c=_eval._parseCode(s)
        }else if(ok&&ok.k=="else"){
          if(!ok.c){
            ok.c=_eval._parseItem(s)
            s=""
          }
        }else if(ok&&(ok.k=="=>"||ok.k=="function")){
          ok.c=_eval._parseCode(s)
          ps.push(ok)
        }else if(df){
          df.c=_eval._parseItem(s)
        }else if(op){
          op.c=_eval._parseItem(s)
        }else if(s.match(/^(delete|typeof)\s/)||s.match(/^\.\.\./)){
          ps.push(_eval._parseItem(s))
        }else if(s.match(/^\./)){
          if(ps.length&&ps[ps.length-1].ps){
            ps[ps.length-1].ps.push(s)
          }else{
            ps.push(s)
          }
        }else{
          ps.push(s)
        }
        s=""
      }
    }

    function _parseObj(o){
      let d={},k,s="",b,ks=[],l;
      o=o.trim()
      if(!o){
        return d
      }
      for(let i=0;i<o.length;i++){
        let c=o[i]
        if(b){
        }else if(c=="\\"){
          b=!b
          continue
        }else if(!k){
          if(!ks.length&&c==":"){
            if(s=="null"){
              k=[null]
            }else if(s=="undefined"){
              k=[undefined]
            }else if(s=="false"){
              k=[false]
            }else if(s=="true"){
              k=[true]
            }else{
              s=s.trim().replace(/^['"]|['"]$/g,"")
              k=[s]
            }
            s=""
            continue
          }
        }else if(!s&&c.match(/\s/)){
          continue
        }else if(c==ks[0]){
          ks.shift()
        }else if("\"'`".includes(ks[0])){
        }else if("({['\"`".includes(c)){
          ks.unshift(_eval.bd[c])
        }else if(c==","&&!ks.length){
          d[k[0]]=_eval._parseItem(s)
          k=""
          s=""
          continue
        }
        s+=c
      }
      if(s){
        d[k[0]]=_eval._parseItem(s)
      }
      return d
    }
  },
  _parseLine:function(v){
    let s="",ps=[],b,k,kk,_endExpress=[],_comment,_inDo,_oneLine=[];
    v=v.trim()

    for(let i=0;i<v.length;i++){
      let c=v[i]

      if(_comment=="/"+"/"){
        if(c=="\n"){
          _comment=0
        }else{
          continue
        }
      }else if(_comment=="/"+"*"){
        if(c=="/"&&v[i-1]=="*"){
          _comment=0
        }
        continue
      }
      if(!s&&c.match(/\s/)){
        continue
      }else if(c=="\\"){
        b=!b
      }else if(b){
        b=0
      }else if(kk){
        if(kk==c){
          kk=0
        }
      }else if("`'\"".includes(c)){
        kk=c
      }else if(k=="/"&&c=="/"){
        k=0
      }else if(!k&&c=="/"&&s.trim().match(/[\(\[\=\?\:]$/)){
        k="/"
      }else if(c==" "&&("+-*/([{%!\?\:".includes(v[i+1])||s.match(/([\s\(\{\[\+\-\*\?\:\/\%\&\|\^\~])$/))){
        continue
      }else if((c=="/"||c=="*")&&s.match(/[^\\]\/$/)){
        _comment="/"+c
        s=s.replace(/[\/]$/,"")
        continue
      }else if(k){
        if(k.r==c){
          if(k.n){
            k.n--
          }else{
            if(_endExpress[0]&&s.includes(_endExpress[0])&&s.substring(_endExpress[0].length).trim()[0]!="{"){
            }else if(k.l=="{"){
              if(s.match(/^(for|if|while|switch|function|else|do|try)[\s\(\{]/)){
                s+=c
                if(!s.match(/^(do|try)/)){
                  _init()
                }
                k=0
                continue
              }
            }else if(k.l=="("&&s.match(/^(if|for|while|switch|function|else if)[\s|\(]/)){
              _endExpress.unshift(s+")")
              let vv=v.substring(i+1).trim();
              if(vv.match(/^(for|if|while|do|try)(\s|\{|\(|$)/)){
                v=vv
                i=-1
                _oneLine.push(_endExpress[0])
                _endExpress=[]
                s=""
                continue
              }
            }
            k=0
          }
        }else if(k.l==c){
          k.n++
        }else if(c.match(/\s/)){
          let vr=v.substring(i+1).trim(),
              vl=v.substring(0,i)
          if(_uselessSpace(vr,vl,c)){
            continue
          }
        }
      }else if(c=="\n"){
        if((_endExpress[0]||"").replace(/ /g,"")==(s||"").replace(/ /g,"")){
          continue
        }
        s=s.trim()
        if(s.match(/^do([\s\{]|$)/)&&!_inDo){
          if(!s.match(/^do\s*\{.+while.+\)/s)){
            s+=c
            _inDo=1
          }else{
            _init()
          }
          continue
        }


        let vr=v.substring(i+1).trim(),
            vl=v.substring(0,i)
        if(_uselessSpace(vr,vl,c)){
          continue
        }
        if(_inDo==1){
          if(!vr.match(/^while(\s|\()/)){
            _inDo=0
            _init()
          }else{
            s+=c
          }
          continue
        }
        if(vl.endsWith("}")&&vr.match(/^(catch|while)(\s|\()/)){
          continue
        }else if(s.trim()=="else"){
          s="else "
          continue
        }
        _init()
        continue
      }else if(c==";"){
        let vr=v.substring(i+1).trim()
        if((!_inDo||!vr.match(/^while(\s|\()/))&&_endExpress[0]!=s){
          ps.push(s.trim())
          s=""
          _init()
          continue
        }
      }else if(_eval.bd[c]){
        s=s.trim()
        k={l:c,r:_eval.bd[c],n:0}
      }
      s+=c
    }
    _init()
    return ps

    function _uselessSpace(vr,vl,c){
      if(vl.match(/([^-]-|[^+]\+|[^\/]\/|[\*=~!&\|\^%><?:,;\.\(\[\{])$/)||vr.match(/^(-[^-]|\!\=|\+[^+]|\/[^\/\*]|[\*%\^&|=><?:,;\.\(\)\[\]\}])/)||vl.match(/([\+][\+][\+]|---)$/)){
        return 1
      }else if(vr[0]=="{"){
        return c!="\n"
      }
    }

    function _init(){
      s=s.trim()
      if(_oneLine.length){
        s=_oneLine.join(" ")+s
        _oneLine=[]
      }
      if(s){
        ps.push(s)
        s=""
      }
      _endExpress.shift()
      _inDo=0
    }
  },
  /**/
  _chkParameter:function(){
    let vs=[]
    for(let i=0;i<arguments.length;i++){
      vs.push(arguments[i])
    }
    return vs
  },
  _testCode:function(_simpleExe,_repeat){
    let vs=[
      {c:`let a=/[a-z]+\\/[0-9]+/ig,b="89a/999B/3d2c/4";b.match(a)`,r:['a/999', 'B/3', 'c/4']},
      {c:"!1+2*3+(~4+5)/3*6+7%2+3^4+!!2<<2+3>>2",r:34},
      {c:"1<2*3&&(4+5)/3*6+7%2>3^4+2<<2+3>>2",r:49},
      {c:"let a=1;!a",r:false},
      {c:"let a=1;~a+5",r:3},
      {c:"_IDE._data._curTest._data.name",r:"demo"},
      {c:"_IDE._data._curTest._data.name+(9+6)*10+'px'",r:"demo150px"},
      {c:"_IDE._data._curTest._data.name+(9+6)*10+1",r:"demo1501"},
      {c:"[1,2,3,null,undefined,0]",r:[1,2,3,null,undefined,0]},
      {c:"({a:2}).a",r:2},
      {c:"[1,2,3][0]",r:1},
      {c:"_Util._replaceAll('lws','w','ok')",r:"loks"},
      {c:"_Util._replaceAll('lws','w','ok')[2]",r:"k"},
      {c:"_ideTestManagement._getStdDescription(_IDE._data._curTest)",r:"[m5.t4] demo"},
      {c:"_ideTestManagement._getStdDescription(_IDE._data._curTest)+' '+_ideTestManagement._getStdDescription(_IDE._data._curTest)",r:"[m5.t4] demo [m5.t4] demo"},
      {c:"_ideTestManagement._getStdDescription(_IDE._data._curTest).length+10*10",r:112},
      {c:"_eval._chkParameter(0)",r:[0]},
      {c:"_eval._chkParameter(undefined)",r:[undefined]},
      {c:"_eval._chkParameter()",r:[]},
      {c:"_eval._chkParameter(1,2,3)",r:[1,2,3]},
      {c:"_eval._chkParameter({})",r:[{}]},
      {c:"[]",r:[]},
      {c:"[0]",r:[0]},
      {c:"[undefined]",r:[undefined]},
      {c:"0",r:0},
      {c:"0.1",r:0.1},
      {c:"''",r:""},
      {c:"undefined",r:undefined},
      {c:"null",r:null},
      {c:"true",r:true},
      {c:"false",r:false},
      {c:`let a=true
        if(a){
          a=11
        }
      `,r:11},
      {c:"(1,2,3)",r:3},
      {c:"let a=3;a*_IDE._data._curTest._data.actions.length;",r:6},
      {c:`let a="lws",b="w",c=3;_Util._replaceAll(a,b,c)+5`,r:"l3s5"},
      {c:`let a={a:3},b=3,c=5;b=3+delete a.a+5,b`,r:9},
      {c:`let a={a:3},b=3,c=5;b=3+typeof a.a+5,b`,r:"3number5"},
      {
        c:`let a=1
        if(a){
          a=3
        }`,
        r:3
      },
      {
        c:`let a=1
        for (let i = 0; i < 10; i++) {
            a+=1
        }`,
        r:11
      },
      {
        c:`let a=1
        for (let i = 0; i < 10; i++) 
            a+=1
        `,
        r:11
      },
      {
        c:`let a=1,i=0
        do{
            a+=7
            i++
        }while(a<100)`,
        r:14
      },
      {
        c:`let a=1
        do
            a+=7
        while(a<100)`,
        r:106
      },
      {
        c:`
        let a=2,b=3;
        if(a){
          let b=222
          a+=b
        }
        `,
        r:224
      },
      {
        c:`
        let a=2,b=3;
        if(a)
          a+=b
        `,
        r:5
      },
      {
        c:`let a=3,b=34;
        lws(3,a,b)+lws(3,b,a)
        function lws(v,a,b) {
          if(a>b){
            a+=1
          }else{
            a+=b
          }
          return v+2+a*b
        }
        `,
        r:1373
      },
      {
        c:`let a=3,b=34;
        lws(3,a,b)+lws(3,b,a)
        function lws(v,a,b) {
          if(a>b)
            a+=1
          else
            a+=b
          
          return v+2+a*b
        }
        `,
        r:1373
      },
      {
        c:`let a=3,b=34;
        lws(function(x){return x*10},a,b)
        function lws(v,a,b) {
          if(a>b){
            a+=1
          }else{
            a+=b
          }
          v=v(a)
          return v+2+a*b
        }`,
        r:1630
      },
      {
        c:`let a=3,b=34;
        lws(x=>x*10,a,b)
        function lws(v,a,b) {
          if(a>b){
            a+=1
          }else{
            a+=b
          }
          v=v(a)
          return v+2+a*b
        }
        `,
        r:1630
      },
      {
        c:`let a=3,b=34;
        lws((x)=>x*10,a,b)
        function lws(v,a,b) {
          if(a>b){
            a+=1
          }else{
            a+=b
          }
          v=v(a)
          return v+2+a*b
        }
        `,
        r:1630
      },
      {
        c:`let a=3,b=34;
        lws(()=>10,a,b)
        function lws(v,a,b) {
          if(a>b){
            a+=1
          }else{
            a+=b
          }
          v=v(a)
          return v+2+a*b
        }
        `,
        r:1270
      },
      {
        c:`let lws=function(x){return x+9};lws(3)`,
        r:12
      // },
      // {
      //   c:`let lws=${_Util._replaceAll.toString()};lws(_eval._testCode.toString(),"a","999")`
      },
      {
        c:`b={c:33,d:334},a={a:function(){
          return b
        }}
        delete a.a().c
        b`,
        r:{d:334}
      },
      {c:"let a=[1,2,3];[a][0][1]",r:2},
      {c:"let a={a:3},b=3,c=5;b=[3+delete a.a+5,b,a];b",r:[9, 3, {}]},
      {c:"let a={a:3},b=3,c=5;b=[3+typeof a.a+5,b,a];b",r:["3number5", 3, {a:3}]},
      {c:`let a=function(){
              arguments[1]+=100;
              return [...arguments]
          }
          a(1,2,3)`,r:[1,102,3]
      },
      {c:"let a=new Date();a.getTime()>100",r:true},
      {
        c:`
        let i,j=10;
        for(i=0;i<10;i++){
          j++
          if(i>3){
            if(i){
               continue
            }
          }
          j++
        }
        j`,
        r:24
      },
      {
        c:`
        let i,j=10;
        for(i=0;i<10;i++){
          j++
          if(i>3){
            if(i){
               break
            }
          }
          j++
        }
        j`,
        r:19
      },
      {
        c:`let a=function(){
            let msg;
            try{
                let a=2;
            if(a){
              throw new Error("lws")
            }
                return 1
            }catch(ex){
                msg=ex.message
            }finally{
                return msg+3
            }
          }
          a()`,
        r:"lws3"
      },
      {
        c:`let a={
          v:"lws",
          a:function(v){
            return v+this.v+this.b(3)
          },
          b:function(v){
            return v*10
          }
        }
        a.a(10)`,
        r:"10lws30"
      },
      {
        c:`[0,1,2].filter(x=>x).map(x=>x*12)`,
        r:[12, 24]
      },
      {
        c:`let lws=function(a){
          let c;
          switch(a){
          case 1:c="+";break;
          case 2:c="-";break;
          case 3:
          case 4:c="*";break;
          default:c="%"
          }
          return eval(10+c+3)
          };
          ([0,1,2,3,4]).map(x=>lws(x))`,
        r:[1, 13, 7, 30, 30]
      },
      {
        c:`a=1,b=0;if(a)for(;a<10;a++)
        b+=3
        b`,
        r:27
      },
      {
        c:"(v=>v+1)(1)",
        r:2
      },
      {
        c:`[lws(10),lws(9),lws(2),lws(7)]
        function lws(v) {
            return v%2?v%3?11:21:v%5?111:112
        }`,
        r:[112, 21, 111, 11]
      },
      {
        c:`\`lws-\${_Util._replaceAll(name,'bz','123')}\``,
        r:"lws-123-master"
      },
      {
        c:"new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' }).format(22);",
        r:"$22.00"
      }
    ]
    let t=Date.now()
    if(!_simpleExe){
      vs.push(
        {
          c:`let a={a:3,b:3}
          debugger
  
          delete a.a
          a
          `,
          r:{b:3}
        },
        {c:"{a:33,b:'lws',c:{d:\"aa\",'e':[33,334,34],f:true,g:false}}",r:{a:33,b:'lws',c:{d:"aa",'e':[33,334,34],f:true,g:false}}},
        {c:"{a:0,b:undefined,c:null,'':1,null:2,undefined:2}",r:{a:0,b:undefined,c:null,'':1,null:2,undefined:2}}
      )
    }else if(_simpleExe=="bz"){
      vs.forEach(x=>x.c=_eval._parseCode(x.c))
      t=Date.now()
    }
    _repeat=_repeat||1
    for(let j=0;j<_repeat;j++){
      let v=vs.forEach(x=>{
        try{
          if(_simpleExe=="js"){
            eval(x.c)
          }else{
            let c=JSON.stringify(_eval._exeCode(x.c))
            if(!_simpleExe&&_repeat<2){
              if(c!=JSON.stringify(x.r)){
                console.log("Failed on:"+x.c+" ==> "+c)
                return 1
              }
            }else{

            }
          }
        }catch(ex){
          console.log("Get Error: "+ex.message+"\n\n"+x.c)
        }
      })
    }
    console.log("Spent time: "+(Date.now()-t))
  }
};/*******************************************************************************
 //AI Functions
 *******************************************************************************/
 $aiAPI={
   getModelAlias:function(o){
     if(o.constructor!=String){
       o=_descAnalysis._retrieveTextForElementPathItem(_cssHandler._findPath(o))||_descAnalysis._retrieveTextForElementPathItem(_cssHandler._findInputPath(o))||""
     }
     return _Util._toCamelWords(_Util._toSingularWord(o))
   },
   //updateDataStatus
   updateDataStatus:function(d,v,m){
     _aiAPI._updateDataStatus(d,v,m)
   },
   //getExeSolutionByParameter
   getExeSolutionByParameter:function(p,k){
     return _aiAPI._getExeSolutionByParameter(p,k)||[]
   },
   async getExistData(express,takeList,data,key){
     if(takeList&&takeList.constructor!=Object){
       takeList={_list:1}
     }
     return await _aiAPI._getExistData(express,takeList||{},data,key)
   },
   searchData:function(express,takeList,data,key){
     if(takeList&&takeList.constructor!=Object){
       takeList={_list:1}
     }
     _aiAPI._searchData(express,takeList||{},data,key)
   },
   searchOrNewData:function(express,data,key){
     _aiAPI._searchData(express,{_new:1},data,key)
   },
   newData:function(express,data,key){
     _aiAPI._createData(express,data,key)
   },
   async initCurModuleData(fun){
     let d=_IDE._data._curModule._data
     return await _aiAPI._getExistData(d.alias||d.code,{_list:1},fun)
   },
   //removeToken
   removeToken:function(){
     return _aiAPI._removeToken()
   },
   //addData
   addData:function(p,m,k){
     return _aiAPI._addData(p,m,k)
   },
   //updateData
   updateData:function(p,m,k){
     return _aiAPI._updateData(p,m,k)
   },
   //deleteData
   deleteData:function(p,m,k){
     return _aiAPI._deleteData(p,m,k)
   },
   //preHandleParameter
   preHandleParameter:function(p,t,m){
     return _aiAPI._preHandleParameter(p,t,m)
   },
   //getAllDataOfCurModule
   getAllDataOfCurModule:function(p){
     return _aiAPI._getAllDataOfCurModule(p)
   },
   //stopRegexAction
   stopRegexAction:function(r,p,k){
     return _aiAPI._stopRegexAction(r,p,k)
   },
   //getCurRefModuleData
   getCurRefModuleData:function(d,dn,k){
     return _aiAPI._getCurRefModuleData(d,dn,k)
   },
   //assignCurtUser
   assignCurtUser:function(p){
     return _aiAPI._assignCurtUser(p)
   },
   //getAuthFlowByRole
   getAuthFlowByRole:function(t){
     return _aiAPI._getAuthFlowByRole(t)
   },
   getAccount:function(d,p){
     return d.find((x,i)=>{
       if(!p){
         return 1
       }else if(p.constructor==String){
         return x.role==p
       }else{
         for(var k in p){
           if(p[k]!=x[k]){
             return
           }
         }
         return 1
       }
     })||d.find(x=>x.username==p)
   },
   //overwriteExistValue
   overwriteExistValue:function(d){
     return _aiAPI._overwriteExistValue(d)
   },
   //parseInnerData
   parseInnerData:function(d){
     return _aiAPI._parseInnerData(d)
   },
   getModuleDataById:function(v,m){
     return _aiAPI._getModuleDataById(v,m)
   },
   retrieveExistData:function(m,f,d){
     return _aiAPI._retrieveExistData(m,f,d)
   },
   toJSONParameter:function(v,fn,_insertIgnoreSubmit){
     v=v===null||v===undefined?{}:v
     if(v.constructor!=Object){
       let vv={}
       vv[fn]=v
       v=vv
     }
     if(_insertIgnoreSubmit){
       v.$ignoreSubmit=1
     }
     v.$asSubForm=1
     return v
   },
   isTheLastAction:function(){
     let a=BZ._getCurAction(),
         t=BZ._getCurTest()
     let as=t._data.actions
     return a==as[as.length-1]
   },
   getUpdateParameter:function(d,p){
     let n={}
     for(let k in p){
       if(d[k]!=p[k]){
         n[k]=p[k]
       }
     }
     return n
   }
 }
 //---------------------------------------------------------------------------------------------//
 
 for(k in $aiAPI){
   $aiAPI[k].toString=function(){}
 };var __=function(v,c,_tab){
  if(!v){
    BZ._log("_IDE._data._curProject,_curVersion,_curModule,_curTest,_curAction,_Util,_CtrlDriver,_setting")
  }
  v=v||_IDE._data._curAction

  if(!v){
    var t=_IDE._data._curTest,m=_IDE._data._curModule,s=_IDE._data._curVersion.setting;
    var k=BZ._data._curPage._key;
    if(t){
      t=t._data;
      switch (k){
        case "_actions":v=t.actions;break;
        case "_data":v=t.dataMap;break;
      }
    }else if(m){
      v=m._data.dataMap
    }else{
      switch (k){
        case "_defaultData":v=s.defaultData;break;
        case "_service":v=s.service;break;
        // case "_preferences":v=curUser._curProject.setting.subscriptions;break;
        // case "_dictionary":v=s.dictionary;break;
        // case "_objectLib":v=s.objectLib;break;
        case "_contentPolice":v=s.content;break;
        case "_alias":v=s.aliasMap;break;
        case "_record":v=s.record;break;
      }
    }
  }
  if(_tab===undefined){
    _tab=2
  }
  return JSON.stringify(v,c,_tab);
}

function _extendJQuery(){
  if(!window.jQuery||jQuery.expr[":"].include){
    return
  }
  var _bzExJQueryFun=/\:(attr|Contains|contains|hidden|show|input|data|link|near|panel|after|before|containCss|css|noCss|endContains|endEqual|equal|RowCol|rowcol|bz|textElement|blank|Attr|text) *(=|$)/g;
  //div:include({div.btn:bz=$field:name:Contains=lws}{div.btn:bz=$field:id}{:equal=23423423})
  //div:include({div.btn:bz=$field:name:Contains=lws}-{div.btn:bz=$field:id}{:equal=23423423})
  jQuery.expr[":"].include= function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    m=m[3]

    if(!document._include||document._include.k!=m||Date.now()-document._include._time>1000){
      document._include={_time:Date.now(),k:m}
      
      m=m.replace(/\\:/g,":\r")
      let s=m.match(/[\-]? *\{[^\}]+\}/g)||[m]
      s=s.map(x=>{
        let n=x.match(/^([\-]? *)\{/)||""
        if(n){
          n=n[1].trim()
          if(n){
            x=x.substring(1)
          }
        }
        x=x.trim()
        if(x.match(/^\{.+\}$/)){
          x=x.substring(1,x.length-1)
        }

        let v=x.match(_bzExJQueryFun),vs=[]
        if(v){
          v.forEach(y=>{
            let i=x.indexOf(y)
            vs.push(x.substring(0,i))
            x=x.substring(i+y.length)
          })
          vs.push(x)
          x=vs.map((y,i)=>{
            y=y.trim().replace(/[:]\r/g,":")
            if(i){
              let vv=v[i-1].replace(/=$/,"").trim()
              if(y){
                y=vv+"("+y+")"
              }else{
                y=vv
              }
            }
            return y
          }).join("")
        }
        x=$(x).toArray()
        return {n:n,x:x}
      })
      document._include.os=s
    }
    return !document._include.os.find(x=>{
      let xx=$(a).find(x.x)[0]
      return x.n?xx:!xx
    })
  }

  jQuery.expr[":"].text=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    var v2=m[3].toLowerCase().trim();
    if(!v2){
      return
    }
    v2=v2.replace(/\s+/," ")
    if(a.nodeType!=1){
      return
    }

    if(!document._text||document._text.k!=m[3]||Date.now()-document._text._time>1000){
      let f=document.body;
      let o=_Util._findLabel(f,v2)

      if(!o.length&&!_Util._isRegexData(v2)&&!v2.includes("|")){
        let vv=_Util._removeSign(v2," ")
        o=_Util._findLabel(f,vv,1)
      }
      o=o.map(x=>_cssHandler._findCellElement(x.o))
      
      if(!o.length||!o.find(x=>x.innerText.trim().toLowerCase()==v2.toLowerCase())){
        let ks=_IDE._data._setting.content.contentAttribute.replace("placeholder","").replace(/\|\|/g,"|")
        let oa=$(`:attr(${ks}=${v2})`).toArray()
        if(!oa.length){
          oa=$(`input:attr(value=${v2})`).toArray()
          ks=["value"]
        }else{
          ks=ks.split("|")
        }
        if(oa.length){
          oa.forEach(x=>x._bzWordLength=_findBestAttrValue(x,ks))
          oa.sort((a,b)=>a._bzWordLength-b._bzWordLength)
          
          o=oa.filter(x=>x._bzWordLength==oa[0]._bzWordLength)
        }
      }

      document._text={
        _time:Date.now(),
        k:m[3],
        as:o
      }
    }

    let as=document._text.as
    return as.includes(a)||$(as).find(a)[0]||(["A","BUTTON"].includes(a.tagName)&&$(a).find(as)[0])
    function _findBestAttrValue(a,ks){
      let aa="";
      ks.forEach(x=>{
        x=a.attributes[x]||{}
        x=x.value
        if(x){
          if(x.toLowerCase().includes(v2.toLowerCase())){
            if(!aa||aa.length>x.length){
              aa=x
            }
          }
        }

      })
      a._bzWordLength=aa.length
      return aa.length
    }
  }

  jQuery.expr[":"].attr=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    return _chkAttr(a,i,m)
  }

  jQuery.expr[":"].Attr=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    return _chkAttr(a,i,m,1)
  }

  function _chkAttr(aa,i,m,_full){
    var v2=m[3],a=aa;
    v2=v2.split("=")
    var v1=v2.shift()
    v2=v2.join("=")

    v1=v1.replace("*","").trim()
    v1=v1.split("|")
    return v1.find(v1=>{
      if(v1!="value"){
        a=aa.attributes[v1]
      }
      if(a && a.value){
        try{
          if(_Util._isRegexData(v2)){
            v1=_Util._eval(`v1=a.value.match(${v2})`,{a:a})
            return v1
          }
          if(v2.endsWith("\" i")||v2.endsWith("\i i")){
            v2=v2.substring(1,v2.length-3)
          }
          v2=_Util._filterTxt(v2)
          v2=_Util._trimSpace(v2)
          v1=_Util._filterTxt(a.value)
          
          if(v1==v2||(!_full&&v1.toLowerCase().includes(v2.toLowerCase()))){
            a._bzJq="attr"
            a._bzJqVal=v1
            return true
          }
        }catch(e){
          if(v1==v2){
            a._bzJq="attr"
            a._bzJqVal=_Util._filterTxt(a.value)
            return true
          }
        }
      }
    })
  }

  jQuery.expr[":"].Contains = function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    m=m[3]

    if(!document._Contains||document._Contains.k!=m||!document._Contains._tag.includes(a.tagName)||a._Contains||Date.now()-document._Contains._time>1000){
      // console.log("pre-handle-dom: "+m)
      // console.log("init Contains: "+a.tagName+","+m)
      let v2=m;
      if(!document._Contains||document._Contains.k!=m||Date.now()-document._Contains._time>1000){
        document._Contains=0
      }
      let _inHidden=jQuery._inHidden
      
      let _inRegex=window._ideDataManagement&&_Util._isRegexData(v2)
      if(_inRegex){
        v2=_Util._getRegexByBZName(v2.substring(1,v2.length-1),1)
        v2=new RegExp(v2,"im")
      }else{
        v2=v2.trim().toLowerCase();
        v2=_Util._filterTxt(v2)
        v2=v2.replace(/\*/g,".*")
      }
      let os=_Util._getElementsByWord(function(w){
        w=(w||"").trim().toLowerCase();
        if(_inRegex){
          return w.match(v2)
        }else{
          w=_Util._filterTxt(w)
          return _Util._includesWord(w,v2,1)
        }
      },a.tagName,document._Contains?document._Contains._inHidden:_inHidden,_Util._getRootDom(a))
      if(document._Contains){
        document._Contains._tag.push(a.tagName)
        document._Contains.os=document._Contains.os.concat(os)
      }else{
        document._Contains={
          _inHidden:_inHidden,
          _tag:[a.tagName],
          k:m,
          os:os,
          _time:Date.now()
        }
        jQuery._inHidden=_inHidden
      }
    }
    return document._Contains.os.includes(a)
  };

  jQuery.expr[":"].hidden= function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    return _Util._isHidden(a)
  }

  jQuery.expr[":"].show= function(a,i,m){
    return true
  }

  jQuery.expr[":"].panel=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    var v2=_Util._toTrimSign(m[3].toLowerCase());
    if(!v2){
      return
    }
    v2=v2.replace(/\s+/," ")
    if(a.nodeType!=1){
      return
    }

    if(!document._panel||document._panel.k!=m[3]||Date.now()-document._panel._time>1000){
      let os=_cssHandler._findNodeByTxt(document.body,v2),oo=new Set();
      if(!os.length&&!_Util._isRegexData(v2)&&!v2.includes("|")){
        let vv=_Util._removeSign(v2," ")
        os=_cssHandler._findNodeByTxt(document.body,vv,1)
      }
      os.forEach(x=>{
        let ss=[]
        _findPanelByHeader(x,ss)
        ss.forEach(y=>oo.add(y))
      })

      document._panel={
        _time:Date.now(),
        k:m[3],
        as:[...oo],
        _tags:new Set()
      }
    }
    
    return document._panel.as.includes(a)
    function _findPanelByHeader(x,ss){
      let e=x.e,
          r=x.o.getBoundingClientRect(),
  //        c=_cssHandler._getUniqueClass(x.o),
          f=_cssHandler._retrieveFontInfo(x.o),
          _start,_hasPreHeader,
          pp=_cssHandler._getBetterParent(x.e);
      while(e.parentElement){
        let p=e.parentElement
        for(let c of p.children){
          if(c==e){
            _start=1
            ss.push(c)
          }else if(!_Util._isHidden(c)){
            if(_start){
              
              let os=$(c).find(x.o.tagName).toArray()
              if(x.o.tagName==c.tagName){
                os.unshift(c)
              }
              if(!os.find(y=>{
                if(!_Util._isHidden(y)){
                  y=_cssHandler._retrieveFontInfo(y)
                  return _Util._isSameObj(f,y)
                }
              })){
                ss.push(c)
              }else{
                return ss
              }
            }else{
              _hasPreHeader=1
            }
          }
        }
        if(p==pp||_cssHandler._isFixedAbsoluteElement(p)||p.previousElementSibling||p.tagName=="BODY"){
          if(_hasPreHeader){
            return ss
          }
          ss.length=0
          ss.push(p)
          return ss
        }
        e=p
      }

    }
    
    
  }

  jQuery.expr[":"].match=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    m=m[3]
    if(!_Util._isRegexData(m)){
      m="/"+m+"/"
    }
    m=_Util._eval(m)
    return (a.innerText||"").trim().match(m)
    
  }
  jQuery.expr[":"].input=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    var v2=m[3].toLowerCase().trim();
    if(!v2){
      return
    }
    v2=v2.replace(/\s+/," ")
    if(a.nodeType!=1){
      return
    }

    if($util._tmpFormForSearchingInput||!document._input||document._input.k!=m[3]||Date.now()-document._input._time>1000){
      let f=$util._tmpFormForSearchingInput||_cssHandler._findForm()||document.body;
      $util._tmpFormForSearchingInput=0
      let o=_Util._findLabel(f,v2),
          os=new Set()

      if(!o.length&&!_Util._isRegexData(v2)&&!v2.includes("|")){
        let vv=_Util._removeSign(v2," ")
        o=_Util._findLabel(f,vv,1)
      }
      o.forEach(x=>{
        let ss=[]
        _findInputByLabel(x,ss)
        ss.forEach(y=>os.add(y))
      })
      os=[...os]

      if(!os.length||!os.find(x=>_Util._isStdInputElement(x)||_Util._isInContentEditable(x))){
        let oos=$(`:attr(${_IDE._data._setting.content.contentAttribute}=${v2})`).toArray()
        _Util._spliceAll(oos,x=>{
          if(!_Util._isInputObj(x)||(_Util._isHidden(x)&&!["checkbox","radio"].includes(x.type))){
            return 1
          }
        })
        if(oos.length){
          os=oos
        }
      }

      let ios=$(os).find("input").toArray().filter(x=>["checkbox","radio"].includes(x.type))
      if(ios.length){
        os=ios
      }

      document._input={
        _time:Date.now(),
        k:m[3],
        as:os,
        _tags:new Set()
      }
    }

    
    return document._input.as.includes(a)||$(document._input.as).find(a)[0]
    
    function _findInputByLabel(o,os){
      if(o.e&&o.e.tagName=="LABEL"){
        let k=o.e.attributes.for
        if(k){
          k=$("#"+k.value.replace(/([^0-9a-zA-Z\_\-])/g,"\\$1"))[0]
          if(k){
            os.push(k)
            return
          }
        }
        let oo=_Util._findInputs(o.e,1)
        if(oo.length){
          os.push(...oo)
          return
        }
      }
      if(o.ks.length){
        o.ks.find(x=>{
          let oo=_Util._findInputs(x,1)
          if(oo.length){
            os.push(...oo)
            return 1
          }
        })
      }
      if(os.length){
        return
      }
      let e=o.e
      while(e&&e.tagName!="TD"&&e.nextElementSibling){
        if(_cssHandler._findSamilarElementByStyle(e.nextElementSibling,o.o).length){
          break
        }
        if(_cssHandler._findSamilarElementByStyle(e.nextElementSibling,o.e).length){
          break
        }
        if(e==o.e){
          let _chkbox=_findCheckboxInPreviousElement(e)
          if(_chkbox){
            os.push(_chkbox)
            break
          }
        }
        let oo=_Util._findInputs(e.nextElementSibling,1)
        oo=oo.filter(x=>!_Util._isHidden(x))
        os.push(...oo);
        
        if(!os.length){
          if(_cssHandler._lookLikeInput(o.e,e.nextElementSibling)){
            os.push(e.nextElementSibling)
            break
          }
        }else{
          break
        }
        e=e.nextElementSibling
      }
      if(os.length){
        return
      }
      if(o.ks.length==1){
        os.push(...o.ks)
      }else if(o.ks.length>1){
        os.push(_Util._getShareParent(o.ks[0],o.ks[1]))
      }
      if(!os.length&&o.e){
        o.e=o.e.parentElement
        _findInputByLabel(o,os)
      }
    }
    
    function _findCheckboxInPreviousElement(e){
      let p=e.previousElementSibling
      if(p){
        if(p.tagName=="INPUT"&&p.type=="checkbox"){
          return p
        }else if(!p.innerText){
          let cs=$(p).find("input[type=checkbox]")
          if(cs.length){
            return cs[cs.length-1]
          }else{
            return _findCheckboxInPreviousElement(p)
          }
        }
      }
    }
    
  }


  jQuery.expr[":"].data=function(a,i,m){
    let r=jQuery.expr[":"].input(a,i,m)
    if(r){
      var vv=_Util._removeSign(m[3]).toLowerCase().trim();
      if(_Util._isInputObj(a)){
        if(a.type=="checkbox"){
          a.bzData=a.checked
        }else if(a.type=="radio"){
          a.bzData=$(`input[name=${a.value}]:checked`).val()
        }else if(_Util._isInContentEditable(a)){
          a.bzData=a.innerText
        }else{
          a.bzData=$(a).val()
        }
      }else{
        let v=a.innerText
        v=v.split(/[:：]/)
        if(v.length>1){
          if(vv==_Util._removeSign(v[0].toLowerCase())){
            a.bzData=v[1]
          }
        }else{
          a.bzData=a.innerText
        }
      }
    }
    return r
  }

  jQuery.expr[":"].link=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    var v2=_Util._toTrimSign(m[3].toLowerCase());
    if(!v2){
      return
    }
    v2=v2.replace(/\s+/," ")
    if(a.nodeType!=1){
      return
    }

    /******************* New Code start *****************************************/
    if(!document._link||document._link.k!=v2||Date.now()-document._link._time>1000){
      let vs=v2.split("|"),oo=[]
      vs.forEach(v=>{
        let o=_Util._getTargetElement($(":endContains("+v+")")),os=[],ss=$("*")

        if(!o.length){
          o=$(":Contains("+v+")").toArray()
          o=_Util._getCeilDom(o)
        }
        if(!o.find(x=>x.innerText==v)){
          os=$("INPUT").toArray().filter(x=>["image","submit","button","reset"].includes(x.type)&&_Util._toTrimSign(x.value.toLowerCase())==v2)
          if(!os.length){
            os=$(`:attr(${_IDE._data._setting.content.contentAttribute}=${v2})`).toArray()
          }
          if(!os.length){
            os=o
          }
        }else{
          os=o
        }
        oo=oo.concat(os)
      })
      
      let os=oo.filter(x=>["A","BUTTON","INPUT"].includes(x.tagName))
      
      if(!os.length){
        os=oo.map(x=>_Util._getParentElementByCss("button,a",x)).filter(x=>x)
        if(!os.length){
          os=oo
        }
      }

      document._link={
        _time:Date.now(),
        k:v2,
        as:os,
        _tags:new Set()
      }
    }

    
    return document._link.as.includes(a)
  }

  jQuery.expr[":"].near = function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    let v2=m[3]
    let _inRegex=window._ideDataManagement&&_Util._isRegexData(v2)
    if(!v2){
      return
    }
    if(!_inRegex){
      v2=_Util._toTrimSign(v2.toLowerCase());
      v2=v2.replace(/\s+/," ")
    }else{
      _inRegex=_Util._eval("_inRegex="+v2)
    }
    if(a.nodeType!=1){
      return
    }

    /******************* New Code start *****************************************/
    if(!document._near||document._near.k!=v2||a._near||Date.now()-document._near._time>1000){
      let _inHidden=jQuery._inHidden
      let o=_Util._getTargetElement($(":endContains("+v2+")"))
      _Util._spliceAll(o,x=>{
        return _Util._isHidden(x)
      })
      if(!o.length){
        o=$(":Contains("+v2+")").toArray()
        o=_Util._getCeilDom(o)
        _Util._spliceAll(o,x=>{
          return _Util._isHidden(x)
        })
      }

      document._near={
        _inHidden:_inHidden,
        o:o,
        _time:Date.now(),
        k:v2,
        as:new Set(),
        _tags:new Set()
      }
    }  

    if(document._near._inHidden){
      if(!_Util._isHidden(a)){
        return
      }
    }else{
      if(_Util._isHidden(a)){
        return
      }
    }
    _searchCandiate(a)
    if(!document._near.as.has(a)){
      return
    }
    /******************* New Code end *********************************************/
    v2=_Util._toTrimSign(v2,30)
    if(BZ._tmpNearRegexKey!=v2){
      BZ._tmpNearRegexKey=v2
      v2=_Util._filterTxt(v2);
      v2=_Util._trimSpace(v2)
      BZ._tmpNearRegex=v2.replace(/\*/g,".*")
    }
    var v1=_Util._findNearTxt(a,BZ._tmpNearRegex)
    if(v1){
      if((_inRegex&&v1.match(_inRegex))||(!_inRegex&&_Util._includesWord(v1,BZ._tmpNearRegex,1))){
        a._bzJq="near"
        a._bzJqVal=v1
        return true
      }
    }
    return false
    
    function _searchCandiate(a){
      let d=document._near
      if(d._tags.has(a.tagName)){
        return
      }
      d._tags.add(a.tagName)
      let o=Object.assign([],d.o)
      let oo=o.map(x=>x.getBoundingClientRect()),as=new Set(),_loop=0;
      while(oo.length&&_loop<3){
        
        for(let i=0;i<o.length;i++){
          let x=o[i]
          let p=x.parentElement
          if(!p||p.tagName=="BODY"){
            return
          }
          o[i]=p
          let os=$(p).find(a.tagName).toArray()
          if(os.length){
            os.forEach(y=>as.add(y))
            if(_Util._isCellElement(a)){
              o.splice(i,1)
              oo.splice(i--,1)
            }
          }
        }
        if(!o[0]||o[0].tagName=="BODY"){
          break
        }
        if(as.size){
          if(d._inHidden){
            break
          }
          _loop++
          for(let i=0;i<oo.length;i++){
            let or=o[i].getBoundingClientRect()
            if(or.width- oo[i].width>100&&or.height- oo[i].height>100){
              oo.splice(i,1)
              o.splice(i--,1)
            }
          }
        }
      }
      as=[...as]
      as.forEach(x=>d.as.add(x))
    }
  };

  jQuery.expr[":"].next= function(a,i,m){
    return a.nextElementSibling
  }

  jQuery.expr[":"].previous= function(a,i,m){
    return a.previousElementSibling
  }

  jQuery.expr[":"].parent= function(a,i,m){
    return a.parentNode
  }

  jQuery.expr[":"].after= function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    m=m[3]
    if(a.nodeType!=1 ||a.type=="hidden"){
      return
    }

    if(!document._after||document._after.k!=m||a._after||Date.now()-document._after._time>1000){
      let _inHidden=jQuery._inHidden,_panel=document._after?document._after._panel:(jQuery.tmpPanel&&$(jQuery.tmpPanel))
      let o=_Util._getTargetElement($(":endContains("+m+")")),
          os=_inHidden?$("*"):_Util._getAllVisableElementsInJQ()
      
      _Util._spliceAll(o,x=>{
        return (_panel&&!_panel.find(x)[0])||_Util._isHidden(x)
      })
      if(!o.length){
        o=$(":Contains("+m+")").toArray()
        _Util._spliceAll(o,x=>{
          return (_panel&&!_panel.find(x)[0])||_Util._isHidden(x)
        })
        o=o.pop()
      }else{
        o=o[0]
      }
      jQuery._inHidden=_inHidden
      document._after={
        _panel:_panel,
        _inHidden:_inHidden,
        o:o,
        _time:Date.now(),
        k:m,
        os:os,
        _idx:os.index(o)
      }
    }
    if(!document._after._inHidden&&_Util._isHidden(a)){
      return
    }
    if(document._after.os.index(a)>document._after._idx){
      return 1
    }
  };

  jQuery.expr[":"].before= function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    return _findBeforeElement(a,i,m)
  };

  function _findBeforeElement(a,i,m){
    m=m[3]
    if(a.nodeType!=1 ||a.type=="hidden"){
      return
    }
    let _timer=Date.now()

    if(!document._before||document._before.k!=m||a._before||Date.now()-document._before._time>1000){
      let _inHidden=jQuery._inHidden
      let o=$(":endEqual("+m+")").toArray(),
          os=_inHidden?$("*"):_Util._getAllVisableElementsInJQ()
          
      if(!o.length){
        o=_Util._getTargetElement($(":endContains("+m+")"))
        _Util._spliceAll(o,x=>{
          return _Util._isHidden(x)
        })
      }
      if(!o.length){
        o=$(":Contains("+m+")").toArray()
        _Util._spliceAll(o,x=>{
          return _Util._isHidden(x)
        })
        o=_Util._getSameTextDom(_Util._getCeilDom(o),m)
      }
      jQuery._inHidden=_inHidden
      document._before={
        _inHidden:_inHidden,
        _time:Date.now(),
        k:m,
        os:os,
        o:o.map(x=>{
          return {
            o:x,
            _idx:os.index(x),
            r:x.getBoundingClientRect()
          }
        })
      }
    }
    if(!document._before._inHidden&&_Util._isHidden(a)){
      return
    }
    let n=document._before.os.index(a)
    return document._before.o.find(x=>{
      let _idx=x._idx
      if(a.tagName=="INPUT"&&a.type=="checkbox"&&$(x.o).find(a.tagName)[0]){
        return !!$(x.o).find(a)[0]
      }
      if(_idx>n){
        if(x._idx-n==1){
          return 1
        }
        for(let j=n+1;j<_idx;j++){
          let c=document._before.os[j]
          if((c.innerText||"").trim()&&!_Util._isHidden(c)){
            if($(c).find(x.o)[0]){
              continue
            }
            return
          }else if(c.tagName==a.tagName&&c.type!=="hidden"){
            return
          }else{
            c=c.getBoundingClientRect()

            if(c.top>x.r.bottom||c.right>x.r.right){
              return
            }
          }
        }
        return 1
      }else if(n-x._idx==1){
        return _Util._positionAfterElement(x.o,a)
      }
    })
  }
  jQuery.expr[":"].containCss = function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    return $(a).find(m[3].trim()).length>0;
  };
  /**
   * includes other element
   */
  jQuery.expr[":"].noCss=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    let v=m[3].toLowerCase().split("|"),
        c=""
    return v.find(vv=>{
      if(vv[0]=="."){
        if(a.className&&a.className.constructor==String){
          return !_includes(a.className,vv)
        }
      }else if(vv[0]=="#"){
        if(a.id&&a.id.constructor==String){
          return !_includes(a.id,vv)
        }
      }
    })&&true
    
    function _includes(c,vv){
      c=c.toLowerCase()
      vv=vv.substring(1)
      let v2=vv.split(/[^a-z0-9]/)
      if(v2.length==1){
        return c.split(/[^a-z0-9]/).includes(vv)
      }else{
        return c.includes(vv)
      }
    }
  };

  jQuery.expr[":"].css=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    let v=m[3].toLowerCase().split("|"),
        c=""
    return v.find(vv=>{
      if(vv[0]=="."){
        if(a.className&&a.className.constructor==String){
          return _includes(a.className,vv)
        }
      }else if(vv[0]=="#"){
        if(a.id&&a.id.constructor==String){
          return _includes(a.id,vv)
        }
      }
    })&&true
    
    function _includes(c,vv){
      c=c.toLowerCase()
      vv=vv.substring(1)
      let v2=vv.split(/[^a-z0-9]/)
      if(v2.length==1){
        return c.split(/[^a-z0-9]/).includes(vv)
      }else{
        return c.includes(vv)
      }
    }
    return $(a).find(m[3].trim()).length>0;
  };

  jQuery.expr[":"].endContains = function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    let o= _checkEndContains(a,i,m)
    if(o){
      a._bzJq="endContains"
    }
    return o
  };

  function _checkEndContains(a,i,m){
    m=m[3]

    if(!document._endContains||document._endContains.k!=m||!document._endContains._tag.includes(a.tagName)||a._endContains||Date.now()-document._endContains._time>1000){
      let _inHidden=jQuery._inHidden
      // console.log("init endContains:"+a.tagName+","+m)
      let v2=m;
      if(!document._endContains||document._endContains.k!=m||Date.now()-document._endContains._time>1000){
        document._endContains=0
      }
      let _inRegex=window._ideDataManagement&&_Util._isRegexData(v2)
      if(_inRegex){
        v2=_Util._getRegexByBZName(v2.substring(1,v2.length-1),1)
        v2=new RegExp(v2,"im")
      }else{
        v2=v2.trim().toLowerCase();
        v2=_Util._filterTxt(v2)
        v2=v2.replace(/\*/g,".*")
      }
      let os=_Util._getEndElementsByWord(function(w){
        w=(w||"").trim().toLowerCase();
        if(_inRegex){
          return w.match(v2)
        }else{
          w=_Util._filterTxt(w)
          return _Util._includesWord(w,v2,1)
        }
      },a.tagName,document._Contains?document._Contains._inHidden:_inHidden,a)
      if(document._endContains){
        document._endContains._tag.push(a.tagName)
        document._endContains.os=document._endContains.os.concat(os)
      }else{
        document._endContains={
          _inHidden:_inHidden,
          _tag:[a.tagName],
          k:m,
          os:os,
          _time:Date.now()
        }
        jQuery._inHidden=_inHidden
      }
    }
    return document._endContains.os.includes(a)
  }

  jQuery.expr[":"].endEqual = function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    if(_Util._isNoTextElement(a)){
      return
    }
    var os=a.childNodes;
    var v2=m[3],_inRegex=window._ideDataManagement&&_Util._isRegexData(v2)
    if(_inRegex){
      v2=_Util._getRegexByBZName(v2.substring(1,v2.length-1),1)
      v2=new RegExp(v2,"i")
    }else{
      v2=v2.trim().toLowerCase();
      v2=_Util._trimSpace(v2)
    }
    for(var i=0;i<os.length;i++){
      var o=os[i];
      if(o.nodeType==3){
        var t=_Util._pickTextFromNode(os,i);
        i=t.i;
        var v1=_Util._trimSpace(t.t.toLowerCase())
        if(_inRegex){
          if(v1.match(v2)){
            a._bzJq="endEqual"
            a._bzJqVal=t.t
            return true
          }else{
            return 
          }
        }else{
          try{
            if(v1==v2){
              a._bzJq="endEqual"
              a._bzJqVal=t.t
              return true;
    //          return $(a.ownerDocument.body).find(a).length;
    //          return !_Util._isHidden(a);
            }
          }catch(e){
            if(v1.includes(v2)){
              a._bzJq="endEqual"
              a._bzJqVal=t.t
              return true;
    //          return $(a.ownerDocument.body).find(a).length;
    //          return !_Util._isHidden(a);
            }
          }
        }
      }
    }
  };

  jQuery.expr[":"].equal = function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    if(_Util._isNoTextElement(a)){
      return
    }
    let t=jQuery(a).text().trim().toLowerCase(),_match
    m=m[3].trim().toLowerCase()
    return t==m
    // if(_Util._isRegexData(m)){
      // eval(`m=${m}`)
      // _match=t.match(m)
    // }else{
      // _match=t.includes(m)
    // }
    // if(_match){
    // if(t.includes(m)){
      // let r=t.replace(m,"").replace(_Util._matchAllSign,"").trim()
      // if(!r){
        // a._bzJq="equal"
        // a._bzJqVal=t
        // return true
      // }
    // }
  };

  //simplar(include)
  jQuery.expr[":"].RowCol=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    return _findRowCol(a,i,m,(v1,v2)=>{
      return v1.toLowerCase()==v2.toLowerCase()
    })
  }

  jQuery.expr[":"].rowcol=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    return _findRowCol(a,i,m,(v1,v2)=>{
      return v1==v2
    })
  }

  function _findRowCol(a,i,m,_fun){
    m=m[3].replace(/^\[(.+)\]$/,"$1")
    let rs,cs,k=m;
    let _timer=Date.now()

    if(!document._rowcol||document._rowcol.k!=m||a._rowcol||Date.now()-document._rowcol._time>1000){

      m=m.split("|")
      rs=_Util._findTextBox(m[0],_fun)||[]
      rs=[...new Set(rs)]
      cs=_Util._findTextBox(m[1],_fun)||[]
      cs=[...new Set(cs)]
      let _founds=[]
      if(rs.length&&cs.length){
        rs.find((x,i)=>{
          let os1=_getCloser(x,cs,1),cc=[]
          os1.forEach(y=>{
            let os2=_getCloser(y,rs)
            if(os2.includes(x)){
              cc.push(y)
            }
          })
          if(cc.length){
            rs[i]={
              o:x,
              r:x.getBoundingClientRect(),
              cs:cc.map(y=>y.getBoundingClientRect()),
              cc:cc
            }
          }
        })
        rs.forEach(r=>{
          if(r.cs){
            let xo=r.o,_chkRow
            while(1){
              let os=$(xo).find(a.tagName).toArray(),_found=[]
              if(!os.length){
                if($(xo).is(a.tagName)){
                  os=[xo]
                }
              }
              os.find(o=>{
                let or=o.getBoundingClientRect();
                if(_match([r],or)){
                  _found.push(o)
                }else if(_found.length){
                  return 1
                }
              })
              _chkRow=os.length
              _founds=_founds.concat(_found)
              if(_found.length||r.cs.find(c=>{return c.right-5<=xo.getBoundingClientRect().right})){
                break
              }
              xo=xo.parentElement
            }
          }
        })
      }

      document._rowcol=a._rowcol={
        _time:Date.now(),
        rs:rs,
        k:k,
        _founds:_founds
      }
    }
    return document._rowcol._founds.includes(a)

    function _match(rs,ar,_chkRow){
      return rs&&rs.find(y=>{
        return (y.r.right<=ar.left||y.r.left<=ar.left)
              &&(!_chkRow||(y.r.top-5<ar.top&&y.r.bottom+5>ar.bottom))
              &&y.cs.find(x=>{
                  return x.bottom<=ar.top&&x.left-5<ar.left&&x.right+5>ar.right
                })
      })
    }
    
    function _getCloser(x,os,_before){
      let xr=x.getBoundingClientRect(),
          vs=[]
      os.forEach(o=>{
        if(o.getBoundingClientRect){
          let or=o.getBoundingClientRect()
          if(_before){
            if(or.bottom<xr.top+5&&xr.left<=or.left+5){
              vs.push(o)
            }
          }else{
            if(or.top+5>xr.bottom&&xr.left+5>or.left){
              vs.push(o)
            }
          }
        }
      })
      while(vs.length){
        let cs=$(x).find(vs).toArray()
        if(!cs.length){
          x=x.parentElement
        }else{
          return cs
        }
      }
      return []
    }
  }

  jQuery.expr[":"].textElement=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    if(a.tagName!="CANVAS"){
      return
    }
    if(_TWHandler._getCanvasTextElement(a,m[3])){
      return true
    }
  }

  jQuery.expr[":"].blank=function(a,i,m){
    if(_Util._isIgnoreElement(a)){
      return
    }
    m=m[3]||0
    return m==_identifyIFrameHandler._getBlankIFrameID(a)
    
  }

  jQuery.expr[":"].bz=function(a,i,m){
    let v=a.dataset.bz
    if(!v){
      return
    }

    m=m[3]
    m=m.split("=")
    a=_cssHandler._getBzPath(a)
    return a.bz.find(x=>x.k==m[0]&&(x.v==m[1]||!m[1]))
  }

  for(var k in jQuery.expr[":"]){
    jQuery.expr[":"][k].toString=function(){}
  }

  //get sub iframe
  jQuery.fn.findIframe=function(a){
    return $util.findIFrame(arguments)
  }
}
_extendJQuery();var _extractData={
//bz-test-code-start
  _testData:{
    d:{
      name:"name-1",
      value:"value-1",
      data:{
        name:"name-2",
        value:"value-2"
      },
      list:[
        {
          name:"name-3",
          value:"value-3"
        },
        {
          name:"name-4",
          value:"value-4",
          age:33
        },
        {
          name:"name-5",
          value:"value-5",
          age:33
        }
      ]
    },
    ds:[{
      name:"name-1",
      value:"value-1",
      data:{
        name:"name-2",
        value:"value-2"
      },
      list:[
        {
          name:"name-3",
          value:"value-3"
        },
        {
          name:"name-4",
          value:"value-4",
          age:33
        },
        {
          name:"name-5",
          value:"value-5",
          age:33
        }
      ]
    },{
      name:"name-1",
      value:"value-1",
      data:{
        name:"name-2",
        value:"value-2"
      },
      list:[
        {
          name:"name-3",
          value:"value-3"
        },
        {
          name:"name-4",
          value:"value-4",
          age:33
        },
        {
          name:"name-5",
          value:"value-5",
          age:33
        }
      ]
    }]
  },
  _test:function(){
    let d=_extractData._testData.d,
        ds=_extractData._testData.ds
    
    _testData(d)
    _testData(ds)
    function _testData(d){
      console.log("Test extractData: ------------------------")
      _showData(d,"name",{name:"name-1"})
      _showData(d,"name(Name)",{"Name":"name-1"})
      _showData(d,"name()","name-1")
      _showData(d,"*().name()",["name-1","name-2","name-3","name-4","name-5"])
      _showData(d,["name","value"],{"name": "name-1","value": "value-1"})
      _showData(d,["name(Name)","value(Value)"],{"Name": "name-1","Value": "value-1"})

      _showData(d,["*.name","*.value"],{
        "name": "name-1",
        "data": {
          "name": "name-2",
          "value": "value-2"
        },
        "list": [
          {
            "name": "name-3",
            "value": "value-3"
          },
          {
            "name": "name-4",
            "value": "value-4"
          },
          {
            "name": "name-5",
            "value": "value-5"
          }
        ],
        "value": "value-1"
      })
      _showData(d,["*(obj).name","*(obj).value"],{
        "obj": {
          "name": "name-1",
          "data": {
            "name": "name-2",
            "value": "value-2"
          },
          "list": [
            {
              "name": "name-3",
              "value": "value-3"
            },
            {
              "name": "name-4",
              "value": "value-4"
            },
            {
              "name": "name-5",
              "value": "value-5"
            }
          ],
          "value": "value-1"
        }
      })
      _showData(d,["*(obj1).name","*(obj2).value"],{
        "obj1": {
          "name": "name-1",
          "data": {"name": "name-2"},
          "list": [{"name": "name-3"},{"name": "name-4"},{"name": "name-5"}]
        },
        "obj2": {
          "value": "value-1",
          "data": {"value": "value-2"},
          "list": [{"value": "value-3"},{"value": "value-4"},{"value": "value-5"}]
        }
      })
      _showData(d,{"*":["name","value"]},{
        "name": "name-1",
        "value": "value-1",
        "data": {
          "name": "name-2",
          "value": "value-2"
        },
        "list": [
          {
            "name": "name-3",
            "value": "value-3"
          },
          {
            "name": "name-4",
            "value": "value-4"
          },
          {
            "name": "name-5",
            "value": "value-5"
          }
        ]
      })
      _showData(d,{"*(obj)":["name(Name)","value(Value)"]},{
        "obj": {
          "Name": "name-1",
          "Value": "value-1",
          "data": {
            "Name": "name-2",
            "Value": "value-2"
          },
          "list": [
            {
              "Name": "name-3",
              "Value": "value-3"
            },
            {
              "Name": "name-4",
              "Value": "value-4"
            },
            {
              "Name": "name-5",
              "Value": "value-5"
            }
          ]
        }
      })
      _showData(d,{"+":["name","value"]},{
        "data": {
          "name": "name-2",
          "value": "value-2"
        },
        "list": [
          {
            "name": "name-3",
            "value": "value-3"
          },
          {
            "name": "name-4",
            "value": "value-4"
          },
          {
            "name": "name-5",
            "value": "value-5"
          }
        ]
      })
      _showData(d,{"+(obj)":["name(Name)","value(Value)"]},{
        "obj": {
          "data": {
            "Name": "name-2",
            "Value": "value-2"
          },
          "list": [
            {
              "Name": "name-3",
              "Value": "value-3"
            },
            {
              "Name": "name-4",
              "Value": "value-4"
            },
            {
              "Name": "name-5",
              "Value": "value-5"
            }
          ]
        }
      })
      // _showData(d,{"*":[{"bz-if":{"name()":"name-4"}},"name","value"]})
      // _showData(d,{"*":[{"bz-if":{"*().name()":"name-4"}},"name","value"]},{
      //   "name": "name-1",
      //   "value": "value-1",
      //   "list": [
      //     {
      //       "name": "name-4",
      //       "value": "value-4"
      //     }
      //   ]
      // })
      // _showData(d,{"*":[{"bz-if":{"*().name()":"name-4"}},"*"]},d)      
      // _showData(d,{"*(array)":[{"bz-if":{"*().name()":"name-4"}},"name(Name)","value(Value)"]},{
      //   "array": {
      //     "Name": "name-1",
      //     "Value": "value-1",
      //     "list": [
      //       {
      //         "Name": "name-4",
      //         "Value": "value-4"
      //       }
      //     ]
      //   }
      // })
      // _showData(d,{"*":[{"bz-if":{"name":"name-3"}},{"bz-if":{"*.name":"name-4"}},"name","value"]})
      // _showData(d,{"*":[{"bz-if":{name:/name-[13]+/}},"name","value"]},{
      //   "name": "name-1",
      //   "value": "value-1",
      //   "list": [
      //     {
      //       "name": "name-3",
      //       "value": "value-3"
      //     }
      //   ]
      // })
      console.log("Test checkData: ------------------------")
      _showChkResult(d,/[0-9]+/)
      _showChkResult(d,{"*.name":/name-[0-9]+/})
      _showChkResult(d,{"*":{
        name:/name-[0-9]+/,
        value:/value-[0-9]+/,
        age:/[0-9]+/
      }})
    }
    function _showChkResult(d,k){
      if(!_extractData._checkData(d,k)){
        console.error("failed: "+__(k))
      }
    }
    function _showData(d,k,t){
      let kk=_Util._clone(k)
      if(d.constructor===Array&&d!==t){
        t=t?[t,t]:[]
      }
      d=_extractData._extract(d,k)

      if(_Util._isEqualData(d,t)){
        // console.log("pass: "+__(kk))
      }else{
        console.error("failed: "+__(kk))
        console.log(d?__(d):d)
      }
    }
  },
//bz-test-code-end
  _data:_CtrlDriver._buildProxy({
    _definition:{},
    _orgData:{},
    _showResult:1,
    _type:"v"
  }),
  /**
   * 1, "name1", "name1.name2","name1.*.name", name1 in top level, name2 under object of name1
   * 2, ["name1","name2"], in any level
   * 3, {name1:["name2","name3"]}, name1 is in the any leval, name2 and name3 are under name1, but in the any level
   * 4, {name1:["name2","name3"]}, name1 is in the any leval, name2 and name3 are under name1, but in the any level
   * 4, {name1:["name2","name3"]}, name1 is in the any leval, name2 and name3 are under name1, but in the any level
   */
  _extract:function(ov,ks){
    if(!ov||!ks){
      return
    }else if(!_Util._isObjOrArray(ov)){
      if(ks.constructor==String){
        if(ks[0]=="+"){
          return
        }else if(ks[0]=="*"){
          return ov
        }
      }
      return
    }

    ov=_Util._clone(ov);

    ks=_handleKey(ks);
    ov= _takeDataByMap(ov,ks)

    return _clearEmptyData(ov)

    function _takeDataByMap(v,km,_parent){

      if(km.constructor==Function||km.constructor==RegExp){
        if(_Util._isObjOrArray(v)){
          return _filterEndData(v,km)
        }else{
          if(km.constructor==Function){
            if(km(v)){
              return v
            }
          }else if(km.constructor==RegExp){
            if(km.test(v)){
              return v
            }
          }
        }
      }
      if(!_Util._isObjOrArray(v)){
        return
      }
      if(v.constructor==Array){
        return v.map(x=>{
          return _takeDataByMap(x,km,_parent)
        })
      }
      if(km.constructor==String){
        let vv={}
        vv[km]=""
        return _takeDataByMap(v,vv,_parent)
      }

      let _data={}
      for(let k in km){
        let kv=km[k],d;
        if(km.constructor==Array){
          d=_takeDataByMap(v,kv,_parent)
        }else{
          d=_takeDataByKey(v,k,_parent,kv);
        }

        if(d){
          if(_Util._isObjOrArray(d)){
            _data=_mergeData(_data,d)
          }else if(_Util._isEmpty(_data)){
            _data=d
          }else if(_data.constructor==Array){
            _data.push(d)
          }else{
            _mergeList(_data,d,"dataList")
          }
        }
      }
      if(!_Util._isEmpty(_data)){
        return _data
      }
    }

    function _filterEndData(v,d){
      if(!v||!_Util._isObjOrArray(v)){
        if(d.constructor==Function){
          return d(v)
        }else{
          return d.test(v)
        }

      }else if(v.constructor==Array){
        v=v.filter(x=>_filterEndData(x,d))
      }else{
        for(let k in v){
          if(!_filterEndData(v[k],d)){
            delete v[k]
          }
        }
      }
      return v
    }

    function _clearEmptyData(v){
      if(!v){
      }else if(v.constructor==Array){
        v=v.map(x=>_clearEmptyData(x)).filter(x=>x!==undefined&&(!_Util._isObjOrArray(x)||!_Util._isEmpty(x)))
      }else{
        for(let k in v){
          let vv=v[k]
          if(_Util._isObjOrArray(vv)){
            vv=_clearEmptyData(vv)
            v[k]=vv
            if(vv&&_Util._isEmpty(vv)&&vv){
              delete v[k]
            }
          }else if(vv===undefined){
            delete v[k]
          }
        }
      }
      return v
    }

    function _takeDataByKey(v,k,_parent,_subKeys){
      k=_parseKey(k)
      if(k._key=="*"||k._key=="+"){
        if(k._key=="+"){
          v= _skipRootData(v)
        }
        if(_subKeys){
          v =_takeDataByMap(v,_subKeys,k)
        }
        if(!_Util._isEmpty(v)){
          if(!k._name){
            return _pickEndData(v,_subKeys)
          }else if(k._name=="*"){
            if(_parent&&!_parent._name&&(_parent._key=="*"||_parent._key=="+")){
              return _pickEndData(v,1)
            }else{
              return v
            }
          }else{
            return _newValue(v,k._name)
          }
        }
      }else if(_parent&&(_parent._key=="*"||_parent._key=="+")){
        return _filterDataByKey(v,k,_subKeys)
      }else{
        v=v[k._key]
        if(v){
          let v1={}
          v1[k._key]=v
          return _filterDataByKey(v1,k,_subKeys)
        }
      }
    }

    function _filterDataByKey(v,k,_subKeys){
      let d={}
      if(v.constructor==Array){
        d=v.map(x=>_filterDataByKey(x,k,_subKeys))
      }else{
        for(let kk in v){
          let kv=v[kk]
          if(kk==k._key){
            if(kv!==undefined){
              if(_subKeys){
                kv=_takeDataByMap(kv,_subKeys,k)
              }else{
                delete v[kk]
              }
              if(kv!==undefined){
                if(k._name){
                  d[k._name]=kv
                }else if(_Util._isEmpty(d)){
                  d=kv
                }else if(d.constructor!=Array){
                  if(kv&&kv.constructor==Array){
                    d=[d,...kv]
                  }else{
                    d=[d,kv]
                  }
                }else{
                  if(kv&&kv.constructor==Array){
                    d.push(...kv)
                  }else{
                    d.push(kv)
                  }
                }
              }
            }
          }else if(_Util._isObjOrArray(kv)&&!_Util._isEmpty(kv)){
            kv=_filterDataByKey(kv,k,_subKeys)
            if(kv){
              if(k._name){
                d[kk]=kv
              }else if(_Util._isEmpty(d)){
                d=kv
              }else if(d.constructor!=Array){
                if(kv&&kv.constructor==Array){
                  d=[d,...kv]
                }else{
                  d=[d,kv]
                }
              }else{
                if(kv&&kv.constructor==Array){
                  d.push(...kv)
                }else{
                  d.push(kv)
                }
              }
            }
          }
        }
      }
      if(!_Util._isEmpty(d)){
        return d
      }
    }

    function _pickEndData(vv,_keepLabel,_data,_listKey){
      if(!_Util._isObjOrArray(vv)){
        return vv
      }
      if(_keepLabel){
        _data=_data||{}
        if(vv.constructor==Array){
          let nv=[]
          vv.forEach(x=>{
            if(x&&x.constructor==Object){
              _pickEndData(x,1,_data)
            }else{
              nv.push(x)
            }
          })
          if(nv.length){
            if(_Util._isEmpty(_data)){
              if(_listKey){
                _data[_listKey]=nv
              }else{
                _data=nv
              }
            }else{
              if(!_listKey){
                _listKey="dataList"
              }
              _mergeList(_data,nv,_listKey)
            }
          }
          return _data
        }
      }else{
        _data=_data||[]
      }
      for(let kk in vv){
        let v=vv[kk]
        if(_Util._isObjOrArray(v)){
          _data=_pickEndData(v,_keepLabel,_data,kk)
        }else{
          if(!_keepLabel){
            _data.push(v)
          }else{
            _mergeList(_data,v,kk)
          }
        }
        delete vv[kk]
      }
      return _data
    }

    function _mergeList(d,v,k){
      if(d[k]===undefined){
        d[k]=v
      }else{
        if(d[k]===undefined){
          d[k]=[]
        }else if(d[k].constructor!=Array){
          d[k]=[d[k]]
        }
        if(v&&v.constructor==Array){
          d.push(...v)
        }else{
          d[k].push(v)
        }
      }
    }
    function _newValue(v,n){
      let d={}
      d[n]=_cloneObj(v)
      return d
    }
    function _cloneObj(v){
      if(_Util._isObjOrArray(v)){
        let d=v.constructor==Array?[]:{}
        for(let k in v){
          d[k]=v[k]
          delete v[k]
        }
        v=d
      }
      return v
    }

    function _skipRootData(v){
      let d={}
      for(let k in v){
        let vv=v[k]
        if(_Util._isObjOrArray(vv)){
          d[k]=vv
        }
      }
      return d
    }

    function _mergeData(d,v){
      if(_Util._isEmpty(d)){
        return v
      }
      for(let k in v){
        let dv=d[k],vv=v[k]
        if(vv===undefined||dv===vv){
          continue
        }else if(dv===undefined){
          d[k]=v[k]
        }else if(_Util._isObjOrArray(vv)&&dv.constructor==vv.constructor){
          for(let kk in vv){
            if(vv[kk]===undefined){
            }else if(dv[kk]===undefined){
              dv[kk]=vv[kk]
            }else if(dv[kk]!=vv[kk]){
              _mergeData(dv[kk],vv[kk])
            }
          }
        }
      }
      return d
    }

    function _parseKey(k){
      let kk=k.split("(")
      if(kk.length>1){
        let k1=kk[1].replace(")","").split(",")
        kk={
          _key:kk[0],
          _name:kk[0]=="+"?"*":kk[0],
          _org:k
        }
        if(k1.length){
          k1.forEach(n=>{
            if(n=="-"){
              kk._minus=1
            }else if(n=="1"||n=="-1"){
              kk._idx=parseInt(n)
            }else{
              kk._name=n
            }
          })
        }else{
          kk._name=""
        }
      }else{
        kk={
          _key:k,
          _name:k=="+"?"*":k,
          _org:k
        }
      }
      return kk
    }

    function _handleStringKey(k,d){
      let v=d[k]
      if(k.indexOf(",")==-1){
        if(k.indexOf(".")>0){
          delete d[k]
          k=k.split(".").map(x=>x.trim())
          let ok=d;
          k.forEach((kk,i)=>{
            if(i<k.length-1){
              if(!ok[kk]){
                ok[kk]={}
              }else if(ok[kk].constructor==String){
                let vv=ok[kk]
                ok[kk]={}
                ok[kk][vv]=""
              }
              ok=ok[kk]
            }else{
              ok[kk]=v
            }
          })
        }
      }else{
        k=k.split(",").map(x=>x.trim())
        k.forEach((kk,i)=>{
          d[kk]=v
          _handleStringKey(kk,d)
        })
      }
      return d
    }
    function _handleKey(k){
      if(k.constructor==Array){
        return k.map(x=>_handleKey(x))
      }else if(k.constructor==Object){
        for(let kk in k){
          k[kk]=_handleKey(k[kk])
          _handleStringKey(kk,k)
        }
        return k
      }else if(k.constructor==Function||k.constructor==RegExp){
        return k
      }else if(k.constructor==String){
        let kk=_Util._toRegExp(k)
        if(kk){
          return kk
        }
        return k.match(/[,.]/)?_handleStringKey(k,{}):k;
      }
    }
  
  },
  _checkData:function(v,d){
    v=v||""
    d=d||""
    if(d.constructor==String&&(_Util._isJsonValueString(d)||_Util._hasCode(d))){
      eval("d="+d)
    }
    if(v.constructor==String&&_Util._isJsonValueString(v)||_Util._hasCode(v)){
      eval("v="+v)
    }

    if(!d||d.constructor!=Object){
      return _extractData._chkValue(v,d)
    }
    d=_Util._toOneLevelJson(d)
    return !d.find(x=>{
      for(let k in x){
        let f=x[k]
        let vv=_extractData._extract(v,k)
        return !_extractData._chkValue(vv,f)
      }
    })
  },
  _chkValue:function(v,d,fs){
    let r;
    if(!d){
    }else if(v&&v.constructor==Array){
      if(fs){
        v.forEach((x,i)=>{
          if(!_extractData._chkValue(x,d,fs)&&!_Util._isObjOrArray(x)){
            v[i]="❌"+x
          }
        })
        return fs.length==0
      }else{
        r= !v.find(x=>!_extractData._chkValue(x,d))
      }
    }else if(v&&v.constructor==Object){
      for(let k in v){
        if(!_extractData._chkValue(v[k],d,fs)){
          if(!fs){
            return 
          }else if(!_Util._isObjOrArray(v[k])){
            v[k]="❌"+v[k]
          }
        }
      }
      return !fs||fs.length==0
    }else if(d.constructor==RegExp||_ideDataManagement._isRegexData(d)){
      v+=""
      r= _Util._toRegExp(d).test(v)
    }else if(d.constructor==Function){
      r= d(v)
    }
    if(r===undefined){
      r= v==d
    }
    if(!r){
      if(fs){
        fs.push(1)
      }else{
        console.log("BZ-LOG: Check data fail: "+v+", "+d)
      }
    }
    return r
  },
  _saveData:function(v,d){
    _DataBuilder._saveData(v,d)
  },
  _stringToData:function(v){
    if(v.constructor==String){
      if(_Util._isJsonValueString(v)||_Util._hasCode(v)||_Util._isFunction(v)){
        eval("v="+v)
      }else if(_Util._isXMLData(v)){
        v=$util.xmlToJson(v)
      }
    }
    return v
  },
  _getChkData:function(v,d){
    if(!d||!v){
      return ""
    }
    let r={}
    if(d.constructor==String&&(_Util._isJsonValueString(d)||_Util._hasCode(d)||_Util._isFunction(d))){
      eval("d="+d)
    }
    v=_extractData._stringToData(v)
    if(!_Util._isObjOrArray(d)){
      let fs=[]
      _chkObj(v,d,"",fs)
    }else{
      d=_Util._toOneLevelJson(d)
      d.forEach(x=>{
        for(let k in x){
          let f=x[k],fs=[]
          let vv=_extractData._extract(v,k)
          _chkObj(vv,f,k,fs)
        }
      })
    }
    return r

    function _chkObj(vv,dv,p,fs){
      let rr;
      if(!vv){
        rr=vv==dv?"✔️":"❌"
      }else if(_Util._isEmpty(vv)&&!dv){
        rr="❌"
      }else{
        _extractData._chkValue(vv,dv,fs)
        rr=fs.length?"❌":"✔️";
      }
      r[rr+p+":"+dv]=vv
    }
  },
  _findDataInScript:function(){
    let a=_IDE._data._curAction,ds

    if(a){
      ds=_findTagCode(a)
    }
    if(!ds){
      _IDE._data._curTest._data.actions.find(a=>{
        ds=_findTagCode(a)
        return ds
      })
    }
    return ds


    function _findTagCode(aa){
      let a=[aa.script,...(aa.requests||[]).map(x=>x.responseScript)]
      let r;
      a.find(x=>{
        if(x){
          if(x&&x.includes("$util.validateData")){
            x=x.split("$util.validateData")[1].trim()
            if(x[0]=="("){
              x=_CtrlDriver._findKeyOuterBlock(x.substring(1),")")
              let a=_CtrlDriver._findKeyOuterBlock(x.p,",")
              if(a.p){
                a.p=a.p.trim()
                if(a.p.match(/\$(test|module|project|parameter|loop|result)/)){
                  r={}
                  r.v=a.p
                }
                a.e=(a.e||"").trim()
                if(a.e.match(/\$(test|module|project|parameter|loop|result)/)){
                  r=r||{}
                  r.d=a.e
                }
                if(!r||!r.v||!r.d){
                  aa=_debugDataHandler._retrieveBindDataFromAction(aa)
                  aa=aa.filter(x=>!r||(x!=r.v&&x!=r.d))
                  if(aa.length){
                    try{
                      aa.sort((a,b)=>JSON.stringify(_Util._getSysObj(b)).length-JSON.stringify(_Util._getSysObj(a)).length)
                    }catch(ex){}
                    r=r||{}
                    r.v=r.v||aa.shift()
                    r.d=r.d||aa[0]
                  }
                }
                return r
              }
            }
          }
        }
      })
      return r
    }

    function _findInScript(s){
      return 
    }
  },
  _showResult:function(){
    _CtrlDriver._refreshData(_extractData._data,"_showResult")
  },
  _showTools:function(v,d){

    let ds=_extractData._findDataInScript()||[];

    if(!v){
      if(ds.v){
        _extractData._data._orgData._key=ds.v
        v=_Util._getSysObj(ds.v)
      }
    }
    if(v&&v.constructor==String&&(_Util._isJsonValueString(v)||_Util._hasCode(v))){
      try{
        eval("v="+v)
        if(v.constructor!=String){
          v=__(v)
        }
      }catch(ex){}
    }

    if(!d){
      if(ds.d){
        _extractData._data._definition._key=ds.d
        d=_Util._getSysObj(ds.d)
      }
    }
    if(d && d.constructor==String&&(_Util._isJsonValueString(d)||_Util._hasCode(d))){
      try{
        eval("d="+d)
        if(d.constructor!=String){
          d=__(d)
        }
      }catch(ex){}
    }
    _extractData._data._definition._value=d
    _extractData._data._orgData._value=v
    let _viewDev={
      _tag:"div",
      _attr:{
        class:"bz-extract-box"
      },
      _items:[
        //body
        {
          _tag:"div",
          _attr:{
            class:"bz-extract-body"
          },
          _items:[
            //definition
            {
              _tag:"div",
              _attr:{
                class:"bz-extract-column"
              },
              _after:function(o){
                setTimeout(()=>{
                  $(o).find("pre").focus();
                })
              },
              _items:[
                {
                  _tag:"div",
                  _attr:{
                    class:"bz-extract-column-title"
                  },
                  _items:[
                    _getDataList("_definition")
                  ]
                },
                {
                  _tag:"div",
                  _attr:{
                    class:"bz-extract-column-content"
                  },
                  _items:[
                    _bzJSEditor._buildJSEditor({
                      _model:"_extractData._data._definition._value",
                      _noBtn:1,
                      _label:"",
                      _noUpdate:1,
                      _disabled:0
                    })
                  ]
                }
              ]
            },
            //org-data
            {
              _tag:"div",
              _attr:{
                class:"bz-extract-column",
                style:"border-left:var(--bz-border);border-right:var(--bz-border);"
              },
              _items:[
                {
                  _tag:"div",
                  _attr:{
                    class:"bz-extract-column-title"
                  },
                  _items:[
                    _getDataList("_orgData")
                  ]
                },
                {
                  _tag:"div",
                  _attr:{
                    class:"bz-extract-column-content"
                  },
                  _items:[
                    _bzJSEditor._buildJSEditor({
                      _model:"_extractData._data._orgData._value",
                      _noBtn:1,
                      _label:"",
                      _noUpdate:1,
                      _disabled:0
                    })
                  ]
                }
              ]
            },
            //result-data
            {
              _tag:"div",
              _attr:{
                class:"bz-extract-column"
              },
              _items:[
                {
                  _tag:"div",
                  _attr:{
                    class:"bz-extract-column-title"
                  },
                  _items:[
                    {
                      _tag:"div",
                      _attr:{
                        class:"input-group"
                      },
                      _items:[
                        {
                          _tag:"select",
                          _attr:{
                            class:"form-control"
                          },
                          _items:[
                            {
                              _tag:"option",
                              _text:"_bzMessage._common._select"
                            },
                            {
                              _tag:"option",
                              _attr:{
                                value:"_data._key"
                              },
                              _text:"_data._item",
                              _dataRepeat:"_bzMessage._extractData._result"
                            }
                          ],
                          _dataModel:"_extractData._data._type",
                          _jqext:{
                            change:function(){
                              setTimeout(()=>{
                                _extractData._showResult()
                              },10)
                            }
                          }
                        },
                        {
                          _tag:"div",
                          _attr:{
                            class:"input-group-btn"
                          },
                          _items:[
                            {
                              _tag:"button",
                              _attr:{
                                class:"btn btn-icon bz-refresh bz-left-space-5"
                              },
                              _jqext:{
                                click:function(){
                                  _extractData._showResult()
                                }
                              }
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  _if:"_extractData._data._showResult",
                  _tag:"div",
                  _attr:{
                    class:"bz-extract-column-content"
                  },
                  _items:function(){
                    let d=_extractData._data._definition._value,
                        v=_extractData._data._orgData._value;
                    if(!d){
                      d=_extractData._data._definition._key
                      if(!d){
                        return
                      }
                      d=_DataBuilder._getOrgDataByPath(d)
                      _extractData._data._definition._value=d
                    }

                    if(!v){
                      v=_extractData._data._orgData._key
                      if(!v){
                        return
                      }
                      v=_DataBuilder._getOrgDataByPath(v)
                      _extractData._data._orgData._value=v
                    }

                    d=_Util._clone(_extractData._stringToData(d))
                    v=_Util._clone(_extractData._stringToData(v))

                    if(_extractData._data._type=="v"){
                      d=_extractData._getChkData(v,d)
                    }else{
                      d=_extractData._extract(v,d)
                      v={}
                      v[_bzMessage._extractData._extractData]=d
                      d=v
                    }
                    d=_CtrlDriver._buildProxy(d)
                    return [_jsonViewor._viewDev(d,[d[_bzMessage._extractData._extractData]])]
                  }
                }
              ]
            }
          ]
        }
      ]
    }
    if(!_extractData._popWin||_extractData._popWin.closed){
      _extractData._popWin=_Util._popWin("","_bzExtractData",0,Math.max(screen.availWidth*0.8,800),Math.max(screen.availHeight*0.8,800),_viewDev,_bzMessage._extractData._title)
    }else{
      _extractData._popWin.focus()
    }

    function _getDataList(k){
      return {
        _tag:"div",
        _attr:{
          class:"input-group"
        },
        _items:[
          {
            _tag:"label",
            _attr:{
              class:"input-group-addon"
            },
            _text:"_bzMessage._extractData."+k
          },
          {
            _tag:"select",
            _attr:{
              class:"form-control"
            },
            _items:[
              {
                _tag:"option",
                _text:"_bzMessage._common._select"
              },
              {
                _tag:"option",
                _attr:{
                  value:"_data._item"
                },
                _text:"_data._item",
                _dataRepeat:function(){
                  let vs=[];
                  (["$loop","$result","$parameter","$test","$module","$project"]).forEach(x=>{
                    try{
                      let v=eval(x)
                      for(let k in v){
                        if(k=="_tmpIdx"){
                          continue;
                        }
                        if(!_Util._isEmpty(v[k])&&v[k].constructor!=Function){
                          vs.push(x+"."+k)
                        }
                      }
                    }catch(ex){}
                  })
                  return vs
                }
              }
            ],
            _jqext:{
              change:function(){
                let v=_extractData._stringToData(_DataBuilder._getOrgDataByPath(this.value))
                _extractData._data[k]._value=v
                _extractData._showResult()
              }
            },
            _dataModel:"_extractData._data."+k+"._key"
          },
          {
            _tag:"div",
            _attr:{
              class:"input-group-btn"
            },
            _items:[
              {
                _tag:"button",
                _attr:{
                  class:"btn btn-icon bz-save bz-left-space-5",
                  disabled:function(){
                    let d=_extractData._data[k]._key
                    return !d||!d.match(/\$(test|module|project)/)
                  }
                },
                _jqext:{
                  click:function(){
                    let d=_extractData._data[k]
                    if(d._key.match(/^\$(test|module|project)/)){
                      _extractData._saveData(d._value,d._key)
                    }
                  }
                }
              }
            ]
          }
        ]
      }
    }
  }
}
/** */;var _infoManagement={
  _data:_CtrlDriver._buildProxy({
    _map:{},
    _read:{},
    _curData:{},
    _popData:[],
    _showPop:true,
    _lastMsgTime:0,
    _sentMsg:[],
    _sentIdx:0
  }),
  _hidePop:function(item){
    $(item).fadeOut();
  },
  _new:function(_user,_timeStamp,_msg,_timer){
    return {
      user:_user,
      timeStamp:_timeStamp,
      msg:_msg,
      _timer
    };
  },
  _getUnRead:function(t){
    var s=r=0;
    for(var k in this._data._map){
      if(k==t || !t){
        s+=this._data._map[k].length;
        r+=this._data._read[k];
      }
    }
    return s-r;
  },
  _add:function(_info){
    if(_info.body){
      _info=_info.body;
      _userManagement._findItem(_info.user,function(data){
        if(_info.msg.startsWith("*|")){
          var _msg=_info.msg.split("|");
          return alert(_msg[1].replace(/\\n/g,"\n"));
        }
        
        var m=_infoManagement._new({displayName:data.displayName,_id:_info.user},_info.timeStamp,_info.msg);
        m.to=_info.to;
        _infoManagement._add(m);
      });
      return;
    }
    var t=_info.to||curProjectData._id;
    if(t==curUser._id){
      t=_info.user._id;
    }
    var m=this._data._map[t]=this._data._map[t]||[];
    this._data._read[t]=this._data._read[t]||0;
    m.push(_info);
    if(_info.user.sys){
      this._data._read[t]++;
    }
    if(m.length>500){//TODO: buffer
      m.pop();
    }
    if(_info.user._id!=curUser._id){
      this._data._popData.push(_info);
    }
    _infoManagement._clear()
  },
  _clear:function(){
    setTimeout(function(){
      var os=_infoManagement._data._popData
      for(var i=0;i<os.length;i++){
        var o=os[i]
        var t=o._timer||2000;
        if(Date.now()-o.timeStamp>=t){
          _infoManagement._data._popData.splice(i--,1)
        }
      }
      if(os.length){
        _infoManagement._clear()
      }
    },2000);
  },
  _addBZInfo:function(msg, _userId, o,_alert,_timer){
    _userManagement._findItem(_userId,function(data){
      var _infoMsg=_Util._formatMessage(msg,[data.displayName,o]);
      var _info=_infoManagement._new({sys:1,displayName:"Boozang"},Date.now(),_infoMsg,_timer);
      if(_alert){
        alert(_infoMsg)
      }else{
        _infoManagement._add(_info);
      }
    });
  },
  _post:function(_tab){
    var d=this._data;
    if(!d._curData.msg){
      return;
    }
    d._curData.timeStamp=Date.now();
    d._curData.user=curUser._id;
    d._curData.to=_tab==curProjectData._id?'':_tab;
    _requestHandler._callService({
      _data:{
        method:"POST",
        url:"/api/info/",
        data:d._curData,
        callback:"_infoManagement._add"
      }
    });
    $(".postMsg").focus();
    var _msg=d._curData.msg;
    var _idx=d._sentMsg.indexOf(_msg);
    if(_idx>=0){
      d._sentMsg.splice(_idx,1);
    }
    d._sentMsg.unshift(_msg);
    if(d._sentMsg.length>100){
      d._sentMsg.pop()
    }
    d._sentIdx=0;
    d._curData.msg="";
    setTimeout(function(){
      $(".info-input").focus();
    },100);
  },
  _login:function(d){
    _userManagement._findItem(d.user,function(data){
      var _infoMsg=_Util._formatMessage(_bzMessage._log._info._login,[data.displayName]);
      var _info=_infoManagement._new({sys:1,displayName:"Boozang"},Date.now(),_infoMsg);
      _infoManagement._add(_info);
      if(_userManagement._data._onlineUsers && data._id!=curUser._id){
        _userManagement._data._onlineUsers.push(data);
      }
    });
  },
  _logout:function(d){
    _userManagement._findItem(d.user,function(data){
      var _infoMsg=_Util._formatMessage(_bzMessage._log._info._logout,[data.displayName]);
      var _info=_infoManagement._new({sys:1,displayName:"Boozang"},Date.now(),_infoMsg);
      _infoManagement._add(_info);
      for(var i =0;i<_userManagement._data._onlineUsers.length;i++){
        var u=_userManagement._data._onlineUsers[i];
        if(u._id==data._id){
          _userManagement._data._onlineUsers.splice(i,1)
        }
      }
    });
  },
  _showImportantInfo:function(_text,_type,_extra,_main,_timer){
    if(bzTwComm._isIDE()){
      // if(!curUser._curProject.setting.infoRunningTest){
        // return
      // }
      window._extensionComm._setInfo(_text,_type,_extra);
      if(!_main){
        return;
      }
    }else if(bzTwComm._isExtension()){
      if(window.frameId){
        return
      }
      if(BZ._data._dock&&parent.parent!=parent){
        return
      }else if(!BZ._data._dock&&parent!=window){
        return;
      }
    }
    var w=_main?window:this._getMainWin();
    if(w){
      if(!w.document.body){
        return setTimeout(function(){
          _infoManagement._showImportantInfo(_text,_type,_extra,_main)
        },500);
      }
      $(w.document.body.parentNode).find(".bz-importantInfo-bk").remove();
      //_console("remove info")
    }
//    _infoManagement._removeImportantInfo(_main)
    //For remove only
    if(!_text){
      return;
    }
    _type=_type||"";
    _text=_bzMessage._importantInfo[_text]||_text;
    var wl=_text.length;

    if(_extra){
      wl="width:550px !important;"
    }else if(wl<20){
      wl="width:300px !important;"
    }else{
      wl="width:650px !important;"
    }
    _extra=_extra?"<div class='extra'>"+_extra+"</div>":"";
    var _html ="<div class='bz-importantInfo-bk' onmouseover='this.remove()'>"
              +"<pre class='bz-importantInfo "+_type+"' style='"+wl+"'>"
              +"<a class='bz-close-white bz-small-icon bz-small-btn' style='border:0;float:right;margin:-15px -15px;'></a>"
              +"<div style='font-size:16px' class='bz-main-info'>"+_text+"</div>"
              +_extra
              +"</pre>"
              +"</div>"
    
    var o=document.createElement("div");
    o.innerHTML=_html;
    o=o.children[0];
    try{
      var w=_main?window:this._getMainWin();
      if(w){
        w.document.body.parentNode.append(o);
      }
    }catch(e){}
    setTimeout(function(){
      o.remove()
    },_timer||10000)
  },
  _getMainWin:function(){
    if(BZ.TW && !BZ.TW.closed && !window.inPlugIn){
      return BZ.TW
    }
  },
  _removeImportantInfo:function(_main){
    this._showImportantInfo()
  }
};var _JSHandler={
  _parseCode:function(c,_type,_alert,_trimCode,_returnSynErr){
    if(!c || c.constructor!==String){
      return c;
    }
    let _exRight,_chker=/^([\/]\{.+)\}[\/]$/;
    if(c.match(_chker)){
      _exRight="}/"
      c=c.replace(_chker,"$1")
    }
    var _list=[];
    //has insert JS
    if(!_type){
      var _idx1=c.indexOf("{{");
      var _idx2=c.lastIndexOf("}}");
      if(_idx1>=0 && _idx1<_idx2){
        _list.push({txt:c.substring(0,_idx1)});
        var _code=c.substring(_idx1+2,_idx2);
        var _tmpList=_JSHandler._parseCode(_code,1);
        if(_tmpList && _tmpList.constructor==Array){
          _list=_list.concat(_tmpList)
        }else{
          _list.push({code:_tmpList});
        }
        _list.push({txt:c.substring(_idx2+2)});
      }else{
        if(_exRight){
          c+=_exRight
        }
        return c;
      }
    }else{
      var _idx1=c.lastIndexOf("{{");
      var _idx2=c.indexOf("}}");
      if(_idx1<0 && _idx2<0){
        return [{code:c}]
      }else if(_idx1>0 && _idx1>_idx2){
        _list.push({code:c.substring(0,_idx2)});
        var _code=c.substring(_idx2+2,_idx1);
        var _tmpList=_JSHandler._parseCode(_code);
        if(_tmpList && _tmpList.constructor==Array){
          _list=_list.concat(_tmpList)
        }else{
          _list.push({txt:_tmpList});
        }
        _list.push({code:c.substring(_idx1+2)});
      }
    }
    for(var i=0;i<_list.length;i++){
      var v=_list[i];
      var _errMsg="";
      if(!v.txt && !v.code){
        _list.splice(i,1);
        i--;
      }else if(v.code){
        if(_trimCode){
          v.code=v.code.trim()
        }
        if(_returnSynErr || _alert){
          _list._hasErr=_list._hasErr||!this._chkSyntaxError(v.code,_alert)
        }
        if(!_returnSynErr){
          delete _list._hasErr
        }
      }
    }
    if(_exRight){
      let o=_list[_list.length-1]
      if(o.txt){
        o.txt+=_exRight
      }else{
        _list.push({txt:_exRight})
      }
    }
    return _list;
  },
  _chkSyntaxError:function(c,_alert){
    try{
      _Util._eval(c);
    }catch(e){
      if(e.message && (e.message.includes("SyntaxError") || e.stack.startsWith("SyntaxError"))){
        if(_alert){
          e.message+=" \ncode: "+c;
          _Util._alertMessage(e);
        }
        return 0;
      }
    }
    return true;
  },
  //_noSkip: 1, use undefined, 2: use empty space
  _exeCodeList:function(_list,_parseOnly,_noSkip,_parameter){
    let $parameter=_parameter===undefined?window.$parameter:_parameter;
    if(!_list || _list.constructor==String || _list.constructor==Number){
      return _list;
    }
    var s="";
    for(var i=0;i<_list.length;i++){
      var c=_list[i];
      if(c.txt){
        if(_list[i-1] && _list[i-1].code && _parseOnly){
          s+="}}";
        }
        c.txt=c.txt.replace(/\\{/g,"{").replace(/\\}/g,"}");
        s+=c.txt;
      }else if(c.code){
        var v=c.code;
        var w=v;
        if(!_parseOnly){
          let vv=v;
          try{
            v=_Util._eval(v)
          }catch(ex){
            v=undefined
            console.log("BZ-LOG:"+ex.message+"\n"+vv)
          }
          if(v===undefined){
            if(!_noSkip){
              v="bz-skip"
            }else if(_noSkip==2){
              v=""
            }
          }
        }else if(!_list[i-1] || _list[i-1].txt){
          s+="{{";
        }
        if(v && (v.constructor==Object || v.constructor==Array)){
          if(_parseOnly){
            s+=JSON.stringify(v);
          }else{
            s=v
          }
        }else if(!s && v && v.constructor==Function){
          if(v==_ideDataHandler._loadingFlag){
            s=_ideDataHandler._getOrgDataSettingFromNamePath(w)
            if(s){
              s=s.url
            }
          }else{
            s=v
          }
        }else if(s){
          s+=v;
        }else{
          s=v
        }
      }
    }
    if(_parseOnly && _list[i-1] && _list[i-1].code){
      s+="}}"
    }
    return s;
  },
  //_noSkip: 1, use undefined, 2: use empty space
  _prepareData:function(_code,_parseOnly,_noSkip,_parameter){    
    try{
      if(window.$parameter&&$parameter.constructor==String&&$parameter.match(/\$test|\$module|\$project|\$loop/)){
        try{
          $parameter=_Util._eval($parameter)
        }catch(e){
          
        }
      }
      if(_code && _code.constructor==Array){
        return _code.map(c=>{
          return _JSHandler._prepareData(c,_parseOnly,_noSkip)
        })
      }else{
        _code=_JSHandler._parseCode(_code,0)
      }
      if(_code && _code.constructor==Array && _code[0] && _code[0].constructor!=Object){
        var vs=[];
        for(var i=1;i<_code.length;i++){
          vs.push(_JSHandler._exeCodeList(_code[i],_parseOnly,_noSkip,_parameter));
        }
        vs.unshift(_code[0])
        return vs;
      }else if(_code&&[String,Object,Array].includes(_code.constructor)){
        var v= _JSHandler._exeCodeList(_code,_parseOnly,_noSkip,_parameter);
        return v
      }
    }catch(e){
    }
    return _code
  },
  //_start: only for beginning of //
  _cleanCode:function(v,_start){
    var t1=Date.now();
    
    var i1=v.indexOf("/"+"*"),i2=v.includes("*"+"/"),i3=v.includes("/"+"/");
    var p,w=v,c1,b,cs,cm,l;
    if((i1>=0 && i1<i2 ) || i3>=0){
      
      w=l="";
      for(var i=0;i<v.length;i++){
        var c=v[i];

        if(cs){//single line comment
          if(c=="\n"){
            cs=0;
          }
          continue;
        }else if(cm){ //mutiple line comment
          if(c=="/" && v[i-1]=="*"){
            cm=0;
          }
          continue;
        }else if(c=="\n"){
          _addResult(l);
          continue;
        }else if("\"'".includes(c) && !b){
          if(!p){
            p=c
          }else if(p==c){
            p=0
          }
        }else if(c=="\\"){
          b=!b
        }else if(!p && c=="/" && !b){
          if(c1){
            _addResult(l=l.substring(0,l.length-1));
            cs=1; //start single line comment
            continue;
          }else if(!_start || l.trim()=="/"){
            c1=c;
          }
        }else if(c=="*" && c1){
          cm=1;
          cs=0;
          _addResult(l=l.substring(0,l.length-1));
          continue;
        }else if(c1){
          c1="";
        }
        l+=c;
        if(c!="\\"){
          b=0;
        }
        if(c!="/"){
          c1="";
        }
      }
      _addResult(l);
    }
    return w//.trim();
    function _addResult(){
      var ll=l.trim(),ww=w.trimRight();
      
      if(ll){
        if(ll[0]=="." || ww.endsWith(".")){
          w=ww+ll
        }else{
          w+="\n"+l;
        }
        l=""
      }
    }
  },
  _formatInsertCodeToDisplay:function(d){
    if(!d){
      return d||"";
    }
    d=this._parseCode(d);
    if(d.constructor!=Array){
      return d;
    }
    var w="",v;
    
    for(var i=0;i<d.length;i++){
      v=d[i]
      if(v.code){
        w+="{{"+v.code+"}}"
      }else{
        w+=v.txt
      }
    }
    return w;
  },
  _formatInsertCodeToData:function(d){
    d=this._parseCode(d);
    if(d.constructor==String){
      return d;
    }
    var w="",v
    for(var i=0;i<d.length;i++){
      v=d[i]
      if(v.code){
        w+="{{"+v.code+"}}"
      }else{
        w+=v.txt
      }
    }
    return w;
  }
};var _localStorageManagement={
  _preKey:"bz-data3/",
  _getKey:function(v,m,t,k){
    if(t){
      t=_IDE._getShortcutTestCode(t==1?0:t)
      if(!t){
        return ""
      }
    }
    
    if(m){
      m=_IDE._getShortcutModuleCode(m==1?0:m)
      if(!m){
        return ""
      }
    }
    if(v==1){
      v=_IDE._data._curVersion.code
    }
    let kk=_localStorageManagement._preKey+pId+"/"
    if(v){
      kk+=v+"/"
    }
    if(m){
      kk+=m+"/"
    }
    if(t){
      kk+=t+"/"
    }
    if(k){
      kk+=k+"/"
    }
    return kk
  },
  _encrypt:function(a,bEncrypt){
    return a;
    /*
    if(!a||_Util._checkBrowserType().name.includes("Edge")){
      return a;
    }
    var b=md5Value;
    var c=""
    var ii=0;
    for(var i=0;i<a.length;i++){
      var v1=a[i].charCodeAt();
      var v2=0;
      if(!b[ii]){
        ii=0;
      }
      v2=b[ii].charCodeAt();
      if(bEncrypt){
        c+=String.fromCharCode((v1 ^ v2)+10);
      }else{
        v1-=10;
        c+=String.fromCharCode(v1 ^ v2);
      }
      ii++;
    }
    return c;
    */
  },
  _decrypt:function(a){
    return this._encrypt(a,false);
  },
  _parseData:function(_noClean){
    if(!this._storeData){
      let _data={},
          hk=/\/t[0-9]+\/(bz-history|bz-debug)[\/]/,
          pk=_localStorageManagement._getKey();
      try{
        for(var n=0;n<localStorage.length;n++){
          var k=localStorage.key(n);
          if(k.startsWith(pk)&&!k.match(hk)){
            var d=k.split("/");
            if(k.endsWith("/")){
              d.splice(d.length-1);
            }
            var _tmp=_data;
            for(var i=1;i<d.length-1;i++){
              if(i<=d.length-1 && !_tmp[d[i]]){
                _tmp[d[i]]={}
              }
              _tmp=_tmp[d[i]];
            }
            if(!_tmp[d[i]]){
              _tmp[d[i]]=JSON.parse(this._decrypt(_compressData._unCompress(localStorage.getItem(k))));
            }else{
              Object.assign(_tmp[d[i]],JSON.parse(this._decrypt(_compressData._unCompress(localStorage.getItem(k)))))
            }
          }
        }
      }catch(e){
        if(!_noClean){
          _localStorageManagement._cleanAll()
        }
      }
      this._storeData=_data;
    }
    return this._storeData;
  },
  _getCurProjectData:function(bCreate){
    if(!_IDE._data._curVersion){
      return;
    }
    var _data=this._parseData();
    if(!_data[BZ._data._curProject._id]){
      if(bCreate){
        _data[BZ._data._curProject._id]={};
      }else{
        return null;
      }
    }
    _data=_data[BZ._data._curProject._id];
    if(!_data[_IDE._data._curVersion.code]){
      if(bCreate){
        _data[_IDE._data._curVersion.code]={};
      }else{
        return null;
      }
    }
    _data=_data[_IDE._data._curVersion.code];
    return _data;
  },
  _remove:function(_path){
    var _data=this._getCurProjectData();
    var i=0,ps=_localStorageManagement._getKey(1);
    for(i=0;i<_path.length-1;i++){
      ps+=_path[i]+"/";
      _data=_data[_path[i]];
      if(!_data){
        return;
      }
    }
    delete _data[_path[i]];
    ps+=_path[i]+"/";
    _localStorageManagement._removeData(ps);
    _localStorageManagement._cleanTask(ps,[],0)
  },
  _update:function(_path,_value,_md5){
    if(_path=="bz-habit"){
      this._store(_path,_value);
      this._parseData(1)[_path]=_value;
    }else{
      let _test=_ideObjHandler._getDataByPath(_path[0],_path[1])
      if(_test&&_test._data.code[0]=="t"){
        if(_aiGeneratorDataHandler._isAIGenerateTest(_test)){
          return _md5
        }
      }
      var _data=this._getCurProjectData(true);
      var i=0,ps="";
      for(i=0;i<_path.length-1;i++){
        if(!_data[_path[i]]){
          _data[_path[i]]={};
        }
        ps+=_path[i]+"/";
        _data=_data[_path[i]];
      }
      ps+=_path[i]+"/";
      if(_value){
        if(_value.doc&&_value.doc.content&&_value.doc.content.constructor==String&&_value.doc.content.startsWith("BZ-")){
          _value.doc.content=JSON.stringify(_compressJSON._unCompress(_value.doc.content))
        }
        _value=_compressJSON._compress(_value);
        if(!_data[_path[i]]){
          _data[_path[i]]={};
        }else if(_path[i]=="tmp"){
          _md5=_md5||_data[_path[i]].md5
        }
        if(!_md5){
          _md5=_calcMD5(_value);
        }
        var d=_data[_path[i]]={md5:_md5,value:_value};
        this._store(ps,d);
      }else{
        delete _data[_path[i]];
        _localStorageManagement._removeData(_localStorageManagement._getKey(1)+ps);
      }
    }
    return _md5;
  },
  _removeData:function(p){
    localStorage.removeItem(p);
  },
  _retrieve:function(_path){
    let d;
    try{
      if(_path=="bz-habit"){
        d=JSON.parse(this._decrypt(_compressData._unCompress(localStorage.getItem("bz-habit"))))
      }else if(_path=="bz-auth"||_path=="bzTmpDB"){
        d=JSON.parse(this._decrypt(_compressData._unCompress(localStorage.getItem(pId+"/"+_path))))
      }else{
        d=this._getCurProjectData();
        if(d){
          for(var i=0;i<_path.length;i++){
            d=d[_path[i]];
            if(!d){
              return null;
            }
          }
        }
      }
    }catch(e){}
    return d||{};
  },
  _store:function(_path,_data,_reTry){
    try{
      _data = _compressData._compress(this._encrypt(JSON.stringify(_data),true));
    }catch(e){
      _data = JSON.stringify(_data);
    }
    try{
      var _prePath;
      if(_path=="bz-auth"||_path=="bzTmpDB"){
        _prePath=pId+"/"+_path
      }else if(_path!="bz-habit"){
        _prePath=_localStorageManagement._getKey(1)+_path
      }else{
        _prePath="bz-habit"
      }
      localStorage.setItem( _prePath, _data);
      _localStorageManagement._removeData(_prePath+"tmp/");
    }catch(e){
      if(_reTry){
        alert("Data is too large to store!")
      }else{
        _localStorageManagement._cleanAll();
        _localStorageManagement._store(_path,_data,1);
      }
    }
  },
  _cleanData:function(_path,gs){
    var _data=this._getCurProjectData();
    var ps=_localStorageManagement._getKey(1)
    for(var i=0;i<_path.length;i++){
      _data = _data[_path[i]];
      ps+=_path[i]+"/"
      if(!_data){
        return;
      }
    }
    _localStorageManagement._cleanTask(ps,gs,0)
  },
  _cleanTask:function(ps,gs,i){
    var k=localStorage.key(i),gs=gs||[];
    if(!k){
      return
    }else if(k.startsWith(ps)){
      var g=k.replace(ps,"").split("/");
      g=g.shift()||g.shift()
      if(!gs.includes(g) && g!="setting"&&g!="tmp"){
        _localStorageManagement._removeData(k);
        i--;
      }
    }
    setTimeout(()=>{
      _localStorageManagement._cleanTask(ps,gs,i+1)
    },1)
  },
  _cleanVersion:function(){
    var _data=this._parseData();
    _data=_data[BZ._data._curProject._id];
    if(!_data){
      return;
    }
    var vs=BZ._data._curProject.versions;
    for(var k in _data){
      var _found=false;
      for(var i=0;i<vs.length;i++){
        var v=vs[i];
        if(v.code==k){
          _found=true;
          break;
        }
      }
      if(!_found){
        delete _data[k];
        _localStorageManagement._cleanTask(_localStorageManagement._getKey(k),[],0)
      }
    }
  },
  _updateTmpData:function(oo,v,_md5){
    if(!oo){
      return
    }
    var _path=["tmp"],
        pd=_localStorageManagement._getCurProjectData(),
        o=oo._data;
        
    if(o.modules){
      _path.unshift("setting");
      _md5=_md5||pd.setting.md5;
    }else if(o.tests){
      _path.unshift(o.code);
      _md5=_md5||o.updateStamp.time;
    }else{
      _path.unshift(o.code);
      _path.unshift(oo._parent._data.code);
      _md5=_md5||pd[oo._parent._data.code][o.code].md5;
    }
    _localStorageManagement._update(_path,v,_md5);
  },
  _deleteTmpData:function(v){
    let kk=_localStorageManagement._getKey(1)
    for(var i=0;i<localStorage.length;i++){
      var k=localStorage.key(i);
      if(k.startsWith(kk) && k.endsWith("/tmp/")&&(!v||k.includes(v))){
        _localStorageManagement._removeData(k)
      }
    }
  },
  _cleanAll:function(){
    let _found=0,vs=[],ms=[],
        pk=_localStorageManagement._getKey(),
        vk=_localStorageManagement._getKey(1),
        mk=_IDE._getShortcutModuleCode(1,1);

    for(var n=0;n<localStorage.length;n++){
      var k=localStorage.key(n);
      if(["bz-habit","bz-ide","bz-init-resize"].includes(k)){
      }else if(!k.startsWith(pk)){
        localStorage.removeItem(k);
        _found=1
        n--
      }else if(!k.startsWith(vk)){
        vs.push(k)
      }else if(mk&&!k.startsWith(mk)){
        ms.push(k)
      }
    }
    !_found&&(vs||ms).forEach(v=>{
      localStorage.removeItem(v);
    })
  },
  //clean old version data
  _cleanOldBZVersion:function(){
    for(var n=0;n<localStorage.length;n++){
      if(localStorage.key(n).startsWith(_localStorageManagement._preKey)){
        return
      }
    }
    if(!localStorage.getItem("BZ-Reload")&&!localStorage.getItem("bz-init-resize")){
      localStorage.clear()
    }
  },
  _reloadData:function(){
    if(localStorage.getItem("BZ-Reload")){
      return alert("Data update error!")
    }else{
      localStorage.clear()
      localStorage.setItem("BZ-Reload","1")
      return setTimeout(()=>{
        location.reload()
      },BZ._isInDemo()?500:1)
    }
  },
};
if(!window.extensionContent){
  _localStorageManagement._cleanOldBZVersion();
};window._mainMenuHandler={
  _data:_CtrlDriver._buildProxy({
    _selectedItems:[]
  }),
  _list:["com","module","feature","search","workspace","ai-model","history"],
  // _list:["com","module","feature","search","workspace","ai-model"],
  _startDrag:function(o,e){
    let d=_mainMenuHandler._getDragDropData(o)
    let s=BZ._data._uiSwitch._selectedItems
    if(s&&s.includes(d.d)&&$(".viewport").find(o)[0]){
      d._list=s
    }else if(d.a){
      d._copy=!_IDE._data._curTest||!_IDE._data._curTest._data.actions.includes(d.a)
    }
    e.dataTransfer.effectAllowed = d._copy||_mainMenuHandler._isCtrlPressed(e)?"copy":"move";
    _mainMenuHandler._data._curDragItem=d
  },
  _getRootData:function(o){
    let s=BZ._data._uiSwitch._selectMainMenu
    if(s=="workspace"){
      return o._data= s;
    }
    o._data={_version:1,_type:s}
  },
  _isWorkSpace:function(o){
    return o._data&&(o._data=="workspace"||o._data._key=="workspace")
  },
  _getDragDropData:function(o){
    o=o._data
    let d=_mainMenuHandler._getMainMenuItemData(o),m,t,a,ct=_IDE._data._curTest
    if(d._version){
      return {}
    }else if(d.tests){
      m=d
    }else if(d.actions){
      t=d
    }else if(ct&&ct._data.actions.includes(d)){
      t=ct._data
      a=d
    }else if(o._item){
      t=o._item._parent||o._item._root
      if(t&&t.actions&&t.actions.includes(d)){
        a=d
      }else{
        return
      }
    }else{
      return
    }
    return {m:m||_ideObjHandler._getModuleByTest(t)._data,t:t,a:a,d:d}
  },
  _isExist:function(d){
    if(d.tests){
      return _ideObjHandler._getDataByPath(d.code)
    }else{
      return _ideObjHandler._getModuleByTest(d)
    }
  },
  _dragenter:function(o,e){
    if(!o.attributes.droppable){
      return
    }
    if(_mainMenuHandler._dropable(o,e)){
      e.dataTransfer.dropEffect=e.dataTransfer.effectAllowed = _mainMenuHandler._isCtrlPressed(e)?"copy":"move";
      if(!_mainMenuHandler._isIgnoreDrop(o,e)){
        $(o).addClass("bz-drag-over")
      }else if(_mainMenuHandler._isCtrlPressed(e)){
        return
      }
      e.preventDefault();
      e.stopPropagation()
    }else if((o._data._item||o._data).tests){
      e.stopPropagation()
      return false
    }
  },
  _dragleave:function(o,e){
    $(o).removeClass("bz-drag-over")
  },
  _dropable:function(oo,e){//return -1 is false, for continue next level drop element.
    let d=_mainMenuHandler._data._curDragItem
    if(d){
      if(_mainMenuHandler._isWorkSpace(oo)){
        return !d.a
      }
      let o=_mainMenuHandler._getDragDropData(oo)
      if(o.d==d.d){
        return 1
      }
      if(!oo.attributes.droppable){
        return
      }
      if(!o.m){
        return d.m==d.d&&(d.m.bt!="data"||!d.m.parentModule)
      }else if(o.m.bt=="data"){
        return
      }else if(d.d==d.m&&d.m.bt){
        return
      }else if(o.m==o.d){
        if(o.m.bt=="feature"){
          return d.d.type=="scenario"
        }else if(o.m.code=="com"){
          return d.d.type=="com"
        }else if(o.m.code=="bug"){
          return d.d.type=="bug"
        }else if(d.d==d.m){
          return !_ideObjHandler._getModulePath(o.d).split("/").includes(d.d.code)
        }
        return d.d==d.t&&d.d.type!="scenario"
      }else{
        return d.d==d.a
      }
    }
  },
  _isIgnoreDrop:function(o,e){
    if(_mainMenuHandler._isWorkSpace(o)){
      return
    }
    let d=_mainMenuHandler._data._curDragItem
    o=_mainMenuHandler._getDragDropData(o)
    if(o.d==d.d){
      return 1
    }else if((!o.m&&!d.d.parentModule)||(o.m&&((o.d.tests||[]).includes(d.d)||(o.d==o.m&&d.d==d.m&&o.d.code==d.d.parentModule)))){
      return !_mainMenuHandler._isCtrlPressed(e)
    }
  },
  _isCtrlPressed:function(e){
    let d=_mainMenuHandler._data._curDragItem
    return (d&&d._copy)||e.ctrlKey||e.metaKey
  },
  _drop:function(o,e){
    if(!o.attributes.droppable){
      return
    }
    $(o).removeClass("bz-drag-over")
    if(!_mainMenuHandler._dropable(o,e)){
      return
    }else if(_mainMenuHandler._isIgnoreDrop(o,e)){
      if(_mainMenuHandler._isCtrlPressed(e)){
        return
      }
      e.preventDefault()
      e.stopPropagation()
      return
    }
    e.preventDefault()
    e.stopPropagation()
    let d=_mainMenuHandler._data._curDragItem
    let ds=d._list||[d.d]
    if(_mainMenuHandler._isWorkSpace(o)){
      _mainMenuHandler._addToWorkspace(ds,1)
      return
    }
    o=_mainMenuHandler._getDragDropData(o)
    if(_mainMenuHandler._isCtrlPressed(e)||d.d==d.t){
      _IDE._getCopyData(ds,0,!o.m||d.d==d.m?"module":d.d==d.t?"test":"action",0,function(ds){
        if(!o.m){
          _ideModuleManagement._move(ds,"",1)
        }else if(d.d==d.m){
          _ideModuleManagement._move(ds,o.d,1)
        }else if(d.d==d.t){
          _ideTestManagement._move(ds,o.d,!_mainMenuHandler._isCtrlPressed(e))
        }else{
          _ideActionManagement._move(ds,o.a,o.t,o.m)
        }
      })
    }else{
      if(!o.m){
        _ideModuleManagement._move(ds,"")
      }else if(d.d==d.m){
        _ideModuleManagement._move(ds,o.d)
      }else{
        _ideActionManagement._move(ds,o.a,o.t,o.m,d.m.code+"."+d.t.code)
      }
    }
    e.preventDefault()
    e.stopPropagation()
  },
  _endDrag:function(o,e){
    _mainMenuHandler._data._curDragItem=0
  },
  _isShowMainMenu:function(v){
    return v.includes(BZ._data._uiSwitch._selectMainMenu)
  },
  _refreshMainMenu:function(){
    if(BZ._data._uiSwitch._refreshMenu){
      _CtrlDriver._refreshData(BZ._data._uiSwitch,"_refreshMenu")
    }
  },
  _handlerSize:function(x,y,o,_end){
    let m=o.previousElementSibling,
        sm=BZ._data._uiSwitch;
    if(x<100){
      BZ._data._uiSwitch._selectMainMenu=0
      $(o).css({left:"var(--bar-width)"})
    }else{
      if(!sm._selectMainMenu){
        sm._selectMainMenu=sm._lastMainMenu||"module"
      }
      if($(m).hasClass("bz-main-menu")){
        $(m).css({width:x-m.getBoundingClientRect().left+"px"})
      }
    }
    if(_end){
      _headTabHandler._setTabSize()
      $("canvas").resize()
    }
  },
  _initWorkspace:function(){
    let s=BZ._data._uiSwitch
    s._workspace=s._workspace.filter(x=>x)
    if(s._workspace[0]&&s._workspace[0].constructor==String){
      s._workspace=s._workspace.map(x=>_ideObjHandler._getDataByPath(x)).filter(x=>x).map(x=>x._data)
    }
  },
  _getMainMenuItemData:function(d){
    d=d._item||d
    if(d._data){
      d=_ideObjHandler._getDataByPath(d._path)
      d=d._data||d
    }else{
      d=d._obj||d
    }
    if(d.o&&d.o._data){
      d=d.o._data
    }
    return d
  },
  _addToWorkspace:function(ds,_forceInsert){
    let _uiSwitch=BZ._data._uiSwitch
    if(ds.constructor!=Array){
      ds=[ds]
    }
    ds.forEach(d=>{
      let i=_uiSwitch._workspace.indexOf(d)
      if(i>=0){
        if(_forceInsert){
          return
        }
        _uiSwitch._workspace.splice(i,1)
      }else{
        _uiSwitch._workspace.push(d)
      }
    })
    BZ._userHabit.workspace[pId]=_uiSwitch._workspace.map(x=>_ideObjHandler._getItemPath(x))
    BZ._storeUserHabit()
    _Util._flashElement($(".bz-workspace")[0],1000)
    if(BZ._data._uiSwitch._selectMainMenu=="workspace"){
      _mainMenuHandler._refreshMainMenu()
    }
  },
  _switchInWorkspace:function(d){
    d=_mainMenuHandler._getMainMenuItemData(d)
    _mainMenuHandler._addToWorkspace(d)
  },
  _setHashByItem:function(d,_fun){
    let dd=d;

    d=d._item._url||d._item._path||_mainMenuHandler._getMainMenuItemData(d)
    let h=location.hash
    if(h.includes("/logCurReport/?fun=trends&")&&d&&d.code!="com"&&d.type!="com"&&(d=="/features"||d=="/modules"||d.tests||d.actions)){
      let k=d.tests?"module":d.actions?"test":"";
      if(k){
        d="&"+k+"="+_ideObjHandler._getItemPath(d).replace(/[\/]/g,".").replace(".","");
      }else{
        d=""
      }
      location.hash=h.replace(/(&(module|test)=.+)?$/,d)
    }else{
      BZ._setHash(d._version?"/":d,undefined,undefined,undefined,_fun)
    }
  },
  _newTest:function(o,_type){
    let s=_mainMenuHandler._getMainMenuItemData(o)
    if(s._version){
      s=0
    }
    _mainMenuHandler._setHashByItem(o)
    _ideTestManagement._newItem(_type,"",0,0,s,function(){
      _mainMenuHandler._refreshMainMenu()
    })
  },
  _selectMainMenu:function(v){
    let s=BZ._data._uiSwitch
    BZ._userHabit.selectMainMenu=s._lastMainMenu=s._selectMainMenu=s._selectMainMenu==v?"":v
    
    BZ._storeUserHabit()
    if(BZ._userHabit.selectMainMenu){
      setTimeout(()=>{
        let o=$(".bz-v-holder")[0]
        _mainMenuHandler._handlerSize(o.getBoundingClientRect().left+5,200,o,1)
      },11)
    }else{
      $("canvas").resize()
    }
  },
  _getRootName:function(d){
    if(d.code=="com"){
      d="_com"
    }else if(d._type=="module"){
      d="_modules"
    }else if(d._type=="feature"){
      d="_features"
    }else{
      d="_ais"
    }
    return _bzMessage._common[d]+" ["+BZ._data._curProject.name+' - '+_IDE._data._curVersion.code+"]"
  },
  _buildRootString:function(t,ms){
    return "_CtrlDriver._buildProxy([{_version:1,_type:'"+t+"',_url:'/"+t+"s',modules:"+ms+"}])"
  }
};var _optHistoryHandler={
  _testUpdateKeys:[
    "code",
    "initParameter",
    "subtype",
    "name",
    "tag",
    "loopData",
    "dataMap",
    "hostId",
    "actions",
    "enterPoint",
    "speed",
    "synActionDesc",
    "note",
    "description",
    "defParameter"
  ],
  _moduleUpdateKeys:[
    "code",
    "dataMap",
    "definition",
    "alias",
    "comment",
    "defaultHostId",
    "keyField",
    "name",
    "rootUrl",
    "tag",
    "tmpDataSize"
  ],
  _data:_CtrlDriver._buildProxy({_undo:{},_redo:{}}),
  _init:function(_code){
    if(BZ._isAutoRunning()){
      return
    }
    let o=_ideObjHandler._getDataByPath(_code)
    if(!o){
      return
    }
    if(o._parent&&!o._parent._loaded){
      return setTimeout(()=>{_optHistoryHandler._init(_code)},100)
    }
    o=o._data

    let d=_optHistoryHandler._data,dd={},
        i=Date.now()

    d._undo._key=o.base
    d._undo._list=0
    d._undo._size=0

    d._redo._key=o.redo
    d._redo._list=0
    d._redo._size=0

    d._path=_code

    d._hoverIdx=-1;
    BZ._data._uiSwitch["_undo"+"_menu"]=BZ._data._uiSwitch["_redo"+"_menu"]=0;

    if(o.code[0]=="t"){
      _optHistoryHandler._updateKeys=_optHistoryHandler._testUpdateKeys
    }else{
      _optHistoryHandler._updateKeys=_optHistoryHandler._moduleUpdateKeys
    }
    _optHistoryHandler._data._hoverGroupIdx=0
    _optHistoryHandler._toBase=0

    _optHistoryHandler._updateKeys.forEach(x=>{
      if(x=="actions"){
        o[x].forEach(y=>y.key=y.key||i++)
      }
      dd[x]=_Util._clone(o[x])
    })

    _optHistoryHandler._curOldData=dd
  },
  _getUpdateContent:function(d,_code){
    if(_code&&_optHistoryHandler._data._path==_code){
      let dd;
      if(_optHistoryHandler._opt){
        dd=_optHistoryHandler._opt
        delete _optHistoryHandler._opt
      }else{
        let _diffs=[]
        
        _optHistoryHandler._updateKeys.forEach(k=>{
          let o=_optHistoryHandler._curOldData[k],
              n=d[k]
          if(["dataMap","defParameter"].includes(k)){
            o=_Util._strToObj(o)
            n=_Util._strToObj(n)
          }
          _Util._getSimpleDiffInJson(o,n,(kk,p,o,f)=>{
            return kk[0]=="_"||(kk=="inGroup"&&!o&&!f)
          },_diffs,k)
        })
        
        if(_diffs.length){
          dd={
            base:d.base,
            key:_IDE._data._curVersion.code+","+d.updateStamp.time,
            details:_diffs
          }
          d.base=dd.key
          d.redo=""
        }
      }

      return dd
    }else{
      return 1
    }
  },
  _getBtnView:function(_type){
    //undo
    let _icon=_type=="_undo"?"undo":"redo"

    return {
      _icon:`bz-${_icon}`,
      _disable: function(){
        return !_optHistoryHandler._has(_type)
      },
      _fun:function(){
        _optHistoryHandler[_type]()
      },
      _title:"_bzMessage._method."+_type
    }
  },
  _getOptDesc:function(v){
    let ks=Object.keys(v)
    if(!ks.includes("from")){
      return _bzMessage._method._add+": "+v.key
    }else if(!ks.includes("to")){
      return _bzMessage._method._remove+": "+v.key
    }else{
      return _bzMessage._method._update+": "+v.key
    }
  },
  _redo:function(_idx,_group){
    let _curData=BZ._data._curPage._obj._data
    if(_idx===undefined){
      _optHistoryHandler._getItemByBase("_redo",function(d){
        _curData.redo=""
        if(!d.find(x=>{
          if(x.key==_optHistoryHandler._data._redo._key){
            let dd;
            if(d.length>1){
              dd=d.pop()
            }
            
            _doIt([x],dd)

            return 1
          }
        })){
          _optHistoryHandler._store()
        }
        if(_IDE._data._curAction){
          BZ._setHash(location.hash)
        }
      })
    }else{
      let _list=_optHistoryHandler._data._redo._list[_group]
      _doIt(_list.slice(0,_idx+1),_list[_idx+1])
    }
    
    function _doIt(ds,dd){
      let rd=_optHistoryHandler._buildData(ds,"from","to","redo",dd);

      rd.base=ds.pop().key
      rd.redo=dd?dd.key:""

      _Util._assign(rd,_curData)
      _optHistoryHandler._store()
    }
  },
  _undo:function(_idx,_group){
    let _curData=BZ._data._curPage._obj._data
    if(_idx===undefined){
      _optHistoryHandler._getItemByBase("_undo",function(d){
        _curData.base=""
        if(d.length){
          d=d[0]
          _doIt([d],d)
        }else{
          _optHistoryHandler._store()
        }
        if(_IDE._data._curAction){
          BZ._setHash(location.hash)
        }
      })
    }else{
      let _list=_optHistoryHandler._data._undo._list[_group]
      _doIt(_list.slice(0,_idx+1),_list[_idx])
    }
    
    function _doIt(ds,d){
      let rd=_optHistoryHandler._buildData(ds,"to","from","undo",d);

      rd.redo=d.key
      rd.base=d.base

      _Util._assign(rd,_curData)
      _optHistoryHandler._store()
    }
  },
  _store:function(){
    let o=BZ._data._curPage._obj._data
    if(o.code[0]=="t"){
      _ideTestManagement._save()
    }else{
      if(_aiGeneratorDataHandler._isAIModule(o)){
        _aiModelHandler._buildMissingTest(o,function(){
          _doModule()
        })
      }else{
        _doModule()
      }
    }
    
    function _doModule(){
      _ideModuleManagement._save(0,function(){
        _aiModelHandler._refreshGUI()
      })
    }
  },
  _buildData:function(_list,f,t,_type,dd){
    let d=_Util._clone(_optHistoryHandler._curOldData)
    
    _list.forEach(x=>{
      if(x.details.length){
        let os={},us=[]
        x.details.forEach(y=>{
          if(y.order){
            os[y.key]=os[y.key]||[]
            os[y.key].push(y)
          }else{
            us.push(y)
          }
        })
        _handleOrder(os)
        _handleUpdate(us)
        
      }        
    })
    
    _optHistoryHandler._opt={
      base:dd?dd.base:"",
      opt:_type,
      key:_IDE._data._curVersion.code+","+BZ._data._curPage._obj._data.updateStamp.time
    }

    return d
    
    function _handleOrder(os){
      if(!_Util._isEmpty(os)){
        for(let k in os){
          let x=os[k]
          let ks=k.split(".")
          let dd=_toData(d,ks)
          let _list=[].concat(dd)
          x.forEach(y=>{
            _list[y[t]]=dd[y[f]]
          })
          _setData(d,ks,_list)
        }
      }
    }
    
    function _handleUpdate(x,_reversed){
      //for remove
      while(x.length){
        let y=x.shift()
        let yks=Object.keys(y)

        let ks=y.key.split(".")
        let kk=ks.pop()
        dd=_toData(d,ks)
        if(dd===undefined||dd===null){
          x.unshift(y)
          if(!_reversed||x.length<_reversed){
            x.reverse()
            return _handleUpdate(x,x.length)
          }else{
            return
          }
        }

        if(yks.includes(f)&&!yks.includes(t)){
          if(dd.constructor==Array){
            dd.splice(kk,1)
          }else{
            delete dd[kk]
          }
        }else if(yks.includes(t)&&!yks.includes(f)){
          if(dd.constructor==Array){
            if(dd.length>kk){
              dd.splice(kk,0,y[t])
            }else{
              dd.push(y[t])
            }
          }else{
            dd[kk]=y[t]
          }
        }else{
          dd[kk]=y[t]
        }
      }
      /*
      //for add
      x.reverse()
      for(let i=0;i<x.length;i++){
        let y=x[i]
        let yks=Object.keys(y)
        if(yks.includes(t)&&!yks.includes(f)){
          let ks=y.key.split(".")
          let kk=ks.pop()
          dd=_toData(d,ks)
          if(dd.constructor==Array){
            if(dd.length>kk){
              dd.splice(kk,0,y[t])
            }else{
              dd.push(y[t])
            }
          }else{
            dd[kk]=y[t]
          }
          x.splice(i--,1)
        }
      }
      
      //for remove
      x.reverse()
      for(let i=0;i<x.length;i++){
        let y=x[i]
        let yks=Object.keys(y)
        if(yks.includes(f)&&!yks.includes(t)){
          let ks=y.key.split(".")
          let kk=ks.pop()
          if(!$.isNumeric(kk)){
            dd=_toData(d,ks)
            delete dd[kk]
            x.splice(i--,1)
          }
        }
      }

      //for add
      x.forEach(y=>{
        let yks=Object.keys(y)
        if(yks.includes(t)&&yks.includes(f)){
          let ks=y.key.split(".")
          let kk=ks.pop()
          dd=_toData(d,ks)
          dd[kk]=y[t]
        }
      })
      */
    }
    
    function _toData(d,ks){
      let dd=d
      ks.find(z=>{
        let dv=_strToData(z,dd[z])
        if(dv!==undefined&&dv!==null){
          dd[z]=dv
          dd=dv
        }else{
          dd=dv
          return 1
        }
      })
      return dd
    }
    
    function _setData(d,ks,v){
      let kk=ks.pop()
      ks.forEach(x=>{
        d=d[x]
      })
      d[kk]=v
    }
    function _strToData(k,d){
      if(["defParameter","dataMap"].includes(k)&&d&&d.constructor==String){
        d=_Util._strToObj(d)
      }
      return d
    }
  },
  _has:function(_type){
    let d=BZ._data._curPage._obj
    d=d._data||d
    if(!BZ._isPlaying()&&BZ._isCheckout()&&!_optHistoryHandler._data._retrieving){
      return _optHistoryHandler._data[_type]._key
    }
  },
  _showList:function(_type,_size){
    let d=_optHistoryHandler._data[_type]
    if(d._list&&d._size>=_size){
      return d._list
    }
    if(_type=="_undo"){
      _retrieveList("undoes",function(_list){
        let vs=[],k=d._key;
        while(_list.find((x,i)=>{
          if(x.key==k){
            vs.push(x)
            k=x.base
            _list.splice(i,1)
            return 1
          }
        })){}
        
        _optHistoryHandler._data[_type]._list=[vs]
      })
    }else{
      _retrieveList("redoes",function(_list){
        _buildRedoTree(_list,_optHistoryHandler._data._undo._key)
      })
    }
    d._size=_size
    
    function _buildRedoTree(_list,_root){
      let _tree=[]
      for(let i=0;i<_list.length;i++){
        let d=_list[i]
        if(d.base==_root){
          _list.splice(i--,1)
          let vs=[d]
          _buildBranch(_list,d.key,vs)
          _tree.push(vs)
        }
      }
      _optHistoryHandler._data[_type]._list=_tree
    }
    
    function _buildBranch(_list,_key,_branch){
      let vs=[]
      for(let n=0;n<_list.length;n++){
        let d=_list[n]
        if(d.base==_key){
          vs.push(d)
          _list.splice(n--,1)
        }
      }
      if(vs.length==1){
        _branch.push(vs[0])
        
        _buildBranch(_list,vs[0].key,_branch)
      }
    }
    
    function _retrieveList(f,_fun){
      _optHistoryHandler._data._retrieving=1
      let p=_optHistoryHandler._getSearchFilter(_optHistoryHandler._data._undo._key,_size)

      _requestHandler._callService({
        _data:{
          method:"GET",
          url:`/api/projects/${BZ._data._curProject.code}/${f}/?${p}`
        },
        _success:function(d){
          _optHistoryHandler._data._retrieving=0
          
          _fun(d.result)
        },
        _failed:function(d){
          alert(d.message)
          _optHistoryHandler._data._retrieving=0
        }
      });
    }
  },
  _getItemByBase:function(_type,_fun){
    let d=_optHistoryHandler._data[_type]

    let p=_optHistoryHandler._getSearchFilter(d._key)
    _optHistoryHandler._data._retrieving=1
    _requestHandler._callService({
      _data:{
        method:"GET",
        url:`/api/projects/${BZ._data._curProject.code}/${_type=="_undo"?"undo":"redo"}/?${p}`
      },
      _success:function(d){
        _optHistoryHandler._data._retrieving=0
        _fun(d.result)
      }
    });
  },
  _getSearchFilter:function(k,_size){
    let d=_optHistoryHandler._data
    return `path=${d._path}&base=${k||""}&limit=${_size}`
  }
};;var _screenshotHandler={
  _isMaking:function(_result){
    var v= BZ._isAutoRunning() 
          && BZ.TW 
          && !BZ.TW.closed          
          && _result._type!=_taskInfo._type._success 
          && _result._type!=_taskInfo._type._warning
          && !_result._imgData;
    if(v){
      return _ideTask._isFinalFailRef(_result,_result._data)
    }
  },
  _generate:function(_result,_force,_fun){
    if(BZ._isAutoRunning()){
      $(".BZIgnore").remove()
    }
    // var _element = _force?_result._data.element:_domActionTask._showIssueInComment(_result);
    let _element=_result._data.element||["BZ.TW.document.BODY"]

    _element=($util.findDom(_element)||[])[0]||window.document.body;
    _doIt(Date.now())
    function _doIt(_time){
      // if(!_force&&(!$(".bz-tip")[0]||!$(".bz-tip")[0]._bzTipDone)){
        // if(Date.now()-_time<5000){
          // setTimeout(function(){_doIt(_time,_element)},500)
          // return 
        // }
      // }
      
      var _mark=BZ._documents.find(".bz-tip"),_pos;
      if(_mark[0]){
        _pos=_screenshotHandler._getMergeArea(_element,_mark[0]);
      }else{
        var _rect=_element.getBoundingClientRect();
        _pos={
          _left:_rect.left,
          _width:_rect.width,
          _top:_rect.top,
          _height:_rect.height
        };
      }

      $(".bz-tip").hide()
      setTimeout(()=>{
        _screenshotHandler._getScreenshot(_pos,0,function(c){
          $(".BZIgnore").remove()
          
          if(!_force&&!_result._generateScreenshotTime){
            
            return _fun&&_fun(c);
          }
          _result._canvas=c
          _final()
        })
      },1)
    }
    function _final(){
      if(_fun){
        _fun(c)
      }else if(bzTwComm._isExtension()){
        bzTwComm._postToIDE({_fun:"_finishScreenshotResult",_scope:"_ideReport",_args:[_result]})
      }else{
        _ideReport._finishScreenshotResult(_result)
      }
    }
  },
  _elementImg:function(_element,cd,_fun){
    _screenshotHandler._getScreenshot(_element,0,function(c){
      _fun(c);
    })
  },
  //cd: coordinate deviation
  _elementImgMd5:function(_element,cd,_fun){
    this._elementImg(_element,cd,function(v){
      if(v.toDataURL){
        v=v.toDataURL();
      }
      _fun(v)
    })
  },
  _getMergeArea:function(_element,_mark){
    if(_element.tagName=="BODY"){
      return {
        _left:0,
        _top:0,
        _width:window.innerWidth,
        _height:window.innerHeight
      }
    }
    var xy=_Util._getDomXY(_element);
    var _rect=_element.getBoundingClientRect();
    var _rect1={
      left:xy.x,
      top:xy.y,
      width:_rect.width,
      height:_rect.height
    }
    
    var xy=_Util._getDomXY(_mark);
    _rect=_mark.getBoundingClientRect();
    var _rect2={
      left:xy.x,
      top:xy.y,
      width:_rect.width,
      height:_rect.height
    }
    
    var x1=_rect1.left<_rect2.left?_rect1.left:_rect2.left;
    var x2=(_rect1.left+_rect1.width)>(_rect2.left+_rect2.width)?(_rect1.left+_rect1.width):(_rect2.left+_rect2.width);
    var y1=_rect1.top<_rect2.top?_rect1.top:_rect2.top;
    var y2=(_rect1.top+_rect1.height)>(_rect2.top+_rect2.height)?(_rect1.top+_rect1.height):(_rect2.top+_rect2.height);
    
    if(x1>10){
      x1-=10;
    }
    if(y1>10){
      y1-=10;
    }
    
    if(x2-x1<500){
      x1-=(500-x2+x1)/2;
      x2+=(500-x2+x1)/2;
      if(x1<0){
        x2-=x1;
        x1=0;
      }
    }
    
    if(y2-y1<320){
      y1-=(320-y2+y1)/2;
      y2+=(320-y2+y1)/2;
      if(y1<0){
        y2-=y1;
        y1=0;
      }
    }
    return {_left:x1,_width:x2-x1,_top:y1,_height:y2-y1};
  },
  _canvasToImg:function(d){
    var o={base64Link:d.toDataURL?d.toDataURL():d, type:"image/png"};
    return _uploadHandler._base64ToBlob(o);
  },
/*Don't delete. It is for generate img 
  _postImg:function(_result){
    var _file=_screenshotHandler._canvasToImg(_result._canvas);
    var formData = new FormData();

    formData.append("uploads[]", _file, _result._data._path+".png");

    $.ajax({
      url: SERVER_HOST+"/api/projects/"+BZ._data._curProject.code+"/uploadScreenshot/",
      type: "POST",
      data: formData,
      processData: false,
      contentType: false,
      success: function(data){
//        console.log('upload successful!\n' + data);
      },
      error:function(data){
//        console.log("error: "+data);
      }
    });
  },
*/ 
  _postImgInString:function(_result,_triggerScreenshot){
    if(_result._type<3){
      console.log("BZ-LOG: postImgInString ...")
    }
    if(_result._canvas||_result._imgData||_result._data._attachIdx!==undefined){
      console.log("BZ-LOG: postImgInString-1 ...")
      let _data=_result._imgData
      if(!_data||!_data.file){
        _data={
          file:_result._canvas||_getAttachImg(),
        }
        _result._imgData=_data;
      }
      if(_data.file){
        _data.name=_calcMD5(_data.file)
        console.log("BZ-LOG: Screenshot:"+_data.name)
  
        _requestHandler._callService({
          _data:{
            method:"POST",
            url:"/api/projects/"+BZ._data._curProject.code+"/uploadScreenshotInString/",
            data:_data
          }
        });
      }else{
        console.log("BZ-LOG: postImgInString-2 ...")
        console.log("BZ-LOG: "+Object.keys(_result).join(", "))
      }
    }else if(_result._type<3&&_result._url&&_result._data.element){
      if(!_triggerScreenshot){
        $util.takeScreenshot(0,function (a) {
          _result._imgData={
            file:a,
            name:_result._data._path.replace(/[\/]/g,".").replace(/[\.]$/,"")
          }
        })
      }
      setTimeout(function(){
        _screenshotHandler._postImgInString(_result,1);
      },10);
    }

    function _getAttachImg(){
      return (_ideReport._attachedInfo[_result._data._attachIdx]||{})._info
    }
  },
  _getElementAreaImg:function(e,f,_fun){
    _screenshotHandler._getScreenshot(e,f,function(c){
      _fun(c);
    })
  },
  _getScreenshotInMd5:function(_fun){
    try{
      let r=document.body.getBoundingClientRect()
      if(!r.width||!r.height){
        return _fun&&_fun(0)
      }
      _screenshotHandler._getScreenshot(document.body,0,function(v){
        if(BZ._hasVideo){
          if(_screenshotHandler._lastScreenshot!=v){
            _Util._log("video-img: "+v)
            _screenshotHandler._lastScreenshot=v
          }  
        }
        _fun&&_fun(_calcMD5(v))
      })
    }catch(ex){
      _fun&&_fun(0)
    }
  },
  _getScreenshot:function(e,_withArea,_bkFun){
    clearTimeout(_screenshotHandler._callBackTimer)
    _screenshotHandler._callBackTimer=setTimeout(()=>{
      _bkFun&&_bkFun()
    },3000)
    let _fun=0,o=e,_highlight=_withArea&&_withArea.outerHTML?_withArea:e;
    if(e.constructor!=Object){
      // setTimeout(()=>{
        if(bzTwComm._isExtension()){
          if(_highlight==BZ.TW.document.body){
            o=o._orgDom
            _doIt()
          }else{
            _bzDomPicker._flashTmpCover(_highlight)
            setTimeout(()=>{
              _prepareCover()
            },10)
          }
        }else{
          o=o.getBoundingClientRect()
          o={
            _left:o.left,
            _top:o.top,
            _width:o.width,
            _height:o.height
          }
          _doIt()
        }
      // },10)
    }else{
      _doIt()
    }
    
    function _prepareCover(_retry){
      _retry=_retry||0
      o=$(".BZCover,.ErrBZCover")[0]
      if(!o){
        if(_retry<10){
          return setTimeout(()=>{
            _prepareCover(_retry+1)
          },100)
        }else{
          o=document.body
          return _doIt()
        }
      }
      
      o=o._orgDom
      if(!_withArea||o.tagName=="BODY"){
        _bzDomPicker._removeTmpCover()
      }
      _doIt()
    }
    
    function _doIt(){
      _domActionTask._doLog("Current url: "+location.href)
      if(bzTwComm._isExtension()){
        bzTwComm._postToGb({
          _fun:"getScreenshot",
          _scope:"funMap",
          _args:[function(c){
            _final(c.imgUrl,o)
          }]
        })
      }else{
        html2canvas(document.body).then((c)=>{
          _final(c.toDataURL(),o)
        })
      }
    }
    
    function _final(c,o){
      clearTimeout(_screenshotHandler._callBackTimer)
      _bkFun(c)
    }
  }
};var $script={
  newList:[],
  getElement:function(elementPath){
    return elementPath?elementPath.outerHTML?elementPath:$util.findDom(elementPath):document.body
  },
  getElements:function(elementPath){
    return $util.findDoms(elementPath)
  },
  getElementMd5:function(element,callBack){
    
  },
  play:function(actions){
    if(!actions){
      return
    }else if(actions.constructor==Function){
      return actions()
    }else if(actions.constructor==String&&!actions.includes("$script.")){
      actions=_scriptActionHandler._parseTxtToAction(actions)
    }else if(actions.constructor==Object){
      actions=[actions]
    }
    
    actions.forEach(x=>{
      if(x.constructor==String){
        _Util._eval(x)
      }else if(x.constructor==Function){
        x()
      }else{
        _playObj(x)
      }
    })
    
    function _playObj(a){
      let f=$script[a.action]
      if(f){
        let ps=f.toString().split("(")[1].split(")")[1].split(",")
              .map(x=x.trim())
              .map(x=>"text,data,imageMd5,storeData,message".includes(x)?"value":x)
              .map(x=>a[x])
        f(...ps)
      }else{
        $script.newList.push(a)
      }
    }
  },
  playInIFrameIdx:function(idx,actions){
    $script.iframeIdx=idx;
    $script.play(actions)
    delete $script.iframeIdx
  },
  playInPanel:function(element,actions){
    $script.panel=_scriptActionHandler._buildElementPath(element)
    $script.play(actions)
    $script.panel=0
  },
  //0: validate
  validateExist:function(element,option){
    return _scriptActionHandler._addScriptAction(0,{
      _element:element,
      _exist:1,
      _option:option,
      _content:{
        type:"exist"
      }
    })
  },
  validateScreenshot:function(element,imageMd5,option){
    return _scriptActionHandler._addScriptAction(0,{
      _element:element,
      _equal:1,
      _data:imageMd5,
      _option:option,
      _content:{
        type:"screenshot"
      }
    })
  },
  validateData:function(element,data,option){
    return _scriptActionHandler._addScriptAction(0,{
      _element:element,
      _equal:1,
      _data:data,
      _option:option,
      _content:{
        type:"data"
      }
    })
  },
  validateText:function(element,text,option){
    return _scriptActionHandler._addScriptAction(0,{
      _element:element,
      _equal:1,
      _data:text,
      _option:option,
      _content:{
        type:"innerText"
      }
    })
  },
  validateValue:function(element,value,option){
    return _scriptActionHandler._addScriptAction(0,{
      _element:element,
      _equal:1,
      _data:value,
      _option:option,
      _content:{
        type:"value"
      }
    })
  },
  validateUnexist:function(element,option){
    return _scriptActionHandler._addScriptAction(0,{
      _element:element,
      _unexist:1,
      _option:option,
      _content:{
        type:"unexist"
      }
    })
  },
  validateEnable:function(element,option){
    return _scriptActionHandler._addScriptAction(0,{
      _element:element,
      _equal:1,
      _data:true,
      _option:option,
      _content:{
        type:"enable"
      }
    })
  },
  validateDisable:function(element,option){
    return _scriptActionHandler._addScriptAction(0,{
      _element:element,
      _equal:1,
      _data:true,
      _option:option,
      _content:{
        type:"disable"
      }
    })
  },
  validateScript:function(script,option){
    return _scriptActionHandler._addScriptAction(0,{
      _script:script,
      _option:option,
      _method:1
    })
  },
  api:function(option){
    return _scriptActionHandler._addScriptAction("api",option)
  },
  //1: mouse event
  click:function(element,option){
    return _scriptActionHandler._addScriptAction(1,{
      _element:element,
      _option:option
    })
  },
  rightClick:function(element,option){
    return _scriptActionHandler._addScriptAction(1,{
      _element:element,
      _option:option,
      _button:2
    })
  },
  dblclick:function(element,option){
    return _scriptActionHandler._addScriptAction(1,{
      _element:element,
      _option:option,
      _action:"dblclick"
    })
  },
  dragdrop:function(element,toElement,option){
    return _scriptActionHandler._addScriptAction(1,{
      _element:element,
      _toElement:toElement,
      _option:option,
      _action:"dragdrop"
    })
  },
  drag:function(element,from,to,option){
    return _scriptActionHandler._addScriptAction(1,{
      _element:element,
      _from:from,
      to:to,
      _option:option,
      _action:"drag"
    })
  },
  mouse:function(element,action,option){
    return _scriptActionHandler._addScriptAction(1,{
      _element:element,
      _option:option,
      _action:action
    })
  },
  //1: keyboard
  set:function(element,value,option){
    return _scriptActionHandler._addScriptAction(1,{
      _element:element,
      _value:value,
      _option:option,
      _doSet:1
    })
  },
  typing:function(element,value,option){
    return _scriptActionHandler._addScriptAction(1,{
      _element:element,
      _value:value,
      _option:option
    })
  },
  check:function(element,option){
    return _scriptActionHandler._addScriptAction(1,{
      _element:element,
      _value:true,
      _option:option
    })
  },
  uncheck:function(element,option){
    return _scriptActionHandler._addScriptAction(1,{
      _element:element,
      _value:false,
      _option:option
    })
  },
  //1: Fill form
  fillform:function(data,option){
    _scriptActionHandler._buildFormActions(data,option)
  },
  //2:
  get:function(element,storeData,option){
    return _scriptActionHandler._addScriptAction(2,{
      _element:element,
      _storeData:storeData,
      _option:option
    })
  },
  //3:
  script:function(script,option){
    return _scriptActionHandler._addScriptAction(3,{
      _script:script,
      _option:option
    })
  },
  //4:
  callTest:function(test,parameter,option){
    return _scriptActionHandler._addScriptAction(4,{
      _test:test,
      _parameter:parameter,
      _option:option
    })
  },
  //5:
  alert:function(element,message,option){
    return _scriptActionHandler._addScriptAction(5,{
      _element:element,
      _msg:message,
      _option:option
    })
  },
  //6:
  gotoUrl:function(url,option){
    return _scriptActionHandler._addScriptAction(6,{
      _url:url,
      _option:option
    })
  },
  refreshData:function(option){
    return _scriptActionHandler._addScriptAction(6,{
      _option:option
    })
  },
  //7:
  group:function(actions,option){
    return _scriptActionHandler._addScriptAction(7,{
      _actions:actions,
      _option:option
    })
  },
  //8:
  visitLinks:function(element,option){
    return _scriptActionHandler._addScriptAction(8,{
      _element:element,
      _option:option
    })
  },
  //9:
  validateFormFields:function(element,option){
    return _scriptActionHandler._addScriptAction(9,{
      _element:element,
      _option:option
    })
  },
  getTaskqueue:function(){
    return _ideTask._data._taskQueue
  },
  getExeTree:function(){
    
  },
};

var _scriptActionHandler={
  _action:{
    ".":"continue",
    "..":"stop",
    "...":"stop-group",
    "....":"stop-all",
    s:"success",
    w:"warning",
    f:"failed",
    e:"error"
  },
  _doTestActionsToText:function(t){
    let as=[];
    if(t.type=="scenario"){
      s=_bzScenario._actionsToDesc(_IDE._data._curTest)
    }else{
      t.actions.forEach(a=>{
        as.push(_scriptActionHandler._actionToText(a))
      })
      s= as.join("\n")
    }
    return BZ._data._uiSwitch._tmpInTextActions=s
  },
  _doTestActionsToJS:function(t){
    let as=[],_curGroup
    t.actions.forEach((a,i)=>{
      let k="/"+"*"+(i+1)+": *"+"/\n"
      if(a.type!=7){
        let aa=_scriptActionHandler._actionToJS(a)
        if(_curGroup){
          if(a.inGroup){
            _curGroup._actions.push("  "+k+"  "+aa)
          }else{
            as.push(_curGroup.k+_scriptActionHandler._actionToJS(_curGroup))
            as.push(k+aa)
            _curGroup=0
          }
        }else{
          as.push(k+aa)
        }
        return
      }else{
        if(_curGroup){
          as.push(_curGroup.k+_scriptActionHandler._actionToJS(_curGroup))
        }
        _curGroup={
          k:k,
          a:a,
          _actions:[]
        }
      }
    })
    if(_curGroup){
      as.push(_curGroup.k+_scriptActionHandler._actionToJS(_curGroup))
    }
    BZ._data._uiSwitch._tmpInJSActions= as.join("\n")
  },
  _actionToJS:function(a,_panel){
    let _actions=a._actions
    if(_actions){
      a=a.a
    }
    let _fun,_value="",_funMap={},
        _options=_parseOptions()
    _parseFun()
    let _element=_parseElement()
    
    if(_actions){
      _element=`[\n${_actions.join(",\n")}]`
    }else if(a.type==0&&a.method==1){
      _element=JSON.stringify(a.script)
    }else if(_element){
      _element=JSON.stringify(_element)
    }else if(a.type==3){
      _element=_handleScript(a.script)||'""'
    }else if(a.type==4){
      _element='"'+(a.refOfSuccess||"").split("/").filter(x=>x).filter(x=>x.length>4)[0]+'"'
      _value=a.successParameter||""
      if(_value){
        if(_value.constructor==String){
          if(_Util._isJsonValueString(_value)){
            if(_Util._hasCode(_value)&&!_Util._hasInsertCodeOnly(_value)){
              _value=JSON.stringify(_value)
            }
          }else{
            _value=JSON.stringify(_value)
          }
        }else{
          _value=JSON.stringify(_value)
        }
        _value=", "+_value
      }
    }else{
      _element=""
    }
    Object.keys(_funMap).forEach(k=>{
      let kv=_Util._eval(`/"${k}":.+/`)
      _options=_options.replace(kv,`"${k}": ${_funMap[k].split("\n").join("\n  ")},`)
    })

    _options=_options.replace(/\,$/,"}")
    if(a.type==6){
      _options=_options.replace(/^, */,"")
      return `$script.${_fun}(${_options})`
    }else{
      return `$script.${_fun}(${_element}${_value}${_options})`
    }
    
    function _parseFun(){
      if(a.apiReplaceEvent){
        _fun="api"
        return
      }
      switch(a.type){
        case 0:
          if(a.method==1){
            _fun="validateScript"
          }else{
            let _type=a.content.type
            if(_type=="data"){
              _fun="validateData"
            }else if(_type=="innerText"){
              _fun="validateText"
            }else if(_type=="exist"){
              _fun="validateExist"
              break
            }else if(_type=="unexist"){
              _fun="validateUnexist"
              break
            }else if(_type=="value"){
              _fun="validateValue"
            }else if(_type=="enable"){
              _fun="validateEnable"
              break
            }else if(_type=="disable"){
              _fun="validateDisable"
              break
            }
            _value=","+JSON.stringify(a.expection)
          }
          break
        case 1:
          if(a.event.type=="mouse"){
            if($script[a.event.action]){
              _fun=a.event.action
              if(a.event.button==2){
                _fun="rightClick"
              }
            }else{
              _fun="mouse"
              _value=`, "${a.event.action}"`
            }
          }else{
            if(a.event.type=="change"){
              _fun="set"
            }else{
              _fun="typing"
            }
            _value=a.event.value
            if(_value){
              if(_Util._isRegexData(_value)){
                _value=", "+_value
              }else if(_Util._hasCode(_value)){
                // if(_value.match(/^\{\{[^\}]+\}\}$/)){
                  // _value=_value.substring(2,_value.length-2)
                // }
                _value=", "+JSON.stringify(_value)
              }else{
                _value=", "+JSON.stringify(_Util._strToJson(_value),0,2)
              }
            }else{
              _value=", ''"
            }
          }
          break
        case 2:
          _fun="get"
          let s=a.script||""
          if(s.constructor==Function){
            s=s.toString()
          }else{
            s=JSON.stringify(s)
          }
          _value=", "+s
          break
        case 3:
          _fun="script"
          break
        case 4:
          _fun="callTest"
          break
        case 5:
          _fun="alert"
          break
        case 6:
          _fun="gotoUrl"
          _fun="refreshData"
          break
        case 7:
          _fun="group"
          break
        case 8:
          _fun="visitLinks"
          break
        case 9:
          _fun="validateFormFields"
      }
    }

    function _parseOptions(){
      let ov={},
          ks=_ideActionData._dataStructure[_ideActionData._keys[a.type]],
          _ignoreKeys=["apiReplaceEvent","element","script","successGoto","failedGoto","errorGoto","refOfSuccess","refOfFailed","refOfError","successParameter","failedParameter","errorParameter","type","key","cameraMd5","css","qpath","cameraMd5","content","expection"]
      if((a.type==0&&a.method==1)||a.type==3){
        _ignoreKeys.shift()
      }
      for(let k in a){
        if(k=="requests"&&a.apiReplaceEvent){
          let r=a[k][0]
          if(r.headers){
            r.headers=_Util._strToJson(r.headers)
          }
          if(r.query){
            r.query=_Util._strToJson(r.query)
          }
          if(r.data){
            r.data=_Util._strToJson(r.data)
          }
          return JSON.stringify(r,0,2)
        }
        if(!ks.includes(k)||["",null,undefined].includes(a[k])||_ignoreKeys.includes(k)){
          continue
        }else if(k=="event"&&!["mouse","typing"].includes(_fun)){
          continue
        }else if(k=="compareMark"&&a[k]=="=="){
          continue
        }else if(a[k]==0){
          continue
        }
        let nk=k
        if(k=="min"){
          nk="delay"
        }else if(k=="max"){
          nk="timeout"
        }else if(k=="md5"){
          nk="value"
        }else if(k=="loopData"){
          _handleScript(a[k],ov,"preScript")
          _funMap.preScript=ov.preScript
          continue
        }else if(k=="resultscript"){
          _handleScript(a[k],ov,"endScript")
          _funMap.endScript=ov.endScript
          continue
        }
        let v=a[k]
        if(v.constructor==String){
          if($.isNumeric(v)){
            v=parseFloat(v)
          }else{
            v=_Util._strToJson(v)
          }
        }
        ov[nk]=v
      }
      _parseCombo(ov)
      if(a.type!=4){
        _parseResult(ov,"onsuccess","refOfSuccess","successParameter","successGoto");
      }
      _parseResult(ov,"onfailed","refOfFailed","failedParameter","failedGoto")
      _parseResult(ov,"onerror","refOfError","errorParameter","errorGoto")
      if(!_Util._isEmpty(ov)){
        let vs=Object.values(ov)
        if(vs.length==1&&(vs[0].constructor==Number||(vs[0].constructor==String&&!_Util._isFunction(vs[0])))){
          ov=JSON.stringify(ov)
        }else{
          ov=JSON.stringify(ov,0,2)
        }
        return ", "+ov
      }
      return ""
    }
    
    function _handleScript(s,o,k){
      if(s){
        if(!_Util._isFunction(s)){
          // s=s.trim().split("\n")
          // if(s[0].trim().endsWith(",")){
          //   s[s.length-1]="return "+s[s.length-1]
          // }else{
          //   s[0]="return "+s[0]
          // }
          // s=s.join("\n")
          // s=`()=>{\n  ${s.trim().split("\n").join("\n  ")}\n}`
          // return s
        }else{
          s=s.replace(/\((.+)\)\(\)$/s,"$1")
        }
        if(o){
          o[k]=s
        }
        return s
      }
    }
    
    function _parseCombo(o){
      if(a.type==1&&a.event&&a.event.repElementMethod){
        let aa=a.event
        o.combo={}
        o=o.combo
        if(aa.repElementMethod){
          o.repElementMethod=aa.repElementMethod
        }
        if(aa.repInterval){
          o.repInterval=aa.repInterval
        }
        if(aa.responseElement){
          o.responseElement=aa.responseElement
        }
      }
      
    }
    
    function _parseResult(o,on,r,p,f){
      if(a[on]){
        o[on]=a[on]
        return
      }
      let s=a[r]
      o[on]={}
      let oo=o[on]
      if(s){
        let def="."
        if(on=="onfailed"){
          def=_IDE._data._setting.content.defFailResponse||".."
        }else if(on=="onerror"){
          def=".."
        }
        if(s&&s!=def&&s!=def+"/"){
          s=s.split("/").filter(x=>x)
          s.forEach(y=>{
            if(y!=def){
              if(y[0]=="."){
                oo.action=_scriptActionHandler._action[y]
              }else if(y.length==1){
                oo.result=_scriptActionHandler._action[y]
              }else{
                oo.test=y
              }
            }
          })
          
          if(a[p]){
            oo.parameter=_Util._strToJson(a[p])
          }
        }
      }
      if(a[f]){
        oo.goto=a[f]
      }
      if(_Util._isEmpty(oo)){
        delete o[on]
      }
    }

    function _parseElement(){
      let e=a.element
      if(!e){
        return
      }
      e=_Util._clone(e);
      
      if(!_Util._isEmpty(_panel)){
        if(_panel.find((x,i)=>{
          if(e[i]!=x){
            return 1
          }
        })){
          return e
        }
        e.splice(0,_panel.length)
      }else if(e[0]=="BZ.TW.document"){
        e.shift()
      }else{
        return e
      }
      let _idx=e.pop()
      if($.isNumeric(_idx)){
        if(_idx!=0){
          e.push(_idx)
          return e
        }
      }else{
        e.push(_idx)
      }
      if(e.length>2){
        return e
      }
      if(e.length>1){
        _panel=e[0].match(/^:panel\(([^\)]+)\)/)
        if(_panel){
          _panel=_panel[1]
          e.shift()
        }else{
          return e
        }
      }else{
        _panel=0
      }
      
      e=e[0]
      let w;
      if(a.type==1){
        if(a.event.type=="mouse"){
          w=e.match(/^:text\(([^\)]+)\)$/)
        }else{
          w=e.match(/^:input\(([^\)]+)\)$/)
        }
      }else if(a.type==2){
        w=e.match(/^:data\(([^\)]+)\)$/)
      }
      
      if(w){
        w=w[1]
        if(_panel){
          return _panel+" > "+w
        }else{
          return w
        }
      }else if(_panel){
        return _panel+" > "+e
      }
      return e
    }
  },
  _actionToText:function(a){
    let _element=_getElementDesc(),
        _action
        
    return (_getMessage()+" "+(_getOption()||"")).trim()
    function _getMessage(){
      _msg=_bzMessage._script._templates[a.type]
      switch(a.type){
        case 0:
          if(a.method==1){
            return _Util._formatMessage(_msg.script,a.script)
          }else{
            return _Util._formatMessage(_msg[a.content.type],a.script||_element,a.expection)
          }
        case 1:
          if(a.apiReplaceEvent){
            return "/"+"/API"
          }else{
            let c=_ideActionManagement._getComDataFromElement(a)
            if(c){
              return c.$fun+" "+c.$label+" = "+c.$value
            }
            return _Util._formatMessage(_msg[a.event.action]||_msg[a.event.type]||`${a.event.action}: {0}`,[_element,a.event.value||_getElementDesc(a.event.element)])
          }
        case 2:
        case 8:
        case 9:
          return _Util._formatMessage(_msg,_element)
        case 3:
          return _Util._formatMessage(_msg,_Util._getStringBySize((a.script||"").split("\n").map(x=>x.trim()).join(" ")))
        case 4:
          return _Util._formatMessage(_msg,_ideTestManagement._getStdDescription(a.refOfSuccess))
        case 5:
          return _Util._formatMessage(_msg,a.description)
        case 6:
        case 7:
          return _Util._formatMessage(_msg,a.description)
      }
    }
    
    function _getOption(){
      let _msg=_bzMessage._script._options
      let w=""
      if(a.flag){
        w+=", "+_msg._flag+": "+a.flag
      }
      if(a.min){
        w+=", "+_msg._delay+": "+a.min
      }
      if(a.max){
        w+=", "+_msg._timeout+": "+a.max
      }
      if(a.successGoto){
        w+=", "+_msg._successGotoFlag+": "+a.successGoto
      }
      if(a.failedGoto){
        w+=", "+_msg._failedGotoFlag+": "+a.failedGoto
      }
      if(a.errorGoto){
        w+=", "+_msg._errorGotoFlag+": "+a.errorGoto
      }
      let t=_ideTestManagement._getStdDescription(a.refOfSuccess)
      if(t){
        w+=", "+_msg._successGotoTest.split("|")[0]+": "+t
      }
      t=_ideTestManagement._getStdDescription(a.refOfFailed)
      if(t){
        w+=", "+_msg._failedGotoTest.split("|")[0]+": "+t
      }
      t=_ideTestManagement._getStdDescription(a.refOfError)
      if(t){
        w+=", "+_msg._errorGotoTest.split("|")[0]+": "+t
      }
      if(w){
        return "("+w.substring(2)+")"
      }
    }

    function _getElementDesc(){
      let e=_Util._clone(a.element)
      if(!_Util._isEmpty(e)){
        let w=_descAnalysis._retrieveTextForElementPathItem(e)
        if(!w){
          e.reverse()
          w=e.find(x=>{
            if(!$.isNumeric(x)){
              return 1
            }
          })
        }
        return w
      }
    }
  },
  _assignToTask:function(a){
    $script.newList.forEach((x,i)=>{
      x._fromAction=a._idx,
      x._supData=a._supData,
      x._idx=0-i-1
      x._path=a._supData._path.replace("/actions",x._idx)
    })
    _ideTask._assignOneAction($script.newList)
    _ideTask._data._taskQueue.unshift(...$script.newList)
    $script.newList=[]
  },
  _addScriptAction:function(_type,v){
    if(_type=="api"){
      let d= {
        type:1,
        apiReplaceEvent:"on",
        requests:[v]
      }
      $script.newList.push(d)
      return d
    }
    let o=v._option||{}
    let d={
      type:_type,
      element:_scriptActionHandler._buildElementPath(v._element,_type==1&&v._value?"input":_type==2?"data":"text")
    }
    if(v._script){
      d.script=v._script
    }
    _attachOptions()
    if(_type!=7){
      $script.newList.push(d)
    }


    switch(_type){
      case 0:
        _buildValidate();
        break;
      case 1:
        _buildEvent();
        break
      case 2:
        d.element=_scriptActionHandler._buildElementPath(v._element,"data")
        if(!v._storeData){
          // d.script=
        }else if(v._storeData.includes("=")){
          d.script=v._storeData
        }
        break
      case 3: //script
        d.element=_scriptActionHandler._buildElementPath(o.element,"text"),
        d.runInIDE=v.runInIDE
        break
      case 4://call test
        _buildCallTest()
        break
      case 5: //alert
        d.description=v._msg
        break
      case 6: //refresh
        _buildRefresh()
        break
      case 7: //group
        _buildGroup()
    }
    if(_ideActionManagement._getComDataFromElement(d)){
      delete d.event
      d.type=4
    }
    return d

    //0:
    function _buildValidate(){
      d.method=v._method||0
      d.expection=v._data
      d.content=v._content
      if(v._equal){
        d.compareMark="=="
      }
    }
    //1:
    function _buildEvent(){
      if(v._doSet){
        d.element=_scriptActionHandler._buildElementPath(v._element,"input")
        
        d.event={
          autoBlur:"on",
          type:"change",
          value:v._value
        }
      }else{
        d.element=_scriptActionHandler._buildElementPath(v._element,"text")
        d.event={
          type:"mouse",
          action:v._action||"click",
          button:v._button||1,
          element:_scriptActionHandler._buildElementPath(v._toElement)
        }
        if(v._from){
          d.event.x=v._from.x
          d.event.y=v._from.y
        }
        if(v.to){
          d.event.moveToX=v.to.x
          d.event.moveToY=v.to.y
        }
      }
    }
    //2:
    function _buildExtract(){
      if(v._value){
        d.element=_scriptActionHandler._buildElementPath(v._element,"input")
        
        d.event={
          autoBlur:"on",
          type:"change",
          value:v._value
        }
      }else{
        d.element=_scriptActionHandler._buildElementPath(v._element,"text")
        d.event={
          type:"mouse",
          action:v._action||"click",
          button:v._button||1,
          element:_scriptActionHandler._buildElementPath(v._toElement)
        }
        if(v._from){
          d.event.x=v._from.x
          d.event.y=v._from.y
        }
        if(v.to){
          d.event.moveToX=v.to.x
          d.event.moveToY=v.to.y
        }
      }
    }
    //4:
    function _buildCallTest(){
      let t=v._test
      if(!t.match(/^m[0-9]+\.t[0-9]+$/)){
        let tt=t.split("."),m;
        if(tt.length==2){
          m=_ideModuleManagement._getItemByName(tt[1])
        }else{
          m=_IDE._data._curModule._data
        }
        if(m){
          tt=_ideTestManagement._getItemByName(tt[1],m)
          if(tt){
            t=m.code+"."+tt.code
          }
        }
      }
      if(t){
        d.refOfSuccess=t
        d.successParameter=v._parameter||o.parameter||o.successParameter||o.data
        if(d.successParameter&&[Object,Array].includes(d.successParameter.constructor)){
          d.successParameter=JSON.stringify(d.successParameter,0,2)
        }
        delete d.element
      }
    }
    //6:
    function _buildRefresh(){
      if(o.loadURL){
        d.loadURL=o.loadURL
        d.refreshType=""
      }else{
        d.refreshType="data"
        d.refreshData=o.refreshData
      }
    }
    //:7
    function _buildGroup(){
      let as=v._actions
      if(as.constructor==Function){
        as=as()
      }
      as.forEach((a,i)=>{
        a.inGroup="on"
        if(!$script.newList.includes(a)){
          $script.newList.push(a)
        }
        if(!i){
          $script.newList.splice($script.newList.indexOf(a),0,d)
        }
      })
    }
    
    function _attachOptions(){
      if(o){
        for(let k in o){
          let kk=k
          if(k=="preScript"){
            k="loopData"
          }else if(k=="endScript"){
            k="resultscript"
          }else if(k=="delay"){
            k="min"
          }else if(k=="timeout"){
            k="max"
          }else if("onsuccess,onfailed,onerror".includes(k)){
            let kk=k.substring(2)
            _toCondition(d,o[k],"refOf"+_Util._toCapitalWord(kk),kk+"Parameter",kk+"Goto",k)
            continue
          }else if(k=="combo"){
            d.event=d.event||{}
            d.event.responseElement=o[k].responseElement
            d.event.repElementMethod=o[k].repElementMethod
            d.event.repInterval=o[k].repInterval
            continue
          }
          if(!d[k]||d[k].constructor!=Object||!o[kk]||o[kk].constructor!=Object){
            d[k]=o[kk]
            if(d[k]&&d[k].constructor==Function){
              d[k]=`(${d[k].toString()})()`
            }
          }else{
            Object.assign(d[k],o[kk])
          }
        }
      }
    }
    
    function _toCondition(d,od,r,p,f,e){
      if(od){
        if(od.constructor==Object){
          if(od.goto){
            d[f]=od.goto
          }
          d[r]=""
          if(od.test){
            d[r]+=od.test+"/"
          }
          if(od.result){
            d[r]+=od.result[0].toLowerCase()+"/"
          }
          if(od.action){
            d[r]+=(od.action=="continue"?".":od.action=="stop"?"..":od.action=="stop-group"?"...":"....")+"/"
          }
          if(!d[r]){
            delete d[r]
          }
        }else{
          d[e]=od
        }
      }
    }
  },
  _buildFormActions:function(d,o){
    o=o||{}
    if(!o.labelMap){
      o.labelMap={}
    }
    if(!o.com){
      o.com={}
    }
    o.labelMap=o.labelMap||{}
    o.ignoreFields=o.ignoreFields||[]
    if(d.constructor==Object){
      let ks=o.order||Object.keys(d),
          pk=_getDataPath()
      d=ks.map(k=>{
        if(o.skipOnEmpty&&!d[k]&&d[k]!==0){
          return
        }else if(o.ignoreFields.includes(k)){
          return
        }
        let v= {
          label:o.labelMap[k]||_Util._idToName(k),
          value:pk?`{{${pk}.${k}}}`:d[k]
        }
        if(o.com[k]){
          v.label=":"+o.com[k]+"("+v.label+")"
        }
        return v
      }).filter(x=>x)
    }
    if(o.panel){
      $script.panel=_scriptActionHandler._buildElementPath(o.panel)
    }
    d.forEach(x=>{
      if(o.clickList){
        o.clickList.find(y=>{
          if(y.preField==x.label){
            $script.click(y.button||y.link||y.text)
          }
        })
      }
      $script.set(x.label,x.value)
    })
    if(o.panel){
      $script.panel=0
    }
    
    function _getDataPath(){
      let _key
      if(d==$parameter){
        _key="$parameter"
      }else if(d==$loop){
        _key="$loop"
      }else if(Object.keys($test||{}).find(k=>{
        if(d==$test[k]){
          _key="$test."+k
          return 1
        }
      })){
      }else if(Object.keys($module||{}).find(k=>{
        if(d==$module[k]){
          _key="$module."+k
          return 1
        }
      })){
      }else if(Object.keys($project||{}).find(k=>{
        if(d==$project[k]){
          _key="$project."+k
          return 1
        }
      })){
      }
      return _key
    }
  },
  _parseTxtToAction:function(v){
    let _msg=_bzMessage._script._matchDesc,as=[],
        _action=_bzMessage._script._actionMap
    v=v.split("\n")
    v.forEach(x=>{
      x=x.trim()
      if(!x){
        return
      }
      try{
        Object.keys(_msg).find(k=>{
          let w=_msg[k]
          w=x.match(w)
          if(w){
            w.shift()
            let a=_Util._clone(_action[w.shift().toLowerCase()])
            w=w.map(y=>_parseText(y))
            if(!a){
              return $script.fillform(_Util._eval(w[0]))
            }
            as.push(a)


            _parseOption(a,w[w.length-1])

            switch(a.type){
              case 0:
                if(a.method==1){
                  a.script=w[0]
                  return 1
                }
                if(w[2]){
                  a.expection=w[2]
                }
                a.element=_scriptActionHandler._buildElementPath(w[0],"data")
                return 1
              case 1:
                if(a.event.type!="mouse"){
                  if(w[2]){
                    a.event.value=w[2]
                  }
                  a.element=_scriptActionHandler._buildElementPath(w[0],"input")
                }else{
                  a.element=_scriptActionHandler._buildElementPath(w[0],"text")
                }
                return 1
              case 2:
                if(w[1]){
                  a.script=w[1]
                }
                a.element=_scriptActionHandler._buildElementPath(w[0],"text")
                return 1
              case 3:
                a.script=w[0]
                return 1
              case 4:
                a.refOfSuccess=_ideTestManagement._getTestKeyFromText(w[0])
                return 1
              case 5://alert
              case 7://group
                a.description=w[0]
                return 1
              case 6:
                if(!a.refreshType){
                  a.loadURL=w[0]
                }else{
                  a.refreshData=w[0].split(/[,;，；]/)
                }
              // case 8:
              // case 9:
            }
            
          }
        })
      }catch(ex){
        alert(_Util._formatMessage(_bzMessage._script._parseTxtFailed,[x,ex.message]))
      }
    })
    return as
    function _parseText(v){
      let vv=(v||"").match(/(".+"|'.+'|`.+`|“.+”|‘.+’|·.+·)/)
      if(vv){
        v=vv[0]
        v=v.substring(1,v.length-1)
      }
      return v
    }
    
    function _parseOption(d,v){
      if(v){
        let _msg=_bzMessage._script._options;
        v=v.toLowerCase().trim().split(/[,;]/)
        v.forEach(x=>{
          x=x.split(/[=:]/)
          x[0]=x[0].toLowerCase()
          if(x[0].includes(_msg._alwaysSuccess)){
            d.refOfFailed=d.refOfError="./s"
          }else if(x[0].includes(_msg._successGotoFlag)){
            d.successGoto=v[1]
          }else if(x[0].includes(_msg._failedGotoFlag)){
            d.failedGoto=v[1]
          }else if(x[0].includes(_msg._errorGotoFlag)){
            d.errorGoto=v[1]
          }else if(x[0].match(_Util._eval(`/${_msg._successGotoTest}/`))){
            d.refOfSuccess=_getTest(v[1])
          }else if(x[0].match(_Util._eval(`/${_msg._failedGotoTest}/`))){
            d.refOfFailed="./"+_getTest(v[1])
          }else if(x[0].match(_Util._eval(`/${_msg._errorGotoTest}/`))){
            d.refOfError="./"+_getTest(v[1])
          }else if(x[0].includes(_msg._timeout)){
            d.max=parseInt(v[1])
          }else if(x[0].includes(_msg._delay)){
            d.min=parseInt(v[1])
          }else if(x[0].includes(_msg._flag)){
            d.flag=parseInt(v[1])
          }
        })
      }
    }
  },
  _buildElementPath:function(x,_type){
    _type=_type||"text"
    if(x){
      let p=_getPanel()
      if(x.constructor==String){
        x=x.split(">")
        while(x.length>1){
          p.push(`:panel(${x.shift().trim()})`)
        }
        x=x[0].trim()
        let xx=_JSHandler._parseCode(x)
        if(xx.constructor==String){
          xx=[{txt:xx}]
        }
        if(x.match(/^\$(parameter|test|loop|project|module|group|action)(\.|\[|$])/)){
          x=`{{${x}}}`
          x=":"+_type+"("+x+")"
        }else if(!xx.find(y=>{
          if(y.txt){
            return y.txt.match(/([\.\#].+|[\[][^\]]+[\]]|\:[^\(]+\([^\)]+\))/)
          }
        })){
          x=":"+_type+"("+x+")"
        }
        x=[...p,x,0]
      }else if(x.constructor==Array){
        if(!x[0].includes("BZ.TW")){
          x=[...p,...x]
        }
      }
      return x
    }else if(x!==undefined){
      return [..._getRoot(),"BODY",0]
    }

    function _getPanel(){
      let p=$script.panel,
          r=_getRoot()
      if(p){
        if(p.constructor==String){
          p=[r,p]
        }else if(!p[0].includes("BZ.TW")){
          p=[r,...p]
        }
        return p.filter(x=>!$.isNumeric(x))
      }else{
        return [r]
      }
    }

    function _getRoot(){
      if($.isNumeric($script.iframeIdx)){
        return "$(BZ.TW.document).findIframe("+$script.iframeIdx+")"
      }else{
        return "BZ.TW.document"
      }
    }
  }
};var _stdComponent={
  _getCheckboxRadioViewDef:function(d){
    let _chk={
      _tag:"input",
      _attr:d._attr||{
        id:d.id,
        checked:d._checked,
        type:d._type||"checkbox",
        style:d._style,
        disabled:d._disabled||("!BZ._isCheckout()||"+(d._exDisabled||"0"))
      },
      _dataModel:d._dataModel,
      _jqext:d._jqext
    }
    if(!d._label){
      return _chk
    }
    let v={
      _if:d._if,
      _data:d._data,
      _after:d._after,
      _update:d._update,
      _tag:"div",
      _attr:{
        class:(d._boxClass||"")+" bz-help-bar",
        style:d._boxStyle||"line-height:30px;"
      },
      _items:[
        {
          _tag:"label",
          _attr:{
            title:d._ariaLabel,
            style:d._labelBoxStyle,
            disabled:d._disabled
          },
          _items:[
            _chk,
            {
              _tag:"span",
              _attr:{
                style:d._labelStyle||(curUser.language=='cn'?'position:relative;top:-1px;':"position:relative;top:0px;")
              },
              _text:d._label
            },
            _uiHandler._getHelperIcon({
              _msg:d._help
            })
          ]
        }
      ]
    }
    if(d._link){
      v._items.push({
        _if:d._link._if,
        _tag:"a",
        _attr:{
          class:d._link._class,
          style:d._link._style
        },
        _items:[
          {
            _text:d._link._label,
          },
          _uiHandler._getHelperIcon({
            _msg:d._link._help||d._link._ariaLabel
          })
        ],
        _jqext:d._link._jqext
      })
    }else if(d._btn){
      v._items.push(_stdComponent._getButtonViewDef(d._btn))
    }
    return v
  },
  _getSelectViewDef:function(d){
    let vv={
      _tag:"select",
      _after:d._after,
      _update:d._update,
      _attr:d._attr||{
        class:d._class||"form-control"+(d._exClass||""),
        style:d._style,
        disabled:d._disabled||(d._chk&&"!"+d._chk)||("!BZ._isCheckout()||"+(d._exDisabled||"0"))
      },
      _dataModel:d._dataModel,
      _items:[
        
      ],
      _focus:d._focus,
      _jqext:d._jqext||(d._resizeModelWindow&&{
        change:function(){
          _Util._resizeModelWindow()
        }
      })
    }
    if(d._groups){
      d._groups.forEach(g=>{
        let vvv={
          _tag:"optgroup",
          _attr:{
            label:g._label
          },
          _items:[]
        }
        vv._items.push(vvv)
        _buildOptionGroup(g,vvv)
      })
    }else{
      _buildOptionGroup(d,vv)
    }
    if(!d._label&&!d._btn&&!d._btns){
      return vv
    }
    let v={
      _if:d._if,
      _tag:"div",
      _attr:{
        class:(d._boxClass||"input-group"),
        style:d._boxStyle
      },
      _items:[
      ]
    }
    
    if(d._label){
      v._items.push({
        _tag:"label",
        _attr:{
          class:d._labelClass||("input-group-addon "+(d._required?"required":"")),
        },
        _items:[
          {
            _text:d._label
          },
          _uiHandler._getHelperIcon({
            _msg:d._help||d._ariaLabel
          })
        ]
      })
    }else{
      vv._if=d._if
    }
    v._items.push(vv);
    _stdComponent._insertInputButtonViewDef(d,v)
    return v
    function _buildOptionGroup(d,vv){
      if(d._empty||d._emptyDesc){
        vv._items.push({
          _tag:"option",
          _attr:{
            value:""
          },
          _text:d._emptyDesc||`_bzMessage._common["${d._empty}"]`
        })
      }
  
      if(d._preOptions){
        d._preOptions.forEach(x=>{
          vv._items.push(_buildOption(x))
        })
      }
      vv._items.push(_buildOption(d));  
    }
    function _buildOption(d){
      return {
        _tag:"option",
        _after:d._optionAfter,
        _attr:{
          value:d._value||"_data._item._value||_data._key",
          style:d._optionStyle,
          title:d._optionTitle,
          class:d._optionClass
        },
        _text:d._text||"_data._item._text||_data._item",
        _dataRepeat:d._dataRepeat
      }
    }
  },
  _getTextareaViewDef:function(d){
    return {
      _if:d._if,
      _tag:"div",
      _attr:{
        class:(d._boxClass||"col-xs-12")+" bz-help-bar"
      },
      _items:[
        {
          _tag:"div",
          _attr:{
            class:d._labelClass||"col-xs-12"
          },
          _items:[
            {
              _text:d._label
            },
            _uiHandler._getHelperIcon({
              _msg:d._help
            })
          ]
        },
        {
          _tag:"textarea",
          _after:d._after,
          _attr:d._attr||{
            spellcheck:false,
            class:d._class||"bz-editor"+(d._exClass||""),
            readonly:d._readonly,
            disabled:d._disabled||("!BZ._isCheckout()||"+(d._exDisabled||"0")),
            placeholder:d._placeholder,
            required:d._required,
            style:d._style||("height:100px;padding:5px;"+(d._exStyle||""))
          },
          _text:d._value,
          _focus:d._focus,
          _dataModel:d._dataModel,
          _jqext:d._jqext
        }
      ]
    }
  },
  _getInputViewDef:function(ds){
    let _single
    if(ds.constructor!=Array){
      ds=[ds]
      _single=1
    }
    let vs=ds.map(d=>{
      if(d._type=="checkbox"||d._type=="radio"){
        return _stdComponent._getCheckboxRadioViewDef(d)
      }else if(d._type=="select"){
        return _stdComponent._getSelectViewDef(d)
      }else if(d._type=="textarea"){
        return _stdComponent._getTextareaViewDef(d)
      }else if(d._type=="test"){
        return _uiHandler._getTestList({
          _title:d._label,
          _dataModel:d._dataModel,
          _afterSetValue:d._afterSetValue
        })
      }else if(d._src){
        return d._src
      }
      let v={
        _if:d._if,
        _tag:"div",
        _attr:{
          class:(d._boxClass||"input-group"),
          style:d._boxStyle
        },
        _update:d._update,
        _items:[
          {
            _tag:"label",
            _attr:{
              class:"input-group-addon "+(d._labelClass||"")+(d._required?" required":"")
            },
            _items:[
              {
                _if:d._chk?1:0,
                _tag:"input",
                _attr:{
                  type:"checkbox"
                },
                _dataModel:d._chk,
                _jqext:d._chkJqext
              },
              {
                _tag:"span",
                _text:d._label
              },
              _uiHandler._getHelperIcon({
                _msg:d._help||d._ariaLabel,
                _style:"margin-left: 5px !important;margin-right: -5px;"
              })
            ]
          }
        ]
      }
      
      if(d._options){
        d._options.forEach(x=>{
          v._items.push(_buildItem(x,x._if))
        })
      }else if(!d._label){
        return _buildItem(d,d._if)
      }else{
        v._items.push(
          _buildItem(d)
        )
      }
      
      if(d._dataList){
        v._items.push({
          _tag:"datalist",
          _attr:{
            id:d._dataList.id
          },
          _items:[
            {
              _tag:"option",
              _attr:{
                value:d._dataList._value
              },
              _text:d._dataList._text,
              _dataRepeat:d._dataList._dataRepeat,
              _jqext:d._jqext
            }
          ]
        })
      }
      _stdComponent._insertInputButtonViewDef(d,v)
      _stdComponent._insertCheckboxViewDef(d,v)
      return v
      
      function _buildItem(d,_if){
        return {
          _if:_if,
          _tag:d._tag||"input",
          _after:d._after,
          _attr:d._attr||{
            id:d.id,
            class:d._class||"form-control "+(d._exClass||""),
            style:d._style,
            autocomplete:d._autocomplete,
            type:d._type||"text",
            readonly:d._readonly,
            placeholder:d._placeholder,
            disabled:d._disabled||(d._chk&&"!"+d._chk)||("!BZ._isCheckout()||"+(d._exDisabled||"0")),
            list:d._dataList&&d._dataList.id,
            value:d._value
          },
          _focus:d._focus,
          _dataModel:d._dataModel,
          _jqext:d._jqext
        }
      }
    })
    if(_single){
      vs=vs[0]
    }
    return vs
  },
  _insertInputButtonViewDef:function(d,v){
    let _btns=d._btns||(d._btn&&[d._btn]);
    if(_btns&&_btns.length){
      v._items.push(_stdComponent._getButtonViewBoxView(_btns))
    }
  },
  _insertCheckboxViewDef:function(d,v){
    if(d._exChk){
      d._exChk._boxClass=d._exChk._boxClass||"input-group-btn bz-input-group-ex"
      d._exChk._boxStyle=d._exChk._boxStyle||" "

      let o=_stdComponent._getCheckboxRadioViewDef(d._exChk)
      v._items.push(o)
    }
  },
  _getButtonViewBoxView:function(_btns){
    if(_btns.constructor!=Array){
      _btns=[_btns]
    }
    let _box={
      _tag:"div",
      _attr:{
        class:"input-group-btn"
      },
      _items:[]
    }
    _btns.forEach(x=>{
      x&&_box._items.push(_stdComponent._getButtonViewDef(x))
    })
    return _box
  },
  _getButtonViewDef:function(d){
    let v={
      _if:d._if,
      _tag:"button",
      _attr:{
        class:d._class||("btn "+d._exClass),
        disabled:d._disabled,
        style:d._style,
        title:d._title
      },
      _items:[
        {
          _text:d._text
        },
        _uiHandler._getHelperIcon({
          _msg:d._help||d._ariaLabel
        })
      ],
      _jqext:d._jqext
    }
    if(!d._class){
      let _setting=d._large?"":" bz-small-btn"
      _setting+=d._primary?" btn-primary":""
      _setting+=d._left?" pull-left":""
      _setting+=d._right?" pull-right":""
      

      if(d._text&&d._icon){
        v._attr.class+=" btn-icon-text "
      }else if(d._icon){
        v._attr.class+=" btn-icon "
      }
      v._attr.class+=" "+(d._icon||"")+_setting
    }
    return v
  },
  _getNoteViewDef:function(d){
    return {
      _if:d._if,
      _tag:"div",
      _attr:{
        class:d._class||"bz-note-text",
        style:d._style
      },
      _text:d._text
    }
  },
  _getBoxViewDef:function(d){
    let v={
      _if:d._if,
      _tag:"div",
      _data:d._data,
      _attr:{
        class:d._class,
        style:d._style
      },
      _items:[]
    }
    if(d._title){
      v._items.push({
        _tag:"div",
        _attr:{
          _tag:"bz-header"
        },
        _text:d._title
      })
    }
    d._items&&d._items.forEach(x=>{
      _addItem(x,v)
    })
    return v
    
    function _addItem(x,v){
      if(x._type=="box"){
        v._items.push(_stdComponent._getBoxViewDef(x))
      }else if(x._type=="_rowbox"){
        let _row={
          _if:x._if,
          _update:x._update,
          _tag:"div",
          _attr:{
            style:"display:flex;"
          },
          _items:[]
        }
        v._items.push(_row)
        x._items.forEach(x=>{
          _addItem(x,_row)
          let o=_row._items.pop()
          o._attr.style=o._attr.style||"flex:1;"
          _row._items.push(o)
        })
      }else if(x._src){
        v._items.push(x._src)
      }else{
        v._items.push(_stdComponent._getInputViewDef(x))
      }
    }
  },
  _getHrWithTitle:function(d){
    return {
      _if:d._if,
      _tag:"div",
      _attr:{
        class:"bz-hr-title"
      },
      _items:[
        {
          _tag:"span",
          _text:d._text
        }
      ]
    }
  },
  _getTestMenuItems:function(){
    return [
      {
        _html:function(d){
          if(d._item){
            if(d._item._parent){
              return _uiHandler._getBadge(d._item._parent._data,d._item._data)
            }else{
              return _uiHandler._getBadge(d._item._data)
            }
          }
        }
      },
      {
        _tag:"span",
        _attr:{
          class:"'bz-small-btn bz-'+_data._item._data.type",
          style:"padding: 0px 5px;margin: 0px 5px 0 0;background-size: 10px !important;position: relative;top: 3px;"
        }
      },
      {
        _text:"_data._item._data.name"
      }
    ]
  },
  _getHoverMenuViewDef:function(d){
    return {
      _tag:"div",
      _attr:{
        class:"bz-hover-box",
        style:d._btnBoxStyle
      },
      _items:[
        {
          _tag:"button",
          _attr:{
            class:d._class||("btn btn-icon bz-small-btn "+d._icon),
            style:d._style
          }
        },
        {
          _tag:"div",
          _attr:{
            class:"bz-menu-with-arrow-"+d._way+" bz-hover-menu",
            style:d._menuStyle
          },
          _items:[
            {
              _tag:"div",
              _attr:{
                class:"bz-menu-with-arrow-out-"+d._way,
                style:d._arrowStyle
              }
            },
            {
              _tag:"div",
              _attr:{
                class:"bz-menu-with-arrow-in-"+d._way,
                style:d._arrowStyle
              }
            },
            {
              _tag:"div",
              _attr:{
                class:"bz-menu-with-arrow-box",
                style:"border: 1px solid var(--menu-color);box-shadow: var(--bz-shadow);border-radius: 5px;"
              },
              _items:d._items
            }
          ]
        }
      ]
    }
  }
};var _timingInfo={
  _message:[],
  _positionKey:"bz-timing-pos",
  _messageKey:"bz-timing-message",
  _highlightKey:"bz-timing-highlight",
  _build:function(_fun){
    //TODO:Remove for tmp
    return
    
    if(_Util._isFunIgnoreInBrowser(["Edge"])){
      return
    }

    if(this._setCmd("window._timingInfo?_timingInfo._build():''")){
      return
    }
    if(!BZ.TW || BZ.TW.closed || !BZ.TW.document || !BZ.TW.document.body){
      return setTimeout(function(){
        _timingInfo._build(_fun)
      },100)
    }
    var _iframe=$(BZ.TW.document).find("#bzInTimeInfo")[0];
    if(!_iframe){
      _iframe=$("<iframe id='bzInTimeInfo' style='width:0px;height:0px;position:fixed;left:0;top:0;z-index:2147483647;border:0 !important;box-shadow:none !important;' class='BZIgnore'></iframe>")[0];
      BZ.TW.document.body.parentNode.append(_iframe);
    }

    if(_fun){
      this._doc=_iframe.contentDocument;
      _fun(_iframe,_iframe.contentDocument)
    }
  },
  _setCmd:function(s){
    if(bzTwComm._isIDE()){
      _extensionComm._setCmd(s);
      return 1;
    }else if(bzTwComm._isExtension() && parent!=window){
      return 1;
    }
  },
  _setTmpInfo:function(m,_timer){
    if(_timingInfo._blockOnIframe()){
      return
    }
    m=(_timingInfo._message||[]).concat(m)
    while(m.length>2){
      m.shift()
    }
    _timingInfo._setInfo(m);
    clearTimeout(_timingInfo._tmpTimer)
    _timingInfo._tmpTimer=setTimeout(function(){
      _timingInfo._end()
    },_timer||5000)
  },
  _blockOnIframe:function(){
    if(BZ._isPlaying()){
      let a=BZ._getCurAction()
      a=a&&a.element
      a=(a&&a[0])||""
      if(a.toLowerCase().includes("iframe")){
        _timingInfo._end()
        return 1
      }
    }
  },
  _setInfo:function(m,i,p){
    //TODO:Remove for tmp
    if(window._ideTask&&_ideTask._curMode!="_demo"){
      return
    }else if($("#bz-demo-window")[0]){
      let o=$("#bz-demo-window i")[0]
      $(o).text(m[0])
      let wr=$("#BZ_Win")[0]
      if(wr){
        wr=wr.getBoundingClientRect()
        let r=o.getBoundingClientRect()
        if(r.height>wr.top&&r.width>wr.left){
          $(o).css({top:wr.bottom+10})
        }else{
          $(o).css({top:0})
        }
      }
      return
    }
    if(bzTwComm._isExtension()||_timingInfo._blockOnIframe()){
      return
    }
    //remove realtime execute action info
    if(!BZ._hasVideo){
      if(!curUser._curProject.setting.infoRunningTest){
        return
      }
      if(BZ._isAutoRunning()||!window.SERVER_HOST){
        return
      }
    }
    if(this._setCmd("_timingInfo._setInfo("+JSON.stringify(m)+")")){
      return
    }
    this._build(_doIt)
    function _doIt(_iframe,doc){
      if(!_iframe.contentDocument){
        return setTimeout(function(){
          _doIt(_iframe,doc)
        },10)
      }
      if(!_iframe.contentDocument.body.innerHTML){
        var _html="<link rel='stylesheet' href='"+SERVER_HOST+"/ide/css/bzInsert.css'/><link rel='stylesheet' href='"+SERVER_HOST+"/ide/css/insert.icons.css'/><div style='background-color: rgba(0, 0, 0, 0.6);float:left;padding:10px;user-select:none;' class='bz-timing-info BZIgnore'></div>"
        _iframe.contentDocument.write(_html)
      }
      var o=doc.createElement("div"),r;
      o.className="bz-item-info";
      o.innerHTML="<div class='bz-info-text'></div><div class='bz-sub-info'></div>";
      _timingInfo._setHighLight()
      i=i||0;
      if(!m[i]){
        return
      }
      localStorage.setItem(_timingInfo._messageKey,JSON.stringify(m))
      if(!i){
        _timingInfo._message=m;
        r=$(doc).find(".bz-timing-info")[0];
        r.innerHTML=""
        r.append(o)
      }else{
        $(p).find(".bz-sub-info")[0].append(o)
      }
      $(o).find(".bz-info-text")[0].innerText=m[i++].trim();
      if(m[i]){
        _timingInfo._setInfo(m,i,o)
      }
      if(r){
        _timingInfo._resize(_iframe,r)
      }
    }
  },
  _end:function(){
    try{
      localStorage.removeItem(this._messageKey)
    }catch(e){}
    this._message=[]
    if(this._setCmd("_timingInfo._end()")){
      return
    }
    try{
      if(BZ.TW && !BZ.TW.closed && BZ.TW.document){
        $(BZ.TW.document).find("#bzInTimeInfo").remove()
      }
    }catch(e){}
  },
  _addInfo:function(_test,_format,_loopValue){
    //TODO:Remove for tmp
    return
    if(_timingInfo._blockOnIframe()){
      return
    }
    if(bzTwComm._isExtension() && parent!=window){
      return ;
    }
    var m=_test._supData.name+" / "+_test.name;
    
    if(_format){
      for(var i=0;i<this._message.length;i++){
        var mm=this._message[i];
        if(mm.startsWith(m)){
          this._message.splice(i);
          break;
        }
      }
      
      m=_Util._formatMessage(_format,[m,_loopValue])
    }
    this._message.push(m)
    this._setInfo(this._message)
  },
  _removeLast:function(){
    //TODO:Remove for tmp
    return
    if(bzTwComm._isExtension() && parent!=window){
      return ;
    }
    this._message.pop();
    this._setInfo(this._message)
  },
  _resize:function(f,p){
    f.style.width="100%";
    f.style.height="50px"
    var r=p.getBoundingClientRect()
    f.style.width=r.width+20+"px";
    f.style.height=r.height+20+"px";
  },
  _setHighLight:function(doc,v){
    doc=doc||this._doc
    localStorage.setItem(this._highlightKey,v+"")
    doc.body.style.backgroundColor="transparent"
    doc.body.style.color="#FFF"
    doc.body.style.overflow="hidden";
  },
  _init:function(){
    //TODO:Remove for tmp
    return
    if(BZ._isAutoRunning()){
      return
    }
    if(this._setCmd("window._timingInfo?_timingInfo._setInfo("+JSON.stringify(this._message)+"):''")){
      return
    }
    this._build(function(p,doc){
      var pos=localStorage.getItem(_timingInfo._positionKey)
      if(pos){
        try{
          pos=JSON.parse(pos)
        }catch(e){
          // console.log("Error josn data: ")
          // console.log(pos)
          return
        }
        if(pos.lx<0){
          pos.lx=0
        }
        if(pos.ly<0){
          pos.ly=0
        }
        if(pos.lx>BZ.TW.innerWidth-50){
          pos.lx=BZ.TW.innerWidth-50
        }
        if(pos.ly>BZ.TW.innerHeight-50){
          pos.ly=BZ.TW.innerHeight-50
        }
        p.style.left=pos.lx+"px";
        p.style.top=pos.ly+"px";
        
      }
      var v=localStorage.getItem(_timingInfo._highlightKey);
      _timingInfo._setHighLight(doc,v)
      var m=localStorage.getItem(_timingInfo._messageKey);
      if(m){
        _timingInfo._setInfo(JSON.parse(m))
      }

      var r=doc.body,x,y,lx,ly;
      r.ondblclick=function(){
        var v=localStorage.getItem(_timingInfo._highlightKey);
        if(v && parseInt(v)){
          v=0
        }else{
          v=1
        }
        _timingInfo._setHighLight(doc,v)
      }
      
      r.onmousedown=function(e){
        x=e.x
        y=e.y
        var pr=p.getBoundingClientRect();
        lx=pr.left;
        ly=pr.top;
      }
      r.onmousemove=function(e){
        if(e.buttons){
          lx=parseInt(p.style.left=(lx+(e.x-x))+"px");
          ly=parseInt(p.style.top=(ly+(e.y-y))+"px");
        }
      }
      r.onmouseup=function(e){
        localStorage.setItem(_timingInfo._positionKey,'{"lx":'+lx+',"ly":'+ly+'}')
        x=y=lx=ly=0;
      }
      r.onselectstart=function(){
        return false;
      }
    })
  }
};var _addOnFormTemplate={
  _tag:"div",
  _attr:{"class":"input-group"},
  _items:[
    {
      _tag:"label",
      _attr:{"class":"input-group-addon"},
      _text:"_data._text"
    },
    {
      _tag:"div",
      _attr:{"class":"input-group-btn"},
      _items:[
        {
          _tag:"button",
          _attr:{"class":"btn btn-icon bz-small-btn"}
        }
      ]
    }
  ]
}

window._uiHandler={
  _sysBtnMap:{},
  _initBZSysBtn:function(){
    let _uiSwitch=BZ._data._uiSwitch;
    _uiHandler._sysBtnMap={
      _popApp:{
        _icon:"bz-popout",
        _title:"_bzMessage._method._popoutApp",
        _style:"margin-top:-8px;",
        _fun:function(){
          BZ._launchCurEnvUrl()
        }
      },
      _locky:{
        _if:"_IDE._data._curModule",
        _icon:function(){
          return _getLockIcon(BZ._data._curPage._obj._data.lockBy)
        },
        _disable:"BZ._data._curPage._obj._data._tmpTest",
        _fun:function(){
          var p=BZ._data._curPage;
          _IDE._lock(p._obj,p._management);
        },
        _mouseover:function(){
          let _this=this,_lockBy=BZ._data._curPage._obj._data.lockBy;

          if(_lockBy){
            var m=_bzMessage._system._info._lockby;
            $(_this).attr({title:m+"..."})
            _userManagement._findItem(_lockBy,function(u){
              if(u.code==curUser.code){
                m+=_bzMessage._system._info._myself;
              }else{
                m+=u.displayName
              }
              $(_this).attr({title:m})
            });
          }else{
            $(_this).attr({title:_bzMessage._method._lock})
          }
        }
      },
      _view:{
        _if:function(){
          let m=_IDE._data._curModule
          if(m&&m._data.bt=="data"){
            _uiSwitch._inTestListDiagram="model"
            _uiSwitch.inFlowView=0
          }else{
            return 1
          }
        },
        _icon:function(){
          return _getViewIcon()
        },
        _menu:[
          {
            _tag:"div",
            _attr:{
              class:"bz-hover",
              onclick:"_ideGUIHandler._switchViewModel(this._data._item)",
            },
            _items:[
              {
                _tag:"input",
                _attr:{
                  type:"radio",
                  checked:function(d){
                    let v
                    
                    if(d._item=="flow"){
                      return _uiSwitch.inFlowView
                    }
                    if(_IDE._data._curTest){
                      v=BZ._userHabit.inDiagram
                    }else if(_IDE._data._curModule){
                      v=_uiSwitch._inTestListDiagram
                    }else{
                      v=_uiSwitch._inListDiagram
                    }
                    return !_uiSwitch.inFlowView&&v==d._item
                  },
                  style:"margin-top:2px;"
                }
              },
              {
                _tag:"button",
                _attr:{
                  class:function(d){
                    var c="bz-table-view"
                    if(d._item=='card'){
                      c="bz-card-view"
                    }else if(d._item=="flow"){
                      c="bz-diagram-view"
                    }else if(d._item=="js"){
                      c="bz-js-view"
                    }else if(d._item=="t"){
                      c="bz-text-view"
                    }else if(d._item=="model"){
                      c="bz-model-view"
                    }
                    return "btn btn-icon bz-small-btn bz-right-space-10 "+c
                  },
                }
              },
              {
                _text:function(d){
                  var w=_bzMessage._method
                  switch(d._item){
                    case "": return w._switchToTable;
                    case "card": return w._switchToCard;
                    case "flow":return w._switchToTree;
                    case "t": return w._switchToDesc;
                    case "js": return w._switchToJS;
                    case "model": return w._switchToModel
                  }
                }
              }
            ],
            _dataRepeat:function(){
              let m=_IDE._data._curModule
              if(_IDE._data._curTest){
                return ["","js","t","flow"]
              }else if(m){
                let vs=["model","","card","flow"]
                
                m=m._data;
                if(!m.bt||["feature","auth","summary"].includes(m.bt)){
                  vs.shift()
                  if(_uiSwitch._inTestListDiagram=="model"){
                    _ideGUIHandler._switchViewModel("")
                  }
                }
                return vs
              }else{
                return ["","card","flow"]
              }
            }
          }
        ]
      },
      _sort:{
        _if:function(){
          let m=_IDE._data._curModule
          return !_IDE._data._curTest&&(!m||(m._data.bt!="data"&&_uiSwitch.inFlowView!="flow"))
        },
        _icon:"bz-sort",
        _title:"_bzMessage._method._sort",
        _menu:[{
          _tag:"div",
          _attr:{"class":"pop-menu"},
          _items:[
            {
              _tag:"li",
              _attr:{"class":"pop-menu-item"},
              _items:[
                {
                  _tag:"button",
                  _attr:{
                    "class":function(d){
                      let c="btn btn-icon bz-small-btn bz-right-space-5 "
                      if(!_IDE._data._curModule||BZ._data._uiSwitch._moduleTab=="module"){
                        c+=_uiSwitch._inModuleSort==d._key?"bz-checkmark":""
                      }else{
                        c+=_uiSwitch._inTestSort==d._key?"bz-checkmark":""
                      }
                      return c
                    }
                  }
                },
                {_tag:"span",_text:"_data._item"}
              ],
              _dataRepeat:"_bzMessage._module._sortby",
              _jqext:{
                click:function(){
                  if(!_IDE._data._curModule||BZ._data._uiSwitch._moduleTab=="module"){
                    _ideVersionManagement._storeSort(this._data._key)
                  }else{
                    _ideModuleManagement._storeSort(this._data._key)
                    if(BZ._data._uiSwitch.inFlowView=='flow'){
                      _guiModuleHandler._drawGUI()
                    }
                  }
                }
              }
            }
          ]
        }]
      },
      _tools:{
        _if:function(){
          let m=_IDE._data._curModule
          if(m&&m._data.bt=="data"){
            _uiSwitch._inTestListDiagram="model"
            _uiSwitch.inFlowView=0
          }else if(m&&m._data.code=="com"){
            return 
          }
          return 1
        },
        _splitBottom:1,
        _icon:"bz-tools",
        _menu:[{
          _if:function(d,c,o){
            $(".pop-tools-menu").html("")
            _IDE._data._curModule;
            _IDE._data._curTest;
            return 1
          },
          _tag:"div",
          _attr:{"class":"pop-menu pop-tools-menu"},
          _items:[
            {
              _tag:"li",
              _attr:{"class":"pop-menu-item"},
              _items:[
                {
                  _if:"_data._item._splitTop",
                  _tag:"hr",
                  _after:function(o){
                    setTimeout(()=>{
                      if(o.parentElement&&o.parentElement.parentElement){
                        o.parentElement.parentElement.insertBefore(o,o.parentElement)
                      }
                    },1000)
                  }
                },
                {
                  _tag:"span",
                  _attr:{
                    "class":function(d){
                      let c="btn-icon bz-right-space-10 "
                      d=d._item._icon
                      if(d.constructor==Function){
                        d=d()
                      }
                      return c+d
                    }
                  }
                },
                {
                  _text:function(d){
                    d=d._item._title
                    if(d.constructor==Function){
                      d=d()
                    }
                    return d
                  }
                }
              ],
              _dataRepeat:function(){
                let t=_IDE._data._curTest,
                    m=_IDE._data._curModule,
                    vs=[]
                m=m&&m._data
                t=t&&t._data

                if(t&&m&&m.code[0]=="m"){
                  vs.push({
                    _icon:"bz-mail",
                    _title:_bzMessage._method._mail,
                    _fun:function(){
                      _ideTrReport._doReport()
                    }
                  });
                }

                if(!m||m.code[0]=="m"){
                  vs.push({
                    _icon:"bz-trends",
                    _title:_bzMessage._log._report._viewTreads,
                    _fun:function(){
                      let _url="/logCurReport/?fun=trends&from="+$util.generateWordsByRegex("/{today-7}/")+"&to="+$util.generateWordsByRegex("/{today}/")
                      // _ideReport._switchReport("trends");
                      if(t){
                        _url+="&test="+m.code+"."+t.code
                      }else if(m){
                        _url+="&module="+m.code
                      }
                      BZ._setHash(_url)
                    }
                  });
                }

                if(t){
                  vs.push({
                    _icon:"bz-compare",
                    _title:_bzMessage._extractData._title,
                    _fun:function(){
                      _extractData._showTools()
                    }
                  });
                }

                if(m&&m.bt=='feature'){
                  vs.push({
                    _icon:"bz-download",
                    _title:_bzMessage._method._downloadFeature,
                    _fun:function(){
                      _bzScenario._showFeatureExport()
                    }
                  });
                }
                if(!t&&m&&m.bt=='feature'&&BZ._isCheckout()){
                  vs.push({
                    _icon:"bz-match",
                    _title:_bzMessage._method._matchLink,
                    _fun:function(){
                      _ideVersionManagement._loadAllData(function(){
                        _bzScenario._matchLink(BZ._getCurPageModule()._data)
                      })
                    }
                  });
                }
                if(t&&t.type=="scenario"&&BZ._isCheckout()){
                  let r=t.actions.find(a=>!_ideActionManagement._getDataStatus(a))
                  if(r&&!t._noReady){
                    t._noReady=1
                  }else if(!r&&t._noReady){
                    t._noReady=0
                  }
                  if(t._noReady){
                    vs.push({
                      _title:_bzMessage._method._matchLink,
                      _icon:"bz-match",
                      _fun:function(){
                        _ideVersionManagement._loadAllData(function(){
                          _bzScenario._matchLink(t)
                        })
                      }    
                    })
                  }
                }

                vs.push({
                  _icon:"bz-monitor",
                  _splitTop:1,
                  _title:_bzMessage._setting._preferences._popWindowStyle,
                  _fun:function(){
                    _ideTestManagement._showPopSizeManagement()
                  }
                },{
                  _title:_bzMessage._tmpDataBase._title,
                  _icon:'bz-tmpdata',
                  _fun:function(){
                    _tmpDataBase._showUI()
                  }
                });

                if(t){
                  vs.push({
                    _icon:function(){
                      let c="bz-expand";
                      if(BZ._data._uiSwitch._showActionParameter){
                        c+=" bz-checked"
                      }
                      return c
                    },
                    _splitTop:1,
                    _title:function(){
                      return BZ._data._uiSwitch._showActionParameter?_bzMessage._method._hideConditionInfo:_bzMessage._method._showConditionInfo
                    },
                    _fun:function(){
                      BZ._data._uiSwitch._showActionParameter=!BZ._data._uiSwitch._showActionParameter
                      BZ._userHabit.showActionParameter=BZ._data._uiSwitch._showActionParameter
                      BZ._storeUserHabit()
                    }
                  },{
                    _icon:"bz-settings",
                    _splitTop:!t,
                    _title:_bzMessage._task._setting,
                    _fun:function(){
                      _Util._confirmMessage({
                        _tag:"div",
                        _items:[
                          {
                            _load:SERVER_HOST+"/ide/js/"+window.ideVersion+"/exViewDefs/action/preference"
                          }
                        ]
                      },[],_bzMessage._task._setting,500)
                    }
  
                  })
                }
                return vs;
              },
              _jqext:{
                click:function(){
                  this._data._item._fun()
                }
              }
            }
          ]
        }]
      },
      // _ref:{
      //   _if:"_IDE._data._curTest&&_IDE._data._curModule._data.code[0]=='m'",
      //   _icon:"bz-ref-list",
      //   _title:"_bzMessage._method._toRef",
      //   _mouseover:function(d){
      //     BZ._data._uiSwitch._showRefMenu=0
      //     this._overTimer=setTimeout(()=>{
      //       _ideTestManagement._toRef(_IDE._data._curTest._data)
      //       BZ._data._uiSwitch._showRefMenu=1
      //     },500)
      //   },
      //   _mouseout:function(){
      //     clearTimeout(this._overTimer)
      //   },
      //   _menuIf:"BZ._data._uiSwitch._showRefMenu",
      //   _menu:[
      //     {
      //       _tag:"div",
      //       _attr:{
      //         class:"bz-hover",
      //         onclick:"BZ._setHash(_data._item);BZ._data._uiSwitch._showRefMenu=0;"
      //       },
      //       _items:_stdComponent._getTestMenuItems(),
      //       // _text:"_ideTestManagement._getStdDescription(_data._item.t,_data._item.m)",
      //       _dataRepeat:function(){
      //         return BZ._data._uiSwitch._refList.map(x=>{
      //           return {
      //             _parent:x.m,
      //             _data:x.t
      //           }
      //         })
      //       }
      //     },
      //     {
      //       _if:"!BZ._data._uiSwitch._refList.length",
      //       _tag:"div",
      //       _attr:{
      //         class:"bz-hover"
      //       },
      //       _text:"_bzMessage._dataBind._empty"
      //     }
      //   ]
      // },
      _disable:{
        _if:"_IDE._data._curTest",
        _icon:"bz-disable",
        _title:"_bzMessage._method._disabled",
        _disable:"!BZ._isCheckout()||!BZ._data._uiSwitch._selectedItems.length",
        _fun:function(){
          var s=BZ._data._uiSwitch._selectedItems;
          var vv=s[0].disable
          s.forEach(function(v){
            v.disable=!vv
          })
          _ideTestManagement._save()
        }
      },
      _group:{
        _if:"_IDE._data._curTest",
        _title:"_IDE._data._curAction&&_IDE._data._curAction.type==7?_bzMessage._method._removeGroup:_bzMessage._method._newGroup",
        _icon:function(){
          let a=_uiSwitch._selectedItems[0]
          return "bz-group "+(a&&a.type==7?"bz-remove-group":"")
        },
        _disable:function(){
          let a=_IDE._data._curAction
          if(!a){
            return 1
          }
          if(_uiSwitch._selectedItems.length&&BZ._isCheckout()){
            if(a.type!=7){
              a=_ideActionManagement._getPreAction(a)
              return a&&a.type==7
            }
          }else{
            return 1
          }
        },
        _fun:function(){
          let s=_uiSwitch._selectedItems
          if(s[0].type==7){
            _ideActionManagement._disbandGroup(s[0])
          }else{
            _ideActionManagement._newGroup(s)
          }
        }
      },
      _generateTest:{
        _if:"_IDE._data._curTest",
        _icon:"bz-generate",
        _title:"_bzMessage._method._newGroupTest",
        _disable:"!BZ._isCheckout()||!BZ._data._uiSwitch._selectedItems.length",
        _fun:function(){
          _ideActionManagement._newGroupTest(_uiSwitch._selectedItems);
        }
      },
      _undo:_optHistoryHandler._getBtnView("_undo"),
      _redo:_optHistoryHandler._getBtnView("_redo"),
      _delete:{
        _if:"!BZ._data._uiSwitch.inFlowView",
        _title:"_bzMessage._method._delete",
        _icon:function(){
          return "bz-delete"
        },
        _disable:function(){
          return !BZ._isCheckout()||(!_uiSwitch._selectedItems.length&&!_IDE._data._curTest)
        },
        _fun:function(){
          let t=_IDE._data._curTest,
              m=_IDE._data._curModule,
              s=_uiSwitch._selectedItems
          if(t){
            if(_aiGeneratorDataHandler._isAIGenerateTest(t)){
              _aiGenerator._generateAITest(t)
            }else{
              s.length?_ideActionManagement._deleteItems(s):_ideTestManagement._deleteTestOrActions(t)
            }
          }else if(s[0]&&s[0].code[0]=="m"){
            _ideModuleManagement._deleteItems(s)
          }else if(m){
            _ideTestManagement._deleteItems(s)
          }else{
            _ideModuleManagement._deleteItems(s)
          }
        }
      },
      _copy:{
        _if:"!BZ._data._uiSwitch.inFlowView",
        _title:"_bzMessage._method._copy",
        _icon:function(){
          return "bz-copy"
        },
        _disable:function(){
          return !BZ._isCheckout()||(!_uiSwitch._selectedItems.length&&!_IDE._data._curTest)
        },
        _fun:function(){
          let s=_uiSwitch._selectedItems,
              t=_IDE._data._curTest,
              m=_IDE._data._curModule
          _IDE._copy((!s||!s.length)&&t?[t._data]:s,0,t?(s.length?"action":"test"):m&&s[0]?"test":"module")
        }
      },
      _paste:{
        _if:"!BZ._data._uiSwitch.inFlowView",
        _title:"_bzMessage._method._paste",
        _icon:"bz-paste",
        _disable:function(){
          let c=_IDE._data._clipData
          if(c){
            if(c.level=="module"){
              return _IDE._data._curTest
            }else if(c.level=="test"){
              return !_IDE._data._curModule
            }else if(c.level=="action"){
              return !_IDE._data._curTest
            }
          }
          return 1
        },
        _fun:function(){
          let c=_IDE._data._clipData,
              t=_IDE._data._curTest,
              m=_IDE._data._curModule
          if(c.level=="test"&&t){
            let d=c.items[0]
            _Util._confirmMessage(_bzMessage._test._askPasteActions,[{
              _title:_bzMessage._method._insert,
              _click:function(c){
                let _idx=d.actions.indexOf(_IDE._data._curAction)
                if(_idx==-1){
                  _idx=t._data.actions.length-1
                }
                d.actions.forEach(a=>{
                  t._data.actions.splice(++_idx,0,a)
                })
                _ideTestManagement._save()
                c._ctrl._close()
              }
            },{
              _title:_bzMessage._method._replace,
              _click:function(c){
                t._data.actions=d.actions
                t._data.enterPoint=d.enterPoint
                _ideTestManagement._save()
                c._ctrl._close()
              }
            }])
          }else if(t){
            _ideActionManagement._paste();
          }else if(m){
            _ideTestManagement._paste()
          }else{
            _ideModuleManagement._paste()
          }
        }
      },
      _setting:{
        _icon:"bz-ex-setting",
        _title:"_bzMessage._method._setting",
        _splitTop:1,
        _fun:function(){
          BZ._advSetting()
        }
      }
    }

    _uiHandler._sysBtnMap=Object.keys(_uiHandler._sysBtnMap).map(k=>{
      let v=_uiHandler._sysBtnMap[k]
      return {
        _if:v._if,
        _tag:"div",
        _attr:{
          class:"bz-hover-box",
          title:v._title
        },
        _items:[
          //split top
          {
            _if:v._splitTop||0,
            _tag:"hr"
          },
          //button
          {
            _tag:"button",
            _attr:{
              class:function(){
                let c='btn btn-icon bz-toolbar-btn '
                if(v._icon.constructor==Function){
                  c+=v._icon()
                }else{
                  c+=v._icon
                }
                return c
              },
              style:v._style,
              disabled:v._disable
            },
            _jqext:{
              click:function(){
                v._fun&&v._fun()
              },
              mouseover:v._mouseover,
              mouseout:v._mouseout
            },
            _items:v._items
          },
          //split bottom
          {
            _if:v._splitBottom||0,
            _tag:"hr"
          },
          //menu
          {
            _if:v._menu?(v._menuIf||1):0,
            _tag:"div",
            _attr:{
              class:"bz-menu-with-arrow-right bz-hover-menu",
              style:"right:calc(var(--bar-width) - 10px);"
            },
            _items:[
              {
                _tag:"div",
                _attr:{
                  class:"bz-menu-with-arrow-out-right",
                  style:"top:10px;"
                }
              },
              {
                _tag:"div",
                _attr:{
                  class:"bz-menu-with-arrow-in-right",
                  style:"top:10px;"
                }
              },
              {
                _tag:"div",
                _attr:{
                  class:"bz-menu-with-arrow-box",
                  style:"max-height:500px;overflow:auto;"
                },
                _items:v._menu
              }
            ]
          }
        ]
      }  
    })

    function _getLockIcon(_lockBy){
      let c="bz-unlock";
      if(_lockBy==curUser._id){
        c="bz-locked"
      }else if(_lockBy){
        c="bz-lock";
      }
      return c
    }
    function _getViewIcon(){
      let t=_IDE._data._curTest,
          m=_IDE._data._curModule,
          c="bz-table-view"
      if(_uiSwitch.inFlowView){
        c="bz-diagram-view"
      }else{
        if(t){
          v=BZ._userHabit.inDiagram
        }else if(m){
          v=_uiSwitch._inTestListDiagram
        }else{
          v=_uiSwitch._inListDiagram
        }
        if(v=="js"){
          c="bz-js-view"
        }else if(v=="t"){
          c="bz-text-view"
        }else if(v=="model"){
          c="bz-model-view"
        }else if(v=="card"){
          c="bz-card-view"
        }
      }
      return c
    }
  },
  _getViewMeun:function(){
    return {
      _if:function(){
        let m=_IDE._data._curModule
        if(m&&m._data.bt=="data"){
          BZ._data._uiSwitch._inTestListDiagram="model"
          BZ._data._uiSwitch.inFlowView=0
        }else{
          return 1
        }
      },
      _tag:"div",
      _attr:{
        class:"bz-hover-box"
      },
      _items:[
        {
          _tag:"button",
          _attr:{
            "class":function(d){
              let _uiSwitch=BZ._data._uiSwitch,
                  c="bz-table-view"
              if(_uiSwitch.inFlowView){
                c="bz-diagram-view"
              }else{
                if(_IDE._data._curTest){
                  v=BZ._userHabit.inDiagram
                }else if(_IDE._data._curModule){
                  v=_uiSwitch._inTestListDiagram
                }else{
                  v=_uiSwitch._inListDiagram
                }
                if(v=="js"){
                  c="bz-js-view"
                }else if(v=="t"){
                  c="bz-text-view"
                }else if(v=="model"){
                  c="bz-model-view"
                }else if(v=="card"){
                  c="bz-card-view"
                }
  
              } 
              return "btn btn-icon "+c+" uipanel pull-right"
            },
          }
        },
        {
          _tag:"div",
          _attr:{
            class:"bz-menu-with-arrow-right bz-hover-menu",
            style:"right:calc(var(--bar-width) - 10px);"
          },
          _items:[
            {
              _tag:"div",
              _attr:{
                class:"bz-menu-with-arrow-out-right",
                style:"top:10px;"
              }
            },
            {
              _tag:"div",
              _attr:{
                class:"bz-menu-with-arrow-in-right",
                style:"top:10px;"
              }
            },
            {
              _tag:"div",
              _attr:{
                class:"bz-menu-with-arrow-box"
              },
              _items:[
                {
                  _tag:"div",
                  _attr:{
                    class:"bz-hover",
                    onclick:"_ideGUIHandler._switchViewModel(this._data._item)",
                  },
                  _items:[
                    {
                      _tag:"input",
                      _attr:{
                        type:"radio",
                        checked:function(d){
                          let _uiSwitch=BZ._data._uiSwitch,v
                          
                          if(d._item=="flow"){
                            return _uiSwitch.inFlowView
                          }
                          if(_IDE._data._curTest){
                            v=BZ._userHabit.inDiagram
                          }else if(_IDE._data._curModule){
                            v=_uiSwitch._inTestListDiagram
                          }else{
                            v=_uiSwitch._inListDiagram
                          }
                          return !_uiSwitch.inFlowView&&v==d._item
                        },
                        style:"margin-top:2px;"
                      }
                    },
                    {
                      _tag:"button",
                      _attr:{
                        class:function(d){
                          var c="bz-table-view"
                          if(d._item=='card'){
                            c="bz-card-view"
                          }else if(d._item=="flow"){
                            c="bz-diagram-view"
                          }else if(d._item=="js"){
                            c="bz-js-view"
                          }else if(d._item=="t"){
                            c="bz-text-view"
                          }else if(d._item=="model"){
                            c="bz-model-view"
                          }
                          return "btn btn-icon bz-small-btn bz-right-space-10 "+c
                        },
                      }
                    },
                    {
                      _text:function(d){
                        var w=_bzMessage._method
                        switch(d._item){
                          case "": return w._switchToTable;
                          case "card": return w._switchToCard;
                          case "flow":return w._switchToTree;
                          case "t": return w._switchToDesc;
                          case "js": return w._switchToJS;
                          case "model": return w._switchToModel
                        }
                      }
                    }
                  ],
                  _dataRepeat:function(){
                    let m=_IDE._data._curModule
                    if(_IDE._data._curTest){
                      return ["","js","t","flow"]
                    }else if(m){
                      let vs=["model","","card","flow"]
                      
                      m=m._data;
                      if(!m.bt||["feature","auth","summary"].includes(m.bt)){
                        vs.shift()
                        if(BZ._data._uiSwitch._inTestListDiagram=="model"){
                          _ideGUIHandler._switchViewModel("")
                        }
                      }
                      return vs
                    }else{
                      return ["","card","flow"]
                    }
                  }
                }
              ]
            }
          ]
        }
      ]
    }
  },
  _getHelperIcon:function(d){
    return {
      _if:d._if||d._msg||0,
      _tag:"button",
      _attr:{
        style:d._style,
        class:"btn btn-icon bz-small-btn bz-help-item bz-left-space-5 hint--rounded hint--"+(d._position||"top")+" "+(d._class||""),
        "aria-label":d._msg
      }
    }
  },
  _getTryScriptBtn:function(d){
    return {
      _if:d._if,
      _tag:"a",
      _attr:{
        disabled:d._disabled,
        class:"btn btn-icon bz-small-btn bz-test pull-right bz-right-space-5"
      },
      _jqext:{
        click:function(){
          let dd=d._data||_IDE._data._curAction
          if(dd&&dd.constructor==String){
            eval("dd="+dd)
          }
          if(!$(this).attr("disabled")){
            _ideTask._tryScript(dd,d._key)
          }
        }
      }
    }
  },
  _popTextEditor:function(t,d){
    _Util._confirmMessage({
      _tag:"div",
      _items:[
        _bzJSEditor._buildJSEditor({
          _model:d,
          _noBtn:1,
          _label:"",
          _desc:"",
          _style:"height:500px"
        })
      ]
    },[],t,"80%")
  },
  _getPickCss:function(d){
    return {
      _tag:"div",
      _attr:{
        class:"input-group bz-path-setting bz-help-bar"
      },
      _items:[
        {
          _tag:"div",
          _attr:{
            class:"input-group-addon bz-no-border"
          },
          _items:[
            {
              _tag:"label",
              _items:[
                {
                  _if:function(){
                    return d._chk
                  },
                  _tag:"input",
                  _attr:{
                    type:"checkbox"
                  },
                  _dataModel:d._chk
                },
                {
                  _tag:"span",
                  _attr:{
                    style:"margin-right:15px;"
                  },
                  _text:d._label
                },
                _uiHandler._getHelperIcon({
                  _msg:d._title
                })
              ]
            },
            {
              _tag:"div",
              _attr:{
                style:"flex:1"
              }
            },
            {
              _tag:"div",
              _attr:{
                class:"bz-path-setting-ctrl"
              },
              _items:[
                {
                  _if:function(){
                    return !d._chk||eval(d._chk)
                  },
                  _tag:"button",
                  _attr:{
                    class:"btn btn-icon bz-dompicker bz-small-btn"
                  },
                  _jqext:{
                    click:function(){
                      _bzDomPicker._pickElement(0,function(v){
                        _bzDomPicker._pickElement(v,function(v){
                          v.pop();
                          v.shift()
                          v=v.join(" ");
                          let f=d._model;
                          if(f.constructor==Function){
                            f=f()
                          }
                          eval(f+'=v')
                          
                          if(_IDE._data._curTest){
                            _ideTestManagement._save()
                          }else{
                            _Util._resizeModelWindow()
                          }
                        })
                      })
                    }
                  }
                },
                {
                  _if:function(){
                    return d._delete
                  },
                  _tag:"button",
                  _attr:{
                    class:"btn btn-icon bz-delete bz-small-btn"
                  },
                  _jqext:{
                    click:function(){
                      d._delete()
                    }
                  }
                }
              ]
            }
          ]
        },
        {
          _if:function(){
            return !d._chk||eval(d._chk)
          },
          _tag:"input",
          _attr:{
            class:"form-control",
            style:"border:0;position: relative;left: 1px;"
          },
          _updateEvent:"change",
          _dataModel:d._model,
          _jqext:{
            click:function(){
              _bzDomPicker._flashMutipleTmpCover(this.value)
            }
          }
        }
      ]
    }
  },
  //d: input, _chkExist: Function
  _getSwitchMenuItem:function(d){
    return {
      _if:d._if,
      _tag:"li",
      _attr:{
        class:function(){
          let c='pop-menu-item '
          if(!BZ._isCheckout(0,1)||(d._disabled&&d._disabled())){
            c+='bz-disabled'
          }
          return c
        }
      },
      _items:[
        //check
        {
          _tag:"button",
          _attr:{
            class:function(){
              let c="btn btn-icon bz-small-btn bz-right-space-5 "
              if(d._chkFun){
                if(d._chkFun()){
                  c+="bz-checkmark"
                }
              }else if(eval(d._dataModel)){
                c+="bz-checkmark"
              }

              return c
            },
          }
        },
        {
          _tag:"span",
          _text:d._text
        }
      ],
      _jqext:{
        click:function(){
          if(!BZ._isCheckout(0,1)||(d._disabled&&d._disabled())){
            return
          }
          let v=eval(d._dataModel)
          
          if(v&&v!=="0"){
            eval(d._dataModel+"=0")
            eval("delete "+d._dataModel)
            if(d._dataModel.includes("repElementMethod")){
              delete _IDE._data._curAction.event.repInterval
              delete _IDE._data._curAction.event.responseElement
            }
          }else{
            eval(d._dataModel+"=d._value||1")
          }
          d._exeFun&&d._exeFun()
          if(_IDE._data._curTest){
            _ideTestManagement._save()
          }
        }
      }
    }
    
  },
  _updateScript:function(d){
    let _btns=[]
    if(d._update){
      _btns.push({
        _title:_bzMessage._method._save,
        _click:function(c){
          d._update()
          c._ctrl._close()
        }
      })
    }
    _Util._confirmMessage({
      _tag:"div",
      _update:d._autoUpdate,
      _items:function(){
        return [
          {
            _if:!!d._label,
            _tag:"div",
            _attr:{
              style:"padding:10px;"
            },
            _text:function(){
              return d._label
            }
          },
          _bzJSEditor._buildJSEditor({
            _model:d._dataModel,
            _noBtn:1,
            _label:"",
            _style:d._jsEditorStyle||"height:400px"
          })
        ]
      }
    },_btns,d._title,d._width)
  },
  _updateKey:function(d,o,_chkExist,_save){
    let v=d.value.trim()
          
    if(!v){
      o.name=d.value=d._oldValue
      d.focus()
      alert(_bzMessage._system._error._requiredField,_bzMessage._common._name)
    }else if(d._oldValue&&d._oldValue!=v&&_chkExist(d.value)){
      o.name=d.value=d._oldValue
      d.focus()
      alert(_bzMessage._system._error.existName)
    }else{
      _save()
      
    }
    
  },
  _getSlider:function(_if,ds,_css){
    let _silderData=_CtrlDriver._buildProxy({_list:[]})
    ds.forEach(x=>{
      _silderData._list.push({
        _rate:x._rate||(1/ds.length)
      })
    })
    return {
      _if:function(){
        return _if?_if(_silderData):1
      },
      _tag:"div",
      _attr:{
        class:"bz-slider-area",
      },
      _after:function(o){
        if(_css){
          $(o).css(_css)
        }
        setTimeout(()=>{
          o=o.getBoundingClientRect().width
          _silderData._list.forEach(x=>{
            x._flex=parseInt(x._rate*o)
          })
        },10)
      },
      _items:[
        {
          _tag:"div",
          _attr:{
            class:"bz-slider-box",
            style:function(d){
              let _itemIf=d._item._if,r
              if(_itemIf){
                if(_itemIf.constructor==Function){
                  r=_itemIf()
                }else{
                  r=eval(_itemIf)
                }
                if(!r){
                  if(d._idx){
                    _silderData._list[0]._hide=0
                  }
                  return "display:none"
                }
              }
              d=_silderData._list[d._idx]
              d=d._flex||d._rate
              if(d<1){
                d=1
              }
              return "display:flex;flex:"+d
            }
          },
          _items:[
            {
              _if:"_data._idx",
              _tag:"div",
              _after:function(o,d){
                let _start,_end
                _Util._setDrag([o],o,0,function(x,y){
                  let o1=_silderData._list[d._idx],
                      o2=_silderData._list[d._idx-1]
                      
                  if(x===undefined){
                    let w1=o.parentElement.getBoundingClientRect().width
                    let w2=o.parentElement.previousSibling.getBoundingClientRect().width

                    o1._flex=w1
                    o2._flex=w2
                    o1._rate=w1/(w1+w2)*_start.r
                    o2._rate=_start.r-o1._rate

                    _start=0
                    $(o.nextSibling).css({"margin-left":0})
                    $(o).css({position:"flex"})
                  }else if(!_start){
                    _start={
                      x:x,
                      w1:o1._flex,
                      w2:o2._flex,
                      r:o1._rate+o2._rate,
                      w:o1._flex+o2._flex
                    }
                  }else{
                    o1._flex=_start.w1+_start.x-x
                    o1._rate=o1._flex/_start.w*_start.r

                    o2._flex=_start.w-o1._flex
                    o2._rate=_start.r-o1._rate
                    
                    if(o1._flex<100){
                      o2._flex=_start.w
                      o2._rate=_start.r
                      o1._flex=1
                      o1._rate=0
                      o1._hide=1
                    }else if(o2._flex<100){
                      o1._flex=_start.w
                      o1._rate=_start.r
                      o2._flex=1
                      o2._rate=0
                      o2._hide=1
                    }else{
                      o1._hide=0
                      o2._hide=0
                    }
                  }
                  return 1
                })
              },
              _attr:{
                class:"bz-slider-bar"
              },
              _jqext:{
                mouseover:function(){
                  $(this).css({height:this.parentElement.getBoundingClientRect().height+"px",left:"unset"})
                },
                mousedown:function(){
                  $(this).css({position:"absolute"})
                  $(this.nextSibling).css({"margin-left":"5px"})
                },
                mouseout:function(){
                  $(this).css({height:"100%"})
                },
                mouseup:function(){
                  $(this.nextSibling).css({"margin-left":"0px"})
                }
              }
            },
            {
              _if:function(d){
                return !_silderData._list[d._idx]._hide
              },
              _tag:"div",
              _attr:{
                class:"'bz-slider-content bz-slider-content-'+_data._idx"
              },
              _items:function(d){
                return [d._item]
              }
            }
          ],
          _dataRepeat:ds
        }
      ]
    }
    
    function _switchContent(_close,_open){
      let o1=_silderData._list[_close]
      let o2=_silderData._list[_open]
      if(o2._rate){
        o2._rate+=o1._rate
        o2._flex+=o1._flex
        o1._rate=0
        o1._hide=1
        o2._hide=0
        o1._flex=1
      }else{
        o2._rate=o1._rate/2
        o2._flex=o1._flex/2
        o1._rate/=2
        o1._hide=0
        o2._hide=0
        o1._flex/=2
      }
    }
  },
  _getTableStyle:function(){
    return {
      _tag:"div",
      _attr:{"class":"input-group bz-top-space-5"},
      _items:[
        {
          _tag:"label",
          _attr:{"class":"input-group-addon"},
          _text:"_bzMessage._setting._tableStyle._title"
        },
        {
          _tag:"select",
          _attr:{"class":"form-control"},
          _dataModel:"BZ._data._uiSwitch._listClass",
          _items:[
            {
              _tag:"option",
              _attr:{
                value:function(d){
                  switch(d._idx){
                    case "large":return "";
                    case "middle":return "bz-middle-table";
                    case "small":return "bz-small-table"
                  }
                }
              },
              _text:"_data._item",
              _dataRepeat:"_bzMessage._setting._tableStyle._options"
            }
          ],
          _jqext:{
            change:function(){
              BZ._userHabit.listClass=this.value
              if(this.value){
                let as=BZ._data._uiSwitch._actionClass;
                if(as=="bz-action-text-and-icon"){
                  BZ._data._uiSwitch._actionClass=BZ._userHabit.actionClass="bz-action-text-only"
                }
              }
              BZ._storeUserHabit()
            }
          }
        }
      ]
    }
  },
  _getActionStyle:function(){
    return {
      _if:"_IDE._data._curTest",
      _tag:"div",
      _attr:{"class":"input-group bz-top-space-5"},
      _items:[
        {
          _tag:"label",
          _attr:{"class":"input-group-addon"},
          _text:"_bzMessage._setting._actionStyle._title"
        },
        {
          _tag:"select",
          _attr:{"class":"form-control"},
          _dataModel:"BZ._data._uiSwitch._actionClass",
          _items:[
            {
              _tag:"option",
              _attr:{
                value:function(d){
                  switch(d._idx){
                    case "icon":return "bz-action-icon-only";
                    case "text":return "bz-action-text-only";
                    case "icontext":return "bz-action-text-and-icon"
                  }
                }
              },
              _text:"_data._item",
              _dataRepeat:function(){
                let vs=_Util._clone(_bzMessage._setting._actionStyle._options)
                if(BZ._data._uiSwitch._listClass){
                  delete vs.icontext
                }
                return vs
              }
            }
          ],
          _jqext:{
            change:function(){
              BZ._userHabit.actionClass=this.value
              BZ._storeUserHabit()
            }
          }
        }
      ]
    }
  },
  _getPlayBtnClass:function(d,_large){
    d=d._item
    if(d.constructor==String){
      d=d.split("/")
      while(!d[0]||(d[1]&&d[1][0]=="m")){
        d.shift()
      }
      d=_ideObjHandler._getDataByPath(d[0],d[1])
      d=d._data
      if(!d.actions){
        return "bz-hide-item"
      }
    }
    var c,k;
    if(_large){
      c="btn btn-icon bz-large-btn btn-none bz-{0}"
    }else{
      c="btn btn-icon bz-small-btn bz-menu-ex-icon bz-{0}"
    }
    var t=_ideTask._setting._orgData
    if(BZ._isPlaying()&&t){
      if(t.createStamp.time==d.createStamp.time&&d.code==t.code){
        k="stop"
      }else{
        k="play"
      }
    }else{
      k="play"
    }
    if(_large){
      k+="-ring"
    }
    return _Util._formatMessage(c,k)
  },
  _getPlayBtnDisabled:function(d){
    d=d._item
    if(d.constructor==String){
      d=d.split("/")
      while(!d[0]||(d[1]&&d[1][0]=="m")){
        d.shift()
      }
      d=_ideObjHandler._getDataByPath(d[0],d[1])
      d=d._data
    }
    var t=_ideTask._setting._orgData
    if(BZ._isPlaying()&&t){
      return t.createStamp.time!=d.createStamp.time||d.code!=t.code
    }
  },
  _getSwitchBtn:function(_style){
    return {
      _tag:"button",
      _attr:{
        style:_style,
        class:"'btn btn-icon bz-small-btn bz-'+(_data._item._open?'open':'close')+'-node'"
      },
      _jqext:{
        click:function(){
          this._data._item._open=!this._data._item._open
        }
      }
    }
  },
  _setAttrValue:function(d,_fun){
    _Util._confirmMessage(_stdComponent._getInputViewDef(d),[{
      _title:_bzMessage._method._save,
      _click:_fun
    }],_bzMessage._method._setNewName)
  },
  //ec:extra class
  _getBadge:function(m,t,d,dc,ec){
    var k=m.code,c=""
    dc=dc||""
    if(t){
      k+="."+(t.code||t._data.code)
      if(d&&_ideObjHandler._hasData(t)){
        c="bz-data-item"+dc
      }
    }else if(d&&_ideObjHandler._hasData(m)){
      c="bz-data-item"+dc
    }

    // if(t){
    //   if(t._noReady){
    //     c+=" bz-no-ready"
    //   }
    // }else{
    //   if(m._noReady){
    //     c+=" bz-no-ready"
    //   }
    // }
    
    return "<div class='badgecol "+(ec||"")+"'><a onclick='BZ._setHash(\""+k.replace(/[\.]/g,"/")+"\")' class='badge "+(m.bt=='feature'?'bz-in-feature ':'')+c+"'>"+k+"</a></div>"
  },
  _batchUpdateInJson:function(v,_fun){
    var _formatError;
    BZ._data._uiSwitch._batchJsonData=_Util._clone(v)

    _Util._confirmMessage({
      _tag:"div",
      _attr:{"class":"bz-batch-json-box"},
      _items:[
        _bzJSEditor._buildJSEditor({
          _model:"BZ._data._uiSwitch._batchJsonData",
          _noBtn:1,
          _labelStyle:"right:16px",
          _style:"height:500px",
          _inJson:1
        })
      ]
    },[
      {
        _title:_bzMessage._common._ok,
        _click:function(c){
          if(_formatError){
            return alert(_bzMessage._system._error._dataFormat)
          }
          try{
            _fun(BZ._data._uiSwitch._batchJsonData)
          }catch(e){
            return alert(_bzMessage._system._error._dataFormat)
          }
          c._ctrl._close()
        }
      }
    ],_bzMessage._method._batchEdit,500)
  },
  _selectElementPath:function(_path,_fun,_exAttr,_info){
    BZ._data._uiSwitch._tmpElementPath=_path
    return _Util._confirmMessage({
      _tag:"div",
      _items:[
        _uiHandler._getElementPath("BZ._data._uiSwitch._tmpElementPath",function(_pick){
          _pick=_pick?0:_path
          _bzDomPicker._pickElement(_pick,function(v){
            BZ._data._uiSwitch._tmpElementPath=_path=v
          })
        }),
        {
          _tag:"div",
          _attr:{"class":"input-group"},
          _items:[
            {
              _tag:"label",
              _attr:{"class":"input-group-addon"},
              _text:"_data._item._text"
            },
            {
              _tag:"input",
              _attr:{"class":"form-control"},
              _dataModel:function(d){
                return d._item._data
              }
            }
          ],
          _dataRepeat:_exAttr
        },
        {
          _if:_info,
          _tag:"div",
          _attr:{"class":"bz-note-text",style:"margin-top:10px;"},
          _text:_info
        }
      ]
    },[
      {
        _title:_bzMessage._common._ok,
        _click:function(dlg){
          _fun(_path)
          dlg._ctrl._close();
        }
      }
    ])
  },
  _getBZSelect:function(p){
    let _uiKey="m"+_aiAPI._newId(),
        _filter=_CtrlDriver._buildProxy({}),
        _curInput=0,_oldValue,_oldDesc

    p._getValue=p._getValue||function(_data){
      let v= eval(_getModelValue())
      v=(v||"").replace(/[\/]$/,"")
      return v
    }
    p._setValue=p._setValue||function(v){
      eval(_getModelValue()+"=v")
      p._afterSetValue&&p._afterSetValue()
    }
    
    p._formatGet=p._formatGet||function(d,_dom){
      if(p._insertCode&&_Util._hasInsertCode(d)){
        return d
      }
      let v=d&&_ideObjHandler._getDataByPath(d)
      if(v){
        return v._data.name
      }else{
        let dd=$(_dom.ownerDocument).find(":focus")[0]
        if(dd==_dom){
          return _dom.value
        }
        return d
      }
    }

    return {
      _if:p._if,
      _tag:"div",
      _attr:{
        style:p._style,
      },
      _update:p._update,
      _items:[
        {
          _if:p._if,
          _tag:"div",
          _attr:{
            "class":"input-group"
          },
          _items:[
            {
              _if:function(){
                return p._title&&!p._noTitle
              },
              _tag:"label",
              _attr:{
                "class":"input-group-addon"
              },
              _text:p._title
            },
            //value label
            {
              _if:function(d){
                return !p._noShowValue&&(!p._insertCode||!_Util._hasInsertCode(p._getValue(d)))
              },
              _tag:"div",
              _attr:{
                class:"bz-input-pre"
              },
              _html:function(d){
                return "<span>["+(p._getValue(d)||"<span style='font-size:9px;'>❌</span>")+"]</span>"
              },
              _jqext:{
                mouseover:function(){
                  if(this.innerText.includes("❌")){
                    if(p._dataModel.includes(".module")){
                      $(this).attr("title",_bzMessage._action._missRefModule)
                    }else{
                      $(this).attr("title",_bzMessage._action._missRefTests)
                    }
                  }else{
                    $(this).attr("title","")
                  }
                },
                click:function(){
                  _Util._getClosestElement(this,this,".bz-select-input").focus()
                }
              }
            },
            //menu
            {
              _if:function(d){
                return BZ._data._uiSwitch[_uiKey]
              },
              _tag:"div",
              _attr:{
                class:"bz-select-options",
                style:function(d,cc,o){
                  let r=_curInput.getBoundingClientRect(),c="",hh=260
                  let h=_curInput.ownerDocument.defaultView.innerHeight-r.bottom
                  if(h<hh&&h<r.top){
                    if(r.top<hh){
                      c="height:"+(r.top-10)+"px;"
                    }
                    return c+"bottom:"+(h+r.height)+"px;"
                  }else{
                    if(h<hh){
                      c="height:"+(h-10)+"px;"
                    }
                    return "width:"+(r.width+15)+"px;border-top:0;"+c
                  }
                }
              },
              _items:[
                //list
                {
                  _tag:"div",
                  _attr:{
                    style:"max-height:220px;overflow-y: auto;overflow-x:hidden;"
                  },
                  _items:[
                    {
                      _tag:"div",
                      _after:function(o){
                        setTimeout(()=>{
                          if($(o).hasClass("active")){
                            _Util._scrollUpSelectedItem(o.parentElement,o)
                          }
                        },10)
                      },
                      _attr:{
                        class:function(_data){
                          let d=_data._item.code
                          let v=eval(_getModelValue())
                          if(v==d||d==_filter._curItem){
                            v=" active"
                          }else{
                            v=""
                          }
                          return 'bz-nowrap bz-select-option bz-hover'+v
                        }
                      },
                      _items:[
                        {
                          _if:"_data._item._groupText",
                          _tag:"div",
                          _attr:{
                            class:"bz-select-option-ex",
                            style:"display:flex;"
                          },
                          _items:[
                            {
                              _tag:"div",
                              _attr:{
                                class:function(d){
                                  d=d._item
                                  if(d._groupIcon){
                                    return "btn btn-icon bz-small-btn bz-right-space-5 "+d._groupIcon
                                  }else{
                                    return "bz-hide"
                                  }
                                },
                                style:"margin-top:2px;top: 1px;position: relative;"
                              }
                            },
                            {
                              _tag:"div",
                              _attr:{
                                style:"flex:1"
                              },
                              _text:"_data._item._groupText"
                            }
                          ]
                        },
                        {
                          _tag:"span",
                          _attr:{
                            class:"bz-select-option-ex2"
                          },
                          _items:[
                            {
                              _tag:"span",
                              _attr:{
                                class:function(d){
                                  let c="btn btn-icon bz-small-btn bz-right-space-5 "
                                  d=d._item
                                  if(d._icon){
                                    c+=d._icon
                                  }else if(d.tests){
                                    c+="bz-"+(d.bt=="feature"?"feature":d.bt=="data"?"ai-model":"module")
                                  }else if(d.actions){
                                    c+="bz-"+d.type
                                  }else{
                                    c+="bz-hide"
                                  }
                                  return c
                                },
                                style:"width:20px;margin-top:1px;margin-left:5px;"
                              }
                            },
                            {
                              _tag:"div",
                              _attr:{
                                style:"flex:1",
                                class:"bz-nowrap"
                              },
                              _text:function(d){
                                let c=""
                                if(!p._noShowValue){
                                  c='['+d._item.code+'] '
                                }
                                return c+d._item.name
                              }
                            }
                          ]
                        }
                      ],
                      _dataRepeat:function(){
                        let vs= p._dataRepeat()
                        return _filterList(vs)
                      },
                      _jqext:{
                        mousedown:function(e){
                          window.event=e
                          _setValue(this._data._item.code,this)
                        },
                        mouseover:function(){
                          _filter._curItem=this._data._item.code
                        },
                        mouseout:function(){
                          _filter._curItem=0
                        }
                      }
                    },
                  ]
                },
                //new button
                {
                  _if:function(){
                    return p._newBtn&&BZ._isCheckout()
                  },
                  _tag:"hr"
                },
                {
                  _if:function(){
                    return p._newBtn&&BZ._isCheckout()
                  },
                  _tag:"div",
                  _attr:{
                    class:"bz-nowrap bz-select-option bz-hover",
                    style:"margin-top: 5px;"
                  },
                  _items:[
                    {
                      _tag:"button",
                      _attr:{
                        class:"btn btn-icon bz-small-btn bz-plus bz-right-space-10",
                        style:"margin-top:-3px;"
                      },
                    },
                    {
                      _text:function(){
                        return p._newBtn._label||(_bzMessage._method._new+" ...")
                      }
                    }
                  ],
                  _jqext:{
                    mousedown:function(){
                      p._newBtn._fun()
                    }
                  }
                },
              ]
            },
            //input
            {
              _if:p._if,
              _tag:"input",
              _attr:{
                "class":function(_data){
                  let c="form-control bz-select-input "
                  let d;
                  eval("d="+p._dataModel)
                  if(!d){
                    c+="bz-background-right-icon bz-search"
                  }
                  return c
                },
                autocomplete:"nope",
                disabled:p._disabled,
                style:function(d,c,o){
                  if(p._noShowValue){
                    return "width:100%;"
                  }
                  d=p._getValue(d)||"[x]"
                  if(_Util._hasInsertCode(d)){
                    return "padding-left:5px;width:calc(100% - 10px);"
                  }
                  d=(d.length+2)*7+12
                  if(o&&o.ownerDocument.defaultView.name!="bz-master"){
                    return `padding-left:${d}px;width:100% !important;`
                  }
                  return `padding-left:${d}px;width:calc(100% - ${d+10}px) !important;`
                }
              },
              _focus:function(_data){
                return !eval(p._dataModel)
              },
              _after:function(o){
                if(o.ownerDocument.defaultView.name!="bz-master"){
                  $(o).css({width:"100%"})
                }
              },
              _dataModel:p._dataModel,
              _jqext:{
                change:p._change,
                keyup:function(e){
                  window.event=e
                  if([40,38].includes(e.keyCode)){
                    return
                  }
                  if(this.value!=_oldDesc||this._changed){
                    this._changed=1
                    _setFilterText(this.value)
                  }
                  
                },
                focus:function(){
                  this._changed=0
                  _oldValue=p._getValue(this._data)
                  _oldDesc=this.value
                  _setFilterText("")
                  _showMenu(this)
                },
                blur:function(e){
                  window.event=e
                  if(!this.value){
                    _setValue("",this)
                  }
                  _filter._curItem=0
                  _hideMenu()
                },
                keydown:function(e){
                  window.event=e
                  let _scope=$(e.target.ownerDocument)
                  let os=_scope.find(".bz-select-option").toArray();
                  let cs=os.map(x=>x._data._item.code)
                  if(e.keyCode==13){
                    let o=this
                    e.stopPropagation()
                    e.preventDefault()
                    if(!o.value&&!_filter._curItem){
                      return o.blur()
                    }
                    if(!_filter._curItem&&os.length){
                      _setFocus(40)
                    }
                    if(_filter._curItem){
                      _setValue(_filter._curItem,o)
                    }
                    _filter._curItem=0
                    o.blur()
                    return _hideMenu()
                  }else if(e.keyCode==27){
                    p._setValue(_oldValue,this._data)
                    this.value=_oldDesc
                    _hideMenu()
                    e.stopPropagation()
                    return
                  }
                  if(e.keyCode==40||e.keyCode==38){
                    _setFocus(e.keyCode)
                   // e.stopPropagation()
                    e.preventDefault()
                  }else{
                    _filter._curItem=0
                    _showMenu(this)
                  }
                  
                  function _setFocus(v){
                    let i=cs.indexOf(_filter._curItem)
                    if(v==38){
                      i--
                      if(i<0){
                        i=cs.length-1
                      }
                    }else{
                      i++
                      if(i>=cs.length){
                        i=0
                      }
                    }
                    _filter._curItem=cs[i]
                    _Util._scrollUpSelectedItem(_scope.find(".bz-select-options")[0],os[i])
                  }
                }
              },
              _formatSet:function(v){
                if(p._insertCode&&_Util._hasInsertCode(v)){
                  return v
                }
                let os=$(".bz-select-option").toArray()
                v=os.find(x=>x._data._item.name.toLowerCase().includes(v.toLowerCase().trim()))
                if(v){
                  return v._data._item.code
                }
                return ""
              },
              _formatGet:p._formatGet
            },
            //down button
            {
              _if:p._if,
              _tag:"div",
              _attr:{
                class:"input-group-btn"
              },
              _items:[
                {
                  _tag:"button",
                  _attr:{
                    disabled:p._disabled,
                    class:"btn btn-icon bz-small-btn bz-caret-down"
                  },
                  _jqext:{
                    click:function(e){
                      window.event=e
                      _Util._getClosestElement(this,this,"input").focus()
                      setTimeout(()=>{
                        _filter._text=""
                      },10)
                    }
                  }
                }
              ]
            },
            //delete button
            {
              _if:function(){
                return p._deleteBtn
              },
              _tag:"div",
              _attr:{
                class:"input-group-btn"
              },
              _items:[
                {
                  _tag:"button",
                  _attr:{
                    disabled:function(d){
                      try{
                        return !p._getValue(d)
                      }catch(e){}
                    },
                    title:function(){
                      return p._deleteBtn._label||_bzMessage._method._delete
                    },
                    class:"btn btn-icon bz-small-btn bz-delete"
                  },
                  _jqext:{
                    click:function(){
                      if(p._deleteBtn._fun){
                        p._deleteBtn._fun()
                      }else{
                        _setValue("",this)
                      }
                    }
                  }
                }
              ]
            },
            //setting button
            {
              _if:function(){
                return p._settingBtn
              },
              _tag:"div",
              _attr:{
                class:"input-group-btn"
              },
              _items:[
                {
                  _tag:"button",
                  _attr:{
                    title:function(){
                      return p._settingBtn._label
                    },
                    class:"btn btn-icon bz-small-btn bz-ex-setting"
                  },
                  _jqext:{
                    click:function(){
                      p._settingBtn._fun()
                    }
                  }
                }
              ]
            }
          ]
        }
      ]
    }
    function _setValue(v,o){
      p._setValue(v,o._data)

      o=_Util._getClosestElement(o,o,"input.bz-select-input")
      o.value=v?p._formatGet(v,o):""
      $(o).change()
    }
    
    function _filterList(ms){
      let vs=(_filter._text||"").split(/[ .,;]/);
      
      vs.forEach(v=>{
        ms=ms.filter(x=>x.name.toLowerCase().includes(v)||x.code.includes(v))
      })

      if(p._buildGroup){
        p._buildGroup(ms)
      }
      return ms
    }
    
    function _setFilterText(v){
      _filter._text=v.toLowerCase().trim()
    }
    
    function _showMenu(o){
      _curInput=o
      if(!BZ._data._uiSwitch[_uiKey]){
        BZ._setTmpUISwitch(_uiKey,[o,o.nextSibling])
      }
    }
    function _hideMenu(){
      BZ._data._uiSwitch[_uiKey]=0
      p._closeMenu&&p._closeMenu()
    }

    function _getModelValue(){
      v=p._dataModel
      if(v.constructor==Function){
        v=v()
      }
      return v
    }
  },
  _getModuleList:function(p){
    p=p||{}
    p._title=p._title||_bzMessage._common._module
    p._dataRepeat=p._dataRepeat||function(){
      return _IDE._data._curVersion.modules.filter(x=>x.code[0]=="m")
    }
    return _uiHandler._getBZSelect(p)
  },
  _getTestList:function(p){
    p=p||{}
    p._title=p._title||(p._noTitle?0:_bzMessage._common._test)
    p._dataRepeat=p._dataRepeat||function(){
      let ms=[]
      _IDE._data._curVersion.modules.forEach(x=>{
        if(x.code[0]=="m"){
          if(p._filterModule){
            if(p._filterModule.constructor==Function){
              if(!p._filterModule(x)){
                return
              }
            }else if(!x.type.match(p._filterModule)){
              return 
            }
          }
          x.tests.forEach(t=>{
            if(p._filterTest){
              if(p._filterTest.constructor==Function){
                if(!p._filterTest(t)){
                  return
                }
              }else if(!t.type.match(p._filterTest)){
                return
              }
            }
            ms.push({m:x,code:x.code+"."+t.code,name:t.name,_icon:"bz-"+t.type})
          })
        }
      })

      return ms
    }
    p._buildGroup=p._buildGroup||function(ms){
      let _last
      ms.forEach(x=>{
        x._groupText=(!_last||_last.m!=x.m)?"["+x.m.code+"] "+x.m.name:0
        x._groupIcon="bz-"+(x.m.bt=="feature"?"feature":"module")
        x._inGroup=1
        _last=x
      })
    }
    
    
    return _uiHandler._getBZSelect(p)
  },
  _getRefTestList:function(_curAction,_key,_updateOnScenario){
    let v=_curAction[_key]||""
    v=_ideActionManagement._getTestFromRef(v);
    BZ._data._uiSwitch._curRef=v
    return _uiHandler._getTestList({
      _title:"_bzMessage._ref._refPath",
      _dataModel:"BZ._data._uiSwitch._curRef",
      _insertCode:1,
      _update:function(){
        // let v=_curAction[_key]||""
        // let r=(v.match(/([\/]|^)[sfew]($|[\/])/)||[""])[0],
            // f=(v.match(/([\/]|^)[\.]+($|[\/])/)||[""])[0],
            // t=(v.match(/([\/]|^)[0-9]+($|[\/])/)||[""])[0]

        // v=`${BZ._data._uiSwitch._curRef}/${r}/${f}/${t}/`
        // _curAction[_key]=v.replace(/[\/]+/g,"/").replace(/^[\/]$/,"")
        // _ideTestManagement._save()
      },
      _filterModule:function(d){
        return !_updateOnScenario||d.bt!="feature"
      },
      _deleteBtn:1,
      _newBtn:{
        _fun:function(){
          let m=_IDE._data._curTest&&_IDE._data._curTest._data.type=="scenario"?{tests:[]}:0
          _ideTestManagement._newItem(0,0,0,0,m,function(t,m){
            m=m.code+"."+t.code
            BZ._data._uiSwitch._curRef=m
            _IDE._data._curAction.refOfSuccess=m+"/"
            _ideTestManagement._save()
          },1)
        },
        _label:_bzMessage._method._newTest+' ...'
      },
      _change:function(){
        BZ._data._uiSwitch._showBatchUpdateTests=[]
        var _this=this;
        setTimeout(()=>{
          _Util._resizeModelWindow()
        },100)
        if(_updateOnScenario){
          _ideActionManagement._batchUpdateRef(_curAction,_IDE._data._curTest,_IDE._data._curModule,BZ._data._uiSwitch._curRef)
        }else{
          _doIt()
        }
        function _doIt(_fun){
          if(!_IDE._data._curTest){
            return _fun()
          }
          setTimeout(function(){
            var v=BZ._data._uiSwitch._curRef||""
            
            if(_IDE._data._curTest._data.type=="scenario"){
              _bzScenario._handleScenarioDescAndParameter(_IDE._data._curTest,_curAction,v,0,_fun)
              return 
            }
            v=_JSHandler._formatInsertCodeToData(v)
            _ideActionManagement._setCondition(
              _curAction,_key,
              v,0,0,_IDE._data._curModule._data.code+"."+_IDE._data._curTest._data.code==v?1:0
            );
            
            _ideTestManagement._save(0,0,_fun)
          },1);
        }
      }
    })
  },
  _getTestRefList:function(_testType){
    return {
      _tag:"optgroup",
      _attr:{
        label:"'['+_data._item.code+'] '+_data._item.name",
      },
      _after:function(o){
        if(!o.children.length){
          $(o).hide()
        }
      },
      _items:[
        {
          _tag:"option",
          _text:"'['+_IDE._getShortcutKey('.',_data._supData._item.code,_data._item.code)+'] '+_compressJSON._unConvert(_data._item.name)",
          _attr:{
            "class":function(d){
              return "bz-group-option-icon bz-"+d._item.type
            },
            value:"_data._supData._item.code+'.'+_data._item.code",
            selected:function(d){
              return !d._supData._idx && !d._idx
            }
          },
          _dataRepeat:function(d){
            var vs=[];
            var w=BZ._data._uiSwitch._addActionSearchWord||""
            if(!_testType&&_IDE._data._curTest&&_IDE._data._curTest._data.type=='scenario'){
              _testType=['unit','api']
            }
            return _ideModuleManagement._sortTestList(d._item,_testType,w.toLowerCase())
          }
        }
      ],
      _dataRepeat:function(){
        var m=_IDE._data._curModule,
            t=_IDE._data._curTest;
        var vs=[],_top;
        _IDE._data._curVersion.modules.forEach(function(v,i){
          var w=BZ._data._uiSwitch._addActionSearchWord||""
          if(v.code.match(/(m[0-9]+|com)/) && v.tests && v.tests.length){
            if(m&&!BZ._data._uiSwitch._addActionSearchWord){
              if(m._data.bt=="feature"){
                if(t&&t._data.type=="int"){
                  if(v.bt!="feature"){
                    return
                  }
                }else{
                  if(v.bt=="feature"){
                    return
                  }
                }
              }else if(v.bt=="feature"){
                return
              }
            }
            for(var i=0;i<v.tests.length;i++){
              if(v.tests[i].name.toLowerCase().includes(w.toLowerCase())){
                if(_IDE._data._curModule&&v.code==_IDE._data._curModule._data.code){
                  _top=v
                }else{
                  vs.push(v)
                }
                return;
              }
            }
          }
        });
        vs.sort(_ideModuleManagement._sortModuleList)
        if(_top){
          vs.unshift(_top)
        }
        return vs;
      }
    }    
  },
  _getBtnSelect:function(p){
    let _menuKey="menu"+_aiAPI._newId()
    return {
      _tag:"span",
      _attr:{
        style:p._boxStyle,
      },
      _items:[
        //Play
        {
          _tag:"button",
          _attr:{
            style:p._style,
            "class":function(){
              let v=eval(p._dataModel)
              if(!p._map[v]){
                eval(p._dataModel+"=p._default")
              }
              return p._class+` btn btn-icon ${p._map[eval(p._dataModel)]}`
            },
            title:function(){
              return p._textRoot[eval(p._dataModel)]
            }
          },
          _jqext:{
            click:p._click
          }
        },
        //dropdown button
        {
          _tag:"button",
          _attr:{
            class:"btn btn-icon-half bz-dropdown dropDownMargin-right dropDownMargin-left",
            style:"margin:0;",
            disabled:p._disabled
          },
          _jqext:{
            click:function(){
              BZ._setTmpUISwitch(_menuKey,[this])
            }
          }
        },
        //dropdown menu
        {
          _if:"BZ._data._uiSwitch."+_menuKey,
          _tag:"div",
          _after:function(o){
            let c=$(".btn-icon-half")[0].getBoundingClientRect()
            $(o).css({left:c.left+"px",display:"block"})
          },
          _attr:{
            "class":"pop-menu bz-play-menu",
            style:function(){
              return "display:none;text-align:left;z-index:"+_Util._getTopZIndex();
            }
          },
          _items:[
            //Play
            {
              _tag:"div",
              _attr:{style:"display:flex"},
              _items:[
                {
                  _tag:"div",
                  _attr:{"class":"pop-menu-item"},
                  _jqext:{
                    click:p._menuItemClick
                  },
                  _items:[
                    {
                      _tag:"button",
                      _attr:{
                        "class":function(d){
                          return "btn btn-icon btn-none  bz-small-btn "+d._item
                        }
                      }
                    },
                    {
                      _tag:"span",_attr:{style:"padding:0 10px;"},
                      _text:function(d){
                        return p._textRoot[d._key]
                      }
                    }
                  ]
                }
              ],
              _dataRepeat:function(){
                return p._map
              }
            },
          ]
        },
        {
          _tag:"button",
          _attr:{
            disabled:"_IDE._data._setting.content.disableAutoOneAction",
            "class":function(){
              let c=`btn btn-icon bz-medium-btn bz-flash`
              if(!_IDE._data._setting.debugOneAction&&!_IDE._data._setting.content.disableAutoOneAction){
                c+=" bz-pressed bz-active-icon"
              }else{
                c+=" bz-grey"
              }
              
              return c
            },
            style:"background-size: 20px !important;width: 22px;height: 22px;margin-left: 8px !important;border-radius: 10px;padding: 0;",
            title:function(){
              if(!_IDE._data._setting.debugOneAction&&!_IDE._data._setting.content.disableAutoOneAction){
                return _bzMessage._setting._preferences._debugOneAction
              }else {
                return _bzMessage._setting._preferences._switchToOneAction
              }
            }
          },
          _jqext:{
            click:function(){
              _IDE._data._setting.debugOneAction=!_IDE._data._setting.debugOneAction
              _ideVersionManagement._savePersonData()
            }
          }
        },
      ]
    }
  },
  _animationToolbar:function(e,i,_fun){
    $(e).css({"margin-left":i+"px",display:"block"})
    _doIt()
    function _doIt(){
      $(e).css({"margin-left":(i+=5)+"px"})
      if(i<-10){
        setTimeout(_doIt,5)
      }else{
        $(e).css({"margin-left":"-10px"})
        if(_fun){
          _fun()
        }
      }
    }
  },
  _mouseoverScreenshot:function(e,_event){
    var xy=_Util._getMouseXY(_event);
    e.style.position="fixed";
    e.style.maxWidth=window.innerWidth+"px";
    e.style.maxHeight=window.innerHeight+"px";
    e.style.zIndex=100000
    var _rect=e.getBoundingClientRect();
    var x1=xy.x-_rect.width/2;
    var y1=xy.y-_rect.height/2;
    if(x1<0){
      x1=0
    }
    if(y1<0){
      y1=0
    }
    if(x1+_rect.width>window.innerWidth){
      x1=window.innerWidth-_rect.width
    }
    if(y1+_rect.height>window.innerHeight){
      y1=window.innerHeight-_rect.height
    }
    
    e.style.left=x1+"px";
    e.style.top=y1+"px";
    e._parent=e.parentElement
    e.ownerDocument.body.append(e)
  },
  _mouseoutScreenshot:function(e){
    e.style.maxWidth="100%";
    e.style.maxHeight="24px";
    e.style.position="";
    e._parent.append(e)
  },
  _getScreenshot:function(m){
    return {
      _if:m,
      _tag:"img",
      _attr:{
        style:"max-width: 100%;max-height: 24px;border: 1px solid var(--highlight-color);",
        src:m
      },
      _jqext:{
        mouseover:function(e){
          _uiHandler._mouseoverScreenshot(this,e)
        },
        mouseout:function(){
          _uiHandler._mouseoutScreenshot(this)
        }
      }
    }
  },
  /*
  _getTestDataListWithEditor:function(_dataModel){
    return [
      _bzJSEditor._buildJSEditor({
        _if:"BZ._data._uiSwitch._refTmpTest.match(/^\{\{.*\}\}$/)",
        _oneRow:1,
        _model:_dataModel,
        _style:"flex:1",
        _befUpdate:function(_editor){
          _editor.innerText.match(
        }
      }),
      {
        _if:"!BZ._data._uiSwitch._refTmpTest.match(/^\{\{.*\}\}$/)",
        _tag:"input",
        _attr:{
          "class":"form-control",
        },
        _dataModel:"BZ._data._uiSwitch._refTmpTest",
        _update:function(v){
          _saveData(v)
        }
      }
    ]
    function _saveData(v){
      eval(_dataModel+"=v")
      _ideTestManagement._save()
    }
  },
  */
  _closeSwitchEditor:function(_this,_fun){
    setTimeout(function(){
      var o=$(":focus")[0]
      if(!o || (o!=_this && o!=$(".bz-code-options")[0] && $(".bz-codePop a:focus")[0]!=o)){
        $(_this).css({top:0})
        $(".bz-code-options").hide();
        BZ._data._uiSwitch._tmpCodeOptions=0
        BZ._data._uiSwitch._showRefList=0;
        if(_fun){
          _fun()
        }
      }
    },100)
  },
  _extendComponet:function(o,_fun){
    _fun(o)
    return o;
  },
  _getCodeOptionUI:function(){
    return {
      _if:function(){
        return BZ._data._uiSwitch._tmpCodeOptions&&_IDE._data._curTest;
      },
      _tag:"select",
      _jqext:{
        blur:function(){
        //$(_uiHandler._curElementInput).blur()
        }
      },
      _attr:{
        id:"bz-data-test-ref-list",
        multiple:"multiple",
        "class":"bz-code-options bz-resize",
        style:function(){
          var o=_uiHandler._curElementInput
          o=o.getBoundingClientRect()
          var i=BZ._data._uiSwitch._tmpCodeOptions.length||1;
          var d=12;
          if(BZ._data._uiSwitch._showRefList){
            var n=0;
            _IDE._data._curVersion.modules.forEach(function(v){
              n+=1+v.tests.length;
            })
            i=Math.max(n,i)
            d=80
          }
          i=i*19+d;
          if(i>400){
            i=400
          }
          var w=o.right-o.left
          if(w<300){
            w=300
          }
          var l=o.left
          if(l+w>window.innerWidth){
            l=window.innerWidth-w
          }
          var c="width:"+w+"px;left:"+l+"px;";
          if(document.body.clientHeight-o.bottom>i+20){
            if(_uiHandler._curElementInput.tagName=="TEXTAREA"){
              $(".bz-keywords-panel").insertBefore(_uiHandler._curElementInput)
            }
            c+="top:"+(o.bottom)+"px;height:"+i+"px;"
          }else{
            if(_uiHandler._curElementInput.tagName=="TEXTAREA"){
              $(".bz-keywords-panel").insertAfter(_uiHandler._curElementInput)
            }
            c+="top:"+(o.top-i)+"px;height:"+i+"px;"
          }
          return "overflow: auto;"+c
        }
      },
      _items:[
        //Data list
        {
          _if:"BZ._data._uiSwitch._showRefList",
          _tag:"optgroup",
          _attr:{
            label:"_bzMessage._common._dataBind",
            "class":"bz-close-node bz-options-main",
            style:"margin:-5px -5px 1px -5px"
          },
          _jqext:{
            click:function(){
              _switchOptGroup(this,$(".bz-code-ref-item"))
            }
          }
        },
        {
          _if:function(){
            if(!BZ._data._uiSwitch._tmpCodeOptions.length && (!_IDE._data._curTest||!_IDE._data._curTest._data.defParameter)){
              var o=_uiHandler._curElementInput;
              
              return o&&(window._tmpMakeParameterValue=_descAnalysis._retrieveTextForElementPathItem(o.value))
            }
            setTimeout(function(){
              if(!$(".bz-code-options option").length){
                $(".bz-code-options").hide()
              }else{
                $(".bz-code-options").show()
              }
            },100)
          },
          _tag:"option",
          _attr:{
            "class":"bz-code-ref-item"
          },
          _text:"_Util._formatMessage(_bzMessage._dataBind._asParameter,[window._tmpMakeParameterValue])",
          _jqext:{
            mousedown:function(){
              var o=$(_uiHandler._curElementInput);
              var v=window._tmpMakeParameterValue
              _IDE._data._curTest._data.defParameter=v;

              o.val(o.val().replace("("+v+")","({{$parameter}})").replace("=\""+v+"\"","=\"{{$parameter}}\"").replace("="+v,"={{$parameter}}"));
              o.change()
              BZ._data._uiSwitch._showRefList=0
              BZ._data._uiSwitch._tmpCodeOptions=0
              o.blur()
              _ideTestManagement._save()
            }
          }
        },
        {
          _tag:"option",
          _attr:{
            "class":function(d){
              var o=_uiHandler._curElementInput;
              var c="bz-code-exist"
              try{
                // var ov= _JSHandler._prepareData(o.value)
                // var v=_JSHandler._prepareData(d._item)
                // if(v!=ov){
                  c=""
                  if(!d._item.match(/\{\{.+\}\}/)){
                  }else if(d._item.includes("$parameter")){
                    c=" bz-code-parameter"
                  }else{
                    // var v=_JSHandler._prepareData(d._item)
                    // if(v.includes("undefined") && !d._item.includes("undefined")){
                      // c=" bz-code-noexist"
                    // }
                  }
                // }
              }catch(e){
                c=" bz-code-noexist"
              }
              
              return "bz-code-ref-item "+c
            },
            style:function(){
              if(BZ._data._uiSwitch._showRefList){
                return 'padding-left:17px;display:none;'
              }
            }
          },
          _text:"_data._item",
          _dataRepeat:"BZ._data._uiSwitch._tmpCodeOptions",
          _jqext:{
            mousedown:function(){
              var o=$(_uiHandler._curElementInput);
              o.val(this.text);
              o.change()
//              eval(o._viewDef._dataModel+"='"+this.text+"'")
              BZ._data._uiSwitch._showRefList=0
              BZ._data._uiSwitch._tmpCodeOptions=0
              $(o).blur()
              _ideTestManagement._save()
            }
          }
        },
        //Ref list
        {
          _if:"BZ._data._uiSwitch._showRefList",
          _tag:"optgroup",
          _attr:{
            label:"_bzMessage._common._refTest",
            "class":"bz-open-node bz-options-main",
            style:"margin:0px -5px 1px -5px"
          },
          _jqext:{
            click:function(){
              _switchOptGroup(this,$(".bz-code-module-item"))
            }
          }
        },
        {
          _if:"BZ._data._uiSwitch._showRefList",
          _jqext:{
            mousedown:function(){
              _selectItem(this)
            }
          },
          _tag:"option",
          _text:"[none]",
          _attr:{
            value:"",
            style:"padding-left:17px;",
            "class":"bz-code-module-item"
          }
        },
        {
          _tag:"optgroup",
          _attr:{
            label:"'['+_data._item.code+']'+_data._item.name",
            "class":"bz-code-module-item bz-open-node",
            style:"padding-left:15px;"
          },
          _jqext:{
            click:function(){
              _switchOptGroup(this,$(this).find("option"))
            }
          },
          _items:[
            {
              _tag:"option",
              _attr:{
                value:"_data._supData._item.code+'.'+_data._item.code",
                selected:function(d){
                  return d._supData._item.name+"."+d._item.name==BZ._data._uiSwitch._curPlugDesc
                },
                style:function(d){
                  var c=""
                  if(_compressJSON._unConvert(BZ._groupWords([d._supData._item.name,d._item.name])).toLowerCase().includes(BZ._data._uiSwitch._curPlugDesc.toLowerCase())){
                    return c+"display:block"
                  }
                  return c+"display:none"
                },
                "class":"'bz-group-option-icon bz-'+_data._item.type"
              },
              _text:"_compressJSON._unConvert('['+_data._supData._item.code+'.'+_data._item.code+'] '+BZ._groupWords([_data._supData._item.name,_data._item.name]))",
              _jqext:{
                mousedown:function(){
                  _selectItem(this)
                }
              },
              _dataRepeat:"_data._item.tests"
            }
          ],
          _dataRepeat:function(){
            var vs=[];
            if(BZ._data._uiSwitch._showRefList){
              _IDE._data._curVersion.modules.forEach(function(v,i){
                if(v.code.match(/(m[0-9]+|com)/) &&v.bt!="feature" && v.tests && v.tests.length){
                  vs.push(v)
                }
              });
            }
            return vs;
          }
        }
      ]
    }
    function _selectItem(_this){
      var o=$(_uiHandler._curElementInput)
      o.val(_this.value);
      o.change()
      BZ._data._uiSwitch._showRefList=0
      BZ._data._uiSwitch._tmpCodeOptions=0
      $(o).blur()
    }
    function _switchOptGroup(o,_options){
      if($(o).hasClass("bz-open-node")){
        $(o).removeClass("bz-open-node")
        $(o).addClass("bz-close-node")
        _options.hide()
      }else{
        $(o).removeClass("bz-close-node")
        $(o).addClass("bz-open-node")
        _options.show()
      }
    }
  },
  _getElementPath:function(_dataModel,_fun,_subTitle,_noPath,_noEdit,_typing,_title,_labelClass,_disabledFun,_noUpdate,_panels){
    var vs= {
      _tag:"div",
      _attr:{
        "class":"input-group bz-path-setting ",
        title:_title||""
      },
      _items:[
        //label
        {
          _tag:"div",
          _attr:{
            "class":"input-group-addon bz-no-border"
          },
          _items:[
            {
              _tag:"span",
              _text:_subTitle||"_bzMessage._action._element"
            },
            {
              _if:function(){
                return !BZ._data._uiSwitch._curAppLanguage
              },
              _tag:"div",
              _attr:{
                class:"bz-path-setting-ctrl"
              },
              _items:_getCtrl()
            }
          ]
        },
        //path input
        {
          _if:function(){
            return !BZ._data._uiSwitch._hideElement
          },
          _tag:"div",
          _attr:{
            class:function(){
              let a=eval(_dataModel)
              
              if(_Util._isEmpty(a)){
                return "bz-empty-path"
              }else{
                return "bz-path-box"
              }
            }
          },
          _items:[
            {
              _tag:"div",
              _attr:{
                "class":"bz-element-path",
                style:function(d){
                  if(d._item==0&&d._item!==""){
                    return "display:none"
                  }
                }
              },
              _dataRepeat:function(){
                let r=eval(_dataModel)
                return r||[]
              },
              _items:function(d){
                return [
                  _bzJSEditor._buildJSEditor({
                    _model:function(){
                      if(BZ._data._uiSwitch._curAppLanguage){
                        return "_descAnalysis._getCurLanguageElement(["+_dataModel+"["+d._idx+"]])[0]"
                      }else{
                        return _dataModel+"["+d._idx+"]"
                      }
                    },
                    _noInTimeUpdate:1,
                    _noBtn:1,
                    _oneRow:1,
                    _insert:1,
                    _noReadonly:_disabledFun&&!_disabledFun(),
                    _placeholder:_bzMessage._tools._insertCodeDescription,
                    // _style:"height:15px;flex:1",
                    //_readonly:"!BZ._isCheckout()||BZ._data._uiSwitch._curAppLanguage",
                    _befUpdate:function(e,_bkfun){
                      _aiDataUpdateHandler._buildTestAIUpdateOptions(e._oldValue,e.innerText,"element["+e._data._idx+"]");
                      let v=_ideActionManagement._updateCurElementOnEditPath("element",e)
                      _typing&&_typing()
                      _bkfun(v)
                      _CtrlDriver._refreshData(BZ._data._uiSwitch,"_hideElement")
                    },
                    _noUpdate:_noUpdate
                  }),
                  {
                    _if:"BZ._isCheckout()",
                    _tag:"button",
                    _attr:{
                      class:"btn btn-icon bz-small-btn bz-plus",
                      style:"margin:0 10px"
                    },
                    _jqext:{
                      click:function(){
                        _addRow(this);
                      }
                    }
                  },
                  {
                    _if:"BZ._isCheckout()",
                    _tag:"button",
                    _attr:{
                      class:"btn btn-icon bz-small-btn bz-cross",
                      style:"margin:0 10px 0 0"
                    },
                    _jqext:{
                      click:function(){
                        let r=eval(_dataModel)
                        
                        r.splice(this._data._idx,1)
                        if(r.length==1&&r[0]==0){
                          r.pop()
                        }
                        if(_typing){
                          _typing()
                        }else if(_IDE._data._curTest){
                          _ideTestManagement._save()
                        }else{
                          _ideModuleManagement._save()
                        }
                      }
                    }
                  }
                ]
              }
            },
            {
              _if:function(){
                let v
                try{
                  eval("v="+_dataModel)
                }catch(e){
                }
                return (!v||!v.length)&&BZ._data._uiSwitch._curDefElement
              },
              _tag:"input",
              _attr:{
                "class":"form-control",
                readonly:1,
                placeholder:"BZ._data._uiSwitch._curDefElement",
                disabled:_disabledFun
              },
              _jqext:{
                click:function(){
                  _bzDomPicker._flashTmpCover(["BZ.TW.document",BZ._data._uiSwitch._curDefElement,0])
                }
              }
            }
          ]
        }
      ],
      _jqext:{
        click:function(){
          let d;
          eval("d="+_dataModel)
          if(_panels){
            d=_aiGeneratorDataHandler._getStdPath(_panels,{path:d})
          }
          _bzDomPicker._flashTmpCover(d)
        }
      }
    }
    
    function _getCtrl(){
      return [
        //screenshot
        {
          _if:function(){
            return _dataModel=="_IDE._data._curAction.element"
          },
          _tag:"button",
          _attr:{
            class:function(){
              let c="btn btn-icon bz-small-btn bz-camera"
              if(_IDE._data._curAction.cameraMd5){
                c+="-icon"
              }
              return c
            },
            title:"_bzMessage._common._screenshot"
          },
          _jqext:{
            click:function(){
              BZ._setTmpUISwitch("_showScreenshot",[this])
            }
          },
          _items:[
            {
              _if:"BZ._data._uiSwitch._showScreenshot",
              _tag:"div",
              _attr:{
                class:"bz-hover-item"
              },
              _items:function(){
                return _actionScreenshotViewDef
              },
              _jqext:{
                mouseout:function(){
                  $(".bz-h-holder,.bz-slider-bar").show()
                  $(this).css({bottom:"unset"})
                },
                mouseover:function(){
                  $(".bz-h-holder,.bz-slider-bar").hide()
                  let r=this.getBoundingClientRect()
                  if(r.bottom>window.innerHeight-20){
                    $(this).css({bottom:"20px"})
                  }
                }
              }
            }
          ]
        },
        //copy
        {
          _tag:"button",
          _attr:{
            "disabled":function(){
              try{
                let d=eval(_dataModel)
                return _Util._isEmpty(d)
              }catch(e){}
            },
            class:"btn btn-icon bz-copy bz-small-btn",
            title:"_bzMessage._method._copy"
          },
          _jqext:{
            click:function(){
              let d=eval(_dataModel)
              _IDE._copy(d,0,'element',this.ownerDocument)
            }
          }
        },
        //paste
        {
          _tag:"button",
          _attr:{
            "disabled":function(){
              if(!(_IDE._data._clipData&& _IDE._data._clipData.level=='element')){
                return 1
              }
              if(_disabledFun){
                return _disabledFun()
              }
              return !BZ._isCheckout()
            },
            class:"btn btn-icon bz-paste bz-small-btn",
            title:"_bzMessage._method._paste"
          },
          _jqext:{
            click:function(){
              let d=_IDE._data._clipData.items
              eval(_dataModel+"=d")
              _typing&&_typing()
              if(_IDE._data._curTest){
                _ideTestManagement._save()
              }else if(_IDE._data._curModule){
                _ideModuleManagement._save()
              }
            }
          }
        },
        //dom-picker
        {
          _if:function(){
            try{
              let d=eval(_dataModel)
              return _Util._isEmpty(d)
            }catch(e){}
          },
          _tag:"button",
          _attr:{
            "disabled":function(){
              if(_disabledFun){
                return _disabledFun()
              }
              return !BZ._isCheckout()
            },
            class:"btn btn-icon bz-dompicker bz-small-btn",
            title:"_bzMessage._picker._selectPath"
          },
          _jqext:{
            click:function(){
              var f=_fun[0]||_fun
              f(1);
            }
          }
        },
        //edit
        {
          _if:function(_data){
            eval("var v="+_dataModel)
            return !_noPath&&v&&v.length
          },
          _tag:"button",
          _attr:{
            "disabled":function(){
              if(_disabledFun){
                return _disabledFun()
              }
              return !BZ._isCheckout()
            },
            "class":"btn btn-icon bz-edit bz-small-btn",
            title:"_bzMessage._picker._editPath"
          },
          _jqext:{
            click:function(e){
              e.stopPropagation()
              _ideActionManagement._deleteScreenshot()
              var f=_fun[0]||_fun,d;
              try{
                if(_dataModel.constructor==String){
                  eval("d="+_dataModel)
                }else{
                  d=_dataModel
                }
                f({element:d})
              }catch(e){}
            }
          }
        },
        //add
        {
          _tag:"button",
          _attr:{
            "disabled":"!BZ._isCheckout()",
            "class":"btn btn-icon bz-plus bz-small-btn",
            title:"_bzMessage._method._add"
          },
          _jqext:{
            click:function(){
              _addRow(this)
            }
          }
        },
        //Delete
        {
          _if:function(_data){
            eval("var v="+_dataModel)
            return !_noPath&&v&&v.length
          },
          _tag:"button",
          _attr:{
            "disabled":function(){
              if(_disabledFun){
                return _disabledFun()
              }
              return !BZ._isCheckout()
            },
            "class":"btn btn-icon bz-delete bz-small-btn",
            title:_bzMessage._method._delete
          },
          _jqext:{
            click:function(){
              eval(_dataModel+"=0")
              _ideActionManagement._deleteScreenshot();
              _IDE._data._curTest&&_ideTestManagement._save()
              if(_fun[1]){
                _fun[1]()
              }
            }
          }
        }
      ]
    }
    return vs

    function _addRow(o){
      let r=eval(_dataModel),
          i=o._data._idx+1;
      if(!i){
        i=0
      }
      if(!r){
        eval(_dataModel+"=[]")
        r=eval(_dataModel)
      }
      r.splice(i,0,".")
      let p=_Util._getClosestElement(o,o,".bz-path-setting")
      setTimeout(()=>{
        r[i]=""
        let o=$(p).find("pre:eq("+i+")")
        o.focus()
      })
    }
  },
  _setInputValueFromMenu:function(p,v){
    let o
    while(!o){
      o=$(p).find("input,textarea,.bz-js-editor")[0]
      if(o&&["checkbox","radio"].includes(o.type)){
        o=0
      }
      if(o){
        if(BZ._lastFocusInput&&!_Util._isHidden(BZ._lastFocusInput)&&$(p).find(BZ._lastFocusInput)[0]){
          if(!["checkbox","radio"].includes(BZ._lastFocusInput.type)){
            o=BZ._lastFocusInput
          }
        }
      }
      p=p.parentElement
    }
    if(o&&o.tagName!="A"){
      if($(o).hasClass("bz-key-input")){
        return
      }
      if(["_data","_defaultData","_personalData"].includes(BZ._data._curPage._key)){
        var d=BZ._data._uiSwitch._selectedItems[0];
        if("po".includes(d.t)){
          if(o.tagName=="INPUT"&&o.type!=="password"){
            var os=$("input,textarea")
            var i=os.index(o)
            if(os[i+1].tagName=="TEXTAREA"||os[i+1].type=="password"){
              o=os[i+1]
            }else{
              o=os[i+2]
            }
            if(!o){
              return
            }
          }
          o.value=""
        }else if("j"==d.t){
          v="$util.generateWordsByRegex(\""+v.replace(/\\/g,"\\")+"\")"
        }
      }

      if($(o).hasClass("bz-js-editor")){
        o._replaceSelectedText(o,v)
      }else{
        var i=o.selectionStart;
        var w=o.value.substring(0,i)+v+o.value.substring(o.selectionEnd);
        $util.triggerChangeEvent(o,w)
        o.selectionStart=o.selectionEnd=i+v.length
      }
      setTimeout(function(){
        o.focus()
      },500)
    }
  },
  _getBZKeyLink:function(_showJson,_floatRight){
    return {
      _tag:"div",
      _attr:{
        class:"bz-key-link"
      },
      _items:[
        {
          _if:function(){
            return _showJson
          },
          _tag:"a",
          _attr:{
            style:"margin-right:10px;text-decoration:underline;float:right;"
          },
          _text:"_bzMessage._dataBind._jsonTransfer",
          _jqext:{
            click:function(){
              let d=_DataBuilder._data._curData
              if(d.t=="o"){
                _uiHandler._batchUpdateInJson(_DataBuilder._objToJsonFromUI(),function(v){
                  _DataBuilder._fillObjectByJson(v)
                })
              }else{
                _uiHandler._batchUpdateInJson(_DataBuilder._csvToJsonFromUI(),function(v){
                  _DataBuilder._fillCSVByJson(v)
                })
              }
            }
          }
        },
        {
          _tag:"a",
          _text:"'+ '+_bzMessage._tools._advData",
          _attr:{
            class:"bz-adv-data-toggle",
            onclick:"BZ._data._uiSwitch._insertDataType=1;BZ._setTmpUISwitch('_insertDataMenu',[this,'pop-menu'])"
          },
          _jqext:{
            mousedown:function(){
              window._purposeInput=$(":focus")[0];
            }
          }
        },
        //Menu
        {
          _if:"BZ._data._uiSwitch._insertDataMenu",
          _tag:"div",
          _attr:{
            "class":"bz-menu bz-value-menu"
          },
          _after:function(o){
            _Util._moveMenu(o)
          },
          _items:[
            {
              _tag:"fieldset",
              _attr:{style:"border:0;border-top:var(--bz-border)"},
              _items:[
                {
                  _tag:"legend",
                  _items:[
                    {
                      _tag:"form",
                      _items:[
                        {
                          _tag:"label",
                          _attr:{style:"margin-right:10px","class":"BZ._data._uiSwitch._regexDataMenu==_data._item?'bz-active':''"},
                          _items:[
                            // {
                            //   _tag:"input",
                            //   _attr:{type:"radio",name:"_insertRegex",value:"_data._item"},
                            //   _dataModel:"BZ._data._uiSwitch._regexDataMenu",
                            // },
                            {_text:"_bzMessage._tools[_data._item]"}
                          ],
                          _dataRepeat:["_insertRegex"]
                          // _dataRepeat:["_insertRegex","_insertValRegex"]
                        }
                      ]
                    }
                  ]
                },
                {
                  _tag:"div",
                  _attr:{
                    style:"overflow: auto;max-height: 300px;"
                  },
                  _items:[
                    {
                      _tag:"a",
                      _attr:{"class":"bz-quick-data col-xs-4"},
                      _items:[
                        {
                          _tag:"span",
                          _attr:{
                            class:"bz-hover",
                            style:"padding-right:30px;"
                          },
                          _items:[
                            {
                              _text:"_data._item"
                            },
                            {
                              _tag:"span",
                              _attr:{
                                class:"bz-copy bz-hover-show",
                                style:"position: absolute;margin-left: 5px;margin-top: -5px;"
                              }
                            }
                          ]
                        }
                      ],
                      _jqext:{
                        mousedown:function(e){
                          if(e.button==2){
                            return
                          }
                          var os=_IDE._data._curVersion.setting.attributeMap,v=this._data._item;
                          if(BZ._data._uiSwitch._insertOrgRegex){
                            for(var i=0;i<os.length;i++){
                              if(os[i].key==this._data._item){
                                v=os[i].regex
                                break
                              }
                            }
                          }else{
                            v="/BZ-"+v+"/"
                          }
                          
                          if(BZ._data._uiSwitch._regexDataMenu=="_insertValRegex"){
                            v="/"+v+"/"
                          }
                          _Util._copyText(v)
                          _Util._flashElement(this,100)

                          //_uiHandler._setInputValueFromMenu(this,v)
                        }
                      },
                      _dataRepeat:function(d){
                        return _IDE._data._curVersion.setting.attributeMap.map(v=>{return v.key})
                      }
                    }
                  ]
                },
                //Insert Regex definition
                {
                  _tag:"label",
                  _attr:{
                    style:"float: left;margin-top: 5px;"
                  },
                  _items:[
                    {
                      _tag:"input",
                      _attr:{
                        type:"checkbox"
                      },
                      _dataModel:"BZ._data._uiSwitch._insertOrgRegex"
                    },
                    {_text:"_bzMessage._tools._insertOrgRegex"}
                  ],
                  _jqext:{
                    click:function(){
                      event.stopPropagation()
                    }
                  }
                }
              ]
            },
            {
              _tag:"fieldset",
              _attr:{style:"border:0;border-top:var(--bz-border)"},
              _items:[
                {
                  _tag:"legend",
                  _text:"_bzMessage._tools._insertCondition"
                },
                {
                  _tag:"div",
                  _items:[
                    {
                      _tag:"a",
                      _attr:{"class":"bz-quick-data col-xs-4"},
                      _items:[
                        {
                          _tag:"span",
                          _attr:{
                            class:"bz-hover",
                            style:"padding-right:30px;"
                          },
                          _items:[
                            {
                              _text:"_data._item"
                            },
                            {
                              _tag:"span",
                              _attr:{
                                class:"bz-copy bz-hover-show",
                                style:"position: absolute;margin-left: 5px;margin-top: -5px;"
                              }
                            }
                          ]
                        }
                      ],
                      _dataRepeat:["bz-skip","bz-skip-group","bz-stop"]
                    }
                  ]
                }
              ]
            },
            {
              _tag:"div",
              _attr:{
                class:"bz-note-text",
                style:"margin-top: 10px;width: calc(100% - 20px);"
              },
              _text:"_bzMessage._method._clickToCopy"
            }
          ]
        }
      ]
    }
  },
  _getPopPosStyle:function(_toggle){
    var xy=BZ._data._uiSwitch[_toggle]._pos,c="left:unset;right:60px;top:unset;bottom:unset;"
    v=window.innerHeight-xy.y
    if(xy.y>245){
      c+="bottom:"+v+"px"
      setTimeout(function(){
        var os=$(".bz-ex-setting-panel,.bz-setting-panel")
        for(var i=0;i<os.length;i++){
          $(os[i]).css({top:os[i].getBoundingClientRect().top+"px",bottom:"unset"})
        }
      },100)
    }else if(v>245){
      c+="top:"+xy.y+"px"
    }else{
      c+="top:0"
    }
    return c
  },
  _getPopCloser:function(_toggle){
    return {
      _tag:"button",
      _attr:{
        "class":"pull-right btn btn-icon bz-mini-btn bz-close",
        style:"position: absolute;right: 5px;top: 5px;",
        onclick:"BZ._data._uiSwitch."+_toggle+"=0",
        title:"_bzMessage._method._closePop"
      }
    }
  },
  _getPopExPanel:function(title, c,_toggle,_exClass){
    return {
      _tag:"div",
      _attr:{
        "class":function(){
          return 'bz-ex-setting-panel '+(_exClass||"")
        },
        style:function(d,c,o){
          if(!o){
            setTimeout(function(){
              var o=$(".bz-ex-setting-panel")[0];
              var oo="";
              if(!o._dragDefined){
                o._dragDefined=true;
                setTimeout(function(){
                  _Util._setDrag([o],o,oo);
                  let r=o.getBoundingClientRect()
                  if(r.top<60){
                    $(o).css({top:"var(--bar-height)"})
                  }
                },100);
              }
            },1);
            return "z-index:"+_Util._getTopZIndex()+";"+_uiHandler._getPopPosStyle(_toggle)
          }
        }
      },
      _items:[
        _uiHandler._getPopCloser(_toggle),
        {
          _tag:"div",
          _attr: {"class":"bz-panel-header"},
          _text:function(){
            return title.constructor==Function?title():title
          }
        },
        {
          _tag:"div",
          _attr: {"class":"bz-panel-body"},
          _items:c
        }
      ]
    }
  },
  _popBaseFunPanel:function(_model){
    return {
      _if:function(){
        return BZ._isCheckout()
      },
      _tag:"div",
      _attr:{
        "class":"bz-keywords-panel pull-left bz-right-space-5",
        style:"margin-left:20px;flex:1;white-space:nowrap;"
      },
      _items:[
        {
          _if:function(){
            return !_model.match(/BZ._data._uiSwitch._apiRequest.responseScript/)
          },
          _tag:"a",
          _text:_bzMessage._action._addBaseFun,
          _jqext:{
            click:function(e){
              BZ._menuFromBtn=this
              BZ._setTmpUISwitch('_showBaseFunMenu',[this,'bz-keywords-menu'],e,1)
            }
          }
        },
        {
          _if:function(){
            return _model.match(/BZ._data._uiSwitch._apiRequest.responseScript/)
          },
          _tag:"a",
          _text:_bzMessage._action._stdApiResponseScript,
          _jqext:{
            click:function(e){
              let r=BZ._data._uiSwitch._apiRequest
              r.responseScript=_ideActionManagement._getStdAPIScript(0,r.method)
              if(BZ._data._curPage._scope=="_module"){
                _ideModuleManagement._save(0,_afterSave)
              }else{
                _ideTestManagement._save(0,0,_afterSave)
              }
              
              function _afterSave(){
                _CtrlDriver._refreshData(BZ._data._uiSwitch,"_apiTab")
              }
            }
          }
        },
        {
          _if:"BZ._data._uiSwitch._showBaseFunMenu",
          _tag:"div",_attr:{"class":"bz-keywords-menu bz-menu",style:"width:350px;top: unset;margin-top: -165px;left: unset;right: unset;"},
          _attr:{
            class:"bz-keywords-menu bz-menu"
          },
          _items:[
            {
              _tag:"a",
              _items:[
                {
                  _tag:"span",
                  _attr:{
                    class:"bz-hover",
                    style:"padding-right:30px;"
                  },
                  _items:[
                    {
                      _text:"_data._item"
                    },
                    {
                      _tag:"span",
                      _attr:{
                        class:"bz-copy bz-hover-show",
                        style:"position: absolute;margin-left: 5px;margin-top: -5px;"
                      }
                    }
                  ]
                }
              ],
              _attr:{
                "class":"bz-quick-data col-xs-6",
                disabled:"!BZ._isCheckout()"
              },
              _jqext:{
                click:function(){
                  if(!BZ._isCheckout()){
                    return;
                  }
                  let o=_Util._getClosestElement(this,this,".bz-js-editor")
                  _Util._copyText(_ideActionData._functions()[this._data._key]._code)
                  // _Util._flashElement(this)
                //  _Util._insertTxtToEditor(o,_ideActionData._functions[this._data._key]._code);
                  BZ._data._uiSwitch._showBaseFunMenu=0
                  o.focus()
                }
              },
              _dataRepeat:"_bzMessage._action._functions"
            },
            {
              _tag:"div",
              _attr:{
                class:"bz-note-text",
                style:"margin-top: 10px;width: calc(100% - 20px);"
              },
              _text:"_bzMessage._method._clickToCopy"
            }
          ]
        }
      ]
    }
  },
  _getPopEditorPanel:function(c,_toggle){
    return {
      _tag:"div",
      _attr:{
        "class":"bz-ex-editor-panel",
        style:function(d,c,o){
          if(o){
            return
          }
          var e=BZ._data._uiSwitch[_toggle]._element
          var r=e.getBoundingClientRect(),s
          if(BZ._data._uiSwitch._topDetails){
            s="top:"+r.top+"px;"
          }else{
            s="bottom:"+(window.innerHeight-r.bottom)+"px;"
          }
          var rr=window.innerWidth-r.right-50
          if(rr<0){
            s+="right:0;width:300px;"
          }else{
            s+="right:"+rr+"px;"
            if(r.left>50){
              s+="left:"+(r.left-50)+"px;"
            }else{
              s+="left:0;"
            }
          }
          return "z-index:"+_Util._getTopZIndex()+";"+s
        }
      },
      _items:[
        _uiHandler._getPopCloser(_toggle),
        {
          _tag:"div",
          _items:c
        }
      ]
    }
  },
  _buildInput:function(_data,_dataRoot){
    let t={
      _tag:_data._tag||"input",
      _attr:{
        disabled:"!_aiPageHandler._isCheckout()",
        "class":(_data._class||"form-control")+" "+(_data._exClass||""),
        style:_data._style||_data._exStyle,
        placeholder:_data._placeholder,
        title:_data._title,
        required:_data._required
      }
    };
    if(_data._src){
      return _data._src
    }else if(_data.constructor==String){
      t._dataModel=_data._dataModel||_uiHandler._buildDataPath(_data,_dataRoot);
    }else if(_data._name){
      t._dataModel=_data._dataModel||_uiHandler._buildDataPath(_data._name,_dataRoot);
    }else if(_data._data){
      t._dataModel=_data._dataModel||_uiHandler._buildDataPath(_data._data,_dataRoot);
    }
    if(_data._options){
      t._tag="select";
      if(_data._options.constructor==Function){
        t._items=_data._options()
      }else if(_data._options.constructor==Object){
        t._items=[]
        for(var k in _data._options){
          t._items.push({
            _tag:"option",
            _text:_data._options[k],
            _attr:{value:k}
          })
        }
      }else{
        t._items=[]
        _data._options.forEach(d=>{
          if(d._src){
            t._items.push(d._src)
          }else if(d.constructor==String){
            t._items.push({
              _tag:"option",
              _text:_uiHandler._buildDataPath(d,_data._messageRoot),
              _attr:{value:d}
            })
          }else{
            t._items.push({
              _tag:"option",
              _text:_uiHandler._buildDataPath(d._text,_data._messageRoot),
              _attr:{value:d._value}
            })
          }
        })
      }
    }else if(["checkbox","radio"].includes(_data._type)){
      t._attr.type=_data._type
      t._attr["class"]=_data._exClass||"";
//      t._attr.checked=t._dataModel
    }else if(_data._type=="html"){
      t._tag="div",
      t._attr.contenteditable=true
    }else if(_data._type){
      t._tag=_data._type
    }
    
    if(_data._triggerUpdateWindowSize){
      if(!t._jqext){
        t._jqext={}
      }
      t._jqext.change=function(){
        _Util._resizeModelWindow(this)
      }
    }
    t._attr=Object.assign(t._attr,_data._attr)
    t._if=_data._if
    return t;
  },
  _buildDataPath:function(d,r){
    if(r&&r.constructor==String&&!d.includes(".")){
      return r+"."+d
    }
    return d
  },
  _buildFormView:function(_data,_template){
    let _view=[]
    let _dataRoot=_data._dataRoot&&_data._dataRoot.constructor==String?_data._dataRoot:"_data"
    _data._items.forEach(function(d){
      t=_Util._clone(_template)
      let _label=t._items[0];
      let _input=t._items[1];
      if(d.constructor==String){
        _label._text=_uiHandler._buildDataPath(d,_data._messageRoot)
      }else if(d._src){
        return _view.push(d._src)
      }else if(d._label){
        _label._text=d._label
      }else if(d._name&&!d._text){
        _label._text=_uiHandler._buildDataPath(d._name,_data._messageRoot);
      }else if(d._text&&d._text.constructor==String){
        _label._text=_uiHandler._buildDataPath(d._text,_data._messageRoot);
      }else{
        _label=Object.assign(_label,d._text)
      }
      
      _label._required=d._required

      t._if=d._if

      t._items.splice(1,0,_input=_uiHandler._buildInput(d,_dataRoot))
      if(["checkbox","radio"].includes(_input._attr.type)){
        _label._items=[
          _input,
          {_text:_label._text}
        ]
        t._items.splice(1)
        delete _label._text
        _label._attr["class"]="col-xs-12"
      }
      if(d._col){
        t._attr["class"]=t._attr["class"]||""
        if(d._col.constructor==String){
          t._attr["class"]="'"+t._attr["class"]+" col-xs-'+("+d._col+")"
        }else{
          t._attr["class"]+=" col-xs-"+d._col
        }
        t._attr.style=t._attr.style||""
        t._attr.style+=";float:left;margin:3px 0;"
      }
      if(d._style){
        t._attr.style=t._attr.style||""
        t._attr.style+=";"+d._style
      }
      if(d._jqext){
        _input._jqext=d._jqext
      }
      if(!d._btn){
        t._items.splice(2,1)
      }else{
        if(d._btn._src){
          t._items[2]=d._btn._src
        }else{
          var _btn=t._items[2]
          _btn._if=d._btn._if
          _btn._items[0]._attr["class"]+=" "+d._btn._icon
          _btn._items[0]._jqext={
            click:d._btn._click
          }
          var c=_btn._items[0]._attr["class"]
          if(d._btn._bluePoint||d._btn._redPoint){
            _btn._items[0]._attr["class"]=function(){
              if(d._btn._bluePoint()){
                c+=" bz-blue-data-point"
              }
              if(d._btn._redPoint()){
                c+=" bz-red-data-point"
              }
              return c
            }
          }
        }
      }
      _view.push(t)
    })
    t={_tag:"div",_items:_view};
    if(_data._dataRoot&&_data._dataRoot.constructor!=String){
      t._data=_data._dataRoot
    }
    return t
  },
  _buildTable:function(_data,_template){
    let _view=[]
    _data._items.forEach(function(d){
      /*
      var v={}
      t=_Util._clone(_template)
      if(d._src){
        return _view.push(d._src)
      }
      _view.push(t)
      
      d.forEach(function(a){
        a=d[a]
        if(a._src){
        }
        if(a._text){
          t._text=a._text
        }else if(a._input){
          
        }
      })
      
      let _label=t._items[0];
      let _input=t._items[1];
      if(d._src){
        _view.push(d._src)
      }else if(d._text.constructor==String){
        _label._text=d._text;
      }else{
        _label=Object.assign(_label,d._text)
      }
      if(d._input.constructor==String){
        _input._dataModel=d._input;
        _input._tag="input"
      }else{
        _input._dataModel=d._input._data;
        switch(d._input._type){
          case "checkbox":
          case "radio":
            _input._attr.type=d._input._type
        }
        _input._tag=d._input.
      }
      t._items[0]._text=
      */
    })
    return _view;
  },
  _getCheckAll:function(_setting){
    return {
      _tag:"label",
      _attr:{
        style:"margin:5px;"
      },
      _items:[
        {
          _tag:"input",
          _attr:{
            checked:function(){
              return !_setting._dataList.find(x=>!x._chk)
            },
            type:"checkbox",
            disabled:_setting._disable
          },
          _jqext:{
            click:function(){
              let _this=this
              setTimeout(()=>{
                for(var k in _setting._dataList){
                  if(_this.checked){
                    _setting._dataList[k]._chk="on"
                  }else{
                    _setting._dataList[k]._chk=""
                  }
                }
              },10)
            }
          }
        },
        {
          _text:"_bzMessage._common._all"
        }
      ]
    }
  },
  _getBatchSelector:function(_setting){
    let _header={
      _tag:"div",
      _attr:{
        style:"margin:5px 0"
      },
      _items:[
        _uiHandler._getCheckAll(_setting)
      ]
    }
    if(_setting._exHeader){
      _header._items.push(_setting._exHeader)
    }
    return [
      _header,
      {
        _tag:"div",
        _attr:{
          style:"display:block;padding:5px",
          class:"bz-row-hover"
        },
        _items:[
          {
            _tag:"input",
            _attr:{
              type:"checkbox",
              disabled:_setting._disable
            },
            _dataModel:"_data._item._chk"
          },
          ..._setting._cols
        ],
        _dataRepeat:function(){
          return _setting._dataList
        },
        _jqext:{
          click:function(e){
            if(_setting._clickRow){
              _setting._clickRow()
            }else if(e.target.type!="checkbox"){
              $(this).find("input:first").click()
            }
          }
        }
      }
    ]
  },
  _getToggle:function(d){
    return {
      _if:d._if,
      _tag:d._tag||"a",
      _attr:{
        class:d._class||"bz-clickable"
      },
      _text:function(){
        let v=eval(d._dataModel)
        return d._text[v?1:0]
      },
      _jqext:{
        click:function(){
          eval(d._dataModel+"=!"+d._dataModel)
          _Util._resizeModelWindow()
        }
      }
    }
  },
  //_curParameter,_autoSize,_height,_textHeight,_insert
  _getJsonFormEditor:function(p,_tabName){
    _tabName=_tabName||"_curDefParameterFormatTab"
    var _curParameter=p._parameter,
        _autoSize=p._autoSize,
        _height=p._height,
        _textHeight=p._textHeight,
        _includeMapEditor=p._includeMapEditor,
        _tmpValue;
    BZ._data._uiSwitch[_tabName]=BZ._data._uiSwitch[_tabName]||"_text"
    //Body
    return {
      _if:function(){
        let a=BZ._data._uiSwitch
        if(a._lastJsonFormEditor&&a._lastJsonFormEditor!=_IDE._data._curTest){
          a._lastJsonFormEditor=0
          setTimeout(()=>{
            a._lastJsonFormEditor=_IDE._data._curTest
          },10)
          return
        }else{
          a._lastJsonFormEditor=_IDE._data._curTest
        }
        return 1
      },
      _tag:"div",
      _attr:{
        "class":"bz-h-h-tabs",
        style:function(){
          return "height:calc(100% - "+(_height||0)+"px);width:calc(100% - 0px);padding-right:0;margin-top:"+(p._marginTop||"unset")
        }
      },
      _items:[
        //Tabs
        {
          _if:function(){
            return BZ._data._uiSwitch[_tabName]!='_other'
          },
          _tag:"div",
          _attr:{
            "class":"bz-h-h-tab-items",
            style:"display: flex;flex-direction: row-reverse;"
          },
          _items:[
            {
              _if:function(){
                return _includeMapEditor
              },
              _tag:"button",
              _attr:{
                "class":"btn btn-icon bz-match pull-right",
                title:"_bzMessage._action._mapTestParameter"
              },
              _jqext:{
                click:function(){
                  _showGenerateTool()
                }
              }
            },
            {
              _tag:"div",
              _attr:{
                "class":function(d){
                  return 'bz-auto-tab bz-h-h-tab-item '+(BZ._data._uiSwitch[_tabName]==d._item?'active':'')
                }
              },
              _jqext:{
                click:function(){
                  BZ._data._uiSwitch[_tabName]=this._data._item
                  _Util._resizeModelWindow()
                }
              },
              _text:"_bzMessage._test._defParameter[_data._item]",
              _dataRepeat:function(){
                var v,_uiSwitch=BZ._data._uiSwitch;
                if(_curParameter=="_IDE._data._curTest._data.defParameter"){
                  if(BZ._isRecording()){
                    return ["_json"]
                  }else if(_uiSwitch._curDefParameterView!="$parameter"){
                    return ["_form"]
                  }
                }

                v=_ideTestManagement._getDefParameterViewData(_curParameter)
                if(v&&v.constructor==String){
                  if(v.match(/\: *[\{\[]/)){
                    return ["_json"]
                  }
                  if(!_Util._hasCode(v)&&_uiSwitch[_tabName]!="_text"){
                    if(_uiSwitch[_tabName]=="_form"){
                      _uiSwitch[_tabName]="_text"
                    }
                  }
                  if(v.match(/^[$](test|module|project|loop|parameter)/)){
                    try{
                      eval("_tmpValue="+v)
                      if(v.trim()[0]=="{"){
                        return ["_text","_form"]
                      }else{
                        _uiSwitch[_tabName]="_text"
                        return ["_text"]
                      }
                    }catch(e){}
                  }
                  if(_uiSwitch[_tabName]=="_form"){
                    _uiSwitch[_tabName]="_text"
                  }
                  _uiSwitch[_tabName]="_text"
                  return ["_text"]
                }else if(v){
                  for(let k in v){
                    if(v[k]&&[Object,Array].includes(v[k].constructor)){
                      _uiSwitch[_tabName]="_json"
                      return ["_json"]
                    }
                  }
                }
                
                if(_Util._getMixDataLevel(v)>2||_Util._hasDeepArray(v)){
                  if(_uiSwitch[_tabName]=="_form"){
                    _uiSwitch[_tabName]="_json"
                  }
                  return ["_json"]
                }else if(_uiSwitch[_tabName]=="_text"){
                  _uiSwitch[_tabName]="_json"
                }

                _uiSwitch[_tabName]=_uiSwitch[_tabName]||"_form"
                return ["_json","_form"]
              }
            },
            {
              _tag:"div",
              _attr:{
                style:"flex:1"
              }
            },
            //lws-new
          ]
        },
        {
          _tag:"div",
          _attr:{
            "class":"bz-h-h-tab-content bz-def-parameter-box",
            style:function(){
              if(_autoSize){
                return "height: calc(100% - "+(_textHeight||10)+"px);overflow: auto;"
              }else{
                return "max-height:300px;"
              }
            }
          },
          _items:[
            {
              _tag:"div",
              _attr:{
                "class":"bz-h-h-tab-content-box1"
              },
              _items:[
                //form
                {
                  _if:function(){
                    return BZ._data._uiSwitch[_tabName]=='_form'
                  },
                  _tag:"div",
                  _attr:{
                    style:function(){
                      _tmpValue=_ideTestManagement._getFinalParameterData(_curParameter)
                    }
                  },
                  _items:[
                    {
                      _if:function(){
                        return _ideTestManagement._isMutipleModuleParameter(_ideTestManagement._getDefParameterViewData(_curParameter))
                      },
                      _tag:"div",
                      _items:[
                        {
                          _tag:"div",
                          _items:[
                            //header
                            {
                              _tag:"div",
                              _attr:{"class":"bz-parameter-group-header"},
                              _items:[
                                {
                                  _tag:"a",
                                  _attr:{
                                    style:"margin: 0;padding: 5px;font-weight: bold;font-size:15px;float:left;"
                                  },
                                  _text:function(d){
                                    var m=_ideObjHandler._getDataByPath(d._key)
                                    if(m&&m._data&&m._data.tests){
                                      var cs=_IDE._data._curTest._closedDefData;
                                      if(!cs||!cs.includes(m._data.code)){
                                        return "- "+m._data.name
                                      }else{
                                        return "+ "+m._data.name
                                      }
                                    }else{
                                      return d._key
                                    }
                                  },
                                  _jqext:{
                                    click:function(){
                                      var cs=_IDE._data._curTest._closedDefData=_IDE._data._curTest._closedDefData||[]
                                      var i=cs.indexOf(this._data._key)
                                      if(i>=0){
                                        cs.splice(i,1)
                                      }else{
                                        cs.push(this._data._key)
                                      }
                                    }
                                  }
                                },
                              ]
                            },
                            //body
                            {
                              _if:function(d){
                                if(_IDE._data._curTest._closedDefData){
                                  return !_IDE._data._curTest._closedDefData.includes(d._key)
                                }
                                return 1
                              },
                              _tag:"div",
                              _items:[
                                _getParameterForm("_data._item",_curParameter)
                              ]
                            }
                          ],
                          _dataRepeat:function(){
                            return _tmpValue
                          }
                        }
                      ]
                    },
                    {
                      _if:function(){
                        return !_ideTestManagement._isMutipleModuleParameter(_ideTestManagement._getDefParameterViewData(_curParameter))
                      },
                      _tag:"div",
                      _attr:{style:"overflow-y:auto;overflow-x:hide;"},
                      _items:[
                        _getParameterForm("_tmpValue",_curParameter)
                      ]
                    }
                  ]
                },
                //JSON
                {
                  _if:function(d){
                    return ['_json','_text'].includes(BZ._data._uiSwitch[_tabName])
                  },
                  _tag:"div",
                  _attr:{
                    style:"height:100%"
                  },
                  _items:[
                    _bzJSEditor._buildJSEditor({
                      _model:_curParameter,
                      _noBtn:1,
                      _inJson:1,
                      _label:"",
                      _placeholder:_bzMessage._tools._jsonWithData,
                      _noReadonly:p._disabled,
                      _style:p._jsEditorStyle||"height:calc(100% - 0px)",
                      // _style:"min-height:200px;height:calc(100% - 10px)",
                      _befUpdate:function(_editor,_fun){
                        if(p._befUpdate){
                          p._befUpdate(_editor,_fun,p)
                        }else{
                          _bzJSEditor._validateJSONFormat(_editor,_fun,p)
                        }
                      }
                    })
                  ]
                }
              ]
            }
          ]
        }
      ]
    }
    
    function _showGenerateTool(){
      BZ._data._uiSwitch._refTestParameters=_ideActionManagement._initMapParameterData(_curParameter)
      BZ._data._uiSwitch._tmpSelectedMap
      _Util._confirmMessage({
        _tag:"div",
        _attr:{"class":"bz-editor-box"},
        _items:[
          {
            _tag:"div",
            _attr:{"class":"col-xs-12"},
            _items:[
              {
                _tag:"span",
                _text:"_bzMessage._test._targetParameter+' / '+_bzMessage._test._passParameter"
              },
              {
                _tag:"a",
                _attr:{
                  "class":"pull-right"
                },
                _text:"_bzMessage._method._autoMap",
                _jqext:{
                  click:function(){
                    BZ._data._uiSwitch._refTestParameters=_ideActionManagement._initMapParameterData(_curParameter,1)
                  }
                }
              }
            ]
          },
          {
            _tag:"div",
            _items:[
              {
                _tag:"div",
                _attr:{
                  "class":'input-group'
                },
                _items:[
                  {
                    _tag:"label",
                    _attr:{
                      "class":"input-group-addon",
                      title:"_bzMessage._test._orgDefValue+': '+_data._item._orgDefValue"
                    },
                    _items:[
                      {
                        _tag:"input",
                        _attr:{
                          type:"checkbox"
                        },
                        _dataModel:"_data._item._chk"
                      },
                      {
                        _text:"_data._key",
                      }
                    ]
                  },
                  {
                    _tag:"input",
                    _attr:{
                      "after-label":"_bzMessage._test._newValue",
                      "class":"form-control",
                      list:"_mapDataList"
                    },
                    _dataModel:"_data._item._mapName",
                  },
                  {
                    _tag:"datalist",
                    _attr:{
                      id:"_mapDataList"
                    },
                    _items:[
                      {
                        _tag:"option",
                        _attr:{
                          value:"_data._item._name",
                          title:"_data._item._staticValue?_bzMessage._test._staticValue:_data._item._new?_bzMessage._test._newValue:_data._item._value"
                        },
                        _text:"_data._item._name",
                        _dataRepeat:function(){
                          return BZ._data._uiSwitch._mapRefParameterOptions
                        }
                      }
                    ]
                  },
                ],
                _dataRepeat:function(){
                  
                  _Util._resizeModelWindow()

                  return BZ._data._uiSwitch._refTestParameters
                }
              }
            ]
          }
        ]
      },[{
        _title:_bzMessage._method._done,
        _click:function(c){
          let w=[],
              d=BZ._data._uiSwitch._refTestParameters
              
          for(var v in d){
            if(!d[v]._chk){
              continue
            }
            let vv=d[v]._mapName
            if(!vv&&vv!==false&&vv!==0){
              vv='""'
            }else if(vv&&!$.isNumeric(vv)&&(!_Util._hasCode(vv)||_Util._hasInsertCode(vv))&&!["true","false"].includes(vv)&&![true,false].includes(vv)&&!vv.match(/^\"[^\"]+\"$/)){
              vv='"'+vv+'"'
            }

            w.push(v+":"+vv)
          }
          w="{\n  "+w.join(",\n  ")+"\n}"
          
          if(!_Util._isSameMissJSON((_Util._stringToObj(p._parameter)||{}).toString(),w)){
            eval(p._parameter+"=w")
            let _tab=BZ._data._uiSwitch[_tabName]
            _ideTestManagement._save()
            BZ._data._uiSwitch[_tabName]="_other"
            setTimeout(()=>{
              BZ._data._uiSwitch[_tabName]=_tab
            },10)
          }
          c._ctrl._close()
        }
      }],_bzMessage._action._mapTestParameter)
    }
    
    function _isReadonlyParameter(_curParameter){
      var v=_ideTestManagement._getDefParameterViewData(_curParameter)
      return (BZ._data._uiSwitch._curDefParameterView!='$parameter'&&_curParameter=='_IDE._data._curTest._data.defParameter')
            ||(v&&v.constructor==String&&v.match(/[$](test|module|project|loop)/))
    }
    function _addDefParameterData(_this,_dataValue,_curParameter,_groupValue){
      BZ._data._uiSwitch._key=""
      BZ._data._uiSwitch._value=""
      _Util._confirmMessage({
        _tag:"div",
        _attr:{"class":"input-group"},
        _items:[
          {
            _tag:"label",
            _attr:{"class":"input-group-addon"},
            _text:"_bzMessage._common._key"
          },
          {
            _tag:"input",
            _attr:{"class":"form-control bz-key-input"},
            _focus:"!_data._idx",
            _dataModel:"BZ._data._uiSwitch._key"
          }
        ]
      },[{
        _title:_bzMessage._method._yes,
        _click:function(c){
          var d=_dataValue;

          d[BZ._data._uiSwitch._key]=BZ._data._uiSwitch._value
          if(_groupValue){
            _setParameterValue(_curParameter,_groupValue)
          }else{
            _setParameterValue(_curParameter,d)
          }

          BZ._data._uiSwitch[_tabName]="_other"
          setTimeout(function(){
            BZ._data._uiSwitch[_tabName]="_form"
          },100)
          _ideTestManagement._save()
          c._ctrl._close()
        }
      }])
    }
    function _getParameterForm(d,_curParameter){
      return {
        _tag:"table",
        _attr:{style:"margin:5px;width:calc(100% - 10px)"},
        _items:[
          {
            _tag:"tbody",
            _items:[
              {
                _tag:"tr",
                _items:[
                  {
                    _tag:"td",
                    _attr:{style:"text-align:left;width:0;padding-right:10px;"},
                    _items:[
                      {
                        _tag:"div",
                        _attr:{
                          style:"max-width:200px;white-space:nowrap;overflow:hidden;text-overflow: ellipsis;"
                        },
                        _items:[
                          {
                            _tag:"label",
                            _text:"_data._key"
                          }
                        ]
                      }
                    ]
                  },
                  {
                    _tag:"td",
                    _attr:{style:"width:100%;"},
                    _items:[
                      {
                        _tag:"input",
                        _attr:{
                          "class":"form-control",
                          value:"_data._item",
                          readonly:function(d){
                            if(_curParameter=="BZ._data._uiSwitch._apiRequest.headers"){
                              let v=_aiAuthHandler._data[BZ._data._uiSwitch._apiRequest.host].tokenValue
                              if(v[d._key]){
                                return 1
                              }
                            }
                            return _isReadonlyParameter(_curParameter)
                          }
                        },
                        _jqext:{
                          change:function(){
                            let v=this.value
                            if($.isNumeric(v)){
                              v=parseFloat(v)
                            }
                            if(d=="_tmpValue"){
                              _tmpValue[this._data._key]=v
                            }else{
                              _tmpValue[this._data._supData._key][this._data._key]=v
                            }
                          },
                          focus:function(){
                            BZ._curFocusInput=this
                            // setTimeout(function(){
                              // BZ._curFocusInput=0
                            // },30)
                          },
                          blur:function(){
                            if($(this).attr("readonly")||this.value==this._data._item){
                              return
                            }
                            var _this=this
                            setTimeout(function(){
                              var o=BZ._curFocusInput
                              _this._data._item=_this.value
                              _setParameterValue(_curParameter,_tmpValue)
                              _ideTestManagement._save()
                              setTimeout(function(){
                                if(o&&o!=_this){
                                  $(o).focus()
                                }
                              },200)
                            },20)
                          }
                        }
                      }
                    ]
                  },
                  {
                    _if:function(){
                      return !_isReadonlyParameter(_curParameter)
                    },
                    _tag:"td",
                    _attr:{style:"width:0"},
                    _items:[
                      {
                        _tag:"button",
                        _attr:{"class":"btn btn-icon bz-cross bz-small-btn"},
                        _jqext:{
                          click:function(){
                            var d=this._data//lws
                            if(d._supData._key){
                              delete _tmpValue[d._supData._key][d._key]
                            }else{
                              delete _tmpValue[d._key]
                            }
                            _setParameterValue(_curParameter,_tmpValue)

                            BZ._data._uiSwitch[_tabName]="_other"
                            setTimeout(function(){
                              BZ._data._uiSwitch[_tabName]="_form"
                              _Util._resizeModelWindow()
                            },100)
                            _ideTestManagement._save()
                          }
                        }
                      }
                    ]
                  }
                ],
                _dataRepeat:function(dd){
                  let v;
                  if(d=="_tmpValue"){
                    v=_tmpValue
                  }else{
                    v=dd._item
                  }
                  return v
                }
              }
            ]
          },
          {
            _if:function(){
              return !_isReadonlyParameter(_curParameter)
            },
            _tag:"tbody",
            _items:[
              {
                _tag:"tr",
                _items:[
                  {
                    _tag:"td",
                    _attr:{colspan:"100%"},
                    _items:[
                      {
                        _tag:"button",
                        _attr:{
                          "class":"pull-right btn btn-icon bz-small-btn bz-plus",
                          disabled:"!BZ._isCheckout()"
                        },
                        _jqext:{
                          click:function(){
                            let d=this._data._key
                            if(d&&!$.isNumeric(d)){
                              _addDefParameterData(this,this._data._item,_curParameter+"."+d,this._data._groupValue)
                            }else{
                              _addDefParameterData(this,_tmpValue, _curParameter)
                            }
                          }
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
    }
    
    function _setParameterValue(p,v){
      if(p&&p.startsWith("_IDE._data._curTest._data.defParameter")){
        if(BZ._data._uiSwitch._curDefParameterView!="$parameter"){
          return
        }
        let tt=BZ._lastUpdateTest||_IDE._data._curTest
        tt._data.defParameter=JSON.stringify(v)
        return
      }
      eval(p+"=JSON.stringify(v)")
    }
  },
  _getSelectValueInputViewDev:function(d){
    let _input=[
      {
        _if:d._if,
        _tag:"input",
        _attr:{
          class:"form-control"
        },
        _dataModel:d._dataModel,
        _jqext:d._jqext
      },
      {
        _if:d._if,
        _tag:"div",
        _attr:{
          class:"input-group-btn"
        },
        _items:[
          {
            _tag:"button",
            _attr:{
              class:"btn btn-icon bz-small-btn bz-caret-down"
            },
            _jqext:{
              mouseover:function(){
                let o=this.nextSibling;
                let r=o.getBoundingClientRect()
                $(o).css({
                  top:r.top+"px",
                  left:r.left+"px",
                  width:r.width+"px",
                  height:r.height+"px",
                  display:"block"
                })
              }
            }
          }
        ]
      },
      {
        _if:d._if,
        _tag:"select",
        _attr:{
          style:"position: absolute;opacity: 0;"
        },
        _items:d._optionItems||[
          {
            _tag:"option",
            _attr:{
              value:d._value
            },
            _text:d._text,
            _dataRepeat:d._dataRepeat
          }
        ],
        _jqext:{
          change:function(){
            let o=this.previousSibling.previousSibling
            if(d._dataModel){
              eval(d._dataModel+"=this.value")
            }
            o.value=this.value
            
            $(o).change()
          },
          mousemove:function(e){
            if(this.getBoundingClientRect().right-e.clientX>30){
             $(this).hide()
            }
          }
        }
      }
    ]

    if(d._label){
      _input={
        _tag:"div",
        _attr:{
          class:"input-group"
        },
        _items:[
          {
            _tag:"label",
            _attr:{
              class:"input-group-addon"
            },
            _text:d._label
          },
          _input
        ]
      }
    }
    return _input
  }
};window._uploadHandler={
  _retrieveBase64ValueFromLink:function(url){
    return url.substring(url.indexOf("base64,")+7); 
  },
  _base64ToBlob:function(o){
      var _sliceSize = 1024;
      var _byteChars = _Util._b64DecodeUnicode(this._retrieveBase64ValueFromLink(o.base64Link));
      var _byteArrays = [];

      for (var _offset = 0, _len = _byteChars.length; _offset < _len; _offset += _sliceSize) {
          var _slice = _byteChars.slice(_offset, _offset + _sliceSize);

          var _byteNumbers = new Array(_slice.length);
          for (var i = 0; i < _slice.length; i++) {
            _byteNumbers[i] = _slice.charCodeAt(i);
          }

          _byteArrays.push(new Uint8Array(_byteNumbers));
      }

      var v = new Blob(_byteArrays, {type:o.type});
      for(var k in o){
        try{
          v[k]=o[k];
        }catch(e){}
      }
      v.$ngfBlobUrl=window.URL.createObjectURL(v);
//      delete v.base64Link;
      return v;
  },
  _inputFileToBase64Obj:function(_files,_funNext,_idx,_result){
    if(!_idx){
      _idx=0;
    }
    if(!_result){
      _result=[];
    }
    if(_files.length<=_idx){
      return _funNext(_result);
    }
    var _file=_files[_idx++];
    var _reader = new FileReader();
    _reader.onload = function (e) {
      var v=e.target.result;
      var o = $.extend(null,_file);
      o.base64Link=e.target.result;
      _result.push(o);
      _uploadHandler._inputFileToBase64Obj(_files,_funNext,_idx,_result);
    }
    _reader.readAsDataURL(_file);
  },
  _buildUploadBold:function(_list){
    var _result=[];
    for(var i=0;i<_list.length;i++){
      var o=_list[i];
      _result.push(this._base64ToBlob(o));
    }
    return _result;
  },
  _setFileValue:function(_input,v){
    if(v.constructor==String){
      v=JSON.parse(v)
    }

    for(var i=0;i<v.length;i++){
      v[i].name=decodeURIComponent(v[i].name.split("?")[0]);
    }

    let a=_uploadHandler._buildUploadBold(v)
    let d = new ClipboardEvent('').clipboardData || new DataTransfer();
    a.forEach((x,i)=>{
      let f=new File([x],v[i].name,{type:v[i].type})
      d.items.add(f);
    })
    _input.files=d.files
    
    
    // let a=_uploadHandler._buildUploadBold(v)
    // let d = new ClipboardEvent('').clipboardData || new DataTransfer();
    // let f=new File(a,v[0].name,{type:v[0].type})
    // d.items.add(f);
    // f=new File(a,v[0].name,{type:v[0].type})
    _input.files=d.files
    
    
  },
  _outputSubmitResult:function(data,_target){
    var w=BZ.TW.open('',_target||"_"+"self");
    w.location.reload();
    w.document.write(data);
  },
  _overWriteSubmitForm:function(_field){
    if(_field.name){
      var _form=_uploadHandler._curForm=_Util._getParentNode(_field,"FORM");
      if(_form && !_form.BZ_handled){
        _form.BZ_handled=true;
        $(_form).on("submit",function(){
          this.submit();
        });
        _form.submit=function(){
          var ps=$(this).serializeArray();
          
          var formData = new FormData();
          
          for(var i=0;i<ps.length;i++){
            var p=ps[i];
            formData.append(p.name, p.value);
          }
           
          var fs=BZ._documents.find("div[type='file']")
          for(var i=0;i<fs.length;i++){
            var f=fs[i];
            for(var n=0;n<f.files.length;n++){
              formData.append($(f).attr("name"), f.files[n],f.files[n].name);
            }
          }
          var _this=this;
          $.ajax({
            url:this.action,
            type:this.method,
            data:formData,
            processData: false,
            contentType: false,
            success: function(data){
              _uploadHandler._outputSubmitResult(data,_this.target);
            },
            error:function(data){
              _uploadHandler._outputSubmitResult(data,_this.target);
            }
          });
          return true;
        }
        
        
      }
    }
  },
  _submitCurForm:function(){
    _uploadHandler._curForm.submit();
  },
  //p:path
  _keepChangeFileFun:function(p){
    //p[0]="window.document";
    if(window.jQuery){
      var o=$(p)[0];
      if(o && o.type=="file" && jQuery["_"+"data"](o).events && jQuery["_"+"data"](o).events.change){
        this._fileChangeFun=jQuery["_"+"data"](o).events.change;
      }
    }
  },
  _exeKeepChangeFileFun:function(p){
    p=_Util._getElementByQuickPath(p)
//    console.log(p)
//    p.dispatchEvent(new Event("load"));
    p.dispatchEvent(new Event("change",{bubbles:true}));
  },
  _getProjectFiles:function(){
    return _IDE._data._curVersion.setting.defaultData.filter(x=>x.type=="r"&&x.value.url&&x.value.url.includes("/"+"/"+location.host))
  },
  _findDataByFileName:function(v){
    let fs=_uploadHandler._getProjectFiles();
    return (fs.find(x=>x.value.name==v)||{}).name
  },
  _addProjectData:function(d){
    let n=_glossaryHandler._getVariableName(d.name)
    _IDE._data._curVersion.setting.defaultData.push({
      type:"r",
      name:n,
      value:{
        url:d.url,
        type:"file"
      }
    })
    _ideVersionManagement._save()
    return "$project."+n
  },
  _handleUploadFile:function(v,_fun){
    let d=_uploadHandler._findDataByFileName(v.name);
    if(d){
      return _fun("$project."+d)
    }
    let fs=_uploadHandler._getProjectFiles();
    if(fs.length>10){
      return alert(_bzMessage._action._limitFileCount)
    }
    _requestHandler._callService({
      _data:{
        method:"POST",
        url:"/api/projects/"+BZ._data._curProject.code+"/uploadFileData/",
        data:v
      },
      _success:function(x){
        _fun(_uploadHandler._addProjectData(x.result))
      }
    });
  },
  _askHandleFile:function(a,_fun){
    let v=a._uploadFile[0]
    v.file=v.base64Link
    delete v.base64Link
    delete a._uploadFile
    _Util._confirmMessage({
      _tag:"div",
      _items:[
        {
          _tag:"label",
          _text:"_bzMessage._action._confirmUploadFileToServer"
        }
      ]
    },[{
      _title:_bzMessage._method._not,
      _class:"btn-secondary",
      _click:function(c){
        if(v.size>6000){
          return alert(_bzMessage._action._tooLargeInScript)
        }
        c._ctrl._close()
      }
    },{
      _title:_bzMessage._method._yes,
      _click:function(c){
        _uploadHandler._handleUploadFile(v,function(n){
          a.event.value=`{{${n}}}`
          $(".row-selected").click()
        })
        c._ctrl._close()
      }
    },{
      _title:_bzMessage._method._cancel,
      _class:"btn-secondary",
      _click:function(c){
        a.event.value=""
        $(".row-selected").click()
        c._ctrl._close()
      }
    }],0,0,1)
  }
};/**/
var _elementMonitor={
  _config:{ attributes: true, childList: true, characterData: true,subtree:true,attributeOldValue:true,characterDataOldValue:true },
  _docs:[],
  _curMutations:[],
  
  _observer: new MutationObserver(function(_mutations) {
    _mutations.forEach(function(_mutation) {
      if((_mutation.type!="attributes" || !["id"].includes(_mutation.attributeName))){
        _elementMonitor._curMutations.push({_mutation:_mutation,_time:Date.now()});
      }
    });
  }),
  _close:function(){
    this._docs=[];
    this._observer.disconnect();
  },
  _addObj:function(d){
    if(!this._docs.includes(d)){
      _domRecorder._lastActionTime=Date.now()
      this._observer.disconnect();
      this._docs.push(d);
      for(var i=this._docs.length-1;i>=0;i--){
        var _doc=this._docs[i];
        if(!_doc || !_doc.defaultView || _doc.defaultView.closed){
          this._docs.splice(i,1);
        }else{
          this._observer.observe(_doc.body,this._config);
        }
      }
    }
  },
  /*
  _handleMonitor:function(){
    var ms=_elementMonitor._curMutations;
//    clearTimeout(_elementMonitor._last);
    _elementMonitor._curMutations=[];
    var ts=[];
    for(var i=0;i<ms.length;i++){
      var m=ms[i]._mutation;
      var t=m.target;
      if(!t.tagName){
        continue;
      }
      if($(t).hasClass("BZIgnore") || $(m.addedNodes[0]).hasClass("BZIgnore")){
        continue;
      }
      
      if(m.type=="attributes"){
        if(m.oldValue==$(t).attr(m.attributeName)){
          continue;
        }
      }else if(m.addedNodes.length){
        if(m.addedNodes[0].tagName){
          t=m.addedNodes[0];
        }
      }
      if(t!==t.ownerDocument.body && _domRecorder._lastActionTime && _domRecorder._lastActionTime<=ms[i]._time && !ts.includes(t) && $(t.ownerDocument.body).find(t).length){
        if(!_Util._isHidden(t)){
          ts.push(t);
        }
      }
    }

    var us=this._findUpdateArea(ts);
    // _domRecorder._generateAIValidation(us)
  },
  */
  _findUpdateArea:function(ts){
    var ws=[];
    for(var i=0;i<ts.length;i++){
      var t=ts[i];
      var _foundWin=false;
      for(var n=0;n<ws.length;n++){
        if(t.ownerDocument==ws[n][0].ownerDocument){
          ws[n].push(t);

          _foundWin=true;
          break;
        }
      }
      if(!_foundWin){
        ws.push([t])
      }
    }
    var us=[];
    for(var i=0;i<ws.length;i++){
      var es=ws[i];
      var a=es[0].ownerDocument.body;
      var ees=[];
      for(var n=0;n<es.length;n++){
        if($(a).find(es[n]).length){
          ees.push(es[n]);
        }
      }
      this._removeSubElements(ees);
//      if(ees.length && ees.length<4){}
//      var e=!ees.length?null:ees.length==1?ees[0]:this._findMinSharingElement(a,ees);
      us=us.concat(ees);
    }
    return us;
  },
  _removeSubElements:function(es){
    for(var i=0;i<es.length;i++){
      var ees=$(es[i]).find(es);
      if(ees.length){
        for(var i=0;i<ees.length;i++){
          var n=es.indexOf(ees[i]);
          if(n>=0){
            es.splice(n,1)
          }
        }
        return this._removeSubElements(es);
      }
    }
  },
  _findMinSharingElement:function(d,es){
    for(var i=0;i<d.childNodes.length;i++){
      var c=d.childNodes[i];
      var _len=$(c).find(es).length;
      if(_len==es.length || (es.includes(c) && _len==es.length-1)){
        return this._findMinSharingElement(c,es);
      }
    }
    return d;
  }
}
/**/;var _ideObjHandler={
  //_map:_CtrlDriver._buildProxy({"":{_subModules:[]}}),
  _treeList:_CtrlDriver._buildProxy([]),
  _SUBLISTKEYS:["tests","modules"],
  _unlockAllMe:function(_fun){
    let d=_IDE._data
    if(d._curVersion.lockBy==curUser.code){
      _ideVersionManagement._lock(1,function(){
        _ideModuleManagement._unlockAllMe(_fun)
      })
    }else{
      _ideModuleManagement._unlockAllMe(_fun)
    }
  },
  _init:function(){
    _ideObjHandler._map=_CtrlDriver._buildProxy({"":{_subModules:[]}}),
    _ideObjHandler._map[""]._data=_IDE._data._curVersion;
    var ms=_IDE._data._curVersion.modules;
    for(var i=0;i<ms.length;i++){
      var m=ms[i];

      m.name=_compressJSON._unConvert(m.name);
      m.dataMap=_compressJSON._unCompress(m.dataMap)||[];
      var o={_data:m,_subModules:[],_loaded:0,_selectedFields:[]};
      _ideObjHandler._map[m.code]=o;
      _ideObjHandler._buildTestMap(o);
    }
    
    for(var i=0;i<ms.length;i++){
      var m=ms[i];
      if(!m.parentModule){
        m.parentModule="";
      }
      var pm=_ideObjHandler._map[m.parentModule];
      if(pm){
        pm._subModules.push(m);
      }
    }
    if(!bzTwComm._isExtension()){
      if(BZ._isInDemo()){
        _ideObjHandler._mergeDemoData(_IDE._data._curVersion);
      }else{
        _ideObjHandler._cleanData(_IDE._data._curVersion);
      }
    }
    _ideObjHandler._buildModuleTreeList()
    _mainMenuHandler._initWorkspace()
  },
  _getModuleByRefKey:function(k){
    //TODO: goto update
    if(!_ideObjHandler._refKeyMap){
      _ideObjHandler._refKeyMap={}
      _IDE._data._curVersion.modules.forEach(x=>{
        if(x.definition&&x.definition.refKeys){
          x.definition.refKeys.forEach(y=>{
            _ideObjHandler._refKeyMap[y]=_ideObjHandler._refKeyMap[y]||[]
            _ideObjHandler._refKeyMap[y].push(x.code)
          })
        }
      })
    }
    return _ideObjHandler._refKeyMap[k]||[]
  },
  _hasAIModule:function(){
    return _IDE._data._curVersion.modules.find(m=>{
      return m.bt=='data'
    })
  },
  _getRootModule:function(m){
    m=m||_IDE._data._curModule
    if(m){
      if(m._data.parentModule){
        m=_ideObjHandler._getDataByPath(m._data.parentModule)
        return _ideObjHandler._getRootModule(m)
      }
      return m
    }
  },
  _getRefTests:function(t,_fun){
    let vs=[]
    t=_ideObjHandler._getDataByPath(t)
    if(t){
      _ideModuleManagement._loadItem(t._parent,function(){
        t._data.actions.forEach(a=>{
          a=(a.refOfSuccess||"").match(_IDE._testKeyRegex)
          if(a){
            vs.push("/"+a[0].replace(".","/"))
          }
        })
        _output(vs)
      })
    }else{
      _output(vs)
    }
    
    return vs
    
    function _output(v){
      _ideReport._outputFile("list-suite.txt",v.join("\n"))

      _fun&&_fun(v)
    }
  },
  _getItemsByTag:function(_tags,_type,_pathOnly){
    var os=[]
    for(var k in _ideObjHandler._map){
      if(k[0]=="m"){
        var m =_ideObjHandler._map[k]._data;
        var ttt=m.tests||[]
        ttt.forEach(tt=>{
          if(tt.type==_type&&_isMatch(m.tag+","+tt.tag)){
            if(_pathOnly){
              os.push("/"+m.code+"/"+tt.code)
            }else{
              os.push({path:"/"+m.code+"/"+tt.code,data:tt})
            }
          }
        })
      }
    }
    if(_pathOnly){
      _ideReport._outputFile("list-scenarios.txt",os.join("\n"))
    }
    return os;
    function _isMatch(v){
      if(v){
        v=v.split(",").map(vv=>{return vv.trim()})
        for(var i=0;i<_tags.length;i++){
          var t=_tags[i],_found=0;
          t=t.split(",").map(o=>{return o.trim()})
          for(var n=0;n<t.length;n++){
            var st=t[n].trim()
            if(st){
              if(st[0]=="~"){
                if(!v.includes(st.substring(1))){
                  _found=1
                  break
                }
              }else{
                if(v.includes(st)){
                  _found=1
                  break
                }
              }
            }
          }
          if(!_found){
            return
          }
        }
        return 1
      }
    }
  },
  _mergeDemoData:function(v){
    var d=_localStorageManagement._getCurProjectData();
    for(var k in d){
      if(k.match(/^m[0-9]{13}$/)){
        var m=_compressJSON._unCompress(d[k].tmp.value)
        m.code=k
        m.updateStamp=m.createStamp={time:Date.now()}
        m.tests=[]
        _ideObjHandler._addModule(m)
      }
      for(var kk in d[k]){
        if(kk.match(/^t[0-9]{13}$/)){
          var t=_localStorageManagement._retrieve([k,kk,"tmp"]);
          if(!t){
            t=_localStorageManagement._retrieve([k,kk]);
          }
          t=_compressJSON._unCompress(t.value);
          if(t.doc){
            var c=_compressJSON._unCompress(t.doc.content);
            $.extend(t,c);
          }
          t.code=kk;
          t.updateStamp=t.createStamp={time:Date.now()}
          _ideObjHandler._addTest(k,t)
        }
      }
    }
  },
  _getItemType:function(d){
    d=d._data||d
    return d.tests?"module":d.modules?"version":d.actions?"test":"action"
  },
  _getItemPath:function(d,p){
    d=d._data||d
    let c=d.code,_path
    if(c){
      if(c=="com"||c[0]=="m"){
        return c
      }
    }else if(!d.modules){
      if(p&&p.actions.includes(d)){
        return _ideObjHandler._getItemPath(p)+"/"+(p.actions.indexOf(d)+1)
      }
    }else{
      return "/"
    }
    _IDE._data._curVersion.modules.find(m=>{
      return m.tests.find(t=>{
        if(c&&t==d){
          _path="/"+m.code+"/"+t.code
          return 1
        }else{
          return t.actions.find((a,i)=>{
            if(a==d){
              _path="/"+m.code+"/"+t.code+"/"+(i+1)
              return 1
            }
          })
        }
      })
    })
    return _path
  },
  _hasData:function(d){
    try{
      d=d.dataMap||d.defaultData;
      return Object.keys(d.k).length
    }catch(e){}
  },
  _setNoReadyItem:function(m,t){
    if(BZ._isAutoRunning()){
      return
    }
    
    setTimeout(()=>{
      if(t){
        if(!t.actions||!t.actions.length){
          _ideObjHandler._setNoReadyItem(m)
        }else{
          _setTestNoReady(t)
        }
      }else{
        m=_ideObjHandler._getDataByPath(m.code)
        _ideModuleManagement._loadItem(m,mm=>{
          var mv=0
          m._data.tests.forEach(t=>{
            _setTestNoReady(t)
            if(t._noReady){
              mv=1
            }
          })
          if(m._data._noReady!=mv){
            m._data._noReady=mv
          }
        })
      }
    },100)
    
    function _setTestNoReady(t){
      t._noReady=0
      if(!t.definition){
        for(var i=0;i<t.actions.length;i++){
          if(!_ideActionManagement._getDataStatus(t.actions[i])){
            t._noReady=1
            return
          }
        }
      }
    }
  },
  _cleanData:function(v){
    var ms=[];
    
    for(var i=0;i<v.modules.length;i++){
      ms.push(v.modules[i].code);
    }
    _localStorageManagement._cleanData([],ms);
    for(var i=0;i<v.modules.length;i++){
      var m=v.modules[i];
      while(!m && i<v.modules.length){
        v.modules.splice(i,1);
        m=v.modules[i];
      }
      if(m){
        var ts=[];
        for(var n=0;n<m.tests.length;n++){
          var t=m.tests[n];
          while(!t && n<m.tests.length){
            m.tests.splice(n,1)
            t=m.tests[n];
          }
          if(t){
            ts.push(t.code);
          }
        }
        _localStorageManagement._cleanData([m.code],ts);
      }
    }
    _localStorageManagement._cleanVersion();
  },
  _buildTestMap:function(_data){
    if(!_data._data.tests){
      return;
    }
    var m=_data._data;
    _data._testMap=_CtrlDriver._buildProxy({});
    for(var n=0;n<m.tests.length;n++){
      let t=m.tests[n]
      t.name=_compressJSON._unConvert(t.name);
      t=_CtrlDriver._buildProxy(t);
      m.tests[n]=t;
      if(!t.actions){
        t.actions=[];
      }
      if(_data._testMap[t.code]){
        m.tests.splice(n--,1)
      }else{
        _data._testMap[t.code]=_ideObjHandler._newTestData(t,_data);
      }
    }
  },
  _getKey:function(m,t,a){
    m=m||BZ._getCurModule()
    if(m){
      m=m._data||m
      m=m.code||m
      
      t=t||BZ._getCurTest()
      if(t){
        t=t._data||t
        a=a||""
        if(a){
          a=t.actions.indexOf(a)
          if(a>=0){
            a="."+a
          }
        }
        t=t.code||t
        return m+"."+t+a
      }else{
        return m
      }
    }
    
  },
  _newTestData:function(t,m){
    var _definition=t.definition
    if(_definition&&m._data.definition){
      if(_definition.code&&t.type!="scenario"){
        //set module operation to test data definition 
        t.definition=_aiGeneratorDataHandler._getItemByGroupAndCode("operations",_definition.code,m)||t.definition
      }
    }
    let d=_CtrlDriver._buildProxy({
      _data:t,
      _dragoverObj:0,
      _dragObj:0,
      _parent:m,
      _actionDebugMap:{},
      _result:[],
      _groupActions:[]
    });
    if(window._debugDataHandler){
      d._debugData=_debugDataHandler._retrieveDataFromLocalStorage(m,t,"bz-debug")
      d._requests=_debugDataHandler._retrieveDataFromLocalStorage(m,t,"bz-requests")
    }
    return d
  },
  _getDataByPath:function(m,t,a){
    try{
      if(!m){
        return _ideObjHandler._map[""];
      }else if(m.constructor!=String){
        m=m._data||m
        return _ideObjHandler._getDataByPath(m.code,t,a)
      }else if(m.match(/[./]/)){
        var d1=m.match(/([\.\/]?(m[0-9]+|com|bug))+[\.]?(t[0-9]+)?[\.]?([0-9]*)/)
        var d2=m.match(/([\.\/]?(m[0-9]+|com|bug))+[\/]?(t[0-9]+)?[\/]?([0-9]*)/)
        if(d1||d2){
          d1=d1||[]
          d2=d2||[]
          t=d1[3]||d2[3]
          a=d1[4]||d2[4]
          if($.isNumeric(a)){
            a=parseInt(a)-1
          }
          m=d2[2]||d2[2]
        }else{
          m=m.match
        }
      }
      m=_ideObjHandler._map[m];
      if(m && t){
        t=m._testMap[t.code||t];
        if(t && $.isNumeric(a)){
          return t._data.actions[a];
        }
        return t;
      }
      return m;
    }catch(E){}
  },
  _addTest:function(_moduleCode,_test){
    var m=_ideObjHandler._map[_moduleCode];
    if(m && m._testMap){
      _test=_CtrlDriver._buildProxy(_test);
      //add to map
      m._testMap[_test.code]=_ideObjHandler._newTestData(_test,m);

      //add to list 
      m._data.tests.push(_test);
      _ideDataManagement._addData(_moduleCode+_test.code,m._testMap[_test.code])
      return _test;
    }
  },
  _deleteTest:function(_moduleCode,_testCode){
    var m=_ideObjHandler._map[_moduleCode];
    if(m && m._testMap){
      //delete from map
      var t=m._testMap[_testCode]
      t=t._data||t;

      m._testMap[_testCode]=0;
      delete m._testMap[_testCode];
      _ideDataManagement._deleteData(_moduleCode+_testCode)
      //delete from list
      for(var i=0;i<m._data.tests.length;i++){
        var t=m._data.tests[i];
        if(t.code==_testCode){
          m._data.tests.splice(i,1);
          for(var n=0;n<BZ._data._uiSwitch._selectedItems.length;n++){
            var o=BZ._data._uiSwitch._selectedItems[n];
            if(o==t){
              BZ._data._uiSwitch._selectedItems.splice(n,1);
              break;
            }
          }
        }
      }
      return t;
    }
  },
  _addModule:function(_module){
    //add main map
    _ideObjHandler._map[_module.code]={_data:_module,_subModules:[]};
    _module=_ideObjHandler._map[_module.code]._data;
    //add main list
    _IDE._data._curVersion.modules.push(_module);
    _ideObjHandler._buildTestMap(_ideObjHandler._map[_module.code])
    //add parent list
    
    if(!_module.parentModule){
      _module.parentModule="";
    }
    var m=_ideObjHandler._map[_module.parentModule];
    if(m){
      m._subModules.push(_module);
    }
    _ideDataManagement._addData(_module.code,_ideObjHandler._map[_module.code])
    _ideObjHandler._buildModuleTreeList()
  },
  _getSubModules:function(m){
    if(m===undefined||(m&&m.constructor!=Array)){
      m=_aiGeneratorDataHandler._getModuleObject(m)
      m=[m._data.code]
    }else if(m.constructor==String){
      m=[m]
    }
    
    var ms=[]
    _ideObjHandler._treeList.forEach(o=>{
      if(m.includes(o._parent)){
        ms.push(_ideObjHandler._getDataByPath(o._code))
      }
    })
    return ms
  },
  _isParentModule:function(p,c){
    p=(p._data||p).code||p
    c=_aiGeneratorDataHandler._getModuleObject(c)._data
    if(!c.parentModule){
      return
    }else if(c.parentModule==p){
      return 1
    }
    return _ideObjHandler._isParentModule(p,c.parentModule)
  },
  _updateModule:function(_module){
    var m=_ideObjHandler._getDataByPath(_module.code);
    if(!m){
      return;
    }
    _ideDataManagement._updateDataMap(m,_module)
    //update main map
    if(!_module.tests){
      let d=m._data._target||m._data
      $.extend(true,d,_module);
      if(d.definition){
        _Util._overwriteObj(d.definition,_module.definition)
      }
      
      _module=m._data;
      m._data=0;
      m._data=_module;
    }else{
      m._data=_module;
      m._md5=null;
      _ideObjHandler._buildTestMap(m);
    }

    //update main list
    for(var i=0;i<_IDE._data._curVersion.modules.length;i++){
      var m=_IDE._data._curVersion.modules[i];
      if(m.code==_module.code){
        _IDE._data._curVersion.modules[i]=_module;
        break;
      }
    }
    
    //update parent list
    var m=_ideObjHandler._map[_module.parentModule];
    if(m){
      for(var i=0;i<m._subModules.length;i++){
        var mm=m._subModules[i];
        if(mm.code==_module.code){
          m._subModules[i]=_module;
          break
        }
      }
    }
    _ideObjHandler._updateNameInTree(_module)
  },
  _deleteModule:function(_module,_noFinal){
    //delete from main list
    var _subItems=[];
    for(var i=0;i<_IDE._data._curVersion.modules.length;i++){
      var m=_IDE._data._curVersion.modules[i];
      if(m.code==_module.code){
        _IDE._data._curVersion.modules.splice(i,1);
        i--;
      }else if(m.parentModule==_module.code){
        _subItems.push(m);
      }
    }
    //delete from main map
    delete _ideObjHandler._map[_module.code];
    _ideDataManagement._deleteData(_module.code)
    //update parent list
    var m=_ideObjHandler._map[_module.parentModule];
    if(m){
      for(var i=0;i<m._subModules.length;i++){
        var mm=m._subModules[i];
        if(mm.code==_module.code){
          m._subModules.splice(i,1);
          break;
        }
      }
    }
    
    for(var i=0;i<_subItems.length;i++){
      _ideObjHandler._deleteModule(_subItems[i],1);
    }
    if(!_noFinal){
      _ideObjHandler._cleanData(_IDE._data._curVersion);
      _ideObjHandler._buildModuleTreeList()
    }
  },
  _isDirty:function(_moduleCode,_testCode){
    var _bDirty=false;
    var o=_ideObjHandler._getDataByPath(_moduleCode,_testCode);
    if(o){
      var _md5=_ideObjHandler._calcMD5(o._data);
      if(!o._md5){
        o._md5=_md5;
      }else{
        _bDirty=o._md5!=_md5;
      }
    }
    return _bDirty;
  },
  _calcMD5:function(d){ //falg for check dirty data 
    var ks=[];
    var v="";
    for(var k in d){
      if(_ideObjHandler._SUBLISTKEYS.indexOf(k)<0){
        if(d[k] || d[k]===0){
          ks.push(k);
        }
      }
    }
    ks.sort();
    for(var i=0;i<ks.length;i++){
      var o=d[ks[i]];
      if(o.constructor==Object || o.constructor==Array){
        o=_ideObjHandler._calcMD5(o);
      }
      v+=ks[i]+":"+o+",";
    }
    return _calcMD5(v);
  },
  _getIDEURL:function(_module,_test,_version){
    _version=_version||_IDE._data._curVersion.code
    let p=BZ._data._curProject.code
    let e=bzTwComm._isIDE()?SERVER_HOST+"/extension?id="+p:("/"+"/"+location.host+location.pathname)
    var v=e+"#"+p+"/"+_version;
    if(_module){
      v+="/";
      _module=_module._data||_module.code||_module;
      v+=_module.code||_module;
      if(_test){
        v+="/";
        _test=_test._data||_test;
        v+=_test.code||_test;
      }
    }
    if(!v.endsWith("/")){
      v+="/";
    }
    return location.protocol+v
  },
  _getRequestURL:function(_module,_test,_version){
    _version=_version||_IDE._data._curVersion.code
    var v="/api/projects/"+BZ._data._curProject.code+"/versions/"+_version;
    if(_module){
      v+="/modules/";
      _module=_module._data||_module
      if(_module){
        _module=_module.code||_module;
      }
      if(_module&&_module.constructor==String){
        v+=_module
      }
      if(_test){
        v+="/tests/";
        _test=_test._data||_test;
        _test=_test.code||_test;
        if(_test.constructor==String){
          v+=_test
        }
      }
    }
    if(!v.endsWith("/")){
      v+="/";
    }
    return v
  },
  _search:function(w){
    if(!w){
      return BZ._data._searchData=[];
    }
    w=w.toLowerCase();
    var ww=w.match(/(m|t)[0-9]+/g),wm,_length,_not=[];
    if(ww){
      w=ww[0]
      ww=ww[1]
    }else{
      wm=[...new Set(w.split(" "))]
      wm=wm.filter(x=>x)

    }
    var _data={_modules:{_key:[],_name:[]},_tests:{_key:[],_name:[]},_tags:{}};
    var _curModule=0
    for(var i=0;i<_IDE._data._curVersion.modules.length;i++){
      var m=_IDE._data._curVersion.modules[i];
      if(ww){
        if(m.code==w){
          _curModule=m
        }
      }else if(!m.code.indexOf(w)){
        _data._modules._key.push({_word:`[${m.code}] ${m.name}`,_start:0,_obj:m,_type:"_module",_url:_ideLocation._getPath("_module",m)});
      }else if(_isMatchData(m.tag,wm)){
        _addTag(m,m.code)
      }else if((m.type||"").includes(w)){
        _data._modules._name.push({_word:`${m.type}, [${m.code}] ${m.name}`,_start:m.type.indexOf(w),_obj:m,_type:"_module",_url:_ideLocation._getPath("_module",m)});
      }else if(_isMatchData(m.name,wm)){
        _data._modules._name.push({_word:`[${m.code}] ${m.name}`,_start:m.name.toLowerCase().indexOf(w),_obj:m,_type:"_module",_url:_ideLocation._getPath("_module",m)});
      }
      if(_curModule||!ww){
        for(var n=0;n<m.tests.length;n++){
          var t=m.tests[n];
          if(ww){
            if(t.code.includes(ww)){
              _data._tests._key.push({_word:`[${m.code}.${t.code}] ${t.name}`,_start:0,_obj:t,_type:"_test",_url:_ideLocation._getPath("_test",m,t)});
            }
          }else if(!t.code.indexOf(w)){
            _data._tests._key.push({_word:`[${m.code}.${t.code}] ${t.name}`,_start:0,_obj:t,_type:"_test",_url:_ideLocation._getPath("_test",m,t)});
          }else if(_isMatchData(t.tag,wm)){
            _addTag(t,m.code+"."+t.code)
          }else if((t.type||"").includes(w)){
            _data._tests._name.push({_word:`${t.type} [${m.code}.${t.code}] ${t.name}`,_start:t.type.indexOf(w),_obj:t,_type:"_test",_url:_ideLocation._getPath("_test",m,t)});
          }else if(_isMatchData(t.name,wm)){
            _data._tests._name.push({_word:`[${m.code}.${t.code}] ${t.name}`,_start:t.name.toLowerCase().indexOf(w),_obj:t,_type:"_test",_url:_ideLocation._getPath("_test",m,t)});
          }
        }
      }
      if(_curModule){
        break
      }
    }
    _data=_data._tests._key.concat(_data._modules._key)
         .concat(Object.values(_data._tags))
         .concat(_data._tests._name).concat(_data._modules._name);
    _data.sort(function(a,b){
      if(a._start==b._start){
        return a._word.length-b._word.length;
      }else{
        return a._start-b._start;
      }
    });
    
    if(_Util._isEmpty(_data)&&!w.match(/^m[0-9]/)){
      _searchInActions(w)
    }
    BZ._data._searchData=_data;
    
    function _searchInActions(w){
      _data=[]
      wm=wm.filter(x=>x!="action")
      _ideVersionManagement._loadAllData(()=>{
        _IDE._data._curVersion.modules.forEach(m=>{
          m.tests.forEach(t=>{
            t.actions.forEach((aa,i)=>{
              let a=_ideActionManagement._getSearchData(aa).replace(/[\"\'\-]/g," ").replace(/\s+/g," ")
              if(_isMatchData(a,wm)){
                a=_ideActionManagement._getAutoDescription(aa,1,t).replace(/[\"\'\-]/g," ").replace(/\s+/g," ")
                _data.push({
                  _start:a.toLowerCase().indexOf(w),
                  _word:`[${m.code}.${t.code}.${i+1}] ${a}`,
                  _obj:aa,
                  _parent:t,
                  _type:"_action",
                  _url:_ideLocation._getPath(0,m,t,aa)
                })
              }
            })
          })
        })
        BZ._data._searchData=_data;
      })
    }
    function _addTag(m,c){
      if(!_data._tags[m.tag]){
        _data._tags[m.tag]={
          _word:m.tag,
          _start:m.tag.toLowerCase().indexOf(w),
          _list:[],
          _type:"_tag"
        }
      }
      _data._tags[m.tag]._list.push({_name:m.name,_key:c,_data:m})
    }
    function _isMatchData(v,wm){
      v=v||""
      v=v.toLowerCase()

      return wm&&v&&!wm.find(x=>{
        if(x=="."){
        }else if(x[0]=="!"){
          return v.includes(x.substring(1))
        }else{
          return !v.includes(x)
        }
      })
    }
  },
  _getManagementByData:function(d){
    if(d.modules){
      return _ideVersionManagement;
    }else if(d.tests){
      return _ideModuleManagement;
    }else if(d.actions){
      return _ideTestManagement;
    }else {
      return _ideActionManagement;
    }
  },
  _getModulePath:function(m){
    m=_aiGeneratorDataHandler._getModuleObject(m)._data
    if(m.parentModule){
      return _ideObjHandler._getModulePath(_ideObjHandler._getDataByPath(m.parentModule))+"/"+m.code
    }
    return "/"+m.code
  },
  _updateNameInTree:function(m){
    _ideObjHandler._treeList.find(o=>{
      if(o._code==m.code){
        o._name=m.name
        return 1
      }
    })
  },
  _buildModuleTreeList:function(vs,ms,_level){
    var vs=vs||_ideObjHandler._treeList,ms=ms||_ideObjHandler._map,_level=_level||0,_tmpMap={},k,m;
    var ks=["name","tag","alias","comment"]
    if(!_level){
      vs.splice(0,vs.length)
    }
    
    for(k in ms){
      if(k!=="" && k!="bug"&&k!="ctrl"&&k!="com"){
        m=ms[k]._data
        ks.forEach(k=>{
          m[k]=_compressJSON._unConvert(m[k])
        })
        _tmpMap[k]={_name:m.name,bt:m.bt,_code:k,_level:_level,_parent:m.parentModule,dataMap:m.dataMap,_path:"/"+k}
      }
    }
    for(var k in _tmpMap){
      m=_tmpMap[k];
      if(!m._parent){
        vs.push(m)
        delete _tmpMap[k]
      }
    }
    while(Object.keys(_tmpMap).length){
      var _changed=0
      for(k in _tmpMap){
        m=_tmpMap[k];
        for(var i=0;i<vs.length;i++){
          var v=vs[i];
          if(v._code==m._parent){
            vs.splice(i+1,0,m)
            m._level+=v._level+1
            m._path=v._path+m._path
            delete _tmpMap[k]
            _changed=1
            break;
          }
        }
      }
      if(!_changed){
        break
      }
    }
  },
  _getSimilarModule:function(ns,_hostId){
    var ds=_ideObjHandler._getDataByPath()._data.modules
    var _max={v:0},n=ns.toString().replace(/[,]/g," ").toLowerCase();
    for(var i=0;i<ds.length;i++){
      if(ds[i].defaultHostId!=_hostId&&_hostId!==undefined){
        continue;
      }
      var d=ds[i].name.toLowerCase(),v=0;
      if(d==n){
        return ds[i]
      }
      for(var j=0;j<ns.length;j++){
        if(d.includes(ns[j])){
          if(ns[j].length==1){
            v+=0.5
          }else{
            v++
          }
        }
      }
      if(Math.ceil(v)==ns.length){
        return ds[i]
      }
      if(_max.v<v && v>=1){
        _max={v:v,i:i}
      }
    }
    if(_max.v){
      return ds[_max.i]
    }
  },
  //m: module name, k: key
  _getSimilarTest:function(m,k){
    var ts=[],m=_ideObjHandler._getDataByPath(m),n;
    if(m){
      m=m._data.tests||[];
      for(var i=0;i<m.length;i++){
        ts.push(m[i].name)
      }
      n=_dictionaryHandler._getSimilarWord(ts,k)
      if(n){
        return m[ts.indexOf(n)]
      }
    }
  },
  _getModuleByTest:function(t,m){
    m=m||t._parent||_IDE._data._curVersion.modules.find(x=>x.tests.includes(t))
    if(m&&m.code){
      m=_ideObjHandler._getDataByPath(m.code)
    }
    return m
  }
};window._TWHandler={
  _resetTime:60000,
  _lastPageInfo:{},
  _curRequestList:[],
  BZ_sent:0,
  _popExpected:{alert:[],confirm:[],prompt:[],onbeforeunload:[]},
  _popActual:{alert:[],confirm:[],prompt:[],onbeforeunload:[]},
  _init:function(){
    this.BZ_sent=0;
    this._lastPageInfo={};
    this._popExpected={alert:[],confirm:[],prompt:[],onbeforeunload:[]};
    this._popActual={alert:[],confirm:[],prompt:[],onbeforeunload:[]};
  },
  startInit:function(){
    console.log("call startInit ...."+window.extensionContent)
    $(document.body).on("mouseover","a",function(){
      _Util._removeLinkTarget(this)
    })
    _TWHandler._takeoverOpenWin();
  },
  _uiSync:function(){
    
  },
  _chkPopInfo:function(_action,_second){ //for alert, confirm, prompt
    var a=_TWHandler._popActual;
    var e=_TWHandler._popExpected;

    for(var k in a){
      var aa=a[k].shift();
      var ee=e[k].shift();
      if (aa===undefined && (ee===undefined || ee.expection===undefined)) {
      }else if (aa===undefined) {
        if(!_second){
          e[k].unshift(ee);
          return "wait"
        }
        return _Util._formatMessage(_bzMessage._test._error._missPop,[k,ee.expection]);
      }else if (ee===undefined) {
        return _Util._formatMessage(_bzMessage._test._error._unexpectedPop,[k,aa]);
      }else if (aa.trim()!=ee.expection.toString().trim()) {
        return _Util._formatMessage(_bzMessage._test._error._unMatchPop,[k,ee.expection,aa]);
      }
    }
  },
  _setPlayMode:function(v){
    _TWHandler._curMode=v

    if(bzTwComm._isExtension()){
      bzTwComm._postToApp({c:"_TWHandler._curMode='"+v+"'"})
    }
  },
  _setBackTestPage:function(w){
    w=w||window
    this._init()
    if(w.BZ_Alert){
      w.alert=w.BZ_Alert;
      w.confirm=w.BZ_Confirm;
      w.prompt=w.BZ_Prompt;
      if(w.onbeforeunload){
        w.onbeforeunload=w.BZ_Onbeforeunload;
      }else if(_TWHandler._checkJQueryEvent().beforeunload){
        _TWHandler._checkJQueryEvent().beforeunload[0].handler=w.BZ_Onbeforeunload;
      }
      
      w.BZ_Alert=0;
      w.BZ_Confirm=0;
      w.BZ_Prompt=0;
      w.BZ_Onbeforeunload=0;
      delete w.BZ_Onbeforeunload_fun;
    }

    //take off outer link
    w.document._handledForOutDomain=false;
    if(window.BZ){
      $(w.document).off("click","a");
    }
 },
  _takeoverFileInput:function(w){
    w=w.HTMLInputElement?w.HTMLInputElement.prototype:0;
    
    if(w && !w._addEventListener){
      w._addEventListener=w.addEventListener;
      w.addEventListener=function(a,b,c){
        if(a=="change" && this.tagName=="INPUT" && this.type=="file"){
          _TWHandler._lastUploadFileFun=b;
        }
        this._addEventListener(a,b,c)
      }
    }
  },
  _takeoverWin:function(keepPopMsg,_data){
    if(bzTwComm._isExtension()){
      if(_data.event && _data.event.popType){
        $("#bzPopReturnData").remove();
        var v=document.createElement("div");
        v.id="bzPopReturnData";
        document.body.parentNode.appendChild(v);
        if(_data.event.alerts){
          $(v).text(JSON.stringify(_data.event.alerts))
        }else{
          $(v).text(_data.event.returnValue)
        }
      }
      return bzTwComm._postToApp({_fun:"_takeoverWin",_scope:"_TWHandler"})
    }else if(bzTwComm._isIDE()){
      return;
    }else{
      console.log("do _takeoverWin in app")
    }
    try{
      if(window.BZ){
        if(BZ._documents){
          BZ._documents.each(function(i,d){
            if(d){
              _doIt(d.defaultView)
            }
          });
        }
      }else{
        _doIt(window);
        var os=document.getElementsByTagName("IFRAME");
        for(var i=0;i<os.length;i++){
          v=os[i]
          if(!v.src||!v.src.startsWith("http")){
            if(v.contentDocument){
              _doIt(v.contentDocument.defaultView);
            }
          }
        }
      }
    }catch(e){
      console.log(e.stack)
    }
    function _doIt(w){
      if(!w||document.getElementById("bzOverrideMark")){
        return;
      }
      if(!keepPopMsg&&_TWHandler._curMode!="record"){
        _TWHandler._takeoverPopMsg(w);
      }

      _TWHandler._takeoverConsole(w);
      _TWHandler._takeoverFileInput(w);
      _TWHandler._setUnload();
      _TWHandler._takeoverOpenWin(w);
      _TWHandler._takeoverCanvas(w)
      _TWHandler._takeoverSocket(w);
      var a=document.createElement("div");
      a.id="bzOverrideMark";
      a.style.display="none";
      w.document.body.parentNode.appendChild(a)
    }
  },
  _takeoverConsole:function(w){
    if(!w._orgAssert){
      w._orgAssert=w.console.assert;
      var _this=this;
      w.console.assert=function(a,b){
        if(!a){
          _this._assertList=_this._assertList||[];
          _this._assertList.push(b)
        }
      }
    }
  },
  _takeoverCanvas:function(w){
    w=w||window
    if(window.name.includes("bz-client")){
      return
    }
    let _CanvasRenderingContext2D="Ca"+"nvas"+"Render"+"ingCont"+"ext2D",
        _prototype="pro"+"tot"+"ype",
        _fillText="fi"+"llTe"+"xt",
        _strokeText="st"+"rokeT"+"ext",
        _clearRect="cle"+"arR"+"ect",
        _reset="r"+"es"+"et",
        _setTransform="se"+"tTr"+"ansfo"+"rm",
        _transform="tr"+"ansfo"+"rm",
        _scale="sca"+"le",
        _translate="tra"+"nsla"+"te",
        _getTransform="ge"+"tTra"+"nsfo"+"rm",
        _drawImage="dra"+"wIma"+"ge",
        _putImageData="pu"+"tIma"+"geD"+"ata",
        _createImageData="cr"+"eateI"+"mageD"+"ata",
        _HTMLCanvasElement="HT"+"MLCan"+"vasEl"+"eme"+"nt",
        _width="wi"+"dth",
        _height="he"+"ig"+"ht",
        _setAttribute="setAttribute";
        
    if(!w[_CanvasRenderingContext2D][_prototype]._bzFillText){
      w[_HTMLCanvasElement][_prototype]._bzSetAttribute=w[_HTMLCanvasElement][_prototype][_setAttribute];
      w[_HTMLCanvasElement][_prototype][_setAttribute]=function(a,b){
        if(a=="width"||a=="height"){
          _clearMap(this["ge"+"tCon"+"tex"+"t"]("2"+"d"))
        }
        this._bzSetAttribute(a,b)
      }

      w[_CanvasRenderingContext2D][_prototype]._bzFillText=w[_CanvasRenderingContext2D][_prototype][_fillText];
      w[_CanvasRenderingContext2D][_prototype][_fillText]=function(a,b,c,d){
//        console.log("fill text: "+a+","+b)
        _handleFillText(this,a,b,c,d)
        this._bzFillText(a,b,c,d)
      }

      w[_CanvasRenderingContext2D][_prototype]._bzStrokeText=w[_CanvasRenderingContext2D][_prototype][_strokeText];
      w[_CanvasRenderingContext2D][_prototype][_strokeText]=function(a,b,c,d){
        _handleFillText(this,a,b,c,d)
        this._bzStrokeText(a,b,c,d)
      }


      w[_CanvasRenderingContext2D][_prototype]._bzClearRect=w[_CanvasRenderingContext2D][_prototype][_clearRect]
      w[_CanvasRenderingContext2D][_prototype][_clearRect]=function(a,b,c,d){
        // console.log("_clearMap:"+a+":"+b+":"+c+":"+d)
        _clearMap(this,a,b,c,d)
        this._bzClearRect(a,b,c,d)
      }

      w[_CanvasRenderingContext2D][_prototype]._bzReset=w[_CanvasRenderingContext2D][_prototype][_reset]
      w[_CanvasRenderingContext2D][_prototype][_reset]=function(a,b,c,d){
        // console.log("_clearMap:"+a+":"+b+":"+c+":"+d)
        _clearMap(this)
        this._bzReset(a,b,c,d)
      }

      if(!w[_CanvasRenderingContext2D][_prototype][_getTransform]){
        w[_CanvasRenderingContext2D][_prototype]._bzSetTransform=w[_CanvasRenderingContext2D][_prototype][_setTransform]
        w[_CanvasRenderingContext2D][_prototype][_setTransform]=function(a,b,c,d,e,f){
          _TWHandler._curTransform={
            a:a,b:b,c:c,d:d,e:e,f:f
          }
          this._bzSetTransform(a,b,c,d,e,f)
        }

        w[_CanvasRenderingContext2D][_prototype]._bzTransform=w[_CanvasRenderingContext2D][_prototype][_transform]
        w[_CanvasRenderingContext2D][_prototype][_transform]=function(a,b,c,d,e,f){
          let v=_TWHandler._curTransform=_TWHandler._curTransform||{a:1,b:0,c:0,d:1,e:0,f:0}
          v.e+=e*v.a
          v.f+=f*v.d
          v.a*=a
          v.b+=b
          v.c+=c
          v.d*=d
          // console.log("transform:"+v.a+":"+v.b+":"+v.c+":"+v.d+":"+v.e+":"+v.f)
          
          this._bzTransform(a,b,c,d,e,f)
        }

        w[_CanvasRenderingContext2D][_prototype]._bzScale=w[_CanvasRenderingContext2D][_prototype][_scale]
        w[_CanvasRenderingContext2D][_prototype][_scale]=function(a,b){
          let v=_TWHandler._curTransform=_TWHandler._curTransform||{a:1,b:0,c:0,d:1,e:0,f:0}
          v.a*=a
          v.d*=b
          // console.log("scale:"+v.a+":"+v.d)
          this._bzScale(a,b)
        }

        w[_CanvasRenderingContext2D][_prototype]._bzTranslate=w[_CanvasRenderingContext2D][_prototype][_translate]
        w[_CanvasRenderingContext2D][_prototype][_translate]=function(a,b){
          let v=_TWHandler._curTransform=_TWHandler._curTransform||{a:1,b:0,c:0,d:1,e:0,f:0}
          v.e+=a
          v.f+=b
          // console.log("translat:"+v.e+":"+v.f)
          this._bzTranslate(a,b)
        }

        w[_CanvasRenderingContext2D][_prototype]._bzGetTransform=w[_CanvasRenderingContext2D][_prototype][_getTransform]
        w[_CanvasRenderingContext2D][_prototype][_getTransform]=function(){
          if(this._bzGetTransform){
            return this._bzGetTransform()
          }else{
            return _TWHandler._curTransform||{a:1,b:0,c:0,d:1,e:0,f:0}
          }
        }
      }
      /*
      w[_CanvasRenderingContext2D][_prototype]._bzDrawImage=w[_CanvasRenderingContext2D][_prototype][_drawImage];
      w[_CanvasRenderingContext2D][_prototype][_drawImage]=function(a,b,c,d,e,f,g,h,j){
        let r=this[_getTransform]()
        if(a.src){
          let dd={
            t:a.src.split("/").pop().split(".")[0],
            w:h*r.a,
            h:j*r.d,
            x:f+r.e,
            y:g+r.f,
            _img:1
            // bg:bg
          }
          dd.c={x:dd.x+dd.w/2,y:dd.y+dd.h/2}
          _addData(this,dd)
        }
        this._bzDrawImage(a,b,c,d,e,f,g,h,j)
      }
      
      // w[_CanvasRenderingContext2D][_prototype]._bzMoveTo=w[_CanvasRenderingContext2D][_prototype].moveTo;
      // w[_CanvasRenderingContext2D][_prototype].moveTo=function(a,b){
        // // console.log("--------moveTo--------")
        // // let r=this[_getTransform]()
        // // console.log(r)
        // // console.log(a+":"+b)
        // // console.log("----------------------------")
        // this._bzMoveTo(a,b)
      // }
      
      // w[_CanvasRenderingContext2D][_prototype]._bzLineTo=w[_CanvasRenderingContext2D][_prototype].lineTo;
      // w[_CanvasRenderingContext2D][_prototype].lineTo=function(a,b){
        // // console.log("--------lineTo--------")
        // // console.log(this.canvas.getAttribute("bzTxtId"))
        // // console.log("strokeStyle: "+this.strokeStyle)
        // // console.log("lineWidth"+this.lineWidth)
        // // let r=this[_getTransform]()
        // // console.log(r)
        // // console.log(a+":"+b)
        // // console.log("----------------------------")
        // // if(a>10||b>10){
          // // return
        // // }
        // this._bzLineTo(a,b)
      // }

      w[_CanvasRenderingContext2D][_prototype]._bzCreateImageData=w[_CanvasRenderingContext2D][_prototype][_createImageData];
      w[_CanvasRenderingContext2D][_prototype][_createImageData]=function(a,b,c){
        // console.log("------CreateImageData------")
        // console.log(a+":"+b+":"+c)
        // console.log("----------------------------")
        this._bzCreateImageData(a,b,c)
      }

      w[_CanvasRenderingContext2D][_prototype]._bzPutImageData=w[_CanvasRenderingContext2D][_prototype][_putImageData];
      w[_CanvasRenderingContext2D][_prototype][_putImageData]=function(a,b,c,d,e,f){
        // console.log("-------[_putImageData]---------")
        // console.log(a+":"+b+":"+c+":"+d+":"+e+":"+f)
        // console.log("----------------------------")
        this._bzPutImageData(a,b,c,d,e,f)
      }
      /**/
    }else{
      return
    }

    function _handleFillText(cc,a,b,c,d){
      let h=parseInt(cc.font.match(/[0-9\.]+/)[0])
      // console.log(a+":"+b+":"+c+":"+h+":"+cc.measureText(a).width)
      // let bg=cc.getImageData(b, c-h, 1, 1)
      // bg=bg.data
      // bg=[bg[0],bg[1],bg[2],bg[3]]
      
      let r=cc[_getTransform](),
          ww=cc.measureText(a).width

      let dd={
        t:a,
        w:ww*r.a,
        h:h*r.d,
        x:b+r.e,
        y:c-h+r.f
        // bg:bg
      }
      
      // console.log(JSON.stringify(dd))
      // console.log(JSON.stringify(r))
      
      dd.c={x:dd.x+dd.w/2,y:dd.y+dd.h/2}
      if(cc.textAlign=="center"){
        dd.x-=dd.w/2
      }else if(cc.textAlign=="right"){
        dd.x-=dd.w
      }
      if(!cc._bzSetTransform||(dd.x>0&&dd.y>0)){
        _addData(cc,dd)
      }
    }

    function _clearMap(c,x,y,w,h){
      if(!_TWHandler._canvasDataMap){
        return
      }
      let _map=_TWHandler._canvasDataMap[c.canvas.getAttribute("bzTxtId")]
      if(_map){
        if(x===undefined){
          for(let k in _map){
            delete _map[k]
          }
        }else{
          let wx=w+x,hy=h+y
          for(var k in _map){
            let d=_map[k]
            _Util._spliceAll(d,v=>{
              return v.x>=x&&v.x<=wx&&v.y>=y&&v.y<=hy
            })
            if(!d.length){
              delete _map[k]
            }
          }
        }
        _TWHandler._buildCanvasDataPath()
      }
    }
    function _addData(c,d){
      d.t=(d.t||"").trim()
      if(!d.t){
        return
      }
      
      if(!d.t.match(_Util._allPrintableChr)){
        return 
      }

      let _key=c.canvas.getAttribute("bzTxtId")
      if(!_key||!_TWHandler._canvasDataMap[_key]){
        _key="bz"+Date.now()
        c.canvas.setAttribute("bzTxtId",_key)
        
        if(!_TWHandler._canvasDataMap){
          _TWHandler._canvasDataMap={}
        }

        _TWHandler._canvasDataMap[_key]={}
      }
      _clearMap(c,d.x,d.y,d.w,d.h)
      
      let _map=_TWHandler._canvasDataMap[_key]
      let dd=_map[d.t]
      if(!dd){
        dd=_map[d.t]=[]
      }
      
      dd.push(d)
      dd.sort((a,b)=>{
        let v=a.y-b.y
        if(!v){
          v=a.x-b.x
        }
        if(!v){
          v=a.w-b.w
        }
        if(!v){
          v=a.h-b.h
        }
        return v
      })
      _TWHandler._buildCanvasDataPath()
    }
  },
  _buildCanvasDataPath:function(){
    clearTimeout(_TWHandler._buildCanvasDataPathTimer)
    _TWHandler._buildCanvasDataPathTimer=setTimeout(()=>{
      _clean()
      _TWHandler._getCanvasData()
    },100)
    function _clean(){
      let cs=document.getElementsByTagName("CANVAS")
      for(var k in _TWHandler._canvasDataMap){
        let _found=0
        for(var i=0;i<cs.length;i++){
          if(cs[i].getAttribute("bzTxtId")==k){
            _found=1
            break
          }
        }
        if(!_found){
          delete _TWHandler._canvasDataMap[k]
        }
      }
    }
    
    // function _buildPath(){
      // let _keyList=[],_dpList=[];
      // for(var k in _TWHandler._canvasDataMap){
        // let c=_TWHandler._canvasDataMap[k]
        // for(var kk in c){
          // if(c[kk].length>1){
            // _dpList.push(c[kk])
          // }else{
            // _keyList.push(c[kk])
          // }
        // }
      // }
      // _dpList.forEach(a=>{
        
      // })
    // }
  },
  _getCloseCanvasItem:function(o,_list){
    let _min,x,y,vv;
    _list.forEach(v=>{
      if(o.x+o.w<=v.x||v.x+v.w<o.x){
        x=v.x-o.x-o.w
      }else{
        x=v.c.x-o.c.x
      }
      if(o.y+o.h<=v.y||v.y+v.h<o.y){
        y=v.y-o.y-o.h
      }else{
        y=v.c.y-o.c.y
      }
      
      vv=Math.pow(x*x+y*y,0.5)
      if(!_min||_min.v>vv){
        _min={
          o:v,
          v:vv
        }
      }
    })
    return _min
  },
  _getCanvasData:function(_map){
    if(bzTwComm._isApp()){
      bzTwComm._postToExt({_fun:"_getCanvasData",_args:[_TWHandler._canvasDataMap],_scope:"_TWHandler"})
    }else{
      return _TWHandler._canvasDataMap=_map||_TWHandler._canvasDataMap
    }
  },
  _getCanvasTextElement:function(c,t,i){
    if(_TWHandler._canvasDataMap){
      let m=_TWHandler._canvasDataMap[c.getAttribute("bzTxtId")]
      if(m){
        m=m[t]
        if(m){
          if(i!==undefined){
            return m[i]
          }
          return m
        }else{
          let tt=t.split(">"),ts=[]
          for(let j=0;j<tt.length;j++){
            let tv=tt[j]
            if(tv.endsWith("\\")&&j<tt.length-1){
              tv=tv.replace("\\",">")+tt[j+1]
              j--
            }
          }
          tt=tt.map(x=>x.trim())
          while(tt.length){
            let tv=tt.pop().replace(/\)$/,"")
            tv=_TWHandler._getCanvasTextElement(c,tv)
            if(tv){
              ts.unshift(tv)
            }else{
              return
            }
          }
          let kt=ts.shift(),_min
          while(ts.length){
            let to=ts.shift()
            kt.forEach((kk,i)=>{
              let mm=_TWHandler._getCloseCanvasItem(kk,to)
              if(!i||mm.v<_min.v){
                _min=mm
              }
            })
            if(_min){
              kt=[_min.o]
            }
          }
          if(i===undefined){
            return [_min.o]
          }else{
            return _min.o
          }
        }
      }
    }
  },
  _getCanvasTextElementIdx:function(c,d){
    if(_TWHandler._canvasDataMap){
      let m=_TWHandler._canvasDataMap[c.getAttribute("bzTxtId")]
      if(m){
        m=m[d.t]
        if(m){
          return m.findIndex(v=>{
            return v==d
          })
        }
      }
    }
  },
  _getCanvasTextElementByMousePos:function(c,x,y,_ignoreTxt){
    if(_TWHandler._canvasDataMap){
      let m=_TWHandler._canvasDataMap[c.getAttribute("bzTxtId")]
      if(m){
        let r=c.getBoundingClientRect(),_min;
        x-=r.left;
        y-=r.top;
        
        for(var k in m){
          let ds=m[k]
          for(var i=0;i<ds.length;i++){
            let d=ds[i]
            
            if(_ignoreTxt==d.t){
              continue
            }

            if(d.x<=x&&d.x+d.w>=x&&d.y<=y&&d.y+d.h>=y){
              return d
            }else{
              let v=Math.pow(Math.pow(d.c.x-x,2)+Math.pow(d.c.y-y,2),0.5)
              if(!_min||_min.v>v){
                _min={v:v,d:d}
              }
            }
          }
        }
        if(_min){
          let d=_min.d
          d.offset=0
          if(x<d.x||x>d.x+d.w||y<d.y||y>d.y+d.h){
            d.offset={
              X:parseInt(x-d.c.x),
              Y:parseInt(y-d.c.y),
              origin:"mc"
            }
          }
          return d
        }
      }
    }
  },
  _takeAssertInfo:function(){
    var v=this._assertList||[];
    this._assertList=[];
    return v;
  },
  _takeoverPopMsg:function(w){
    var _beforeunload=w.onbeforeunload || (_TWHandler._checkJQueryEvent().beforeunload?_TWHandler._checkJQueryEvent().beforeunload[0].handler:null);
    
    if((!w.BZ_Onbeforeunload && _beforeunload) || (w.BZ_Onbeforeunload_fun && w.BZ_Onbeforeunload_fun!=_beforeunload)){
      w.BZ_Onbeforeunload=_beforeunload;
      if(_beforeunload){
        _beforeunload=function(){
          _TWHandler._setOnbeforeunload(w.BZ_Onbeforeunload());
        };
        if(w.onbeforeunload){
          w.onbeforeunload=_beforeunload;
        }else{
          _TWHandler._checkJQueryEvent().beforeunload[0].handler=_beforeunload;
        }
      }
      w.BZ_Onbeforeunload_fun=_beforeunload;
    }
    if(w.BZ_Alert){
      return;
    }
    w.BZ_Alert=w.alert;
    w.BZ_Confirm=w.confirm;
    w.BZ_Prompt=w.prompt;
    
    w.alert=function(m){
      _TWHandler._setAlert(m);
    };
    w.confirm=function(_msg){
      var v= _TWHandler._triggerConfirm(_msg);
      return v;
    };
    w.prompt=function(_msg){
      var v=_TWHandler._triggerPrompt(_msg)
      return v
    };
  },
  _takeoverAjax:function(_win){
    var p=_win.XMLHttpRequest.prototype
    if(!p.BZ_Ajax||p.open==p.BZ_Ajax){
      _TWHandler._setBZSent({i:0,_root:_win.parent==_win});
      p.BZ_Ajax=p.open;
      p.open=function(a,b,c){
        var o=this;
        var _host=_Util._retrieveHostFromUrl(b)
        if(!_host){
          _host=location.protocol+"/"+"/"+location.host;
        }
        o.url=b;

        o.m=a;
        _TWHandler._curAPI={url:b,method:a,host:_host}

        this.BZ_ReceiveAjax=function(url){
          if((o.readyState==4 || o._time && Date.now()-o._time>1000) && url==o.url){
            _TWHandler._setBZSent({i:-1,_root:_win.parent==_win,url:b});
            bzTwComm._postToExt({_fun:"_setRequestCount",_args:[{_url:o.url,i:-1}],_scope:"_TWHandler"});
            _TWHandler._setResponse({data:o.response,url:o.url,m:o.m,status:o.status,host:_host});
          }else{
            if(o._send && o.readyState==0 && !o._time){
              o._time=Date.now()
            }
            var a=this;
            _win.setTimeout(function(){
              a.BZ_ReceiveAjax(url)
            },0);
          }
        };
        _win.setTimeout(function(){
          o.BZ_ReceiveAjax(b)
        },0);
        if(c!==undefined){
          return this.BZ_Ajax(a,b,c);
        }else{
          return this.BZ_Ajax(a,b);
        }
      };

      if(!p.BZ_SetHeader||p.BZ_SetHeader==p.setRequestHeader){
        p.BZ_SetHeader=p.setRequestHeader;
        
        p.setRequestHeader=function(a,b){
          this._headers=this._headers||{}
          if(this._headers[a]!==b){
            this._headers[a]=b
          }
          this.BZ_SetHeader(a,b)
        }
      }

      if(!p.BZ_AjaxSend||p.BZ_AjaxSend==p.send){
        p.BZ_AjaxSend=p.send;
        p.send=function(a,b,c){
          bzTwComm._postToExt({_fun:"_setRequestCount",_args:[{_url:this.url,i:1}],_scope:"_TWHandler"});
          _TWHandler._setBZSent({i:1,_root:_win.parent==_win,url:this.url,m:this.m});
          this._send=1;
          _TWHandler._setAjaxRequest(a,this._headers)
          return this.BZ_AjaxSend(a,b,c);
        };
      }
      
      let _bzFetch=_win.fetch
      _win.fetch=function(a,b,c){
        let _url=a.url||a
        let _host=_Util._retrieveHostFromUrl(_url)
        let m=a.method?a.method:b?b.method:"GET"
        let _body=(a&&a.body)||(b&&b.body)||b
        let _headers=(a&&a.headers)||(b&&b.headers)||b||{}
        _TWHandler._curAPI={url:_url,method:m,host:_host}
        bzTwComm._postToExt({_fun:"_setRequestCount",_args:[{_url:_url,i:1}],_scope:"_TWHandler"});
        _TWHandler._setBZSent({i:1,_root:_win.parent==_win,url:_url,m:m});

        let _featchResult=_bzFetch(a,b,c)
        _featchResult.then(x=>{
          x=x.clone()
          _TWHandler._setAjaxRequest(_body,_headers)
          setTimeout(()=>{
            _TWHandler._setBZSent({i:-1,_root:_win.parent==_win,url:_url});
            bzTwComm._postToExt({_fun:"_setRequestCount",_args:[{_url:_url,i:-1}],_scope:"_TWHandler"});
            try{
              let _contentType=x.headers.get('content-type')||""
              if(_contentType.includes("json")){
                x.json().then(xx=>{
                  let d={data:xx,url:_url,m:m,status:x.status,host:_host}
                  _TWHandler._setResponse(d);
                })
              }
            }catch(e){}
          },100)
        },_err=>{
          _TWHandler._setBZSent({i:-1,_root:_win.parent==_win,url:_url});
         // throw _err
        })
        return _featchResult
      }
      
      _TWHandler._ajaxReady=1
      if(bzTwComm._isApp()){
        console.log("set ajax to control")
        let d={_fun:"_setAjaxReady",_args:[1],_scope:"_TWHandler"}
        bzTwComm._postToExt(d);
        bzTwComm._postToIDE(d);
      }
    }
  },
  _setRequestCount:function(v){
    if(_TWHandler._isIgnoreRequest(v._url)){
      return
    }
    if(v.i==-1){
      _TWHandler._curRequestList.find((x,i)=>{
        if(x._url==v._url){
          _TWHandler._curRequestList.splice(i,1)
          return 1
        }
      })
    }else{
      _TWHandler._curRequestList.push(v)
    }
  },
  _takeoverSocket:function(_win){
    var p=_win.WebSocket.prototype
    if(!p._bzSocketSend||p._bzSocketSend==p.send){
      p._bzSocketSend=p.send
      p.send=function(_msg,bz){
        if(!bz){
          // console.log("lws-sent: ")
          // console.log(_msg)
          _TWHandler._setBZSent({i:1,_root:_win.parent==_win,m:"socket",url:this.url});
          _TWHandler._setAjaxRequest({data:_msg,url:this.url})

          if(!_win._bzSocket){
            // console.log("set message")
            _win._bzSocket=this
            _win._bzSocket.addEventListener("message",function(e){
               // console.log("lws-received: -1")
              // console.log(e.data)
              var o=_win._bzSocket
              _TWHandler._setBZSent({i:-1,_root:_win.parent==_win,m:"socket",url:this.url});
              _TWHandler._setResponse({data:e.data,url:o.url});
            })
          }
        }
        this._bzSocketSend(_msg)
      }
    }
  },
  _setAjaxReady:function(v){
    _TWHandler._ajaxReady=v
  },
  _isTakeoverReady:function(){
    return _TWHandler._ajaxReady
  },
  _enableLocalAjax:function(){
    
  },
  _setResponse:function(o){
    o.url=_Util._mergeURL(location.protocol+"/"+"/"+location.host,o.url)
    if(bzTwComm._isApp()){
      bzTwComm._postToIDE({_fun:"_attachRepData",_args:[o],_scope:"_appReqRepHandler"});
    }else if(bzTwComm._isIDE()){
      _appReqRepHandler._attachRepData(o);
    }
  },
  _setAjaxRequest:function(v,_headers){
    if(bzTwComm._isApp()){
      if(v){
        if(_TWHandler._curAPI){
          _TWHandler._curAPI.data=v
        }else{
          _TWHandler._curAPI=v
        }
      }
      
      v=_TWHandler._curAPI
      if(_headers&&v){
        v.contentType=_headers["Content-Type"]||_headers["content-type"]
        v.headers=JSON.stringify(_headers)
      }
      _TWHandler._curAPI=0

      bzTwComm._postToExt({_fun:"_postAPIData",_args:[v],_scope:"_TWHandler"});
    }
  },
  _takeoverForm:function(w){
    var fs=w.document.getElementsByTagName("form")
    for(var i=0;i<fs.length;i++){
      var f=fs[i]
      if(!f._bzForm){
        f._bzForm=1
        f._orgForm=f.onsubmit
        
        f.onsubmit=function(a,b,c){
          var r=0
          if(f._orgForm){
            r=f._orgForm(a)
          }
          if(r!==false){
            var d={}
            for(var n=0;n<this.elements.length;n++){
              var nn=this.elements[n]
              if(nn.name){
                d[nn.name]=nn.value
              }
            }
            _TWHandler._setAjaxRequest({data:d,url:this.action,method:this.method.toUpperCase()})
          }

          return r
        }
      }
    }
  },
  _postAPIData:function(v){
    // if(_TWHandler._curMode!="_api"){
      // return
    // }
    if(!BZ._autoRecording){
      _TWHandler._setToken(v)

      v.url=_Util._mergeURL(location.protocol+"/"+"/"+location.host,v.url)
      
      bzTwComm._postToIDE({_fun:"_attachReqData",_scope:"_appReqRepHandler",_args:[v]})
    }
  },
  _setToken:function(v){
    if(v.headers&&window.name!="bz-master"){
      try{
        let r={_tokenHost:_apiHandler._getHostIdx(v.url),tokenValue:""}
        if(r._tokenHost===undefined){
          return
        }
        var h=_Util._strToJson(v.headers)
        let a=_IDE._data._setting.authList.find(x=>x.hostToken==r._tokenHost)
        var ts=a.tokenKey.split(/, */)
        if(ts.find(t=>{
          if(h[t]){
            if(!r.tokenValue){
              r.tokenValue={}
            }
            r.tokenValue[t]=h[t]
          }else{
            return 1
          }
        })){
          return
        }
        
        // if(_Util._isSameObj(_aiAuthHandler._getToken(r._tokenHost),r.tokenValue)){
        //   return
        // }
        _TWHandler._token=r

        bzTwComm._postToIDE({_fun:"_setToken",_scope:"_aiAuthHandler",_args:[r]})
      }catch(e){}
    }
  },
  _isIgnoreRequest:function(v){
    var rs=_IDE._data._curVersion.setting.content.ignoreRequest
    if(rs && v){
      var ws=rs.trim().split("\n")
      for(var i=0;i<ws.length;i++){
        if(v.includes(ws[i].trim())){
          return 1
        }
      }
    }
  },
  _setBZSent:function(d,_win){
    if(!bzTwComm._isApp() && d.url&&_TWHandler._isIgnoreRequest(d.url)){
      return
    }
    if(d.i){
      _TWHandler._endTime=Date.now()
      if(!_TWHandler.BZ_sent){
        this._startRequest=Date.now()
      }
      _TWHandler._dataList=_TWHandler._dataList||{}
      var _url=d.m+":"+d.url
      if(d.i>0){
        if(!_TWHandler._dataList[_url]){
          _TWHandler._dataList[_url]=1
          _TWHandler.BZ_sent+=1;
        }
      }else{
        if(_TWHandler._dataList[_url]){
          _TWHandler.BZ_sent-=1;
          delete _TWHandler._dataList[_url]
        }
      }
      
      if(this._startRequest && Date.now()-this._startRequest>_TWHandler._resetTime && _TWHandler.BZ_sent==1){
        _TWHandler.BZ_sent=0;
        if(_TWHandler._resetTime>6000){
          _TWHandler._resetTime/=2;
        }
      }

    }else if(d._root){
      _TWHandler._lastSent=0;
      _TWHandler.BZ_sent=0;
    }
    if(!bzTwComm._isIDE()&&bzTwComm._isApp()){
      bzTwComm._postToIDE({_fun:"_setBZSent",_args:[d],_scope:"_TWHandler"});      
    }else if(bzTwComm._isIDE()&&!BZ._isPlaying()&&d._root&&!d.url){
      _extensionComm._exeFun("_setUIData","_IDE._innerWin",{_dataBind:{_showDataBind:_IDE._innerWin._data._dataBind._showDataBind}});
    }
    //_console(" ------------- "+d.i+":"+d.m+":"+d.url+":"+_TWHandler.BZ_sent);
  },
  _bzOnBeforeUnload:function(){
    _bzDomPicker._cancel();
    _TWHandler._pageReloading=1;
    BZ._documents=0;
    BZ._data._hasTW=0;
    BZ.TW.bzReloading=1;
    //if(window.bzTwComm){
      bzTwComm._postToIDE({_fun:"_infoLoadingNewPage",_args:[1],_scope:"_extensionComm"});
    //}
  },
  _bzUnload:function(){
    _TWHandler._pageReloading=1;
    BZ._documents=0;
    BZ._data._hasTW=0;
    if(!BZ._isAutoRunning()){
      setTimeout(function(){
        try{
          _IDE._innerWin._insertCtrls();
        }catch(e){}
      },1000);
    }
    BZ.TW.bzReloading=1;
    if(BZ.TW._userUnload && BZ.TW.onunload.toString()!=BZ.TW._userUnload.toString()){
      if(BZ.TW._userUnload.constructor==Function){
        return BZ.TW._userUnload();
      }else{
        return _Util._eval(BZ.TW._userUnload);
      }
    }
  },
  _setDataFromContentToPage:function(n,v){
    $("<button style='display:none;' onclick=''></button>").click().remove()
  },
  _setUnload:function(){
    if(!window.BZ){
      return;
    }

    window.onbeforeunload=0
    BZ.TW.onbeforeunload=_TWHandler._bzOnBeforeUnload;
    
    if(!BZ.TW || BZ.TW.closed || BZ.TW._userUnload){
      return;
    }else{
      if(BZ.TW.onunload && BZ.TW.onunload!=_TWHandler._bzUnload){
        BZ.TW._userUnload=BZ.TW.onunload;
      }

      BZ.TW.onunload=_TWHandler._bzUnload;
    }
  },
  _isAfterRequest:function(){
    var v=0,t=60000;
    if(bzTwComm._isIDE()){
      v= !_TWHandler.BZ_sent || _TWHandler.BZ_sent<0;
      t=6000;
    }else{
      v=((!_TWHandler.BZ_sent || _TWHandler.BZ_sent<0) && !_TWHandler._pageReloading) || (BZ.TW && !BZ.TW.XMLHttpRequest.prototype.BZ_Ajax)
    }
    if(!v){
      this._lastAfterRequest=this._lastAfterRequest||Date.now();
      if(Date.now()-this._lastAfterRequest>t){
        this._lastAfterRequest=0
        return 1
      }
    }else{
      this._lastAfterRequest=0
    }
    return v;
  },
  _takeoverOpenWin:function(_win){
    // let _key=performance.now()
    // console.log("_takeoverOpenWin:"+_key)
    _win=_win||window
    if(bzTwComm._isExtension()){
      // console.log("1:"+_key)
      bzTwComm._postToApp({_fun:"_takeoverOpenWin",_scope:"_TWHandler"})
      return
    }else if(bzTwComm._isIDE()){
      // console.log("2:"+_key)
      return;
    }
    _win=_win||window
    if(_win.BZ_PopOpen&&_win.BZ_PopOpen!=_win.open){
      // console.log("3:"+_key)
      return;
    }
    _win.BZ_PopOpen=_win.open;
    _win.open=function(_url,_name,_option,_replace){
      if(_name!="BZ-In-Testing" && !window.BZ){
        var fs=window.document.getElementsByTagName("IFRAME");
        for(var i=0;i<fs.length;i++){
          if(fs[i].name==_name){
            return _win.BZ_PopOpen(_url,_name,_option,_replace);
          }
        }
      }else if(_name=="BZ-In-Testing" || _Util._getDomsByTagAndName("IFRAME",_name).length){
        return _win.BZ_PopOpen(_url,_name,_option,_replace);
      }
      var _pop=_win.BZ_PopOpen(_url,"_"+"se"+"lf",_option,_replace);

      setTimeout(function(){
        if(_pop&&_pop.closed){
          _win.BZ_PopOpen(_url,"_"+"se"+"lf",_option,_replace);
        }
      },1000)
      return _pop
    }
  },
  _setAlert:function(_msg){
    if(bzTwComm._isApp()){
      bzTwComm._postToExt({_fun:"_setAlert",_args:[_msg],_scope:"_TWHandler"})
    }else{
      _TWHandler._popActual.alert.push(_msg+"");
    }
  },
  _setOnbeforeunload:function(_msg){
    if(_msg){
      if(bzTwComm._isApp()){
        bzTwComm._postToExt({_fun:"_setOnbeforeunload",_args:[_msg],_scope:"_TWHandler"})
      }else{
        _TWHandler._popActual.onbeforeunload.push(_msg+"");
      }
    }
  },
  _triggerConfirm:function(_msg){
    if(bzTwComm._isApp()){
      bzTwComm._postToExt({_fun:"_triggerConfirm",_args:[_msg],_scope:"_TWHandler"})
      return true
    }
    var a = _TWHandler._popActual.confirm;
    a.push(_msg+"");
    var aa=_TWHandler._popExpected.confirm;
    var rv=true;
    if(aa && aa[a.length-1]!==undefined){
      // eval("rv="+aa[a.length-1].returnValue);
      rv=aa[a.length-1].returnValue;
      aa.pop();
      a.pop();
    }
    return rv;
  },
  _triggerPrompt:function(_msg){
    if(bzTwComm._isApp()){
      bzTwComm._postToExt({_fun:"_triggerPrompt",_args:[_msg],_scope:"_TWHandler"});
      if(document.getElementById("bzPopReturnData")){
        var v= document.getElementById("bzPopReturnData").innerText;
        try{
          var vv=JSON.parse(v)
          if(vv.constructor==Array){
            v=vv.shift().returnValue
            if(vv.length){
              document.getElementById("bzPopReturnData").innerText=JSON.stringify(vv)
            }
          }
        }catch(e){}
        return v
      }
      return;
    }
    var a = _TWHandler._popActual.prompt;
    a.push(""+_msg);
    var b=_TWHandler._popExpected.prompt;
    
    var rv=false;
    
    if(b && b.length){
      rv=b[0].returnValue;
      if(b.length>1){
        b.shift()
      }
//      _TWHandler._popExpected.prompt.pop();
    }
    return rv;
  },
  _waitFollowingPop:function(_result,_fun,_time){
    if(_TWHandler._popExpected){
      // console.log("has alert setting")
      for(var k in _TWHandler._popExpected){
        var v=_TWHandler._popExpected[k];
        if(v && v.length){
          _time=_time||0;
          _time+=1000;
          if(_time>_domActionTask._getCurExpectReactionTime()){
            return _fun();
          }
          return setTimeout(function(){
            _TWHandler._waitFollowingPop(_result,_fun,_time)
          },1000);
        }
      }
    }
    _fun();
  },
  _isAfterHashLoad:function(w){
    if(w.location.pathname==_TWHandler._lastPageInfo._pathname && (w.location.hash || w.location.href.endsWith("#"))){
      if(w.location.hash==_TWHandler._lastPageInfo._hash){
        return true;
      }else if(w.location.hash && $(w.document.body).html()!=_TWHandler._lastPageInfo.html){
        return true;
      }else if(Date.now()-_TWHandler._lastPageInfo.time>2000){
        return true;
      }
    }
    return false;
  },
  _exeAfterLoad:function(_bFirst,_fun){
    // console.log("_exeAfterLoad")
    var w=BZ.TW;
    try{
      var t=Date.now();
      _TWHandler._enteredNewPage=false;
      BZ._prepareDocument(function(){
        t=(Date.now()-t)/3;
        if(t>3000){
          t=3000;
        }else if(500>t){
          t=500;
        }
        setTimeout(function(){
          _TWHandler._afterNewPageOpened(_fun);
        },t);
      });
    }catch(e){
      if(_bFirst){
        setTimeout(function(){
          _TWHandler._exeAfterLoad(false,_fun);
        },100);
      }else{
        _Util._alertMessage(e.message,e);
      }
    }  
  },
  _getPopWinSize:function(h){
    if(window.screenX>0){
      window.moveTo(-7,0);
    }
    var ws=BZ._userHabit.popSize[h],
        w=screen.width-window.outerWidth
    if(!ws){
      ws="height="+screen.availHeight+",top=0,";
      if(window.outerWidth>screen.width*0.7){
        ws+="left=0,width="+screen.width
      }else{
        ws+="left="+window.outerWidth+window.screenX+",width="+(w)
      }
    }else if(ws.match(/^[0-9 x#%]+$/)){
      ws=ws.split("x").map(x=>x.trim())
      if(!ws[1]){
        ws[1]=screen.height
      }
      if(ws[0].includes("%")){
        ws[0]=screen.width*(parseInt(ws[0])/100)
      }
      ws=`width=${ws[0]},height=${ws[1]},top=0,left=${w>ws[0]?window.outerWidth+window.screenX:screen.width-ws[0]}`
    }
    return ws;
  },
  _addTWChecker:function(_fun,_timer){
    var _errorProcess=0,_timer=_timer||0
    clearTimeout(_TWHandler._checkTW)

    return _TWHandler._checkTW=setTimeout(function(){
      if(_timer>1){
        return _startErrorProcess()
      }else if(!BZ._isPlaying()){
        return
      }
      _timer++
      if(!BZ.TW||BZ.TW.closed){
        _crash()
      }else{
        if(bzTwComm._isIDE()){
          _startErrorProcess()
          _extensionComm._retrieveDataFromTW("name",function(v){
            _clearErrProcess()
            _TWHandler._addTWChecker(_fun,_timer)
          },1)
        }else{
          try{
            BZ.TW.document
            _TWHandler._addTWChecker(_fun,_timer)
          }catch(e){
            _crash()
          }
        }
      }
    },120000)//2min
    function _startErrorProcess(){
      _errorProcess=setTimeout(function(){
        if(_TWHandler._checkTW){
          _crash()
        }
      },2000)
    }
    function _clearErrProcess(){
      clearTimeout(_errorProcess)
      _TWHandler._checkTW=0
    }
    function _crash(){
      if(_fun){
        _fun(-1)
      }
      _ideTask._crash()
    }
  },
  _clearTWChecker:function(){
    clearTimeout(_TWHandler._checkTW)
    _TWHandler._checkTW=0
  },
  //h:window size,
  //_again: try again,
  _openUrl:function(_enterPointValue,_callBack,h,_again){
    window.$project&&(window.$project.$flag="")

    let _final=0

    if(_enterPointValue){
      _enterPointValue=_domActionTask._setCurValue(_enterPointValue)
    }
    if(h===undefined&&!_ideTestManagement._getCurHost()){
      BZ._setStatus("")
      BZ._setHash("settingEnvironment")
      return alert(_bzMessage._system._error._missHost)
    }
    var ws=this._getPopWinSize(h);
    if(!_enterPointValue){
      if(window.inPlugIn){
        _extensionComm._openURL(_enterPointValue,ws);
      }else{
        BZ.TW=window.open(_enterPointValue,_TWHandler._getClientName(),ws);
      }
      return _callBack&&_callBack()
    }
    _TWHandler._addTWChecker(_finalFun);
    if(window.inPlugIn){
      if(!_extensionComm._alertExtensionRequest()){
        _extensionComm._openURL(_enterPointValue,ws,_finalFun);
      }else if(BZ._isAutoRunning()){
        // console.log("BZ-LOG: No extension issue and stop task!")
        _ideTask._end()
      }
      
      return;
    }
    
    try{
      if (BZ.TW && !BZ.TW.closed){
        BZ.TW.BZOldPage=true;
      }else{
        BZ.TW=null;
      }

      _TWHandler._lastPageInfo={
        _pathname:BZ.TW?BZ.TW.location.pathname:null,
        _hash:BZ.TW?BZ.TW.location.hash:null,
        _html:BZ._documents?BZ._documents._getBodyHtml():"",
        time:Date.now()
      };
      var _doc=BZ.TW?BZ.TW.document:null;
      if(BZ.TW && !BZ.TW.closed){
        if(_Util._loadInHash(_enterPointValue,BZ.TW.location)){
          _doc=null;
        }
      }
      this._setUnload();
      // // console.log("BZ-LOG: openUrl - "+_enterPointValue);
      BZ.TW=window.open(_enterPointValue,_TWHandler._getClientName(),ws);
      _TWHandler._curLoadingURL=_enterPointValue;
      BZ._checkPopBlocking(_enterPointValue,_callBack);
      BZ._prepareDocument(function(){
        _TWHandler._exeAfterLoad(true,_finalFun);
      },_doc);
    }catch(e){
      return e.message;
    }

    function _finalFun(a,b,c){
      if(_callBack){
        _callBack(a,b,c)
      }else{
        _Util._readyExecute(()=>{
          return _extensionComm._pageReady
        },()=>{
          setTimeout(()=>{
            _extensionComm._setCurAction(_IDE._data._curAction)
          },1000)
        })
      }

      // // console.warn("lws")
      // // console.log("BZ-LOG: after open url: "+JSON.stringify(a))
      // // console.warn("BZ-LOG: after open url"+JSON.stringify(a))
      // if(!_again&&_final){
      //   /*************************************/
      //   //Maybe should take back

      //   BZ._closePopWindow()
      //   return _TWHandler._openUrl(_enterPointValue,_callBack,h,1)

      //   //Maybe should take back
      //   /*************************************/
      // }
      // _final=1
      // _TWHandler._clearTWChecker()
      // // console.log("BZ-LOG: finalFun 1")
      // if(a!==-1&&_callBack){
      //   console.log("BZ-LOG: before checkTWReady")
      //   _TWHandler._checkTWReady(function(){
      //     return _callBack(a,b,c)

      //     console.log("BZ-LOG: before checkTWReady 1")
      //     _TWHandler._checkTWData(function(){
      //       if(_callBack){
      //         console.log("BZ-LOG: before checkTWReady 2")
      //         _callBack(a,b,c)
      //         _callBack=0
      //       }
      //     })
      //   },_enterPointValue)
      // }else{
      //   _callBack=0
      // }
    }
  },
  _getClientName:function(){
    return "bz-client"
    // let n="bz-client"
    // if(BZ._isPlaying()){
    //   n+="-playing"
    // }
    // return n
  },
  _checkTWReady:function(_fun,_enterPointValue){
    // if(!BZ._isPlaying()){
      // return
    // }
    setTimeout(()=>{
      let _time=_time2=0
      let t=BZ._getCurHost
      let _loadPageTime=_IDE._data._setting.advanced[_ideTestManagement._getCurServerId()].loadPageTime||60000
  
      if(bzTwComm._isIDE()){
        let i=0;
        _TWHandler._reloadPageOnCheckTWReady=0
        let _timer=setInterval(function(){
          if(!BZ._isPlaying()&&!_fun){
            console.log("BZ-LOG: STOP check APP Ready")
            return clearInterval(_timer)
          }
          console.log("BZ-LOG: check app ready")
          _extensionComm._retrieveDataFromTW("window._TWHandler&&window._TWHandler._responseReady()",function(v){
            console.log("BZ-LOG: retry for wait location.href:"+v)
            _time++
            if(v){
              console.log("BZ-LOG: Get APP Ready")
              clearInterval(_timer)
              _TWHandler._reloadPageOnCheckTWReady=0
              _fun()
            }else if(_time>30){
              _fun()
            }
          },1)
          
          _time2+=50
          //if no response from app in 20s, stop checking
          if(_time2>_loadPageTime){
            console.log("BZ-LOG: STOP on try too many")
            clearInterval(_timer)
            if(!_TWHandler._reloadPageOnCheckTWReady){
              _TWHandler._reloadPageOnCheckTWReady=1
              BZ._closePopWindow()
              console.log("BZ-LOG: TWHandler 2")
              return _TWHandler._openUrl(_enterPointValue,_fun)
            }
          }
        },50)      
      }else{
        _fun()
      }
    },0)
  },
  _responseReady:function(){
    return location.href
  },
  _afterNewPageOpened:function(_fun){
    // console.log("_afterNewPageOpened")
    if(!_TWHandler._enteredNewPage){
      _TWHandler._enteredNewPage=true;
    }else{
      return;
    }
    _TWHandler._takeoverWin();
    if(_fun){
      _fun();
    }else{
      _IDE._innerWin._insertCtrls();
    }
  },
  _isSameDomain:function(_url){
    if(_url && _url.indexOf("http")!=0 && _url.includes(":/"+"/")){
      return false;
    }
    return !_url || _url.startsWith("javascript:") || (_url.indexOf("http")!=0 && _url.indexOf("/"+"/")!=0) || _url.indexOf(location.origin)==0;
  },
  _checkJQueryEvent:function(e){
    try{
      return $["_"+"data"](e,"events") || {};
    }catch(e){}
    return {};
  }
};var _ideDataHandler={
  _urlDataMap:{},
/*
data structure
  [
    {
      name:"xxx",
      type:"o/p/m/c/f/j/r/a/x",
      value:{...}
    }
  ]
*/
  //np:name path
  //Like: $module.name --> $module.v.d0
  _getDataPathFromNamePath:function(np,_curUnStoredData){
    if(np.includes("$parameter")){
      return
    }else{
      try{
        let v,nn
        if(np.startsWith("$project")){
          v=$data()
          nn=np.replace("$project","")
        }else if(np.startsWith("$module")&&_IDE._data._curModule){
          v=$data(_IDE._data._curModule._data.code)
          nn=np.replace("$module","")
        }else if(np.startsWith("$test")&&_IDE._data._curTest){
          v=$data(_IDE._data._curModule._data.code,_IDE._data._curTest._data.code)
          nn=np.replace("$test","")
        }
        if(v){
          eval("v=v"+nn)
          if(v!==undefined){
            return np
          }
        }
      }catch(e){
        
      }
    }
  },
  _getDataTypeByPath:function(np){
    var _end=""
    if(np.endsWith("()")){
      np=np.substring(0,np.length-2)
      _end="()"
    }
    np=_ideDataHandler._getDataPathFromNamePath(np);
    if(np){
      np=np.split(".")
      var d=0
      if(np[0]=="$project"||np[0]=="$data()"){
        d=_ideDataManagement._curMap[""];
      }else if(np[0]=="$module"){
        d=_ideDataManagement._curMap[BZ._getCurModule()._data.code];
      }else if(np[0]=="$test"){
        d=_ideDataManagement._curMap[BZ._getCurModule()._data.code+BZ._getCurTest()._data.code];
      }else if(np[0].includes("$data")){
        let ks=np[0].match(/m[0-9]+|t[0-9]+/g)
        if(ks){
          d=_ideDataManagement._curMap[ks[0]+(ks[1]||"")];
        }
      }
      if(d){
        d=d.find(v=>{return v.name==np[1]})
        if(d){
          return d.type
        }
      }
    }
  },
  //nnp:name path
  //like: $module.name -- current module data
  _getOrgDataSettingFromNamePath:function(nnp,_curUnStoredData){
    var np=nnp,dd={}
    try{
      var _end=""
      if(np.endsWith("()")){
        np=np.substring(0,np.length-2)
        _end="()"
      }
      if(np){
        np=np.split(".")
        var d=0

        if(np[0]=="$project"){
          d=_ideDataManagement._getDataMap()
        }else if(np[0]=="$module"){
          d=_curUnStoredData?BZ._getCurModule()._data.dataMap:_ideDataManagement._getCurModuleDataMap()
        }else if(np[0]=="$test"){
          d=_curUnStoredData?BZ._getCurTest()._data.dataMap:_ideDataManagement._getCurTestDataMap()
        }
        if(d){
          d=d.find(v=>{
            return v.name==np[1]
          })
          if(d){
            if(d.type=="o"){
              d.value.forEach(v=>{
                dd[v.key]=v.value
              })
            }else if("cm".includes(d.type)){
              dd=_Util._csvToObj(d.value)
            }else{
              dd=d.value
            }
            if(np[2]){
              return dd[np[2]]
            }
            return dd
          }
        }
      }
    }catch(e){
      if(_curUnStoredData){
        return _ideDataHandler._getOrgDataSettingFromNamePath(np)
      }
    }
  },
  //t: test case object
  _getLoopData:function(t){
    let v=t._data.loopData&&t._data.loopData.loopValue,d
    if(v){
      if(v.startsWith("$test.")){
        d=$data(t._parent._data.code,t._data.code)
      }else if(v.startsWith("$test.")){
        d=$data(t._parent._data.code)
      }else if(v.startsWith("$project.")){
        d=$data()
      }
      if(d){
        v=v.split(".")
        d=d[v[1]]
        
        if(d&&d.constructor!=Array&&v[2]){
          d=d[v[2]]
        }
        return d
      }
    }
  },
  //Like: $module.v.d0.d1 --> $module.user.name
  _getNamePathFromDataPath:function(dp){
    return dp
  },
  _getValueFromNamePath:function(np){
    return eval(this._getDataPath(np));
  },
  _reloadData:function(_url,_type){
    _ideDataHandler._urlDataMap[_url]=0;
    _ideDataHandler._loadData(_url,_type);
  },
  _getReqData:function(_url){
    if(_url&&_url.startsWith(location.protocol)){
      _url=location.protocol+_url;
    }
    var v=this._urlDataMap[_url];
    if(v=="_loading"){
      return
    }
    return v;
  },
  _isLoadDataCompleted:function(){
    var vs=[$test,$module,$project];
    for(var i=0;i<vs.length;i++){
      var v=vs[i];
      for(var k in v){
        if(v[k]==_ideDataHandler._loadingFlag){
          return;
        }
      }
    }
    return 1;
  },
  _loadingFlag:function(){},
  _loadData:function(_url,_type,_fun,xo,xk,_tryTime,_fromModule,_fromTest){
    _tryTime=_tryTime||0
    if(_url){
      var o = _ideDataHandler._urlDataMap[_url];
      if(!o){
        _ideDataHandler._urlDataMap[_url]="_loading";
        var _realUrl=_url.replace("/"+"/www.dropbox.com/","/"+"/dl.dropbox.com/")
        if(!_realUrl.match(/^http/)){
          _realUrl="http:"+_realUrl
        }
        try{
          _extensionComm._callBackground(function(r){
            if(_type=="file"){
              _ideDataHandler._urlDataMap[_url]=r;
              _doIt(r)
            }else{
              _doIt(_parseData(r.data,_type,_url));
            }
          },"ajax",{url:_realUrl,method:"GET",responseType:_type=="file"?'arraybuffer':""})
          return
          /*
          if(_type=="file"){

            var xhr = new XMLHttpRequest();
            xhr.open('GET', _realUrl, true);
            xhr.responseType = 'arraybuffer';
            
            var _result;

            xhr.onload = function(e) {
              if (_Util._isAPISucessStatus(this.status)) {
                try{
                  
                  
                }catch(exx){
                  _handlerErr(exx.message)
                }
              }else{
                v=_Util._formatMessage(_bzMessage._system._error._requestFailed+_getErrDataFrom(),[_realUrl])
                _handlerErr(v)
              }
            };
            xhr.onerror=function(v,a,b){
              v=v.responseText||"";
              v=_Util._formatMessage(_bzMessage._dataBind._loadDataFailed+_getErrDataFrom(),[_url,v])
              _handlerErr(v)
            }
            try{
              return xhr.send();
            }catch(ex2){
              _handlerErr(ex2.message)
            }
          }else{
            $.ajax({
              url:_realUrl,
              type:"GET",
              cache:false,
              complete:function(v,r,rs){
                _doIt(_parseData(v.responseText,_type,_url));
              },
              error:function(v,a,b){
                if(a=="parsererror"){
                  _doIt(_parseData(v.responseText,_type,_url));
                }else{
                  var v=_Util._formatMessage(_bzMessage._dataBind._loadDataFailed+_getErrDataFrom(),[_url,v.responseText])
                  _handlerErr(v)
                }
              }
            });
            return
          }
          */
        }catch(ex){
          return alert(ex.message)
        }
      }else if(o=="_loading"){
        return setTimeout(function(){
          _ideDataHandler._loadData(_url,_type,function(v){
            _doIt(v)
          });
        },100)
      }
      _doIt(o);
    }
    function _doIt(v){
      if(_fun){
        _fun(v,xo,xk,_type,_url);
      }
    }
    function _formatValue(v){
      return (v+"").replace(/[- ]/g,"_")
    }
    function _parseData(v,_type,_url){
      try{
        if(_type=="csv"){
          v=_ideDataHandler._parseCSV(v) 
          var s="",vs=[];
          v[0].forEach((vv,i)=>{
            vv=_formatValue(vv)
            v[0][i]=vv
          })
          if(v[0][0]=="_"+"key"){
            vs={}
            _type="m"
          }
          for(var i=1;i<v.length;i++){
            var vv=v[i];
            let o={},kk;
            v[0].forEach((k,n)=>{
              if(_type=="m"){
                if(!n){
                  kk=_formatValue(v[i][0])
                  return
                }
              }
              o[k]=v[i][n]
            })
            if(_type=="m"){
              vs[kk]=o
            }else{
              vs.push(o)
            }
          }
          v=vs
        }else{
          eval("v="+v);
        }
        _ideDataHandler._urlDataMap[_url]=v;
        return v;
      }catch(e){
        alert(_Util._formatMessage(_bzMessage._dataBind._loadDataFailed+_getErrDataFrom(),[_url,v]));
      }
    }
    function _handlerErr(_msg){
      if(_tryTime<1){
        setTimeout(function(){
          _ideDataHandler._urlDataMap[_url]=0;
          _ideDataHandler._loadData(_url,_type,_fun,xo,xk,++_tryTime,_fromModule,_fromTest)
        },1000)
      }else{
        _ideDataHandler._urlDataMap[_url]=_msg
        alert(_msg)
        _doIt(_msg)
      }
    }
    function _getErrDataFrom(){
      var n=""
      if(_fromModule!==undefined && !_fromModule){
        n=_bzMessage._root._defaultData._title
      }else if(_fromModule){
        if(_fromModule.constructor==String){
          _fromModule=_ideObjHandler._getDataByPath(_fromModule)
        }
        if(_fromModule){
          n=_fromModule._data.name
          if(_fromTest){
            _fromTest=_ideObjHandler._getDataByPath(_fromModule._data.code,_fromTest)
            if(_fromTest){
              n+=" - "+_fromTest._data.name
            }
          }
        }
      }
      if(n){
        n="\n\n"+_Util._formatMessage(_bzMessage._dataBind._errorFrom,[n])
      }
      return n
    }
  },
  _getLoadingFiles:function(){
    var vs=[]
    for(var k in  _ideDataHandler._urlDataMap){
      if(_ideDataHandler._urlDataMap[k]=="_loading"){
        vs.push(k)
      }
    }
    return vs;
  },
  _parseCSV:function(_strData, _strDelimiter){
    _strData=(_strData||"").trim()
    if(!_strData){
      return ""
    }
    // Check to see if the delimiter is defined. If not,
    // then default to comma.
    _strDelimiter = (_strDelimiter || ",");

    // Create a regular expression to parse the CSV values.
    var _objPattern = new RegExp(
      (
          // Delimiters.
          "(\\" + _strDelimiter + "|\\r?\\n|\\r|^)" +

          // Quoted fields.
          "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +

          // Standard fields.
          "([^\"\\" + _strDelimiter + "\\r\\n]*))"
      ),
      "gi"
    );


    // Create an array to hold our data. Give the array
    // a default empty first row.
    var _arrData = [[]];

    // Create an array to hold our individual pattern
    // matching groups.
    var _arrMatches = null;


    // Keep looping over the regular expression matches
    // until we can no longer find a match.
    while (_arrMatches = _objPattern.exec( _strData )){

        // Get the delimiter that was found.
        var _strMatchedDelimiter = _arrMatches[ 1 ];

        // Check to see if the given delimiter has a length
        // (is not the start of string) and if it matches
        // field delimiter. If id does not, then we know
        // that this delimiter is a row delimiter.
        if (_strMatchedDelimiter.length && _strMatchedDelimiter !== _strDelimiter){

            // Since we have reached a new row of data,
            // add an empty row to our data array.
            _arrData.push( [] );

        }

        var _strMatchedValue;

        // Now that we have our delimiter out of the way,
        // let's check to see which kind of value we
        // captured (quoted or unquoted).
        if (_arrMatches[ 2 ]){

            // We found a quoted value. When we capture
            // this value, unescape any double quotes.
            _strMatchedValue = _arrMatches[ 2 ].replace(
                new RegExp( "\"\"", "g" ),
                "\""
                );

        } else {

            // We found a non-quoted value.
            _strMatchedValue = _arrMatches[ 3 ];

        }


        // Now that we have our value string, let's add
        // it to the data array.
        _arrData[ _arrData.length - 1 ].push( _strMatchedValue );
    }

    // Return the parsed data.
    return( _arrData );
    
  },
  _setFun:function(cc,_name){
    var c=cc.trim()
    if(!c.startsWith("function")){
      if(c.includes("return ")){
        c="function(){"+c+"}";
      }
    }else if(c.match(/^(function)( +)([a-z])/i)){
      return alert(_bzMessage._dataBind._funNameErr)
    }
    try{
      c=_Util._eval("c="+c)
      return c;
    }catch(e){
      if(_name&&cc){
        return alert(_bzMessage._dataBind._funErr+'"'+e.message+'"\n\n'+_name+" = "+cc);
      }
    }
    
  },
  _getDataPositionPath:function(m,t,n){
    if(m){
      var mm=_ideObjHandler._getDataByPath(m)._data.name
      if(t){
        return mm+" / "+_ideObjHandler._getDataByPath(m,t)._data.name+" / "+n
      }
      return mm+" / "+n
    }
    return "$project / "+n
  },
  //Like: from $module:{v,k,t} --> $module.abc.xyz
  _generateNameData:function(d,_tmpData,_fromModule,_fromTest){
    if(d&&d.constructor!=Array){
      return _localStorageManagement._reloadData()
    }
    var nd={};
    d.forEach(v=>{
      _ideDataHandler._takeData(v,nd,_tmpData,_fromModule,_fromTest)
    })
    return nd;
  },
  _takeData:function(v,nd,_tmpData,_fromModule,_fromTest){
    if(!v){
      return
    }
    let n=v.name
    if("pajf".includes(v.type)){
      if(v.type=="j"){
        nd[n]=_ideDataHandler._setFun(v.value,n)
      }else{
        nd[n]=v.value
      }
    }else if("x"==v.type){
      try{
        nd[n]=_Util._strToJson(v.value)
      }catch(ex){
        nd[n]=v.value
      }
    }else if("o"==v.type){
      nd[n]={};
      v.value.forEach(vv=>{
        if(vv.key){
          nd[n][vv.key]=vv.value
        }
      })
    }else if("r"==v.type){
      if(_tmpData && _tmpData[n]){
        nd[n]=_tmpData[n]
      }else{
        if(!v.value.url){
          return
        }
        var u=_ideDataHandler._getReqData(v.value.url);
        if(u){
          if(!bzTwComm._isIDE()||v.value.type!="file"){
            nd[n]=u;
          }else{
            nd[n]=v.value.url
          }
        }else{
          nd[n]=_ideDataHandler._loadingFlag;
          //Directly load file not in extension side
          if((bzTwComm._isIDE())){
            let x=v.value
            _ideDataHandler._loadData(x.url,x.type,function(v,o,k,t,_url){
              //don't set on extension way
              if(!bzTwComm._isIDE()||t!="file"){
                o[k]=v;
                _extensionComm._setShareData({"_ideDataManagement._tmpTaskDataMap":_ideDataManagement._tmpTaskDataMap})
              }else{
                o[k]=_url
              }
            },nd,n,0,_fromModule,_fromTest);
          }
        }
      }
    }else if("cm".includes(v.type)){
      nd[n]=_Util._csvToObj(v.value)
    }
  },
  //d: data, t: type (o:object, p:properity, c:csv, m:matrix, f:file,r:request, j:JS), v:value
  //Like create matrix data as:
  //_ideDataHandler._newItem(_IDE._data._curModule._data.dataMap,"lws","m",{admin:{user:"lws",pwd:"123"}})
  //for dataHandler
  _newItem:function(d,_name,t,v){
    if(!d){
      return
    }
    if(v===undefined){
      v=_Util._clone(_DataBuilder._defDataMap[t])
    }else if(t=="o"){
      let vs=[]
      for(var k in v){
        vs.push({key:k,value:v[k]})
      }
      v=vs
    }else if("mc".includes(t)&&v.constructor!=String){
      v=_csvEditor._objToCSV(v)
    }
    d.push({
      name:_name,
      type:t,
      value:v
    })
    return d.length-1
  },
  _newSubItem:function(dm,k,dv){
    dm.find(v=>{
      if(v.name==k){
        v.value.push(dv)
        return 1
      }
    })
  },
  _removeItem:function(d,k){
    d.splice(d.findIndex(v=>{return v.name==k}),1)
    let t=_IDE._data._curTest
    if(t){
      t=t._data
      if(d==t.dataMap&&t.loopData.loopValue=="$test."+k){
        t.loopData={
          loopStart:0
        }
      }
    }
  },
  _removeItemByName:function(d,_name){
    d.find((v,i)=>{
      if(v.name==_name){
        d.splice(i,1)
        return 1
      }
    })
  },
  _removeSubItem:function(d,k,kk){
    var v=d.v[k];
    k=d.k[k];
    delete k.k[kk];
    delete v[kk]
    k=Date.now()
    d.k[k]={}
    d.v[k]={}
    delete d.k[k]
    delete d.v[k]
  },
  /*Change only Object data to name data
    Like: 
    {d1:"n1",d2:"v1"}
     --> 
    {name:"n1",value:"v1"}
  */
  _getObjDisplay:function(d,k,_overWrite){
    var n,vs=d.v[k],ks=d.k[k].k,nd={};
    var ws=""
    for(k in vs){
      n=ks[k].n
      nd[n]=vs[k]
      if(_ideDataHandler._isPasswordKey(n)&&!_Util._isRegexData(vs[k])){
        nd[n]=vs[k].replace(/./g,"*")
      }
      var w=n+" = "+nd[n]+"\n"
      if(_overWrite &&_overWrite[n]){
        w="<i class='bz-over-write'>"+w+"</i>"
      }else if(_overWrite){
        w="<span>"+w+"</span>"
      }
      ws+=w
    }
    return "<div>"+ws+"</div>"
  },
  _parseToSouData:function(d){
    //d=_JSHandler._cleanCode(d).split("\n");
    d=d.split("\n");
    
    d.forEach(function(v,n){
      if(!v.match(/\$project|\$loop|\$module|\$test/)){
        return;
      }
      var vvs=_ideDataHandler._splitByString(v);
      vvs.forEach(function(w,i){
        if(w.c){
          var c=w.c;
          
          if(c.match(/\$module|\$test|\$project|\$loop/)){
            var s="",ss="";
            for(var j=0;j<c.length;j++){
              var v=c[j];
              if(v=="$" && !s){
                s=v;
              }else if(s){
                if(_ideDataHandler._endVarCode(v)){
                  
                  if(s.match(/^\$module|^\$test|^\$project|\$loop|\$parameter/)){
                    ss+=s
                  }
                  ss+=v;
                  s=0;
                }else if(!v.match(/[a-z]/)){
                  if(s.match(/^\$module|^\$test|^\$project|^\$loop/)){
                    s+=v;
                  }else{
                    ss+=s+v;
                    s=0;
                  }
                }else{
                  s+=v;
                }
              }else{
                ss+=v;
              }
            }
            if(s){
              ss+=s;
            }
            c=ss;
          }
          
          w.c=c;
        }
      });
      var w="";
      for(var i=0;i<vvs.length;i++){
        w+=vvs[i].t||vvs[i].c
      }
      d[n]=w;
    })
    var w=""
    for(var i=0;i<d.length;i++){
      w+=d[i];
      if(i<d.length-1){
        w+="\n"
      }
    }
    return w;
  },
  _endVarCode:function(c){
    return "`~!@#%^&*)+-={}:;<>?,/\\| \t".includes(c)
  },
  _splitByString:function(v){
    var w="",c="",t="",cs=[],p,b;
    for(var i=0;i<v.length;i++){
      c=v[i]
      if("'\"".includes(c) && !b){
        if(!p){
          p=c
          if(w){
            cs.push({c:w})
            w=""
          }
        }else if(p==c){
          t+=c;
          p=0
          cs.push({t:t})
          t="";
          continue;
        }
      }else if(c=="\\"){
        b=!b;
      }
      if(p){
        t+=c;
      }else{
        w+=c;
      }
      if(c!="\\"){
        b=0;
      }
    }
    if(w){
      cs.push({c:w})
    }else if(t){
      throw new Error("Syntax error: "+v)
    }
    return cs;
  },
  _funToString:function(){
    if(!_IDE._data._curTest){
      return
    }
    var vs=[$project,$module,$test,$loop,window.$parameter]
    vs.forEach(function(v,i){
      if(v && v.constructor==Object){
        for(var k in v){
          if(v[k] && v[k].constructor==Function){
            v[k]="\t"+v[k].toString()
          }
        }
      }
    })
  },
  _isPasswordKey:function(n){
    var vs=[_bzMessage._login._password.toLowerCase(),"password","pwd"];
    n=n.toLowerCase();
    for(var i=0;i<vs.length;i++){
      if(n==vs[i] || n.includes(vs[i])){
        return 1
      }
    }
  }
};var _ideDataManagement={
  _curMap:{},
  _tmpTaskDataMap:{_parameter:{},_loop:{},_app:{},_fun:{},_upgradeDiffs:{_full:[],_text:[]}},
  _cleanActionTmpData:function(m,t){
    var c=m.code+t.code
    delete _ideDataManagement._tmpTaskDataMap._loop[c]
    delete _ideDataManagement._tmpTaskDataMap._app[""]
    delete _ideDataManagement._tmpTaskDataMap._app[c]
    delete _ideDataManagement._tmpTaskDataMap._parameter[c]
  },
  _updateDataValueOnSwitchLanguage:function(_language){
    let d=_ideDataManagement._tmpTaskDataMap._app,
        c=_ideDataManagement._curMap,
        cl=_ideDataManagement._language||""
        _ideDataManagement._language=_language
    let _wordMap=_buildMap(cl)
    
    let _languageIdx=_IDE._data._setting.appLanguages.indexOf(_language||cl)-1
    
    for(var k in c){
      c[k].find(v=>{
        let m,t;
        if(k){
          m=k.split("t")
          
          t="t"+m[1]
          m=m[0]
        }
        if(!d[k]&&k){
          $data(m,t)
        }
        if(!_language){
          if(!v.languageMap||!v.languageMap[cl]){
          }else if(v.languageMap[cl]=="\r"){
            d[k]=_translate(d[k])
          }else{
            _ideDataHandler._takeData(v,d[k],"",m,t)
          }
        }else{
          if(!v.languageMap||!v.languageMap[_language]){
            if(cl){
              _ideDataHandler._takeData(v,d[k],"",m,t)
            }
          }else if(v.languageMap[_language]=="\r"){
            d[k]=_translate(d[k])
          }else{
            let vv={
              name:v.name,
              type:v.type,
              value:v.languageMap[_language]
            }
            _ideDataHandler._takeData(vv,d[k],"",m,t)
          }
        }
      })
    }
    
    function _translate(d){
      if(d){
        if(d.constructor==String){
          let v=_wordMap[d]
          if(v){
            return v[_languageIdx]
          }else{
            let dd=d.match(_Util._matchAllLetterAndNumber)
            if(dd){
              let w=""
              dd.forEach(x=>{
                let j=d.indexOf(x)
                let xx=_wordMap[x]
                if(!xx){
                  xx=x
                }else{
                  xx=xx[_languageIdx]
                }
                w+=d.substring(0,j)+xx
                d=d.substring(j+x.length)
              })
              return w
            }
          }
        }else if([Object,Array].includes(d.constructor)){
          for(let k in d){
            d[k]=_translate(d[k])
          }
        }
      }
      return d
    }
    
    function _buildMap(_from){
      if(_from){
        _appWordHandler._languageWordMap=_appWordHandler._languageWordMap||{}
        if(!_appWordHandler._languageWordMap[_from]){
          let i=_IDE._data._setting.appLanguages.indexOf(_from)-1,
          d={}
          _appWordHandler._languageWordMap[_from]=d
          for(let k in _appWordHandler._wordMap){
            d[_appWordHandler._wordMap[k][i]]=_Util._clone(_appWordHandler._wordMap[k])
            d[_appWordHandler._wordMap[k][i]].splice(i,1,k)
          }
        }
        return _appWordHandler._languageWordMap[_from]
      }
      return _appWordHandler._wordMap
    }
  },
  _loadData:function(ms,_fun){
    _ideDataManagement._updateData(ms,0,function(){
      var i,j,m,t;
      for(i=0;i<ms.length;i++){
        m=ms[i];
        _parse(m);
        _ideDataManagement._curMap[m.code]=m.dataMap;
        for(j=0;j<m.tests.length;j++){
          t=m.tests[j]
          _parse(t);
          _ideDataManagement._curMap[m.code+t.code]=t.dataMap
        }
      }

      _ideDataManagement._curMap[""]=_IDE._data._curVersion.setting.defaultData
      _ideDataManagement._curMap._personalData=curUser._curProject.setting.personalData
      
      _IDE._data._versionDataReady=1

      if(_fun){
        _fun()
      }
    })
    
    function _parse(dd){
      if(!dd.dataMap){
        dd.dataMap=[]
      }else if(dd.dataMap.constructor==String){
        dd.dataMap=JSON.parse(dd.dataMap)
      }
    }
  },
  _getCurDataPathList:function(_scope){
    let vs=[];
    _scope=_scope||["$project","$module","$test"]
    if(_IDE._data._curTest&&_scope.includes("$test")){
      _ideDataManagement._curMap[_IDE._data._curModule._data.code+_IDE._data._curTest._data.code].forEach(v=>{
        vs.push("$test."+v.name)
      })
    }
    if(_IDE._data._curModule&&_scope.includes("$module")){
      _ideDataManagement._curMap[_IDE._data._curModule._data.code].forEach(v=>{
        vs.push("$module."+v.name)
      })
    }
    if(_scope.includes("$project")){
      _ideDataManagement._curMap[""].forEach(v=>{
        vs.push("$project."+v.name)
      })
    }
    return vs
  },
  _getPersonalData:function(s){
    let vs=_ideDataManagement._curMap._personalData||[],
        nd={};
    vs.forEach(v=>{
      if(v.scope==(s||undefined)){
        _ideDataHandler._takeData(v,nd)
      }
    })
    return nd
  },
  _getDataMap:function(m,t){
    if(m){
      m=m.code||m._data||m
      m=m.code||m
      if(t){
        t=t.code||t._data||t
        t=t.code||t
        return _ideDataManagement._curMap[m+t]
      }
      return _ideDataManagement._curMap[m]
    }
    return _ideDataManagement._curMap[""]
  },
  _getCurTestDataMap:function(){
    return _ideDataManagement._getDataMap(BZ._getCurModule(),BZ._getCurTest())
  },
  _getCurModuleDataMap:function(){
    return _ideDataManagement._getDataMap(BZ._getCurModule())
  },
  _getCurFileData:function(){
    let ds={
          $test:_ideDataManagement._getCurTestDataMap(),
          $module:_ideDataManagement._getCurModuleDataMap(),
          $project:_ideDataManagement._getDataMap("")
        },
        fs=[];
    _Util._loopObj(ds,(v,k)=>{
      v.forEach(y=>{
        if(y.type=="f"||(y.type=="r"&&y.value.type=="file")){
          fs.push(k+"."+y.name)
        }
      })
    })
    return fs
  },
  //For task only
  _assignCurData:function(m,t){
    m=m||BZ._getCurModule()._data.code;
    t=t||BZ._getCurTest()._data.code;
    var tt=_ideDataManagement._tmpTaskDataMap,td,md;
    window.$project=$data();
    if(t=="_try"){
      td=_IDE._data._curTest=_ideTask._data._curTest=_ideTask._data._curTest||{_data:_ideTask._setting._parameter}
      md=_ideTask._data._curModule=_IDE._data._curModule
      window.$parameter={}
      window.$loop={}
      window.$test={}

      //merge data
      let d=_ideTask._tmpSysData
      if(d){
        for(var k in d){
          var mm=$project[k]=$project[k]||{}
          for(var kk in d[k]){
            mm[kk]=d[k][kk]
          }
        }
      }
    }else{
      td=_ideTask._data._curTest=_ideObjHandler._getDataByPath(m,t)
      _setCurModule(m)
      md=_ideTask._data._curModule
      if(!td){
        return
      }
      window.$test=$data(m,t)
      window.$loop=tt._loop[m+t]||window.$loop||{};
      window.$parameter=tt._parameter[m+t]=tt._parameter[m+t]||(td&&_ideDataManagement._parseParameter(td._data.defParameter))||{};
    }


    tt._curTest={_data:_Util._cloneSelectData(td._data,0,"code|name|actions|type|speed")};
    md=md._data
    tt._curModule={
      _data:{
        code:m,
        name:md.name,
        parentModule:md.parentModule,
        bt:md.bt,
        defaultHostId:md.defaultHostId,
      }
    }
    if(md.bt=="data"){
      tt._curModule._data.definition=md.definition
    }

    window.$module=$data(m);
    _extensionComm._setShareData({"_ideDataManagement._tmpTaskDataMap":tt})

    function _setCurModule(m){
      if(_ideTask._changeUIOnPlaying()){
        _IDE._data._curModule=_ideTask._data._curModule=_ideObjHandler._getDataByPath(m);
      }
    }
  },
  _assignCurDataForRecording:function(t,a){
    var tt=_ideDataManagement._tmpTaskDataMap;
    if(BZ._isRecording()){
      tt._curTest={_data:_Util._cloneSelectData(t._data,0,"code|name|actions|type|speed")};
      tt._curAction=a
    }
    _extensionComm._setShareData({"_ideDataManagement._tmpTaskDataMap":tt})
  },
  _setParameter:function(m,t,v){
    _ideDataManagement._tmpTaskDataMap._parameter[m+t]=v;
  },
  //on recording or checking test case, 
  _initTmpData:function(_force){
    window.$project=window.$module=window.$test={}; 
    var m=BZ._getCurModule(),
        t=BZ._getCurTest()

    _extensionComm._setShareData({"_ideDataManagement._curMap":_ideDataManagement._curMap})
    if(m){
      m=m._data;
    }
    if(t){
      t=t._data;
    }
    if(m&&t){
      _ideDataManagement._tmpTaskDataMap=_ideDataManagement._getInitData(m,t);
    }else{
      if(m){
        _ideDataManagement._tmpTaskDataMap._curModule={_data:{code:m.code,name:m.name,parentModule:m.parentModule}}
      }
      if(t){
        _ideDataManagement._tmpTaskDataMap._curTest={_data:_Util._cloneSelectData(t,0,"code|name|actions|hostId|type|speed")}
      }
    }
    
    _ideDataManagement._tmpTaskDataMap._curAction=_IDE._data._curAction;
    delete window.$loop;
    
    _ideDataManagement._retrieveTmpCurData(_force)
    if(t&&((t.doc&&t.doc._id)||_force)){
      t={
        code:t.code,
        loopData:_Util._clone(t.loopData),
        defParameter:_Util._clone(t.defParameter)
      }

      _ideDataManagement._prepareCurLoopData(t)
      _ideDataManagement._tmpTaskDataMap._parameter[m.code+t.code]=_ideDataManagement._parseParameter(t.defParameter)||{}
    }
    
    if(!BZ._isAutoRunning()){
      _aiAuthHandler._data.forEach(x=>{
        if(x.module){
          x=_ideObjHandler._getDataByPath(x.module)
          if(x){
            _ideTask._setTmpUser(x)
          }
        }
      })
    }
    _extensionComm._setShareData({"_ideDataManagement._tmpTaskDataMap":_ideDataManagement._tmpTaskDataMap})
  },
  _getInitData:function(m,t){
    let d={
      _env:_IDE._data._curVersion.setting.environments[curUser._curProject.setting.curEnvironment],
      _parameter:{},
      _app:{},
      _loop:{},
      _curTest:t?{_data:_Util._cloneSelectData(t,0,"code|name|actions|hostId|type|speed")}:t,
      _curModule:{_data:{code:m.code,name:m.name,parentModule:m.parentModule,bt:m.bt}},
      _upgradeDiffs:window.$upgradeDiffs||{_full:[],_text:[]}
    }
    if(m.bt=="data"){
      d._curModule._data.definition={
        fields:m.definition.fields
      }
    }
    return d
  },
  _initRandomValue:function(d){
    if(d && d.constructor==String){
      return _getRegexFromString(d)
    }
    for(var k in d){
      var v=d[k]
      if(v){
        if([Object,Array].includes(v.constructor)){
          _ideDataManagement._initRandomValue(v)
        }else if([String,RegExp].includes(v.constructor)){
          d[k]=_getRegexFromString(v.toString(),k)
        }
      }
    }
    return d
    function _getRegexFromString(s,k){
      if(_Util._isRegexData(s)){
        return $util.generateWordsByRegex(s,k)
      }
      return s
    }
  },
  _refreshParameter:function(v){
    if(_IDE._data._curTest){
      _IDE._data._curTest._data.defParameter=v
      $parameter=_ideDataManagement._parseParameter(v)
      var d=_ideDataManagement._tmpTaskDataMap
      if(d&&d._parameter){
        d._parameter[_IDE._data._curModule._data.code+_IDE._data._curTest._data.code]=$parameter
      }
      _extensionComm._setShareData({"$parameter":$parameter})
    }
  },
  /*
  _isBaseOnParameter:function(t){
    if(t){
      for(var i=0;i<t.length;i++){
        var e=t[i].element,ev=t[i].event;
        if(e&&JSON.stringify(e).includes("$parameter")){
          return 1
        }else if(ev&&JSON.stringify(ev).includes("$parameter")){
          return 1
        }
      }
    }
  },
  */
  _parseParameter:function(v){
    v=v||""
    if(v&&v.constructor==String&&("{['\"".includes(v.trim()[0]) || _Util._hasCode(v))){
      try{
        v=_Util._eval("v="+v)
      }catch(e){}
    }
    return v
  },
  _retrieveTmpCurData:function(_force){
    var m,t,k;
    window.$TW=BZ.TW;
    $project=$data(0,0,_force)
    
    if(bzTwComm._isExtension()){
      m=_ideDataManagement._tmpTaskDataMap._curModule;
      t=_ideDataManagement._tmpTaskDataMap._curTest;
      _IDE._data._curTest=_CtrlDriver._buildProxy(t);
      _IDE._data._curModule=m;
      _IDE._data._curAction=_ideDataManagement._tmpTaskDataMap._curAction||_IDE._data._curAction
    }else{
      m=BZ._getCurModule();
      t=BZ._getCurTest();
    }
    window.$environment=_ideDataManagement._tmpTaskDataMap._env;
    if(t&&t.code!="_try"&&(!t._data||t._data.code!="_try")){
      window.$module=$data(m,0,_force);
      window.$test=$data(m,t,_force);
      k=m._data.code+t._data.code
      window.$loop=_ideDataManagement._tmpTaskDataMap._loop?_ideDataManagement._tmpTaskDataMap._loop[k]:{}
      if((!window.$parameter||!BZ._isRecording())&&_ideDataManagement._tmpTaskDataMap._parameter){
        window.$parameter=_ideDataManagement._tmpTaskDataMap._parameter[k]=_ideDataManagement._initRandomValue(_ideDataManagement._tmpTaskDataMap._parameter[k])
        if(window.$parameter===""||window.$parameter===undefined){
          if(t._data.defParameter){
            try{
              window.$parameter=_ideDataManagement._tmpTaskDataMap._parameter[k]=_ideDataManagement._tmpTaskDataMap._parameter[k]=t._data.defParameter
              eval("window.$parameter=_ideDataManagement._tmpTaskDataMap._parameter[k]=_ideDataManagement._tmpTaskDataMap._parameter[k]="+t._data.defParameter)
            }catch(e){}
          }
        }
        if(!t._data.doc||t._data.doc._id){
          if(window.$parameter===""||window.$parameter===undefined){
            window.$parameter=_ideDataManagement._tmpTaskDataMap._parameter[k]=_ideDataManagement._tmpTaskDataMap._parameter[k]={}
          }
        }
      }else{
        window.$parameter={}
      }
      window.$upgradeDiffs=_ideDataManagement._tmpTaskDataMap._upgradeDiffs
    }else{
      window.$module={}
      window.$test={}
      window.$loop={}
      window.$parameter={}
    }
  },
  _prepareCurLoopData:function(t){
    clearTimeout(_ideDataManagement._missLoopTestTimer)
    var k=_IDE._getShortcutKey(0,0,t);
    _ideDataManagement._tmpTaskDataMap._loop[k]=$loop=null;
    
    var _data=t.loopData||{},_noEnd=1;
    var v=_data.loopValue;
    if(v){
      if(v.constructor==String){
        try{
          eval("v="+v);
        }catch(e){
        }
      }
      if(!v||!v.length){
        var _msg=_Util._formatMessage(_bzMessage._system._error._missingLoopData,["$loop"]);
        if(BZ._isPlaying()){
          throw new Error(_msg)
        }else{
          BZ._data._uiSwitch._missLoopTest[k]=1
          return _ideDataManagement._missLoopTestTimer=setTimeout(()=>{
            _ideDataManagement._prepareCurLoopData(t)
          },100)
        }
      }else{
        BZ._data._uiSwitch._missLoopTest[k]=0
      }
      _data.loopValue=v;

      let _loopDataIdx="_"+"loopIdx"
      if($parameter&&$parameter[_loopDataIdx]!==undefined&&_data.loopEnd===undefined){
        _data.loopStart=parseInt($parameter[_loopDataIdx])||0
        _data.loopEnd=_data.loopStart+1
      }

      _data.loopStart=parseInt(_data.loopStart)||0;
      console.log("Loop data Idx2:"+_data.loopStart)
      window.$loop=_data.loopValue[_data.loopStart];
      
      v=_data.loopEnd;
      if(!v && v!==0){
        v=_data.loopValue.length;
      }
      if(v===false || v==="false" || v==="null"|| v===null || v==="undefined" || v===undefined){
        $loop=null;
        _noEnd=0
      }else{
        var vv=parseInt(v);
        if(vv && _data.loopStart>=vv){
          $loop=null;
          _noEnd=0
        }else{
          _data.loopStart++;
        }
      }
    }else{
      $loop=null;
      _noEnd=0
    }
    _ideDataManagement._tmpTaskDataMap._loop[k]=$loop;
    _fillRefData($loop)
    return _noEnd
    function _fillRefData(d){
      if(d){
        _Util._findDeepObj(d,function(v,k,ks,ps,o){
          if(v&&v.constructor==String&&v.match(/^<.+>$/)){
            o[k]=$test[v.substring(1,v.length-1).trim()]
          }
        })
      }
    }
  },
  //The function is triggered in playing processing
  _prepareTmpDataByPath:function(ds){
    if(ds&&ds.includes("_try")){
      return
    }
    var _tmpTaskDataMap=_ideDataManagement._tmpTaskDataMap
    if(!ds){
      return;
    }
    var ds=ds.split("/");
    ds.shift();
    ds.shift();
    var m,mm,tt,a,md,t;
    for(var i=0;i<ds.length;i++){
      var d=ds[i];
      if(d=="tm" || d=="tt"){
        return;
      }else if(d==_IDE._data._curVersion.code){
      }else if((d=="bug"||d=="com"||d=="ctrl" || d[0]=="m") && !tt){
        m=d;
        $module=$data(d)
      }else if(d[0]=="t" && !tt && m){
        tt=_ideTask._dataMap[m][d];
        $test=$data(m+d)
        t=d
        break;
      }
    }
    _tmpTaskDataMap._loop[m+t]=window.$loop;
  },
  //For updating from client side, should be triggered on only Script action.
  _updateTmpData:function(d,m,t){
    if(m&&t&&d&&d._tmpTaskDataMap){
      for(var k in d._tmpTaskDataMap){
        if(["_app","_loop"].includes(k)){
          if(d._tmpTaskDataMap[k]){
            _ideDataManagement._tmpTaskDataMap[k]=d._tmpTaskDataMap[k]
          }
        }else if(k=="_parameter"){
          var kk=m._data.code+t._data.code
          _ideDataManagement._tmpTaskDataMap[k][kk]=d._tmpTaskDataMap[k][kk]
        }else if(!["_env","_curModule","_curTest","_curAction"].includes(k)){
          _ideDataManagement._tmpTaskDataMap[k]=d._tmpTaskDataMap[k]
        }
      }
      let kkk=_IDE._getShortcutKey("",m,t);

      [[""],[m],[m,t]].forEach(xx=>{
        let x=$data(...xx);
        if(x){
          xx=xx[0]?_IDE._getShortcutKey("",...xx):""
          xx=d._tmpTaskDataMap._app[xx]
          Object.keys(x).forEach(y=>{
            if(x[y]&&x[y].constructor==Function){
              xx[y]=x[y]
            }
          })
        }
      });
      $loop=d._tmpTaskDataMap._loop[kkk]||$loop;
      $test=d._tmpTaskDataMap._app[kkk]||$test
      $module=d._tmpTaskDataMap._app[_IDE._getShortcutModuleCode(m)]||$module
      $project=d._tmpTaskDataMap._app[""];
    }
  },
  _updateDataMap:function(o,d){
    o=o._data||o;
    let dd=_compressJSON._unCompress(d.dataMap||d.defaultData)||[]
    if(o.dataMap){
      o.dataMap=dd
    }else{
      o.defaultData=dd
    }

    delete d.dataMap
    delete d.defaultData
    try{
      if(_DataBuilder._data._curData){
        _DataBuilder._setCurData(_DataBuilder._data._curData.k,_DataBuilder._data._curData._scope)
      }
    }catch(e){}
  },
  _addData:function(k,d){
    _ideDataManagement._curMap[k]=d._data.dataMap=d._data.dataMap||[]
    _DataBuilder._data._dataList=0
  },
  _deleteData(k){
    delete _ideDataManagement._curMap[k]
  },
  _updateData:function(ms,i,_fun){
    if(i<ms.length){
      var m=ms[i];
      if(m.tests.length){
        for(var n=0;n<m.tests.length;n++){
          var t=m.tests[n];
          t.dataMap=_compressJSON._unCompress(t.dataMap||[])
        }
        _ideDataManagement._updateData(ms,i+1,_fun)
      }else{
        _ideDataManagement._updateData(ms,i+1,_fun)
      }
    }else{
      _fun&&_fun()
    }
  },
  //np: name path ($test.data.name), v: new value
  _upgradeValueFromNamePath:function(np,v){
    var t=_ideDataManagement._tmpTaskDataMap._curTest._data.code;
    var m=_ideDataManagement._tmpTaskDataMap._curModule._data.code;
    
    if(np.startsWith("$parameter")){
      eval(np+"=v")
      _IDE._data._curTest._data.defParameter=_ideDataManagement._tmpTaskDataMap._parameter[m+t]=$parameter
    }else{
      var ps=np.split(".");
      var ov=0,d="";
      if(ps[0]=="$test"){
        d=m+t
        ov=BZ._getCurTest()._data.dataMap
      }else if(ps[0]=="$module"){
        d=m
        ov=BZ._getCurModule()._data.dataMap
      }else if(ps[0]=="$project"){
        ov=_IDE._data._curVersion.setting.defaultData
      }
      d=_ideDataManagement._tmpTaskDataMap._app[d]
      d[ps[1]]=v
      ov.find(vv=>{
        if(vv.name==ps[1]){
          vv.value=v
        }
      })
    }
  },
};

/*****************************************************/
// KEEP! for avoid duplicate call and good on toolbar//
window.$parentModule=function(){
  let v=BZ._getCurModule()
  
  if(v){
    v=v._data.parentModule
    if(v){
      return $data(v)
    }
  }
}
// KEEP! for avoid duplicate call and good on toolbar//
/*****************************************************/

var $data=function(m,t,init){
  var d=null,
      _map=_ideDataManagement._curMap,
      _tmpTaskDataMap=_ideDataManagement._tmpTaskDataMap;
  if(init){
    if(t){
      m=(m._data||m).code||m
      t=t._data||t
      let tt
      if(t.constructor==Object){
        tt=t
        t=t.code
      }else{
        tt=_ideObjHandler._getDataByPath(m,t)._data
      }
      _map[m+t]=tt.dataMap
      delete _tmpTaskDataMap._app[m+t]
    }else if(m){
      m=m._data||m
      let mm
      if(m.constructor==Object){
        mm=m
        m=m.code
      }else{
        mm=_ideObjHandler._getDataByPath(m)._data
      }
      _map[m]=mm.dataMap
      delete _tmpTaskDataMap._app[m]
    }else{
      console.log("BZ-LOG: init project data")
    }
  }
  if(m && m.constructor==Object){
    m=(m.code||m._data.code||"")
    // if(m!="com"){
      // m=m.substring(1)
    // }
  }else if(m&&m.constructor==String){
    if(window._ideObjHandler){
      window._tmpTakeDataModule=_ideObjHandler._getDataByPath(m)
    }else{
      window._tmpTakeDataModule=_tmpTaskDataMap._app[m]
    }
  }
  if(t && t.constructor==Object){
    t=(t.code||t._data.code)//.substring(1)
  }
  d=_pickData(m,t);
  if(!d){
    if($.isNumeric(m)){
      m="m"+m
      if(t || t==0){
        if($.isNumeric(t)){
          t="t"+t;
          d=_pickData(m,t)
        }else{
          if(!window._ideObjHandler){
            return
          }
          var md=_ideObjHandler._getDataByPath(m);
          if(!md){
            return
          }
          for(var i=0;i<md._data.tests.length;i++){
            if(t==md._data.tests[i].name){
              t=md._data.tests[i]
              break;
            }
          }
          if(t && t.constructor!=String){
            d=_pickData(m,t.code)
          }
        }
      }else{
        d=_pickData(m)
      }
    }else{
      m=_ideModuleManagement._getItemByName(m)
      if(m){
        return $data(m.code.substring(1),t)
      }
    }
  }
  delete window._tmpTakeDataModule
  return d;
  
  function _pickData(mm,tt){
    var dd,k=(mm||"")+(tt||"");
    dd=_tmpTaskDataMap._app[k]
    
    var td=_map[k]

    if(td){
      td=_ideDataHandler._generateNameData(td,dd,mm||"",tt||"")
    }else if(!k){
      td=window.$project||{}
    }
    if(!k){
      td._tmpIdx=1
    }
    if(!dd||init){
      _tmpTaskDataMap._app[k]=dd=$util.generateDataByRegex(td,k)
     // _ideDataManagement._initRandomValue(td)
    }else{
      for(var kk in td){
        if(_eval._isFun(td[kk])){
          dd[kk]=td[kk]
        }
      }
    }
    
    if(dd){
      $.extend(true,dd,_ideDataManagement._getPersonalData(k));
    }
    return dd;
  }
};window._domRecorder={
  _uploadFileTypes:["avi","bat", "css", "docx", "epub", "gif", "html", "jpg", "js", "json", "odt","ogv","pdf", "png", "rtf", "sh", "txt", "zip"],
  _tmpPath:[],
  _curAPI:0,
  _listenEvents:{
    change: "1",
    dblclick: "1",
    dragDrop: "1",
    click: "1"
  },
  unTmpClass:new Set(),
  _monitorList:[],
  _start:function(){
    this._lastStep=null;
    _domRecorder._setEventListenerOnAllDoms();
    _domRecorder._handleFileInput()
    // this._generateAIValidation([document.body],1)
  },
  _end:function(){
    _ideDataBind._data._inSelectFillField=0
    // _elementMonitor._handleMonitor();
    // _elementMonitor._close();
    _domRecorder._closeObserver();
    _domRecorder._removeEventListener();
    _domRecorder._setBackPopMsg();
    BZ._recording=0;
  },
  _observerTime:Date.now(),
  _observer:new MutationObserver(function(_mutations) {
    let _hasNew;
    if(_mutations.find(_mutation=>{
      let a=_mutation.addedNodes[0]
      
      return a&&a.nodeType==1&&!_domRecorder._isBZElement(a)
    })){
      if(_domRecorder._clickInputStep){
        _domRecorder._createRecordAction(_domRecorder._clickInputStep,1)
        _domRecorder._clickInputStep=0
      }
      clearTimeout(_domRecorder._newInsertTrigger);
      _domRecorder._newInsertTrigger=setTimeout(function(){
        _domRecorder._removeEventListener();
        _domRecorder._setEventListenerOnAllDoms();
      },10);
    }
  }),
  _isBZElement:function(t){
    return t&&($(t).hasClass("BZIgnore")||$(".BZIgnore").find(t).length)
  },
  _handleFileInput:function(){
    $("input[type=file]").on("click",function(e){
      if(BZ._isRecording()){
        bzTwComm._postToIDE({scope:"_domRecorder",fun:"_setClickFileInput"});
        e.stopPropagation()
        e.preventDefault()
        _domRecorder._selectUploadFileOption(this)
      }else if(BZ._isPlaying()){
        e.stopPropagation()
        e.preventDefault()
      }
    })
  },
  _selectUploadFileOption:function(e){
    window._uiSwitch=_CtrlDriver._buildProxy({_uploadFileFrom:"std"});
    
    let fs=_ideDataManagement._getCurFileData()
    
    if(fs.length){
      _uiSwitch._uploadFileFrom="_exist"
    }

    _Util._confirmMessage({
      _tag:"div",
      _attr:{
        style:"flex-direction: column;display: flex;line-height: 30px;height:150px;font-size:15px;"
      },
      _items:[
        {
          _tag:"div",
          _text:function(){
            return _bzMessage._action._ifUploadFile
          }
        },
        //exist file data
        {
          _if:function(){
            return fs.length
          },
          _tag:"label",
          _items:[
            {
              _tag:"input",
              _attr:{
                style:"margin-right:10px",
                type:"radio",
                value:"_exist"
              },
              _dataModel:{_data:_uiSwitch,_key:"_uploadFileFrom"}
            },
            {
              _text:function(){
                return _bzMessage._action._existFileData
              }
            }
          ]
        },
        {
          _if:function(){
            return _uiSwitch._uploadFileFrom=='_exist'&&fs.length
          },
          _tag:"div",
          _attr:{
            style:"display:flex;"
          },
          _items:[
            {
              _tag:"select",
              _attr:{
                style:"height:25px;width:100%"
              },
              _dataModel:{_data:_uiSwitch,_key:"_uploadUrl"},
              _items:[
                {
                  _tag:"option",
                  _attr:{
                    style:"font-size:13px",
                    value:function(d){
                      return '{{'+d._item+'}}'
                    }
                  },
                  _text:function(d){
                    d=d._item
                    let v=_Util._eval(d)
                    if(v.constructor==Function){
                      v=_ideDataHandler._getOrgDataSettingFromNamePath(d).url
                    }
                    if(v.constructor==String){
                      d=`${d} (${v})`
                    }
                    return d
                  },
                  _dataRepeat:function(){
                    return fs
                  }
                }
              ]
            }
          ]
        },
        //std files
        {
          _tag:"label",
          _items:[
            {
              _tag:"input",
              _attr:{
                style:"margin-right:10px",
                type:"radio",
                value:"std"
              },
              _dataModel:{_data:_uiSwitch,_key:"_uploadFileFrom"}
            },
            {
              _text:function(){
                return _bzMessage._action._uploadInStdFiles
              }
            }
          ]
        },
        {
          _if:function(){
            return _uiSwitch._uploadFileFrom=='std'
          },
          _tag:"div",
          _attr:{
            style:"display:flex;"
          },
          _items:[
            {
              _tag:"select",
              _attr:{
                style:"height:25px;width:100%"
              },
              _dataModel:{_data:_uiSwitch,_key:"_uploadUrl"},
              _items:[
                {
                  _tag:"option",
                  _attr:{
                    style:"font-size:13px",
                    value:function(d){
                      return d._item
                    }
                  },
                  _text:function(d){
                    return d._item
                  },
                  _dataRepeat:function(){
                    let vs=_domRecorder._uploadFileTypes
                    return vs.map(x=>"http:"+SERVER_HOST+'/file/example.'+x)
                  }
                }
              ]
            }
          ]
        },
        //url
        {
          _tag:"label",
          _items:[
            {
              _tag:"input",
              _attr:{
                style:"margin-right:10px",
                type:"radio",
                value:"url"
              },
              _dataModel:{_data:_uiSwitch,_key:"_uploadFileFrom"}
            },
            {
              _text:function(){
                return _bzMessage._action._uploadInUrlFile
              }
            }
          ]
        },
        {
          _if:function(){
            let r=_uiSwitch._uploadFileFrom=='url'
            if(r&&!_uiSwitch._uploadUrl){
              _uiSwitch._uploadUrl="/"+"/"
            }
            return r
          },
          _tag:"div",
          _attr:{
            style:"display:flex;"
          },
          _items:[
            {
              _tag:"input",
              _attr:{
                style:"flex:1;height:25px;"
              },
              _dataModel:{_data:_uiSwitch,_key:"_uploadUrl"}
            }
          ]
        },
        {
          _tag:"label",
          _items:[
            {
              _tag:"input",
              _attr:{
                style:"margin-right:10px",
                type:"radio",
                value:"local"
              },
              _dataModel:{_data:_uiSwitch,_key:"_uploadFileFrom"}
            },
            {
              _text:function(){
                return _bzMessage._action._uploadFromDesk
              }
            }
          ]
        },
        {
          _tag:"hr"
        },
        {
          _if:function(){
            return _uiSwitch._uploadUrl&&_uiSwitch._uploadFileFrom!='local'
          },
          _tag:"div",
          _items:[
            {
              _if:function(){
                return _uiSwitch._uploadUrl&&_uiSwitch._uploadUrl.match(/[.](docx|html|odt|epub|avi|pdf|rtf|zip)$/)
              },
              _tag:"a",
              _attr:{
                style:"cursor:pointer;",
                href:function(){
                  return _uiSwitch._uploadUrl
                },
                target:"_"+"blank"
              },
              _text:function(){
                return _bzMessage._action._reviewByDownload
              }
            },
            {
              _if:function(){
                return _uiSwitch._uploadUrl&&_uiSwitch._uploadUrl.endsWith('.ogv')
              },
              _tag:"video",
              _attr:{
                width:200,
                controls:1,
                style:"margin-top:5px;"
              },
              _items:[
                {
                  _tag:"source",
                  _attr:{
                    src:function(){
                      return _uiSwitch._uploadUrl
                    }
                  },
                  _text:"Your browser does not support HTML video."
                }
              ]
            },
            {
              _if:function(){
                return _uiSwitch._uploadUrl&&_uiSwitch._uploadUrl.match(/[.](png|jpg|gif)$/)
              },
              _tag:"img",
              _attr:{
                onerror:"this.style.display='none'",
                onload:"this.style.display='block'",
                src:function(){
                  return _uiSwitch._uploadUrl
                },
                style:"max-width:50px;max-height:50px;",
                onmouseover:"this.style.position='fixed';this.style.maxWidth='unset';this.style.maxHeight='unset';",
                onmouseout:"this.style.position='unset';this.style.maxWidth='50px';this.style.maxHeight='50px';",
              }
            },
            {
              _if:function(){
                let s=_uiSwitch._uploadUrl
                if(s&&s.match(/[.](bat|js|sh|css|json|txt)$/)){
                  $.get(s,function(d){
                    _uiSwitch._tmpContent=d
                  })
                  return 1
                }
              },
              _tag:"div",
              _attr:{
                style:"line-height:20px;padding:10px 0;"
              },
              _text:function(){
                if(_uiSwitch._uploadUrl.endsWith(".json")){
                  return JSON.stringify(_uiSwitch._tmpContent,0,2)
                }else{
                  return _uiSwitch._tmpContent
                }
              }
            }
          ]
        }
      ]
    },[{
      _title:_bzMessage._method._continue,
      _style:"background-color: #0069FF;color: #FFF;float: right;border: 1px solid #999;border-radius: 6px;padding: 6px 10px;font-size:15px;",
      _click:function(c){
        if(_uiSwitch._uploadFileFrom!="local"&&!_uiSwitch._uploadUrl){
          return alert(_bzMessage._action._missingUploadFile)
        }else if(_uiSwitch._uploadFileFrom=="local"){
          _uiSwitch._uploadUrl=""
          $(e).click()
        }else{
          let _url=_uiSwitch._uploadUrl
          if(_uiSwitch._uploadFileFrom=="_exist"){
            _url=_Util._eval(_url.replace(/[\{\}]/g,""))
          }
          if(_url.constructor==String){
            _Util._setUrlFileToInput(_url,e)
          }else{
            $util.triggerChangeEvent(e,_url,1);
          }
        }
        setTimeout(()=>{
          _uiSwitch._uploadFileFrom=""
        },100)
        c._ctrl._close()
      }
    },{
      _title:_bzMessage._method._cancel,
      _style:"background-color: #FFF;color: #000;float: right;border: 1px solid #999;border-radius: 6px;padding: 6px 10px;font-size:15px;",
      _click:function(c){
        _uiSwitch._uploadFileFrom=0
        _uiSwitch._uploadUrl=0
        
        c._ctrl._close()
      }
    }],0,0,1)
    setTimeout(()=>{
      $(".bz-modal-window").css({height:"480px","font-size":"11px"})
    },20)
  },
  _setClickFileInput:function(){
    _domRecorder._lastClickFileInput=Date.now()
    if(_domRecorder._lastNewActionTime&&_domRecorder._lastClickFileInput-_domRecorder._lastNewActionTime.t<200){
      let as=_IDE._data._curTest._data.actions
      let _idx=as.indexOf(_domRecorder._lastNewActionTime.a)
      
      if(_idx>=0){
        as.splice(_idx,1)
        if(_idx){
          BZ._setHash(_idx-1)
        }
      }
    }
  },
  _setBackPopMsg:function(){
    if(bzTwComm._isExtension()){
      return bzTwComm._postToApp({_fun:"_setBackPopMsg",_scope:"_domRecorder"})
    }
    if(window.BZ){
      if(BZ._documents){
        BZ._documents.each(function(i,w){
        });
      }
    }else{
      _doIt(window)
    }
    function _doIt(w){
      try{
        w.alert=w.BZ_Recording_Alert;
        w.confirm=w.BZ_Recording_Confirm;
        w.prompt=w.BZ_Recording_Prompt;
        
        if(w.BZ_Recording_Onbeforeunload){
          w.onbeforeunload= w.BZ_Recording_Onbeforeunload;
        }
        
        w.BZ_Recording_Alert=w.BZ_Recording_Confirm=w.BZ_Recording_Confirm=0
        
        if(w.XMLHttpRequest.prototype.BZ_Ajax){
          w.eval("window.XMLHttpRequest.prototype.open=window.XMLHttpRequest.prototype.BZ_Ajax");
          w.eval("window.XMLHttpRequest.prototype.send=window.XMLHttpRequest.prototype.BZ_AjaxSend");
          w.eval("window.XMLHttpRequest.prototype.setRequestHeader=window.XMLHttpRequest.prototype.BZ_SetHeader");
        }
      }catch(e){
      }
    }
  },
  _closeObserver:function(){
    try{
      this._observer.disconnect();
    }catch(e){}
    this._monitorList=[];
  },
  _setEventListenerOnAllDoms:function(_inTime){
    if(BZ._autoRecording && BZ._recording){
      _domRecorder._setDomEventListener(document)
      if(!_inTime){
        setTimeout("_domRecorder._setEventListenerOnAllDoms()",100);
      }
      return
    }
    if(!BZ._isRecording()){
      _domRecorder._closeObserver();
      return;
    }
    var w=BZ.TW;
    try{
      BZ._prepareDocument(function(){
        if(BZ._documents){
          //set event listener
          BZ._documents.each(function(i,_document){
            _domRecorder._setDomEventListener(_document)
            if(bzTwComm._isExtension()){
              var os=$("IFRAME");
              os.each(function(i,v){
                if(!v.src.startsWith("http")){
                  _domRecorder._setDomEventListener(v.contentDocument)
                }
              })
            }
          });
        }
      });
      if(!_inTime){
        setTimeout(function(){
          _domRecorder._setEventListenerOnAllDoms()
        },100);
      }
  //    }
    }catch(e){
      
    }
  },
  _setDomEventListener:function(_document){
    if(_document._inListening && (_document.body&&_document._body==_document.body)){
      return;
    }
    if(bzTwComm._isExtension()){
      bzTwComm._postToApp({_fun:"_takeoverPopMsg",_scope:"_domRecorder"})
    }else{
      _domRecorder._takeoverPopMsg(_document.defaultView);
    }
    if(BZ._autoRecording){
    // }else if(curUser._curProject.setting.record.autoAIValidation){
      // _elementMonitor._addObj(_document);
    }else{
      // _elementMonitor._close();
    }
    if(_document.body){
      _document._body=_document.body;
    }

    _domRecorder._monitor(_document);
    $(_document).on("focus","select,input,textarea",_domRecorder._bindFocus);
//    $(_document).find("select,input,textarea").bind("focus",_domRecorder._bindFocus);
    $(_document).find("[contenteditable=true]").bind("blur",_domRecorder._bindContentEditable);
    for(var k in _domRecorder._listenEvents){
      if (k=="click") {
        $(_document).find("*").not("style,script").bind("mousedown",_domRecorder._bindFun);
      }else if (k=="mousedown" && _domRecorder._listenEvents.click) {
        continue;
      }else if (k=="focus") {
        continue;
      }else if(k=="dragDrop"){
        $(_document).find("*").not("style,script").bind("mouseup",_domRecorder._bindFun);
        $(_document).find("*").not("style,script").bind("mousemove",_domRecorder._bindFun);
        if(!_domRecorder._listenEvents.mousedown && !_domRecorder._listenEvents.click){
          $(_document).find("*").bind("mousedown",_domRecorder._bindFun);
        }
        continue;
      }
      if(k=="change"){
        $(_document).find("input,textarea,select").bind(k,_domRecorder._bindFun);
      }else{
        $(_document).find("*").not("style,script").bind(k,_domRecorder._bindFun);
      }
    }
    $(_document).find("*").not("style,script").bind("keyup",_domRecorder._bindFun);
    $(_document).find("*").not("style,script").bind("keydown",_domRecorder._bindKeydown);
    _document._inListening=true;
    /*
    let iframes=$(_document).find("IFRAME")
    if(iframes[0]){
      iframes=iframes.toArray();
      iframes.forEach(function(v){
        if(!v.src){
          _domRecorder._setDomEventListener(v.contentDocument)
        }
      })
    }
    */
  },
  _buildTmpPath:function(o,_last){
    _last=_last||[]
    if(_last[0]==o){
      return _last
    }
    var _tmpPath=[]
    while(o && o.tagName!="BODY"){
      _tmpPath.push(o)
      o=o.parentNode||o.host
    }
    return _tmpPath
  },
  _retrievePath:function(p,x,y,_ignoreTxt){
    var _removedElement=[],_body
    if(p.length){
      delete p[0].bzTxtElement
      _body=p[0].ownerDocument.body
    }else{
      return
    }
    if(!_cssHandler._isInShadowDom(p[0])){
      let _lastPath=p[0].bzTmp
      while(p[0]&&!$(p[0].ownerDocument).find(p[0]).length){
        _removedElement.push(p.shift())
        if(!p.length){
          p=this._lastPaths
          _removedElement=[]
        }
      }
      if(!p[0]){
        return {
          _elementPath:_lastPath,
          W:{
            HH:[],
            LL:{}
          }
        }
      }
    }else{
      while(!p[0].getBoundingClientRect().width){
        p.shift()
      }
    }
    if(!p.length){
      p.push(_body)
    }
    let pp=0;
    if(p[0].tagName=="CANVAS"){
      p[0].bzTxtElement=_TWHandler._getCanvasTextElementByMousePos(p[0],x,y,_ignoreTxt)
      pp=p[0]
    }
    p[0].bzShortCut=0
    p=_cssHandler._findPath(p[0],1,_removedElement.length?2:0);
    if(_removedElement.length){
      var i=p._elementPath.pop();
      if(!$.isNumeric(i)){
        p._elementPath.push(i)
      }
      var e=_cssHandler._findCellElement(_removedElement[0]);
      var i=_removedElement.indexOf(e);
      _removedElement.splice(i+1)
      while(_removedElement.length){
        if(_removedElement[0]==e){
          break
        }
        _removedElement.shift()
      }
      while(_removedElement.length){
        e=_removedElement.pop()
        var d={e:e,oe:e,ps:[],ee:1,_headers:[]};
        _cssHandler._findAttributes(d)
        d=d._result._main
        if(d){
          d=d.join("")
        }else{
          d=e.tagName
        }
        p._elementPath.push(d);
      }
      if(e&&!_cssHandler._isInput(e)){
        var w=_Util._filterTxt($util.getElementText(e))
        if(w){
          p._elementPath[p._elementPath.length-1]+=":Contains("+w+")"
        }
      }
      p._elementPath.push(0)
    }

    return p;
  },
  _takeoverPopMsg:function(w){
    w=w||window
    try{
      var _beforeunload=w.onbeforeunload || (_checkJQueryEvent().beforeunload?_checkJQueryEvent().beforeunload[0].handler:null);
      if((!w.BZ_Recording_Onbeforeunload && _beforeunload) || (w.BZ_Recording_Onbeforeunload_fun && w.BZ_Recording_Onbeforeunload_fun!=_beforeunload)){
        w.BZ_Recording_Onbeforeunload=_beforeunload;
        if(_beforeunload){
          _beforeunload=function(){
            var _msg=w.BZ_Recording_Onbeforeunload();
            if(_msg){
              _domRecorder._curPopMsg={_type:"onbeforeunload",_msg:_msg,_time:Date.now()};
              var r=_domRecorder._curPopMsg._returnValue=_domRecorder._curPopMsg._msg;
              _domRecorder._setPopMsg();
              return r;
            }
          }
          if(w.onbeforeunload){
            w.onbeforeunload=_beforeunload;
          }else{
            _checkJQueryEvent().beforeunload[0].handler=_beforeunload;
          }
        }
        w.BZ_Recording_Onbeforeunload_fun=_beforeunload;
      }
      _TWHandler._takeoverCanvas(w)
      
      if(!w.BZ_Recording_Alert||w.BZ_Recording_Alert==w.alert){
        w.BZ_Recording_Alert=w.alert
        w.alert=function(m){
          _domRecorder._curPopMsg={_type:"alert",_msg:m,_time:Date.now()};
          _domRecorder._setPopMsg();
          w.BZ_Recording_Alert(m);
        }
      }
      if(!w.BZ_Recording_Confirm||w.BZ_Recording_Confirm==w.confirm){
        w.BZ_Recording_Confirm=w.confirm
        w.confirm=function(m){
          _domRecorder._curPopMsg={_type:"confirm",_msg:m,_time:Date.now()};
          var r=_domRecorder._curPopMsg._returnValue=w.BZ_Recording_Confirm(m);
          _domRecorder._setPopMsg();
          return r
        }
      }
      if(!w.BZ_Recording_Prompt||w.BZ_Recording_Prompt==w.prompt){
        w.BZ_Recording_Prompt=w.prompt
        w.prompt=function(m){
          _domRecorder._curPopMsg={_type:"prompt",_msg:m,_time:Date.now()};
          var r=_domRecorder._curPopMsg._returnValue=w.BZ_Recording_Prompt(m);
          _domRecorder._setPopMsg();
          return r
        }
      }
    }catch(e){}
    function _checkJQueryEvent(e){
      try{
        return $["_"+"data"](e,"events") || {};
      }catch(e){}
      return {};
    }
  },
  _setPopMsg:function(_popMsg){
    _popMsg=_popMsg||_domRecorder._curPopMsg;
    _domRecorder._curPopMsg=null;
    if(bzTwComm._isApp()){
      bzTwComm._postToExt({_fun:"_setPopMsg",_args:[_popMsg],_scope:"_domRecorder"});
      bzTwComm._postToIDE({_fun:"_setPopInfo",_args:[_popMsg],_scope:"_domRecorder"});
    }else if(!bzTwComm._isIDE()){
      _domRecorder._curPopMsg=_popMsg;
    }
  },
  _showSetAlert:function(v){
    _Util._confirmMessage({
      _tag:"div",
      _data:v,
      _items:[
        {
          _tag:"div",_attr:{"class":"input-group"},
          _items:[
            {
              _tag:"div",_attr:{"class":"input-group-addon"},
              _items:[
                {
                  _tag:"label",
                  _text:"_bzMessage._action._popType"
                }
              ]
            },
            {
              _tag:"select",
              _attr:{
                "disabled":"!BZ._isCheckout()",
                "class":"form-control",
              },
              _dataModel:"_data.popType",
              _items:[
                {
                 _tag:"option",
                  _attr:{
                    value:"_data._item"
                  },
                  _text:"_data._item",
                  _dataRepeat:["","alert","confirm","prompt","onbeforeunload"]
                }
              ]
            }
          ]
        },
        //Compare
        {
          _tag:"div",_attr:{"class":"input-group"},
          _items:[
            {
              _tag:"div",_attr:{"class":"input-group-addon"},
              _items:[
                {
                  _tag:"label",_text:"_bzMessage._action._compare"
                }
              ]
            },
            {
              _tag:"select",
              _attr:{
                "disabled":"!BZ._isCheckout()",
                "class":"form-control"
              },
              _items:[
                {
                  _tag:"option",
                  _attr:{
                    value:"_data._item"
                  },
                  _text:function(d){
                    return d._item.includes("clude")?_bzMessage._common[d._item]:d._item;
                  },
                  _dataRepeat:["==",">",">=","<","<=","!=","regex","include","exclude"]
                }
              ],
              _dataModel:"_data.compareMark"
            }
          ]
        },
        {
          _tag:"div",
          _attr:{
            "class":"input-group"
          },
          _items:[
            {
              _tag:"div",_attr:{"class":"input-group-addon"},
              _items:[
                {
                  _tag:"label",
                  _text:"_bzMessage._action._expection"
                },
              ]
            },
            //expection value
            {
              _tag:"input",
              _attr:{
                "class":"form-control",
                placeholder:"_bzMessage._action._dataSizeWarning"
              },
              _dataModel:"_data.expection"
            }
          ]
        },
        //return value
        {
          _if:function(d){
            return d.popType=='confirm' || d.popType=='prompt';
          },
          _tag:"div",_attr:{"class":"input-group"},
          _items:[
            {
              _tag:"div",_attr:{"class":"input-group-addon"},
              _items:[
                {
                  _tag:"label",
                  _text:"_bzMessage._action._returnValue"
                }
              ]
            },
            {
              _tag:"input",
              _attr:{
                "disabled":"!BZ._isCheckout()",
                type:"text",
                "class":"form-control"
              },
              _dataModel:"_data.returnValue"
            }
          ]
        }
      ]
    },[{
      _title:_bzMessage._method._close,
      _click:function(c){
        c._ctrl._close()
        _ideTestManagement._save()
      }
    }],0,0,1,0,1)
  },
  _isIgnoreClickElement:function(e){
    if(_cssHandler._isCustomizeInputCss(e)){
      return 
    }
    return ["INPUT","TEXTAREA","SELECT"].includes(e.tagName) && !["reset","submit","button","image"].includes(e.type)
  },
  _monitorSetInputActions:{
    _mergeForSetAction:function(e,a){
      let _this=this
      if(_this._isInMonitoredScope(e)&&(a._type=="click"||a._type=="change")){
        let as=_this._curMonitorElement._actions
        if(as.length==2){
          if(a._type!="click"||as[1]._type=="click"){
            _setLastAction(a)
            return
          }
        }else if(as.length>2){
          _setLastAction(a)
          return
        }
        as.push(a)
        if(a._type=="click"){
          clearTimeout(_domRecorder._mergeSetActionTime)
          _domRecorder._mergeSetActionTime=setTimeout(()=>{
            _doIt(as)
          },500)
        }
      }else{
        _setLastAction(a)
      }
            
      function _doIt(as){
        if(_Util._isHidden(_this._curMonitorElement._element)){
          let _targetElement=as[0]._element
          if((_targetElement.innerText||_targetElement.value||"").includes(a._txt)){
            as={
              _actions:as,
              _data:{
                _value:a._txt
              }
            }
            
            if(_IDE._innerWin._data._dataBind._showDataBind&&_targetElement){
              let p=_ideDataBind._getBindData(_targetElement)
              if(p){
                if(p.includes("$")){
                  p="{{"+p+"}}"
                  as._data._inputPath=_cssHandler._findInputPath(_targetElement)
                }
                as._data._name=p
              }
            }
            if(!bzTwComm._isExtension()){
              _ideActionManagement._mergeToSetAction(as);
            }else{
              bzTwComm._postToIDE({_args: [as],_scope:"_ideActionManagement",_fun:"_mergeToSetAction"});
            }
          }
          _this._lastAction=_this._curMonitorElement=0
          _Util._clearPreEventElements()
        }else{
          _setLastAction(a)
        }
      }

      function _setLastAction(a,_noclear){
        if(a._type=="click"){
          _this._lastAction=a
        }else{
          if(Date.now()-_domRecorder._monitorSetInputActions._chkTime>300){
            _Util._clearPreEventElements()
          }
          _this._lastAction=0
        }
        _this._curMonitorElement=0
      }
    },
    _chkElementUpdate:function(e){
      console.log("_chkElementUpdate")
      if(this._isInMonitoredScope(e)){
        return
      }

      let ds=_Util._getDiffAfterTriggerEvent(1,1)
      this._chkTime=Date.now()
      if(ds.includes(e)&&this._lastAction){
        this._curMonitorElement={
          _element:e,
          _diffList:ds,
          _actions:[this._lastAction]
        }
      }else{
        this._curMonitorElement=0
        this._lastAction=0
      }
    },
    _isInMonitoredScope:function(e){
      return this._curMonitorElement&&this._curMonitorElement._diffList.includes(e)
    }
  },
  _recordEvent:function(_action,_value){
    if(_ideDataBind._data._inSelectFillField){
      return
    }
    var _element=_action.currentTarget;
    if(["mousedown"].includes(_action.type)){
      _domRecorder._monitorSetInputActions._chkElementUpdate(_element)
    }

    if(_action.type=="change"){
      _element=_action.target;
      if(_element.type=="hidden"){
        return;
      }
    }
    _Util._removeLinkTarget(_element);

    if(_cssHandler._isInput(_element) && !_element.readOnly && !$("#BZ_Win").find(_element).length && "focusin"==_action.type){
      // setTimeout(function(){
        // _ideDataBind._showMe(_element)
      // },100);
      return
    }else if(_Util._isInContentEditable(_element) && !$("#BZ_Win").find(_element).length && "mousedown"==_action.type){
      // setTimeout(function(){
        // _ideDataBind._showMe(_element)
      // },100);
    }else if(!$(BZ.TW.document).find(".BZIgnore").find(_element).length){
      if(_action.type=="blur" && !_domRecorder._typed){
        return;
      }
    }
    //ignore tab on input/select
    var _keyCode=_Util._checkKeycode(_action)
    if(_keyCode==9 && ["A","BUTTON","INPUT","SELECT","TEXTAREA"].includes(_element.tagName)){
      return
    }else if([40,38,39,37].includes(_keyCode) && ["SELECT","TEXTAREA"].includes(_element.tagName)){
      return
    }else if(13==_keyCode && ["TEXTAREA"].includes(_element.tagName)){
      return 
    }
    var _paths;
    if(!this._lastPaths || this._lastPaths[0]!=_element){
      this._lastPaths=_paths=_domRecorder._buildTmpPath(_element);
    }else{
      _paths=this._lastPaths
    }

    if(["click","dblclick","mousedown"].includes(_action.type) && this._isIgnoreClickElement(_element)){
      if(_element.type=="file"){
        console.log("click file")
      }else if(_element.tagName!="SELECT"){
        this._lastStep._action=_action.type=="mousedown"?"click":_action.type;
        this._clickInputStep=this._lastStep
      }
      this._lastStep=0
      return;
    }

    
    var _step={
      _element:_element,
      _type:_ideActionData._type._triggerEvent,
      _paths:_paths,
      _action:_action.type,
      _ctrl:_action.ctrlKey,
      _alt:_action.altKey,
      _code:_keyCode,
      _char:_Util._checkCharcode(_action),
      _shift:_action.shiftKey,
      _value:_value,
      _button:_action.buttons||_action.button,
      _pageX:_action.pageX,
      _pageY:_action.pageY,
      _time:Date.now(),
      _tmpUrl:BZ.TW.location.href,
      _domXY:_Util._getDomXY(_element),
      _keyName:_action.key
    };

    if(_action.type=="mouseup"){
      if(!this._lastStep){
      }else if(this._listenEvents.dragDrop && this._lastStep._inDragdrop){
        _step._element=this._lastStep._element;
        _step._paths=this._lastStep._paths;
        _step._action="dragdrop";
        _step._orgPath=this._lastStep._orgPath;
        _step._tmpUrl=this._lastStep._tmpUrl;
        _step._startPos=_domRecorder._mousedownStep._domXY
        _domRecorder._createRecordAction(_step);
        this._lastStep=_step
      }else if(this._lastStep._action=="mousemove"){
        this._lastStep._action="click";
        _domRecorder._createRecordAction(this._lastStep);
        this._lastStep=0
      }
      return;
    }
    var _this=this;
    if (_action.type=="mousedown") {
      this._lastStep=_domRecorder._mousedownStep=_step;
      _step._orgPath=_domRecorder._retrievePath(_step._paths,_action.pageX,_action.pageY)
      return;
    }else if(_action.type=="mousemove"){
      if(!_step._button){
        if(this._lastStep && this._lastStep._action=="mousedown"){
          if(this._lastStep._element.draggable && (Math.abs(_step._pageX-this._lastStep._pageX)>10||Math.abs(_step._pageY-this._lastStep._pageY)>10)){
            this._lastStep._action="dragdrop";
            this._lastStep._pageX=_action.clientX
            this._lastStep._pageY=_action.clientY
            this._lastStep._targetElement=_Util._getElementByXY(this._lastStep._element.ownerDocument,_action.clientX,_action.clientY,this._lastStep._element)
            if(this._lastStep._targetElement){
              this._lastStep._targetElement=_cssHandler._findPath(this._lastStep._targetElement)
            }
          }else{
            this._lastStep._action="click";
          }
          _domRecorder._createRecordAction(this._lastStep);
          this._lastStep=0
        }else{
          this._lastStep=_step;
        }
      }else{
        if(this._lastStep && this._lastStep._element==_step._element && (this._lastStep._domXY.x!=_step._domXY.x || this._lastStep._domXY.y!=_step._domXY.y)){
          this._lastStep._inDragdrop=1
        }
      }
      return;
    }else if(_action.type=="click"){
      if(!this._lastStep){
        return
      }else if(this._lastStep._action=="dragdrop"){
        this._lastStep=0;
        return;
      }
      
      if(this._lastStep._action!=="mousedown"){
        return _domRecorder._createRecordAction(_step);
        /*
        var _tmpClick=_step;
        return setTimeout(function(){
          _domRecorder._createRecordAction(_tmpClick);
        },100)
        */
      }else if(this._lastStep && this._lastStep._action=="mousedown"){
        if((_action.pageX||_action.pageY)&&(Math.abs(_action.pageX-_domRecorder._lastStep._pageX)>50||Math.abs(_action.pageY-_domRecorder._lastStep._pageY)>50)){
          this._lastStep._action="dragdrop"
          this._lastStep._pageX=_action.pageX
          this._lastStep._pageY=_action.pageY
          if(this._lastStep._element.tagName=="CANVAS"){
            let _ignoreTxt=_descAnalysis._retrieveTextForElementPathItem(this._lastStep._orgPath._elementPath)
            let ee=_domRecorder._retrievePath(_step._paths,_action.pageX,_action.pageY,_ignoreTxt)
            if(ee){
              this._lastStep._targetElement=ee._elementPath
            }
          }
        }else{
          this._lastStep._action="click"
        }
        _domRecorder._createRecordAction(_domRecorder._lastStep);
        this._lastStep=0;
        return;
      }
    }
    if(!(this._lastStep && this._lastStep._action=="mousedown" && _step._element!=this._lastStep._element)){
      this._lastStep=_step;
    }
    _domRecorder._createRecordAction(_step);
  },
  _setPopInfo:function(_popMsg,a){
    if(!_popMsg){
      return;
    }
    a=a||_IDE._data._curAction;
    if(a){
      if(!a.event.popType){
        a.event.popType=_popMsg._type;
        a.expection=_popMsg._msg;
        a.event.returnValue=_popMsg._returnValue;
        a.event.popFollow=""
      }else{
        if(!a.event.alerts){
          a.event.alerts=[]
          a.event.alerts.push({
            popType:a.event.popType,
            expection:a.expection,
            returnValue:a.event.returnValue,
            popFollow:""
          })
        }
        a.event.alerts.push({
          popType:_popMsg._type,
          expection:_popMsg._msg,
          returnValue:_popMsg._returnValue,
          popFollow:""
        })
      }
    }
  },
  _addData:function(d){
    if(_isIgnoreElement(d._element,d._action)){
      return
    }
    if(!BZ._autoRecording && _domRecorder._lastData && _domRecorder._lastData._element==d._element && _domRecorder._lastData._action==d._action && d._action=="click"){
      return
    }else{
      _domRecorder._lastData={_element:d._element,_action:d._action}
    }
    if(d._action=="change"){
      _domRecorder._typed=0;
    }
    if(!d._orgPath){
      d._orgPath=_domRecorder._retrievePath(d._paths,d._pageX,d._pageY);
      if(!d._orgPath){
        return
      }
    }

    var a={
      "type":d._type,
      "element":d._orgPath._elementPath||d._orgPath.element,
      // qpath:_Util._getQuickPath(d._element),
      // css:d._orgPath.W||d._orgPath.css,
      event:{
        type:["change","focus","blur"].indexOf(d._action)>=0?d._action:d._action.indexOf("key")==0?"key":"mouse",
        ctrl:d._ctrl,
        alt:d._alt,
        shift:d._shift,
        button:d._button,
        x:d._pageX,
        y:d._pageY,
        keyCode:d._code,
        charCode:d._char,
        _customize:d._element._customize,
        value:BZ._autoRecording?d._value:_domActionTask._curValueDataBind||d._value
      },
      _tmpUrl:d._tmpUrl,
      _inUpload:d._inUpload,
      _uploadFile:d._uploadFile,
      _uploadUrl:d._uploadUrl
    };
    if(_isComElement(a.element)){
      let tt=_getComTarget(d._element)
      let tw=_descAnalysis._retrieveTextForElementPathItem(a.element)
      a.event.type="change"
      if(!tt){
        a.event.value="{{$parameter."+_glossaryHandler._getVariableName(tw)+"}}"
      }else if(tt.type=="radio"){
        a.event.value=tw
      }else{
        a.event.value="true"
      }
    }else if(d._action=="click"){
      // _ideDataBind._bindDataOnElement(a,"element")
    }
    //It is in blank IFRAME
    if(d._element.ownerDocument!==document&&!a.element[1].includes("IFRAME")){
      a.element.splice(1,0,"IFRAME:blank("+_identifyIFrameHandler._getBlankIFrameID(d._element.ownerDocument.defaultView)+")")
    }
    
    if(d._element.bzTxtElement){
      a.offset=d._element.bzTxtElement.offset
      delete d._element.bzTxtElement
    }
    
    if(d._targetElement){
      a.event.element=d._targetElement
      if(a.offset){
        a.event.offset=a.offset
        delete a.offset//={x:0,y:0,origin:"mc"}
      }
    }
    if(d._action=="dragdrop"&&d._startPos&&d._domXY){
      a.event.way=Math.abs(d._startPos.x-d._domXY.x)>Math.abs(d._startPos.y-d._domXY.y)?"H":"V"
    }
    if(!BZ._autoRecording){
      _domActionTask._curValueDataBind=0;
    }
    _domRecorder._setPopInfo(this._curPopMsg,a);
    this._curPopMsg=0;
    
    if(d._action=="change" && d._element.type!="file"){
      a.event.autoBlur="on";
    }else if(d._action=="keyup"){
      a.event.action="group";
      a.event.keyName=d._keyName
      delete a.event.value;
    }
    if(d._button==2){
      a.event.action="click";
    }else if (!["keyup","change","focus","blur"].includes(d._action)) {
      a.event.action=d._action;
    }
    
    if(d._element.tagName=="CANVAS"&&a.event.action=="click"&&!_descAnalysis._retrieveTextForElementPathItem(a.element)){
      
    }
    
    // _ideDataBind._bindDataOnElement(a,"element")
    _domRecorder._lastAction=a;
    _domRecorder._lastElement=d._element;
    _domRecorder._clickInputStep=0
    
    // if(!BZ._autoRecording && a.event.type!="change"){
      // _ideDataBind._hideMe()
    // }
    if(this._lastStep&&d._action=="change"){
      if(this._lastStep._action!="mousedown"){
        this._lastStep=0
      }
    }else{
      this._lastStep=0
    }
    if(_IDE._data._setting.autoMergeToSetValue){
      a._mergeId=Date.now()
      _domRecorder._monitorSetInputActions._mergeForSetAction(d._element,{
        _action:a,
        _element:d._element,
        _type:d._action,
        _txt:d._element.innerText||_descAnalysis._retrieveTextForElementPathItem(d._element),
        _elementScope:_cssHandler._getElementScope(d._element)
      })
    }
    if(BZ._autoRecording){
      BZ._storeData(a)
    }else if(!bzTwComm._isExtension()){
      _ideActionManagement._addItem(a);
    }else{
      //Call background to set back recording action
      _domRecorder._sendData(a)
    }
    _timingInfo._setTmpInfo([_ideActionManagement._getAutoDescription(a,1)])
    setTimeout(function(){
      _descAnalysis._clearTmpPath(1);
    },200)

    function _getComTarget(o){
      while(o){
        let os=$(o).find("INPUT")
        if(os.length){
          if(os.length>1){
            return
          }else{
            return os[0]
          }
        }else if(o.tagName=="BODY"){
          return
        }
        o=o.parentNode
      }
    }

    function _isComElement(p){
      return p[1][0]==":"&&!p[1].match(/^\:(input|text|Contains|RowCol|equal)/i)
    }

    function _isIgnoreElement(e,_action){
      if(_action=="click"&&e){
        if(e.tagName!="LABEL"&&e.tagName!="INPUT"){
          e=_Util._getParentNode(e,"LABEL")
        }
        
        if(e&&e.tagName=="LABEL"){
          e=$(e).find("input")[0]
        }

        if(e&&e.tagName=="INPUT"&&e.getBoundingClientRect().width&&(["checkbox","radio"].includes(e.type))){
          return 1
        }
      }
    }
  },
  _sendDataList:[],
  _sendData:function(a){
    this._lastData=a;
    BZ._formatInIFramePath(a.element)
    _domRecorder._sendDataList.push({_args:[a,function(){
      _doIt()
    }],_scope:"_ideRecorder",_fun:"_addNewItem"})
    _doIt()
    function _doIt(){
      if(!_domRecorder._waitSendData){
        let o=_domRecorder._sendDataList.shift()
        if(o){
          _domRecorder._waitSendData=1
          bzTwComm._postToIDE(o);
          
          setTimeout(()=>{
            _domRecorder._waitSendData=0
            _doIt()
          },300)
        }
      }
    }
  },
  _isIgnoreEvent:function(d){
    if(_cssHandler._isCustomizeInputCss(d)){
      return 
    }
    var _tagName=d.tagName;
    if(!d.readOnly){
      if((_tagName=="INPUT" && !["button","submit","radio","image"].includes(d.type)) || ["TEXTAREA","SELECT"].includes(_tagName)){
        //ignore click on input event
        return _tagName=="SELECT" || !_cssHandler._getParentSelect(d);
      }
    }
    return _Util._inSelectOption(d)
  },
  _insertPrepareChange:function(){
    if(this._prepareChange){
      var a=this._prepareChange;
      a._time=Date.now()
      this._prepareChange=0;
      this._createRecordAction(a)
      this._lastPrepareChangeElement={_element:a._element,_time:Date.now()}
    }
  },
  _createRecordAction:function(d,_force){
    if(this._lastPrepareChangeElement&&this._lastPrepareChangeElement._element==d._element&&Date.now()-this._lastPrepareChangeElement._time<500){
      if(d._code!=13||(this._lastAction&&this._lastAction.event.type!="change")){
        return
      }
    }
    if(!d || d._action=="focusin"){
      return;
    }
    if(d._action=="blur" && !_domRecorder._typed){
      return;
    }
    if(d._action=="keyup"){
      if(!d._code){
        return;
      }
      if(d._char==0 && ([13,40,38,33,34,9].includes(d._code) || d.code>111)){
        this._insertPrepareChange();
      }else if(_Util._isStdInputElement(d._element)){
        d._action="change"
        d._value=d._element.value;
        if(d._code==13 && !d._value){
          this._insertPrepareChange();
        }else{
          return this._prepareChange=d;
        }
      }else if($(d._element).attr("contenteditable")){
        return;
      }
    }else if(this._prepareChange && d._action._element!=this._prepareChange._element){
      this._insertPrepareChange();
    }else{
      this._prepareChange=0;
    }
    if(d._action=="click" && this._lastStep && this._lastStep._action=="keyup"){
      return;
    }
    if(["change","blur","focusout"].includes(d._action)){
      if(this._lastChangeStep && this._lastChangeStep._element==d._element && d._time-this._lastChangeStep._time<500){
        return;
      }else{
        this._lastChangeStep=d;
      }
    }else{
      this._lastChangeStep=0;
    }
    
    if(!_force&&"click,mousedown,mouseup".includes(d._action)){
      if(this._isIgnoreEvent(d._element)){
        return;
      }
    }else if(d._action=="change" && d._element.tagName=="SELECT"){
      var vs=""
      for(var i=0;i<d._element.selectedOptions.length;i++){
        var o=d._element.selectedOptions[i];
        v=o.textContent || o.text;
        vs+="\n"+v;
      }
      d._value=vs.substring(1);
    }
    var _changeOnFile=d._action=="change" && d._element.tagName=="INPUT" && d._element.type=="file";
    if(_changeOnFile){
      _uploadHandler._inputFileToBase64Obj(d._element.files,function(_result){
        var uf=_uiSwitch._uploadUrl
        d._uploadFile=_result
        _result=JSON.stringify(_result,0,2)
        if(uf||_ideActionManagement._checkFileSize(_result)){
          d._value=uf||("{{"+_result+"}}");
          d._inUpload=1
          d._uploadUrl=uf
          if(uf){
            delete d._uploadFile
          }
          _domRecorder._addData(d);
        }
      })
    }else if(d._action=="change" && d._element.tagName=="INPUT" && d._element.type=="checkbox"){
      if(!d._element.checked){
        d._value=null;
      }
    }else if(["focusout","blur"].includes(d._action) && !_Util._isStdInputElement(d._element) && d._element.contentEditable){
      d._action="change"
    }
    if(!_changeOnFile){
      _domRecorder._addData(d);
    }
  },
  _bindKeydown:function(a){
    if(!a.keyCode){
      return;
    }
    if($(BZ.TW.document).find(".BZIgnore").find(a.target).length){
      return;
    }
    // _elementMonitor._handleMonitor();
    if(_Util._isInContentEditable(a.currentTarget || a.target)){
      _domRecorder._typed=1;
    }
    setTimeout(function(){
      _ideDataBind._filter(a.target)
    },100)
  },
  _bindFun:function(a,b,c){
    if(!BZ._isRecording()){
      return;
    }
    if($(BZ.TW.document).find(".BZIgnore").find(this).length){
      return;
    }else if(!_IDE._data._setting.disableShadowRootRecording&&a.target.shadowRoot&&_Util._hasDeepContent(a.target.shadowRoot)){
      if(!a.target.shadowRoot._inListening){
        a.target.shadowRoot._path=_cssHandler._findPath(a.target)
        _domRecorder._setDomEventListener(a.target.shadowRoot)
      }
      return
    }else if(a.target==this){
      _domRecorder._recordEvent(a,this.value);
    }else if(a.type=="change"){
      _domRecorder._recordEvent(a,a.target.value);
    }

    if(a.type=="mouseup" && a.target==this){
      _domRecorder._removeEventListener();
      _domRecorder._setEventListenerOnAllDoms(1);
    }
  },
  _bindContentEditable:function(a){
    if(!BZ._isRecording() || (!BZ._autoRecording && _bzDomPicker._isPicking() && !_bzDomPicker._isRecording())){
      return;
    }
    if(a.target==this){
      _domRecorder._recordEvent(a,this.innerHTML);
    }
  },
  _bindFocus:function(a){
    if(!BZ._isRecording()){
      return;
    }
    if(a.target==this && !$(BZ.TW.document).find(".BZIgnore").find(this).length){
      _domRecorder._recordEvent(a,this.value);
    }
  },
  _removeEventListener:function(){
    //remove listener
    if(BZ._autoRecording){
      return _domRecorder._removeDomEventListener(document)
    }
    BZ._prepareDocument(function(){
      if(BZ._documents){
        BZ._documents.each(function(i,_document){
          _domRecorder._removeDomEventListener(_document)
        });
        if(!_bzDomPicker._isPicking()&&!_ideDataBind._data._inSelectFillField){
          _bzDomPicker._removeTmpCover();
        }
      }
    });
  },
  _removeDomEventListener:function(_document){
    try{
      _document._inListening=false;
      $(_document).off("focus","select,input,textarea",_domRecorder._bindFocus);
//      $(_document).find("select,input,textarea").unbind("focus",_domRecorder._bindFocus);
      $(_document).find("[contenteditable=true]").unbind("blur",_domRecorder._bindContentEditable);
      
      for(var k in _domRecorder._listenEvents){
        if (k=="click") {
          $(_document).find("*").not("style,script").unbind("mousedown",_domRecorder._bindFun);
        }else if (k=="mousedown" && _domRecorder._listenEvents.click) {
          continue;
        }else if (k=="focus") {
          continue;
        }else if(k=="dragDrop"){
          $(_document).find("*").not("style,script").unbind("mouseup",_domRecorder._bindFun);
          $(_document).find("*").not("style,script").unbind("mousemove",_domRecorder._bindFun);

          if(!_domRecorder._listenEvents.click){
            $(_document).find("*").unbind("mousedown",_domRecorder._bindFun);
          }
          continue;
        }
        if(k=="change"){
          $(_document).find("input,textarea,select").unbind(k,_domRecorder._bindFun);
        }else{
          $(_document).find("*").not("style,script").unbind(k,_domRecorder._bindFun);
        }
      }
      $(_document).find("*").not("style,script").unbind("keyup",_domRecorder._bindFun);
      $(_document).find("*").not("style,script").unbind("keydown",_domRecorder._bindKeydown);
    }catch(e){
      
    }
  },
  _monitor:function(_doc){
    var ds=_domRecorder._monitorList;
    if(!ds.includes(_doc)){
      ds.push(_doc);
      _domRecorder._observer.disconnect();
      for(var i=ds.length-1;i>=0;i--){
        var d=ds[i];
        if(!d.defaultView || d.defaultView.closed || !d.body){
          ds.splice(i,1);
        }else{
          _domRecorder._observer.observe(d.body,{
            childList:true,
            subtree:true,
            characterData: true,
            attributes:true,
            attributeFilter: ['style','class'],
            attributeOldValue:true
          });    
        }
      }
    }
  }
};var _taskInfo={
  _type:{
    _notReady:5,
    _success:4,
    _warning:3,
    _failed:2,
    _error:1,
    _crash:0
  },
  _errSou:{
    _env:0,        // Environment
    _page:1,       // Open Page
    _perf:2,       // performance
    _element:3,     // Source Data
    _exp:4,         // Expection Data
    _script:5
  },
  _valueMap:{
    s:"_success",
    w:"_warning",
    f:"_failed",
    e:"_error",
    c:"_crash"
  },
  _values:["_crash","_error","_failed","_warning","_success","_notReady"]
};var _domActionTask={
  _handleMonitorUrl:function(r){
    if(BZ._isPlaying()){
      for(let k in _domActionTask._curMonitorUrlFun){
        try{
          if(_domActionTask._curMonitorUrlFun[k](r.url)){
            delete _domActionTask._curMonitorUrlFun[k]
          }
        }catch(e){
          _ideReport._logErrInfo(_bzMessage._action._monitorUrlError+"\n"+k+"\n"+e.message)
        }
      }
    }
  },
  _findElement:function(o,p){
    if(!o.e){
      if(o.panels){
        o.e=_Util._findDomWithPanels(o.element,o.panels,p)
      }else{
        if(o.event&&o.event._valueKey){
          if(o.qpath){
            try{
              o.e=$util.findDom(o.qpath,p);
              if(o.e){
                return o.e
              }
            }catch(e){}
          }
          o.e=_cssHandler._findInputByLabel(o.element,o.event._valueKey)
          if(o.e){
            if(o.e._bzPath){
              o.element=o.e._bzPath
            }else{
              o.element=_cssHandler._findPath(o.e,0,3)
              window.$newElement=o.qpath=_Util._getQuickPath(o.e)
            }
          }
          return o.e
        }else if(o.mutipleElement){
          window.$element=o.e=_Util._findDoms(o.element.filter(x=>!$.isNumeric(x)));
        }else{
          o.e=$util.findDom(o.element,p);
        }
      }
    }
    return o.e
  },
  _getCurMaxWaitTime:function(a){
    return a.max||a.min||_domActionTask._getCurExpectReactionTime()
  },
  _getCurExpectReactionTime:function(){
    return _domActionTask._getCurAdvancedSetting().expectReactionTime
  },
  _getCurAdvancedSetting:function(){
    let t=BZ._getCurTest()
    t=t&&t._data.hostId
    return _IDE._data._curVersion.setting.advanced[t||0]
  },
  _exeResultScript:function($result,r){
    var _tmpStatus=$result.status
    try{
      let f;
      try{
        f=_Util._eval("f="+r._data.resultscript,{$result:$result})
        if(f&&f.constructor==Function){
          f()
        }
      }catch(ee){
        _Util._eval(`(()=>{\n${r._data.resultscript}\n})()`,{$result:$result})
        if(f&&f.constructor==Function){
          f()
        }
      }
      let b=$result.break;
      if(_tmpStatus!=$result.status){
        r._type=$result.status=="success"?4:$result.status=="warning"?3:$result.status=="failed"?2:1
      }
      if(b){
        r._bzSkip=0
        r._bzEnd=b=="bz-end"
        r._bzStop=b=="bz-stop"
        r._bzSkipGroup=b=="bz-skip-group"
        r._continue=b=="bz-continue"
      }
    }catch(e){
      r._type=2
      r._msg=_bzMessage._test._tab.resultscript+": "+e.message
    }
  },
  _buildTaskAction:function(a,t,i,q){
    var o=a._orgData||a;
    a=_Util._clone(o);
    a._orgData=o;
    a._supData=t;
    a._path=_ideLocation._getPath(0,t._supData,t)+(i+1)+"/";
    a._idx=i;
    if(!bzTwComm._isExtension()){
      a._level=_ideTask._level;
    }

    a.description=a.stepKey||!a.description?_ideActionManagement._getAutoDescription(a,1).trim():a.description
    q&&q.unshift(a);
    return a
  },
  _gotoFlag:function(s,as){
    if(BZ._isPlaying()&&s){
      let t=BZ._getCurTest()._data.code,
          m=BZ._getCurModule()._data.code,
          a,vs=[];
          
      if(!as&&!bzTwComm._isExtension()){
        as=_ideTask._data._taskQueue
      }
      while(a=as.shift()){
        vs.push(a)
        try{
          if(a._supData.code==t&&a._supData._supData.code==m){
            if(s==".."||s=="bz-stop"){
              continue
            }
            if(s=="..."||s=="bz-skip-group"){
              if(!a.inGroup||a.type==7){
                as.unshift(a)
                return
              }
            }
            if(!a.inGroup&&a.flag==s){
              as.unshift(a)
              return
            }
          }else{
            if(s==".."||s=="..."||s=="bz-stop"||s=="bz-skip-group"){
              as.unshift(a)
            }else{
              a=0
            }
            break
          }
        }catch(e){}
      }
      while(!a&&vs.length){
        as.unshift(vs.pop())
      }
    }
  },
  /*
  1:"Element appears",
  2:"Element appears and disappears",
  3:"Element appears and click",
  4:"Element appears and double click",
  5:"Element disappears",
  6:"Element disappears and appears again",
  7:"Element disappears and appears again and click",
  8:"Element disappears and appears again and double click",
  */
  _preCkRepElement:function(a,_result){
    //The action already completed in last page.
    var t=_taskInfo._type,
        md=a.event.repElementMethod;
    if(!md||!a.event.responseElement){
      return 
    }
    _result._startTime=Date.now()
    var o=$util.findDom(a.event.responseElement)
    if(o&&!_Util._isHidden(o)){
      _result._repElement=o
    }
    if("a1234".includes(md)){
      if(o&&!_Util._isHidden(o)){
        _result._type=t._error
        _result._msg=_bzMessage._task._repElementAppearBeforeExeError
      }
    }else{
      if(!o){
        _result._type=t._error
        _result._msg=_bzMessage._task._missBeginningRepElementError
      }
    }
  },
  /*
  1:"Element appears",
  2:"Element appears and disappears",
  3:"Element appears and click",
  4:"Element appears and double click",
  5:"Element disappears",
  6:"Element disappears and appears again",
  7:"Element disappears and appears again and click",
  8:"Element disappears and appears again and double click",
  */
  _ckRepElement1:function(a,_result,_fun){
    let t=_taskInfo._type,md=a.event.repElementMethod;
    _result._pTime=Date.now()-_result._startTime;
    if(!md||!a.event.responseElement){
      return _fun(_result)
    }
    if("a1234".includes(md)){
      var o=$util.findDom(a.event.responseElement)
      if(o&&!_Util._isHidden(o)){
        if(md==2){
          _result._repElement=o
          return _domActionTask._ckRepElement2(a,_result,_fun)
        }else if(3==md){
          _domActionTask._clickElement(o)
        }else if(4==md){
          _domActionTask._dblclickElement(o)
        }
        return _fun(_result)
      }
    }else{
      if(_Util._isHidden(_result._repElement)){
        if(md!=5){
          return _domActionTask._ckRepElement2(a,_result,_fun)
        }
        return _fun(_result)
      }
    }
    let _time=parseInt(a.max||2000)
    if(_result._pTime>_time){
      _result._type=t._error
      if("a1234".includes(md)){
        _result._msg=_bzMessage._task._repElementAppearFailed
      }else{
        _result._msg=_bzMessage._task._repElementDispearFailed
      }
      return _fun(_result)
    }else{
      if(_reExe(a)){
        a._reTrigger=1
        if($(document).find(a.e)[0]){
          return _domActionTask._trigger(a,function(r){
            _domActionTask._ckRepElement1(a,_result,_fun)
          })
        }else{
          _result._type=1
          _result._msg=_bzMessage._system._error._lostElement
          return _fun(_result)
        }
      }
      BZ._setTimeout(function(){
        _domActionTask._ckRepElement1(a,_result,_fun)
      },10)
    }
    
    function _reExe(a){
      if(md=="a"){
        _result._retryTimes=_result._retryTimes||0
        let _speed=Math.max(parseInt(a.event.repInterval)||(_time/10),1000)
        if(parseInt(_result._pTime/_speed)>_result._retryTimes){
          _result._retryTimes++
          return 1
        }
      }
    }
  },
  /*
  2:"Element appears and disappears",
  6:"Element disappears and appears again",
  7:"Element disappears and appears again and click",
  8:"Element disappears and appears again and double click",
  */
  _ckRepElement2:function(a,_result,_fun){
    var t=_taskInfo._type,md=a.event.repElementMethod;
    _result._pTime=Date.now()-_result._startTime;
    if(!md||!a.event.responseElement){
      return _fun(_result)
    }
    if("678".includes(md)){
      var o=$util.findDom(a.event.responseElement)
      if(o&&!_Util._isHidden(o)){
        if(md==7){
          _domActionTask._clickElement(o)
        }else if(md==8){
          _domActionTask._dblclickElement(o)
        }
        return _fun(_result)
      }
    }else{
      if(_Util._isHidden(_result._repElement)){
        return _fun(_result)
      }
    }
    var t=a.max||2000
    if(Date.now()-_result._startTime>t){
      _result._type=t._error
      if(4==md){
        _result._msg=_bzMessage._task._repElementAppearFailed
      }else{
        _result._msg=_bzMessage._task._repElementDispearFailed
      }
      return _fun(_result)
    }else{
      BZ._setTimeout(function(){
        _domActionTask._ckRepElement2(a,_result,_fun)
      },10)
    }
  },
  _clickElement:function(o,_fun){
    _domActionTask._isLoading(function(){
      $util.triggerMouseEvents(o,1,0,0,0,0,0,_fun)
    })
  },
  _dblclickElement:function(o,_fun){
    _domActionTask._isLoading(function(){
      $util.triggerDblClickEvents(o,1,0,0,0,0,0,_fun);
    })
  },
  _showIssueInComment:function(_result){
    var _element,_data=_result._data||_IDE._data._curAction,_chkSize;
    if(_result._errSou==_taskInfo._errSou._exp){
      _element=_data.element;
    }else{
      _element=$.extend([],_data.element);
      while(_element.length>1){
        var e=$util.findDom(_element)
        if(e){
          if(_chkSize){
            let r=e.getBoundingClientRect()
            while(r.width<500||r.height<500&&e.tagName!="BODY"){
              e=e.parentElement
              r=e.getBoundingClientRect()
            }
            _element=_cssHandler._findPath(e)
          }
          break
        }
        _chkSize=1
        _element.pop();
      }
      if(_element.length==1){
        _element.push("*:eq(0)","0")
      }
    }

    _bzDomPicker._removeTmpCover();
    _domActionTask._doComment({description:_result._msg,element:_element});    
    return _element;
  },
  _setCurValue:function(v){
    v=_JSHandler._prepareData(v);
    if(_Util._isRegexData(v)){
      v=$util.generateWordsByRegex(v)
    }
    return v
  },
  _prepareRequest:function(v,_result){
    var _host=""
    let _parameter=window.$parameter
    
    if(_parameter.$result){
      try{
        if(v._preScript){
          let $result
          $result=_parameter.$result[_result.idx]
          let $parameter={}
          _Util._eval(v._preScript,{$parameter:$parameter,$result:$result})
          _parameter=$parameter
        }else if(v._defParameter){
          _parameter=v._defParameter
        }
      }catch(e){
        throw new Error(e.message)
      }
    }

    if(!_apiHandler._isSocketRequest(v)){
      if($.isNumeric(v.host)){
        _host=BZ._curEnv.items[v.host].host
      }
      if(_host.endsWith("/")&&v.url[0]=="/"){
        _host=_host.substring(0,_host.length-1)
      }
      if(v.url.startsWith(_host)||v.url.match(/http[s]*\:\/\/.+/)){
      }else{
        _host+=v.url
        v.url=_host
      }
      delete v.host

      let _url=_JSHandler._prepareData(v.url,0,2,_parameter)
      if(!_url||!_url.split){
        alert("Skipped by empty data on url: "+v.url)
        return
      }
      v.url=_url
      let q=v.query
      if(q&&q.constructor!=Object){
        eval("q="+q)
      }
      v.url=v.url.split("?")[0]
      if(!_Util._isEmpty(q)){
        q=_Util._objToURI(_Util._formatObjectToFinalData(q,_parameter))
        v.url+=q||""
      }
      if(v.headers){
        if(v.headers.constructor==String){
          try{
            eval("v.headers="+v.headers)
          }catch(e){
            try{
              let vv=_Util._parseJSONWithRefDataToObj(v.headers)
              v.headers={}
              vv.forEach(x=>{
                v.headers[x._key]=_Util._removeStringSign(x._value)
              })
            }catch(ex){
              delete v.headers
            }
          }
        }
        if(v.headers&&v.headers.constructor==Object){
          v.headers=_Util._formatObjectToFinalData(v.headers,_parameter)
        }
      }else{
        delete v.headers
      }

      try{
        if(v.contentType&&v.contentType.toLowerCase().includes("json")){
          if(v.data&&v.data.constructor==String){
            v.data=_Util._strToJson(v.data,_parameter)
          }
          if(v.data){
            v.data=_Util._formatObjectToFinalData(v.data,_parameter)
            // v.data=JSON.stringify(v.data)
          }
        }else{
          // v.data=_Util._parameterToObj(v.data)
          v.data=_Util._formatObjectToFinalData(v.data,_parameter)
        }
      }catch(e){          
      }
    }else{
      if(v.data){
        v.data=_JSHandler._prepareData(v.data,0,0,_parameter)
        v.data=_Util._strToJson(v.data,_parameter)
        v.data=_Util._formatObjectToFinalData(v.data,_parameter)
      }
    }
  },
  _setBackData:function(a){
    let s=(a.script||"")
    if(a.requests){
      s+=a.requests.map(x=>x.responseScript||""+(x.loopData||"")).join("")
    }
    if(s.includes("$util.validateData")){
      s=s.split("$util.validateData")
      s.shift()
      s.forEach(x=>{
        x=x.split(",")
        x.shift()
        x.forEach(y=>{
          y=y.split(")")[0].trim()
          let d=y.match(/\$(test|module|project)[\.\[]([^\.\)]+)/)
          if(d){
            let dd=window["$"+d[1]]
            dd[d[2]]=_DataBuilder._getOrgDataByPath(y)
          }
        })
      })
    }
  },
  _prepareItem:function(_setting,a,_result,_funOnSelfCtrl){
    var u=!BZ._isAutoRunning();
    var _element=a.element||a.panel
    _domActionTask._setBackData(a)
    if(_apiHandler._isRequestAction(a)){
      return 1
    }else if(a.refCom){
      return 1
    }else if(a.event){
      _domActionTask._setErrorPos(_result,"_eventChange","_actionDetailsGeneral");
      a.event.value=_domActionTask._setCurValue(a.event.value)
      //skip
      if(_isSkip(a.event.value,"_value")){
        _domActionTask._reportAppInfo("Prepare action: value skip")
        return
      }
      _domActionTask._setErrorPos(_result,"_eventKeys","_actionDetailsGeneral");
      a.event.groupKeys=_domActionTask._setCurValue(a.event.groupKeys)
    }
    if(a.expection){
      _domActionTask._setErrorPos(_result,"_expection","_actionDetailsGeneral");
      if(_Util._hasCode(a.expection)){
        a.expection=_domActionTask._setCurValue(a.expection);
      }
      //skip
      if(_isSkip(a.expection,"_expection")){
        _domActionTask._reportAppInfo("Prepare action: expection skip")
        return
      }
    }
    if(a.api){
      _domActionTask._setErrorPos(_result,"_httpURL","_actionDetailsGeneral");
      a.api.httpURL=_JSHandler._prepareData(a.api.httpURL,0,2);
      if(_isSkip(a.api.httpURL,"_url")){
        _domActionTask._reportAppInfo("Prepare action: url skip")
        return
      }

      _domActionTask._setErrorPos(_result,"_httpHeaders","_actionDetailsGeneral");
      a.api.httpHeaders=_JSHandler._prepareData(a.api.httpHeaders);
      if(_isSkip(a.api.httpHeaders,"_headers")){
        _domActionTask._reportAppInfo("Prepare action: api headers skip")
        return
      }

      _domActionTask._setErrorPos(_result,"_httpData","_actionDetailsGeneral");
      a.api.httpData=_JSHandler._prepareData(a.api.httpData);
      if(_isSkip(a.api.httpData,"_httpData")){
        _domActionTask._reportAppInfo("Prepare action: url httpdata skip")
        return
      }
    }else if(a.loadURL){
      a.loadURL=_Util._mergeURL(_ideTestManagement._getCurHost(), _JSHandler._prepareData(a.loadURL,0,2))
    }
    if(_element){
      _element=_cssHandler._getCustomizeElement(_element,a)
      //Update element
      _element=_JSHandler._prepareData(_element);
      /*
      _element.forEach((e,j)=>{
        var w=_descAnalysis._retrieveTextForElementPathItem(e)
        if(_Util._isRegexData(w)){
          _element[j]=_element[j].replace(w,$util.generateWordsByRegex(w))
        }
      })
      */
      //skip
      if(_isSkip(_element,"_element")){
        _domActionTask._reportAppInfo("Prepare action: element skip")
        return
      }
      if(a.element){
        a.element=_element
      }else{
        a.panel=_element
      }
    }
    if(a.element){
      a.element.forEach((ee,j)=>{
        ee=_descAnalysis._retrieveTextForElementPathItem(ee)+""
        if(ee){
          ee=ee.match(/\/\{random:[0-9-]+[^\}]\}[\/]/)
          if(ee){
            ee=ee[0]
            let vv=$util.generateWordsByRegex(ee)
            a.element[j]=a.element[j].replace(ee,vv)
            if(a.event&&a.event.value==ee){
              a.event.value=vv
            }
          }
        }
      })
      if(a.skipActionElement){
        if($util.findDom(a.skipActionElement)){
          _result._bzSkip=1
          _result._pos="_element"
          _result._type=4
          _finalFun()
          
          _domActionTask._reportAppInfo("Prepare action: on skip element setting")
          return
        }
      }
      
      _domActionTask._setErrorPos(_result,"_element","_actionDetailsGeneral");
      _domActionTask._reportAppInfo("Prepare element")

      var e=_domActionTask._findElement(a,a.errOnHidden);
      
      if(!e){
        _domActionTask._reportAppInfo("Prepare action: element-1 not found. HTML size: "+(((document.body||{}).innerHTML||{}).length||0))
        bzTwComm._postToIDE({_fun:"_end",_scope:"_timingInfo",_args:[""]});
        e=_Util._getRandomSelection(a.element)
        
        if(e&&a.event&&a.event.value&&a.event.value.startsWith("/{random")){
          a.event.value=$util.getElementText(e)
          _domActionTask._setRandomValueToVariable(a.event.value,a)
        }
      }
      
      // if(e&&a.finalElement){
      //   e=_findFinalElement(e,a)
      //   if(!e){
      //     _domActionTask._reportAppInfo("Prepare action: element-2 not found")
      //   }
      //   a.e=e
      // }
      
      if(!e){
        _domActionTask._reportAppInfo("Prepare action: element-3 not found")
        if(a.content&&a.content.type=="unexist"){
          _result._type=_taskInfo._type._success
          return _finalFun()
        }else{
          _result._msg=_bzMessage._system._error._testError+"\n"+JSON.stringify(a.element,0,2);
        }
      }
      if(!e&&a.failElement&&$util.findDom(a.failElement)){
        _result._type=_taskInfo._type._failed
        _finalFun()
        return
      }else if(u&&!e&&(!a.content||a.content.type!="unexist")&&(!a.refOfError||a.refOfError.includes("e"))){
        e=_aiElementUpgrade._aiFindElement(a,window.$upgradeDiffs)
        if(!e){
          _result._type=_taskInfo._type._error
          return _finalFun()
        }else if(e._solution=="update"){
          window.$newElement=e;
          a.element=e._path
        }else{
          _result._type=_taskInfo._type._error;
          if(!a._inOneAction){
            e._upgradeList=_aiElementUpgrade._buildUpgradeStrategy(_element,e._path)
            window.$newElement=e;
            var ee=_Util._findTextElement(e._element)
            _screenshotHandler._getScreenshot(ee,0,function(c) {
              window.$newElement._img=c
              _finalFun()
              _bzDomPicker._removeTmpCover();
              _bzDomPicker._showTmpCover([e._element])
            });
          }else{
            _finalFun()
          }
          return 
        }
      }else if(!e){
        _result._type=_taskInfo._type._error
        
        return _finalFun()
      }else{
        if(e.constructor!=Array&&_Util._isHidden(e)){
          if(a.content&&a.content.type=="unexist"){
            _domActionTask._reportAppInfo("Prepare action: check unexist on hidden element")
            _result._type=_taskInfo._type._success
            return _finalFun()
          }
        }else if(a.offset){
          if(a.e.bzTxtElement){
            var xy = _Util._getDomXY(a.e);
            let aa={
              x:parseFloat(xy.x)+a.e.bzTxtElement.x,
              y:parseFloat(xy.y)+a.e.bzTxtElement.y,
              h:a.e.bzTxtElement.h,
              w:a.e.bzTxtElement.w
            }
            a.e._offset=_bzDomPicker._getOffsetPoint(aa,a.offset)
          }
        }
        if(_cssHandler._lastAllInputsMap){
          var p=_element.join(" ")
          _cssHandler._lastAllInputsMap[p]=e
        }
      }
    }
    return 1
    
    function _isSkip(v,p){
      v=v||""
      if(JSON.stringify(v).match(/bz-skip-group/i)){
        _result._type=_taskInfo._type._success
        _result._bzSkipGroup=1;
        _result._pos=p
        _finalFun()
        return 1
      }else if(JSON.stringify(v).match(/bz-skip/i)){
        _result._type=_taskInfo._type._success
        _result._bzSkip=1;
        _result._pos=p
        _finalFun()
        return 1
      }else if(JSON.stringify(v).match(/bz-stop/i)){
        _result._type=_taskInfo._type._success
        _result._bzStop=1;
        _result._pos=ps
        _finalFun()
        return 1
      }
    }
    function _finalFun(){
      if(_funOnSelfCtrl){
        _funOnSelfCtrl(_result)
      }
    }
  },
  _exeFillForm:function(d,_backFun){
    var r=_taskInfo._type;
    _ideReport._ignoreReport=1
    let o=_domActionTask._curFillForm={
      _action:d,
      _backFun:_backFun,
      _curData:{},
      _result:{_type:r._warning,_msg:_bzMessage._action._noData},
      _failedResults:[],
      _success:[],
      _missingData:{},
      _filledData:{},
      _curActionList:[],
      _successItems:[]
    }
    if(d.data.constructor==Array){
      _ergodicSettingHandler._buildFillformData(d)
    }

    o._exeProcess=function(){
      _ideReport._outputActionLog(d,60000)
      _timingInfo._setInfo([_bzMessage._task._analysising])
      o._keyMap={}
      for(let k in d.data){
        o._keyMap[k]=1
      }
      
      BZ._setTimeout(function(){
        o._fillActionList()
      },100);
    }
    
    o._fillActionList=function(_full){
      o._submitError=0
      var ks=Object.keys(d.data)

      ks.forEach(k=>{
        o._newActionListItem(k,_full)
      })
      if(o._curActionList.length){
        if(!o._submitError&&o._needRefill&&!_full){
          return o._fillActionList(1)
        }
        o._exeCurAction()
      }else{
        o._end()
      }
    }
    
    o._newActionListItem=function(k,_full){
      var dk=d.data[k]
      var a={
        element:dk.element||d.element,
        $lable:dk.$label,
        customize:dk.customize,
        $header:dk.$header,
        qpath:dk.element,
        event:{autoBlur:1,type:"change",_dataSrc:dk,_valueKey:k},
        type:1
      }
      if(o._setNewActionValue(a,o._filledData,_full)){
        if(a.event._curValueType=="error"){
          o._submitError=a
        }
        
        o._curActionList.push({a:a,k:k,v:dk,p:k})
      }
    }

    //a: action, _filledData: filled data,_full: fill all data
    o._setNewActionValue=function(a,_filledData,_full){
      a=a.event
      let k=a._valueKey
      let vm=a._dataSrc,vv=_filledData[k];
      a._curValueType=""
      a._curValidMsg=""
      if(vm.constructor==Object){
        if(vm.error&&vm.error.constructor==Array&&!vm.error.length){
          delete vm.error
        }
        if(!_full&&vm.error!==undefined&&!o._submitError){
          if(vm.error.constructor==Array){
            vv=vm.error.shift()
            if(!vm.error.length){
              delete vm.error
            }
          }else {
            vv=vm.error
            delete vm.error
          }
          a._curValidMsg=vv.message
          vv=vv.value!==undefined?vv.value:vv
          a._curValueType="error"
        }else{
          if(!_full&&(((vm.success.value!==undefined)&&vv==vm.success.value)||vv==vm.success)){
            return
          }else{
            vv=vm.success.value!==undefined?vm.success.value:vm.success
            a._curValidMsg=vm.success.message
          }
        }
        a.value=vv
      }else{
        if(vv==vm&&!_full){
          return
        }else{
          a.value=vm
        }
      }
      o._curData[k]=a.value
      if(!_full){
        _filledData[k]=a.value
      }
      return a
    }
    
    o._exeCurAction=function(){
      if(!_TWHandler._isAfterRequest()){
        return o._exeCurAction()
      }
      _ideReport._outputActionLog(d,1000)
      if(!BZ._isPlaying()){
        o._end()
        return
      }
      var a=o._curExeItem=o._curActionList.shift();
      if(a){
        _timingInfo._setInfo([_bzMessage._task._fillingForm+": "+a.k])
        
        BZ._setTimeout(function(){
          /*****************************************************/
          //after trigger action, call back o._exeItemResult
          /*****************************************************/
          a.a._inForm=1
          _ideTask._action._runAction(a.a)
        },100)
      }else if(o._afterFillAll){
        o._afterFillAll()
      }else{
        BZ._setTimeout(function(){
          //success
          if(d.autoNext){
            o._submit("nextBtn")
          }else if(d.autoSubmit){
            o._submit("submitBtn")
          }else{
            o._deepTest()
          }
        },100)
      }
    }
    
    o._deepTest=function(_setFailedOnEnd){
      if(o._submitError){
        //rebuild data
        o._fillActionList()
      }else{
        if(_setFailedOnEnd){
          o._addFailedResult({
            _msg:_bzMessage._action._failedOnSuccessData
          })
        }else if(Object.keys(o._missingData).length){//After click next on success data
          d.data=o._missingData
          o._missingData={}
          o._success=[]
          o._fillActionList()
          return
        }
        o._end()
      }
    }
    //_data: action
    //_checkType: line or submit
    o._checkMsg=function(_data,_checkType,_fun){
      if(!_checkType){
        return _fun()
      }
      let _css=_cssHandler._getActionMsgCss(d,_checkType)

      let _setting={
        _checkType:_checkType,
        element:d.element,
        _data:[]
      }
      let _lineErrCss=_Util._isEmpty(d.lineError||[])?"":d.lineError
      let _sumErrCss=_Util._isEmpty(d.finalError||[])?"":d.finalError

      for(let i=0;i<_data.length;i++){
        let a=_data[i].a;
        var _curValueType=a.event._curValueType;
        if(a.event._curValidMsg||_curValueType=="error"||_css[_curValueType]){
          _setting._data.push({
            _element:a.element,
            qpath:a.qpath,
            _type:_curValueType,
            _valueKey:a.event._valueKey,
            _lineErrCss:_lineErrCss,
            _sumErrCss:_sumErrCss,
            _msg:a.event._curValidMsg,
            _value:a.event.value
          })
        }else if(!_curValueType&&d.finalError){
          _setting._data.push({
            _element:a.element,
            qpath:a.qpath,
            _type:"",
            _valueKey:a.event._valueKey,
            _lineErrCss:_lineErrCss,
            _value:a.event.value
          })
        }
      }
      
      if(_setting._data.length){
        BZ._setTimeout(function(){
          _cssHandler._checkFillFormMsg(_setting,function(ds){
            //TODO: store check result
            for(var k in ds){
              var dd=ds[k]
              if(!dd._result){
                let _msg;
                if(dd._type=="error"){
                  _msg=_bzMessage._action._lostTargetElement
                }else{
                  _msg=_Util._formatMessage(
                    _bzMessage._action._msgNotMatch,
                    [
                      dd._valueKey,
                      dd._value,
                      dd._msg,
                      dd._updateMsg
                    ]
                  )
                }
                o._addFailedResult({
                  _msg:_msg,
                  _valueKey:dd._valueKey,
                  _value:dd._value,
                  _defMsg:dd._msg,
                  _updateMsg:dd._updateMsg
                })
                if(!dd._updateMsg){
                  o._needRefill=1
                }
              }
            }
            _fun()
          })
        },500)
      /*
      }else if(d.finalSuccess){
        _cssHandler._isElementReady({ts:[_btnPath],element:d.element},function(b){
          if(!b){
            o._addFailedResult({
              
            })
          }
          _fun()
        })
        */
      }else{
        _fun()
      }
    }
    
    o._addFailedResult=function(_msg){
      for(var i=0;i<o._failedResults.length;i++){
        if(o._failedResults[i]._msg==_msg._msg){
          return
        }
      }
      o._failedResults.push(_msg)
    }
    
    o._submit=function(_btnType){
      if(!_TWHandler._isAfterRequest()){
        return BZ._setTimeout(function(){
          o._submit(_btnType)
        },100)
      }
      var _btnPath=d[_btnType]
      _cssHandler._isElementReady({ts:[_btnPath],element:d.element},function(b){
        b=b[0]
        if(b=="enable"){
          var a={_inForm:1,element:_btnPath,type:1,event: {type: "mouse","button": 1,action: "click"}}
          
          _ideTask._action._runAction(a,0,function(){
            BZ._setTimeout(function(){
              o._checkAfterSubmit(_btnType)
            },1000)
          })
        }else if(b=="disable"){
          o._deepTest(1)
        }else if(_btnType=="nextBtn"&&d.autoSubmit){
          o._submit("submitBtn")
        }else{
          o._deepTest(1)
        }
      })
    }
    
    o._checkAfterSubmit=function(_btnType){
      if(!_TWHandler._isAfterRequest()){
        return BZ._setTimeout(function(){
          o._checkAfterSubmit()
        },100)
      }
      if(d.handleMsg&2){
        //check on all data
        return o._checkMsg(o._success,d.handleMsg,function(_failedResult){
          _cssHandler._isElementReady({ts:o._success.map(oo=>{return oo.a.element}),element:d.element},function(rs){
            var _enableCount=0,_emptyCount=0
            rs.forEach(rr=>{
              if(rr.includes("enable")){
                _enableCount++
              }
              if(rr.includes("empty")){
                _emptyCount++
              }
            })
            
            if(rs.length-_enableCount>rs.length/2){//form is submitted and dispear
              if(o._submitError){//It is a error on submit error data
                o._result._type=r._error;
                o._addFailedResult({
                  _msg:_bzMessage._action._passErrData+":\n",
                  _valueKey:o._submitError.k,
                  _value:o._curData[o._submitError.k]
                })
                $test.curFillFormData=_Util._clone(o._curData)
                o._end()
              }else{//It is right for submit a normal data
                if(_btnType=="nextBtn"){
                  if(!Object.keys(o._missingData).length&&d.autoSubmit){
                    return o._submit("submitBtn")
                  }
                  d.data=o._missingData
                  o._missingData={}
                  o,_deepTest()
                }else{
                  o._checkSuccessInfo(function(_success){
                    o._success=[]
                    o._filledData={}
                    if(d.finalSuccess&&!_success){
                      o._result._type=r._failed
                      o._addFailedResult({
                        _msg:_bzMessage._action._missSuccessMsg
                      })
                    }
                    _cssHandler._cleanCache(d,function(){
                      o._end()
                    })
                  })
                }
              }
            }else{//form is still here
              if(o._submitError){// It is right for submit error data
                o._deepTest()
              }else{//It is maybe not good for normal data
                o._checkSuccessInfo(function(_success){
                  if(!_success){
                    o._result._type=r._error;
                    o._addFailedResult({
                      _msg:_bzMessage._action._failedOnSuccessData
                        +(d.finalSuccess?" "+_bzMessage._common._orWord+" "+_Util._formatMessage(_bzMessage._action._missSuccessMsg,d.finalSuccess):"")
                    })
                  }
                  _cssHandler._cleanCache(d,function(){
                    o._end()
                  })
                })
              }
            }
          })
        })
      }
      o._deepTest()
    }
    
    o._checkSuccessInfo=function(_fun){
      if(d.finalSuccess){
        _cssHandler._isElementReady({ts:[d.finalSuccess],element:d.element},function(rs){
          _fun(rs[0])
        })
      }else{
        _cssHandler._chkNoElement({
          element:d.element,
          _css:d.finalError||d.lineError
        },function(r){
          _fun(!r)
        })
      }
    }

    o._exeItemResult=function(_result,dd){
      _timingInfo._end();
      if(dd.$newElement){
        o._curExeItem.a.qpath=dd.$newElement
      }
      if(_result._type==r._success){
        let _found=0
        for(var i=0;i<o._success.length;i++){
          if(o._success[i].k==o._curExeItem.k){
            o._success[i]=o._curExeItem
            _found=1
            break
          }
        }
        if(!_found){
          o._success.push(o._curExeItem)
        }
        if(d.handleMsg&1){
          //check on each line
          return o._checkMsg([o._curExeItem],1,function(){
            o._exeCurAction()
          })
        }
        o._exeCurAction()
      }else if(_result._type==r._error){
        o._missingData[o._curExeItem.k]=o._curExeItem.v
        delete d.data[o._curExeItem.k]
        o._exeCurAction()
      }else if(_result._type==r._failed){
        if(o._curExeItem.a.event._curValueType!="error"){
          o._addFailedResult({
            _msg:o._curExeItem.k+": "+_result._msg,
            _valueKey:o._curExeItem.k,
            _value:o._curData[o._curExeItem.k]
          })
          o._end()
        }
      }
    }
    o._end=function(){
      o._success=[]
      o._filledData={}
      _timingInfo._end()
      _domActionTask._curFillForm=0
      $test.curFillFormData=_Util._clone(o._curData)
      o._result._msg=""
      var _successList=new Set(Object.keys(d.data))
      if(!o._failedResults.length&&o._result._type==r._warning){
        if(Object.keys(o._missingData).length){
          o._result._type=r._failed;
        }else{
          o._result._type=r._success;
        }
      }else{
        if(o._result._type==r._warning){
          o._result._type=r._failed
        }
        o._failedResults.forEach((f,j)=>{
          if(f._data&&f._data._valueKey){
            o._result._msg+="\n"+(j+1)+". "+f._data._valueKey+": "
            _successList.delete(f._data._valueKey)
          }else{
            o._result._msg+="\n"+(j+1)+". "
          }
          o._result._msg+=f._msg
        })
      }
      if(!o._failedResults.length){
        if(o._result._msg){
          o._result._msg+="\n---------------------\n"
        }
        _successList=[..._successList]
        o._result._msg+="\n"+_successList.map(oo=>{return oo+":"+_bzMessage._common._success}).join("\n")
      }
      _ideReport._ignoreReport=0
      o._result._data=o._action;
      o._result._fillFomeData={
        _failedResults:o._failedResults,
        _successList:_successList
      }
      _ideTask._setDoNext(o._result);
    }
    if(d.data&&!$.isEmptyObject(d.data)){
      o._exeProcess()
    }else{
      if(d.autoSubmit){
        o._submit("submitBtn")
      }else{
        o._result._data=d
        return _backFun?_backFun(o._result):_ideTask._setDoNext(o._result);
      }
    }
  },
  _logOneAction:function(a){
    let v=a._path.match(_IDE._actionPathRegex)
    if(v){
      v="##"+_bzMessage._log._exeSingleActionGroup+"## ("+v[0].split("/").pop()+"), "+a.description
      _domActionTask._doLog(v)
    }
  },
  _reportAppInfo:function(v){
    if(bzTwComm._isExtension()){
      bzTwComm._postToIDE({
        _fun:"_receiveAPPInfo",
        _scope:"_ideTask",
        _args:[v]
      })
    }
  },
  _doLog:function(v){
    if(bzTwComm._isExtension()){
      bzTwComm._postToIDE({
        _fun:"log",
        _scope:"console",
        _args:["BZ-LOG: "+v]
      })
    }else{
      console.log("BZ-LOG: "+v+" (APP)")
    }
  },
  _exeOneActionList:function(_data,_setting,_backFun,_descDelay){
    _data.asOneAction=0
    let as=[_data],_result,_lastLog,_waitSameRequest=0,_startTime=Date.now(),_tryNotWait;
    _domActionTask._curOneActionList=as.concat(_data._oneActionList)
    let ss=[],_curGroup,_retry=0,_speed=parseInt(_data.speed)||50,_enableElse,_lastAction;
    let _localActions=localStorage.getItem(_data._path)
    localStorage.removeItem(_data._path)
    _domActionTask._curOneActionList.forEach(x=>x._inOneAction=1)
    if(_localActions){
      let _leaveActions=_Util._strToJson(_localActions)
      if(!_Util._isEmpty(_leaveActions)){
        _domActionTask._curOneActionList=_leaveActions
      }
    }
    $group=null
    _doIt()
    
    function _doIt(a){
      let _ssss=(a&&(a.max||a.min))||_speed
      BZ._setTimeout(()=>{
        if(_TWHandler._curRequestList.length&&!_tryNotWait){
          _waitSameRequest++
          let _log=_Util._formatMessage(
            _bzMessage._task._waitRequests,[
              _TWHandler._curRequestList.length,
              _TWHandler._curRequestList.map(r=>{
                return "    "+r._url
              }).join("\n")+"\n"
            ]
          )
          if(_lastLog!=_log){
            _lastLog=_log
            _domActionTask._doLog(_log)
            _retry=0
            return _doIt(a)
          }else{
            _log=_bzMessage._task._logAgain
            if(_waitSameRequest<10&&Date.now()-_startTime<30000){
              _domActionTask._doLog(_log)
              _tryNotWait=1
              return _doIt(a)
            }
          }
        }
        if(!_tryNotWait){
          _lastLog=""
        }
        a=a||_domActionTask._curOneActionList.shift()
        _storeTmpData(_data._path,_domActionTask._curOneActionList)
        
        if(!a||a.type==7){
          if(_curGroup){
            if(_curGroup.loopGroup||!_chkEndGroup()){
              a&&_domActionTask._curOneActionList.unshift(a)
              _domActionTask._curOneActionList=ss.concat(_domActionTask._curOneActionList)
              ss=[]
              return _doIt()
            }else{
              _handleResult(_result,_curGroup)
              _curGroup=0
              ss=[]
              if(a){
                return _doIt(a)
              }
            }
          }else if(a){
            if(a.elseGroup&&!_enableElse){
              while(_domActionTask._curOneActionList.length){
                a=_domActionTask._curOneActionList.shift()
                if(a&&(!a.inGroup||a.type==7)){
                  _domActionTask._curOneActionList.unshift(a)
                  break
                }
              }
              return _doIt()
            }

            _enableElse=0
            _curGroup=a
            //Handle group data
            a&&_tmpLoopDatahandler._handleGroupData(a,_setting)
            return _doIt()
          }else if(_result){
            return _backFun(_result)
          }
        }else if(_curGroup){
          if(!ss.includes(a)){
            ss.push(a)
          }
          delete a.e
        }
        
        if(a){
          _TWHandler._curRequestList.length=0
          if(a!=_lastAction){
            _domActionTask._logOneAction(a);
            _lastAction=a
          }
          _domActionTask._exeAction(a,_setting,function(r){
            //Retry
            if((r._type==1&&a.failedReaction!=1)||(r._type==2&&a.failedReaction==2)){
              if(a.e&&a.type==1&&a.event.type=="change"&&!_Util._isInputObj(a.e,1)){
              }else{
                let _time=parseInt(a.max||_IDE._data._setting.advanced[a._supData.hostId||0].expectReactionTime||2000)
                if(_retry<_time){
                  _retry+=_speed
                  if(r._type==1){
                    _domActionTask._doLog(_bzMessage._task._retryOnMissingElement)
                  }else{
                    _domActionTask._doLog(_bzMessage._task._retryOnElementExist)
                  }
                  _tryNotWait=0
                  delete a.e
                  return _doIt(a)
                }
              }
            }
            delete a.e
            let v=_handleResult(r,a)
            if(v.includes("..")||v.includes("....")||(v.includes("...")&&a.inGroup)){
              if(ss.length==1&&a.type==0&&v.includes("...")){
                _enableElse=1
              }
              while(_domActionTask._curOneActionList.length){
                a=_domActionTask._curOneActionList.shift()
                if(a&&(!a.inGroup||a.type==7)){
                  _domActionTask._curOneActionList.unshift(a)
                  break
                }
              }
              if(_final(v,r)){
                return
              }
            }else{
              _retry=0
            }
            if(_domActionTask._curOneActionList.length||(_curGroup&&(_curGroup.loopGroup||window.$group!=null))){
              return _doIt()
            }else{
              return _final()
            }

            return _final()
          },_descDelay)
        }else if(_result){
          return _backFun(_result)
        }
      },_ssss)
    }
    
    function _storeTmpData(p,_list){
      try{
        _list=_list.map(x=>{
          x=Object.assign({},x)
          x._supData={
            actions:[],
            _path:x._supData._path,
            code:"t6",
            _supData:{
              code:x._supData._supData.code
            }
          }
          return x;
        })
        _list=JSON.stringify(_list)

        localStorage.setItem(p,_list)
      }catch(e){
        
      }
    }
    function _handleResult(r,a){
      r._data=a
      if(a.type==0){
        if(!a.content){
        }else if(a.content.type=="exist"){
          if(r._type==1){
            r._type=2
          }
        }else if(a.content.type=="unexist"){
          // if(r._type==1){
            // r._type=4
          // }else if(r._type==4){
            // r._type=2
          // }
        }
      }
      
      if(!r.exeTime){
        r.exeTime=a.exeTime
      }
      if(a.resultscript){
        _domActionTask._exeResultScript({
          failedAction:r._type<=2?a:0,
          status:r._type==2?"failed":r._type<2?"error":"success"
        },r)
      }

      let v=(r._type<=1?a.refOfError||"..":r._type==2?a.refOfFailed||"..":a.refOfSuccess||".").replace(/[\/]$/,"").split("/")
      if(v.includes("s")){
        r._type=4
      }else if(v.includes("w")){
        r._type=3
      }else if(v.includes("f")){
        r._type=2
      }else if(v.includes("e")){
        r._type=1
      }
      if(!_result){
        _result=_Util._clone(r)
        _result._resultList=[]
      }else if(_result._type>r._type){
        _result._type=r._type
      }
      if(r!=_result){
        _result._resultList.push(r)
        if(!_result._failedAction&&r._type<=2){
          _result._failedAction=a
        }
      }
      
      return v
    }

    function _chkEndGroup(){
      var ga=_curGroup
      window._tmpGroupLoopData=window._tmpGroupLoopData||{}
      let k=_tmpLoopDatahandler._getActionKey(ga)
      if(_tmpGroupLoopData[k]){
        if(_tmpGroupLoopData[k]&&_tmpGroupLoopData[k].d){
          if(_tmpGroupLoopData[k].d.constructor==Number){
            $group=_tmpGroupLoopData[k].i++
            if($group>=_tmpGroupLoopData[k].d){
              _tmpGroupLoopData[k]=$group=undefined
              return 1
            }
          }else{
            $group=_tmpGroupLoopData[k].d[_tmpGroupLoopData[k].i++]
            if(!$group){
              _tmpGroupLoopData[k]=$group=undefined
              return 1
            }
          }
        }
      }else{
        return 1
      }
    }

    function _final(_inError,r){
      if(_inError){
        _result._msg=r._msg
      }
      if(!_curGroup){
        if(_inError){
          _doScreenshot(r)
        }else{
          _backFun(_result)
        }
        return 1
      }

      let v=_handleResult(_result,_curGroup)
      if(_inError){
        if(_inError.includes("..")&&_curGroup._tmp){
          if(_result._type>=3){
            _curGroup.refOfSuccess="../"
          }else if(_result._type==2){
            _curGroup.refOfFailed="../"
          }else{
            _curGroup.refOfError="../"
          }
        }
        if(!v.includes("s")&&!v.includes("w")&&_result._type<3){
          if(BZ.TW&&!BZ.TW.closed&&!r._data.apiReplaceEvent&&r._data.element){
            _doScreenshot(r,v,_inError)
            return 1
          }
          _backFun(_result)
          return 1
        }else{
          delete _result._failedAction
          delete _result._msg
          
          if(!_domActionTask._curOneActionList.length||(!v.includes(".")&&!_inError.includes("..."))){
            _backFun(_result)
            return 1
          }
        }
      }else {
        _backFun(_result)
        return 1
      }
      _curGroup=0
      $group=null
      ss=[]
    }
    
    function _doScreenshot(r,v,_inError){
      setTimeout(()=>{
        _screenshotHandler._generate(r,0,function(c){
          _result._imgData={
            file:c,
            name:r._data._path.replace(/[\/]/g,".").replace(/[\.]$/,"")
          };
  
          // console.log("BZ-LOG: debugger screenshot: "+_result._imgData.name)
          _result._stack=r._data._idx
          if(!v||(!v.includes(".")&&!v.includes("...")&&!_inError.includes("..."))){
            return _backFun(_result)
          }
          
          _curGroup=0
          $group=null
          ss=[]
          _result=r
  
          _doIt()
        })
      },1000)
    }
  },
  _isLoading:function(_fun){
    let s=_IDE._data._setting.content.loadingElement
    if(s){
      if(_Util._isFunction(s)){
        try{
          s=_eval._exeCode(s)

          if(s&&_eval._isFun(s)){
            return _end(_eval._exeFun(s))
          }

          return _end(s)
        }catch(e){
          alert(e.message)
          return
        }
      }else{
        s=$util.findDom(s)
        if(s&&!_Util._isHidden(s)){
          return _end(1)
        }
      }
    }
    s=$util.findDom(":bz($loading)")
    if(s&&!_Util._isHidden(s)){
      return _end(1)
    }
    return _end()
    function _end(r){
      if(r){
        if(_fun){
          setTimeout(()=>{
            _domActionTask._isLoading(_fun)
          },100)
        }
        return r
      }
      _fun&&_fun()
    }
  },
  _exeAction:function(_data,_setting,_backFun,_descDelay){
    BZ._data._uiSwitch._curLoadingAPIInfo=0
    
    _domActionTask._doLog("Exe Action ...")
    _domActionTask._reportAppInfo("Exe action "+_data.description)
    if(_domActionTask._isLoading()){
      console.log("Page in Loading ...")
      return setTimeout(()=>{
        _domActionTask._exeAction(_data,_setting,_backFun,_descDelay)
      },100)
    }
    if(_domActionTask._lastAction&&_domActionTask._lastAction!=_data&&_data._repeatOnExtensionComm){
      if(_domActionTask._lastAction._path==_data._path){
        return
      }
    }
    _data._repeatOnExtensionComm=0
    _domActionTask._lastAction=_data
    if(_data.asOneAction&&_data._oneActionList){
      return _domActionTask._exeOneActionList(_data,_setting,function(_result){
        localStorage.removeItem(_data._path)
        _result.$returnValue=window.$returnValue
        _result.exeTime=_data.exeTime
        delete window.$returnValue

        var d={$newElement:window.$newElement};
        //d["_tmpTaskDataMap"]=_ideDataManagement._tmpTaskDataMap
        d._tmpTaskDataMap=_ideDataManagement._tmpTaskDataMap

        _backFun(_result,d)
      },_descDelay)
    }
    var _fun,_orgData=_data._timestamp?_data:_data._orgData==_data||(_data._supData&&_data._orgData&&_data._supData==_data._orgData._supData)?_data._orgData:_Util._clone(_data),_result={};
    _TWHandler._setPlayMode(BZ._data._uiSwitch._testPlay._curMode)
    _TWHandler._takeoverWin(0,_data);
    if(!_data.apiReplaceEvent&&!_TWHandler._isTakeoverReady()&&BZ.TW&&!BZ.TW.closed){
      if(!_data._waitAjax){
        _data._waitAjax=Date.now()
      }
      if(Date.now()-_data._waitAjax<1000){
        return BZ._setTimeout(function(){
          _domActionTask._exeAction(_data,_setting,_backFun,_descDelay)
        },1)
      }
    }
    
    if(_backFun){
      _fun=function(r){
        _domActionTask._doLog("Send back result")
        r.exeTime=_data.exeTime
        if(_data.e){
          delete _data.e.bzTxtElement
        }
        r._img=_data._img
        if(bzTwComm._isExtension()){
          r._url=BZ.TW.location.href
        }
        if(_data.type!=4&&_tmpLoopDatahandler._handleActionLoopData(_data,r)){
          return setTimeout(()=>{
            _domActionTask._exeAction(_orgData,_setting,_backFun,_descDelay)
          },(BZ._getCurTest()&&BZ._getCurTest()._data.speed)||_orgData.min||50)
        }

        BZ._lastResult=r;
        r._errorPos=_domActionTask._errorPos;
        /**/
        //TODO: The code is for upgrade data
        if(_setting._updateWizard){
          r._newElement=_data._orgData.element;
          //r._newExpection=_data._orgData.expection;
          //r._newMd5=_data._orgData._newMd5;
        }
        /**/
        _ideDataManagement._tmpTaskDataMap._group=$group
        r.$returnValue=window.$returnValue
        _fun=0
        if(bzTwComm._isExtension()){
          r._newScriptList=$script.newList
          $script.newList=[]
        }
        _domActionTask._lastAction=0
        if(_backFun){
          let _finalFun=_backFun
          _backFun=0
          r._data=_data
          if(_data._takeScreenshot&&r._type<3){
            delete _data.e
            _data.element=["BZ.TW.document"]
            _domActionTask._doLog("Go to take screenshot")
            return _screenshotHandler._generate(r,0,function(v){
              r._canvas=v
              delete r._data.e
              _domActionTask._doLog("Send result 3")
              _finalFun&&_finalFun(r);
              _finalFun=0
            })
          }
          delete r._data.e
          _domActionTask._doLog("Send result 2")

          var d={$newElement:window.$newElement};
          //d["_tmpTaskDataMap"]=_ideDataManagement._tmpTaskDataMap
          d._tmpTaskDataMap=_ideDataManagement._tmpTaskDataMap

          _finalFun&&_finalFun(r,d);
          _finalFun=0
        }
      }
    }
    //Handle $group and $action 
    $group=_setting.$group;
    if(!BZ._isAutoRunning()&&_data._applyTmpData){
      _data._applyTmpData()
      $parameter=_aiAPI._preHandleParameter($parameter,0,_data._supData?_data._supData._supData:0)
    }
    if(_doApiRegister()){
      return
    }
    if((_data.type!=7||_data.asOneAction)&&!_tmpLoopDatahandler._initActionData(_data,_fun)){
      return
    }
    if(_doApiRegister()){
      return
    }

    if(_cssHandler._hasWaitingElement()){
      return BZ._setTimeout(function(){
        _domActionTask._exeAction(_data,_setting,_backFun,_descDelay)
      },100)
    }
    if(_data._code&&!_descDelay){
      return BZ._setTimeout(function(){
        _domActionTask._exeAction(_data,_setting,_backFun,1)
      },100)
    }
    var _force=_setting._force;
    _TWHandler._setPlayMode(_data._playMode)
    
    try{
      _tipHandler._removeAll();
      if(!_data._orgData){
        var a=_Util._clone(_data);
        a._orgData=_data;
        _data=a;
      }
      _domActionTask.TW=_setting.TW;
      //for cross-domain extension
      if(bzTwComm._isExtension()){
        _domActionTask.TW=window;
        BZ._prepareDocument();
      }
      window.$newElement=0
      
      _domActionTask._reportAppInfo("Prepare action: "+_data.description)
      if(!_domActionTask._prepareItem(_setting,_data,_result,_fun)){
        if(BZ._isAutoRunning()&&!_data._takeScreenshot){
          _screenshotHandler._getScreenshotInMd5(function(v){
            _Util._log("miss-element-screenshot-md5: "+v)
          })
        }
        // if(document.body._lastAction!=_data){
        //   _Util._log("Auto-retry on missing element of: "+_data.description)
        //   return setTimeout(()=>{
        //     document.body._lastAction=_data
        //     _domActionTask._exeAction(_data,_setting,_backFun,_descDelay)
        //   },1000)
        // }
        _domActionTask._reportAppInfo("Prepare action failed on: "+_data.description)
        if(_result._type==_taskInfo._type._notReady&&(!_domActionTask._notReadyTime||Date.now()-_domActionTask._notReadyTime<2000)){
          _domActionTask._notReadyTime=_domActionTask._notReadyTime||Date.now()
          return BZ._setTimeout(function(){
            _domActionTask._exeAction(_orgData,_setting,_backFun,_descDelay)
          },100)
        }
        _domActionTask._notReadyTime=0
        return //_fun&&_fun(_result)
      }else if(_data.type==1&&_data.e&&!_data.apiReplaceEvent&&_data.event&&_data.event.action=="click"){
        _domActionTask._reportAppInfo("clicked: "+_data.e.outerHTML.substring(0,300))
      }
      if(_data.e&&_data.type==0){
        _bzDomPicker._flashTmpCover(_data.e)
      }
      _domActionTask._reportAppInfo("After Prepare action: "+_data.e)

      _domActionTask._notReadyTime=0
      _result._data=_data;

      _waitData(function(){
        if(_apiHandler._isRequestAction(_data)){
          _result._type=4
          _result._msg=""
          _data.requests.forEach(r=>{
            _ideDataManagement._initRandomValue(r.body)
            _ideDataManagement._initRandomValue(r.headers)
          })
          if(_data.rampUp){
            $parameter.$result=[]
            return _domActionTask._exeRampUp(_data,function(r){
              _fun&&_fun(r)
            },1)
          }else if(_data.repeatTimes){
            $parameter.$result=[]
            return _domActionTask._exeLoad(_data,function(r){
              _fun(r)
            },0)
          }else{
            return _domActionTask._exeAPI(_data.requests,0,0,function(r){
              _fun(r)
            },_result)
          }
        }else if (!_force) {
          _waitOverWin()
        }else{
          _doIt(0)
        }
      })
    }catch(ex){
      _domActionTask._doLog("exeaction error: "+ex.message)
      BZ._log(ex.stack)
      if(_fun){
        _result._type=bzTwComm._isExtension()?_taskInfo._type._error:_taskInfo._type._crash;
        _result._msg=ex.message;
        _fun(_result)
      }
    }

    function _waitData(_fun){
      let d=[$parameter,$test,$module,$project,window.$action,window.$group]
      _chkData()
      function _chkData(){
        if(_hasWaitData(d)){
          return setTimeout(()=>{
            _chkData()
          },100)
        }
        _fun()
      }
    }

    function _hasWaitData(d,_fun){
      let _has;
      if(d&&_Util._isObjOrArray(d)){
        for(let k in d){
          let v=d[k]
          if(v&&v.constructor==Promise){
            if(!v._has){
              v.then(x=>{
                d[k]=x
                _hasWaitData(d,_fun)
              })
            }
            _has=1
          }else if(_Util._isObjOrArray(v)){
            _has=_has||_hasWaitData(v)
          }
        }
      }
      return _has
    }
    function _doApiRegister(){
      if(bzTwComm._isIDE()){
        if(!_aiAuthHandler._isAuthItem(BZ._getCurModule())){
          return (!_data.apiReplaceEvent||_apiDataHandler._hasWaitingData([window.$parameter,window.$group,window.$action]))&&_apiDataHandler._registerExeFun(()=>{
            _domActionTask._exeAction(_data,_setting,_backFun,_descDelay)
          },0,1,_data)
        }
      }
    }
    function _waitOverWin(){
      if(bzTwComm._isExtension()){
        BZ._setTimeout(function(){
          var w=window.$TW||window;
          if($(w.document).find("#bzOverrideMark").length){
            _doIt(0)
          }else{
            _TWHandler._takeoverWin(0,_data)
            _waitOverWin()
          }
        },10)
      }else{
        _doIt(0)
      }
    }
    
    function _doIt(_tryTime,_noCamera){
      if(_data.e&&BZ._hasVideo&&!_noCamera&&BZ.TW==window){
        return _domActionTask._takeScreenshot(_data,function(v){
          if(v&&v.length>100){
            _Util._log("video-img: "+v)
          }
          _doIt(_tryTime,1)
        })
      }else if(_data.e&&BZ._data._uiSwitch._testPlay._curMode=="_camera"&&!_noCamera&&!_data.cameraMd5&&!_data._camera&&!_data._inVisit&&!_data._inForm){
        if(_data.e){
          return _domActionTask._takeScreenshot(_data,function(){
            _doIt(_tryTime,1)
          })
        }
      }

      _domActionTask._taskQueue=_setting._taskQueue;
      
      var T=_ideActionData._type;
      var M=_ideActionData._method;
      try{
        //Ref
        if(_data.type==T._ref||_data.refCom){
          _result._type=_taskInfo._type._success;
          _result._goingCom=1
        //Validation
        }else if(_data.type==T._validation && _data.method==M._data){
          _result=_domActionTask._validateByData(_data,_setting,_force);
        //Extract data
        }else if(_data.type==T._extractData && _data.method==M._data){
          if(_data.api && _data.api.httpMethod=="GET" && _data.api.downloadAsFile){
            return _domActionTask._fetchFileDataFromURL(_data.api.httpURL,function(v){
              _domActionTask._setErrorPos(_result,"_script","_actionDetailsGeneral");
              _domActionTask._exeScript(_data.script,v,window.$element,function(){
                _fun&&_fun({_type:_taskInfo._type._success})
              });
            })
          }else{
            _result=_domActionTask._extractDataByData(_data,_setting);
            _domActionTask._setErrorPos(_result,"_script","_actionDetailsGeneral");
            _domActionTask._exeScript(_data.script,_result._extractData,window.$element,function(){
              if(!_result._extractData.data){
                _result._type=3
                _result._msg=_bzMessage._task._extractEmptyData
              }
            });
          }
        //Visit 
        }else if(_data.type==T._visit){
          _aiVisitHandler._start(_data)
          _result._type=_taskInfo._type._success;
          return BZ._setTimeout(function(){
            if(_fun){
              _fun(_result)
            }
          },100)
        //Group
        }else if(_data.type==T._group){
          _result._type=_taskInfo._type._success;
          if(!BZ._isAutoRunning()&&!bzTwComm._isExtension()){
            _ideActionGroup._switchGroupOpen(_data._orgData,true)
          }
          // if(_data.singleAction){
            // return _domActionTask._exeEventGroup(_data,_fun)
          // }
        //Script
        }else if(_data.type==T._script){
          _domActionTask._setErrorPos(_result,"_script","_actionDetailsGeneral");
          if(bzTwComm._isExtension()){
            _TWHandler._takeoverConsole(window)
          }
          return _domActionTask._doScript(_data,function(r){
            var _assertList=_TWHandler._takeAssertInfo();
            if(_assertList.length){
              r._type=_taskInfo._type._failed;
              
              r._msg=r._msg||"";
              _assertList.forEach(function(v){
                r._msg+=v+"\n"
              });
            }
            
            if(_fun){
              _fun(r)
            }
          });
        //validation Script
        }else if(_data.type==T._validation && _data.method==M._script&&_data.runInIDE){//script
          return _domActionTask._validateJs(_data,_fun);
        }else if(_data.type==T._refresh&&_data.refreshType){
          (_data.refreshData||[]).forEach(v=>{
            let mc=BZ._getCurModule()._data.code,
                tc=BZ._getCurTest()._data.code
            if(v.startsWith("$project")){
              $project=_ideDataManagement._tmpTaskDataMap._app[""]=$data(0,0,1)
            }else if(v.startsWith("$module")){
              $module=_ideDataManagement._tmpTaskDataMap._app[mc]=$data(mc,0,1)
            }else if(v.startsWith("$test")){
              $test=_ideDataManagement._tmpTaskDataMap._app[mc+tc]=$data(mc,tc,1)
            }
          })
        }else if(_data.type==T._refresh &&!_data.refreshType){
          let _url=_data.loadURL
          if(!_url){
            if(!BZ.TW||BZ.TW.closed){
              _url=_Util._mergeURL(_ideTestManagement._getCurHost(), _JSHandler._prepareData("/",0,2))
            }else{
              if(bzTwComm._isIDE()){
                _extensionComm._setCmd("location.reload()");
              }else{
                BZ.TW.location.reload()
              }
              _fun&&_fun({_type:_taskInfo._type._success})
              return
            }
          }
          return _TWHandler._openUrl(_url,function(_event){
            _event=_event||{}
            if(_event.error){
              if(_TWHandler._isIgnoreRequest(_event.url)){
                _event.error=0
              }else{
                if(_data!=_ideTask._setting._testingData){
                  return
                }
                if(_tryTime<3){
                  return BZ._setTimeout(function(){
                    _doIt(++_tryTime)
                  },3000)
                }
              }
            }
            BZ._twInError=_event.error?Number.MAX_SAFE_INTEGER:0
            var _txt=_event.error?_bzMessage._system._error._loadPageErr:_event.failed?_bzMessage._system._error._loadPageFailed:"";
            if(_txt){
              _txt=_Util._formatMessage(_txt,[_event.code||""])
              
              _txt+=_url
              BZ._log("BZ-LOG: exeAction:"+_txt)
            }else{
              _txt=_bzMessage._system._info._loadPageSuccess+_url
            }
            _ideTask._setDoNext({
              _type:_event.error?_taskInfo._type._crash:_event.failed?_taskInfo._type._failed:_taskInfo._type._success,
              _msg:_txt,
              _data:_data
            });
          });
        }else if(window.BZ && window.BZ._hasTestWindow()){
          //Refresh
          if(_data.type==T._refresh&&!_data.refreshType){
            _result._type=_taskInfo._type._success;
            _domActionTask.TW.document.body.innerHTML="";
            if(_data.clearLocalStorage){
              var _bzData=_domActionTask.TW.localStorage.getItem("bz-data");
              _domActionTask.TW.localStorage.clear();
              _domActionTask.TW.localStorage.setItem("bz-data",_bzData);
            }
            if(_data.clearCookie){
              $util.clearCookie(_domActionTask.TW.document);
            }
            if(_fun){
              _fun(_result);
            }
            _domActionTask.TW.location.reload();
            return
          //Validation html
          }else if(_data.type==T._validation && _data.method==M._html){
            if(_data.content.type=="screenshot"){
              return _domActionTask._validateScreenshot(_data,_force,_fun);
            }
            _result=_domActionTask._validateHtml(_data,_force);
          //validation Script
          }else if(_data.type==T._validation && _data.method==M._script){//script
            console.log("validation Script")
            return _domActionTask._validateJs(_data,_fun);
          //Extract data on html
          }else if(_data.type==T._extractData && _data.method==M._html){ //extract
            _result=_domActionTask._extractDataByHtml(_data);
            return _domActionTask._exeScript(_data.script,_result._extractData,window.$element,function(){
              _fun&&_fun(_result)
            });
          //event
          }else if(_data.type==T._triggerEvent){ //event
            var _change=null;
            if(_data.event.action=="dragdrop"){
              return _domActionTask._doDragdrop(_data,_fun)
            }else if(_data.event.action=="drag"){
              return _domActionTask._doDrag(_data,_fun)
            }
            return _domActionTask._trigger(_data,_fun);
          }else if (_data.type==T._comment) {
            _result=_domActionTask._doComment(_data);
          }
        //Refresh load page
        }else{
          _result._type=_taskInfo._type._crash;
          _result._errSou=_taskInfo._errSou._env;
          _result._msg=_bzMessage._system._error._missTestWindow;
        }
      }catch(e){
        _domActionTask._doLog("exeaction error: "+e.message)
        console.error(e.stack)
        _result._type=_taskInfo._type._error;
        if(_data.element && !window.$element){
          _result._errSou=_taskInfo._errSou._element;
          _result._msg=_bzMessage._system._error._missElement;
        }else{
          _result._msg=(e.stack||"").toString().split("\n")[0];
        }
        if(e.stack.includes("_exeScript")){
          _result._errSou=_taskInfo._errSou._script;
        }
      }
      _result._errorPos=_domActionTask._errorPos;
      if(_fun){
        _fun(_result);
      }
    }
  },
  // _pickBatchRequestData:function(d){
  //   let ds=[],v,rs=[]
  //   let r=d.requests,qs,us
  //   r.forEach(x=>{
  //     ds.push(..._debugDataHandler._retrieveBindDataFromAction(x))
  //   })
    
  //   ds=[...new Set(ds)]
    
  //   if(d._supData&&d._supData.definition){
  //     qs=d._supData.definition.query
  //     us=d._supData.definition.path
  //   }
    

  //   ds.forEach(x=>{
  //     try{
  //       eval("v="+x)
  //       if(v&&v.constructor==Array){
  //         let k=x.split(".").pop()
  //         if(!qs&&!us.length){
  //           rs.push({k:x,v:v})
  //         }else{
  //           if(qs&&qs.find(y=>{
  //               if(y.name==k){
  //                 if(!y.inArray){
  //                   rs.push({k:x,v:v})
  //                 }
  //                 return 1
  //               }
  //             })){
              
  //           }else if(us&&us.find(y=>{
  //               if(y.name==k){
  //                 if(!y.inArray){
  //                   rs.push({k:x,v:v})
  //                 }
  //                 return 1
  //               }
  //           })){
              
  //           }
  //         }
  //       }
  //     }catch(ex){}
  //   })
  //   return rs
  // },
  _exeLoad:function(d,_fun,i){
    i=i||0
    let t=d.period/d.repeatTimes
    if(i>=parseInt(d.repeatTimes)){
      return
    }

    if(!d._result){
      d._result={_type:4,_details:{},_start:Date.now()}
    }

    d._result._details[i]={i:i,_start:Date.now(),_data:[]}

    _domActionTask._exeAPI(d.requests,d.exeMethod!=1,0,function(r){
      // d._result._details[i]._result=r
      // d._result._details[i]._end=Date.now()
      
      if(d._result._type>r._type){
        d._result._type=r._type
      }
      // if(r._msg){
        // d._result._msg=d._result._msg||""
        // d._result._msg+=r._msg
      // }
      for(var n=0;n<d.repeatTimes;n++){
        if(!d._result._details[n]||!d._result._details[n]._end){
          return
        }
      }
      
      d._result._end=Date.now()
      _fun(d._result)
    },{idx:i,_details:d._result._details,_inLoadingTest:1})
    BZ._setTimeout(function(){
      _domActionTask._exeLoad(d,_fun,i+1)
    },t)
  },
  _exeRampUp:function(d,_fun,n){
    if(!d._result){
      d._result={
        _type:4,
        _details:{},
        _start:Date.now(),
        _runningRequests:0,
        _idx:-1,
        _max:0
      }
      n=1
    }
    
    if(n){
      n--
      d._result._runningRequests++
      if(d._result._runningRequests>d._result._max){
        d._result._max=d._result._runningRequests
      }
      d._result._idx++
      let i=d._result._idx
      
      d._result._details[i]={i:i,_start:Date.now(),_data:[]}
      _domActionTask._exeAPI(d.requests,1,0,function(r){
        if(d._result._type>r._type){
          d._result._type=r._type
        }
        d._result._runningRequests--
        BZ._clearTimeout(_domActionTask._nextRampTime)
        _lanuchRequest(_fun)
      },{idx:i,_details:d._result._details,_inLoadingTest:1})
    }
    let t=(Date.now()-d._result._start)/1000

    if(t<parseInt(d.rampUp.totalTime)){
      if(n>0){
        return BZ._setTimeout(()=>{
          _domActionTask._exeRampUp(d,_fun,n)
        },0)
      }
      _domActionTask._nextRampTime=BZ._setTimeout(()=>{
        _lanuchRequest(_fun)
      },1000)
    }else{
      _waitFinish(_fun)
    }
    
    function _lanuchRequest(_fun){
      if(!BZ._isPlaying()){
        return
      }
      t=(Date.now()-d._result._start)/1000
      if(t<parseInt(d.rampUp.totalTime)){
        if(d.rampUp.up>0){
          t=parseInt((t/d.rampUp.up)*d.rampUp.users)
        }else{
          t=d.rampUp.users
        }
        if(t>d.rampUp.users){
          t=d.rampUp.users
        }
        t-=d._result._runningRequests
        
        if(t){
          return _domActionTask._exeRampUp(d,_fun,t)
        }else{
          _domActionTask._nextRampTime=BZ._setTimeout(()=>{
            _lanuchRequest(_fun)
          },1000)
        }
      }else{
        _waitFinish(_fun)
      }
    }
    function _waitFinish(_fun,vs){
      BZ._clearTimeout(_domActionTask._waitFinishTime)
      if(!vs){
        vs=[]
        for(var k in d._result._details){
          if(!d._result._details[k]._end){
            vs.push(d._result._details[k])
          }
        }
      }else{
        _Util._spliceAll(vs,x=>{
          return x._end
        })
      }
      if(!vs.length){
        console.log("++++++++++++++++++++++++++++++++++++++++++++++++++++++")
        console.log("BZ-LOG: max: "+d._result._max)
        console.log("++++++++++++++++++++++++++++++++++++++++++++++++++++++")
        d._result._end=Date.now()
        _fun(d._result)
      }else{
        _domActionTask._waitFinishTime= BZ._setTimeout(()=>{
          _waitFinish(_fun,vs)
        })
      }
    }
  },
  _handleResponseData:function(v,_outputData){
    let _msg
    if(v&&v.constructor==Object){
      _msg=v.message
      console.log("BZ-LOG: API status: "+v.status)
      for(var k in v){
        let vv=v[k]
        if(vv&&vv.constructor==String){
          try{
            // if(_outputData){
            //   console.log("BZ-LOG: "+k)
            // }
            vv=_Util._strToJson(vv)
            if(vv&&[Array,Object].includes(vv.constructor)){
              _msg=_msg||vv.message
              // for(var kk in vv){
              //   let vvv=JSON.stringify(vv[kk])
              //   vvv=vvv.substring(0,100)+(vvv.length>100?" ...":"")
              //   if(_outputData){
              //     console.log("BZ-LOG:     "+kk+": "+vvv)
              //   }
              // }
            }else{
              // vv=(vv+"").substring(0,100)+(vv.length>100?" ...":"")
            }
          }catch(e){
            // vv=(vv+"").substring(0,100)+(vv.length>100?" ...":"")
          }
        }else{
          // if(_outputData){
          //   console.log("BZ-LOG: "+k+": "+vv)
          // }
        }
      }
    }
    return _msg
  },
  _exeAPI:function(aa,_async,i,_fun,_result){
    if(!BZ._isPlaying()){
      return
    }
    var a=_Util._clone(aa[i]),_returnData,
        _timerout
    if(a){
      let _proxy=_IDE._data._setting.advanced[a.host||0].apiProxy
      if(a.disable){
        return _domActionTask._exeAPI(aa,_async,i+1,_fun,_result)
      }
      _result._apiParameter=a
      _domActionTask._prepareRequest(a,_result);
      a.cache=false;
      if(_async){
        a.async=_async;
      }
      if(_apiHandler._isSocketRequest(a)){
        return _domActionTask._exeSocket(a,_result,function(){
          _domActionTask._exeAPI(aa,_async,i+1,_fun,_result)
        })
      }
      if(_result._details===undefined){
        _result._msg=_result._msg||""
        if(_result.idx===undefined){
          _result._msg+="\n"+"url: "+a.url
        }else{
          _result._msg+="\n"+(_result.idx+1)+". url: "+a.url
        }
        _result._start=Date.now()
      }else{
        _result._details[_result.idx]._curStart=Date.now()
      }
      
      a.complete=function(v){
        if(!_timerout){
          return
        }
        clearTimeout(_timerout)
        $result=v
        //Log API Response:
        let _msg=_domActionTask._handleResponseData(v,!_result._inLoadingTest)

        let _curDetails,_end=Date.now();

        v.idx=_result.idx;
        var r={_type:_Util._isAPISucessStatus(v.status)?4:1};

        
        _result._responseScriptResultData=_domActionTask._exeResponseScript(a,r,v)||0

        _result._type=r._type
        if(r._returnData){
          _result._returnData=_result._returnData||[]
          r._returnData._idx=a._idx
          r._returnData.actionResult=r._type
          _result._returnData[a._idx]=r._returnData
        }        

        if(_result._type>2&&[Object,Array].includes(_result._responseScriptResultData.constructor)&&!(a.responseScript&&a.responseScript.match(/\$aiAPI[.](add|updata|delete)Data/))){
          if(a.method=="DELETE"&&a.asStdFun){
            _aiAPI._deleteData($parameter,a._module)
          }else if(a.asStdFun){
            _aiAPI._updateData(_result._responseScriptResultData,a._module)
          }
        }
        
        let s=v.responseText||_msg||""
        
        if(!s&&v.data&&v.data.constructor==String){
          s=v.data
        }

        if(_result._details===undefined){
          
          _result._msg+="\n"+_bzMessage._common._status+": "+v.status+"\n"+_bzMessage._log._report._time+": "+(Date.now()-_result._start)
                      +"\n"+_bzMessage._api._responseSize+": "+s.length
                      +"\n"+_bzMessage._common._message+": "+s.substring(0,300)+(s.length>300?" ...":"")
          
        }else{
          _curDetails=_result._details[_result.idx]
          _curDetails._type=r._type
          // _curDetails._data.push({
          //   // _url:a.url,
          //   // _method:a.method,
          //   _end:_end,
          //   _start:_curDetails._curStart,
          //   _status:v.status,
          //   // _data:s.length,
          //   // _msg:r._type!=4?s:""
          // })
          delete _curDetails._data
          _setLoadingInfo(r)

        }
        _ideTask._addTmpDetails(r._type)
        if(r._type!=4){
          if(_result._details){
            _result._details[_result.idx]._end=Date.now()
          }
          _fun(_result)
        }else{
          _domActionTask._exeAPI(aa,_async,i+1,_fun,_result)
        }
      }

      //ignore testing on boozang host
      if(_ideLocation._ignoreHost.find(x=>{
        x=eval("/^(http|https)?:?[\/]*"+x+"/")
        return a.url.match(x)
      })){
        return alert("Not support")
      }
      _timerout=-1
      _Util._ajax(a,_proxy)

      _timerout=setTimeout(()=>{
        _result._type=1
        _result._msg="timeout"
        if(_result._details){
          _result._details[_result.idx]._end=Date.now()
          _result._details[_result.idx]._type=1
        }
        _fun(_result)
      },a.timeout||60000)
    }else{
      if(_result._details){
        _result._details[_result.idx]._end=Date.now()
      }
      _fun(_result)
    }

    function _setLoadingInfo(r){
      let l=BZ._data._uiSwitch._curLoadingAPIInfo
      if(!l){
        BZ._data._uiSwitch._curLoadingAPIInfo={_startTime:Date.now(),_success:0,_failed:0}
        l=BZ._data._uiSwitch._curLoadingAPIInfo
        let t=BZ._getCurTest()
        if(!t._curLoadingAPIInfo){
          t._curLoadingAPIInfo={}
        }
        t._curLoadingAPIInfo[t._data.actions.indexOf(BZ._getCurAction())]=l
      }
      
      if(r._type==4){
        l._success++
      }else{
        l._failed++
      }
    }
  },
  _exeResponseScript:function(d,r,_result){
    let $result=_result,dd,rr
    try{
      if(_result.data&&_result.data.constructor==String){
        eval("dd="+_result.data)
        if(dd.message){
          _result.message=dd.message
        }else if(_result.status>=400){
          _result.message=dd
        }
      }
      if(!_result.responseJSON){
        if(dd.responseJSON){
          _result.responseJSON=dd.responseJSON
        }
      }
      delete _result.data
    }catch(e){
      console.log(e.message)
      e.stack
    }
    try{
      var s=(d.responseScript||"").trim();
      if(s.match(/^\(function/)||s.match(/\(\(.*\)\s*\=\>/)){
        eval("rr="+s)
        r._type=rr||rr===undefined?4:2
        if(!rr||![Object,Array].includes(rr.constructor)){
          rr=0
        }
      }else{
        eval(s)
      }
    }catch(e){
      r._type=1
      r._errMsg=e.message+"\n"+e.stack
      r._msg+=e.message+"\nrequest response: "+_Util._getStringBySize($result.responseText,100)
    }
    if(!BZ._isAutoRunning()){
      try{
        r._returnData=$result
      }catch(e){}
    }
    return rr||_result.responseJSON
  },
  _exeSocket:function(r,_result,_fun){
    _domActionTask._websockets=_domActionTask._websockets||{};
    _domActionTask._socketBKFun=_fun;
    var _host=BZ._curEnv.items[r.host].host
    var w= _domActionTask._websockets[_host];
    if(!w){
      w=_domActionTask._websockets[r.url]=new WebSocket(_host);
      w.onmessage=function(d){
        $result=d
        d.responseText=d.data
        d=d.data;
        _domActionTask._exeResponseScript(r,_result)
        if(_result._type==2){
          var v=window._lastSocketData||""
          _result._msg="\n"+_bzMessage._task.UnMatch
          _result._msg+="\n"+_bzMessage._common._data+": "+v.substring(0,50)+(v.length>50?"... ("+v.length+")":"")
          _result._msg+="\n"+_bzMessage._diff._actual+": "+d.substring(0,50)+(d.length>50?"... ("+d.length+")":"")
        }
        _domActionTask._socketBKFun(_result)
      }
    }
    BZ._log("Socket Send out: "+r.data)
    window._lastSocketData=r.data
    _send()
    function _send(t){
      t=t||Date.now()
      if(w.readyState==1){
        w.send(r.data)
      }else if(w.readyState==3){
        w=_domActionTask._websockets[r.url]=new WebSocket(r.url);
        BZ._setTimeout(()=>{
          _send()
        },1000)
      }else if(Date.now()-t<3000||w.readyState==2){
        BZ._setTimeout(()=>{
          _send()
        },1)
      }else{
        _result._msg+=""
        _fun()
      }
    }
  },
  _validateByData:function(_data,_setting,_force){
    var _result=_domActionTask._extractDataByData(_data,_setting);
    if(_result._type==_taskInfo._type._error){
      return _result;
    }else{
      return _domActionTask._compareWithExpection(_data,_result._extractData,_force);
    }
  },
  _fetchMultipleFileDataFromURL:function(us,_fun,i,fs){
    i=i||0
    let u=us[i]
    fs=fs||[]
    if(u){
      _domActionTask._fetchFileDataFromURL(u,function(v){
        v.forEach(x=>fs.push(x))
        setTimeout(()=>{
          _domActionTask._fetchMultipleFileDataFromURL(us,_fun,i+1,fs)
        },1)
      })
    }else{
      _fun(fs)
    }
  },
  _fetchFileDataFromURL:function(uri,_fun) {
    try{
      let v=_eval._exeCode(uri)
      if(v.constructor==Array && v[0].base64Link){
        return _fun(v)
      }
    }catch(e){}
    if(extensionContent){
      bzTwComm._postToIDE({_scope:"_ideDataHandler",_fun:"_loadData",_args:[uri,"file",function(v){
        if(v && v.constructor==String){
          _ideDataHandler._loadData(uri,"file",_fun)
        }else{
          _fun(v)
        }
      }]})
    }else{
      _ideDataHandler._loadData(uri,"file",_fun)
    }
  },
  _postData:function(_data,_fun){
    if(bzTwComm._isIDE()){
      bzTwComm._postToExt({_fun:"_postData",_scope:"_domActionTask",_args:[_data,_fun]})
      return
    }
    if(_data.contentType&&_data.contentType.toLowerCase().includes("application/json")){
      _data.data=JSON.stringify(_data.data);
    }
    
    _data.success=function(v,r,rs){
      _fun({_result:"_success"})
    }
    _data.error=function(v,a,b){
      let _value=v.responseText?v.responseText.trim():v.statusText||"";
      _fun({_result:"_failed",_msg:_value})
    }
    $.ajax(_data)
  },
  _extractDataByData:function(_data,_setting){
    var _value=null;
    var _msg=null,_url=_Util._mergeURL(_setting._host,_data.api.httpURL||"/");
    BZ._log(_url)
    var _ajaxData={
      url:_url,
      type:_data.api.httpMethod,
      cache:false,
      async:false,
      success:function(v,r,rs){
        try{
          _value={status:rs.status,data:v};
          if(_data.type==_ideActionData._type._validation){
            _value=_CtrlDriver._sortJson(_doJsonIgnore(_value));
          }
          BZ._log(_value)
        }catch(e){
          BZ._log(e.stack)
        }
      },
      error:function(v,a,b){
        _value=v.responseText?v.responseText.trim():v.statusText||"";
      }
    };
    if(_data.api.contentType){
      _ajaxData.contentType=_data.api.contentType
    }
    if(_data.api.dataType){
      _ajaxData.dataType=_data.api.dataType
    }
    
    if(_data.api.downloadAsFile){
      
    }else{
      
    }
    function _doJsonIgnore(d){
      if(_data.content.type=="JSON"){
        var _ignore=_data.content.ignore
        if(_ignore){
          if(_ignore.attrs.status){
            delete d.status;
          }
          if(_ignore.attrs.data){
            delete d.data;
          }else if(_ignore.jsonKey || _ignore.jsonValue || _ignore.attrs.nullValue || _ignore.attrs.emptyValue){
            d.data=_domActionTask._getJsonAfterIgnore(d.data,_ignore.jsonKey,_ignore.jsonValue,_ignore.attrs.nullValue,_ignore.attrs.emptyValue);
          }
        }
      }
      return d;
    }
    if(_data.api.httpHeaders){
      if(_data.api.httpHeaders.constructor==String){
        try{
          eval("_ajaxData.headers="+_data.api.httpHeaders);
        }catch(e){
          alert(_bzMessage._system._dataFormat);
        }
      }else{
        _ajaxData.headers=_data.api.httpHeaders;
      }
    }
    if(_data.api.httpData){
      var ct=_data.api.contentType||""
      if(_data.api.httpData.constructor==String&&!ct.includes("application/json")){
        try{
          eval("_ajaxData.data="+_data.api.httpData);
        }catch(e){
          alert(_bzMessage._system._dataFormat);
        }
      }else{
        if(!ct.includes("application/json")&&_data.api.httpData.constructor!=String){
          _ajaxData.data=JSON.stringify(_data.api.httpData);
        }else{
          _ajaxData.data=_data.api.httpData;
        }
      }
    }
    $.ajax(_ajaxData);
    return {_type:_taskInfo._type._success,_extractData:_value};
  },
  _doScript:function(d,_fun){
    var $element;
    if(d.element){
      _domActionTask._setErrorPos({},"_element","_actionDetailsGeneral");
      $element = _domActionTask._findElement(d);
    }

    _domActionTask._setErrorPos({},"_script","_actionDetailsGeneral");
    if(d._tmpEndAction||d.endGroup){
      return _doIt()
    }
    _domActionTask._exeScript(d.script,null,$element,function(_back){
      if(_back&&_back.constructor==Function){
        _back(_doIt)
      }else{
        _doIt()
      }
    });
    function _doIt(w){
      if(bzTwComm._isIDE()){
        _apiDataHandler._registerExeFun(()=>{
          _final(w)
        },0,0,d)
      }else{
        _final(w)
      }
    }
    
    function _final(w){
      _ideDataManagement._tmpTaskDataMap._parameter[BZ._getCurModule()._data.code+BZ._getCurTest()._data.code]=$parameter
      if(_fun){
        let c=$util._canvas
        delete $util._canvas
        if(c){
          c={
            file:c
          }
        }
        _fun({_type:_taskInfo._type._success,_msg:w,_imgData:c})
      }
    }
  },
  _exeScript:function(c,$result,$element,_fun){
    let r={}
    if(c){
      window.$result=$result
      window.$element=$element
      c=_Util._parseToExeCode(c)
      console.log("_exeScript-2: "+c)
      c=_Util._eval(c)
      _fun(c)
    }
  },
  _validateScreenshot:function(_data,_force,_fun){
    var _result={
      _type:_taskInfo._type._failed
    }
    var _element=_data.element;
    _domActionTask._setErrorPos({},"_element","_actionDetailsGeneral");
    var _dom=_domActionTask._findElement(_data);
    var c=_data.content;
    var co=_data._orgData.content;
    c.left=co.left=co.left||0;
    c.right=co.right=co.right||0;
    c.top=co.top=co.top||0;
    c.bottom=co.bottom=co.bottom||0;
    
    _screenshotHandler._elementImgMd5(_dom,c,function(v){
      if(v && v.constructor==String){
        _result = _domActionTask._compareWithExpection(_data,v,_force);
      }else{
        _result._type=_taskInfo._type._error
        _result._msg=v.message;
      }
      _result._data=_data;
      _result._errorPos=_domActionTask._errorPos;
      if(_fun){
        _fun(_result)
      }
    });
  },
  _takeScreenshot:function(o,_fun){
    let ee=document.body;
    if(o){
      o.e=_domActionTask._findElement(o)
      if(o.e){
        ee=_Util._findTextElement(o.e)
      }else{
        o.e=ee
      }
    }else{
      o={e:ee}
    }
    _screenshotHandler._getElementAreaImg(ee,o.e,function(c) {
      o._img=c
      _bzDomPicker._removeTmpCover();
      _fun(c)
    });
  },
  //Validation action
  _compareWithExpection:function(d,v,_force){
    if(v && $.type(v)!="object" && $.type(v)!="string"){
      v=JSON.stringify(v,0,2);
    }
    var _result={};
    var _bRebuild=false;
    var _bNumber=false;
    var _org=v;
    if(v && v.constructor==String){
      v=v.replace(/\r\n/g,"\n");
    }
    var v1="";
    
    if (d.expection==undefined || d.expection==null || d.expection==""){
      v1="";
    }else{
      v1=(d.expection+"").replace(/\r\n/g,"\n");
    }
    if (d.md5 && !d.expection) {
      v=_calcMD5(v);
      v1=d.md5;
    }else if (_Util._isNumber(d.expection)) {
      v1=parseFloat(d.expection);
    }else{
      v=_compressJSON._convertToEntities(v);
      v1=_compressJSON._convertToEntities(v1);
    }

    var bOk=false;
    var _exe=null;
    v=(v+"").replace(/[\r\n]/g," ").replace(/\s+/g," ")
    v1=(v1+"").replace(/[\r\n]/g," ").replace(/\s+/g," ")
    
    //v: actual, v1: expection
    if(d.content&&["enable","disable","checked"].includes(d.content.type)){
      v=Boolean(v==0||v=="false"?false:v)
      v1=Boolean(v1==0||v1=="false"?false:v1)
      bOk=v==v1
    }else if(d.compareMark=="include"){
      bOk=v.includes(v1)
    }else if(d.compareMark=="exclude"){
      bOk!=v.includes(v1)
    }else if (d.compareMark!="regex") {
      if(d.compareMark=="=="){
        bOk=v==v1
      }else if(d.compareMark=="<="){
        bOk=v<=v1
      }else if(d.compareMark==">="){
        bOk=v>=v1
      }else if(d.compareMark=="<"){
        bOk=v<v1
      }else if(d.compareMark==">"){
        bOk=v>v1
      }else if(d.compareMark=="!="){
        bOk=v!=v1
      }
    }else if(_Util._isRegexData(v1)){
      bOk=Boolean(v.match(new Regex(v1)))
    }else{
      bOk=Boolean(v.match(v1))
    }

    if(!bOk){
      d._actual=_org;
      if(_force){
        if (d._orgData.expection===undefined || d===null || d===""){
          _bRebuild=true;
        }else{
          _bRebuild=true;
        }
      }
      if(_bRebuild){
        d._orgData.expection=_org;
        d._orgData.md5="";
        _result._type=_taskInfo._type._warning;
        _result._msg="_replaceExpection";
        _result._data=d;
      }else{
        _result._type=_taskInfo._type._failed;

        _result._msg=_bzMessage._task.UnMatch+": "+v1;
        _result._errSou=_taskInfo._errSou._exp;
        _result._newData=_org;
        if((d._orgData.expection||"").includes("{{")){
          _result._orgRealValue=v1;
        }
      }
    }else{
      _result._type=_taskInfo._type._success;
    }
    
    return _result;
  },
  _validateHtml:function(_data,_force){
    var _result=_domActionTask._extractDataByHtml(_data);
    for(var i=0;i<_domActionTask._taskQueue.length;i++){
      var t=_domActionTask._taskQueue[i];
      if(t.type==_ideActionData._type._triggerEvent && t.element){
        var e=_JSHandler._prepareData(t.element)
        t=_domActionTask._findElement(t);
        if(t){
          $util.triggerMouseEvent(t,"mouseover");
          $util.triggerMouseEvent(t,"mousemove");
        }
        break;
      }
    }
    if(_result._type==_taskInfo._type._success){
      if(!["exist","unexist","dnexist"].includes(_data.content.type)){
        if(_data.content.type=="data"){
          BZ._log("Validate data ......")
          _result = _domActionTask._compareWithDataExpection(_data,_result._extractData,_force);
          BZ._log(_result)
        }else{
          _result = _domActionTask._compareWithExpection(_data,_result._extractData,_force);
        }
        if(_result._type==_taskInfo._type._failed && _data._preDom && !_data._preDom._changed){
          _result._type=_taskInfo._type._notReady;
        }else{
          delete _data._preDom;
        }
      }else if(_data.content.type=="unexist"){
        _result._type=_taskInfo._type._failed
        _result._msg=_bzMessage._system._error._existError
      }
    }else if(_data.content.type=="unexist"){
      _result._type=_taskInfo._type._success
    }
    return _result;
  },
  _validateJs:function(_data,_fun,$parameter,$test,$module,$loop){
    $parameter=$parameter||window.$parameter
    $test=$test||window.$test
    $module=$module||window.$module
    $loop=$loop||window.$loop
    
    _domActionTask._extractDataByJs(_data,function(_result){
      if(_result._type==_taskInfo._type._success){
        if(!_result._extractData){
          _result._type=_taskInfo._type._failed
        }else if(_result._extractData=="bz-stop"){
          _result._bzStop=1
        }
      }
      return _fun(_result);
    },$parameter,$test,$module,$loop);
  },
  _extractDataByHtml:function(_data){
    var _element=_data.element;
    _domActionTask._setErrorPos({},"_element","_actionDetailsGeneral");
    var _dom=_domActionTask._findElement(_data);
    if(_dom){
      if(_data.type!=_ideActionData._type._extractData){
        var _content = null;
        var _cType=_data.content.type;
        if(["exist","unexist","dnexist"].includes(_cType)){
        }else if(_cType=="innerText"){
          _content=_Util._formatInnerText($util.getElementText(_dom,1));
          
          if(_data.content.preFormat){
            try{
              _content=_content.replace(new RegExp(_data.content.preFormat),_data.content.replace)
            }catch(e){
              if(!BZ._isAutoRunning()){
                alert(e.message)
              }
            }
            BZ._log("af"+"ter pr"+"eFormat")
            BZ._log(_content)
          }
        }else if(_cType=="value"){
          if(_dom.tagName=="SELECT"){
            _content=""
            for(var i=0;i<_dom.selectedOptions.length;i++){
              if(_content){
                _content+="\n"
              }
              _content+=_dom.selectedOptions[i].text
            }
          }else if(_dom.tagName=="INPUT"&&_dom.type=="checkbox"){
            _content=_dom.checked?"on":"off"
          }else{
            _content=_dom.value
          }
        }else if(_cType=="enable"){
          _content=!(_dom.disabled||$(_dom).attr("disabled")||"")
        }else if(_cType=="disable"){
          _content=(_dom.disabled||$(_dom).attr("disabled")||"")+""
        }else if(_cType=="checked"){
          _content=_dom.checked||$(_dom).attr("checked")||""
        }else if(_cType=="data"){
          _content=_dom;
        }
/*
        if(!["exist","unexist","dnexist"].includes(_cType)){
          _content=_domActionTask._maskContent(_content);
        }
*/
        if(_data._preDom){
          _data._preDom._changed=_calcMD5(_dom.outerHTML)!=_data._preDom.html
        }
      }else{
        _content=window.$element
      }
      BZ._log("ex"+"trac"+"tDat"+"aByH"+"tml")
      BZ._log(_content)
      return {
        _type:_taskInfo._type._success,
        _extractData:_content
      };
    }else{
      return {
        _type:_taskInfo._type._error,
        _msg:_bzMessage._system._error._missElement,
        _errSou:_taskInfo._errSou._element
      };
    }
  },
  _doDrag:function(d,_fun){
    let x=parseFloat(d.event.x||0),
        y=parseFloat(d.event.y||0),
        x2=parseFloat(d.event.moveToX||0),
        y2=parseFloat(d.event.moveToY||0);
    var tr=new DataTransfer(),te,
        _dom=_domActionTask._findElement(d);

    var _result={_type:_taskInfo._type._failed}
    
    var ps=[{_action:"mousedown", x:x, y:y}];
    let t=10,
        xs=(x2-x)/t,
        ys=(y2-y)/t;
    for(var i=0;i<t;i++){
      let xx=x+xs*i,
          yy=y+ys*i
      
      ps.push({_action:"mousemove", x:xx, y:yy})
    }
    ps.push({_action:"mousemove", x:x2, y:y2});
    ps.push({_action:"mouseup", x:x2, y:y2});
    _exeMouseGroup()
    
    function _exeMouseGroup(){
      var p=ps.shift()
      if(p){
        BZ._setTimeout(function(){
          $util.triggerMouseEvent(_dom,p._action,d.event.button,p.x,p.y,d.event.ctrl,d.event.alt,d.event.shift,tr);
          _exeMouseGroup()
        },100);
      }else{
        _fun({_type:_taskInfo._type._success,_errorPos:_domActionTask._errorPos})
      }
    }
  },
  _doDragdrop:function(d,_fun){
    var x=parseFloat(d.event.x||1),y=parseFloat(d.event.y||1);
    var tr=new DataTransfer(),te,r;

    var _result={_type:_taskInfo._type._failed}
    if(x>=0 && y>=0){
      var _element=d.element;
      _domActionTask._setErrorPos({},"_element","_actionDetailsGeneral");
      var _dom=_domActionTask._findElement(d),_dom2;
      if(d.event.element && d.event.element.length){
        let _lastTxtElement=_dom.bzTxtElement
        
        _dom2=_domActionTask._findElement(d.event);
        if(_dom2.tagName=="CANVAS"&&_dom2.bzTxtElement){
          r=_dom2.getBoundingClientRect()
          te=_dom2.bzTxtElement
          x=r.left+te.x+te.w/2
          y=r.top+te.y+te.h/2

          if(d.event.offset){
            var xy = _Util._getDomXY(_dom2);
            let aa={
              x:parseFloat(xy.x)+_dom2.bzTxtElement.x,
              y:parseFloat(xy.y)+_dom2.bzTxtElement.y,
              h:_dom2.bzTxtElement.h,
              w:_dom2.bzTxtElement.w
            }
            let _offset=_bzDomPicker._getOffsetPoint(aa,d.event.offset)
            x=_offset.x
            y=_offset.y
          }


          if(_lastTxtElement&&_dom==_dom2){
            _dom.bzTxtElement=_lastTxtElement
          }
        }
      }
      if(!_dom2){
        _dom2=_Util._getElementByXY(_dom.ownerDocument.body,d.event.x,d.event.y)
      }
      var xy=_Util._getDomXY(_dom);
      var _rect=_dom.getBoundingClientRect();
      if(_dom.tagName=="CANVAS"&&_dom.bzTxtElement){
        te=_dom.bzTxtElement;

        xy.x=_rect.left+te.x+te.w/2
        xy.y=_rect.top+te.y+te.h/2
      }else{
        xy.x+=parseInt(_rect.width/2);
        xy.y+=parseInt(_rect.height/2);
      }
      var t=10;
      var xs=parseInt((x-xy.x)/t);
      var ys=parseInt((y-xy.y)/t);

      var ps=[{_action:"mousedown", x:xy.x, y:xy.y}];
      
      // if(_dom.tagName=="CANVAS"&&_dom.bzTxtElement){
        // ps=[{_action:"mousedown", x:-1, y:-1}];
      // }
      
      ps.push({_action:"dragstart", x:xy.x, y:xy.y,tr:tr});
      ps.push({_action:"drag", x:xy.x, y:xy.y,tr:tr});
      
      for(var i=0;i<t;i++){
        let xx=xy.x+=xs,
            yy=xy.y+=ys
        
        if(r&&r.left<xx&&r.right>xx&&r.top<yy&&r.bottom>yy){
          ps.push({_action:"mousemove", x:xx, y:yy,_dom:_dom2})
        }else{
          ps.push({_action:"mousemove", x:xx, y:yy})
        }
      }

      ps.push({_action:"mousemove", x:x, y:y,_dom:_dom2});
      ps.push({_action:"dragenter", x:x, y:y,_dom:_dom2,tr:tr});
      ps.push({_action:"dragover", x:x, y:y,_dom:_dom2,tr:tr});
      ps.push({_action:"mouseup", x:x, y:y,_dom:_dom2});
      ps.push({_action:"drop", x:x, y:y,_dom:_dom2,tr:tr});
      ps.push({_action:"dragend", x:x, y:y,tr:tr});
      _exeMouseGroup()
      
      function _exeMouseGroup(){
        if(ps.length){
          var p=ps.shift()
          BZ._setTimeout(function(){
            $util.triggerMouseEvent(p._dom||_dom,p._action,d.event.button,p.x,p.y,d.event.ctrl,d.event.alt,d.event.shift,p.tr);
            _exeMouseGroup()
          },100);
        }else{
          _fun({_type:_taskInfo._type._success,_errorPos:_domActionTask._errorPos})
        }
      }
    }else{
      _domActionTask._setErrorPos({},"xy","_actionDetailsGeneral");
      _result._errorPos=_domActionTask._errorPos;
      _fun(_result)
    }
  },
  //Trigger event action
  _trigger:function(d,_fun){
    if(d.type==1){//event only
      _domActionTask._prepareValidation();
    }
    var _result={_type:_taskInfo._type._success},dd;
    try{
      dd=d.event.alerts||(d.event.popType?[{
        popType:d.event.popType,
        expection:d.expection,
        returnValue:d.event.returnValue,
        popFollow:d.event.popFollow
      }]:0)
      if(dd){
        _TWHandler._popExpected.alert=[]
        _TWHandler._popExpected.confirm=[]
        _TWHandler._popExpected.prompt=[]
        dd.forEach(ddd=>{
          _TWHandler._popExpected[ddd.popType].push({
            expection:ddd.expection,
            returnValue:ddd.returnValue,
            popFollow:ddd.popFollow
          });
        })
      }
      
      _domActionTask._setErrorPos(_result,"_element","_actionDetailsGeneral");
      var dom=_domActionTask._findElement(d);
      
      if(["BUTTON","INPUT","TEXTAREA","SELECT"].includes(dom.tagName)){
        if(dom.disabled){
          _result._type=_taskInfo._type._error
          _result._msg=_bzMessage._system._error._disableElement
          _result._errSou=_taskInfo._errSou._element;
          if(_fun){
            _fun(_result)
          }
          return
        }
      }

      var _eType=d.event.type;
      var _action=d.event.action;
      //keypress
      if (_eType=="key") {
        if(d.event.groupKeys){
          return _triggerKeyGroup(dom,d.event.groupKeys,0)
        }else if(_action=="group"){
          return $util.triggerKeyEvents(dom,d.event.keyCode,d.event.charCode,d.event.ctrl,d.event.alt,d.event.shift,_doAfterKeyEvent);
        }else{
          $util.triggerKeyEvent(dom,_action,d.event.keyCode,d.event.charCode,d.event.ctrl,d.event.alt,d.event.shift);
        }
        if(_Util._isStdInputElement(dom) && (d.event.char || d.event.groupKeys) && _action=="group"){
          $util.triggerChangeEvent(dom,$(dom).val(),1,_result,0,0,0,1)
        }
      //mouse (click)
      }else if (_eType=="mouse") {
        _domActionTask._preCkRepElement(d,_result)

        if(_result._type!=_taskInfo._type._error){
          _Util._removeLinkTarget(dom);
          if(["group","click"].includes(_action) && d.event.button!=2){
            return $util.triggerMouseEvents(dom,parseInt(d.event.button)||1,d.event.x,d.event.y,d.event.ctrl,d.event.alt,d.event.shift,function(){
              if(!_checkPop()){
                return
              }
              if(d._reTrigger){
                return _fun(_result)
              }
              return _exeRepElementAction(d,_result,_fun)
            });
          }else if(_action=="DOMMouseScroll"){
            $util.triggerWheelEvent(dom,d.event.y);
          }else if(_action=="dblclick"){
            $util.triggerDblClickEvents(dom,parseInt(d.event.button)||1,d.event.x,d.event.y,d.event.ctrl,d.event.alt,d.event.shift);
            return _exeRepElementAction(d,_result,_fun)
          }else{
            return $util.triggerMouseEvent(dom,_action,d.event.button,d.event.x,d.event.y,d.event.ctrl,d.event.alt,d.event.shift,0,function(){
              return _exeRepElementAction(d,_result,_fun)
            });
          }
        }
      //change
      }else if(_eType=="change"){
        var v=(d.event.value||"")
        if(v.constructor!=Array){
          v+=""
        }
        if(["bz-skip-group"].includes(v)){
          _result._bzSkipGroup=1
          if(_fun){
            _fun(_result)
          }
          return;
        }else if(["bz-skip"].includes(v)){
          _result._bzSkip=1
          if(_fun){
            _fun(_result)
          }
          return;
        }else if(v=="bz-stop"){
          _result._bzStop=1
          if(_fun){
            _fun(_result)
          }
          return;
        }
        if(!d._customize&&_domActionTask._isCustomizeAction(d)){
          return _domActionTask._exeCustomizeAction(d,_result,_fun)
        }else if(dom.type=="radio"){
          try{
            if(v.startsWith("/{random")){
              dom=$util.randomItem($("input[name='"+dom.name.replace(/'/g,"\\'")+"']").toArray()).value
              v=dom.value
              _domActionTask._setRandomValueToVariable(v,d)
            }else{
              dom=$("input[name='"+dom.name.replace(/'/g,"\\'")+"'][value='"+v.replace(/'/g,"\\'")+"']")[0]||dom
            }
          }catch(e){}
          $util.triggerMouseEvents(dom,1,0,0,0,0,0);

        }else if (dom.type && dom.type=="checkbox") {
          if((!d.event.value||d.event.value=='off'||d.event.value=="false") != !dom.checked){
            $util.triggerMouseEvents(dom,1,0,0,0,0,0);
          }
        }else if(_cssHandler._isNatureCustomizeInput(dom)){
          /**********************************/
          //set value on customize dropdown 
          /**********************************/
          return _domActionTask._exeSetValueOnUnInput(d,dom,function(v){
            _result._type=v
            _fun(_result)
          })
        }else{
          try{
            if(dom.tagName=="INPUT" && dom.type=="file" && bzTwComm._isExtension()){
              if(v && v.constructor==String){
                if(v.match(/^[\/]?example\..+$/)){
                  v=SERVER_HOST+"/file/"+v.replace("/","")
                }
                _domActionTask._fetchFileDataFromURL(v,function(v){
                  _setFileFun(d,dom,v,_fun)
                })
              }else if(v&&v.constructor==Array&&v[0]&&v[0].constructor==String){
                _domActionTask._fetchMultipleFileDataFromURL(v,function(v){
                  _setFileFun(d,dom,v,_fun)
                })
              }else{
                _setFileFun(d,dom,v,_fun)
              }
              return
            }else if(v.constructor==Array&&dom.tagName=="SELECT"){
              for(let k of dom.options){
                if(v.includes(k.text)){
                  $(k).prop("selected",true)
                }else{
                  $(k).prop("selected",false)
                }
              }
            }else if(v.startsWith("/{random")&&dom.tagName=="SELECT"){
              let vs=[],e=v.split(":")[1],f,os
              if(e){
                e=e.split("|")
                f=e[0]
                e=e[1]
                if(e){
                  if(e.endsWith("}/")){
                    e=e.substring(0,e.length-2).split(",")
                  }
                }
              }
              if(f&&f[0]=="!"){
                f=f.substring(1)
                if(f.endsWith("}/")){
                  f=f.substring(0,f.length-2)
                }
                os=$(dom).find("*").not(f).toArray()
              }else{
                os=$(dom).find(f||"option").toArray()
              }
              
              for(var i =0;i<os.length;i++){
                let x=os[i].text
                if(x&&(!e||!e.includes(x))){
                  vs.push(x)
                }
              }
              v=$util.randomItem(vs).value
              _domActionTask._setRandomValueToVariable(v,d)
            }
            return $util.triggerChangeEvent(dom,v,d.event.autoBlur,_result,d.withEntry,d.withSubmit,function(){
              _doAfterKeyEvent()
            },d.disableAISet);
          }catch(ex){
            //DO NOT REMOVE!!!!
            //Sometime trigger customer key event error
            console.log(e.stack)
          }
        }
      }
      if(!_checkPop()){
        return
      }
    }catch(e){
      _result._type=_taskInfo._type._error;
      _result._msg=_bzMessage._system._error._missElement;
      _result._errSou=_taskInfo._errSou._element;
    }
    if(_fun){
      _fun(_result)
    }
    
    function _exeRepElementAction(d,_result,_fun){
      return _domActionTask._ckRepElement1(d,_result,function(){
        if(_fun){
          _fun(_result)
        }
      })
    }
    function _setFileFun(d,dom,v,_fun){
      var p=_Util._getQuickPath(dom)
      return BZ._setTimeout(function(){
        $util.triggerChangeEvent(dom,v,d.event.autoBlur);
        if(_fun){
          BZ._setTimeout(()=>{
            _fun(_result)
          },1000)
        }
      },100)
    }
    function _triggerKeyGroup(dom,s,i){
      if(i>=s.length){
        return _doAfterKeyEvent()
      }
      var c=s[i].charCodeAt(0),k;
      if(c==10){
        k=13;
      }else{
        k=c-32;
      }
      $util.triggerKeyEvents(dom,k,c,false,false,false,function(){
        _triggerKeyGroup(dom,s,i+1)
      });
    }
    function _doAfterKeyEvent(){
      if(_Util._isStdInputElement(dom) && (d.event.char || d.event.groupKeys) && _action=="group"){
        $util.triggerChangeEvent(dom,$(dom).val(),1,_result,0,0,0,1)
      }
      if(!_checkPop()){
        return
      }
      if(_fun){
        _fun(_result)
      }
    }
    function _checkPop(){
      if(!_IDE._data._curVersion.setting.content.ignorePopValidation){
        var _popAction=localStorage.getItem("BZ-Action-pop");
        if(!_popAction){
          var _msgObj = _TWHandler._chkPopInfo(d);
          if(_msgObj && _msgObj=="wait"){
            localStorage.setItem("BZ-Action-pop",_result)
            return _recheck(0)
            
            function _recheck(i){
              BZ._setTimeout(function(){
                _msgObj = _TWHandler._chkPopInfo(d,i==100?1:0);
                if(_msgObj && _msgObj=="wait" && i<100){
                  return _recheck(++i);
                }else if(_msgObj){
                  _setPopResult(_msgObj);
                }
                _fun(_result)
              },100);
            }
          }else if(_msgObj){
            localStorage.setItem("BZ-Action-pop",_result)
            _setPopResult(_msgObj);
          }
          function _setPopResult(_msgObj){
            _result._type=_taskInfo._type._failed;
            _result._msg=_msgObj;
            _result._missingPopMsg=true;
            _result._errSou=_taskInfo._errSou._element;
            localStorage.removeItem("BZ-Action-pop");
          }
        }else{
          localStorage.removeItem("BZ-Action-pop");
        }
      }
      return 1
    }
  },
  _getActionExpectReactionTime:function(a){
    return parseInt(a.max||((_IDE._data._setting.advanced[a._supData?a._supData.hostId||0:0]||{}).expectReactionTime)||2000);
  },
  /**********************************/
  //set value on customize dropdown 
  //a: action, e: element
  /**********************************/
  _exeSetValueOnUnInput:function(a,e,_bkFun,_ignoreForce){
    let _curInputDom=e
    _domActionTask._doLog("Auto set uninput value on: "+e.outerHTML)
    if(!_ignoreForce){
      let _focus=$(":focus")[0]
      if(_focus){
        return $util.triggerBlurEvent(_focus,function(){
          setTimeout(()=>{
            _domActionTask._exeSetValueOnUnInput(a,e,_bkFun,1)
          },10)
        })
      }
    }
    
    _Util._preTriggerEvent()

    let _values=_Util._clone(a.event.value),
        _value=a.event.value,//current value
        rs,//request
        // cs,//UI exist item;
        _times,
        _valueIdx=0,
        _newElements=[],
        _preValue=_Util._toTrimSign(_cssHandler._getElementScope(e).innerText),
        _start=Date.now(),
        _period=_domActionTask._getActionExpectReactionTime(a)

    if(_values.constructor!=Array){
      _values=[a.event.value]
    }

    if(_selectOption(e,_values,function(r){
      return _bkFun(r)
    })){
      return
    }
    if(_selectMultip(e,_values,a)){
      return _bkFun(4)
    }

    // _prepareValues()
    let _elementList=_getElementList(e)
        // _observer=_buildObserver();

    if(e&&e.innerText==a.event.value){
      _Util._log("Exe Click of no-input")
      return _exeClick(e,0,function(){
        BZ._setTimeout(()=>{
          _newElements=_Util._getDiffAfterTriggerEvent(1,1);
          if(_newElements.length){
            _findTarget(0,_doIt)
          }else{
            _bkFun(4)
          }
        },100)
      })
    }

    _doIt()
    
    function _selectOption(e,_options,_fun){
      let os=_cssHandler._getOptionElementByBZFlag(e)||_cssHandler._isList(e,1),
          r=4
      if(os){
        _options.find((x,i)=>{
          if(x=="/{random}/"){
            if(a._requestErgodicDom&&!a._requestErgodicDom._ergodicValueList){
              d._ergodicValueList=os
            }else{
              _Util._randomList(os)
            }
            x=os[0]
          }
          if(!os.find((o,j)=>{
            if(o==x||o.innerText.toLowerCase()==x.toLowerCase()){
              _exeClick(o)
              os.splice(j,1)
              return 1
            }
          })){
            r=1
            return 1
          }
        })
        _fun(r)
        return 1
      }
    }

    function _doIt(){
      _value=_values[_valueIdx]
      _TWHandler._curRequestList.length=0
      _times=0
      if(_value){
        if(!_valueIdx){
          // cs=$(":equal("+_value+")").toArray(),
          // _Util._spliceAll(cs,c=>{
            // return _Util._isHidden(c)
          // })
          _exe(_elementList,0)
        }else{
          // cs=[]
          BZ._setTimeout(()=>{
            _findTarget(0,function(v){
              _fun(v)
            })
          },BZ._isAutoRunning()?0:500)
        }
      }else{
        _end(4)
      }
    }
    
    function _fun(v){
      if(v){
        _valueIdx++
        //Do next value
        _doIt()
      }else{
        //result is Failed
        _end(1)
      }
    }
    
    function _end(v){
      // _observer.disconnect();
      _exeClick(BZ.TW.document.body,0,function(){
        _bkFun(v)
      })
    }
    
    function _exe(es){
      let x=es.shift(),
          _curFun;
      if(x&&Date.now()-_start<60000){
        let er=x.getBoundingClientRect()
        if(!er.height||!er.width){
          return _exe(es)
        }
        if(_Util._isInputObj(x,1)){
          if(_value!==undefined&&_isEditableInput(x)&&_value!="/{random}/"){
            _curFun=_exeChange
          // }else if(!_value){
          //   return _end()
          }else{
            return _exe(es)
          }
        }else{
          _curFun=_exeClick
        }
        _curFun(x,1,function(v){
          if(v){
            $(x).blur()
            _fun(1)
          }else{
            _exe(es)
          }
        })
      }else{
        _fun()
      }
    }
    
    function _exeChange(o,_continueTarget,_fun){
      $util.triggerChangeEvent(o,_value,0,0,0,0,function(){
        _domActionTask._doLog("auto fill input: "+o.outerHTML)
        _findTarget(_cssHandler._getElementScope(o),_fun,1)
      },1)
    }
    
    function _exeClick(o,_continueTarget,_fun){
      $util.triggerMouseEvents(o,1,0,0,0,0,0,function(){
        setTimeout(()=>{
          _continueTarget?_findTarget(_cssHandler._getElementScope(o),_fun):_fun&&_fun(1)
        },100)
      })
    }
    
    function _findTarget(_exceptScope,_fun,_fromInput,_waitTimes){
      _waitTimes=_waitTimes||0
      BZ._setTimeout(()=>{
        if(_TWHandler._curRequestList.length){
          if(!rs){
            rs=_Util._clone(_TWHandler._curRequestList)
          }
          if(rs.find(r=>{
            return _TWHandler._curRequestList.find(rr=>{
              return rr.url==r.url
            })
          })){
            return _findTarget(_exceptScope,_fun,_fromInput,_waitTimes)
          }
        }
        if(!_findItem(_exceptScope,"equal")&&!_findItem(_exceptScope,"Contains")){
          _newElements=_Util._getDiffAfterTriggerEvent(1,1);
          if(_fromInput||!_newElements.find(n=>{
            if(n.nodeType!=1){
              n=n.parentElement
            }
            if(!n){
              return
            }
            if(a.event.fromPanel&&!$(n).is(a.event.fromPanel)){
              return
            }
            let os=_Util._findInputs(n)
            
            return os.find(o=>{
              if(_isEditableInput(o)&&_value!=="/{random}/"){
                _exeChange(o,1,_fun)
                return 1
              }
            })
          })){
            if((_waitTimes<10&&!_fromInput)||Date.now()-_start<_period){
              _findTarget(_exceptScope,_fun,_fromInput,_waitTimes+1)
            }else{
              _fun()
            }
          }
        }else{
          _fun(1)
        }
      },50)
    }
    
    function _findItem(_exceptScope,_bzPathMethod){
      _newElements=_Util._getDiffAfterTriggerEvent(1,1);
      return _newElements.find(n=>{
        if(a.event.fromPanel&&!$(n).is(a.event.fromPanel)){
          return
        }
        if(_exceptScope){
          if(n.nodeType!=1){
            n=n.parentElement
          }
          if(!n){
            return
          }
          let nt=n.getBoundingClientRect(),
              et=_exceptScope.getBoundingClientRect()
          if(_exceptScope==n||$(_exceptScope).find(n).length){
            return
          }
        }

        if(_value=="/{random}/"){
          let _random=_findRandomValue(n,a.event.valueStyle)
          if(!_random){
            return
          }else{
            _values[_valueIdx]=_value=_random
            try{
              let vv=a._orgData.event.value
              if(vv.match(/^\{\{.+\}\}$/s)){
                vv=vv.substring(2,vv.length-2)
                if(_values.length==1){
                  _Util._eval(vv+"=_value",{_value:_value})
                }else{
                  _Util._eval(vv+"=_values",{_values:_values})
                }
              }
            }catch(e){}
          }
        }
        _Util._newFindDom()
        let os=$(n).find(":"+_bzPathMethod+"("+_value+")").toArray().reverse();
        
        if(os.length){
          let _triggered=0
          os.forEach(o=>{
            let or=o.getBoundingClientRect()
            if(or.width&&or.height&&(!a.event.valueStyle||os.includes(_cssHandler._getElementScope(o,a.event.valueStyle)))){
              _triggered=1
              $util.triggerMouseEvents(o,1,0,0,0,0,0)
              return 1
            }
          })
          return _triggered
        }
      })
    }
    
    function _findRandomValue(o,_style){
      if(o.tagName=="BODY"){
        return
      }
      let os=_Util._getTargetElement($(o).find(":endContains(/./)"))
      _Util._spliceAll(os,x=>{
        return !$util.getElementText(x)||!_Util._toTrimSign(x.innerText)||_Util._isHidden(x)||x.getBoundingClientRect().width<5||x.getBoundingClientRect().height<5||(_style&&!_cssHandler._getElementScope(x,_style))
      })

      _Util._filterEndElementList(os)

      if(!BZ._isPlaying()&&a._requestErgodicDom&&_Util._isEmpty(a._requestErgodicDom._ergodicValueList)){
        a._requestErgodicDom._ergodicValueList=os.map(x=>$util.getElementText(x)).filter(x=>x)
        if(_Util._isEmpty(a._requestErgodicDom._ergodicValueList)){
          return
        }
        a._requestErgodicDom._ergodicIdx=0
        return a._requestErgodicDom._ergodicValueList[0]
      }
      while(os.length){
        o=$util.randomItem(os)
        if(o&&o.value){
          let v=$util.getElementText(o.value)
          if(!_preValue||_Util._toTrimSign(v)!=_preValue||os.length==1){
            return v
          }
        }else{
          return
        }
      }
    }
    function _isEditableInput(o){
      let or=o.getBoundingClientRect()
      return o.tagName=="INPUT"&&!o.readonly&&!$(o).attr("readonly")&&!$(o).attr("disabled")&&!o.disabled&&or.width&&or.width&&!["checkbox","radio","file"].includes(o.type)
    }
    function _getElementList(e){
      let s=_cssHandler._getElementScope(e)
      let es=$(s).find("*").toArray()
      
      es.splice(es.indexOf(e),1)
      es.unshift(e)
      es.push(s)
      es.find(x=>{
        if(_Util._isInputObj(x,1)&&!_Util._isHidden(x)&&!["checkbox","radio","file"].includes(x.type)){
          es.unshift(x)
          return 1
        }
      })
      return es
    }
    
    function _selectMultip(e,vs,a){
      let ws=$util.getElementText(e).split(/\s/),
          _chkEqual=`:endEqual(/${vs.join("|")}/)`,
          os
      if(vs.find(x=>{
        return !ws.includes(x)
      })){
        return 
      }
      if(a.event.selectStyle||a.event.valueStyle){
        if(a.event.valueStyle){
          os=$(e).find(a.event.valueStyle).toArray()
          let oo=[];
          os.forEach(x=>{
            let xx=$(x).find(_chkEqual)
            if(!xx.length){
              if($(x).is(_chkEqual)){
                oo.push(x)
              }
            }else{
              oo=oo.concat(xx.toArray())
            }
          })
          os=$(oo)
        }else{
          os=$(e).find(_chkEqual)
        }
        if(os.length!=vs.length){
          return
        }
        if(a.event.selectStyle){
          let ss=$(e).find(a.event.selectStyle+_chkEqual).toArray();
          os=os.toArray()
          _Util._spliceAll(os,x=>{
            if(ss.includes(x)||$(ss).find(x)[0]){
              return 1
            }
          })
          $(os).click()
        }else{
          os.click()
        }
      }else{
        os=$(e).find(`INPUT[type=checkbox]:near(/${vs.join("|")}/)`)
        if(os.length){
          $(e).find(`INPUT[type=checkbox]:checked`).click()
          $(os).click()
        }else{
          return
        }
      }
      return 1
    }
  },
  _isCustomizeAction:function(d){
    return d._customize=_cssHandler._getCustomizeGroupByElementPath(d.element,d.customize)
  },
  _setRandomValueToVariable:function(v,a){
    if(_Util._hasCode(a._orgData.event.value)){
      try{
        let cc=a._orgData.event.value.replace(/[\{\}]/g,"")
        _Util._eval(cc+"=v",{v:v})
      }catch(e){
      }
    }
  },
  _mouseoverItems:function(e,ck,_fun){
    let _org=e
    $util.triggerMouseEvent(e,"mouseover")
    $util.triggerMouseEvent(e,"mousemove")
    BZ._setTimeout(function(){
      if(!_chkFun(e)){
        _triggerChildren(e)
        BZ._setTimeout(function(){
          if(!_chkFun(e)){
            let p=_triggerParents(e,_org)
            BZ._setTimeout(function(){
              if(!_chkFun(p)){
                _fun()
              }
            },10)
          }
        },10)
      }
    },10)
    
    function _triggerParents(e,_org){
      e=e.parentElement
      let r=_org.getBoundingClientRect()
      let pr=e.getBoundingClientRect()
      if(pr.width<=r.width+50&&pr.width>=r.width&&pr.height<=r.height+10&&pr.height>=r.height){
        $util.triggerMouseEvent(e,"mouseover")
        $util.triggerMouseEvent(e,"mousemove")
        return _triggerParents(e,_org)
      }else{
        return e
      }
    }
    
    function _triggerChildren(e){
      for(var i=0;i<e.children.length;i++){
        let ee=e.children[i]
        $util.triggerMouseEvent(ee,"mouseover")
        $util.triggerMouseEvent(ee,"mousemove")
        _triggerChildren(ee)
      }
    }
    
    function _chkFun(e){
      let o=$(e).find(ck)[0]
      if(o){
        _fun(o)
        return 1
      }
    }
  },
  _clearValue:function(d,_doIt,_fun){
    let e=_cssHandler._getOutestCover(d.e)
    let _clear="";
    if(d._customize.clear){
      _clear=d._customize.clear.join(" ")
      if(d._customize.clear.length==1){
        if(_clear.match(/^[\.\#]/)){
          _clear=":css("+_clear+")"
        }
      }
    }else{
      return _fun&&_fun()
    }
    //Clear value
    _cssHandler._findCloserElement(e,_clear,function(b){
      if(!b){
        _domActionTask._trigger({
          type:1,
          element:d.element,
          event:{type:"mouse",action:"click"}
        },function(r){
          BZ._setTimeout(function(){
            _cssHandler._findCloserElement(e,_clear,function(b){
              if(b&&b.tagName=="INPUT"){
                _domActionTask.as=[{
                  type:1,
                  e:b,
                  element:_cssHandler._findPath(b),
                  event:{type:"key",action:"change",value:""}
                }]
              }else{
                _domActionTask.as=[{
                  type:1,
                  e:b,
                  element:b?_cssHandler._findPath(b):["BZ.TW.document",_clear,0],
                  event:{type:"mouse",action:"click"}
                },{
                  type:1,
                  element:["BZ.TW.document","BODY",0],
                  event:{type:"mouse",action:"click"}
                }]
              }
              _doIt([],_fun)
            })
          },500)
        })
      }else{
        if(b.tagName=="INPUT"){
          _domActionTask.as=[{
            type:1,
            e:b,
            element:_cssHandler._findPath(b),
            event:{type:"key",action:"change",value:""}
          }]
        }else{
          _domActionTask.as=[{
            type:1,
            e:b,
            element:_cssHandler._findPath(b),
            event:{type:"mouse",action:"click"}
          }]
        }
        BZ._setTimeout(function(){
          _doIt([],_fun)
        },500)
      }
    })
  },
  _exeCustomizeAction:function(d,_result,_fun){
    var _inRecording=BZ._isRecording(),
        j=0,vs=[],_timer=0,_maxTime=parseInt(d.max);
    _domActionTask.as=[]
    let _values=d.event.value.replace(/(^\||\|$)/,"").split("|")
    if(d._customize.value&&d.event.value){
      var _valueElement=_cssHandler._findCloseElement(d.e,d._customize.value)
      if(_valueElement){
        _valueElement=_valueElement.value||$util.getElementText(_valueElement)||""
        if(_valueElement){
          vs=d.event.value.split("|")
          _Util._spliceAll(vs,v=>{
            if(_valueElement.match(new RegExp("(^| )"+v+"( |$)"))){
              _valueElement=_valueElement.replace(new RegExp("(^| )"+v+"( |$)"),"")
              return 1
            }
          })
          if(!vs.length&&!_valueElement.trim()){
            return _fun({_type:4})
          }else if(!_valueElement.trim()){
            return _triggerToggle(vs)
          }else{
            return _domActionTask._clearValue(d,_doIt,function(r){
              if(r&&r._type==1){
                r._msg=_bzMessage._setting._objectLib._missCloser
                _fun(r)
              }else{
                _triggerToggle(_values)
              }
            })
          }
        }
      }
    }
    if(!d.event.value&&d._customize.clear){
      return _domActionTask._clearValue(d,_doIt,function(r){
        _fun(r)
      })
    }
    
    _triggerToggle(_values)
    function _triggerToggle(_values){
      _doTrigger({
        type:1,
        element:_Util._clone(d.element),
        event:{type:"mouse",action:"click"},
        errOnHidden:"on"
      },function(){
        BZ._setTimeout(()=>{
          _fillValue(_values)
        },100)
      })
    }

    
    function _fillValue(_values){
      let _value=_values.shift()
      _value=_getRandomValue(_value,d._customize)||_value
      d._customize.steps.forEach(function(v,j){
        if(_inRecording&&v.event.type=="change"&&_value=="*"){
          return
        }
        if(_values.length&&j==d._customize.steps.length-1&&(!v.element||!v.element.join(" ").includes("$"))){
          return
        }
        v=_Util._clone(v)
        if(v.element&&v.element.length){
          v.element.unshift(d._customize.panel.join(" "))
          v.element.unshift(d.element[0])
        }else{
          v.element=["BZ.TW.document","BODY",0]
        }
        v.errOnHidden="on"
        _domActionTask.as.push(v)
      })

      vs=_domActionTask._retrieveWordsInFormat(_value,d._customize.format)

      if(_inRecording){
        BZ._triggerSetStatus(0)
        return BZ._setTimeout(function(){
          _doIt([],function(r){
            if(_values.length){
              _fillValue(_values)
            }else{
              _fun(r)
            }
          })
        },100)
      }
      _doIt(vs,function(r){
        if(r._type!=4){
          if(r.a){
            r._msg+=" ("+_ideActionManagement._getAutoDescription(r.a,1).trim()+")"
          }
          return _fun(r)
        }
        if(_values.length){
          _fillValue(_values)
        }else{
          _fun(r)
        }
      })
    }
    
    function _getRandomValue(v,c){
      v=v.match(/^\/\{random:?(.*)\}\/$/)
      let cc,nv;
      if(v){
        v=v[1]
        
        if(v){
          v=v.split("|")
          cc=v.shift()
          nv=v
        }
        v=_getOptionsFromPanel(cc?[cc]:c.panel,c.steps,nv)
        return $util.randomItem(v).value
      }
    }
    
    function _getOptionsFromPanel(pp,s,nv){
      pp=_Util._clone(pp)
      pp.unshift("BZ.TW.document")
      let p=_Util._clone(pp)
      p.push(0)
      p=$util.findDom(p)
      if(p){
        if(s.find(i=>{
          if(i.event&&i.event.type=="mouse"){
            i.element.forEach(oi=>{
              if(!$.isNumeric(oi)){
                let vv=oi.replace(/\$[0-9]+/g,"*")
                pp.push(vv)
              }
            })

            pp=_Util._findDoms(pp)||[]

            return 1
          }
        })){
          p=[]
          pp.forEach(pi=>{
            pi=$util.getElementText(pi).trim()
            if(pi){
              p.push(pi)
            }
          })
          
          nv&&_Util._spliceAll(p,v=>{
            return nv.includes(v)
          })
          return p
        }
      }
    }
    function _doIt(vs,_bkFun){
      var a=_domActionTask.as.shift()
      for(var i=vs.length;i>0;i--){
        if(a.event.value){
          a.event.value=a.event.value.replace("$"+i,vs[i-1])
        }
        a.element.forEach(function(v,jj){
          var vv=vs[i-1]
          if(vv){
            if(v.constructor==String){
              a.element[jj]=v.replace("$"+i,vs[i-1])
            }
            if(!a.event.value){
              a.event.value=vv
            }
          }
        })
      }
      var vv=a.event.value;
      if(vv=="*"){
        var oo=_domActionTask._findElement(a)
        if(oo){
          _cssHandler._findPath(oo)
          vv=_descAnalysis._retrieveTextForElementPathItem(oo.bzTmp)
        }
      }
      _findDom(a.element,function(o){
        if(!BZ._isAutoRunning()){
          _bzDomPicker._flashTmpCover(a.element)
          BZ._setTimeout(()=>{
            _doTrigger(a,0,_bkFun)
          },300)
        }else{
          _doTrigger(a,0,_bkFun)
        }
      })
      function _findDom(p,_bkFun,_time){
        _time=_time||Date.now()
        let o=$util.findDom(p,1)
        if(!o&&_maxTime>Date.now()-_time){
          BZ._setTimeout(()=>{
            _findDom(p,_bkFun,_time)
          },10)
        }else{
          _bkFun(o)
        }
      }
    }

    function _doTrigger(a,_fun,_bkFun){
      _domActionTask._trigger(a,function(r){
        if(_fun){
          return _fun(r)
        }
        if(_domActionTask.as.length&&r._type==4){
          _timer=0
          BZ._setTimeout(function(){
            _doIt(vs,_bkFun)
          },500)
        }else{
          if(_inRecording){
            return BZ._setTimeout(function(){
              BZ._triggerSetStatus("record")
              BZ._setTimeout(function(){
                r._customizeInputAction={
                  _element: {},
                  _type: 1,
                  _orgPath:d,
                  _action: "change",
                  _value: vv,
                  _time: Date.now(),
                  _tmpUrl: location.href
                };
                _bkFun(r)
              },100)
            },100)
          }else if(r._type<3&&_timer<_maxTime){
            _domActionTask.as.unshift(a)
            _timer+=500
            return BZ._setTimeout(function(){
              _doIt(vs,_bkFun)
            },500)
          }
          r.a=a
          _bkFun(r)
        }
      })
    }
  },
  _retrieveWordsInFormat:function(w,f){
    var vs=f.split(/[^\$0-9]+/),
        fs=f.split(/\$[0-9]+/),ws=[]
    for(var i=0;i<fs.length;i++){
      f=fs[i]
      if(f){
        var j=w.indexOf(f)
        ws.push(w.substring(0,j))
        w=w.substring(j+f.length)
      }
    }
    if(ws.length){
      if(w){
        ws.push(w)
      }
      return ws
    }else{
      return [w]
    }
  },
  _doComment:function(_data){
    _domActionTask._setErrorPos({},"_element","_actionDetailsGeneral");
    var _dom=_domActionTask._findElement(_data);
    
    
    if(_tipHandler._showItem(_data)){
      return {_type:_taskInfo._type._success};
    }else{
      return {_type:_taskInfo._type._failed};
    }
  },
  _getJsonAfterIgnore:function(d,_ignoreKeys,_ignoreValues,_nullValue,_emptyValue){
    _ignoreKeys=(_ignoreKeys||"").trim();
    _ignoreValues=(_ignoreValues||"").trim();
    
    if(d.constructor==Array || d.constructor==Object){
      for(var k in d){
        if(!_ignoreKeys || !k.match(_ignoreKeys)){
          var v=_domActionTask._getJsonAfterIgnore(d[k],_ignoreKeys,_ignoreValues,_nullValue,_emptyValue);
          if(_emptyValue && v===""){
            delete d[k];
          }else if(_nullValue && v===null){
            delete d[k];
          }else if(v && v.constructor!=Object && v.constructor!=Array){
            v=v.toString();
            if(_ignoreValues && v.match(_ignoreValues)){
              delete d[k];
            }else{
              d[k]=v;
            }
          }else{
            d[k]=v;
          }
        }else{
          delete d[k]
        }
      }
    }
    return d;
  },
  _compareWithDataExpection:function(d,o,_force){
    var _result={_type:_taskInfo._type._success,_msg:""};
    _domActionTask._setErrorPos(_result,"_expection","_actionDetailsGeneral");
    let vs=(d.expection||"").split("\n");
    vs=vs.map(x=>{
      if(_Util._hasCode(x)){
        return _eval._exeCode(x)
      }
      return x
    }).filter(x=>x!==undefined&&x!==null&&x!==""&&x!="bz-skip");
    var _text=$util.getElementText(o)
    var _inputs=_cssHandler._findAllInputs(d.e)
    _inputs&&_inputs.forEach(u=>{
      vs.find((x,j)=>{
        if(x==u.value){
          vs.splice(j,1)
          return 1
        }
      })
    })
    
    for(var i=0;i<vs.length;i++){
      var v=vs[i],vv=v;

      try{
        if(!vv&&vv!==0&&vv!==false){
          continue
        }else if(["bz-skip","bz-ignore"].includes(vv)){
          
          continue
        }else if(v=="bz-stop"){
          _result._bzStop=1
          break;
        }
        if(!_text.includes(vv)){
          _result._type=_taskInfo._type._failed;

          _result._msg=_bzMessage._task.UnMatch+": \n\n"+v+` (${vv})`;
          _result._errSou=_taskInfo._errSou._exp;
          break;
        }
      }catch(e){
        _result._type=_taskInfo._type._failed;
        _result._msg+=e.message+" ("+v+")\n";
        _result._errSou=_taskInfo._errSou._exp;
        break;
      }
    }
    if(_force && _result._type!==_taskInfo._type._success){
      alert(_result._msg)
    }
    return _result;
  },
  _extractDataByJs:function(_data,_fun,$parameter,$test,$module,$loop){
    $parameter=$parameter||window.$parameter
    $test=$test||window.$test
    $module=$module||window.$module
    $loop=$loop||window.$loop
    let $element=window.$element

    if(_data.script){
      var element;
      if(_data.element){
        _domActionTask._setErrorPos({},"_element","_actionDetailsGeneral");
        element = _domActionTask._findElement(_data);
      }
      var s=_data.script.trim();
      if(s[s.length-1]==";"){
        s=s.substring(0,s.length-1);
      }

      _domActionTask._exeScript(s,0,$element,function(v){
        _fun({
          _type:v?_taskInfo._type._success:_taskInfo._type._failed,
          _extractData:v
        })
      })
    }else{
      _fun({
        _type:_taskInfo._type._success
      });
    }
  },
  /*
  var data=[
    'DIV:Contains({{$parameter.name1}})',
    'DIV:Contains({{$util.findDom($parameter.name2)}})',
    'DIV:Contains({{$util.findDom($parameter.name3 + $parameter.value1)}})',
    'DIV:Contains({{$util.findDom($parameter.name4 + " "+$parameter.value2)}})',
    'DIV:Contains({{$util.findDom($parameter.name5 + $parameter.value3)}})',
    'DIV:Contains({{$util.findDom($parameter.name11) + $util.findDom($parameter.value7)}})',
    'DIV:Contains({{$util.findDom($parameter.name12) + $parameter.value8}}',
    'DIV:Contains({{$parameter.value10+$util.findDom($parameter.name14)}}',
    'DIV:Contains($parameter.name6)',
    'DIV:Contains($util.findDom($parameter.name7))',
    'DIV:Contains($util.findDom($parameter.name8 + $parameter.value4))',
    'DIV:Contains($util.findDom($parameter.name9 + " "+$parameter.value5))',
    'DIV:Contains($util.findDom($parameter.name10 + $parameter.value6))',
    'DIV:Contains($util.findDom($parameter.name13) + $util.findDom($parameter.value9))',
    'DIV:Contains($util.findDom($parameter.value11+$util.findDom($parameter.name15)))',
    '$util.findDom($parameter.value12+$util.findDom($parameter.name16))',
    '$parameter["lws-ok"]',
  ]
  data.forEach(x=>{
    console.log(_domActionTask._retrieveBindDataFromString(x))
  })
  */
  _retrieveBindDataFromString:function(w){
    // w=w.match(_IDE._insertJSOnlyRegex)
    w=w.match(/\$(project|module|test|loop|data|group|action|parameter|result|element)((\.[^\s\)\]\}\,\;\:\!\=\?\>\<\.\^\%\&\|\@\"\'\+\-\*\/]+)|\[[^\]]+\])+(\(.+\))?/g)
    if(w){
      w=w.map(x=>{
        return x.replace(/\)/,"").replace(/[\"\']$/,"")
      })
      w=[...new Set(w)]
    }
    return w
  },
  // _getCurDataExpress:function(ss){
  //   if(ss){
  //     let s=_domActionTask._retrieveBindDataFromString(ss);
  //     if(s){
  //       s.forEach((v,i)=>{
  //         let vv
  //         try{
  //           eval("vv="+v)
  //           s[i]=v+" = "+JSON.stringify(vv)
  //         }catch(e){
  //           s[i]=v+" ("+_bzMessage._common._error+": "+e.message+")"
  //         }
  //       })
  //       return s.join("\n")
  //     }
  //   }
  //   return ss
  // },
  _prepareValidation:function(){
    var ts=[];
    while(true && _domActionTask._taskQueue){
      var t=_domActionTask._taskQueue.shift();
      if(!t){
        break;
      }
      ts.push(t);
      if(t.code){
        break;
      }
      if(t.type==0 && t.method==0&&t.element){
        try{
          var dom=_domActionTask._findElement(t);
          if(dom){
            t._preDom={
              _html:_calcMD5(dom.outerHTML)
            };
          }
        }catch(e){}
      }else if(t.type==1){
        break;
      }
    }
    for(var i=ts.length-1;i>=0;i--){
      _domActionTask._taskQueue.unshift(ts[i]);
    }
  },
  _setErrorPos:function(_result,_value,_key){
    if(bzTwComm._isIDE()){
      _ideTask._setErrorPos(_result,_value,_key);
    }else{
      this._errorPos={_value:_value,_key:_key}
    }
  }
};//for $action,$group
var _tmpLoopDatahandler={
  _getActionKey:function(a,t,m){
    if(a._timestamp){
      return a._timestamp
    }
    let k=BZ._getCurTestPath()+","
    if(a._supData){
      return k+a._supData._supData.code+"."+a._supData.code+"."+a._idx
    }else if(m){
      return k+m.code+"."+t.code+"."+t.actions.indexOf(a)
    }
    try{
      return k+BZ._getCurModule()._data.code+"."+BZ._getCurTest()._data.code+"."+a._idx
    }catch(e){}
  },
  _initActionData:function(a,_fun){
    let k=_tmpLoopDatahandler._getActionKey(a)
    if(!k){
      return 1
    }
    window._tmpLoopData=window._tmpLoopData||{}
    
    // let _lastResult=_ideTask._data._lastResult._data
    // if(_lastResult==a._supData||(_lastResult._supData==a._supData&&a._idx-1==_lastResult._idx)){
      // window._tmpLoopData[k]=0
    // }
    
    if(!window._tmpLoopData[k]&&a.loopData){
      let rr={_type:4}
      let dd=window._tmpLoopData[k]={d:_Util._stringToData(a.loopData),i:0}

      switch(dd.d){
        case 0:
        case "bz-skip":window._tmpLoopData[k]=0;rr._bzSkip=1;rr._pos="_action";_fun(rr);return
        case "bz-skip-group":window._tmpLoopData[k]=0;rr._bzSkipGroup=1; _fun(rr);return
        case "bz-stop":window._tmpLoopData[k]=0;rr._bzStop=1; _fun(rr);return
      }
      if(a._timestamp){
        console.log("BZ-LOG: [Tmp-Action]"+(a.type==7?"$group":"$action")+" = "+JSON.stringify(dd.d,0,2))
      }else{
        let t=BZ._getCurTest(),
            m=BZ._getCurModule()

        console.log("BZ-LOG: ["+m._data.code+"."+t._data.code+']'+t._data.name+", "+(a.type==7?"$group":"$action")+" = "+JSON.stringify(dd.d,0,2))
      }
      if(dd.d===undefined||dd.d===null){
        return 1
      }
      if($.isNumeric(dd.d)){
        dd.d=parseFloat(dd.d)
        if(dd.d<=0){
          return _fun()
        }
      }else if(dd.d.constructor==Array&&!dd.d.length){
        window._tmpLoopData[k]=0;
        rr._bzSkip=1;
        rr._pos="_action"
        _fun(rr);
        return
      }else if(dd.d.constructor!=Array){
        window._tmpLoopData[k].d=[dd.d]
      }
      _tmpLoopDatahandler._setNewActinData(a)
    }
    return 1
  },
  _setNewActinData:function(a){
    let k=_tmpLoopDatahandler._getActionKey(a)
    let dd=window._tmpLoopData[k]
    if(dd&&dd.d!=undefined){
      if(dd.d.constructor==Number){
        window.$action=dd.i++
        if(window.$action>=dd.d){
          window.$action=undefined
          delete window._tmpLoopData[k]
        }
      }else if(dd.d.constructor==Array){
        window.$action=dd.d[dd.i++]
        if(!window.$action){
          delete window._tmpLoopData[k]
        }
      }
    }
  },
  _hasNewActinData:function(a,r,_removeData){
    let k=_tmpLoopDatahandler._getActionKey(a)
    let dd=window._tmpLoopData&&_tmpLoopData[k]
    if(dd&&dd.d!=undefined&&(!r||r._type>2)){
      if(dd.d.constructor==Number){
        if(window.$action<dd.d){
          return 1
        }else if(_removeData){
          delete window._tmpLoopData[k]
        }
      }else if(dd.d.constructor==Array){
        if(dd.d[dd.i]){
          return 1
        }else if(_removeData){
          delete window._tmpLoopData[k]
        }
      }
    }
  },
  _handleActionLoopData:function(d,r){
    if(window._tmpLoopData&&d.type!=7){
      let k=_tmpLoopDatahandler._getActionKey(d)

      if(window._tmpLoopData[k]&&(!r||(r._type>2)||d.apiReplaceEvent)){
        _tmpLoopDatahandler._setNewActinData(d)
        if(window.$action){
          if(window.$action.parameter&&window.$action.parameter._cleanActionLoop){
            delete window._tmpLoopData[k]
            if(window.$action.parameter._update){
              window.$action.parameter._update()
            }
          }
          return 1
        }else{
          delete window._tmpLoopData[k]
          delete window.$action
        }
      }else if(r){
        delete window._tmpLoopData[k]
        delete window.$action
      }
    }
  },
  _insertGroupActions:function(_lastResult,a,as){//check $group
    if(_lastResult&&!_lastResult.code
       &&(!a||(a.code&&_lastResult._data.type!=4)||(!a.code&&!a.inGroup))
       &&_lastResult._data.inGroup
       &&!_lastResult._bzSkipGroup)
    {
      var t=_lastResult._data._supData
      var ga=_ideActionGroup._findGroupAction(_lastResult._data,t)
      window._tmpGroupLoopData=window._tmpGroupLoopData||{}
      let k=_tmpLoopDatahandler._getActionKey(ga,t,t._supData)
      
      if(ga.loopGroup||_tmpGroupLoopData[k]){
        if(_tmpGroupLoopData[k]&&_tmpGroupLoopData[k].d){
          if(_tmpGroupLoopData[k].d.constructor==Number){
            $group=_tmpGroupLoopData[k].i++
            if($group>=_tmpGroupLoopData[k].d){
              _tmpGroupLoopData[k]=$group=undefined
              return _endGroup(ga)
            }
          }else{
            $group=_tmpGroupLoopData[k].d[_tmpGroupLoopData[k].i++]
            if(!$group){
              _tmpGroupLoopData[k]=$group=undefined
              return _endGroup(ga)
            }
          }
        }
        var i=t.actions.indexOf(ga),ii;
        ii=_lastResult._data._idx
        for(var n=ii;n>=i;n--){
          _domActionTask._buildTaskAction(t.actions[n],t,n,as)
        }
        if(_lastResult._data.endGroup){
          as.splice(ii-i+1,0,_lastResult._data)
        }
        return 1
      }else{
        _endGroup(ga)
      }
    }
    
    function _endGroup(g){
      if(g.resultscript){
        try{
          eval(g.resultscript)
        }catch(e){}
      }
      if(g.successGoto){
        _domActionTask._gotoFlag(g.successGoto,as)
      }
    }
  },
  _handleGroupData:function(_data,_setting){
    let _skip=1
    //Handler $group
    if(_data.type==7&&_data.loopData){
      let k=_tmpLoopDatahandler._getActionKey(_data)
      //let t=_ideTask._data._lastResult._data
      window._tmpGroupLoopData=window._tmpGroupLoopData||{}
      if(!_tmpLoopDatahandler._lastData){
        _tmpLoopDatahandler._lastData=_data
      }
      let t=_tmpLoopDatahandler._lastData
      if(t==_data._supData||(t._supData==_data._supData&&_data._idx-1==t._idx)){
        window._tmpGroupLoopData[k]=0
      }
      if(!_tmpGroupLoopData[k]){
        _tmpGroupLoopData[k]={d:_Util._stringToData(_data.loopData),i:0}
        let gd=_tmpGroupLoopData[k]
        if(gd.d!==undefined&&gd.d!==null){
          if(!gd.d||gd.d=="bz-skip"){
            return _skip
          }else if(gd.d.constructor==Number){
            $group=gd.i++
          }else if(gd.d.constructor==Array){
            $group=gd.d[gd.i++]
            if($group===undefined){
              return _skip
            }
          }else {
            $group=gd.d
            gd.i++
            gd.d=[gd.d]
          }
        }else{
          delete _tmpGroupLoopData[k]
        }
      }
    }
    _setting.$group=window.$group
  },
  _stopGroupLoop:function(a){
    a=_ideActionGroup._findGroupAction(a)
    if(a){
      let k=_tmpLoopDatahandler._getActionKey(a)
      if(a.loopGroup||(window._tmpGroupLoopData&&window._tmpGroupLoopData[k])){
        window._tmpGroupLoopData[k]=window.$group=undefined
      }
    }
  }
};var _apiHandler={
  _init:function(){
    BZ._data._uiSwitch._apiRequestActions=[]
    BZ._data._uiSwitch._apiRequests=[]
    _apiHandler._curRequestMap={}
  },
  _getAPIDefValue:function(d){
    if(d.required){
      let f=_aiGeneratorDataHandler._getFieldByCode(d.code)
      if(f){
        d=f.inputFormat
      }else{
        d=""
      }
    }else{
      d="bz-skip"
    }
    return d
  },
  _getTabInfo:function(d,r){
    let v=""
    if(d=="_timeout"){
      v=r.timeout?"*":""
    }else if(d=="_preScript"){
      let a=_IDE._data._curAction
      if(a){
        v=a.loopData?"*":""
      }else if(r.preScript){
        v="*"
      }
    }else if(d=="_responseScript"){
      v=r.responseScript?"*":""
    }else if(d=="_join"){
      v=!_Util._isEmpty(r.joins)?"*":""
    }else if(d=="_body"){
      v=!_Util._isEmpty(r.data)&&(r.data.constructor!=String||r.data.replace(/\s/g,"")!="{}")?"*":""
    }else if(d=="_path"){
      v=!_Util._isEmpty(r.path)?"*":""
    }else if(d=="_query"){
      v=!_Util._isEmpty(r.query)&&(r.query.constructor!=String||r.query.replace(/\s/g,"")!="{}")?"*":""
    }
    return v
  },
  _updateQuery:function(r,_force,_noJson){
    if(!r.query||_force){
      r.query={}
      let v=r.url.split("?")[1]
      if(v){
        v=v.split("&")
        
        v.forEach(x=>{
          x=x.split("=")
          r.query[x[0]]=$.isNumeric(x[1])?parseFloat(x[1]):decodeURI(x[1])
        })
        if(!_noJson){
          r.query=JSON.stringify(r.query)
        }
      }
    }
  },
  _isSocketRequest:function(v){
    return !v.method
  },
  _assignRequestHostAndUrl:function(r,_url){
    let i=r.host!==undefined?r.host:_apiHandler._getHostIdx(_url)
    _url=_apiHandler._removeProtocol(_url)
    r.host=i
    let o=BZ._curEnv.items[i]
    if(o){
      _host=_apiHandler._removeProtocol(o.host)
      if(_url.startsWith(_host)){
        r.url=_url.substring(_host.length)
      }
      if(r.url[0]!="/"){
        r.url="/"+(r.url||"")
      }
    }
  },
  _getHostIdx:function(_url){
    _url=_apiHandler._removeProtocol(_url)
    let _items=_IDE._data._setting.environments[_IDE._data._setting.curEnvironment].items
    let fs=_items.filter(x=>x.host)
    let v=fs.filter((o,i)=>{
      return _url.startsWith(_apiHandler._removeProtocol(o.host))
    }).sort((a,b)=>{return b.host.length-a.host.length})[0]
    
    
    if(v){
      return _items.indexOf(v)
    }
  },
  _removeProtocol:function(_url){
    return _url.replace(/^(http|https)?:?[\/][\/]/,"")
  },
  _formatRequests:function(rs){
    let rr=[]
    rs.forEach((r,i)=>{
      _apiHandler._updateQuery(r,1,1)
      let d={
        host:r.host,
        url:r.url,
        method:r._method,
        data:r.data,
        headers:r.headers,
        contentType:(r.headers||{})["Content-Type"]||(r.headers||{})["content-type"],
        path:_Util._getPathFromUrl(r.url),
        status:r._code,
        query:r.query,
        _response:r._rep
      }
      if(r.headers){
        d.contentType=r.headers["Content-Type"]||r.headers["content-type"]||r.headers["Accept"]||r.headers["accept"]
      }
      rr.push(d)
      // delete (r.headers||{})["Content-Type"]
      // delete (r.headers||{})["content-type"]
    })
    return rr
  },
  _isRequestAction:function(a){
    a=a||_IDE._data._curAction||{}
    return a.type=="a"||(a.requests&&a.requests.length)||a.apiReplaceEvent
  },
  _getRequestsDesc:function(d){
    return d.requests.map((v,i)=>{
      return i+1+". "+(v.method||"Socket")+": "+v.url
    }).join("\n")
  },
  _isEmptyResponse:function(v){
    return !v||(v.constructor==Object&&!Object.keys(v).length)||(v.constructor==Array&&!v.length)
  },
  _definedHost:function(_missHost,_fun,_noFun){
    var _host=_Util._retrieveHostFromUrl(_missHost.url)||_missHost.host;
    return _Util._confirmMessage(_Util._formatMessage(_bzMessage._auth._missHost,[_host]),[{
      _title:_bzMessage._method._add,
      _click:function(c){
        var _name="API"
        var ns=BZ._curEnv.items.map(e=>{
          return e.name
        })
        var i=1
        while(ns.includes(_name)){
          _name="API"+i;
          i++
        }
        _IDE._data._setting.environments.forEach((e,i)=>{
          if(i==_IDE._data._setting.curEnvironment){
            e.items.push({
              host:_host,
              defaultRoot:"",
              name:_name
            })
          }else{
            e.items.push({name:_name})
          }
        })
        BZ._curEnv=_IDE._data._setting.environments[_IDE._data._setting.curEnvironment]

        _ideVersionManagement._save(_fun)
        c._ctrl._close()
      }
    },{
      _title:_bzMessage._method._not,
      _click:function(c){
        _noFun()
        c._ctrl._close()
      }
    }])
    
  },
  _chkHost:function(rs,_fun){
    let _idx=_IDE._data._curTest._data.hostId
    let v=rs.find(r=>{
      if(r.host==-1||r.host===undefined){
        r.host=_apiHandler._getHostIdx(r.url)
        return r.host===undefined
      }
    })
    if(v){
      _apiHandler._definedHost(v,function(){
        v.host=BZ._curEnv.items.length-1
        _apiHandler._chkHost(rs,_fun)
      },function(){
        var u=_Util._retrieveHostFromUrl(v.url)
        _Util._spliceAll(rs,r=>{
          return r.url.startsWith(u)
        })
        _apiHandler._chkHost(rs,_fun)
      })
    }else if(rs.length){
      _fun()
    }
  },
  _mapRequestDetails:function(rs,_fun){
    rs=_CtrlDriver._buildProxy(rs)
    BZ._data._uiSwitch._tmpMapReqList=rs
    _Util._confirmMessage({
      _tag:"div",
      _items:[
        {
          _tag:"div",
          _attr:{
            style:"line-height:25px;"
          },
          _items:[
            //title
            {
              _tag:"a",
              _attr:{
                class:"bz-request-mapping-item"
              },
              _items:[
                {
                  _tag:"button",
                  _attr:{
                    class:function(d){
                      let c="close"
                      if(d._item._open){
                        c="open"
                      }
                      return "btn btn-icon bz-node-"+c
                    },
                    style:"margin-top:-5px;margin-right:5px;"
                  }
                },
                {
                  _text:"_data._item.method+': '+_data._item.url",
                }
              ],
              _jqext:{
                click:function(){
                  this._data._item._open=!this._data._item._open
                  _Util._resizeModelWindow()
                }
              }
            },
            {
              _if:"_data._item._open",
              _tag:"div",
              _attr:{
                class:"bz-req-map-details"
              },
              _items:[
                //path
                {
                  _if:"!_Util._isEmpty(_data._item.path)",
                  _tag:"div",
                  _items:[
                    {
                      _tag:"div",
                      _text:"_bzMessage._api._path"
                    },
                    {
                      _tag:"div",
                      _attr:{
                        class:"input-group bz-request-value"
                      },
                      _items:[
                        {
                          _tag:"input",
                          _attr:{
                            class:"form-control"
                          },
                          _dataModel:"BZ._data._uiSwitch._tmpMapReqList[_data._supData._idx].path[_data._key]",
                          _jqext:{
                            click:function(e){
                              let _data=this._data
                              e.stopPropagation()
                              BZ._data._uiSwitch._selectedAPIItem=_data._supData._idx+'.path.'+_data._idx
                            }
                          }
                        },
                        {
                          _if:"BZ._data._uiSwitch._selectedAPIItem==_data._supData._idx+'.path.'+_data._idx",
                          _tag:"div",
                          _attr:{
                            style:"margin-top:25px;",
                            class:"pop-menu"
                          },
                          _items:function(d,c,o){
                            return _getDataOptions(rs,d,o)
                          }
                        }
                      ],
                      _dataRepeat:"_data._item.path"
                    }
                  ]
                },
                //Query
                {
                  _if:"!_Util._isEmpty(_data._item.query)",
                  _tag:"div",
                  _items:[
                    {
                      _tag:"div",
                      _items:[
                        {
                          _text:"_bzMessage._api._query"
                        },
                        {
                          _tag:"label",
                          _attr:{
                            class:"pull-right"
                          },
                          _items:[
                            {
                              _tag:"input",
                              _attr:{
                                type:"checkbox"
                              },
                              _dataModel:"_data._item._asQueryParameter",
                            },
                            {_text:"_bzMessage._api._asParameter"}
                          ]
                        }
                      ]
                    },
                    {
                      _tag:"div",
                      _attr:{
                        class:"input-group bz-request-value"
                      },
                      _items:[
                        {
                          _tag:"label",
                          _attr:{
                            class:"input-group-addon"
                          },
                          _text:"_data._key"
                        },
                        {
                          _tag:"input",
                          _attr:{
                            class:"form-control"
                          },
                          _dataModel:"BZ._data._uiSwitch._tmpMapReqList[_data._supData._idx].query[_data._key]",
                          _jqext:{
                            click:function(e){
                              let _data=this._data
                              e.stopPropagation()
                              BZ._data._uiSwitch._selectedAPIItem=_data._supData._idx+'.query.'+_data._key
                            }
                          }
                        },
                        {
                          _if:"BZ._data._uiSwitch._selectedAPIItem==_data._supData._idx+'.query.'+_data._key",
                          _tag:"div",
                          _attr:{
                            style:"margin-top:25px;",
                            class:"pop-menu"
                          },
                          _items:function(d,c,o){
                            return _getDataOptions(rs,d,o)
                          }
                        }
                      ],
                      _dataRepeat:"_data._item.query"
                    }
                  ]
                },
                //form
                {
                  _if:"!_Util._isEmpty(_data._item.data)",
                  _tag:"div",
                  _items:[
                    {
                      _tag:"div",
                      _items:[
                        {
                          _text:"_bzMessage._log._report._form"
                        },
                        {
                          _tag:"label",
                          _attr:{
                            class:"pull-right"
                          },
                          _items:[
                            {
                              _tag:"input",
                              _attr:{
                                type:"checkbox"
                              },
                              _dataModel:"_data._item._asFormParameter",
                            },
                            {_text:"_bzMessage._api._asParameter"}
                          ]
                        }
                      ]
                    },
                    {
                      _tag:"div",
                      _attr:{
                        class:"input-group bz-request-value"
                      },
                      _items:[
                        {
                          _tag:"label",
                          _attr:{
                            class:"input-group-addon"
                          },
                          _text:"_data._key"
                        },
                        {
                          _tag:"input",
                          _attr:{
                            class:"form-control"
                          },
                          _dataModel:"BZ._data._uiSwitch._tmpMapReqList[_data._supData._idx].data[_data._key]",
                          _jqext:{
                            click:function(e){
                              let _data=this._data
                              BZ._data._uiSwitch._selectedAPIItem=_data._supData._idx+'.data.'+_data._key
                              e.stopPropagation()
                            }
                          }
                        },
                        {
                          _if:"BZ._data._uiSwitch._selectedAPIItem==_data._supData._idx+'.data.'+_data._key",
                          _tag:"div",
                          _attr:{
                            style:"margin-top:25px;",
                            class:"pop-menu"
                          },
                          _items:function(d,c,o){
                            return _getDataOptions(rs,d,o)
                          }
                        }
                      ],
                      _dataRepeat:"_data._item.data"
                    }
                  ]
                },
                //response variable
                {
                  _if:"!_Util._isEmpty(_data._item._response)",
                  _tag:"div",
                  _attr:{
                    class:"input-group"
                  },
                  _items:[
                    {
                      _tag:"label",
                      _attr:{
                        class:"input-group-addon"
                      },
                      _items:[
                        {
                          _tag:"input",
                          _attr:{
                            type:"checkbox"
                          },
                          _dataModel:"_data._item._setRepToVar",
                          _jqext:{
                            click:function(){
                              if(this.checked&&!this._data._item._responseDataName){
                                let m=_IDE._data._curModule._data
                                this._data._item._responseDataName="$parameter."+_glossaryHandler._getVariableName(m.alias||m.name).toLowerCase()
                              }
                            }
                          }
                        },
                        {_text:"_bzMessage._api._responseDataName"}
                      ]
                    },
                    {
                      _tag:"input",
                      _attr:{
                        class:"form-control",
                        disabled:"!_data._item._setRepToVar"
                      },
                      _dataModel:"_data._item._responseDataName"
                    },
                    {
                      _tag:"a",
                      _attr:{
                        class:"input-group-addon input-group-org-addon"
                      },
                      _text:"_bzMessage._common._view",
                      _jqext:{
                        click:function(){
                          alert(JSON.stringify(this._data._item._response,0,2))
                        }
                      }
                    }
                  ]
                }
              ]
            }
          ],
          _dataRepeat:rs
        },
        {
          _tag:"hr",
          _attr:{
            style:"width:100%;float:left;"
          }
        },
        // {
        //   _tag:"div",
        //   _attr:{
        //     class:"col-xs-12"
        //   },
        //   _items:[
        //     {
        //       _tag:"label",
        //       _items:[
        //         {
        //           _tag:"input",
        //           _attr:{
        //             type:"checkbox"
        //           },
        //           _dataModel:"BZ._data._uiSwitch._reqToOneAction"
        //         },
        //         {
        //           _text:"_bzMessage._api._reqToOneAction"
        //         }
        //       ]
        //     }
        //   ]
        // }
      ],
      _jqext:{
        click:function(){
          BZ._data._uiSwitch._selectedAPIItem=0
        }
      }
    },[{
      _title:_bzMessage._method._save,
      _click:function(c){
        _fun(_Util._clone(rs))
        c._ctrl._close()
      }
    }],_bzMessage._api._mapRequestDetails)
    
    function _getDataOptions(rs,d,_dom){
      let vs=new Set()
      for(let i=0;i<d._supData._idx;i++){
        let r=rs[i]
        if(r._setRepToVar&&r._responseDataName&&r._response&&r._response.constructor==Object){
          for(var k in r._response){
            if(r._response[k]==d._item){
              vs.add("{{"+r._responseDataName+"."+k+"}}")
            }
          }
        }
        if(r._asQueryParameter){
          for(var k in r.query){
            if(r.query[k]==d._item){
              vs.add("{{$parameter."+k+"}}")
            }
          }
        }
        if(r._asFormParameter){
          for(var k in r.data){
            if(r.data[k]==d._item){
              vs.add("{{$parameter."+k+"}}")
            }
          }
        }
      }

      window.$parameter=window.$parameter||{}
      if($parameter.constructor==Object){
        for(let k in $parameter){
          if($parameter[k]==d._item){
            vs.add("{{$parameter."+k+"}}")
          }
        }
        let kk=_glossaryHandler._findSimilarWord(Object.keys($parameter),d._key+"")
        if(kk){
          vs.add("{{$parameter."+kk+"}}")
        }
      }
      
      
      if(!vs.size){
        $(_dom).hide()
      }
      
      vs=[...vs]

      return [
        {
          _tag:"div",
          _attr:{
            class:"pop-menu-item"
          },
          _text:"_data._item",
          _jqext:{
            click:function(){
              let v=BZ._data._uiSwitch._selectedAPIItem.split(".")
              rs[v[0]][v[1]][v[2]]=this._data._item
            }
          },
          _dataRepeat:vs
        }
      ]
    }
  },
  _buildAPIActions:function(rs){
    let _stdHeaders
    rs=rs.filter(x=>x._chk)
    _apiHandler._chkHost(rs,()=>{
      rs=_apiHandler._formatRequests(rs)
      _apiHandler._mapRequestDetails(rs,(rs)=>{
        rs=rs.map(r=>{
          if(r._asQueryParameter){
            $parameter=Object.assign($parameter,r.query)
            for(var k in r.query){
              r.query[k]="{{$parameter."+k+"}}"
            }
          }

          if(r._asFormParameter){
            $parameter=Object.assign($parameter,r.data)
            for(var k in r.data){
              r.data[k]="{{$parameter."+k+"}}"
            }
          }

          let _code=""
          if(r._responseDataName){
            if(r._responseDataName.includes(".")){
              _code=`  try{\n`
              +`    ${r._responseDataName} = JSON.parse($result.responseText);\n`
              +`  }catch(e){\n`
              +`  }\n`
            }else{
              _code=`  try{\n`
              +`    Object.assign(${r._responseDataName}, JSON.parse($result.responseText));\n`
              +`  }catch(e){\n`
              +`  }\n`
            }
          }
          
          if(r.headers&&r.headers.Authorization){
            r.headers.Authorization="##BZ-TOKEN##"
          }

          let rr={
            url:_buildUrl(r.url,r.path),
            query:JSON.stringify(r.query||{},0,2).replace(/(\"\{\{|\}\}\")/g,""),
            host:r.host,
            method:r.method,
            contentType:r.contentType,
            data:r.data,
            responseScript:`(function(){\n${_code}`
                          +`  return $result.status == ${r.status};\n`
                          +`})()`
          }
          
          if(_aiAuthHandler._getTakeTokenHostByTokenHostIdx(_apiHandler._getHostIdx(r.url))!=-1){
            rr.autoToken="on"
          }
          if(r.headers){
            rr.headers=JSON.stringify(r.headers,0,2)
            if(!_stdHeaders){
              _stdHeaders=rr.headers
            }
          }
          if(r.data){
            rr.data=JSON.stringify(r.data,0,2).replace(/(\"\{\{|\}\}\")/g,"")
          }
          return rr
        })
        _IDE._data._curTest._data.defParameter=JSON.stringify($parameter)
        let as=_IDE._data._curTest._data.actions
        // if(BZ._data._uiSwitch._reqToOneAction){
        //   as.push({
        //     type:1,
        //     apiReplaceEvent:"on",
        //     requests:rs
        //   })
        // }else{
        //   rs.forEach(r=>{
        //     as.push({
        //       type:1,
        //       apiReplaceEvent:"on",
        //       requests:[r]
        //     })
        //   })
        // }
        rs.forEach(r=>{
          as.push({
            type:1,
            apiReplaceEvent:"on",
            requests:[r]
          })
        })
        if(_stdHeaders){
          rs.forEach(r=>{
            if(!r.headers){
              r.headers=_stdHeaders
            }
          })
        }
        _ideTestManagement._save()
      })
    })

    function _buildUrl(u,ps){
      let h=_Util._retrieveHostFromUrl(u)
      if(!h.match(/[\/]$/)){
        h+="/"
      }
      return h+ps.join("/")
    }
  }
};var _aiAuthHandler={
  _getCurSetting:function(i){
    if(i===undefined){
      i=_aiAuthHandler._getCurHostIdx()
    }
    return _aiAuthHandler._data[i]
  },
  _getCurHostIdx:function(i){
    let t=BZ._getCurTest()
    if(t){
      return t._data.hostId
    }else{
      t=BZ._getCurModule()
      return t?t._data.defaultHostId:0
    }
  },
  _getTokenHostIdxByUIHostIdx:function(i){
    let e=_aiAuthHandler._getCurSetting(i)
    if(e.inAuth&&e.module&&e.token){
      e=_ideObjHandler._getDataByPath(e.module,e.token)
      if(e){
        e=e._data.actions.find(a=>a.tokenHost)
        return e&&e.tokenHost
      }
    }
  },
  _getTakeTokenHostByTokenHostIdx:function(i){
    return _aiAuthHandler._data.findIndex(x=>x.hostToken==i)
  },
  //i: api host idx
  _getToken:function(i){
    i=_aiAuthHandler._getCurSetting(i)
    return i?i.tokenValue:""
  },
  _retrieveToken:function(_testHost,_fun){
    let t=_aiAuthHandler._getCurSetting(_testHost)
    if(t.module&&t.token){
      _ideTask._runTmpTest(t.module+"."+t.token,_fun)
    }else{
      _fun()
    }
  },
  _authSettingOptions:[
    {
      _name:"key",
      _auth:["api"],
      _dynamic:1
    },
    {
      _name:"value",
      _auth:["api"]
    },
    {
      _name:"username",
      _auth:["basic"]
    },
    {
      _name:"password",
      _auth:["basic"]
    },
    {
      _name:"token",
      _auth:["bearer"],
      _dynamic:1
    },
    {
      _name:"Authorization",
      _auth:["digest","oauth1","oauth2","hawk","aws","ntlm","akamai"],
      _dynamic:1
    }
  ],
  _init:function(_fun,_reload){
    _aiAuthHandler._testActionMap={
      _tokenMap:{},
      _verifyTokenExistAction:{
        description:_bzMessage._auth._testDesc._verifyTokenExist,
        "compareMark": "==",
        "type": 0,
        "method": 1,
        "refOfFailed": "./s/",
        "inGroup": "",
        "script": "$util.getTokenByHostId()",
        "refOfSuccess": "../",
        "runInIDE": "on",
        "refOfError": "./s/"
      },
      token:[
        {
          "type": 4,
          "refOfSuccess": "m1.t3/",
          "inGroup": ""
        },
        {
          description:_bzMessage._auth._testDesc._clickTriggerRequest,
          type: 1,
          element: [
            "BZ.TW.document",
            "A",
            0
          ],
          event: {
            type: "mouse",
            action: "click"
          },
          token: "Authorization",
          tokenHost: "0",
          todo:"on",
          note:_bzMessage._auth._testDesc._todoToken
        }
      ],
      hasSign:[
        {
          description:_bzMessage._auth._testDesc._setSignStatus,
          type: 4,
          loopData: "$aiAPI.getAuthFlowByRole($parameter)",
          refOfSuccess: "{{$action.code}}",
          successParameter: "$action.parameter"
        }
      ],
      signIn:[
        //Handler parameter
        {
          description:_bzMessage._setting._objectLib._handleParameter,
          type:3,
          runInIDE:"on",
          script:`$parameter = $aiAPI.getAccount($module.data, $parameter)`
        },
        //Check if you are already logged in.
        {
          description:_bzMessage._auth._testDesc._chkSignIn,
          type: 0,
          method: 0,
          content: {
            type: "exist"
          },
          element: [
            "BZ.TW.document",
            "DIV:Contains({{$parameter.identifier}})",
            0
          ],
          errOnHidden: "on",
          failedReaction: 1,
          refOfSuccess: "../",
          refOfFailed: "m1.t5/s/./",
          resultscript: "(function(){\n  if($result.status=='success'){\n    $aiAPI.assignCurtUser($parameter);\n  }\n})()",
          successParameter: "",
          todo:"on",
          note:_bzMessage._auth._testDesc._todoChkSignIn
        },
        //Fill username
        {
          type: 1,
          element: [
            "BZ.TW.document",
            `:input(${_bzMessage._auth._username})`,
            0
          ],
          event: {
            type: "change",
            value: "{{$parameter.username}}",
            autoBlur: "on"
          },
          todo:"on",
          note:_bzMessage._auth._testDesc._todoUsername
        },
        //Fill password
        {
          type: 1,
          element: [
            "BZ.TW.document",
            `:input(${_bzMessage._auth._password})`,
            0
          ],
          event: {
            type: "change",
            value: "{{$parameter.password}}",
            autoBlur: "on"
          },
          todo:"on",
          note:_bzMessage._auth._testDesc._todoPassword
        },
        //Click login button
        {
          type: 1,
          element: [
            "BZ.TW.document",
            `BUTTON:Contains(${_bzMessage._auth._login})`,
            0
          ],
          event: {
            type: "mouse",
            action: "click"
          },
          resultscript: "(function(){\n  if($result.status==\"success\"){\n    $aiAPI.assignCurtUser($parameter);\n  }\n})()",
          todo:"on",
          note:_bzMessage._auth._testDesc._todoLogin
        },
        //Check if you have successfully logged in
        {
          description:_bzMessage._auth._testDesc._chkSignInSuccess,
          compareMark: "==",
          type: 0,
          method: 0,
          content: {
            type: "exist"
          },
          refOfFailed: "..../",
          element: [
            "BZ.TW.document",
            "BODY:Contains({{$parameter.identifier}})",
            0
          ],
          errOnHidden: "on",
          failedReaction: 1,
          todo:"on",
          note:_bzMessage._auth._testDesc._todoChkSignInOption
        }
      ],
      signInApi:[
        {
          type: 1,
          apiReplaceEvent: "on",
          requests: [
            {
              url: "/api/signin",
              method: "POST",
              host: 0,
              data: {
                username: "{{$parameter.username}}",
                password: "{{$parameter.password}}"
              },
              contentType: "application/x-www-form-urlencoded; charset=UTF-8",
              headers: "{\"Accept\":\"*/*\"}",
              responseStatus: 200
            }
          ],
          todo:"on",
          note:_bzMessage._auth._testDesc._todoSignInApi,
          resultscript: "(function(){\n  if($result.status==\"success\"){\n    $aiAPI.assignCurtUser($parameter);\n  }\n})()"
        },
        {
          type: 6,
          note:_bzMessage._auth._testDesc._todoRefresh
        },
        {
          description:_bzMessage._auth._testDesc._chkSignInSuccess,
          compareMark: "==",
          type: 0,
          method: 0,
          content: {
            type: "exist"
          },
          refOfFailed: "..../",
          element: [
            "BZ.TW.document",
            "BODY:Contains({{$parameter.identifier}})",
            0
          ],
          todo:"on",
          note:_bzMessage._auth._testDesc._todoChkSignInOption,
          errOnHidden: "on",
          failedReaction: 1
        }
      ],
      signOut:[
        //Check if you are already logged in.
        // {
          // description:_bzMessage._auth._testDesc._chkSignOut,
          // compareMark: "==",
          // type: 0,
          // method: 0,
          // content: {
            // type: "exist"
          // },
          // refOfFailed: "../w/",
          // element: [
            // "BZ.TW.document",
            // `:link(${_bzMessage._common._home})`,
            // 0
          // ],
          // todo:"on",
          // note:_bzMessage._auth._testDesc._todoSigninStatus,
          // refOfError: "../w/",
          // failedReaction: 1
        // },
        //Click sign-out
        {
          type: 1,
          element: [
            "BZ.TW.document",
            `:link(${_bzMessage._auth._logout})`,
            0
          ],
          event: {
            type: "mouse",
            action: "click"
          },
          todo:"on",
          refOfError:"../w",
          failedReaction:1,
          note:_bzMessage._auth._testDesc._todoSignout,
          resultscript: "(function(){\n  if($result.status=='success'){\n    $aiAPI.assignCurtUser();\n  }\n})()"
        },
        //Confirm sign-out (Maybe no need)
        {
          description:_bzMessage._auth._testDesc._confirmSignout,
          type: 1,
          element: [
            "BZ.TW.document",
            `:link(${_bzMessage._method._yes})`,
            0
          ],
          event: {
            type: "mouse",
            action: "click"
          },
          todo:"on",
          note:_bzMessage._auth._testDesc._todoConfirmSignout,
          refOfError: "./w/",
          failedReaction: 1
        },
        //Check if signout success
        // {
          // description:_bzMessage._auth._testDesc._chkSignoutSuccess,
          // compareMark: "==",
          // type: 0,
          // method: 0,
          // content: {
            // type: "unexist"
          // },
          // element: [
            // "BZ.TW.document",
            // `:link(${_bzMessage._common._home})`,
            // 0
          // ],
          // todo:"on",
          // note:_bzMessage._auth._testDesc._todoSignOutSuccessOption,
          // failedReaction: 1
        // }
      ],
      signOutApi:[
        {
          type: 1,
          apiReplaceEvent: "on",
          requests: [
            {
              url: "/api/signout",
              method: "POST",
              host: 0,
              headers: "{\"Accept\":\"*/*\"}",
              responseStatus: 200
            }
          ],
          todo:"on",
          note:_bzMessage._auth._testDesc._todoSignOutApi,
          resultscript: "(function(){\n  if($result.status=='success'){\n    $aiAPI.assignCurtUser();\n  }\n})()"
        },
        //Refresh page
        {
          type: 6,
          note:_bzMessage._auth._testDesc._todoRefresh
        },
        //Check if signout success
        {
          description:_bzMessage._auth._testDesc._chkSignoutSuccess,
          compareMark: "==",
          type: 0,
          method: 0,
          content: {
            type: "unexist"
          },
          todo:"on",
          note:_bzMessage._auth._testDesc._todoSignOutSuccessOption,
          element: [
            "BZ.TW.document",
            `A:endContains(${_bzMessage._common._home})`,
            0
          ],
          failedReaction: 1
        }
      ]
    }
    if(!_aiAuthHandler._data||_reload){
      console.log("BZ-LOG: init auth data")
      var s=_IDE._data._setting;
      while(s.environments[0].items.length>s.authList.length){
        s.authList.push({})
      }
      if(s.authList){
        if(s.authList.find(x=>{
          return x&&x.data&&x.data.match(/^d[0-9]+$/)
        })){
          return _localStorageManagement._reloadData()
        }
      }
      _aiAuthHandler._data=_CtrlDriver._buildProxy(s.authList);
      console.log("BZ-LOG: aiAuthHandler.data: "+_aiAuthHandler._data.length)
      // _aiAuthHandler._data.forEach((v,i)=>{
        // if(!v.inAuth){
          // _aiAuthHandler._data[i]={}
        // }
      // })
      _aiAuthHandler._loadAuthModule(_fun)
      _ideTestManagement._shareComIdentifyCss()
      _aiAuthHandler._loadStaticTokenValue()
      
      let _token=_aiAuthHandler._testActionMap._tokenMap=_localStorageManagement._retrieve("bz-auth")||{}

      _IDE._data._setting.environments[_IDE._data._setting.curEnvironment||0].items.forEach((x,i)=>{
        let o=_aiAuthHandler._data[i]=_aiAuthHandler._data[i]||{}
        
        let d=_token[x.host]||{}
        if(d.time&&Date.now()-d.time<10800000){
          o.tokenValue=d.tokenValue
          o.time=d.time
        }
      })
    }else{
      _fun()
    }
  },
  _loadAuthModule:function(_fun,i){
    i=i||0
    for(;i<_aiAuthHandler._data.length;i++){
      var a=_aiAuthHandler._data[i]
      if(!a.module){
        continue
      }
      var m=_ideObjHandler._getDataByPath(a.module)
      if(m&&!m._loaded){
        return _ideModuleManagement._loadItem(m,function(m){
          if(a.token&&a.token.constructor==String&&!_ideObjHandler._getDataByPath(m._data.code,a.token)){
            a.token=""
          }
          if(a.signIn&&!_ideObjHandler._getDataByPath(m._data.code,a.signIn)){
            a.signIn=""
          }
          if(a.signOut&&!_ideObjHandler._getDataByPath(m._data.code,a.signOut)){
            a.signOut=""
          }
          if(a.signOutApi&&!_ideObjHandler._getDataByPath(m._data.code,a.signOutApi)){
            a.signOutApi=""
          }
          if(a.signInApi&&!_ideObjHandler._getDataByPath(m._data.code,a.signInApi)){
            a.signInApi=""
          }
          _aiAuthHandler._loadAuthModule(_fun,i+1)
        })
      }else if(!m){
        a.module=a.token=a.signIn=a.signOut=a.signInApi=a.signOutApi=""
      }
    }
    _fun&&_fun()
  },
  _getAuthFields:function(i){
    let d=_aiAuthHandler._getUserDataMap(i)||{}
    for(var k in d){
      return Object.keys(d[k])
    }
  },
  _isAuthItem:function(k){
    if(k){
      k=_ideObjHandler._getDataByPath(k)
      if(k){
        k=k._parent||k
        k=k._data.definition
        return k&&k.type=="auth"
      }
    }
  },
  _isSignInStatus:function(m,t){
    m=m._data||m;
    t=t._data||t;
    m=m.code||m;
    t=t.code||t;
    return _aiAuthHandler._data.find(o=>{
      return o.module==m&&(o.hasSign==t)
    });
  },
  _isTokenTest:function(t,m){
    t=t||BZ._getCurTest();
    m=m||BZ._getCurModule();
    t=(t._data||t||0).code||t
    m=(m._data||m||0).code||m
    if(t&&m){
      return _aiAuthHandler._data.find(a=>{
        return a.token&&(a.token.code==t||a.token==t)&&a.module&&(a.module==m||a.module.code==m)
      })
    }
  },
  _isSignOut:function(m,t){
    m=m._data||m;
    t=t._data||t;
    m=m.code||m;
    t=t.code||t;
    return _aiAuthHandler._data.find(o=>{
      return o.module==m&&(o.signOut==t||o.signOutApi==t)
    });
  },
  _removeTokenByIdx:function(i){
    //i: api host idx
    _aiAuthHandler._data[i].tokenValue=""
    delete _aiAuthHandler._data[i].tokenValue
    delete _aiAuthHandler._testActionMap._tokenMap[BZ._getCurEnvUrl(i)._url]
    _localStorageManagement._store("bz-auth",_aiAuthHandler._testActionMap._tokenMap)
    _extensionComm._setShareData({"BZ._curEnv":BZ._curEnv,"_IDE._data._setting":_IDE._data._setting})
    _extensionComm._setShareData({"_aiAuthHandler._data":_aiAuthHandler._data})
  },
  _clearTokenByTest:function(m,t){
    m=BZ._getCurModule()
    if(!m){
      return
    }
    t=t||BZ._getCurTest()
    if(!t){
      return
    }
    t=t._data||t
    if(_aiAuthHandler._isSignOut(m,t)){

      let o=_aiAuthHandler._data[t.hostId]
      if(o){
        o=_aiAuthHandler._data[o.hostToken]
        if(o){
          o.tokenValue=0
          delete o.tokenValue
          if(_ideTask._setting.token){
            _ideTask._setting.token.delete(t.hostId)
          }
        }
      }
    }
  },
  _getModule:function(_hostId){
    if(_hostId===undefined){
      if(BZ._getCurTest()){
        _hostId=BZ._getCurTest()._data.hostId
      }else if(BZ._getCurModule()){
        _hostId=BZ._getCurModule()._data.defaultHostId
      }else{
        _hostId=_IDE._data._setting.curEnvironment
      }
    }
    var d=_aiAuthHandler._data[_hostId]
    if(d&&d.module){
      d=_ideObjHandler._getDataByPath(d.module)
      return d&&d._data;
    }
  },
  _openSetting:function(_idx,_userData,_fun){
    var d=_aiAuthHandler._popData=_CtrlDriver._buildProxy(_Util._clone(_aiAuthHandler._data[_idx])),
        _envId=_IDE._data._setting.curEnvironment
    d._idx=_idx;
    d._env=_IDE._data._setting.environments[_envId].items[_idx]
    if(!d._env){
      return
    }
    _aiAuthHandler._assignModuleData(d,1,1)
    _aiAuthHandler._assignTest(d,"signIn",1,1)
    _aiAuthHandler._assignTest(d,"hasSign",1,1)
    _aiAuthHandler._assignTest(d,"signOut",1,1)
    _aiAuthHandler._assignTest(d,"signInApi",1,1)
    _aiAuthHandler._assignTest(d,"signOutApi",1,1)
    _aiAuthHandler._assignTest(d,"token",1,1)

    d.dataScope="$module"
    _aiAuthHandler._assignData(d,1,1)
    
    var btns=[
      {
        _title:!_IDE._data._setting.authList[_aiAuthHandler._popData._idx].inAuth||_aiAuthHandler._popData.module.code?_bzMessage._method._saveData:_bzMessage._method._saveAndGenerate,
        _click:function(dlg){
          if(!_aiAuthHandler._popData.module.name){
            return alert(_bzMessage._system._error._requiredField,_bzMessage._auth._module)
          }
          if(!_aiAuthHandler._popData.module.code){
            _aiAuthHandler._save(function(){
              _final()
            })
          }else{
            let dd=_IDE._data._setting.authList[d._idx]
            dd.tokenErrMsg=d.tokenErrMsg
            dd.tokenKey=d.tokenKey
            dd.hostToken=d.hostToken
            
            if(!dd.module){
              dd.module=d.module?d.module.code||d.module:""
              dd.signIn=d.signIn?d.signIn.code||d.signIn:""
              dd.hasSign=d.hasSign?d.hasSign.code:d.hasSign
              dd.signOut=d.signOut?d.signOut.code||d.signOut:""
              dd.signInApi=d.signInApi?d.signInApi.code||d.signInApi:""
              dd.signOutApi=d.signOutApi?d.signOutApi.code||d.signOutApi:""
              dd.token=d.token?d.token.code||d.token:""
              dd.dataScope=d.dataScope||"$module"
              dd.data=d.data&&"data"
              
            }

            _ideVersionManagement._save(function(){
              _aiAuthHandler._storeData(_aiAuthHandler._popData,function(){
                _final()
              })
            })
            
          }
          
          function _final(){
            BZ._setHash(_aiAuthHandler._popData.module.code)
            $data(_aiAuthHandler._popData.module.code,0,1)
            
            dlg._ctrl._close()
            _DataBuilder._data._dataList=0
          }
        }
      }
    ];
    if(!d.module.code){
      d._generalTests="on"
      d._apiTests="on"
      d._tokenTest="on",
      d.tokenKey="Authorization"
      d.tokenErrMsg="Unauthorized"
    }
    
    if(_userData){
      d.data=_userData
    }

    BZ._data._uiSwitch._skipAuthData=0
    if(d.module.code&&!Object.keys(d.data).length){
      BZ._data._uiSwitch._skipAuthData="on"
    }
    
    if(_userData){
      _aiAuthHandler._save(function(){
        $data(_aiAuthHandler._popData.module.code,0,1)
        _DataBuilder._data._dataList=0
        _fun&&_fun(d)
      })
    }else{
      _Util._confirmMessage(_aiAuthWizardViewDef,btns,_bzMessage._auth._title+_IDE._data._setting.environments[_envId].name+" ("+d._env.name+")","85%",0,0,1);
    }
  },
  _assignModuleData:function(d,_search,_new){
    if(d.module && d.module.constructor==String){
      d.module=_ideObjHandler._getDataByPath(d.module)
      if(d.module){
        d.module=d.module._data
      }
    }
    var ns=[_bzMessage._auth._moduleName,'-',d._env.name]
    if(!d.module&&_search){
      d.module=_ideObjHandler._getSimilarModule(ns.map(function(v){return v.toLowerCase()}),d._idx)
    }
    if(!d.module){
      if(_new){
        d.module={name:ns.join(" ")}
      }else{
        d.module={code:""};
      }
    }
  },
  _getNameKeyByTag:function(_tag){
    switch(_tag){
      case "signIn":return "sign-in";
      case "hasSign":return "has-sign";
      case "signOut":return "sign-out";
      case "signInApi":return "sign-in-api";
      case "signOutApi":return "sign-out-api";
    }
    return "token"
  },
  _assignTest:function(d,_tag,_search,_new){
    var n=_aiAuthHandler._getNameKeyByTag(_tag),dd=d[_tag];
    if(dd&&dd.constructor==String){
      if(d.module.code){
        dd=d[_tag]=_ideObjHandler._getDataByPath(d.module.code,dd)
      }else{
        dd=0
      }
      if(dd){
        dd=d[_tag]=dd._data
      }
    }
    if(!dd&&d.module &&d.module.code && _search){
      dd=d[_tag]=_ideObjHandler._getSimilarTest(d.module.code,n);
    }
    if(!dd){
      if(_new){
        d[_tag]={name:_dictionaryHandler._getWordsByKey(n)[0]}
      }else{
        d[_tag]={code:""};
      }
    }
  },
  _assignData:function(d){
    if(d.data&&d.data.constructor==String){
      d._dataMap={name:d.data,code:d.data};
      d.data=_Util._clone($data(d.module.code)[d.data]||[])
      _Util._resizeModelWindow()
    }else{
      d.data=[{role:"",username:"",password:"",identifier:"",id:""}]
      d._dataMap={name:"data"};
    }
  },
  _save:function(_fun){
    var d=_aiAuthHandler._popData;
    if(d.inAuth){
      _aiAuthHandler._storeModule(d,function(m){
        d.module=m;
        _aiAuthHandler._storeTest(d,"signOut",function(t){
          d.signOut=t
          _aiAuthHandler._storeTest(d,"signIn",function(t){
            d.signIn=t
            _aiAuthHandler._storeTest(d,"signInApi",function(t){
              d.signInApi=t
              _aiAuthHandler._storeTest(d,"signOutApi",function(t){
                d.signOutApi=t
                t.enterPoint.type="followSameURL"
                _aiAuthHandler._storeTest(d,"hasSign",function(t){
                  d.hasSign=t
                  _aiAuthHandler._storeData(d,function(){
                    if(_aiAuthHandler._popData._tokenTest){
                      _aiAuthHandler._storeTest(d,"token",function(t){
                        d.token=t
                        if(BZ._data._uiSwitch._apiAuth){
                          BZ._data._uiSwitch._apiAuth.token=t.code
                        }
                        _aiAuthHandler._storeSetting(d,function(){
                          _fun()
                        })
                      })
                    }else{
                      _aiAuthHandler._storeSetting(d,function(){
                        _fun()
                      })
                    }
                  })
                })
              })
            })
          })
        })
      })
    }else{
      _aiAuthHandler._storeSetting(d,function(){
      })
    }
  },
  _generateTests:function(d,vs){
    if(!vs){
      vs= _CtrlDriver._buildProxy([{_text:d.signOut.name},{_text:d.signIn.name}])
      
      if(d.token.name){
        vs.push({_text:d.token.name})
      }

      if(!_ideTestManagement._getItemByName(_bzMessage._auth._checkTest,d.module)){
        vs.push({_text:_bzMessage._auth._checkTest})
      }
    }
    _ideDataBind._data._scope="$parameter"
    _ideDataBind._data._key="data"
    _ideDataBind._data._limit=0
    _extensionComm._setShareData({"_ideDataBind._data._scope":"$parameter"})
    _extensionComm._setShareData({"_ideDataBind._data._key":"data"})
    _extensionComm._setShareData({"_ideDataBind._data._limit":0})
    
    _IDE._innerWin._data._dataBind._showDataBind=1

    _ideTask._setCurTmpTest(d.module,d.signIn)
    _ideDataManagement._initTmpData()
    _aiExeHandler._launchPageOnly(_Util._mergeURL(d._env.host,d._env.defaultRoot),function(){
      
    })
    BZ._setHash("settingEnvironment")
  },
  _hasAuthRequest:function(rs){
    if(rs.constructor!=Array){
      rs=[rs]
    }
    return rs.find(r=>{
      let h=r.headers||"{}"
      v=_Util._eval("h="+h)
      h=h.Authorization
      if(h){
        return h.match(/^(Bearer|OAuth|Hawk|AWS4-HMAC-SHA256) .+/s)||h.includes(BZ._bzTokenData)
      }
    })
  },
  _storeModule:function(d,_fun){
    let fs=[],_hasOther=0,_errData=[],_hasErr
    for(var k in d.data){
      let o=d.data[k]
      let od=o.other
      try{
        od=_Util._eval("od="+od)
        if(od.constructor==Object){
          if(!_hasOther){
            _hasOther=1
          }else if(_hasOther==-1){
            _hasErr=1
          }
          o=Object.assign(o,od)
          delete(o.other)
        }
      }catch(e){
        _errData.push(k)
        if(_hasOther==1){
          _hasErr=1
        }
      }
      
      if(!fs.length){
        k=Object.keys(o)
        k.forEach(kk=>{
          fs.push({
            name:kk,
            data:kk,
            code:kk,
            type:"string"
          })
        })
      }
    }
    if(_hasErr){
      alert(_bzMessage._system._error._dataFormatError+_errData.join(", "))
    }
    d.module.definition={type:"auth",fields:fs}

    if(!d.module.code){
      d.module.defaultHostId=d._idx
      d.module.rootUrl=d._env.defaultRoot;
      
      d.module.bt="auth"

      _objGenerator._generateModule(d.module,_fun)
    }else{
      _ideModuleManagement._save(d.module,function(){
        _fun(d.module)
      })
    }
  },
  _storeTest:function(d,_tag,_fun){
    var o=d[_tag];
    if(!o.code&&o.name){
      o.type=_tag.endsWith("Api")?"api":"unit";
      if(["hasSign"].includes(_tag)){
        o.subtype="ctrl"
      }else{
        o.subtype="operation"
      }
      o.enterPoint={value:d._env.defaultRoot,type:"follow"};

      o.hostId=d._idx;
      o.synActionDesc="on"
      o.definition={type:_tag}
      if(_tag=="signIn"){
        _aiAuthHandler._testActionMap[_tag][1].refOfFailed=d.module.code+"."+d.signOut.code+"/s/./"
      }else if(_tag=="token"){
        let oo=_Util._clone(_aiAuthHandler._testActionMap[_tag])
        oo[0].refOfSuccess=d.module.code+"."+d.signIn.code+"/s/./"
        let vo=_aiAuthHandler._testActionMap._verifyTokenExistAction
        oo.unshift(vo)
        oo.splice(2,0,vo)
        oo.push(vo)
        _objGenerator._generateTest(d.module,o,oo,_fun)
        return
      }
      _objGenerator._generateTest(d.module,o,_aiAuthHandler._testActionMap[_tag],_fun)
    }else{
      _fun(o)
    }
  },
  _getCurUserName:function(m){
    let lm=_aiAuthHandler._getLinkageModule(m)
    if(lm){
      return _aiGeneratorDataHandler._getCurModuleDataName(lm)
    }
    if(!$.isNumeric(m)){
      m=_aiGeneratorDataHandler._getModuleObject(m)._data.defaultHostId
    }
    return _bzMessage._aiDefinition._curUser+(m||"")
  },
  _getCurUser:function(m){
    return $project[_aiAuthHandler._getCurUserName(m)];
  },
  _getLinkageModule:function(m){
    if(!$.isNumeric(m)){
      m=_aiGeneratorDataHandler._getModuleObject(m)._data.defaultHostId
    }
    m=_aiAuthHandler._getModule(m)
    if(m&&m.definition){
      return m.definition.linkageModule
    }
  },
  _isLinkageModule:function(m){
    let _env=_IDE._data._setting.environments[_IDE._data._setting.curEnvironment]
    return _env.items.find((v,i)=>{
      let mi=_aiAuthHandler._getModule(i)
      if(mi){
        mi=_aiGeneratorDataHandler._getModuleObject(mi)
        if(mi&&mi._data.definition&&mi._data.definition.linkageModule){
          m=m._data||m
          m=m.code||m
          if(mi._data.definition.linkageModule==m){
            return 1
          }
        }
      }
    })
  },
  _loadStaticTokenValue:function(){
    _aiAuthHandler._data.forEach(a=>{
      a.tokenValue=""
      delete a.tokenValue
    })
    _aiAuthHandler._data.forEach(a=>{
      if(a.token&&a.token.constructor==Object){
        let v={}
        switch(a.token.type){
          case "no":v="";break;
          case "api":a.token.key&&(v[a.token.key]=a.token.value);break;
          case "basic":v.Authorization="Basic "+_Util._b64EncodeUnicode(a.token.username+":"+a.token.password);break;
          case "bearer":v.Authorization=a.token.token;break;
          default:v.Authorization=a.Authorization

        }
        _aiAuthHandler._data[a.token.host].tokenValue=v
      }
    })
    
    _extensionComm._setShareData({"_aiAuthHandler._data":_aiAuthHandler._data.map(v=>{
      if(_Util._isEmpty(v.tokenValue)){
        v.tokenValue=""
      }
      return {tokenValue:v.tokenValue}
    })})
  },
  _storeData:function(d,_fun){
    var m=_ideObjHandler._getDataByPath(d.module.code)
    _ideModuleManagement._loadItem(m,function(m){
      d.module=m._data

      m._data.dataMap=[{
        name:"data",
        type:"c",
        value:_csvEditor._objToCSV(d.data)
      }]
      
      _ideModuleManagement._save(m,function(){
        _fun()
      })
    })
  },
  _storeSetting:function(d,_fun){
    var dd=_IDE._data._setting.authList[d._idx]
    dd.module=d.module.code
    dd.signIn=d.signIn.code
    dd.hasSign=d.hasSign.code
    dd.signOut=d.signOut.code;
    dd.signInApi=d.signInApi.code;
    dd.signOutApi=d.signOutApi.code;
    dd.dataScope=d.dataScope
    dd.data=d._dataMap.name

    if(d.token){
      dd.token=d.token.code;
      dd.tokenErrMsg=d.tokenErrMsg
      dd.tokenKey=d.tokenKey
      dd.hostToken=d.hostToken
    }

    _ideVersionManagement._save(_fun)
  },
  // _storeTokenToTmpVariable:function(a,m,t){
  _setToken:function(r){
    if(r.tokenValue){
      var s=_aiAuthHandler._data[r._tokenHost]
      if(_Util._isSameObj(s.tokenValue,r.tokenValue)){
        return
      }
      s.tokenValue=r.tokenValue
      $console.output(_bzMessage._log._info._retrieveToken+":")
      $console.output(r.tokenValue)
      _extensionComm._setShareData({"_aiAuthHandler._data":_aiAuthHandler._data.map(v=>{
        return {tokenValue:v.tokenValue}
      })})
      let _host=_IDE._data._setting.environments[_IDE._data._setting.curEnvironment].items[r._tokenHost].host
      _aiAuthHandler._testActionMap._tokenMap[_host]={tokenValue:r.tokenValue}
      _extensionComm._setShareData({"BZ._curEnv":BZ._curEnv,"_IDE._data._setting":_IDE._data._setting})
      _extensionComm._setShareData({"_aiAuthHandler._data":_aiAuthHandler._data})
    }
    _Util._loopObj(_aiAuthHandler._testActionMap._tokenMap,x=>{
      if(x.tokenValue){
        x.time=Date.now()
      }else{
        delete x.time
      }
    })
    _localStorageManagement._store("bz-auth",_aiAuthHandler._testActionMap._tokenMap)
  },
  _isInSignAPI:function(s){
    let m=BZ._getCurModule(),t=BZ._getCurTest()
    if(m&&t&&m._data.code==s.module&&[s.signInApi,s.signOutApi].includes(t._data.code)){
      return 1
    }
  },
  _assignTokenToAPIRequest:function(a){
    if(a.apiReplaceEvent&&a.requests){
      a.requests.forEach(r=>{
        if(!_apiHandler._isSocketRequest(r)){
          var s=_aiAuthHandler._data[r.host]
          if(!r.autoToken||_aiAuthHandler._isInSignAPI(s)){
            return
          }
          if(s&&s.tokenValue){
            r.headers=_Util._strToJson(r.headers||"{}")
            for(var k in s.tokenValue){
              r.headers[k]=s.tokenValue[k]
            }
          }
        }
      })
    }
  },
  _getHostTokenNames:function(h){
    var d=_aiAuthHandler._data[h]
    if(d&&d.token){
      if(d.token.constructor==Object){
        d=_Util._clone(d.token)
        delete d.host
        delete d.type

        switch(d.type){
          case "no":return;
          case "api":
            return
        }
        return ["Authorization"]
      }else if(d.module&&d.token.match(_IDE._testKeyRegex)){
        d=_ideObjHandler._getDataByPath(d.module,d.token);
        if(d){
          d=d._data.actions.find(a=>{
            return a.token
          })
          if(d){
            return d.token.split(/, */)
          }
        }
      }
    }
  },
  _getCurDataMap:function(d){
    var dm=$data(d.module)||{};
    return dm[d.data]||[]
  },
  _getUserDataMap:function(i){
    let d=_aiAuthHandler._data[i]
    if(!_Util._isEmpty(d)){
      let dd=_aiAuthHandler._getCurDataMap(d)

      for(var k in dd){
        d=dd[k]
        if(d.other){
          try{
            if(d.other&&d.other.match(/\=/)){
              d.other.split(",").forEach(dd=>{
                let v=dd.split("=")
                d[v[0]]=d[v[1]]
              })
              delete d.other
            }else if(d.other&&d.other.match(/^\{.*\}$/)){
              let o;
              o=_Util._eval("o="+d.other)
              for(var kk in o){
                d[kk]=o[kk]
              }
              delete d.other
            }
          }catch(e){}
        }
      }
      return dd
    }
  },
  _getRolesByHostId:function(_hostIdx){
    try{
      var a=_IDE._data._curVersion.setting.authList[_hostIdx],d,dm,t,m;
      d=$data(a.module)[a.data]||[]
      let rs=new Set()
      d=Object.values(d)
      d.forEach(x=>{
        if(x=x.role){
          if(x.constructor==Array){
            x.forEach(y=>rs.add(y))
          }else{
            rs.add(x)
          }
        }
      })
      return [...rs]
    }catch(e){}
  },
  //_host: host, _type: _signIn, _signOut
  _getTestCase:function(_host,_type){
    var d=_aiAuthHandler._data[_host||0];
    return (d[_type]||"")&&(d.module+"."+d[_type])
  }
};var _aiDataHandler={
  _miniMap:{
    _email:"email",
    _phoneNumber:"phone",
    _address:"address",
    _postCode:"postcode",
    _name:"name",
    _text:"text",
    _number:"number",
    _decimal:"decimal",
    _link:"link"
  },
  _init:function(_fun){
    _aiDataHandler._dataReady=0;
    _aiDataHandler._cleanData([_aiWordHandler,_dictionaryHandler,_cssHandler,_descAnalysis])
    if(_aiDataHandler._checkData()){
      return setTimeout(function(){
        _aiDataHandler._registerData(function(){
          _aiDataHandler._sendData()
          if(_fun){
            _fun()
          }
        })
      },1)
    }
  },
  _checkData:function(){
    if(_dictionaryHandler._init()){
      if(_cssHandler._init()){
        if(_descAnalysis._init()){
          return 1
        }
      }
    }
  },
  _cleanData:function(os){
    os.forEach(function(o){
      for(var k in o){
        if(["_typeValue","_fromValue","_keyboardMap"].includes(k)){
          continue
        }
        if(o[k].constructor==Array){
          o[k]=[]
        }else if(o[k].constructor==Object){
          o[k]={}
        }
      }
    })
  },
  //Init _aiWordHandler,_dictionaryHandler,_cssHandler,_descAnalysis data on client side
  _initData:function(d){
    for(var k in d){
      var o=d[k];
      for(var kk in o){
        window[k][kk]=o[kk]
      }
    }
  },
  _sendData:function(){
    if(window.inPlugIn){
      if(_IDE._backgroundReady){
        _extensionComm._setShareData({"_aiDataHandler":{
          _aiWordHandler:_aiWordHandler,
          _dictionaryHandler:_dictionaryHandler,
          _cssHandler:_cssHandler,
          _descAnalysis:_descAnalysis
        }})
        _aiDataHandler._dataReady=1
      }else{
        console.log("BZ-LOG: Wait background info 2")
        _extensionComm._loadPlugCode(function(){
          _aiDataHandler._sendData(1)
        })
      }
    }else{
      _aiDataHandler._dataReady=1
    }
  },
  _registerData:function(_fun,i,j){
    //Ignore on Bug report lib
    if(!window.$data){
      return
    }
    console.log("BZ-LOG: register data ...")
    let o=$data()||{}
    console.log("BZ-LOG: "+Object.keys(o)+":"+o)
    //register $project
    i=i||0;
    j=j||0;
    if(!i&&!j){
      _aiDataHandler._registerItemData($data(),{},BZ._data._curProject,"p")
    }
    var ms=_IDE._data._curVersion.modules, m;
    ms.forEach(m=>{
      if(m.code[0]!='m'){
        return
      }
      /************************************************************************/
      //Remove because conflict with generate RegExp data in $data function
      /************************************************************************/
      // while(m.tests.length>j){
        // _aiDataHandler._registerItemData($data(m.code,m.tests[j].code),{m:m.code,t:m.tests[j].code})
        // return setTimeout(function(){
          // _aiDataHandler._registerData(_fun,i,j+1)
        // },1)
      // }
      // _aiDataHandler._registerItemData($data(m.code),{m:m.code},m,"m")

      // return setTimeout(function(){
        // _aiDataHandler._registerData(_fun,i+1)
      // },1)
    })
    _fun()
  },
  _registerItemData:function(_data,_oExtra,_obj,_type){
    var _from=_aiWordHandler._fromValue._data;
    var _extra=_Util._clone(_oExtra)
    _doData(_data,_extra)
    if(_obj){
      _extra=_Util._clone(_oExtra)
      _doObj(_obj,_type,_extra)
    }
    function _doObj(o,_type,_extra){
      //the data is module name/alias
      _extra.tt="o" //module name
      _aiWordHandler._registerWord(o.name,_type,_from,0,_extra);
      var a=(o.alias||"").split(";");
      
      for(var i=0;i<a.length;i++){
        _aiWordHandler._registerWord(a[i],_type,_from,0,_extra);
      }
    }
    function _doData(o,_extra,_valueOnly){
      //the data is module data
      try{
        for(var k in o){
          if(!_valueOnly){
            _extra.tt="n" //data name
            _aiWordHandler._registerWord(k,"a",_from,0,_extra)
            _extra=_Util._clone(_extra)
          }
          _extra.tt="d"
          var v=o[k];
          if(v.constructor==Object){
            _doData(o[k],_extra)
          }else if(v.constructor==Array){
            if(v[0] && v[0].constructor==Object){
              _doData(v[0],_extra)
            }
            for(var i=1;i<v.length;i++){
              if(v[i].constructor==Object){
                _doData(v[i],_extra,1)
              }else{
                _aiWordHandler._registerWord(v[i],"v",_from,0,_extra)
              }
            }
          }else{
            if(v.length<100){
              _aiWordHandler._registerWord(v,"v",_from,0,_extra)
            }
          }
        }
      }catch(e){}
    }
  }
};var _aiDataUpdateHandler={
  _brackMap:{"]":"[",")":"(","}":"{"},
  //Base on input value to generate update options
  // v: new value
  // _bElement: point out whether the update is from element path
  _getValueOptions:function(v,_bElement){
    var vv=v.match(/\{\{(.+)\}\}/),_list,_text;
    if(vv){
      _list=_getOptionsByCode(vv[1])
      _list.splice(_list.indexOf(vv[1]),1)
      try{
        if(vv[1].trim()!="$"){
          _text=_Util._eval("_text="+vv[1])
        }else{
          return ["$parameter","$test","$module","$project","$loop"]
        }
      }catch(e){}
    }else if(_bElement){
      vv=v.match(/\((.+)\)/);
      if(!vv){
        _list=_getOptionsByText(v,1)
      }else{
        _list=_getOptionsByText(vv[1],1)
      }
    }else{
      _list=_getOptionsByText(v,0)
    }
    if(vv){
      _list.forEach(function(a,i){
        var vvv=vv[0].replace(vv[1],a)
        _list[i]=vv?v.replace(vv[0],vvv):a;
      })
      if(_text){
        if(vv[0][0]=="{"){
          _list.push(v.replace(vv[0],_text))
        }else{
          _list.push(v.replace(vv[1],_text))
        }
      }
    }
    return [... new Set(_list)];
    function _getOptionsByCode(c){
      if(!_IDE._data._curTest){
        return []
      }
      var ps=["$test","$module","$project"],rs=[];
      if(_IDE._data._curTest._data.loopData && _IDE._data._curTest._data.loopData.loopValue){
        ps.unshift("$loop")
      }
      //1. Handle $parameter alone. like: 
      //$parameter --> $parameter.name, $test.name, $test.data.name
      if(c=="$parameter"){
        _replaceParameterAlone(rs,ps)
        return rs
      }
      
      if($parameter&&![Object,Array].includes($parameter.constructor)){
        rs.push("$parameter")
      }
      ps.unshift("$parameter")

      //handle orgData, like:
      //$test.data.name -->        $test,data,name
      //$test[$parameter].name --> $test,,name
      //$test.name -->             $test,name
      var cc=c.split(/\[\$parameter\]|\./),f=[""];
      for(var i=1;i<cc.length;i++){
        if(cc[i]){
          f[i]=cc[i].match(/\(.*\)/)||""
          if(f[i]){
            cc[i]=cc[i].replace(f[i],"")
          }
        }
      }
      
      var c2=cc[cc.length-1]
      if(c2 && c[0]!="$parameter"){
        //$test.data.name --> $parameter.name
        rs.push("$parameter."+c2)
        
        //extra: find the same attribute name in diff data
        //$test.data.name --> $test.name, $test.user.name, $test.role.user.name
        if(cc[0]){
          try{
            var v=_Util._eval("v="+cc[0])
            v=_findSameAttributeNameData(v,c2,cc[0])
            v.forEach(function(vv){
              if(vv!=c){
                rs.push(vv)
              }
            })
          }catch(e){}
        }
      }
      
      
      //2. replace root scope, like:
      //$test.data.name --> $module.data.name
      ps.forEach(function(x,i){
        if(x!=cc[0]){
          var xx=c.replace(cc[0],x);
          if(!xx.includes("$parameter")){
            try{
              var xv=undefined;
              xv=_Util._eval("xv="+xx)
            }catch(e){}
            if(xv===undefined){
              if(cc[0]=="$parameter"||"$loop"==cc[0]){
                var oo=_Util._eval("oo="+x)
                for(var k in oo){
                  var o=oo[k]
                  if(o.constructor==Object && k!=cc[1]){
                    xx=c.replace(cc[0],x+"."+k);
                    xv=undefined
                    try{
                      xv=_Util._eval("xv="+xx)
                    }catch(e){}
                    if(xv!==undefined){
                      rs.push(xx)
                    }
                  }
                }
                return
              }
            }
          }
          if(rs.includes(xx)){
            return
          }
          rs.push(xx)
        }
      })
      
      //3. use $parameter to replace
      if(!c.includes("$parameter")){
        for(var i=1;i<cc.length;i++){
          var k=""
          for(var n=0;n<cc.length;n++){
            if(n!=i){
              if(n){
                k+="."
              }
              k+=cc[n]+f[n]
            }else{
              k+="[$parameter]"
            }
          }
          rs.push(k)
        }
      }
      
      
      var o=0;
      try{
        o=_Util._eval("o="+cc[0])
      }catch(e){}
      if(!o){
        return rs
      }
      //4. replace $parameter in second level
      if(cc[1]===""){
        for(var k in o){
          if(!cc[2]){
            if(![Object,Array].includes(o[k].constructor) && (!_bElement || !_Util._isFileData(o[k]))){
              rs.push(cc[0]+"."+k)
            }
          }else {
            var oo=o[k][cc[2]]
            if(oo!==undefined){
              rs.push(cc[0]+"."+k+"."+cc[2]+(oo.constructor==Function?"()":"")+(cc[3]?"."+cc[3]:""))
              if(cc[3] && o[k][cc[2]].constructor==Object){
                for(var kk in o[k][cc[2]]){
                  if(kk!=cc[3]){
                    rs.push(cc[0]+"."+k+"."+cc[2]+"."+kk+(o[k][cc[2]][kk].constructor==Function?"()":""))
                  }
                }
              }else{
                for(var kk in o[k]){
                  if(kk!=cc[2]){
                    rs.push(cc[0]+"."+k+"."+kk+(o[k][kk].constructor==Function?"()":""))
                  }
                }
              }
            }
          }
        }
      }else if(cc[2]===""){ //5. replace $parameter in third level
        var oo=o[cc[1]]
        if(oo && oo.constructor==Object){
          for(var k in oo){
            if(oo[k]!==undefined&&oo[k]!==null){
              rs.push(cc[0]+"."+cc[1]+"."+k+(oo[k].constructor==Function?"()":"")+(cc[3]?"."+cc[3]:""))
            }
          }
        }
      }else if(cc[3]===""){ 
        //5. replace $parameter in forth level
        var oo=o[cc[1]][cc[2]]
        if(oo && oo.constructor==Object){
          for(var k in oo){
            rs.push(cc[0]+"."+cc[1]+"."+cc[2]+"."+k)
          }
        }
      }else{
        //6. replace last level
        //$test.data.admin.name --> $test.data.admin.value
        //$test.data.name --> $test.data.value
        //$test.name --> $test.value 
        try{
          var oo=_Util._eval("oo="+c);
          var ff=_Util._isFileData(oo)
          var pk=cc[0];
          for(var i=1;i<cc.length-1;i++){
            o=o[cc[i]]
            pk+="."+cc[i]
          }
          for(var k in o){
            if(k!=c2){
              var fff=_Util._isFileData(o[k])
              if(o[k].constructor==oo.constructor && ff==fff){
              }else if(o[k].constructor==Array && fff && ff){
              }else if(oo.constructor==Function && (o[k].constructor!=Array || !fff)){
              }else{
                continue
              }
              rs.push(pk+"."+k+(o[k].constructor==Function?"()":""))
            }
          }
        }catch(e){}
      }
      return rs
    }
    
    function _findSameAttributeNameData(o,n,p,gs){
      gs=gs||[]
      for(var k in o){
        if(o[k] && Object==o[k].constructor){
          _findSameAttributeNameData(o[k],n,p+"."+k,gs)
        }else if(o[k] && Array==o[k].constructor){
        }else{
          if(k==n){
            gs.push(p+"."+k)
          }
        }
      }
      return gs
    }
    //$parameter --> $parameter.name, $test.name, $test.data.name
    function _replaceParameterAlone(rs,ps){
      if($parameter && $parameter.constructor!=Object){
        ps.unshift("$parameter")
      }
      ps.forEach(function(p,i){
        try{
          var pp=_Util._eval("pp="+p)
          _filterMap(pp,1,function(v,p){
            if(v.constructor==Function){
              p+="()"
            }
            rs.push(p)
          },p)
        }catch(e){}
      })
    }
    
    function _filterMap(o,_levelLimit,_fun,_path){
      if(o && o.constructor==Object){
        for(var k in o){
          _filterMap(o[k],_levelLimit,_fun,_path+"."+k)
          if(_levelLimit && _path.split(".").length==2 && o[k].constructor==Object){
            break
          }
        }
      }else if(o && o.constructor!=Array){
        _fun(o,_path)
      }
    }

    /***************************************************
    * handle Text to code
    ***************************************************/
    function _getOptionsByText(t){
      var ps=["$parameter","$loop","$test","$module","$project"],rs=[]
      ps.forEach(function(x,i){
        try{
          var pv=_Util._eval("pv="+x);
          _filterMap(pv,1,function(v,p){
            _insertTxtOption(t,p,v,rs)
          },x)
        }catch(e){}
      })
      return rs;
    }
    
    function _insertTxtOption(t,k,v,rs){
      if(!_Util._isFileData(v)){
        k="{{"+k;
        if(v.constructor==Function){
          rs.push(k+"()}}")
        }else{
          k+="}}"
          if(t.includes(v)){
            rs.unshift(t.replace(v,k))
          }
        }
      }
    }
  },
  /*******************************************
  *
  * Do Update Job
  *
  ********************************************/
  _buildTestAIUpdateOptions:function(v1,v2,_type,_action){
    let t=_IDE._data._curTest
    if(!t||t._data.type=="_try"){
      return
    }
    BZ._data._uiSwitch._createBindData=0
    _action=_action||_IDE._data._curAction;
    if(v1==v2){
      return []
    }
    var us=[],as=t._data.actions;
    var n=as.indexOf(_action),_diff=_aiDataUpdateHandler._getDiff(v1,v2);
    for(var i=n;i<as.length;i++){
      var a=as[i],u=[];
      if(_type.startsWith("requests[")){
        a.requests&&a.requests.forEach((ar,ri)=>{
          _addItem(ar.url,"requests["+ri+"].url",u)
          _addItem(ar.data,"requests["+ri+"].data",u)
        })
      }else if(!_type.includes("refOf")){
        if(a.element){
          a.element.forEach(function(v,i){
            if(i && !$.isNumeric(v)){
              _addItem(v,"element["+i+"]",u)
            }
          })
        }
        if(a.event){
          _addItem(a.event.value,"event.value",u,a.element)
          _addItem(a.event.groupKeys,"event.groupKeys",u,a.element)
        }else if(a.expection){
          if(a.content && a.content.type=="data"){
            var uu=[]
            _addItem("{{"+a.expection+"}}","expection",uu)
            if(uu.length){
              var x=uu[0]._old
              uu[0]._old=x.substring(2,x.length-2)
              x=uu[0]._new
              uu[0]._new=x.substring(2,x.length-2)
              u.push(uu[0])
            }
          }else{
            _addItem(a.expection,"expection",u)
          }
        }
      }else{
        _addItem(a.refOfSuccess,"refOfSuccess",u)
        _addItem(a.refOfFailed,"refOfFailed",u)
        _addItem(a.refOfError,"refOfError",u)
      }
      if(i==n){
        for(var q=0;q<u.length;q++){
          if(_type.includes(u[q].k)){
            u.splice(q,1);
            q--
          }
        }
      }
      if(u.length){
        us[i]=u
      }
    }
    if(us.length){
      t._updates=us
    }
    function _addItem(v,k,u,_elementPath){
      if(v){
        v=_JSHandler._formatInsertCodeToDisplay(v);
        var vv=_aiDataUpdateHandler._getUpdateCode(v,_diff)
        if(vv && vv!=v){
          u.push({_old:v,_new:vv,k:k})
        }else if(_elementPath){
          vv=_aiDataUpdateHandler._getUpdateCodeForNewData(v,_diff,_elementPath)
          if(vv && vv!=v){
            u.push({_old:v,_new:vv,k:k,_newData:1})
          }
        }
      }
    }
  },
  _getDiff:function(v1,v2){
    //v1=_JSHandler.
    var vs=this._getDiffItems(v1,v2);
    vs.forEach(function(v,i){
      if(v._fromCode && v._toCode){
        vs[i]=_aiDataUpdateHandler._getDiffCode(v._fromCode,v._toCode)
      }
      _aiDataUpdateHandler._getOthTxtToCode(v._fromTxt,v._toCode,vs,v)
      _aiDataUpdateHandler._getOthTxtToCode(v._toTxt,v._fromCode,vs,v,1)
    })
    return vs
  },
  _getOthTxtToCode:function(_txt,_code,_group,_curValue,_back){
    if(_txt && _code && !_code.endsWith("[$parameter]")){
      try{
        var v=_Util._eval("v="+_code)
        if(v==_txt){
          var a=_code.substring(_code.lastIndexOf(".")+1)
          _code=_code.substring(0,_code.length-a.length-1)
          if(_code){
            var o=_Util._eval("o="+_code)
            for(var k in o){
              var oo=o[k]
              if(k!=a && oo!=_txt && oo.constructor!=Object && oo.constructor!=Array){
                if(_back){
                  _group.push({_toTxt:oo,_fromCode:_code+"."+k})
                }else{
                  _group.push({_fromTxt:oo,_toCode:_code+"."+k})
                }
              }
            }
          }
        }
      }catch(e){
        if(!_back){
          _curValue._newData=1
          return _Util._confirmMessage(_Util._formatMessage(_bzMessage._dataBind._askBuildData,[_code]),[
            {
              _title:_bzMessage._method._yes,
              _click:function(_this){
                _this._ctrl._close();
                _aiDataUpdateHandler._bindAndGenerateData("{{"+_code+"}}",_txt,0,function(){
                  BZ._data._uiSwitch._createBindData=1
                })
              }
            }
          ]);
        }
      }
    }
  },
  _bindAndGenerateData:function(_value,_tmpValue,_replace,_funMain,_delayStoreData,_noAsk){
    
    if(bzTwComm._isExtension()){
      bzTwComm._postToIDE({_fun:"_bindAndGenerateData",_scope:"_aiDataUpdateHandler",_args:[{_value:_value,_tmpValue:_tmpValue}]});
      return 
    }else if(_value._value){
      _tmpValue=_value._tmpValue
      _value=_value._value
    }
    
    var v,d={};
    let vv=_value.match(/^{{(.+)}}$/)
    if(vv){
      _value=vv[1]
    }else{
      return
    }
    d[_value]=_tmpValue
    _extensionComm._setShareData(d)
  //exist data
    try{
      if(!_value.endsWith("()")){
        v=_Util._eval("v="+_value)
      }
      if(_value.endsWith("()")){
        return _funMain?_funMain(_value):""
      }
    }catch(e){}
    var ps=_value.split(".");
    if(["$test","$module","$project"].includes(ps[0])){
      if(_Util._isRegexData(_ideDataHandler._getOrgDataSettingFromNamePath(_value))){
        return _funMain?_funMain(_value):""
      }
    }
    if(ps.length>4 || (ps.length<2 && ps[0]!="$parameter" && ps[0]!="$loop")){
      return alert(_bzMessage._system._error._dataFormatError)
    }
    if(ps[0]=="$module"){
      if(_delayStoreData){
        _doBind()
      }else if(!_IDE._data._curModule._data.lockBy){
        _doBind(function(){
          _ideModuleManagement._save(_IDE._data._curModule._data)
        });
      }else if(_IDE._data._curModule._data.lockBy!=curUser.code){
        return _userManagement._findItem(_IDE._data._curModule._data.lockBy,function(u){
          alert(_Util._formatMessage(_bzMessage._system._info._dataLocked,["$module",u.displayName]));
        });
      }else{
        _doBind(function(){
          _ideModuleManagement._save(_IDE._data._curModule._data)
        })
      }
    }else if(ps[0]=="$project" && (!_IDE._data._curVersion.lockBy || _IDE._data._curVersion.lockBy!=curUser.code)){
      if(_delayStoreData){
        _doBind()
      }else if(!_IDE._data._curVersion.lockBy){
        _doBind(function(){
          _ideVersionManagement._save()
        });
      }else if(_IDE._data._curVersion.lockBy!=curUser.code){
        return _userManagement._findItem(_IDE._data._curVersion.lockBy,function(u){
          alert(_Util._formatMessage(_bzMessage._system._info._dataLocked,["$project",u.displayName]));
        });
      }else{
        _doBind(function(){
          _ideVersionManagement._save()
        })
      }
    }else{
      _doBind(function(){
        if(ps[0]=="$test"){
          window.$test=_ideDataHandler._generateNameData(_IDE._data._curTest._data.dataMap);
          _extensionComm._setShareData({"$test":$test})
        }else{
          _extensionComm._setShareData({"$parameter":$parameter})
        }
      })
    }
    
    
    function _doBind(_fun){
      var _name=ps[ps.length-1],_namePath=ps[0];
      var _dataMap=_namePath=="$parameter"?0:_namePath=="$test"?_ideDataManagement._getCurTestDataMap():_namePath=="$module"?_ideDataManagement._getCurModuleDataMap():_ideDataManagement._getDataMap();
      if(ps.length>=3){
        _namePath+="."+ps[1]
      }
      var $d=_Util._eval(_namePath);
      
      var o={};
      o[_name]=_tmpValue;
      var _parentData=_ideDataHandler._getDataPathFromNamePath(_namePath);
      if(!_parentData){
        if(ps.length>=3){
          var oo={}
          $d=_Util._eval(ps[0]);
          if(ps.length==4){
            oo[ps[2]]=o;
            o=oo;
            oo={}
          }
          oo[ps[1]]=o;
          $d[ps[1]]=o;
          $d=_Util._eval(_namePath);
          if(ps.length==3){
            _ideDataHandler._newItem(_dataMap,ps[1],"o",o);
          }else{
            _ideDataHandler._newItem(_dataMap,ps[1],"m",o);
          }
        }else if(_namePath=="$parameter"){
          var s=_IDE._data._curTest._data.defParameter||""
          if(s&&s.constructor==String){
            try{
              s=_Util._eval("s="+s)
            }catch(e){}
          }
          if(_name!=_namePath){
            if(!s||!s[_name]||!_Util._isRegexData(s[_name])){
              if(s.constructor!=Object){
                s={}
              }
              if(!$parameter){
                _IDE._data._curTest._showTextarea=1
                BZ._data._uiSwitch._curDefParameterView="$parameter"
                BZ._data._uiSwitch._curDefParameterFormatTab="_json"
              }
              $parameter=s
              $parameter[_name]=_tmpValue
              _IDE._data._curTest._data.defParameter=JSON.stringify($parameter,0,2);
            }else{
              _doIt()
              if(_fun){
                _fun()
              }
              return
            }
          }else{
            $parameter=_IDE._data._curTest._data.defParameter=_tmpValue
          }
          
          //sync parameter window
          if(BZ._data._uiSwitch._curDefParameterView=="$parameter"&&BZ._data._uiSwitch._curDefParameterFormatTab=="_form"){
            BZ._data._uiSwitch._curDefParameterFormatTab="_json"
            //setTimeout('BZ._data._uiSwitch._curDefParameterFormatTab="_form"',100)
          }
        }
        _doIt()
      }else{
        _parentData=_parentData.split(".");
        _parentData=_parentData[_parentData.length-1]
        var _data;
        if(ps.length<=3){
          _data=_ideDataHandler._getDataPathFromNamePath(_namePath+"."+_name);
        }else if(ps.length==4){
          _data=_ideDataHandler._getDataPathFromNamePath(_namePath+"."+ps[2]+"."+_name);
        }
        if(!_data){
          if(_parentData=="v"){
            _ideDataHandler._newItem(_dataMap,"p",o);
          }else{
            if(ps.length==3){
              _ideDataHandler._newSubItem(_dataMap,_parentData,{key:_name,value:_tmpValue});
            }else{//matrix
              //_ideDataHandler._newSubItem(_dataMap,_parentData,{k:ps[2]+"."+ps[3],v:_tmpValue});
            }
          }
          _doIt()
        }else if(_noAsk){
          _doUpdateData(_data,_tmpValue)
        }else{
          window.open("","bz-master")
          if(ps.length==4){
            _namePath+="."+ps[2]
          }
          return _Util._confirmMessage(_Util._formatMessage(_bzMessage._system._info._updateData,[_namePath+"."+_name+" = "+v]),[
            {
              _title:_bzMessage._method._yes,
              _click:function(_this){
                _doUpdateData(_data,_tmpValue)
                _this._ctrl._close();
              }
            }
          ]);
        }
      }
      if(_fun){
        _fun()
      }
      function _doIt(){
//        $data[_name]=_tmpValue;
        if(_replace){
          _value=_value.replace(/\.[a-zA-Z0-9]+\./,"[$parameter].")
        }
        _funMain?_funMain(_value):""
      }
      function _doUpdateData(_data,_tmpValue){
        _data=_data.split(".");
        for(var i=1;i<_data.length-1;i++){
          _dataMap=_dataMap[_data[i]];
        }
        _dataMap[_data[i]]=_tmpValue;
        _doIt()
        if(_fun){
          if(BZ._isRecording()){
            _ideDataManagement._assignCurData()
          }
          _fun()
        }
      }
    }
    
  },
  _getDiffItems:function(v1,v2){
    var r=[]
    if(v1!=v2 && v1 && v2){
      if(v1.constructor==String && v2.constructor==String){
        r=[{_fromTxt:v1,_toTxt:v2}]
      }
      if(v1.constructor==String){
        v1=_JSHandler._parseCode(v1,0,0,1);
      }
      if(v2.constructor==String){
        v2=_JSHandler._parseCode(v2,0,1,1,1);
        if(v2._hasErr){
          delete v2._hasErr
          return
        }
        delete v2._hasErr
      }
      if(v1.constructor==v2.constructor){
        if(v1.constructor!=String){
          //like:
          //  {{$test.data.name}} --> {{$test.data.value}}
          //  {{$test.data1.name}} --> {{$test.data2.value}}
          //  {{$test.data.name}} --> {{$module.data.value}}
          for(var i=0;i<v2.length;i++){
            for(var n=0;n<v1.length;n++){
              if(JSON.stringify(v1[n])==JSON.stringify(v2[i])){
                if(i==1 && n==1){
                  r=r.concat(_aiDataUpdateHandler._getDiffItems([v1[0]],[v2[0]]))
                }
                v1=v1.slice(n+1)
                v2=v2.slice(i+1)
                n=-1
              }
            }
          }
          if(v1.length==1 && v2.length==1){
            r.push({
              _fromTxt:v1[0].txt,
              _fromCode:v1[0].code,
              _toTxt:v2[0].txt,
              _toCode:v2[0].code
            })
          }
        }else{
          v=v1.length>v2.length?v2:v1;
          var _diff1=_diff2="",s1=v1.length-v.length;s2=v2.length-v.length
          for(var i=0;i<v.length;i++){
            if(v1[i]!=v2[i]){
              for(var ii=v.length-1;ii>=0;ii--){
                if(v1[ii+s1]!=v2[ii+s2]){
                  _diff1=v1.substring(i,ii+1+s1)
                  _diff2=v2.substring(i,ii+1+s2)
                  i--;
                  for(;i>=0;i--){
                    if(!v[i].match(/[^a-z0-9\u4E00-\u9FCC]/ig)){
                      _diff1=v[i]+_diff1
                      _diff2=v[i]+_diff2
                    }else{
                      break
                    }
                  }
                  ii++;
                  for(;ii<v.length;ii++){
                    if(!v[ii].match(/[^-a-z0-9\u4E00-\u9FCC]/ig)){
                      _diff1+=v[ii+s1]
                      _diff2+=v[ii+s2]
                    }else{
                      break
                    }
                  }
                  r.push({_fromTxt:_diff1,_toTxt:_diff2})
                  break
                }
              }
              break
            }
          }
        }
      }else if(v1.constructor==String){
        //like: 
        //  abcxyz --> abc{{$test.name}}
        //  abcxyz --> {{$test.name}}xyz
        //  abcxyz --> ab{{$test.name}}yz
        for(var i=0;i<v2.length;i++){
          var v=v2[i].txt
          if(v){
            if(i==0 && v1.startsWith(v)){
              v1=v1.substring(v.length)
              v2.shift()
              i--
            }else if(i==v2.length-1 && v1.endsWith(v)){
              v1=v1.substring(0,v1.length-v.length)
              v2.pop()
            }else if(i!=0 && i!=v2.length-1 && v1.includes(v)){
              var vv=v1.split(v)
              if((vv[0] && vv.length==2) || (vv.length>2)){
                if(!vv[0]){
                  vv[0]=v+vv[1]
                  vv[1]=vv[2]
                }
                r=r.concat(_aiDataUpdateHandler._getDiffItems(vv[0],v2.slice(0,i)))
                r=r.concat(_aiDataUpdateHandler._getDiffItems(vv[1],v2.slice(i+1)))
                return r
              }
            }
          }
        }
        if(v1){
          if(v2.length==1){
            //like: abc --> {{$test.name}}
            r.push({_fromTxt:v1,_toCode:v2[0].code})
          }else{
            //  abcxyz --> d{{$test.name}}e, {{$test.name}}e, d{{$test.name}}
            for(var i=0;i<v2.length;i++){
              if(v2[i].code){
                var v=_getValueFromCode(v2[i])
                if(v && v1.includes(v)){
                  r.push({_fromTxt:v,_toCode:v2[i].code})
                  var i=v1.indexOf(v);
                  v1=v1.substring(i+v.length)
                }
              }
            }
          }
        }
      }else{
        r=_aiDataUpdateHandler._getDiffItems(v2,v1)
        r.forEach(function(v,i){
          var o={}
          o._toTxt=v._fromTxt
          o._toCode=v._fromCode
          o._fromTxt=v._toTxt
          o._fromCode=v._toCode
          r[i]=o
        })
      }
    }
    
    return r

    function _getValueFromCode(c){
      try{
        var v=_Util._eval("v="+c)
        return v
      }catch(e){}
    }
  },
  _getDiffCode:function(s1,s2){
    if(s1==s2){
      return
    }
    var l1=s1.length,l2=s2.length,p="",e="",ee=[];
    var l=Math.min(l1,l2)
    for(var i=0;i<l;i++){
      var c1=s1[l1-i-1]
      var c2=s2[l2-i-1]
      if(c1!=c2){
        break
      }
      if(")]}".includes(c1)){
        p=c1+p;
      }else if("([{".includes(c1)){
        if(c1==_aiDataUpdateHandler._brackMap[p[0]]){
          p=p.substring(1)
          if(!p){
            _addItem(i)
          }
        }else{
          return
        }
      }else if("."==c1 && !p){
        _addItem(i)
      }
      e=c1+e;
      if(e.length==1 && ee.length){
        ee[0]=e+ee[0]
      }
    }
    
    return {_fromCode:s1,_toCode:s2,_end:ee}
    
    function _addItem(i){
      if(e[e.length-1]=="."){
        e=e.substring(0,e.length-1)
      }
      ee.unshift(e)
      e=""
      s1=s1.substring(0,l1-i-1)
      s2=s2.substring(0,l2-i-1)
    }
  },
  _getUpdateCodeForNewData:function(w,_diffs,_elementPath){
    if(_JSHandler._parseCode(w).constructor!=String){
      return
    }
    
    for(var i=0;i<_diffs.length;i++){
      var d=_diffs[i]
      if(d._newData){
        var _name=_descAnalysis._findLabelFromInputElementPath(_elementPath)
        if(_name){
          _code=_Util._replaceLast(d._toCode,"."+_name,".")
          _diffs.push({_extraData:1,_fromTxt:w,_toCode:_code})
          return "{{"+_code+"}}";
        }
      }
    }
  },
  _getUpdateCode:function(w,_diffs){
    var rw="",www="",d;
    w=_JSHandler._parseCode(w,0,0,0,1);
    if(w.constructor==String){
      w=[{txt:w}]
    }else if(w._hasErr){
      delete w._hasErr
      return
    }
    delete w._hasErr
    for(var i=0;i<_diffs.length;i++){
      d=_diffs[i]
      if(d._fromTxt){
        for(var n=0;n<w.length;n++){
          var ww=w[n]
          if(!ww._done && ww.txt && ww.txt.includes(d._fromTxt)){
            if(d._toTxt){ //Replace Txt To Txt
              www=ww.txt.replace(d._fromTxt,d._toTxt)
              if(www!=ww.txt){
                ww.txt=www
                delete ww.code
                ww._done=1
              }
            }else{ //Replace Txt To Code
              www=ww.txt.split(d._fromTxt)
              if(www.length>1){
                ww._data=[];
                var x=0
                for(var j=0;j<www.length;j++){
                  var jw=www[j]
                  if(jw){
                    if(_Util._isBetweenWords(jw,x)){
                      ww._data.push({txt:jw})
                    }else{
                      if(x){
                        ww._done--;
                        ww._data.pop();
                        ww._data.push({txt:d._fromTxt})
                      }
                      ww._data.push({txt:jw})
                      if(x){
                        x=0
                        if(!_Util._isBetweenWords(jw,x)){
                          ww._data.push({txt:d._fromTxt})
                          continue
                        }
                      }else{
                        ww._data.push({txt:d._fromTxt})
                        continue
                      }
                    }
                  }
                  if(j<www.length-1){
                    x=1
                    ww._done=(ww._done||0)+1
                    ww._data.push({code:d._toCode})
                  }
                }
                if(!ww._done){
                  delete ww._data
                }else{
                  w.splice(n,1)
                  for(var q=0;q<ww._data.length;q++){
                    var p=ww._data[q];
                    p._done=1
                    w.splice(n+q,0,p)
                  }
                }
              }
            }
          }
        }
      }else if(d._toTxt){ //Replace Code to Txt
        for(var n=0;n<w.length;n++){
          var ww=w[n]
          if(!ww._done && ww.code && ww.code.includes(d._fromCode)){
            www=_Util._replaceWord(ww.code,d._fromCode,String.fromCharCode(0))
            if(www!=ww.code){
              if(www.length==1){
                ww.txt=d._toTxt
                delete ww.code
              }else{
                ww.code=www.replace(new RegExp(String.fromCharCode(0),"g"),'"'+d._toTxt+'"')
                delete ww.txt
              }
              ww._done=1
            }
          }
        }
      }else if(d._fromCode){ //Replace Code to Code
        for(var n=0;n<w.length;n++){
          var ww=w[n]
          if(!ww._done && ww.code){
            var cc=d._fromCode;
            for(var j=d._end.length-1;j>=0;j--){
              var gc=_groupCode(d,j)
              var xw=_Util._replaceWord(ww.code,d._fromCode+gc,d._toCode+gc);
              if(xw!=ww.code){
                ww.code=xw;
                delete ww.txt
                ww._done=1
                if(j<d._end.length-2){
                  ww._warning=1
                }
              }
            }
            var xw=_Util._replaceWord(ww.code,d._fromCode,d._toCode);
            if(xw!=ww.code){
              ww.code=xw;
              delete ww.txt
              ww._done=1
              if(d._end.length>1){
                ww._warning=1
              }
            }
          }
        }
      }
    }
    return _JSHandler._formatInsertCodeToDisplay(w);
    function _groupCode(v,z){
      var cc=""
      for(var q=0;q<=z;q++){
        cc+=v._end[q]
      }
      return cc
    }
  },
  _doUpdateItem:function(us,ui,i,_inBatch){
    var u=us[ui][i];
    var a=_IDE._data._curTest._data.actions[ui]
    var v=_JSHandler._formatInsertCodeToData(u._new)
    if(u.k.includes("event")){
      var k=u.k.split(".")
      a.event[k[k.length-1]]=v
    }else{
      _Util._eval("a."+u.k+"=v",{v:v,a:a})
    }
    this._cancelUpdateItem(us,ui,i)
    
    if(_inBatch && u._newData){
      _inBatch.push(u)
    }else if(BZ._data._uiSwitch._createBindData && u._newData){
      _aiDataUpdateHandler._bindAndGenerateData(u._new,u._old,0)
    }
    if(!_inBatch){
      _ideTestManagement._save()
    }
  },
  _cancelUpdateItem:function(us,ui,i){
    var u=us[ui];
    u.splice(i,1);
    if(!u.length){
      us[ui]=null
    }
    for(i=0;i<us.length;i++){
      if(us[i]){
        return
      }
    }
    while(us.length){
      us.pop()
    }
  },
  _updateAll:function(){
    var us=_IDE._data._curTest._updates,_inBatch=[];
    
    for(var i=0;i<us.length;i++){
      var u=us[i];
      
      for(var n=0;u && n<u.length;n++){
        _aiDataUpdateHandler._doUpdateItem(us,i,n,_inBatch)
      }
    }
    if(BZ._data._uiSwitch._createBindData){
      for(var i=0;i<_inBatch.length;i++){
        var u=_inBatch[i]
        if(i==_inBatch.length-1){
          _aiDataUpdateHandler._bindAndGenerateData(u._new,u._old,0)
        }else{
          _aiDataUpdateHandler._bindAndGenerateData(u._new,u._old,0,0,1)
        }
      }
    }
    _ideTestManagement._save()
  },
  _cancelAll:function(){
    var us=_IDE._data._curTest._updates;
    for(var i=0;i<us.length;i++){
      var u=us[i];
      
      for(var n=0;u && n<u.length;n++){
        _aiDataUpdateHandler._cancelUpdateItem(us,i,n)
      }
    }
  },
  _updateData:function(d){
    var i=Object.keys(d._data).length
    for(var k in d._data){
      var v=d._data[k]
      var p=d._path+"."+k
      i--
      _aiDataUpdateHandler._bindAndGenerateData("{{"+p+"}}",v,0,function(){},i,1)
    }
  }
};/*
page data constructor:
  U: url,
  _allElementKeys: Element key list in String
  _newElementKeys: New Element List toString (new element of current page)
  _newElementMap: New Element Map

Element data constructor:
  K: element key (For search from parent page _allElementKeys)
  _elementPath: element path
  W: words{
    L: label words 
    H: header words
  }
  C: CSS {FS:font-size, FW: font-weight, FC: font-color, FF: font-family, BC:background-color, }
  R: RECT {L:left, T: top, W: width, H: height},
  V: value (input)
  VT: value type (1: input, 2: selct, 3: checkbox, radio)
  _exe: execute function name (_exeChange, _exeClick, _loadPage, [empty])
  _followPage: Sub Page (execute operation get sub page)
*/
var _aiElementHandler={
  _generatePageElementKeys:function(p,pk,_ignoreAlert){
    pk=pk||""
    for(var i=0;i<p._newElementKeys.length;i++){
      var o=p._newElementKeys[i];
      //_allElementKeys: element key List in String
      o.K=_aiKeyHandler._getElementKey(o);
      if(o.K){
        o.PKS=pk+o.K;
        p._allElementKeys+=o.K;
      }else{
        p._newElementKeys.split(i,1);
        i--;
      }
    }
    return p;
  },
  _findInputElements:function(_page){
    var es=[]
    for(var k in _page._newElementMap){
      var e=_page._newElementMap[k];
      if(e._exe=="_exeChange" && !e.disable){
        es.push(e)
      }
    }
    return es;
  },
  _findClickElements:function(_page){
    var es=[]
    for(var k in _page._newElementMap){
      var e=_page._newElementMap[k];
      if(e._exe=="_exeClick"){
        es.push(e)
      }
    }
    return es;
  },
  _buildNewElementMap:function(p){
    //register elements and generate new element keys
    var s="",w,gs=[];
    p._newElementKeys.forEach(function(v,i){
      p._newElementMap[v.K]=v;
      s+=v.K;
      v.W=_aiWordHandler._registerFromAction({element:v._elementPath,type:1,css:v.W,event:{type:v._exe=="_exeChange"?"change":"click"}})
      _aiElementHandler._assignGroup(p._newElementKeys,v,gs)
    });
    p._newElementKeys=s;
  },
  //e: current element, p: page
  _registerPage:function(e,p,_lastPage){
    delete p._ignoreArea;
    delete p._clickable;
    e._followPage=p;
    //assign key to each element 
    _aiElementHandler._generatePageElementKeys(p,e.PKS);
    
    //compare with parent page and remove repeat elements
    this._filterShareElements(_lastPage,p);
    this._buildNewElementMap(p);
    
    //Find samilar page in parent page
    if(e._labelGroup || e._headerGroup){
      for(var i=0;i<_lastPage._newElementKeys.length;i++){
        var c=_lastPage._newElementKeys[i];
        c=_lastPage._newElementMap[c];
        if(c==e){
          break;
        }else if(!c._followPage || !c._followPage._newElementMap){
          continue;
        }
        if(c._labelGroup==e._labelGroup && c._labelGroup){
          if(_aiWordHandler._isLookingWord(c._labelGroup[0],"v")){
            e._followPage={_allElementKeys:e._followPage._allElementKeys}
            _aiReport._report(_bzMessage._aiReport._findRowData,{e:e._elementPath,U:p.U})
            break;
          }
        }
        if(c._headerGroup==e._headerGroup && c._headerGroup){
          if(_aiWordHandler._isLookingWord(c._headerGroup[0],"v")){
            e._followPage={_allElementKeys:e._followPage._allElementKeys}
            _aiReport._report(_bzMessage._aiReport._findRowData,{e:e._elementPath,U:p.U})
            break;
          }
        }
      }
    }
  },
  _isSamilarPage:function(c,e){
    var r=_aiElementHandler._getSamilarData(c,e);
    return r._found/r._nesC>0.6 && r._found/r._nesE>0.6;
  },
  _getSamilarData:function(c,e){
    var _idx=_found=_missgroupC=_missgroupE=0,_laste,_lastFoundC,_lastFoundE,_foundGroup=[];
    
    for(var m=0;m<e._newElementKeys.length;m++){
      var e1=e._newElementMap[e._newElementKeys[m]];
      var s=e1._elementPath.toString();

      var deh=_aiElementHandler._replaceWord(s,e1.W.H);
      var del=_aiElementHandler._replaceWord(s,e1.W.L);
      var dea=_aiElementHandler._replaceWord(deh,e1.W.L);

      for(var n=0;n<c._newElementKeys.length;n++){
        if(_foundGroup.includes(n)){
          continue
        }
        var c1=c._newElementMap[c._newElementKeys[n]],dch,dcl;
        var cc=c1._elementPath.toString(),_curFound=0;
        if(s==cc){
          _curFound=1
        }else{
          if(_aiWordHandler._isLookingWord(c1.W.H,"v")){
            cc=_aiElementHandler._replaceWord(cc,c1.W.H);
          }
          if(_aiWordHandler._isLookingWord(c1.W.L,"v")){
            cc=_aiElementHandler._replaceWord(cc,c1.W.L);
          }
          _curFound=[deh,del,dea].includes(cc)
        } 
        if(_curFound){
          _idx=n+1;
          _found++;
          _lastFoundC=c1;
          _lastFoundE=s;
          _foundGroup.push(n)
          break;
        }
      }
    }
    return {
      _found:_found,
      _nesC:c._newElementKeys.length,
      _nesE:e._newElementKeys.length
    }
  },
  //cp:curPage, np:new Page
  _filterShareElements:function(cp,np){
    if(!cp){
      return;
    }
    var s=np._allElementKeys;
    for(var n=np._allElementKeys.length-1;n>=0;n--){
      if(cp._allElementKeys.includes(np._allElementKeys[n])){
        np._newElementKeys.splice(n,1)
      }
    }
  },
  _replaceWord:function(s,w,r,i){
    if(!w){
      return s;
    }
    i=i||0;
    if(i>1){
      return s;
    }
    r=r||"BZ-Word";
    var s1=s.replace("("+w+")","("+r+")");
    if(s1==s){
      return _aiElementHandler._replaceWord(s.replace('"'+w+'"',r),w,'"'+r+'"',i+1);
    }
    return _aiElementHandler._replaceWord(s1,w,r,i+1);
  },
  _isSameTemplate:function(w1,w2,_exe){
    w1=this._replaceWord(w1.s,w1.w);
    w2=this._replaceWord(w2.s,w2.w);
    if(_exe=="_exeChange"){
      w1=w1.replace(/SELECT|TEXTAREA/,"INPUT");
      w2=w2.replace(/SELECT|TEXTAREA/,"INPUT");
    }
    return w1==w2;
  },
  _assignGroup:function(vs,o,gs){
    var _foundHeader=_foundLabel=0;
    var oep=_Util._clone(o._elementPath);
    oep=oep.pop().toString()
    for(var i=0;i<vs.length;i++){
      var v=vs[i];
      if(v==o){
        return;
      }

      var vep=_Util._clone(v._elementPath);
      vep=vep.pop().toString()
      
      //same x,y
      if(v.W.H && v.W.H==o.W.H && v._exe==o._exe && v._exe=="_exeChange"){
        if(!v._labelGroup){
          v._labelGroup=[v.W.L]
          gs.push(v._labelGroup)
        }
        if(!v._labelGroup.includes(o.W.L)){
          v._labelGroup.push(o.W.L);
          o._labelGroup=v._labelGroup;
        }
      }else if(v.R.L==o.R.L || v.R.T==o.R.T){
        //same height;
        if(v.R.H==o.R.H||(v.W.L && o.W.L && ((Math.round(v.R.H/o.R.H)==2 && v.W.L.length>o.W.L.length)||(Math.round(o.R.H/v.R.H)==2 && o.W.L.length>v.W.L.length)))){
          if(v.W.H && o.W.H){
            if(v.W.H==o.W.H){
              if(o.W.L && v.W.L && o._exe==v._exe && _aiElementHandler._isSameTemplate({s:vep,w:v.W.L},{s:oep,w:o.W.L},o._exe)){
                if(!v._labelGroup){
                  v._labelGroup=[v.W.L]
                  gs.push(v._labelGroup)
                }
                if(!v._labelGroup.includes(o.W.L)){
                  v._labelGroup.push(o.W.L);
                  o._labelGroup=v._labelGroup;
                }
              }
            }else if(o.W.L==v.W.L){
              var g=_inGroupHeader(v.W.H,o.W.H);
              if(g){
                vep=vep.replace("("+v.W.H+")","BZ-Header");
                oep=oep.replace("("+o.W.H+")","BZ-Header");
                
                if((!o.W.L && vep==oep) || _aiElementHandler._isSameTemplate({s:vep,w:v.W.L},{s:oep,w:o.W.L},o._exe)){
                  v._headerGroup=o._headerGroup=g;
                }
              }
            }
          }
        }
      }
    }
    function _inGroupHeader(h1,h2){
      for(var i=0;i<gs.length;i++){
        if(gs[i].includes(h1) && gs[i].includes(h1)){
          return gs[i]
        }
      }
    }
  }
};var _aiElementUpgrade={
  _aiFindElement:function(_action,_upgradeDiffs,_bRetry){    
    var _css=_action.css,ll,hh,cs,rs,ls,p=_action.element;
    if(!_css){
      return 
    }
    //pre search in upgrade
    if(ll=_aiElementUpgrade._upgradePathInDiffOptions(p,_action.errOnHidden,_upgradeDiffs)){
      return ll
    }
    var _idx=p.pop()
    if(!$.isNumeric(_idx)){
      p.push(_idx)
      _idx=0
    }
    if (!window.BZ || BZ._documents || BZ._autoRecording){
      _ready=1
    }else{
      return
    }
    ll=_aiElementUpgrade._generateElementSearchOptions(p,_css.LL)
    hh=_aiElementUpgrade._generateElementSearchOptions(p,_css.HH)
    try{
      cs=$(_Util._eval(p[0]))
      if(!cs.length){
        cs=$(BZ.TW.document);
      }
    }catch(ex){
      return
    }
    if(ll){
      rs=_aiFindCell(p[0],ll,_upgradeDiffs)
      rs=_filterOutHidden(rs)
    }
    if(rs){
      if(rs.length>_idx+1&&hh){
        for(var i=0;i<hh.length;i++){
          var r=_aiFindHeader(p[0],hh,_upgradeDiffs,rs)
          if(r&&r.length<rs.length&&r.length>=_idx+1){
            rs=r
            if(r.length==_idx+1){
              break
            }
          }
        }
      }else if(rs.length>1||(!hh&&!ll)){
        return
      }
      rs=rs[_idx]||rs[rs.length-1]

      return {_path:_cssHandler._findPath(rs),_element:rs}
    }
    
    function _aiFindCell(_root,ss,_upgradeDiffs){
      var ps=[_root].concat(ss._path);
      var os=_Util._findDoms(ps),os1,t=0;
      if(!os || !os.length){
        os=_aiElementUpgrade._upgradePathInDiffOptions(ps,1,_upgradeDiffs)
        if(!os){
          if(ss._keys){
            os=_searchInWords(ps,ss._keys)
          }
          if((!os||!os.length)&&ss._oth){
            os=_searchInWords(ps,ss._oth)||os
          }
          if(ss._css &&(!os ||os.length>1)){
            os=_searchInCss(os||$(_Util._eval(_root)),ss._css)||os
          }
        }
      }
      return os
    }
    
    function _aiFindHeader(_root,ss,_upgradeDiffs,os){
      var hs=_aiFindCell(_root,ss,_upgradeDiffs)
      hs=_filterOutHidden(hs)
      if(hs){
        var oo=0;
        while(1){
          oo=hs.find(os)
          if(oo.length){
            return oo
          }
          hs=hs.parent()
        }
      }
    }
    function _searchInWords(ps,ws){
      var k=":text("+ws.join("|")+")"
      if(ps.constructor==Array){
        ps[1]=ps[1].split(/[\[\:\.\#]/)[0]+k
        ps=_Util._findDoms(ps)
      }else{
        ps= ps.find(k)
      }
      return ps&&ps.length?ps:0
    }
    
    function _searchInCss(os,c){
      var o;
      os=$(os)
      if(c.eType){
        o=os.find(_cssHandler._keyMap[c.eType]._css)
      }else{
        o=os.find(c.tag)
      }
      if(c.css){
        var _best;
        c.css.forEach(function(v){
          if(!_best||!_best.length){
            _best=(o||os).find(v)
          }else{
            o=_best.find(v)
            if(o.length){
              _best=o
            }
          }
        })
        o=_best||o;
      }
      return o&&o.length?o:0
    }
    
    function _filterOutHidden(os){
      var ss=[];
      _Util._filterOutHidden(os,ss)
      return ss.length?$(ss):0
    }
    
  },
  _upgradePathInDiffOptions:function(p,_errOnHidden,_upgradeDiffs){
    var _paths=_aiElementUpgrade._aiUpgradePath(p,_upgradeDiffs._full),o
    if(_paths){
      o=$util.findDom(_paths,_errOnHidden)
      if(o){
        return {_element:o,_path:_paths,_solution:"update"}
      }
    }
    _paths=_aiElementUpgrade._aiUpgradePath(p,_upgradeDiffs._text)
    if(_paths){
      o=$util.findDom(_paths,_errOnHidden)
      if(o){
        return {_element:o,_path:_paths,_solution:"update"}
      }
    }
  },
  //e:element path, c: css(LL/HH), h: is header
  _generateElementSearchOptions:function(p,c,h){
    if(c && c.constructor==Array){
      var vs=[]
      c.forEach(function(cc){
        var v=_aiElementUpgrade._generateElementSearchOptions(p,cc,1)
        if(v){
          vs.unshift(v)
        }
      })
      return vs.length?vs:0;
    }
    if(c){
      var o,w;
      o={_path:h?p[c.id]:p.slice(c.id)}

      w=_descAnalysis._retrieveTextForElementPathItem(p[c.id])
      if(w){
        o._keys=_retrieveKeys(c)

        o._oth=_retrieveOth(w,o._keys)
      }
      o._css=c.C||c
      return o;
    }
    
    function _retrieveOth(s,ks){
      if(ks){
        ks.forEach(function(w){
          s=_Util._removeWord(s,w)
        })
      }
      return [...(new Set(s.replace(/[^0-9a-z\u4E00-\u9FCC]/gi," ").replace(/\s+/g," ").split(" ")))]
    }
    function _retrieveKeys(c){
      if(c.WT){
        var ks=[]
        c.WT.forEach(function(cc){
          var s=_aiElementUpgrade._getWordsInDefined([cc]);
          if(s){
            ks=ks.concat(s.split("|"))
          }
        })
        return ks.length?ks:0
      }
    }
  },
  _aiUpgradePath:function(ps,_upDiffs){
    ps=_Util._clone(ps)
    var _changed=0,_scope=_IDE._data._curModule._data.code+"."+_IDE._data._curTest._data.code+".";
    for(var i=0;i<ps.length;i++){
      var v=ps[i];
      if(!$.isNumeric(v)){
        for(var n=0;n<_upDiffs.length;n++){
          var o=_upDiffs[n];
          if(!o._scope || _scope.startsWith(o._scope)){
            var vv=_aiDataUpdateHandler._getUpdateCode(v,[o._diff])
            if(vv && vv!=v){
              ps[i]=vv
              _changed=1
              break
            }
          }
        }
      }
    }
    if(_changed){
      return ps;
    }
  },
  _getWordsInDefined:function(WT){
    var s="",gs=[],gs1=[];
    for(var i=0;i<WT.length;i++){
      var w=WT[i];
      if(w.DD){
        s+=_dictionaryHandler._keyMap[w.DD.K].toString().replace(/,/g,"|")
      }else if(w.EXTRA){
        for(var j=0;j<w.EXTRA.length;j++){
          var e=w.EXTRA[j]
          if(e.tt=="o"){
            var ww=_aiWordHandler._findWordByExtra(e)
            if(ww){
              if(s){
                s+="|"
              }
              s+=ww;
            }
          }
        }
      }
    }
    return s;
  },
  _pickElement:function(_pick){
    if(bzTwComm._isIDE()){
      _extensionComm._exeFun("_pickElement","_aiElementUpgrade",_pick);
    }else if(_IDE._data._curAction){
      _descAnalysis._clearTmpPath(1);
      _bzDomPicker._start({_id:"_actionElementPick",_back:_back,_type:_IDE._data._curAction&&!_pick?_IDE._data._curAction.element:null});
    }else{
      return
    }
    _infoManagement._showImportantInfo(_bzMessage._picker._reminder,0,0,1)
//    console.log("------Before--------")
//    console.log(_IDE._data._curAction.element);
    var _oldPath=_IDE._data._curAction.element
//    console.log("--------------")
    function _back(_path,_pos,_element){
      var e=$util.findDom(_path);
      _IDE._data._curAction.element=_path;
      _ideDataBind._bindDataOnElement(_IDE._data._curAction,"element");
      
      _screenshotHandler._getScreenshot(_Util._findTextElement(_element),0,function(c){
        c={_img:c,_path:_path}
//        console.log("-------After-------")
//        console.log(_oldPath);
//        console.log(_path)
//        console.log("--------------")
        c._upgradeList=_aiElementUpgrade._buildUpgradeStrategy(_oldPath,_path)
        _bzDomPicker._showTmpCover([_path])
        if(bzTwComm._isExtension()){
          BZ._formatInIFramePath(c._path)
          bzTwComm._postToIDE({_scope:"_aiElementUpgrade",_fun:"_setUpgradeElement",_args:[c]});
        }else{
          _aiElementUpgrade._setUpgradeElement(c);
        }
      })
    }
  },
  //for set back value after user pick element from page
  _setUpgradeElement:function(d){
    var n=BZ._data._uiSwitch.$newElement
    n._img=d._img;
    n._path=d._path;
    n._upgradeList=_aiElementUpgrade._buildUpgradeStrategy(n._orgPath,n._path)
  },
  //op:orginal path, np:new path
  _buildUpgradeStrategy:function(op,np,_scope){
    var _list=[];
    op=_Util._clone(op);
    np=_Util._clone(np);
    if($.isNumeric(op[op.length-1])){
      op.pop()
    }
    if($.isNumeric(np[np.length-1])){
      np.pop()
    }
    var i=0;
    while(np.length&&op.length){
      if(np[0]==op[0]){
        np.splice(0,1)
        op.splice(0,1)
      }else if(np.length>op.length){
        _removeExtra(np,op)
      }else if(np.length<op.length){
        _removeExtra(op,np)
      }else{
        break
      }
    }
    
    np.forEach(function(v,i){
      var d=_aiDataUpdateHandler._getDiff(op[i],v)
      for(var n=0;n<d.length;n++){
        var t=d[n]._toTxt||d[n]._toCode
        if(t!=v && v.startsWith(t) && d.length>1){
          d.splice(n--,1)
        }
      }
      _list=_list.concat(d)
    })
    _list.forEach(function(v,i){
      _list[i]={_diff:v,_scope:_scope||(_IDE._data._curModule._data.code+".")}
    })
    return _list;
    function _removeExtra(m,l){
      for(var j=0;j<m.length-l.length;j++){
        if(m[j]==l[0]){
          l.shift()
          m.splice(0,j+1)
          if(m.length==l.length){
            return
          }
          j=-1
        }
      }
      m.splice(0,m.length-l.length)
    }
  },
  _addUpgradeList:function(_list,_newList){
    if(!_newList){
      return
    }
    _newList.forEach(function(v){
      _list._full.push(v);
      if(v._diff._fromTxt && v._diff._toTxt){
        var t1=_descAnalysis._retrieveTextForElementPathItem(v._diff._fromTxt)
        var t2=_descAnalysis._retrieveTextForElementPathItem(v._diff._toTxt)
        if(t1 && t2){
          _list._text.push({_diff:{_fromTxt:t1,_toTxt:t2},_scope:v._scope})
        }
      }
    })
  }
};var _aiExeHandler={
  /*
  _curPathIdx:-1,
  _curPath:[],
  _surfData:0,
  _pageMap:{},
  _pageNewElementMap:{}
  */
  _launchPageOnly:function(_url,_fun){
    var _test={
      enterPoint:{
        type: "newpage",
        value: _url
      }
    };
    _ideTask._test._doTestEnterPage(_test,0,_fun,16)
  },
  _cleanInput:function(){
    var os=$(BZ.TW.document.body).find("input,textarea,select")
    for(var i=0;i<os.length;i++){
      if(!["checkbox","radio","submit","button","image","reset"].includes(os[i].type)){
        if(!$(".BZIgnore").find(os[i])[0]){
          os[i].value=""
          os[i].setAttribute("autocomplete","off")
        }
      }
    }
  }
};var _aiFlagHandler={
  _processData:_CtrlDriver._buildProxy({_list:[],_warnings:[],_curTab:"_new",_curSettingTab:"_setting"}),
  _data:{_environment:{}},
  _isFlag:function(v){
    return v&&v.match(/^\$(id|ergodic|ergodic-next|maybe-no-exist|loading|scan-data|timeout|delay|validation|validations|auth|login-enter|login-form|logout|menu|input-format|sup-module|url|no-url|sub-module|ref-module|module|module-enter|details|details-enter|ex-details-enter|new|add|create|update|edit|modify|remove|delete|form|form-tab|auth-field|field|fields|skip|data-name|name|type|key|alias|row|label|init-data|items|operations|role|roles|opr-alias|opr-type|edit-oprs|required|unique|dependency|dependencies|value|option|target|css|to-status|status|from-status|flow|insert|ex-insert|submit|save|close|next|back|previous|confirm|failed|list|table|step-key|pre-step|end-step|step-index) *$/)
  },
  //step 1, execute on IDE
  _identifyApp:function(ad){
    _aiFlagHandler._processData._warnings=[]
    // _aiFlagHandler._processData._updateInfo={}

    _aiFlagHandler._buildExistModuleMap((ms)=>{
      _aiFlagHandler._start()
      if(!BZ.TW||BZ.TW.closed){
        BZ._launchCurEnvUrl(ad.startUrl,function(){
          setTimeout(()=>{
            _aiFlagHandler._identify(ms)
          },100)
        })
      }else{
        _aiFlagHandler._identify(ms)
      }
    })
  },
  _identify:function(ms){
    if(!_extensionComm._pageReady){
      return setTimeout(()=>{
        _aiFlagHandler._identify(ms)
      },100)
    }
    setTimeout(()=>{
      _aiFlagHandler._identifyPage((d)=>{
        _aiFlagHandler._moduleMap=d._moduleMap
        _aiFlagHandler._data=d._page._setting
        $project=d.$project
        $parameter=d.$parameter
        let ms=_getNewModules();
        _storeNewModules(ms,function(){
          _mergeBZData(d._page)
        })
      },ms)
    },500)
    
    function _mergeBZData(d){
      while(d._warnings.length){
        let w=d._warnings.shift()
        if(!_aiFlagHandler._processData._warnings.find(x=>x._key==w._key)){
          _aiFlagHandler._processData._warnings.push(w)
        }
      }
      
      _aiFlagHandler._processData._refresh=Date.now()

      d._warnings=[]
      d._updateInfo={}
      _aiFlagHandler._store(Object.values(_aiFlagHandler._moduleMap),function(){
        _aiFlagHandler._curContinueData=d
        _aiFlagHandler._continueProcess()
      })
    }
    
    function _getNewModules(){
      let ms=[]
      for(let k in _aiFlagHandler._moduleMap){
        let m=_aiFlagHandler._moduleMap[k]
        if(!m.code){
          ms.push(m)
        }
        _aiFlagHandler._updateModuleCode(m,"parentModule")
        _aiFlagHandler._updateModuleCode(m.definition.contents[0],"module")
      }
      ms.sort((a,b)=>{
        if(!a.parentModule||a.parentModule.match(/^m[0-9]+$/)){
          return -1
        }else if(!b.parentModule||b.parentModule.match(/^m[0-9]+$/)){
          return 1
        }else if(a.parentModule==b.alias){
          return 1
        }else if(b.parentModule==a.alias){
          return -1
        }
        return 0
      })
      return ms
    }

    function _storeNewModules(ms,_fun){
      let m=ms.shift()
      if(m){
        _aiFlagHandler._updateModuleCode(m,"parentModule")
        _aiFlagHandler._updateModuleCode(m.definition.contents[0],"module")
        _ideModuleManagement._save(m,function(m){
          _aiFlagHandler._moduleMap[m.alias]=m
          m._chk="on"
          m._new=1
          
          _aiFlagHandler._updateAllModuleCode(m)
          _storeNewModules(ms,_fun)
        })
      }else{
        _fun()
      }
    }
  },
  _updateModuleCode:function(v,k){
    let m=_aiGeneratorDataHandler._getModuleObject(v[k])
    m=m&&m._data.code
    if(m&&m!=v[k]){
      return v[k]=m
    }
  },
  _continueProcess:function(){
    if(_aiFlagHandler._processData._status!='_playing'){
      _aiFlagHandler._hideShowLoading()
      return
    }
    _aiFlagHandler._processData._status=_aiFlagHandler._exeType
    let d=_aiFlagHandler._curContinueData
    _aiFlagHandler._setProcessData()
    
    if(!d._setting._exeList.find(x=>{
      if(!x._done){
        if(x._module){
          let m=_aiFlagHandler._moduleMap[x._module]
          if(!m._chk){
            x._done=1
            return
          }
        }
        
        let as=[].concat(x._steps)
        
        if(x._type=="submit-login"){
          as=[]
        }
        if(x.preSteps){
          as.push({
            _preActions:x.preSteps
          })
        }
        as.push({
          _element:x._element
        })
        if(x.endSteps){
          as.push({
            _endActions:x.endSteps
          })
        }

        _aiFlagHandler._exeActions(as,function(){
          _aiFlagHandler._assignFlagByScript()
          x._done=1
          if(_aiFlagHandler._data.fullHyApp&&!x._noUrl){
            _extensionComm._retrieveDataFromTW("location.href",function(v){
              let m=x._module
              if(m){
                m=_aiFlagHandler._moduleMap[m]
                if(!m.definition.contents.find(a=>{
                  if(a.code==x._code){
                    _updateEnter(m,a,v)
                    return 1
                  }
                })){
                  m.definition.operations.find(a=>{
                    if(a.code==x._code){
                      _updateEnter(m,a,v)
                      
                      return 1
                    }
                  })
                }
              }
              _aiFlagHandler._identify(d.ms)
            })
          }else{
            setTimeout(()=>{
              _aiFlagHandler._identify(d.ms)
            },100)
          }
        })
        if(x._type!="submit-login"&&x._type!="$logout"){
          d._setting._curExeItem=x;
        }
        return 1
      }
    })){
      if(_aiFlagHandler._data._scanAuth){
        _storeLogout(_storeLogin)
      }else{
        _aiFlagHandler._finalStore(Object.values(_aiFlagHandler._moduleMap),function(){
          _aiFlagHandler._stop()
          _aiFlagHandler._processData._complete=1
        })
      }
    }
    
    function _storeLogout(_fun){
      let a=_aiFlagHandler._data._scanAuth
      if(a._logout){
        let t=_aiAuthHandler._getTestCase(d._setting._hostIdx,"signOut")
        if(t){
          t=_ideObjHandler._getDataByPath(t)
          if(t){
            let m=t._parent
            t=t._data
            let as=t.actions
            as[0].element=a._logout._element
            if(a._confirmLogout){
              as[1].element=a._confirmLogout._element
            }else if(as.length>1){
              as.pop()
            }
            
            return _ideTestManagement._save(t,m,function(){
              _fun()
            })
          }
        }
      }
      _fun()
    }
    
    function _storeLogin(){
      let a=_aiFlagHandler._data._scanAuth
      if(a._loginForm){
        let t=_aiAuthHandler._getTestCase(d._setting._hostIdx,"signIn")
        if(t){
          t=_ideObjHandler._getDataByPath(t)
          if(t){
            let m=t._parent
            t=t._data
            let as=t.actions
            let _form=a._loginForm._form

            if(_form){
              if(_form.username){
                as[2].element=_form.username._element
              }
              if(_form.password){
                as[3].element=_form.password._element
              }
              if(_form.$submit){
                as[4].element=_form.$submit._element
              }
            }

            if(a._identify){
              as[1].element=a._identify._element
              as[5].element=a._identify._element
            }
            if(_form.extra){
              as.splice(3,0,{
                type:1,
                event:{
                  value:"{{$parameter.extra}}",
                  type:"change",
                  autoBlur:"on"
                }
              })
            }
            
            return _ideTestManagement._save(t,m,function(){
              _afterStoreAuth()
            })
          }
        }
      }
      _afterStoreAuth()
    }
    
    function _afterStoreAuth(){
      _aiFlagHandler._data._scanAuth=0
      d._setting._exeList=[]
      d._setting._curExeItem=0;
      _aiFlagHandler._identify(d.ms)
    }
    
    

    function _updateEnter(m,a,v){
      if(!a.fakeElement&&a.type!="delete"){
        _aiFlagHandler._setModuleUpdate(m,"_update","contents",a.code)
        
        a.url=_aiFlagHandler._handleUrl(v,m)
        delete a.path
        a.fakeElement="on"
      }
    }
  },
  _scanForm:function(_fun,_form){
    if(_fun){
      if(_fun.constructor==Function){
        _aiFlagHandler._identifyPageCallback=_fun
        
        let m=_Util._clone(_IDE._data._curModule._data)
        let _moduleData={}
        _moduleData[m.alias]=m
        _form=m.definition.contents.find(x=>x.code==_form.code)
        _form.formValues={}
        _form.buttons=[]
        let _model=m.definition.models.find(x=>x.code==_form.code)
        _model.items=[]
        let _host=_aiAuthHandler._getCurHostIdx(),fc=_form.from[_host].code
        let _from=m.definition.operations.find(x=>x.code==fc)
        if(!_from){
          m.definition.contents.find(x=>x.buttons&&x.buttons.find(y=>{
            if(y.code==fc){
              _from=y
              return 1
            }
          }))
        }
        let _script=_IDE._data._setting.authList[_host].scan||{}
        _from={
          _key: _from.alias||_from.type,
          _type: _from.type,
          _element: _from.path,
          _module: m.alias,
          _code: _from.code,
          _steps: [
            {
              "_url": _from.url
            }
          ],
          _done: 1
        }

        if(bzTwComm._isIDE()){
          _extensionComm._setShareData({$project:$project||{}})
          _extensionComm._setShareData({$parameter:{}})
          _extensionComm._setShareData({"_IDE._data._curVersion.modules":[_moduleData]})
          _extensionComm._setShareData({"_aiFlagHandler._moduleMap":_moduleData})
          _extensionComm._setShareData({"_aiFlagHandler._data":{
            _environment:0,
            _curExeItem:_from,
            _exeList:[_from],
            _warnings:[],
            tmpFlagScript:_script.tmpFlagScript,
            _updateInfo:{},
            avoidBzFlagElement:1,
            _ids:{},
            _curScanArea:_form
          }});
          BZ._focusTW()
          
          let c=_aiGeneratorDataHandler._getContentByCode(_form.code)||{}
          c=c.path||[]
          if(_Util._isEmpty(c)){
            _extensionComm._setCmd("_aiFlagHandler._scanForm();",1,0)
          }else{
            _extensionComm._setCmd("_aiFlagHandler._scanForm();",0,0,c)
          }
          return
        }
      }else{
        return _aiFlagHandler._identifyPageCallback(_fun)
      }
    }
    _Util._afterAppReady(function(){
      _aiFlagHandler._identifyBZFlag(_fun)
    })
    
  },
  //step 2, send request to APP
  _identifyPage:function(_fun,_data){
    if(_fun){
      if(_fun.constructor==Function){
        _aiFlagHandler._identifyPageCallback=_fun

        if(bzTwComm._isIDE()){
          $project=$project||{}
          $parameter=$parameter||{}
          _extensionComm._setShareData({"$project":$project})
          _extensionComm._setShareData({"$parameter":$parameter})
          _extensionComm._setShareData({"_IDE._data._curVersion.modules":_data})
          _extensionComm._setShareData({"_aiFlagHandler._moduleMap":_aiFlagHandler._moduleMap})
          _extensionComm._setShareData({"_aiFlagHandler._data":_aiFlagHandler._data})
          _extensionComm._setCmd("_aiFlagHandler._identifyPage();",1,0)
          return
        }
      }else{
        return _aiFlagHandler._identifyPageCallback(_fun)
      }
    }
    
    _doIt(0)
    function _doIt(i){
      if(!BZ.TW.document.body.innerText){
        return setTimeout(()=>{
          _doIt(0)
        },100)
      }
      if($.isNumeric(_domActionTask._getLoadingFun())){
        return setTimeout(()=>{
          _doIt(0);
        },10)
      }
  
      _domActionTask._isLoading(function(){
        if(!$("[data-bz]")[0]){
          if(i>20){
            _final()
          }else{
            setTimeout(()=>{
              _doIt(i+1)
            },100)
          }
        }else{
          _final()
        }
        
      })
    }
    
    function _final(){
      _aiFlagHandler._identifyBZFlag(_fun)
    }
  },
  //step 3, execute on APP
  _identifyBZFlag:function(_fun){
    _aiFlagHandler._data._warnings=[]
    _aiFlagHandler._forms=[]
    let _curScanArea,
        _page={
          _url:location.href,
          _items:[],
          _environment:_aiFlagHandler._data._environment,
          _stepMap:_aiFlagHandler._data._stepMap,
          _warnings:_aiFlagHandler._data._warnings,
          _updateInfo:_aiFlagHandler._data._updateInfo
        }
    _setCurScanArea(_aiFlagHandler._data._curScanArea)
    
    if(_aiFlagHandler._data._curExeItem&&["add","edit","delete"].includes(_aiFlagHandler._data._curExeItem._type)){
      _fillForm(207,0,_curScanArea)
    }else{
      _identifyCurPage(document.body)
    }
    
    function _setCurScanArea(_scan){
      let p;
      if(_scan){
        if(_Util._isEmpty(_scan.path)){
          p=_cssHandler._findForm()
        }else{
          p=$util.findDom(_scan.path)
        }
        if(p){
          if(_Util._isEmpty(_scan.path)){
            _scan.path=_cssHandler._findPath(p)
          }
          _curScanArea=p.parentElement
        }
      }
      _assignAIFlag(p,_scan&&_scan.alias)
    }
    
    function _assignAIFlag(p,_alias){
      _aiFlagHandler._assignFlagByScript()
      if(p&&!p.dataset.bz){
        p.dataset.bz=`$form(${_alias})`
        let os=_cssHandler._findAllInputs(p),
            _rList=[],
            _aiApp=_IDE._data._setting.content.aiApp
        let _formTab=(_aiApp.formTab||[]).join(",")
        if(_formTab){
          $(p).find(_formTab).toArray().forEach(x=>{
            if(!x.dataset.bz){
              x.dataset.bz="$form-tab"
            }
          })
        }
        if(os.length){
          let rs=_aiApp.requiredField
          rs=$(p).find(rs).toArray()
          rs.forEach(r=>{
            while(1){
              let o=$(r).find(os)
              if(o.length){
                _rList.push(...o.toArray())
                break
              }else{
                r=r.parentElement
              }
            }
          })
          
          os.forEach(x=>{
            if(x.tagName=="SELECT"||(!["INPUT","TEXTAREA"].includes(x.tagName)&&!$(x).is("[contenteditable=true]"))){
              if(!x.dataset.bz){
                let _css=""
                if(x.tagName!="SELECT"){
                  _aiApp.customize.find(y=>{
                    if($(x).is(y)){
                      _css=",$css:"+y
                    }
                  })
                }
                if(x._required){
                  x.dataset.bz="$field($required,$ergodic"+_css+")"
                }else{
                  x.dataset.bz="$field($ergodic"+_css+")"
                }
              }
            }
          })
        }
        
        _rList.forEach(x=>{
          if(!x.dataset.bz){
            x.dataset.bz="$field($required)"
          }
        })
        let _from,_curExeItem=_aiFlagHandler._data._curExeItem
        if(_curExeItem){
          let m=_aiFlagHandler._getModuleInMap(_curExeItem._module);
          _from=_aiModelHandler._getPanelFromObj(_curExeItem._panel,m.definition)||{}
          _from=_from.type
          if(_from=="form-tab"){
            _from=["$insert"]
          }else{
            _from=["$submit","$cancel"]
          }
        }
        _assignFormBtnType(p,_from)
      }
    }
    
    function _doClick(e,_alias,_fun){
      return setTimeout(()=>{
        _Util._preTriggerEvent()
        _domActionTask._clickElement(e,function(){
          BZ.lastClickElement=e
          e._clicked=1
          setTimeout(()=>{
            let _diff=_Util._getDiffAfterTriggerEvent()
            if(_diff.length){
              let x=_Util._getNewPanelFromNewElements(_diff);
              _assignAIFlag(x,_alias)
              _fun(x)
            }else{
              _fun()
            }
          },1000)
        })
      },100)
    }

    function _assignFormBtnType(f,_default){
      if(_default){
        _default=new Set(_default)
      }
      let i=_cssHandler._findAllInputs(f).pop()
      
      let bs=$(f).find("button,a,.btn,input[type=submit],input[type=button],input[type=img]").toArray().reverse()
      let os=$(f).find("*").toArray(),bb=[]
      i=os.indexOf(i)
      bs.find(x=>{
        if(!x.dataset.bz&&os.indexOf(x)>i){
          let xx=_cssHandler._getFormBtnType(x)
          if(xx){
            if(_default){
              _default.delete(xx)
            }
            x.dataset.bz=xx
          }else{
            bb.push(x)
          }
        }else{
          return 1
        }
      })
      if(_default){
        _default=[..._default]
        bb.forEach(x=>{
          x.dataset.bz=_default.shift()
        })
      }
    }

    function _doNext(_fun){
      let aa=_aiFlagHandler._curForm&&_aiFlagHandler._curForm._nextBtn
      if(aa){
        let a=aa._element
        if(a&&!_Util._isHidden(a)&&!$(a).attr("disabled")){
          let _exeItem=_Util._clone(_aiFlagHandler._data._curExeItem)
          _exeItem._panel=aa._nextPanel
          _exeItem._key=aa._nextKey
          _aiFlagHandler._curForm._exeItem=_aiFlagHandler._data._curExeItem
          _aiFlagHandler._data._curExeItem=_exeItem
          _doClick(a,_exeItem._key,function(){
            _doFailed(a,function(){
              _fillForm(222)
            })
          })
        }
      }else{
        _selectErgodic()
      }
    }

    function _doExInsert(){
      let aa=_aiFlagHandler._curForm&&!_aiFlagHandler._curForm._fromExInsert&&_aiFlagHandler._curForm._exInsertBtn
      if(aa){
        let a=aa._element
        if(a&&!_Util._isHidden(a)&&!$(a).attr("disabled")){
          _doClick(a,aa._exInsertKey,function(x){
            let ff=_getCurForm(x||BZ.TW.document.body,aa._exInsertKey)
            if(ff){
              let _exeItem=_Util._clone(_aiFlagHandler._data._curExeItem)
              _exeItem._panel=aa._exInsertPanel
              _exeItem._key=aa._exInsertKey
              _aiFlagHandler._curForm._exeItem=_aiFlagHandler._data._curExeItem
              _aiFlagHandler._data._curExeItem=_exeItem
              ff._fromExInsert=1
              _fillForm(299,ff)
            }else{
              _identifyCurPage()
            }
          })
        }
      }else{
        if(_aiFlagHandler._curForm&&_aiFlagHandler._curForm._fromExInsert){
          _aiFlagHandler._forms.shift()
          _aiFlagHandler._curForm=_aiFlagHandler._forms[0]
        }
        _identifyCurPage()
      }
    }

    function _doInsert(){
      let aa=_aiFlagHandler._curForm&&_aiFlagHandler._curForm._insertBtn
      if(aa){
        let a=aa._element
        if(a&&!_Util._isHidden(a)&&!$(a).attr("disabled")){
          return _doClick(a,"",function(x){
            if(x){
              _identifyCurPage(x,1)
            }else if(_aiFlagHandler._curForm._fromFormTab){
              _doFormTab()
            }else{
              _doExInsert()
            }
          })
        }else{
          _aiFlagHandler._curForm._insertBtn=0
        }
      }
      
      _doExInsert()
    }

    function _doFormTab(){
      let aa=(_aiFlagHandler._curForm&&_aiFlagHandler._curForm._formTabBtn)||[]
      aa=aa.shift()
      if(aa){
        let a=aa._element
        if(a._clicked){
          return _doFormTab()
        }
        if(a&&!_Util._isHidden(a)&&!$(a).attr("disabled")){
          let _exeItem=_Util._clone(_aiFlagHandler._data._curExeItem)
          _exeItem._panel=aa._formTabPanel
          _exeItem._key=aa._formTabKey
          _aiFlagHandler._curForm._exeItem=_aiFlagHandler._data._curExeItem
          _aiFlagHandler._data._curExeItem=_exeItem
          _doClick(a,aa._formTabKey,function(x){
            if(x){
              let _form=_getCurForm(x||BZ.TW.document.body)
              
              if(!_aiFlagHandler._forms.includes(_form)&&!_aiFlagHandler._forms.find(y=>y._element==_form._element)){
                _form._fromFormTab=1
                _fillForm(317,_form)
              }else{
                _doFormTab()
              }
            }else{
              _doFormTab()
            }
          })
        }else{
          _doFormTab()
        }
      }else{
        if(_aiFlagHandler._curForm&&_aiFlagHandler._curForm._fromFormTab){
          _aiFlagHandler._forms.shift()
          _aiFlagHandler._curForm=_aiFlagHandler._forms[0]
          _doFormTab()
        }else{
          _doNext()
        }
      }
    }
    
    function _doBack(){
      let b=$(BZ.TW.document).find(":attr(data-bz=$back)")[0]
      if(b){
        _aiFlagHandler._forms.shift()
        _aiFlagHandler._curForm=_aiFlagHandler._forms[0]
        if(_aiFlagHandler._curForm){
          _aiFlagHandler._data._curExeItem=_aiFlagHandler._curForm._exeItem
          return _domActionTask._clickElement(b,function(){
            BZ.lastClickElement=b
            _doFailed(b,function(){
              _selectErgodic()
            })
          })
        }
      }
      _closeForm()
    }

    function _doFailed(btn,_fun){
      let b=$(BZ.TW.document).find(":attr(data-bz=$failed)")[0]
      if(b){
        btn=_cssHandler._findPath(btn)
        btn=_descAnalysis._retrieveTextForElementPathItem(btn)

        _Util._confirmMessage(_Util._formatMessage(_bzMessage._aiFlag._appErr,btn),[{
          _title:_bzMessage._method._continue,
          _click:function(c){
            c._ctrl._close()
            _fun()
          }
        }],_bzMessage._aiFlag._handleError,0,0,0,1)
      }else{
        _fun()
      }
    }

    function _closeForm(_fun){
      let b=$(BZ.TW.document).find(":attr(data-bz=/\\$(close|cancel)/)")[0]
      if(b){
        
        return _domActionTask._clickElement(b,function(){
          _doFailed(b,function(){
            _doFinal()
          })
        })
      }
      _doFinal()
    }

    function _doFinal(){
      _setErgodicDependencies()
      _page={
        _page:_page,
        _moduleMap:_aiFlagHandler._moduleMap,
        $project:$project,
        $parameter:$parameter
      }
      if(bzTwComm._isExtension()){
        return bzTwComm._postToIDE({
          _fun:"_identifyPage",
          _scope:"_aiFlagHandler",
          _args:[_page]
        })
      }else{
        _fun(_page)
      }
    }
    
    function _setErgodicDependencies(){
      _curExeItem=_aiFlagHandler._data._curExeItem
      if(_curExeItem&&_curExeItem._relationModules){
        _curExeItem._relationModules=[..._curExeItem._relationModules]
        _curExeItem._relationModules.forEach(m=>{
          m=_aiFlagHandler._moduleMap[m]
          m.definition.fields.forEach(f=>{
            if(f._ergodicMap){
              for(let mk in f._ergodicMap){
                let v=f._ergodicMap[mk]
                for(let dk in v){
                  let vs=v[dk]._selected
                  vs=[...vs]

                  if(!_Util._isSameArray(vs, v[dk]._values)){
                    let mm=_aiFlagHandler._moduleMap[mk]
                    mm.definition.fields.find(ff=>{
                      if(ff.data==dk){
                        _aiFlagHandler._addDependencyOfField(f,ff.code,mm,vs)

                        return 1
                      }
                    })
                  }
                }
              }
            }

            delete f._ergodicMap
          })
        })
      }
    }
    
    function _selectErgodic(){
      let aa=_aiFlagHandler._curForm&&_aiFlagHandler._curForm._ergodicNextItems
      if(aa){
        let bs=[]
        let b=aa.find(a=>{
          bs.unshift(a)
          if(a._values.length-1==a._valueIdx){
            a._valueIdx=0
          }else{
            a._valueIdx++
            let o=$util.findDom(a._path)
            if(o){
              if(a._values){
                o._ergodicValue=a._values[a._valueIdx]
              }else{
                o._ergodicIdx=a._valueIdx
              }
            }
            return 1
          }
        })

        if(b){
          return _exeSetValues(bs,function(){
            _fillForm(316,_aiFlagHandler._curForm)
          })
        }
      }
      _doBack()
    }
    
    function _exeSetValues(bs,_fun){
      let b=bs.shift()
      if(b){
        _domActionTask._exeAction({
          type:1,
          event:{
            value:b._values[b._valueIdx],
            action:"change"
          },
          element:b._path,
          failedReaction:1,
          refOfFailed:"./s/",
          refOfError:"./s/"
        },0,function(r){
          setTimeout(()=>{
            _exeSetValues(bs,_fun)
          },100)
        })
      }else{
        _fun()
      }
    }

    function _clickConfirm(_fun){
      setTimeout(()=>{
        let c=$(":bz($confirm)")[0]
        if(c){
          _domActionTask._clickElement(c,function(){
            _fun()
          })
        }else{
          _fun()
        }
      },300)
    }
    
    function _fillForm(_debugCode,f,o){
      o=o||BZ.TW.document.body
      f=f||_getCurForm(o)

      if(f){
        if(!_aiFlagHandler._curForm||_aiFlagHandler._curForm!=f){
          _aiFlagHandler._curForm=f
          _aiFlagHandler._forms.unshift(f)
        }
        _ideDataBind._doFillForm(0,f._element,"/{random}/",function(_dependencies){
          if(_page._formDependencies&&_dependencies){
            _page._formDependencies.push(..._dependencies)
          }else{
            _page._formDependencies=_dependencies
          }
          _identifyCurPage(f._element)
        })
      }else{
        _identifyCurPage(o)
      }
    }

    function _identifyCurPage(o,_afterInsert){
      if(o){
        _findBZElement(o,_page)
        _aiFlagHandler._setBZData(_page,1,function(){
          if(_afterInsert){
            _doFormTab()
          }else{
            _doInsert()
          }
        })
      }else{
        _doFormTab()
      }
    }

    function _getCurForm(o,k){
      let _opr=_aiFlagHandler._data._curExeItem,f
      if(k){
        f=$(o).find(":bz($form="+k+")")[0]
      }else if(_opr&& "add,edit,delete,next,form-tab".includes(_opr._type)){
        if(!_opr._key){
          f=$(o).find(":bz($form="+_opr._key+")")[0]
        }
        if(!f){
          let fs=$(o).find(":bz($form)").toArray();
          
          f=fs.pop()
          while(fs.length){
            let ff=fs.pop()
            if($(ff).find(f)[0]){
              f=ff
            }
          }
        }
      }
      if(!f){
        f=_cssHandler._findForm(o)
      }
      if(f){
        return {
          _from:_opr,
          _element:f
        }
      }
    }
    
    function _removeIgnoreFlag(v){
      if(_aiFlagHandler._isInOperation()){
        v.find((x,i)=>{
          if(x.$details){
            v.splice(i,1)
            return 1
          }
        })
      }else if(_aiFlagHandler._isInDetails()){
        v.find((x,i)=>{
          if(x.$form){
            v.splice(i,1)
            return 1
          }
        })
      }
    }
    
    function _findBZElement(o,_parentNode,_inForm){
      let v=o.dataset.bz,_node
      if(v){
        v=_aiFlagHandler._parseBZFlag(v)
        if(v){
          if(v[0]&&v[0].$skip){
            return
          }
          
          _removeIgnoreFlag(v)
          if(_Util._isEmpty(v)){
            return
          }

          //for standard input component
          if(_cssHandler._isInput(o)&&_inForm&&!v[0].$field){
            let vv=[{
              $field:{}
            }]
            v.forEach(x=>{
              Object.assign(vv[0].$field,x)
            })
            v=vv
          }
          _node={
            _element:o,
            _value:v,
            _items:[]
          }
          _aiFlagHandler._assignElementPath(v,o,_node)
          if(_parentNode){
            _parentNode._items.push(_node)
          }
          v=Object.keys(v[0])[0]
          if(_aiFlagHandler._isPanel(v)){
            _parentNode=_node
            if(v=="$form"){
              _inForm=1
            }
          }else if(_inForm&&v=="$field"){
            return
          }
        }
      }else if(o.tagName.toLowerCase()=="bz"){
        _parentNode._items.push({
          _value:[{
            _exModuleSetting:o.innerText
          }]
        })
      }else if(_inForm&&_cssHandler._isInput(o)){ //for standard input component
        let pp={
          _element:o,
          _value:[{$field:{}}]
        }
        _aiFlagHandler._assignElementPath(v,o,pp)
        _parentNode._items.push(pp)
        return
      }else if(_inForm){
        let _bnts=[
          _bzMessage._method._cancel,
          _bzMessage._method._close,
          _bzMessage._method._submit,
          _bzMessage._method._save,
          _bzMessage._method._next,
          _bzMessage._method._continue,
          _bzMessage._method._complete,
          _bzMessage._method._finish
        ].join("|")
        
        if($(o).is(`:link(${_bnts})`)){
          let pp={
            _element:o,
            _value:[]
          }
          let mv=o.innerText.match(_Util._eval(`/${_bnts}/i`))
          if(mv){
            mv=mv[0].toLowerCase()
            if(mv==_bzMessage._method._cancel.toLowerCase()){
              mv="$cancel"
            }else if(mv==_bzMessage._method._close.toLowerCase()){
              mv="$cancel"
            }else if(mv==_bzMessage._method._submit.toLowerCase()){
              mv="$submit"
            }else if(mv==_bzMessage._method._save.toLowerCase()){
              mv="$save"
            }else if(mv==_bzMessage._method._next.toLowerCase()){
              mv="$next"
            }else if(mv==_bzMessage._method._continue.toLowerCase()){
              mv="$next"
            }else if(mv==_bzMessage._method._complete.toLowerCase()){
              mv="$submit"
            }else if(mv==_bzMessage._method._finish.toLowerCase()){
              mv="$submit"
            }

            let md={}
            md[mv]={}
            pp._value.push(md)
            _aiFlagHandler._assignElementPath(v,o,pp)
            _parentNode._items.push(pp)
            return
          }
        }
      }

      for(let j=0;j<o.children.length;j++){
        let x=o.children[j]
        if(!_Util._isHidden(x)||["checkbox","radio"].includes(x.type)){
          _findBZElement(x,_parentNode,_inForm)
          x=x.dataset.bz||""
          if(x.match(/\$row *([:\(=]?|$)/)){
            while(1){
              j++
              x=o.children[j]
              if(!x){
                break
              }else{
                x=x.dataset.bz||""
                if(!x.match(/\$row *([:\(=]?|$)/)){
                  j--
                  break
                }
              }
            }
          }
        }
      }
    }
    
    function _isSame(a,b){
      a=a._value.map(x=>Object.keys(x).join(",")).join(",")
      b=b._value.map(x=>Object.keys(x).join(",")).join(",")
      return a==b
    }

  },
  _setFieldInfo:function(x){
    if(!x.bzShortCut){
      let _path=_cssHandler._findPath(x);
      x.bzShortCut={_elementPath:_path,_key:_path.join(",")};
      let _forms=$(":bz($form)").toArray().reverse();
      _forms.find(y=>{
        if($(y).find(x)){
          
          let f=_aiFlagHandler._parseBZFlag(y.dataset.bz)
          if(!f.find(z=>{
            if(z.$form){
              z=_aiFlagHandler._getFlagAttrValue(z.$form,"$module")
              if(z){
                x._module=z
              }
              return 1
            }
          })){
            if(_aiFlagHandler._data._curExeItem){
              x._module=_aiFlagHandler._data._curExeItem._module
            }
          }
        }
      })
    }
  },
  _handleUrl:function(v,m){
    let d=_aiFlagHandler._data
    if(d.fullHyApp&&d.handleUrl){
      if(!d._handleUrlFun){
        d._handleUrlFun=_aiFlagHandler._buildHandleUrlFun(d.handleUrl)
      }

      try{
        return d._handleUrlFun(v,_aiGeneratorDataHandler._getCurModuleDataName(m))
      }catch(e){
        _aiFlagHandler._addWarning(v,"_handleUrlError")
      }
    }
    return v
    //TODO: parse insert data,
  },
  _buildHandleUrlFun:function(v){
    try{
      v=_Util._eval("v="+v)
      return v
    }catch(e){
      console.log(e.stack)
      alert(_bzMessage._aiFlag._error._buildHandleUrlFunError+": "+e.message)
    }
  },
  //step 4, execute on APP and IDE
  _setBZData:function(_page,_ideUpdate,_fun){
    let _moduleMap=_aiFlagHandler._moduleMap,
        _exeList=_aiFlagHandler._data._exeList,
        _sortKeys=["$menu","$login-enter","$logout","$module-enter","$module","$details-enter","$details"],
        _url=_page._url

    _page._setting=_aiFlagHandler._data
    try{
      _sortItems(_page._items)

      _doUpdate(_page._items,_page,_page._environment,_final)
    }catch(ex){
      console.log(ex.stack)
      alert(ex.message)
    }
    
    function _final(){
      _handleFormDependences()
      _fun&&_fun()
    }
    
    function _doUpdate(_items,_page,_environment,_fun){
      let x=_items.shift()
      
      if(x){
        x._environment=_Util._clone(_environment)
        if(x._value&&x._value.find(y=>{
          for(let k in y){
            let v=y[k]
            
            if(_page._setting&&_page._setting._scanAuth){
              switch(k){
                case "$login-enter":
                  _addLoginEnter(k,v,x,_page._setting._scanAuth)
                  return
                case "$logout":
                  _addLogout(k,v,x,_page._setting._scanAuth)
                  return 
                case "$auth-field":
                  _addIdentify(k,v,x,_page._setting._scanAuth)
                  return
                case "$login-form":
                  _addLoginForm(k,v,x,_page._setting._scanAuth,function(){
                    _fun&&_fun()
                  })
                  return 1
                case "$menu":
                  _addMenu(k,v,x)
                  break
                default:
                  if(!_Util._isEmpty(x._items)){
                    _doSubItemForAuth(x,_page,function(){
                      _doUpdate(_items,_page,_environment,_fun)
                    })
                    return 1
                  }
              }
              continue
            }
            _bindDataOnPath(x)

            switch(k){
              case "_exModuleSetting":
                _addExModuleSetting(v,x)
                break
              case "$login-enter": case "$logout": 
                return
              case "$login-form":
                _addLoginForm(k,v,x,0,function(){
                  _fun&&_fun()
                })
                return 1
              case "$module-enter":case "$details-enter":case "$ex-details-enter":
                _addEnter(k,v,x,function(){
                  _doUpdate(_items,_page,_environment,_fun)
                })
                return 1
              case "$module":
                _addModuleScope(k,v,x,function(){
                  _doUpdate(_items,_page,_environment,_fun)
                })
                return 1
              case "$details":case "$form":case "$list":case "$table":
                _addPanel(k,v,x,function(){
                  _doUpdate(_items,_page,_environment,_fun)
                })
                return 1
              case "$add":case "$new":case "$create": case "$edit":case "$update":case "$modify":case "$remove":case "$delete":
                //$from-status,to-status,value
                if(!_aiFlagHandler._isInOperation()){
                  _addOprEnter(k,v,x)
                }
                break
              case "$pre-step":case "$end-step":
                _aiFlagHandler._addStep(k,v,x)
                break
              case "$menu":
                _addMenu(k,v,x)
                break
              case "$id":
                _addId(v,x)
                break
              case "$un-field":
                break
              case "scan-data":
              case "$row":
                break
              case "$field":
                //$data-name,$name,$type,$key,$label,$required,$unique
                //$dependency,
                //$from-status,to-status,value,$value
                _addField(k,v,x)
                break
              case "$submit":case "$save":case "$next":case "$close":case "$cancel": case "$confirm": case "$insert": case "$ex-insert": case "$form-tab":
                if(k=="$cancel"){
                  k="$close"
                }else if(k=="$save"){
                  k="$submit"
                }
                _addButtonToForm(k,v,x)
                break
              case "$failed":case "$back":case "$previous":
                break
              default:
                if(x._environment._panel&&x._environment._panel.type=="form"){
                  _addField(k,n,x)
                }else{
                  _aiFlagHandler._addWarning(k,"_missFlag",x)
                }
            }
          }
        })){
          return
        }
        _doUpdate(_items,_page,_environment,_fun)
      }else{
        _fun&&_fun()
      }
    }
    
    function _doSubItemForAuth(o,_page,_fun){
      _doUpdate(o._items,_page,o._environment,function(){
        _fun()
      })
    }
    
    function _addIdentify(k,v,o,dd){
      let e=_page._setting.identifier
      if(e){
        if(!o._path.find(x=>x.includes&&x.includes(e))){
          if(o._element.innerText.toLowerCase().includes(e.toLowerCase())){
            let i=o._path.length-1
            i=o._path[i].includes?i:i-1
            if(!o._path[i].match(/Contains|text|equal|endEqual|endContains/)){
              o._path[i]+=`:Contains(${e})`
            }
          }
        }
      }
      dd._identify={
        _element:o._path
      }
    }
    
    function _addLoginEnter(k,v,o,dd){
      let _alias=_getAlias(k,v,o)||k

      let d=_exeList.find(x=>x._key==_alias&&x._type==k)
      if(!d){
        d={
          _key:_alias,
          _type:k,
          _element:o._path,
          _url:_url
        }
        let c=_aiFlagHandler._data._curExeItem
        if(c){
          d._steps=[...c._steps]
          d._steps.push({_element:c._element})
        }else{
          d._steps=[{_url:_url}]
        }
        
        dd._loginEnter=d

        _exeList.push(d)
      }
    }

    function _addLogout(k,v,o,dd){
      let _alias=_getAlias(k,v,o)||k

      let d=_exeList.find(x=>x._key==_alias&&x._type==k)
      if(!d){
        d={
          _key:_alias,
          _type:k,
          _element:o._path,
          _url:_url
        }
        let c=_aiFlagHandler._data._curExeItem
        if(c){
          d._steps=[...c._steps]
          d._steps.push({_element:c._element})
        }else{
          d._steps=[{_url:_url}]
        }
        
        dd._logout=d

        _exeList.push(d)
      }
    }

    function _addLoginForm(k,v,o,dd,_fun){
      let _alias=_getAlias(k,v,o)||k

      let d=_exeList.find(x=>x._key==_alias&&x._type==k)
      if(!d){
        d={
          _key:_alias,
          _type:k,
          _element:o._path,
          _url:_url,
          _form:{}
        }
        let c=_aiFlagHandler._data._curExeItem
        if(c){
          d._steps=[...c._steps]
          d._steps.push({_element:c._element})
        }else{
          d._steps=[{_url:_url}]
        }
        if(dd){
          dd._loginForm=d
        }
      }
      d._done=0;
      
      let as=[];
      (o._items||[]).forEach(x=>{
        x._value.forEach(y=>{
          let v=_aiFlagHandler._getFlagAttrValue(y,"$field")
          if(v){
            d._form[v]={
              _element:x._path
            }
            as.push({
              _element:x._element,
              _value:_page._setting[v]
            })
          }else{
            v=_aiFlagHandler._getFlagAttrValue(y,"$submit")
            if(v){
              d._element=x._path
              d._type="submit-login"
              d._form.$submit={
                _element:x._path
              }
              _exeList.push(d)
            }
          }
        })
      });
      _setValues(as,_fun)
    }
    
    function _setValues(as,_fun){
      let a=as.shift()
      if(a){
        $util.triggerChangeEvent(a._element,a._value,1)
        setTimeout(()=>{
          _setValues(as,_fun)
        },200)
      }else{
        _fun()
      }
    }
    
    function _generateNewField(x,_environment){
      if(!x._fieldCode&&x.dataset.bz){
        let v=_aiFlagHandler._parseBZFlag(x.dataset.bz)
        
        v=v.find(x=>x.$field)
        if(v){
          _environment._element=x
          return _addField("$field",v.$field,_environment)
        }
      }
      
      if(!x._fieldCode){
        let p=_cssHandler._findPath(x)
        if(p&&(x._module||(_environment._environment&&_environment._environment._module))){
          x._module=x._module||_environment._environment._module
          let w=_descAnalysis._retrieveTextForElementPathItem(p)
          if(!w){
            return
          }
          let k=_Util._toCamelWords(_Util._toSingularWord(w))
          let m=_aiFlagHandler._moduleMap[x._module];
          if(m){
            let f=m.definition.fields.find(f=>f.data==k)
            if(f){
              return
            }
            let bz=_aiFlagHandler._parseBZFlag(x.dataset.bz)
            bz=bz.find(y=>y.$field||y.$type)||{}
            f={
              code:_aiAPI._newId(),
              data:k,
              name:w,
              type:_getFieldType(bz.$field||bz,x),
              required:bz.$required&&"on",
              label:bz.$label&&"on",
              key:bz.$key&&"on",
              preSteps:[],
              endSteps:[],
              dependencies:[],
              path:p
            }

            m.definition.fields.push(f)
            x._fieldCode=f.code
            let fm
            if(_environment._environment&&_environment._environment._panel){
              fm=m.definition.contents.filter(x=>x.code==_environment._environment._panel).reverse()[0]
            }else{
              fm=m.definition.contents.filter(x=>x.type=="form").reverse()[0]
            }
            if(fm){
              fm=m.definition.models.find(x=>x.code==fm.code)
              fm.items.push({
                code:f.code,
                group:"fields"
              })
            }
          }
        }
      }
      
    }
    function _handleFormDependences(){
      (_page._formDependencies||[]).forEach(x=>{
        let f=x._oprElement._fieldCode
        let m=_aiFlagHandler._moduleMap[x._oprElement._module]
        if(f){
          (x._removed||[]).forEach(n=>{
            _generateNewField(n,x._oprElement._environment)
            let rd=x._removedDependency
            if(n._fieldCode&&rd&&rd._values&&rd._field._fieldCode){
              let nm=_aiFlagHandler._moduleMap[n._module]
              if(nm){
                let nf=nm.definition.fields.find(x=>x.code==n._fieldCode)
                _aiFlagHandler._addDependencyOfField(nf,x._removedDependency._field._fieldCode,m,x._removedDependency._values)
              }
            }
          });
          (x._newElements||[]).forEach(n=>{
            _generateNewField(n,x._oprElement._environment);
            if(n._fieldCode){
              let nm=_aiFlagHandler._moduleMap[n._module]
              let nf=nm.definition.fields.find(x=>x.code==n._fieldCode)
              if(!nf){
                
              }else{
                _aiFlagHandler._addDependencyOfField(nf,f,m,x._value)
              }
            }
          });
        }
      });
      _page._formDependencies=0
    }
    
    function _addErgodicNextItem(v,o,_key){
      if(v){
        _aiFlagHandler._curForm._ergodicNextItems=_aiFlagHandler._curForm._ergodicNextItems||[]
        if(!_aiFlagHandler._curForm._ergodicNextItems.find(x=>x._key==_key)){
          if(!v.value||!v.value.length){
            v.value=_cssHandler._isList(o._element)
            if(v.value){
              v.value=v.value.map(x=>x.innerText)
            }else{
              return
            }
          }
          o._values=v.value
          
          o._valueIdx=0
          o._key=_key
          _aiFlagHandler._curForm._ergodicNextItems.push(o)
        }
      }
    }
    

    function _addExModuleSetting(v,o){
      if(!_aiFlagHandler._data._exModuleSetting){
        return
      }
      let m=_getModuleObject(o)||{alias:""}
      m=m.alias
      let d=_aiFlagHandler._data._exModuleSetting[m]
      d=d||[]
      
      if(v.constructor!=String){
        _formatValue(v)
        v=JSON.stringify({
          $flow:{
            $items:[v.$flow]
          }
        })
      }else{
        let vv=_Util._strToJson(v)
        if(!vv||vv.constructor==String){
          _aiFlagHandler._addWarning("_exModuleSetting","_dataFormatError",o)
          return
        }
      }
      
      if(!d.includes(v)){
        d.push(v)
      }
      _aiFlagHandler._data._exModuleSetting[m]=d
    }
    
    function _formatValue(d){
      for(let k in d){
        if(d[k].value){
          d[k]=d[k].value
          if(d[k].constructor==Array&&d[k].length<2){
            d[k]=d[k][0]
          }
        }else if(d[k].constructor==Object){
          _formatValue(d[k])
        }
      }
    }
    
    function _getExistItem(k,v,o){
      let _alias=_getAlias(k,v,o),r,kk
          
      if(_aiFlagHandler._isOperation(k)){
        kk="operations"
      }else if("$field"==k){
        kk="fields"
      }else if(["$insert","$ex-insert","$form-tab","$submit","$close","$next","$confirm"].includes(k)){
        kk="buttons"
      }else{
        kk="contents"
      }
      let c=_aiFlagHandler._data._curExeItem
      
      let _panel=_getPanel(o)

      if(!_alias&&c&&kk=="contents"){
        _alias=(c._environment&&c._environment._key)||c._key
      }

      let _itemModule=_getModuleObject(o,v)
      if(!_itemModule){
        return
      }
      
      let md=_itemModule.definition
      
      if(kk=="operations"){
        return md.operations.find(x=>{
          return x.alias==_alias
        })
      }else if(kk=="contents"){
        let _chkKey=k
        if(k=="$details"){
          _chkKey="dataPanel"
        }else if(k=="$module"){
          _chkKey="modulePanel"
        }else{
          _chkKey=k.replace("$","")
        }
        r=md.contents.find(x=>{
          if(x.alias==_alias&&x.type==_chkKey){
            return 1
          }
        })
        if(!r&&_alias){
          r=md.contents.find(x=>{
            if(!x.alias&&x.type==_chkKey){
              return 1
            }
          })
        }
        return r
      }

      let _model=_getModel(o)
      if(_model&&_model.items){
        _model.items.find(x=>{
          if(x.group==kk){
            if(kk=="buttons"){
              if(md.contents.includes(_panel)){
                r=_panel.buttons.find(y=>y.type==k.substring(1)&&(y.alias==_alias||y.type!="form-tab"))
                if(r&&k!="$form-tab"){
                  _setExeButton(o,k,r)
                }
              }
            }else{
              r=md[kk].find(y=>y.alias==_alias)
            }
            return r
          }
        })
      }

      return r
    }
    
    function _setExeButton(o,k,d){
      let f=_aiFlagHandler._curForm,
          _curExeItem=_aiFlagHandler._data._curExeItem

      if(k=="$close"){
        f._closeBtn=o
      }else if(k=="$next"){
        f._nextBtn=o
        o._nextPanel=d.lanuchPanel
        o._nextKey=d.alias
      }else if(k=="$ex-insert"){
        f._exInsertBtn=f._exInsertBtn?0:o
        o._exInsertPanel=d.lanuchPanel
        o._exInsertKey=d.alias
      }else if(k=="$insert"){
        f._insertBtn=f._insertBtn?0:o
      }else if(k=="$form-tab"){
        f._formTabBtn=f._formTabBtn||[]
        o._formTabPanel=d.lanuchPanel
        o._formTabKey=d.alias
        f._formTabBtn.push(o)
      }
    }

    function _sortItems(_items){
      //sort identifier order
      _items.sort((a,b)=>{
        a=Object.keys(a._value[0])[0]
        b=Object.keys(b._value[0])[0]
        let r;
        if(!_sortKeys.find(x=>{
          if(a.includes(x)){
            r=-1
          }else if(b.includes(x)){
            r=1
          }
          return r
        })){
          if(_aiFlagHandler._isOperation(a)){
            r=-1
          }else if(_aiFlagHandler._isOperation(b)){
            r=1
          }
        }

        return r
      })
    }

/*********************************************************
// flag function
/*********************************************************/
    function _addEnter(k,v,o,_fun){
      switch(k){
        case "$module-enter":k="enterModule";break;
        case "$details-enter":k="enterDetails";break;
        case "$ex-details-enter":k="enterDetails"
      }
      let _alias=_getAlias(k,v,o);
      let _panel=_getPanel(o)
      _panel=_panel&&_panel.code
      if(k=="enterModule"){
        let m=_addModule(k,v,o,_panel)
        if(!m||!m._chk){
          return _fun()
        }
        let c=m.definition.contents.find(x=>x.type=="enterModule")
        _updatePath(c,o,m,"contents",c.code)
        _addExeItem(v,c,o,m,"contents")
      }else if(k=="enterDetails"){
        let m=_getModuleObject(o,v);
        let md=_getModuleDefinition(o,v)
        if(md){
          if(!md.contents.find(x=>{
            if(x.type==k&&x.panel.includes(_panel)){
              x.alias=x.alias||_alias
              _end(x,m)
              return 1
            }
          })){
            let c=_aiFlagHandler._addDetails(m,_panel,_alias)
            _end(c._enter,m)
          }
        }
      }else{
        _aiFlagHandler._addWarning(k,"_missImplement",o)
      }
      _fun()

      function _end(c,m){
        _updatePath(c,o,m,"contents",c.code)
        _addExeItem(v,c,o,m,"contents")
        _aiFlagHandler._setModuleUpdate(m,"_new","contents",c.code)
      }
    }
    
    function _updatePath(c,o,m,g,cc){
      if(c.path){
        if(bzTwComm._isExtension()){
          let oo=$util.findDom(c.path)
          if(!_Util._isSameArray(c.path,o._path)&&!c.path.find(x=>_Util._hasInsertCode(x))){
            if(!oo||(oo!=o._element&&(oo.type!="radio"||oo.name!=o._element.name))){
              _aiFlagHandler._updateValue(c,"path",o._element.bzPath||o._path,m,g,cc)
            }
          }
        }
      }else if(!c.fakeElement||!c.url){
        _aiFlagHandler._updateValue(c,"path",o._element.bzPath||o._path,m,g,cc)
        if(c.path){
          delete c.fakeElement
        }
      }
    }

    function _addModuleScope(k,v,o,_fun){
      let m=_addModule(k,v,o);
      if(!m||!m._chk){
        return _fun()
      }
      let _url
      if(_aiFlagHandler._data.fullHyApp&&BZ.TW==window){
        _url=_aiFlagHandler._handleUrl(location.href,m)
      }

      let c=m.definition.contents.find(x=>x.type=="modulePanel")
      let e=m.definition.contents.find(x=>x.type=="enterModule")

      if(_aiFlagHandler._data.fullHyApp){
        _aiFlagHandler._updateValue(e,"url",_url,m)
      }
      
      _updatePath(c,o,m,"contents",c.code)

      _doUpdate(o._items,o,{_module:m.alias,_panel:c.code,_panelType:"modulePanel"},function(){
        _fun()
      })
    }
    
    function _addModule(k,v,o,_panel){
      let _key=_getKey(v,o),
          _name=_getName(k,v,o),
          _curExeItem=_aiFlagHandler._data._curExeItem
      
      if(!_key){
        if(_curExeItem&&_curExeItem._type=="enterModule"){
          _key=_curExeItem._key
        }
      }
      if(!_key){
        _key=_Util._toCamelWords(_Util._toSingularWord(_name))
      }
      if((!_key||_key=="modulePanel")){
        _aiFlagHandler._addWarning(k,"_missKey",o)
        return 
      }
      
      let m=_moduleMap[_key],sm

      if(m){
        return m
      }
      if(v["$sub-module"]){
        sm=_getModuleObject(o,v)
      }else{
        sm=_getSupModuleObject(o,v)
      }
      return _aiFlagHandler._addModule(_name,_key,sm,_panel)
    }
    
    function _addSupModule(m,v){
      let sm=_aiFlagHandler._getFlagAttrValue(v,"$sup-module")
      if(sm){
        sm=_moduleMap[sm]||_addSupModule(sm,v["$sup-module"])
      }
      
      return _aiFlagHandler._addModule(0,m,sm)
    }
    
    function _addSubModule(m,sm,_fun){
      let _enter=sm.definition.contents[2]
      let _panelCode=sm.definition.models[0].items[0].code
      m.definition.contents.push({
        code:_enter.code,
        module:sm.code||sm.alias,
        type:"modulesub"
      })
      _model.items.push({
        code:_enter.code,
        group:"relatedModules"
      })
      m.definition.relatedModules.push({
        code:_enter.code,
        module:sm.code||sm.alias,
        type:"modulesub"
      })
    }

    function _addPanel(k,v,o,_fun){
      let m=_getModuleObject(o,v),
          _panel=_getPanel(o),
          _exeItem=_aiFlagHandler._data._curExeItem
      if(_exeItem&&_exeItem._type=="$menu"){
        return _fun&&_fun()
      }
      if(!m){
        _aiFlagHandler._addWarning(k,"_missModule",o)
        return _fun&&_fun()
      }


      let d=_getExistItem(k,v,o),
          _alias=_getAlias(k,v,o)
      if(!d){
        if(k=="$form"||k=="$login-form"){
          let _oprKey
          if(!(v.$add||v.$edit||v.$delete)){
            
            if(_exeItem){
              if(_exeItem._module==m.alias&&["edit","delete"].includes(_exeItem._type)){
                _oprKey=_exeItem._type
              }
            }
          }else{
            _oprKey=v.$edit?"edit":v.$delete?"delete":"add"
          }
          _oprKey=_oprKey||"add"
          d=m.definition.operations.find(x=>x.type==_oprKey)
          if(!d){
            d=_aiFlagHandler._addOpr(m,_oprKey,_oprKey,0,_url)
            if(_panel.type=="form"&&_exeItem&&_exeItem._module!=m.alias){
              _addOutOpr(m,d._enter,d._panel,v.$required,_panel,_exeItem._module,1)
            }
          }
        }else if(k=="$details"){
          d=_aiFlagHandler._addDetails(m,_panel,_alias,_url)
        }else if(k=="$list"||k=="$table"){
          d=_aiFlagHandler._addListOrTable(m,k.substring(1),_alias,_panel)
        }

        if(d&&d._panel){
          d=d._panel
          _aiFlagHandler._setModuleUpdate(m,"_new","contents",d.code);
        }
      }else{
        d.alias=d.alias||_alias
      }
      
      if(k=="$form"&&!_aiFlagHandler._curForm&&_exeItem._element){
        _aiFlagHandler._curForm={
          _key: d.alias,
          _type: d.alias,
          _element: _exeItem._element,
          _module:_exeItem._module,
          _url: _exeItem._url,
          _code: _exeItem._code,
          _panel: d.code,
          _steps: _exeItem._steps,
          _relationModules: {}
        }
      }
      
      if(d.lanuchPanel){
        m.definition.contents.find(x=>{
          if(x.code==d.lanuchPanel){
            _updatePath(x,o,m,"contents",d.code)
            return 1
          }
        })
      }else{
        _updatePath(d,o,m,"contents",d.code)
      }

      _doUpdate(o._items,o,{_module:m.alias,_panel:d.code,_panelType:d.type,_key:d.key},function(){
        _fun()
      })
    }
    
    function _addOutOpr(_oprModule,_ooEnter,_ooForm,_required,_form,_panelModule){
      if(_panelModule.constructor==String){
        _panelModule=_aiFlagHandler._moduleMap[_panelModule]||_aiGeneratorDataHandler._getModuleObject(_panelModule)
      }
      _panelModule=_panelModule&&(_panelModule._data||_panelModule)
      
      _form=_aiFlagHandler._getPanel(_panelModule,_form)
      let d={
        code: _aiAPI._newId(),
        type: "outopr",
        name: _ooEnter.name,
        panel: [
          _form._panel.code
        ],
        preSteps: [],
        endSteps: [],
        lanuchPanel: _ooEnter.lanuchPanel,
        lanuchModule: _oprModule.code||_oprModule.alias,
        operation: _ooEnter.code,
        requiredOperation:_required&&"on",
        parentCtrl:"on",
        fakeElement:"on"
      }
      _form._panel.buttons.push(d)
      
      _form._panelModel.items.push({
        code:d.code,
        group:"buttons"
      })
      _ooForm.from.push({
        module:_panelModule.code||_panelModule.alias,
        code:d.code
      })
    }
    
    function _addMenu(k,v,o){
      let _alias=_getAlias(k,v,o),
          m=_getModuleObject(o,v)
      m=m&&m.alias
      let d=_exeList.find(x=>x._key==_alias&&x._type==k)
      if(!d){
        d={
          _key:_alias,
          _type:k,
          _element:o._path,
          _url:_url,
          _panel:_getPanel(o),
          _module:m
        }
        let c=_aiFlagHandler._data._curExeItem
        if(c){
          d._steps=[].concat(c._steps)
          d._steps.push({_element:c._element})
        }else{
          d._steps=[{_url:_url}]
        }

        _exeList.push(d)
      }
    }

    function _addOprEnter(k,v,o){
      if(k.match(/\$(new|create)/)){
        k="$add"
      }else if(k.match(/\$(modify|update)/)){
        k="$edit"
      }else if(k=="$remove"){
        k="$delete"
      }
      
      let m=_getModuleObject(o,v)
      
      let d=_getExistItem(k,v,o)
      if(!d){
        k=k.substring(1)
        d=_aiFlagHandler._addOpr(m,k,_getAlias(k,v,o)||k,_getPanel(o))
        d=d._enter
      }else{
        if(!d._chk){
          return
        }
        _updatePath(d,o,m,"operations",d.code)
      }
      if(!v.$flow&&d.type!="edit"){
        _addExModuleSetting({
          $flow:{
            "$opr-alias":d.alias
          }
        },o)
      }else if(v.$flow){
        v.$flow["$opr-alias"]=d.alias
        _addExModuleSetting(v,o)
      }
      
      _updatePath(d,o,m,"operations",d.code)

      _addExeItem(v,d,o,0,"operations")
    }
    
    function _addId(v,o){
    }
    
    function _bindDataOnPath(o){
      let p=o._flagPath||[]
      p.forEach((x,i)=>{
        if(x&&x.constructor==String){
          let v=x.match(/:bz\(\$id=([^\)]+)\)/)
          if(v){
            x=_replace(x,"$id",v[1])
          }
          v=x.match(/:bz\(\$field\=([^\)]+)\).*\:(contains|Contains|text|equal|endEqual|endContains)\(([^\)]+)\)/)
          if(v){
            x=_replace(x,v[1],v[3])
          }
          v=x.match(/:bz=\$field\=([^\:]+).*\:(contains|Contains|text|equal|endEqual|endContains)=([^\)\:]+)/)
          if(v){
            x=_replace(x,v[1],v[3])
          }
          p[i]=x
        }
      })
      if(!_aiFlagHandler._data.avoidBzFlagElement){
        o._path=o._flagPath
      }
      
      function _replace(x,ff,v){
        if(_Util._hasInsertCode(v)){
          return x
        }
        let c=_aiFlagHandler._data._ids[v]
        if(c){
          if(x.includes("("+v+")")){
            _replaceInPath("("+v+")","("+c+")")
            return x.replace("("+v+")","("+c+")")
          }else{
            _replaceInPath(v,c)
            return x.replace(v,c)
          }
        }
        
        let md=_getModuleDefinition(o),m=_getModuleObject(o,v)
        
        if(md){
          let f=md.fields.find(f=>{
            if(ff=="$id"){
              return f.key
            }
            return f.data==ff
          })
          if(!f){
            f={
              code:_aiAPI._newId(),
              name:ff=="$id"?"ID":_Util._toCapitalWord(_Util._parseCamelWords(ff)),
              data:ff=="$id"?"id":ff,
              type:"string",
              key:ff=="$id"?"on":"",
              dependencies:[],
              preSteps:[],
              endSteps:[]
            }

            md.fields.push(f)
            _aiFlagHandler._setModuleUpdate(m,"_new","fields",f.code);
          }
          f.demoValue=v
          
          let k=_aiGeneratorDataHandler._getCurModuleDataName(m)
          v="{{$project."+k+"."+f.data+"}}";
          _aiFlagHandler._data._ids[f.demoValue]=v
          $project=$project||{}
          $project[k]=$project[k]||{}
          $project[k][f.data]=f.demoValue;
          
          if(ff=="$id"){
            _replaceInPath(f.demoValue,v)
            return x.replace(f.demoValue,v)
          }
          _replaceInPath("("+f.demoValue+")","("+v+")")
          return x.replace("("+f.demoValue+")","("+v+")")
        }
      }
      
      function _replaceInPath(f,v){
        if(_aiFlagHandler._data.avoidBzFlagElement){
          o._path=o._path.map(x=>{
            if(x.replace){
              x=x.replace(f,v)
            }
            return x
          })
        }
      }
      
    }
    
    function _addField(k,v,o){
      o._element._environment=o
      let _data=(v.value&&v.value.join(","))||_getAlias(k,v,o),
          md=_getModuleDefinition(o,v),
          m=_getModuleObject(o,v),
          _panel=_getPanel(o,v),
          _model=_getModel(o,v),
          _curExeItem=_aiFlagHandler._data._curExeItem

      if(_curExeItem){
        _curExeItem._relationModules=_curExeItem._relationModules||new Set()
        _curExeItem._relationModules.add(m.alias)
      }
      if(_data){
        _data=_data.split(",").map(x=>x.trim()).filter(x=>x)
      }else{
        return _aiFlagHandler._addWarning("","_fieldError",o)
      }

      if(!md){
        return _aiFlagHandler._addWarning(_data.join(","),"_missModule",o)
      }else if(!_panel){
        return _aiFlagHandler._addWarning(_data.join(","),"_missPanel",o)
      }
      
      _data.forEach((d,j)=>{
        let f=md.fields.find(x=>{
          if(x.data==d){
            return 1
          }
        })
        
        if(!f){
          f={
            code:_aiAPI._newId(),
            data:d,
            name:j?_Util._toCapitalWord(d):_getName(k,v,o),
            dependencies:[],
            type:""
          }
          md.fields.push(f)
          
          _aiFlagHandler._setModuleUpdate(m,"_new","fields",f.code);
        }else{
          if(_Util._isHidden(o._element)){
            return
          }
        }
        
        o._element._fieldCode=f.code
        o._element._module=m.alias
        if(_panel.type=="form"){
          _aiFlagHandler._updateValue(f,"name",_getName(k,v,o),m,"fields",f.code)
          if(f.type!="module"){
            _aiFlagHandler._updateValue(f,"type",_getFieldType(v,o._element,f.name),m,"fields",f.code)
          }
          
          _aiFlagHandler._updateValue(f,"required",(v.$required||f.required)&&"on",m,"fields",f.code)
          _aiFlagHandler._updateValue(f,"maybeNoExist",((v["$maybe-no-exist"]&&"on")||f.maybeNoExist)&&"on",m,"fields",f.code)
          _aiFlagHandler._updateValue(f,"unique",(v.$unique||f.unique)&&"on",m,"fields",f.code)
          _aiFlagHandler._updateValue(f,"key",(v.$key||f.key)&&"on",m,"fields",f.code)
          _aiFlagHandler._updateValue(f,"label",(v.$label||f.label)&&"on",m,"fields",f.code)
          _updatePath(f,o,m,"fields",f.code)
          _setErgodicValues(f)
        }
        if(v.$timeout){
          _aiFlagHandler._updateValue(f,"max",_aiFlagHandler._getFlagAttrValue(v,"$timeout"),m,"fields",f.code)
        }
        if(v.$delay){
          _aiFlagHandler._updateValue(f,"min",_aiFlagHandler._getFlagAttrValue(v,"$delay"),m,"fields",f.code)
        }

        let rf=v["$ref-module"]||{}
        let rm=rf.value&&rf.value[0]
        if(rm){
          _aiFlagHandler._updateValue(f,"type","module",m,"fields",f.code)
          if(_aiFlagHandler._moduleMap[rm]){
            rm=_aiFlagHandler._moduleMap[rm]
            _aiFlagHandler._updateValue(f,"module",rm.code,m,"fields",f.code)
          }else if(!f.module){
            _aiFlagHandler._updateValue(f,"module",rm,m,"fields",f.code)
          }else{
            let _found
            for(let k in _aiFlagHandler._moduleMap){
              if(_aiFlagHandler._moduleMap[k].code==f.module){
                _found=1
                break
              }
            }
            if(_found){
              _aiFlagHandler._updateValue(f,"module",rm,m,"fields",f.code)
            }
          }
          rf=_aiFlagHandler._getFlagAttrValue(rf,"$field")
          if(rf){
            if(rm.code){
              rf=rm.fields.find(f=>f.data==rf)||rf
              rf=rf.code||rf
            }
            _aiFlagHandler._updateValue(f,"mapLabel",rf,m,"fields",f.code)
          }
        }

        if(f.type=="string"&&(!f.key||_panel.type=="form")&&!md.fields.find(x=>x.label)){
          _aiFlagHandler._updateValue(f,"label","on",m,"fields",f.code)
        }
        
        if((!f.inputFormat&&_panel.type=="form")||v["$input-format"]){
          let fv=_aiFlagHandler._getFlagAttrValue(v,"$input-format")
          if(!fv&&o._element.type=="file"){
            fv="/"+SERVER_HOST.replace(/[\/]/g,"[\\/]").replace(/\./g,"\\.")+"[\/]file[\/]example\\.png/"
          }
          _aiFlagHandler._updateValue(f,"inputFormat",fv,m,"fields",f.code)
          
          if(!f.inputFormat&&f.type!="module"){
            let iv=_aiPageHandler._getFormat(f.name,f.type,o._element)
            if(iv&&iv.constructor==Array){
              iv=_aiFlagHandler._arrayToStdDependenciesRegex(iv,f.required)
            }
            
            _aiFlagHandler._updateValue(f,"inputFormat",iv,m,"fields",f.code)
          }
        }
        if(_panel.type=="form"){
          _panel.formValues=_panel.formValues||{}

          if(!_panel.formValues[f.code]){
            _aiFlagHandler._updateValue(_panel.formValues,f.code,{dynamicData:"on"},m,"fields",f.code)
          }
          

          if(_Util._isEmpty(f.dependencies)){
            if(o._element&&($(o._element).attr("readonly")||o._element.disabled)){
              _aiFlagHandler._updateValue(_panel.formValues[f.code],"readonly","on",m,"fields",f.code)
            }
          }else{
            _aiFlagHandler._updateValue(_panel.formValues[f.code],"readonly","",m,"fields",f.code)
          }
        }
        
        let $d=v.$dependency
        if($d){
          let ff=$d.value&&$d.value[0]
          if(ff){
            ff=md.fields.find(x=>x.data==ff)||ff
            ff=ff.code||ff
          }
          let dd={
            code:_aiAPI._newId(),
            items:[{
              moduleData:_aiFlagHandler._getFlagAttrValue($d,"$data-type")||"specialData",
              module:_aiFlagHandler._getFlagAttrValue($d,"$module")||m.code||m.alias,
              valueType:_aiFlagHandler._getFlagAttrValue($d,"$value-type")||1,
              field:ff
            }],
            targetValue:_aiFlagHandler._getFlagAttrValue($d,"$target-value")||"[true]" //[true],[false],[disable],[enable]
          }
          if(!f.dependencies||!f.dependencies.find(x=>{return _Util._isSameObj(x.items[0],dd.items[0])&&x.targetValue==dd.targetValue})){
            _aiFlagHandler._updateValue(f,"dependencies",[dd],m,"fields",f.code)
          }
        }

        if(_panel.type=="form"||o._element.type!="file"){
          _addItemIntoCurPanel(o,f,"fields");
        }

        _aiFlagHandler._addStep(0,v,{_module:m.alias,_code:f.code,_group:"fields"})

        if(v.$flow){
          if(!v.$flow.$fields){
            v.$flow.$fields={}
            v.$flow.$fields[f.data]=v.$flow.$value||true
          }
          delete v.$flow.$value
          delete v.$flow.$alias
          _addExModuleSetting(v,o)
        }
        
        _addErgodicNextItem(v["$ergodic-next"],o,f.data)
      })
    }
    
    function _setErgodicValues(f){
      (_aiFlagHandler._forms||[]).forEach(o=>{
        if(o._ergodicNextItems){
          let m=o._from._module
          f._ergodicMap=f._ergodicMap||{}
          f._ergodicMap[m]=f._ergodicMap[m]||{}

          o._ergodicNextItems.forEach(x=>{
            if(f.data!=x._key){
              f._ergodicMap[m][x._key]=f._ergodicMap[m][x._key]||{_selected:new Set(),_values:x._values}
              f._ergodicMap[m][x._key]._selected.add(x._values[x._valueIdx])
            }
          })
        }
      })
    }
    
    function _getNewNextAlias(){
      let c=_aiFlagHandler._data._curExeItem
      if(c){
        c._curNextIdx=c._curNextIdx||0
        c._curNextIdx++
        return c._type+"Next"+c._curNextIdx
      }
    }

    function _addButtonToForm(k,v,o){
      let _model=_getModel(o),
          _panel=_getPanel(o),
          m=_getModuleObject(o,v)

      let d=_getExistItem(k,v,o)

      if(!d&&_model&&_panel&&_panel.type=="form"){
        let d={
          code:_aiAPI._newId(),
          alias:_getAlias(k,v,o),
          endSteps:[],
          preSteps:[],
          name:_getName(k,v,o)||_Util._toCapitalWord(k.substring(1)),
          panel:[_panel.code],
          path:o._path,
          type:k.substring(1)
        }

        d.maybeNoExist=v["$maybe-no-exist"]&&"on"
//        _addExeItem(v,d,o)
        _panel.buttons=_panel.buttons||[]
        _panel.buttons.push(d)

        _addItemIntoCurPanel(o,d,"buttons");
        
        _aiFlagHandler._setModuleUpdate(m,"_new","contents",_panel.code+"/"+d.code,"buttons");

        _aiFlagHandler._addStep(0,v,{_module:m.alias,_code:_panel.code,_group:"contents",_button:d.code})
        if(k=="$next"||k=="$form-tab"||k=="$ex-insert"){
          let dd={
            alias:_getKey(v,o)||_getNewNextAlias(),
            code:_aiAPI._newId(),
            type:"form",
            items:[],
            from:[{
              code:d.code,
              module:m.code||m.alias
            }],
            asOneAction:"",
            speed:100,
            buttons:[]
          }
          d.alias=dd.alias
          dd.name=_aiModelHandler._getPanelName(dd,m)
          m.definition.contents.push(dd)
          d.lanuchPanel=dd.code
          
          dd={
            code:dd.code,
            items:[],
            group:"contents",
            pin:1
          }
          m.definition.models.push(dd)
          _aiModelHandler._assignNewPanelPos(_model,m.definition,dd)
        }
        _setExeButton(o,k,d)
        
        if(k=="$submit"||k=="$save"){
          _panel.buttons.find(b=>{
            if(b.type=="outopr"){
              let om=_aiFlagHandler._getModuleInMap(b.lanuchModule)
              if(om){
                let _submit=_Util._clone(d);
                _submit.code=_aiAPI._newId();
                _submit.panel=[b.lanuchPanel];

                om.definition.contents.find(x=>{
                  if(x.code==b.lanuchPanel){
                    x.buttons.push(_submit)
                    return 1
                  }
                });
                om.definition.models.find(x=>{
                  if(x.code==b.lanuchPanel){
                    x.items.push({
                      code:_submit.code,
                      group:"buttons"
                    })
                    return 1
                  }
                })
              }
            }
          })
        }
      }else if(!d){
        _aiFlagHandler._addWarning(k,"_missForm",o)
      }else{
        _updatePath(d,o,m,"contents",d.code,"buttons")
      }
    }

/*********************************************************/    
// base function
/*********************************************************/
    //Add browseing page step
    function _addExeItem(v,d,o,m,g){
      m=m||_getModuleObject(o,v)
      m=m&&m.alias
      let dd=_exeList.find(x=>x._key==d.alias&&x._module==m)
      if(!dd){
        let s={
          _key:d.alias,
          _type:d.type,
          _element:o._path,
          _module:m,
          _url:_url,
          _code:d.code,
          _panel:d.lanuchPanel,
          _noUrl:v["$no-url"]
        }

        let c=_aiFlagHandler._data._curExeItem
        if(c){
          s._steps=[].concat(c._steps)
          s._steps.push({_element:c._element})
        }else{
          s._steps=[{_url:_url}]
        }

        _aiFlagHandler._addStep(0,v,{_module:m,_code:d.code,_group:g})

        _exeList.push(s)
      }
    }

    function _getKey(v,o,_bInput){
      return ((v.value&&v.value[0])
             ||_glossaryHandler._getVariableName(_Util._toSingularWord(_descAnalysis._retrieveTextForElementPathItem(o._flagPath,_bInput)))
             ||"").trim()
    }
    
    function _getAlias(k,v,o){
      let _alias=_aiFlagHandler._getFlagAttrValue(v,"$alias")
      if(!_alias){
        _alias=_getKey(v,o,k=="$field")||(_aiFlagHandler._isOperation(k)||k.match(/\$(list|table)/)?k.substring(1):"")
      }
      if(!_alias){
        if(k=="$form"){
          if(v.$add){
            _alias="add"
          }else if(v.$edit){
            _alias="edit"
          }else if(v.$delete){
            _alias="delete"
          }
        }else if(["list","$table","$details"].includes(k)){
          _alias=k.substring(1)
        }else if(k=="$details-enter"){
          _alias="details"
        }else if(k.match(/\$(submit|save|close|ex-insert|insert|cancel|next|back)/)){
          _alias=k.substring(1)
        }
      }
      return _alias
    }
    
    function _getName(k,v,o){
      let _name= v.$name||_Util._toCapitalWord(_Util._parseCamelWords(_getKey(v,o,k=="$field")))
      if(!_name){
        _name=_getPanelName(k,v)
      }
      return _name
    }
    
    function _getPanelName(k,v){
      switch(k){
        case "$details":k="dataPanel";break;
        case "$module":k="modulePanel";break;
        case "$list":
        case "$table":
        case "$form":k=k.substring(1);break;
        default:
          return
      }
      return _bzMessage._model._panelType[k]
    }

    function _getEnterName(v,o){
      return v.$name||_descAnalysis._retrieveTextForElementPathItem(o)
    }
    
    function _getFieldType(v,o){
      let dt=v.$type
      if(!dt){
        if(o.tagName=="INPUT"){
          if(o.type=="checkbox"){
            dt="boolean"
          }else if(o.type=="radio"){
            dt="enum"
          }else if(o.type=="number"){
            dt="number"
          }else if(o.type=="file"){
            dt="file"
          }else{
            dt="string"
          }
        }else if(o.tagName=="TEXTAREA"){
          dt="text"
        }else{
          dt="enum"
        }
      }
      return dt
    }
    
    function _getSupModuleObject(o,v){
      let sm=_aiFlagHandler._getFlagAttrValue(v,["$sup-module"])
      if(sm){
        if(_moduleMap[sm]){
          return _moduleMap[sm]
        }
        return _addSupModule(sm,v["$sup-module"])
      }
    }
    function _getModuleObject(o,v){
      let mm,p,d=o._environment||_aiFlagHandler._data._curExeItem;
      if(d){
        mm=_moduleMap[d._module]
        p=d._panel
      }
      if(!v){
        return mm
      }
      let m=_aiFlagHandler._getFlagAttrValue(v,"$module")
      
      if(m){
        if(_moduleMap[m]){
          return _moduleMap[m]
        }
        let sm=_getSupModuleObject(o,v.$module)
        return _aiFlagHandler._addModule(0,m,sm,p)
      }else{
        return mm
      }
    }

    function _getModuleDefinition(o,v){
      let m=_getModuleObject(o,v)
      return m&&m.definition
    }
    
    function _getPanel(o,v){
      let m=_getModuleDefinition(o,v)
      if(m){
        let cs=[o._environment._panel,_aiFlagHandler._data._curExeItem],r;
        cs.find(c=>{
          if(c){
            c=c._panel||c
            if(c){
              r=m.contents.find(x=>x.code==c)
              return r
            }
          }
        })
        return r

      }
    }

    function _getModel(o,v){
      let m=_getModuleDefinition(o,v)
      if(m){
        let cs=[o._environment._panel,_aiFlagHandler._data._curExeItem],r;
        cs.find(c=>{
          if(c){
            c=c._panel||c
            if(c){
              r=_aiModelHandler._getItemPanelModel(m,c)
              return r
            }
          }
        })
        return r
      }
    }
    
    function _addItemIntoCurPanel(o,d,g){
      let m=_getModel(o)
      if(m){
        if(!m.items.find(x=>x.code==d.code)){
          m.items.push({
            code:d.code,
            group:g
          });
          _aiFlagHandler._setModuleUpdate(_getModuleObject(o,"_new","models",m.code))
        }
      }
    }
  },
  _stdDependenciesRegexToArray:function(v){
    return (v||"").replace(/^[\/][\^\(]*|[\$\)]*[\/]$/g,"").split("|")
  },
  _arrayToStdDependenciesRegex:function(vs,_required){
    vs=new Set(vs)
    vs=[...vs]
    if(_required){
      vs=vs.filter(x=>x)
    }else{
      vs=vs.map(x=>x||"")
    }
    return `/^(${vs.join("|")})$/`
  },
  _buildEnumInputFormat:function(df,m,nv){
    if(!df.code){
      df=m.definition.fields.find(x=>x.code==df)
    }
    if(df&&df.type=="enum"){
      let v=df.inputFormat
      if(!v||v.includes("/{random")){
        v=""
      }
      v=new Set(_aiFlagHandler._stdDependenciesRegexToArray(v))
      if(nv){
        if(nv.constructor!=Array){
          nv=[nv]
        }
        nv.forEach(x=>v.add(x))
        df.inputFormat=_aiFlagHandler._arrayToStdDependenciesRegex([...v])
      }
    }
    
  },
  _addDependencyOfField:function(tf,df,dm,vs){
    if(tf.code==df){
      return
    }
    tf.dependencies=tf.dependencies||[]
    let d={
      field:df,
      module:dm.code||dm.alias,
      moduleData:"specialData"
    },v=vs
    if(vs&&vs.constructor==Array){
      v=vs[0]
    }
    if(v===true){
      d.valueType=1
    }else if(v===false){
      d.valueType=0
    }else if(v==vs||vs.length==1){
      d.valueType="=="
      d.value=v
    }else if(vs){
      d.valueType="regex"
      d.value=_aiFlagHandler._arrayToStdDependenciesRegex(vs)
    }
    
    _aiFlagHandler._buildEnumInputFormat(df,dm,vs)
    
    if(tf.dependencies.find((x,i)=>{
      return x.items.find(y=>{
        let vt=y.valueType
        if(y.field==df){
          if($.isNumeric(vt)&&$.isNumeric(d.valueType)){
            if(vt!=d.valueType){
              tf.dependencies.splice(i,1)
            }
          }else if(y.value!=d.value){
            let yvs=_aiFlagHandler._stdDependenciesRegexToArray(y.value+""),
                dvs=_aiFlagHandler._stdDependenciesRegexToArray(d.value+"")
            yvs.push(...dvs)
            yvs=[...new Set(yvs)]
            if(y.length>1){
              y.valueType=="regex"
              y.value=_aiFlagHandler._arrayToStdDependenciesRegex(yvs)
            }
          }
          return 1
        }else{
          let fm=_aiFlagHandler._getModuleInMap(y.module)
          if(fm){
            if(fm.definition.fields.find(x=>{
              if(x.code==y.field){
                return (x.dependencies||[]).find(z=>{
                  return z.items.find(q=>q.field==df&&(q.value==d.value||((q.value+"").includes(d.value))))
                })
              }
            })){
              return 1
            }
          }
        }
      })
    })){
      return
    }


    tf.dependencies.push({
      code:_aiAPI._newId(),
      items:[d],
      targetValue:"[true]"
    })
    let dfi=dm.definition.fields.findIndex(x=>x.code==df)
    if(dfi>=0){
      dm.definition.models.forEach(x=>{
        if(x.items){
          dfi=x.items.findIndex(y=>y.code==df)
          if(dfi>0){
            let tfi=x.items.findIndex(y=>y.code==tf.code)
            if(tfi>=0&&tfi<dfi){
              dfi=x.items.splice(dfi,1)
              x.items.splice(tfi,0,dfi[0])
            }
          }
        }
      })
    }
  },
  _isInOperation:function(){
    let _curExeItem=_aiFlagHandler._data._curExeItem
    return _curExeItem&&["add","edit","delete"].includes(_curExeItem._type)
  },
  _isInDetails:function(){
    let _curExeItem=_aiFlagHandler._data._curExeItem
    return _curExeItem&&_curExeItem._type=="enterDetails"
  },
  //preSteps and endSteps
  _addStep:function(k,v,o){
    let sk=_aiFlagHandler._getFlagAttrValue(v,"$step-key")
    
    if(sk){
      let _map=_aiFlagHandler._data._stepMap
      let i=_aiFlagHandler._getFlagAttrValue(v,"$step-index")
      if(!i||$.isNumeric(i)){
        _map[sk]=_map[sk]||{}
        _map=_map[sk]
        if(!i){
          _map._master=o
        }else if(k=="$pre-step"){
          _map.preSteps=_map.preSteps||[]
          _map.preSteps[i]=o
        }else if(k=="$end-step"){
          _map.endSteps=_map.endSteps||[]
          _map.endSteps[i]=o
        }
      }else{
        _aiFlagHandler._addWarning(k,"_missStepIndex",o)
      }
    }else if(k){
      _aiFlagHandler._addWarning(k,"_missStepKey",o)
    }
  },
  _getModuleInMap:function(v){
    v=_aiFlagHandler._moduleMap[v]||_aiGeneratorDataHandler._getModuleObject(v)
    if(v){
      v=v._data||v
      return _aiFlagHandler._moduleMap[v.alias]
    }
  },
  _getLinkField:function(m){
    m=m.definition.fields
    m=m.find(x=>x.label&&x.type!="module")||m[0]
    if(m){
      return m.code
    }
  },
  //final store
  _finalStore:function(ms,_fun){
    let _map=_aiFlagHandler._data._exModuleSetting
    let _statusMap={}
    _updateFields()

    _handleBZElement()

    _handleSteps()

    _updateStatus()

    _updateFlow()

    _storeScenarios(ms,0,function(){
      _aiFlagHandler._setProcessData()
      _aiFlagHandler._batchSave(ms,0,_fun)
      _aiFlagHandler._processData._refresh
    })
    
    function _storeScenarios(ms,i,_fun){
      let m=ms[i]
      if(m){
        let d=m.definition.moduleDataFlow,ts=[]
        for(let f in d){
          for(let t in d[f].to){
            d[f].to[t].forEach(x=>{
              if(!x.data.scenario.code.match(_IDE._testKeyRegex)){
                let k=x.key
                ts.push({
                  name:_aiFlowHandler._getFlowScenarioName(t,f,m)+(k&&k!="default"?" ("+k+")":""),
                  type:"scenario",
                  definition:{
                    code:x.data.scenario.code
                  },
                  enterPoint:{
                    type:"follow"
                  },
                  hostId:m.defaultHostId,
                  tag:_statusManagement._getDataStatusByKey(t,m).name
                })
              }
            })
          }
        }
        if(ts.length){
          _ideTestManagement._batchSave(ts,m,0,function(){
            m.tests.forEach(t=>{
              if(t.definition&&t.type=="scenario"){
                let v=(t.definition.code||"").split(".")
                let vv=d[v[0]]
                if(!vv){
                  return
                }
                vv=vv.to
                if(!vv){
                  return
                }
                vv=vv[v[1]]
                if(!vv){
                  return
                }
                vv.find(x=>{
                  if(x.data.scenario.code==t.definition.code){
                    x.data.scenario.code=m.code+"."+t.code
                    return 1
                  }
                })
              }
            })
            _storeScenarios(ms,i+1,_fun)
          })
        }else{
          _storeScenarios(ms,i+1,_fun)
        }
      }else{
        _fun()
      }
    }

    function _handleBZElement(){
      //String to object and put data to right place
      for(let k in _map){
        let vs=_map[k],_remove=[]
        vs.forEach((v,i)=>{
          v=_Util._strToJson(v)
          let n=v.$module&&v.$module.$alias
          if(v.$module){
            v=v.$module
          }
          if(n&&n!=k){
            if(!_aiFlagHandler._moduleMap[n]){
              _aiFlagHandler._addWarning("_exModuleSetting","_unexistModule",v)
              _remove.unshift(i)
              return
            }
            _map[n]=_map[n]||[]

            _map[n].push(v)
            _remove.unshift(i)
          }
          
          let d=v["$init-data"]
          let m=_aiFlagHandler._moduleMap[k]
          if(d){
            delete v["$init-data"]
            d.name=d.name||"data"
            m.definition.initData=d.name
            
            m.dataMap=[d]
          }
          
          d=v["$ex-steps"]
          if(d){
            delete v["$ex-steps"]
            d.forEach(x=>{
              for(let k in x){
                _aiFlagHandler._addStep(k,x[k],x[k])
              }
            })
          }


          vs[i]=v
        })
        _remove.forEach(x=>{
          vs.splice(x,1)
        })
      }
      
      for(let k in _map){
        let vs=_map[k],vv={}
        vs.forEach(x=>{
          vv=_Util._mergeDeepWithArray(vv,x)
        })
        _map[k]=vv
      }
    }
    
    function _handleSteps(){
      Object.values(_aiFlagHandler._data._stepMap).forEach(x=>{
        if(x._master){
          let m=_aiFlagHandler._moduleMap[x._master._module]
          m.definition[x._master._group].find(g=>{
            if(g.code==x._master._code){
              ["preSteps","endSteps"].forEach(k=>{
                if(x[k]){
                  let vs=[]
                  if(x._master._button){
                    g.buttons&&g.buttons.find(b=>{
                      if(b.code==x._master._button){
                        b[k]=vs
                      }
                    })
                  }else{
                    g[k]=vs
                  }
                  x[k].forEach(y=>{
                    if(y){
                      if(y.$action){
                        vs.push(y.$action)
                      }else{
                        vs.push({
                          type:1,
                          element:y._element,
                          event:{
                            type: "mouse",
                            action: "click"
                          }
                        })
                      }
                    }
                  })
                }
              })
            }
          })
        }
      })
    }

    function _updateStatus(){
      for(let k in _map){
        let m=_map[k],md=_aiFlagHandler._moduleMap[k].definition
            _operations={},mm=_aiFlagHandler._moduleMap[k]
        
        md.operations.forEach(x=>{
          _operations[x.type]=_operations[x.type]||[]
          _operations[x.type].push(x)
        })

        let _statusList=md.moduleDataStatus
        
        if(m.$status){
          m.$status.forEach(x=>{
            _assignStatus(mm,_statusList,x,_operations.edit||[])
          })
        }
        if(m.$flow&&m.$flow.$items){
          m.$flow.$items.forEach(f=>{
            let v=f["$to-status"]
            if(v){
              _assignStatus(mm,_statusList,{$name:v},_operations.edit||[])
            }
            v=f["$from-status"]
            if(v){
              if(v.constructor==String){
                v=[v]
              }
              v.forEach(x=>{
                _assignStatus(mm,_statusList,{$name:x},_operations.edit||[])
              })
              f["$from-status"]=v
            }
          })
        }
        _ideObjHandler._map[mm.code]._data=mm
      }
    }
    //_statusList: module status list, x: one status data
    function _assignStatus(m,_statusList,x,_editors){
      let yd=_statusList.find(y=>{
        if(y.name.toLowerCase()==(x.$name||"").toLowerCase()){
          return 1
        }
      }),mc=m.code+"."
      if(!yd){
        yd={
          name:x.$name,
          id:_aiAPI._newId()
        }
        _statusList.push(yd)
        m.definition.moduleDataFlow[yd.id]={to:0}
        _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataStatus",yd.id);
      }
      
      let v=x["$opr-type"]||""
      if(v&&v.match(/^(add|edit|delete)$/i)){
        _aiFlagHandler._updateValue(yd,"opr",v.toLowerCase()||yd.opr,m,"moduleDataStatus",yd.id)
      }else if(v){
        _aiFlagHandler._addWarning("_exModuleSetting","_unexistOprType",v)
        return
      }else if(!yd.opr){
        _aiFlagHandler._updateValue(yd,"opr","edit",m,"moduleDataStatus",yd.id)
      }
      yd.oprs=yd.oprs||[]
      if(yd.opr!="delete"){
        v=x["$edit-oprs"]
        if(v){
          v.forEach(z=>{
            md.operations.find(o=>{
              if(o.alias==z.$alias){
                if(!yd.oprs.find(oo=>{
                  if(oo.test==mc+o.testCode){
                    _aiFlagHandler._updateValue(oo,"role",z.$role||z.$roles||oo.role||(_hasAuth()?"sign-in":"*"),m,"moduleDataStatus",yd.id)
                    return 1
                  }
                })){
                  yd.oprs.push({
                    test:mc+o.testCode,
                    role:z.$role||z.$roles||(_hasAuth()?"sign-in":"*")
                  })
                  _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataStatus",yd.id)
                }
              }
            })
          })
        }else if(!yd.oprs.length){
          yd.oprs=_editors.map(y=>{
            return {
              test:mc+y.testCode,
              role:_hasAuth()?"sign-in":"*"
            }
          })
          _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataStatus",yd.id)
        }
      }
    }
    
    function _updateFlow(){
      for(let k in _map){
        let m=_map[k],
            md=_aiFlagHandler._moduleMap[k].definition,
            _operations={},
            mm=_aiFlagHandler._moduleMap[k]

        md.operations.forEach(x=>{
          _operations[x.type]=_operations[x.type]||[]
          _operations[x.type].push(x)
        })

        let _statusList=md.moduleDataStatus;
        let _defStatus=_statusList.find(x=>x.default);
        
        
        if(m.$flow){
          let _items=[];
          (m.$flow.$items||[]).forEach((x,j)=>{
            let _key=x.$key,
                _from=x["$from-status"],
                to=x["$to-status"],
                _opr=x["$opr-alias"],
                _validation=x.$validation||x.$validations,
                _fields=_parseFields(x.$fields||x.$field)
                
            //handle opr
            if(!_opr){
              if(_fields){
                let _fieldsKeys=Object.keys(_fields).map(y=>{
                  let vv=md.fields.find(f=>f.data==y)
                  return vv.code
                })
                _opr=(_operations.edit||[]).find(y=>{
                  return md.contents.find(z=>{
                    if(z.code==y.lanuchPanel){
                      return !_fieldsKeys.find(f=>!z.formValues[f])
                    }
                  })
                })
              }
            }else{
              _opr=md.operations.find(o=>o.alias==_opr)
            }

            if(!_opr){
              return _aiFlagHandler._addWarning("$to-status","_unexistOpr",x)
            }
            
            //handle to
            if(!to){
              if(_opr.type=="delete"){
                _statusList.find(s=>{
                  if(s.opr=="delete"){
                    to=s.name
                    return 1
                  }
                })
              }else{
                to=_defStatus.name
              }
            }

            //handle from
            if(!_from){
              if(_opr.type!="add"){
                _from=[_defStatus.name]
              }else{
                _from=[""]
              }
            }

            //handle dependencies
            let _dependencies=_Util._clone(m.$flow.$dependencies||[])
            _dependencies=_dependencies.concat(x.$dependencies||[])
            
            _opr=mm.code+"."+_opr.testCode
            
            _from.forEach(f=>{
              let dd=_items.find(x=>x._key==_key&&x._from==f&&x.to==to)
              if(dd){
                let o=dd._oprs.find(o=>o._opr==_opr)
                if(!o){
                  dd._oprs.push({
                    _opr:_opr,
                    _fields:x.$fields
                  })
                }else{
                  if(!o._fields){
                    o._fields=x.$fields
                  }else{
                    Object.assign(o._fields,x.$fields)
                  }
                }
                dd._roles=dd._roles||x.$role||x.$roles
                dd._dependencies=dd._dependencies||_dependencies
                dd._validation=_validation
              }else{
                dd={
                  _key:_key,
                  _from:f,
                  _validation:_validation,
                  to:to,
                  _oprs:[{
                    _opr:_opr,
                    _fields:x.$fields
                  }],
                  _roles:x.$role||x.$roles,
                  _dependencies:_dependencies
                }
                _items.push(dd)
              }

            })
          });
          
          _items.forEach(x=>{
            _buildFlow(mm,md.moduleDataFlow,_statusList,x._from,x.to,x._dependencies,x._oprs,x._roles,x._key,x._validation)
          })
        }
        _buildMissFlow(mm,md.moduleDataFlow,_operations,_statusList,_defStatus)
      }
    }
    
    function _parseFields(v){
      if(v){
        if(v.$alias){
          let d={}
          d[v.$alias]=v.$value||true
          return d
        }else if(v.constructor==Array){
          let d={},k
          v.forEach((x,i)=>{
            if(x.$alias){
              k=0
              d[x.$alias]=x.$value||true
            }else if(k){
              d[k]=x
            }else{
              k=x
            }
          })
          return _Util._isEmpty(d)?undefined:d
        }else{
          return v
        }
      }
    }
    
    function _buildMissFlow(m,_flowMap,_operations,_statusList,_defStatus){
      let _rebuild
      for(let k in _flowMap){
        if(k=="start"){
          continue
        }
        if(!_hasFlow(_flowMap,k)){
          let _from,to,_opr,_role;
          _statusList.find(x=>{
            if(x.id==k){
              to=x.name
              if(x.opr!="add"){
                _from=_defStatus.name
              }
              _opr=_operations[x.opr]
              if(_opr){
                if(_opr.length>1){
                  _opr=_getUnRefOpr(_flowMap,_opr,m)||opr[0]
                }else{
                  _opr=_opr[0]
                }
              }else{
                _aiFlagHandler._addWarning("","_missOpr",x.opr)
              }
              return 1
            }
          })
          if(to&&_opr){
            _rebuild=1
            _buildFlow(m,_flowMap,_statusList,_from||"",to,[],[{
              _opr:m.code+"."+_opr.testCode
            }])
          }
        }
      }
      if(_rebuild){
        _buildMissFlow(m,_flowMap,_operations,_statusList,_defStatus)
      }
    }
    
    function _getUnRefOpr(_flowMap,_oprs,m){
      return _oprs.find(o=>{
        for(let k in _flowMap){
          k=_flowMap[k].to
          if(k){
            for(let kk in k){
              if(k[kk].data,oprs.find(x=>x.test==m.code+"."+o.testCode)){
                return 
              }
            }
          }
        }
        return 1
      })
    }

    function _hasFlow(_flowMap,k){
      if(_flowMap[k].to){
        for(let kk in _flowMap){
          kk=_flowMap[kk]
          if(kk.to&&kk.to[k]){
            return 1
          }
        }
      }else{
        return 1
      }
    }
    
    function _buildFlow(m,_flowMap,_statusList,_from,to,_dependencies,_oprs,_role,_key,_validation){
      _key=_key||"default"
      let _varName=_aiGeneratorDataHandler._getCurModuleDataName(m),
          _defStatus=_statusList.find(x=>x.default);
      _from=_statusList.find(x=>x.name.toLowerCase()==_from.toLowerCase())
      if(_from){
        _from=_from.id
      }else{
        _from="start"
      }
      to=_statusList.find(x=>x.name.toLowerCase()==to.toLowerCase())
      _toOpr=to.name
      to=to.id

      _flowMap[_from]=_flowMap[_from]||{}
      _flowMap[_from].to=_flowMap[_from].to||{}
      _flowMap[_from].to[to]=_flowMap[_from].to[to]||[]
      let s=_flowMap[_from].to[to]
      let d=s.find(x=>x.key==_key)
      
//      let _path=_from+".to."+to+".data"
      let _path=_from+"."+to

      if(!d){
        d={
          data:{
            oprs:[],
            dependencies:[]
          },
          key:_key
        }
        s.push(d)
        _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",_key,_path)
      }
      _Util._spliceAll(d.data.oprs, x=>!_oprs.find(t=>t._opr==x.test))
      //update oprs
      _oprs.forEach(o=>{
        let t=d.data.oprs.find(t=>o._opr==t.test)
        if(!t){
          t={
            test:o._opr,
            scenarioFields:[],
            required:"on",
            varName:_varName,
            stepKey:"when",
            data:[]
          }
          d.data.oprs.push(t)
          // _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key+"/"+t.test,_path+".oprs.test")
          _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key,_path)
        }
        o._fields=o._fields||[]
        // _Util._spliceAll(t.data, x=>{
          // return !o._fields.find(y=>y==x.field)
        // })
        for(let k in o._fields){
          let f=m.definition.fields.find(f=>f.data==k);
          // let _key=d.key+"/"+t.test+"/"+f.code
          if(f){
            let ff=t.data.find(x=>x.field==f.code)
            if(ff){
              // _aiFlagHandler._updateValue(ff,"value",o._fields[k],m,"moduleDataFlow",_key,_path+".oprs.data.field")
              _aiFlagHandler._updateValue(ff,"value",o._fields[k],m,"moduleDataFlow",d.key,_path)
            }else{
              t.data.push({
                value:o._fields[k],
                colName:k,
                field:m.code+"."+f.code
              })
              // _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",_key,_path+".oprs.data.field")
              _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key,_path)
            }
          }
        }
      })

      //update role
      _aiFlagHandler._updateValue(d.data,"roles",d.data.roles||_role||(_hasAuth()?"sign-in":"*"),m,"moduleDataFlow",d.key,_path)

      //update dependencies
      // _Util._spliceAll(d.data.dependencies,x=>{
        // return !_dependencies.find(y=>{
          // let dm=_aiFlagHandler._moduleMap[y.$module]
          // return dm.code==x.code&&x.data.find(z=>z.field=="$status"&&(z.value||"").toLowerCase()==(y.$status||"").toLowerCase())
        // })
      // })
      _dependencies.forEach((y,i)=>{
        let dm=_aiFlagHandler._moduleMap[y.$module]
        
        let dd=d.data.dependencies.find(x=>{
          return dm.code==x.code&&x.data.find(z=>z.field=="$status"&&(z.value||"").toLowerCase()==(y.$status||"").toLowerCase())
        })
        if(!dd){
          dd={
            varName:_aiGeneratorDataHandler._getCurModuleDataName(dm),
            code:dm.code,
            data:[
              {
                field:"$status",
                colName:dm.alias+"_"+"status",
                value:y.$status
              }
            ],
            scenarioFields:[],
            idx:i,
            stepKey:"given"
          }
          
          if(m.code!=dm.code){
            _insertFieldDependencies(m,dm,dd.data)
          }
          d.data.dependencies.push(dd)
          // _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key+"/"+dd.code,_path+".dependencies.code")
          _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key,_path)
        }
        let ii=d.data.dependencies.indexOf(dd)
        if(ii!=i){
          d.data.dependencies.splice(ii,1)
          d.data.dependencies.splice(i,0,dd)
          _aiFlagHandler._setModuleUpdate(m)
        }
      })

      if(_from=="start"){
        if(m.parentModule){
          if(!d.data.dependencies.find(d=>d.code==m.parentModule)){
            let pm=_ideObjHandler._getDataByPath(m.parentModule)
            
            let dd={
              code:m.parentModule,
              idx:0,
              stepKey:"given",
              varName:_aiGeneratorDataHandler._getCurModuleDataName(m.parentModule),
              scenarioFields:[],
              data:[{
                colName:pm._data.alias+"_"+"status",
                field:"$status",
                value:_statusManagement._getModuleDefStatus(pm).name
              }]
            }
            d.data.dependencies.unshift(dd)
            _insertFieldDependencies(m,m.parentModule,dd.data)
            // _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key+"/"+dd.code,_path+".dependencies.code")
            _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key,_path)
          }
        }
        m.definition.fields.forEach(f=>{
          if(f.type=="module"&&f.module!=m.code){
            if(!d.data.dependencies.find(d=>d.code==f.module)){
              let fm=_aiGeneratorDataHandler._getModuleObject(f.module)
              if(fm&&!_aiAuthHandler._isAuthItem(fm)){
                
                let dd={
                  code:f.module,
                  idx:d.data.dependencies.length,
                  stepKey:"given",
                  varName:_aiGeneratorDataHandler._getCurModuleDataName(fm),
                  scenarioFields:[],
                  data:[{
                    colName:fm._data.alias+"_"+"status",
                    field:"$status",
                    value:_statusManagement._getModuleDefStatus(fm).name
                  }]
                }

                _insertFieldDependencies(m,f.module,dd.data)

                d.data.dependencies.push(dd)
                // _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key+"/"+dd.code,_path+".dependencies.code")
                _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key,_path)
              }
            }
          }
        })
        d.data.dependencies.forEach((x,i)=>{
          _aiFlagHandler._updateValue(x,"idx",i,m)
        })
      }

      let _forDelete=_statusList.find(x=>x.id==to).opr=="delete"?"on":""
      if(!d.data.scenario){
        d.data.scenario={
          enable: "on",
          data: [],
          given: [],
          when: [],
          then: [{
            scenarioFields:[],
            varName:_varName,
            stepKey:"then",
            test:_findValidTest(m),
            forDelete:_forDelete
          }],
          code:_from+"."+to+"."+d.key
        }

        // _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key+"/"+d.data.scenario.code,_path+".scenario.code")
        _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key,_path)

        if(_statusList.find(x=>x.id==to&&x.opr!="add")){
          d.data.scenario.curGiven={
            varName: _varName,
            code:m.code+"."+m.tests.find(t=>t.definition&&t.definition.type=="has").code,
            status: _from,
            data: [
              {
                field: "$status",
                value: _statusList.find(x=>x.id==_from).name
              }
            ],
            scenarioFields: [],
            idx: 0,
            stepKey: "given"
          }
        }
      }
      if(_validation){
        if(_validation.constructor!=Array){
          _validation=[_validation]
        }
        d.data.scenario.then=d.data.scenario.then||[]
        _validation.forEach(x=>{
          let xt,xm=x.$module?_aiFlagHandler._getModuleInMap(x.$module):m;
          if(x.$alias){
            xt=xm.definition.contents.find(y=>y.alias==x.$alias)
            if(xt.testVE){
              xt=xm.code+"."+xt.testVE
            }
          }

          xt=xt||_findValidTest(xm)

          if(!d.data.scenario.then.find(x=>x.test==xt&&x.forDelete==_forDelete)){
            d.data.scenario.then.push({
              scenarioFields:[],
              varName:x.$module?_aiGeneratorDataHandler._getCurModuleDataName(xm):_varName,
              stepKey:"then",
              test:xt,
              forDelete:_forDelete 
            })
            // _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key+"/"+xt,_path+".scenario.then.test")
            _aiFlagHandler._setModuleUpdate(m,"_new","moduleDataFlow",d.key,_path)
          }
        })
      }
    }
    
    function _insertFieldDependencies(tm,fm,_list){
      fm=_aiFlagHandler._getModuleInMap(fm)
      let mp={}
      tm.definition.fields.forEach(x=>{
        (x.dependencies||[]).forEach(d=>{
          d.items.forEach(y=>{
            if(y.module==fm.code||y.module==fm.alias){
              mp[y.field]=mp[y.field]||[]
              mp[y.field].push(y.value)
            }
          })
        })
      })

      for(let k in mp){
        let vs=mp[k],vv=[]
        vs=vs.map(x=>_aiFlagHandler._stdDependenciesRegexToArray(x))
        vs.forEach(x=>vv.push(...x))
        vv=new Set(vv)
        vv=[...vv]
        let f=fm.definition.fields.find(x=>x.code==k)
        _list.push({
          colName:f.data,
          field:fm.code+"."+f.code,
          value:_aiFlagHandler._arrayToStdDependenciesRegex(vv)
        })
      }
    }
    
    function _findValidTest(m){
      let t=m.definition.contents.find(x=>x.testVE)
      if(t){
        return m.code+"."+t.testVE
      }
    }
    
    function _getTestPathByAlias(v,m){
      v=m.definition.operations.find(x=>x.alias==v)
      if(v){
        return m.code+"."+v.testCode
      }
    }
    
    function _hasAuth(){
      return _IDE._data._setting.authList[_aiFlagHandler._data._hostIdx].inAuth
    }

    //update dependencies
    function _updateFields(){
      ms.forEach(m=>{
        if(!m.definition.startPanel){
          if(_aiFlagHandler._data.fullHyApp){
            m.definition.startPanel="url"
          }
          m.definition.contents.find(x=>{
            if(x.type=="enterModule"){
              x.name=x.name||m.name
              if(!m.definition.startPanel){
                m.definition.startPanel=x.code
              }
              return 1
            }
          })
        }
        
        _aiFlagHandler._updateAllModuleCode(m)
      })
    }
  },
  _updateAllModuleCode:function(m){
    m.definition.fields.forEach(f=>{
      f.type=f.type||"string";
      _aiFlagHandler._updateValue(f,"type",f.type||"string",m,"fields",f.code);
      (f.dependencies||[]).forEach(d=>{
        (d.items||[]).forEach(i=>{
          m._update=_aiFlagHandler._updateModuleCode(i,"module")||m._update;
          if(i.field&&!$.isNumeric(i.field)){
            dm.definition.fields.find(x=>{
              if(x.data==i.field){
                i.field=x.code
                m._update=1
                return 1
              }
            })
          }
        })
      });

      if(f.type=="module"){
        m._update=_aiFlagHandler._updateModuleCode(f,"module")||m._update;
        let rm=Object.values(_aiFlagHandler._moduleMap).find(x=>x.code==f.module)
        
        if(rm){
          if(f.mapLabel){
            if(!$.isNumeric(f.mapLabel)){
              rm=rm.definition.fields.find(x=>x.data==f.mapLabel)
              if(rm){
                _aiFlagHandler._updateValue(f,"mapLabel",rm.code,m,"fields",f.code)
              }
            }
          }else{
            _aiFlagHandler._updateValue(f,"mapLabel",_aiFlagHandler._getLinkField(rm),m,"fields",f.code)
          }
        }
      }
    })
    m.definition.contents.forEach(x=>{
      if(x.from){
        x.from.forEach(y=>{
          m._update=_aiFlagHandler._updateModuleCode(y,"module")||m._update
        })
      }
      if(x.buttons){
        x.buttons.forEach(b=>{
          m._update=_aiFlagHandler._updateModuleCode(b,"lanuchModule")||m._update
        })
      }
    })
    
    m.definition.relatedModules.forEach(x=>{
      m._update=_aiFlagHandler._updateModuleCode(x,"module")||m._update
    })
  },
  //final step: execute on IDE
  _store:function(ms,_fun){
    _preStore(ms,0)
    
    function _preStore(ms,i){
      let m=ms[i];
      if(m){
        if(!m._chk||!m._update){
          return _preStore(ms,i+1)
        }
        if(m.code){
          let cm=_ideObjHandler._getDataByPath(m.code)
          if(cm){
            m.updateStamp=cm._data.updateStamp
          }
        }
        _ideModuleManagement._save(m,function(mm){
          ms[i]=_aiFlagHandler._synaModule(m,mm)

          _storeNewModuleTests(m,function(){
            _preStore(ms,i+1)
          })
        })
      }else{
        _updateModules(ms,_fun)
      }
    }
    
    function _storeNewModuleTests(m,_fun){
      let ts=[]
      if(!m.tests.length){
        //suite test case
        ts.push(_testCaseBodyHandler._getTest(m,_bzMessage._aiDefinition._mainSuite,"suite","int"))
        //ctrl test case
        ts.push(_testCaseBodyHandler._getTest(m,_Util._formatMessage(_bzMessage._aiDefinition._has,m.name),"has","unit","ctrl"))
      }
      
      //validation test cases
      m.definition.contents.forEach(x=>{
        if(_bzMessage._model._panelType[x.type]&&!x.testVE){
          if(x.type=="form"){
            if(!m.definition.operations.find(y=>x.from.find(z=>z.code==y.code)&&y.type=="edit")){
              return 
            }
          }else if(x.type=="modulePanel"){
            return
          }
          x.name=x.name||_aiModelHandler._getPanelName(x,m)
          
          let tt={
            testVE:_Util._formatMessage(_bzMessage._aiDefinition._validationName,[m.name+ ' - '+x.name]),
            code:x.code
          }
          tt=_testCaseBodyHandler._getValidation(tt,"testVE",m)
          ts.push(tt)
        }
      })
      
      //unit test cases
      m.definition.operations.forEach(t=>{
        if(!t.testCode){
          let tt=_testCaseBodyHandler._getTest(m,t.name,t.type,"unit","operation")
          tt.definition.code=t.code
          tt.tag=t.type
          ts.push(tt)
        }
      })
      
      _ideTestManagement._batchSave(ts,m,0,function(){
        _fun()
      })
    }

    function _updateModules(ms,_fun){
      ms.forEach(m=>{
        m._update=0
        m.definition.operations.forEach(t=>{
          if(!t.testCode){
            
            m.tests.find(x=>{
              if(x.definition&&x.definition.code==t.code){
                _aiFlagHandler._updateValue(t,"testCode",x.code,m)
                return 1
              }
            })
          }
        })
        m.definition.contents.forEach(t=>{
          m.tests.find(x=>{
            if(x.definition&&x.definition.type=="testVE"&&x.definition.from==t.code){
              _aiFlagHandler._updateValue(t,"testVE",x.code,m)
              return 1
            }
          })
        })
        _Util._findDeepObj(m.definition,(v,k,pk,ps,o)=>{
          if(k=="module"&&v&&!v.match(/^m[0-9]+$/)){
            v=_aiFlagHandler._moduleMap[v]
            if(v){
              _aiFlagHandler._updateValue(o,k,v.code,m)
            }
          }
        })
      })
      
      _aiFlagHandler._batchSave(ms,0,_fun)
    }
  },
  _synaModule:function(m,mm){
    _aiFlagHandler._moduleMap[mm.alias]=mm
    mm._chk=m._chk
    mm._new=m._new
    return mm
  },
  _batchSave:function(ms,i,_fun){
    let m=ms[i]
    if(m){
      if(m._update){
        m._update=0
        _ideModuleManagement._save(m,function(mm){
          ms[i]=_aiFlagHandler._synaModule(m,mm)
          _aiFlagHandler._batchSave(ms,i+1,_fun)
        })
      }else{
        _aiFlagHandler._batchSave(ms,i+1,_fun)
      }
    }else{
      _fun()
    }
  },
  _init:function(){
    _aiFlagHandler._data=_CtrlDriver._buildProxy({
      _environment:0,
      _hostIdx:0,
      _exeList:[],
      _warnings:[],
      _ids:{},
      _stepMap:{},
      _exModuleSetting:{},
      _updateInfo:{}
    });
    let ad=_aiFlagHandler._data
    _initSetting()
    _aiFlagHandler._processData._status=""
    //TODO: check button position
    _Util._confirmMessage({
      _tag:"div",
      _update:function(){
        _Util._resizeModelWindow()
      },
      _items:[
        //tabs
        {
          _tag:"div",
          _attr:{
            class:"bz-h-h-tab-items"
          },
          _items:[
            {
              _tag:"div",
              _attr:{
                style:"padding:5px 10px;",
                class:"'bz-h-h-tab-item '+(_aiFlagHandler._processData._curSettingTab==_data._item?'white-active':'')"
              },
              _text:"_bzMessage._aiFlag._tabs[_data._item]",
              _dataRepeat:function(){
                return ["_setting","_script"]
              },
              _jqext:{
                click:function(){
                  _aiFlagHandler._processData._curSettingTab=this._data._item
                  _Util._resizeModelWindow()
                }
              }
            },
          ]
        },
        //Setting
        {
          _if:"_aiFlagHandler._processData._curSettingTab=='_setting'",
          _tag:"div",
          _attr:{
            class:"bz-h-h-tab-content",
            style:function(){
              return `max-height:${window.innerHeight-250}px;padding:5px;width:calc(100% - 12px);`
            }
          },
          _items:[
            _stdComponent._getBoxViewDef({
              _items:[
                {
                  _type:"_rowbox",
                  _update:function(){
                    _initSetting()
                    _Util._resizeModelWindow()
                  },
                  _items:[
                    //environments
                    {
                      _label:"_bzMessage._setting._environment._title",
                      _dataModel:"_IDE._data._setting.curEnvironment",
                      _type:"select",
                      _text:"_data._item.name",
                      _value:"_data._idx",
                      _dataRepeat:"_IDE._data._setting.environments"
                    },
                    //host idx
                    {
                      _if:"_IDE._data._setting.environments[_IDE._data._setting.curEnvironment].items.find(x=>x.host)",
                      _label:"_bzMessage._setting._subscription._server",
                      _dataModel:"_aiFlagHandler._data._hostIdx",
                      _type:"select",
                      _text:"_data._item.name+' ('+_data._item.host+')'",
                      _value:"_data._idx",
                      _dataRepeat:"_IDE._data._setting.environments[_IDE._data._setting.curEnvironment].items"
                    },
                    //new host
                    {
                      _if:function(){
                        return !_IDE._data._setting.environments[ad._environment].items.find(x=>x.host)
                      },
                      _label:"URL",
                      _dataModel:"_aiFlagHandler._data._host",
                      _jqext:{
                        change:function(){
                          this._data.startUrl=this.value
                          BZ._launchCurEnvUrl(this.value)
                        }
                      }
                    },
                  ]
                },
                {
                  _src:{
                    _tag:"fieldset",
                    _attr:{
                      style:function(){
                        let s="border-width:0;padding:unset;margin:8px 0;"
                        if(_IDE._data._setting.authList[_aiFlagHandler._data._hostIdx].inAuth){
                          s="border-width:1px;padding:5px 10px 7px 10px;margin:8px 0;"
                        }
                        return s
                      }
                    },
                    _items:[
                      //Enable Auth
                      {
                        _tag:"legend",
                        _items:[
                          {
                            _tag:"label",
                            _items:[
                              {
                                _tag:"input",
                                _attr:{
                                  type:"checkbox",
                                  disabled:"_aiAuthHandler._getRolesByHostId(_aiFlagHandler._data._hostIdx).length"
                                },
                                _dataModel:"_IDE._data._setting.authList[_aiFlagHandler._data._hostIdx].inAuth"
                              },
                              {
                                _text:"_bzMessage._setting._environment._enableAuthSetting"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        _if:"_IDE._data._setting.authList[_aiFlagHandler._data._hostIdx].inAuth",
                        _tag:"div",
                        _items:[
                          _stdComponent._getBoxViewDef({
                            _items:[
                              {
                                _type:"checkbox",
                                _label:"_bzMessage._aiDefinition._skipLogin",
                                _dataModel:"_aiFlagHandler._data._skipLogin"
                              },
                              //role list
                              {
                                _if:"_aiAuthHandler._getRolesByHostId(_aiFlagHandler._data._hostIdx).length",
                                _label:"_bzMessage._aiDefinition._role",
                                _type:"select",
                                _disabled:"_aiFlagHandler._data._skipLogin",
                                _text:"_data._item",
                                _value:"_data._item",
                                _dataRepeat:"_aiAuthHandler._getRolesByHostId(_aiFlagHandler._data._hostIdx)",
                                _dataModel:"_aiFlagHandler._data._role",
                                _jqext:{
                                  change:function(){
                                    setTimeout(()=>{
                                      _initSetting(_aiFlagHandler._data._role)
                                    },100)
                                  }
                                }
                              },
                              //role
                              {
                                _if:"!_aiAuthHandler._getRolesByHostId(_aiFlagHandler._data._hostIdx).length",
                                _label:"_bzMessage._aiDefinition._role",
                                _disabled:"_aiFlagHandler._data._skipLogin",
                                _dataModel:"_aiFlagHandler._data._role"
                              },
                              {
                                _type:"_rowbox",
                                _items:[
                                  //exist username
                                  {
                                    _if:"_aiAuthHandler._getRolesByHostId(_aiFlagHandler._data._hostIdx).length",
                                    _label:"_bzMessage._login._userName",
                                    _type:"select",
                                    _text:"_data._item.username",
                                    _value:"_data._item.username",
                                    _disabled:"_aiFlagHandler._data._skipLogin",
                                    _dataRepeat:function(){
                                      let d=_aiAuthHandler._getUserDataMap(ad._hostIdx)
                                      d=d.filter(x=>x.role==ad._role)
                                      if(!d.find(x=>x.username==ad.username)){
                                        ad.username=""
                                      }
                                      return d
                                    },
                                    _dataModel:"_aiFlagHandler._data.username",
                                    _jqext:{
                                      change:function(){
                                        setTimeout(()=>{
                                          _initSetting(_aiFlagHandler._data._role,_aiFlagHandler._data.username)
                                        },100)
                                      }
                                    }
                                  },
                                  //new username
                                  {
                                    _if:"!_aiAuthHandler._getRolesByHostId(_aiFlagHandler._data._hostIdx).length",
                                    _label:"_bzMessage._login._userName",
                                    _disabled:"_aiFlagHandler._data._skipLogin",
                                    _dataModel:"_aiFlagHandler._data.username"
                                  },
                                  //password
                                  {
                                    _type:"password",
                                    _label:"_bzMessage._login._password",
                                    _disabled:"_aiFlagHandler._data._skipLogin||_aiAuthHandler._getRolesByHostId(_aiFlagHandler._data._hostIdx).length",
                                    _dataModel:"_aiFlagHandler._data.password"
                                  }
                                ]
                              },
                              {
                                _type:"_rowbox",
                                _items:[
                                  //extra value
                                  {
                                    _label:"_bzMessage._login._extra",
                                    _disabled:"_aiFlagHandler._data._skipLogin||_aiAuthHandler._getRolesByHostId(_aiFlagHandler._data._hostIdx).length",
                                    _dataModel:"_aiFlagHandler._data.extra"
                                  },
                                  //identifier
                                  {
                                    _label:"_bzMessage._aiDefinition._identify",
                                    _disabled:"_aiFlagHandler._data._skipLogin||_aiAuthHandler._getRolesByHostId(_aiFlagHandler._data._hostIdx).length",
                                    _dataModel:"_aiFlagHandler._data.identifier"
                                  }
                                ]
                              }
                            ]
                          })
                        ]
                      }
                    ]
                  }
                },
                //start url
                {
                  _label:"_bzMessage._aiDefinition._startUrl",
                  _dataModel:"_aiFlagHandler._data.startUrl",
                  _btn:{
                    _icon:"btn btn-icon bz-small-btn bz-popout",
                    _jqext:{
                      click:function(){
                        BZ._launchCurEnvUrl(_aiFlagHandler._data.startUrl)
                      }
                    }
                  }
                },
                //as a full hy app
                {
                  _src:{
                    _tag:"fieldset",
                    _attr:{
                      style:function(){
                        let s="border-width:0;padding:unset;margin:8px 0;"
                        if(_aiFlagHandler._data.fullHyApp){
                          s="border-width:1px;padding:5px 10px 7px 10px;margin:8px 0;"
                        }
                        return s
                      }
                    },
                    _items:[
                      {
                        _tag:"legend",
                        _items:[
                          {
                            _tag:"label",
                            _items:[
                              {
                                _tag:"input",
                                _attr:{
                                  type:"checkbox"
                                },
                                _dataModel:"_aiFlagHandler._data.fullHyApp"
                              },
                              {
                                _text:"_bzMessage._aiDefinition._fullHyApp"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        _if:"_aiFlagHandler._data.fullHyApp",
                        _tag:"div",
                        _after:function(){
                          _aiFlagHandler._data.handleUrl=_aiFlagHandler._data.handleUrl||"function(url, module){\n  return url;\n}"
                        },
                        _items:[
                          {
                            _tag:"div",
                            _attr:{
                              style:"padding:0 0 5px 5px;"
                            },
                            _text:"_bzMessage._aiFlag._handleUrl"
                          },
                          {
                            _tag:"textarea",
                            _attr:{
                              class:"bz-editor",
                              style:"height:100px;padding:5px;",
                              spellcheck:false
                            },
                            _dataModel:"_aiFlagHandler._data.handleUrl"
                          }
                        ]
                      }
                    ]
                  }
                }
              ]
            })
          ]
        },
        //script
        {
          _if:"_aiFlagHandler._processData._curSettingTab=='_script'",
          _tag:"div",
          _attr:{
            class:"bz-h-h-tab-content",
            style:function(){
              return `max-height:${window.innerHeight-250}px;padding:5px;width:calc(100% - 12px);`
            }
          },
          _items:[
            {
              _tag:"div",
              _items:[
                {
                  _tag:"a",
                  _text:"_bzMessage._aiDefinition._setTmpFlag",
                  _attr:{
                    class:"bz-clickable bz-left-space-5",
                  },
                  _jqext:{
                    click:function(){
                      _aiFlagHandler._assignFlagByScript(2)
                    }
                  }
                },
                {
                  _tag:"button",
                  _attr:{
                    style:"position: absolute;right: 60px;margin-top: 1px;",
                    class:"btn btn-icon bz-cross bz-small-btn",
                    title:"_bzMessage._method._cleanFlag"
                  },
                  _jqext:{
                    click:function(){
                      _aiFlagHandler._assignFlagByScript(1)
                    }
                  }
                },
                {
                  _tag:"button",
                  _attr:{
                    style:"position: absolute;right: 20px;margin-top: -3px;",
                    class:"btn btn-icon bz-merge-btn",
                    title:"_bzMessage._method._pickAndCopyElementPath"
                  },
                  _items:[
                    {
                      _tag:"span",
                      _attr:{
                        class:"bz-dompicker"
                      }
                    },
                    {
                      _tag:"span",
                      _attr:{
                        class:"bz-copy"
                      }
                    },
                  ],
                  _jqext:{
                    click:function(){
                      _bzDomPicker._pickDetails("_path",function(v){
                        _Util._copyData(v)
                      })
                    }
                  }
                }
              ]
            },
            {
              _tag:"div",
              _after:function(){
                _aiFlagHandler._data.handleUrl=_aiFlagHandler._data.handleUrl||"function(url, module){\n  return url;\n}"
              },
              _items:[
                {
                  _tag:"textarea",
                  _attr:{
                    class:"bz-editor",
                    style:"height:300px;padding:5px;",
                    spellcheck:false
                  },
                  _dataModel:"_aiFlagHandler._data.tmpFlagScript",
                  _jqext:{
                    change:function(){
                      _extensionComm._setShareData({"_aiFlagHandler._data.tmpFlagScript":_aiFlagHandler._data.tmpFlagScript})
                    }
                  }
                }
              ]
            },
            // use bz-flag on element path
            _stdComponent._getInputViewDef({
              _type:"checkbox",
              _label:"_bzMessage._aiDefinition._avoidBzFlagElement",
              _dataModel:"_aiFlagHandler._data.avoidBzFlagElement",
              _boxClass:"bz-row-1",
              _boxStyle:"margin-left:2px;padding:8px 0 3px 0;",
              _labelStyle:"position:relative;top:0px;"
            })
          ]
        },
        //note
        {
          _tag:"div",
          _attr:{
            class:"bz-note-text bz-top-space-10"
          },
          _text:function(){
            let v=_bzMessage._model
            if(_aiFlagHandler._processData._curSettingTab=='_script'){
              v=v._aiBuilderScriptDesc
            }else{
              v=v._aiBuilderDesc
            }
            return v
          }
        }
      ]
    },[{
      _title:_bzMessage._method._start,
      _class:"bz-play btn-icon-text btn-secondary",
      _click:function(c){
        if(_aiFlagHandler._data.fullHyApp&&_aiFlagHandler._data.handleUrl){
          let f=_aiFlagHandler._buildHandleUrlFun(_aiFlagHandler._data.handleUrl)
          if(!f){
            return
          }else{
            _aiFlagHandler._data._handleUrlFun=f
          }
        }
        if(!_aiFlagHandler._data._skipLogin&&_IDE._data._setting.authList[_aiFlagHandler._data._hostIdx].inAuth){
          return _buildAuth(ad,c)
        }
        _doStart("_playing",c)
      }
    },{
      _title:_bzMessage._test._play._stepByStep,
      _class:"bz-step btn-icon-text btn-secondary",
      _click:function(c){
        _doStart("_pause",c)
      }
    }],_bzMessage._model._aiIdentifySetting,600)
    
    function _doStart(t,c){
      _IDE._data._setting.authList[ad._hostIdx]=_IDE._data._setting.authList[ad._hostIdx]||{}
      _IDE._data._setting.authList[ad._hostIdx].scan={
        startUrl:ad.startUrl,
        fullHyApp:ad.fullHyApp,
        handleUrl:ad.handleUrl,
        avoidBzFlagElement:ad.avoidBzFlagElement,
        tmpFlagScript:ad.tmpFlagScript
      }
      
      _ideVersionManagement._save(function(){
        _aiFlagHandler._setExeType(t)
        _aiFlagHandler._identifyApp(ad)
      })

      c._ctrl._close()
    }
    function _buildAuth(ad,c){
      if(!ad.username){
        return alert(_bzMessage._aiFlag._error._missingUserName)
      }
      ad._scanAuth={}
      let hs=_aiAuthHandler._getRolesByHostId(ad._hostIdx)
      if(!hs.length){
        let i=_IDE._data._setting.curEnvironment
        let e=_IDE._data._setting.authList[i]
        if(!e){
          _IDE._data._setting.authList[i]={}
          e=_IDE._data._setting.authList[i]
        }
        e.inAuth="on"
        _aiAuthHandler._openSetting(ad._hostIdx,[{
          role:ad._role||"",
          username:ad.username,
          password:ad.password||"",
          identifier:ad.identifier||"",
          extra:ad.extra||""
        }],function(d){
          ad._auth=d
          _doStart("_playing",c)
        })
      }else{
        _doStart("_playing",c)
      }
    }
    
    function _initSetting(_role,_username){
      let s=_IDE._data._setting
      let h=s.environments[s.curEnvironment].items[ad._hostIdx]
      let a=s.authList[ad._hostIdx]
      if(a.scan){
        ad.startUrl=a.scan.startUrl
        ad.fullHyApp=a.scan.fullHyApp
        ad.handleUrl=a.scan.handleUrl
        ad.avoidBzFlagElement=a.scan.avoidBzFlagElement
        ad.tmpFlagScript=a.scan.tmpFlagScript
      }
      if(!_role){
        if(h){
          ad.startUrl=h.host||ad.startUrl
          BZ._launchCurEnvUrl(ad.startUrl)
        }
      }
      
      h=_aiAuthHandler._getRolesByHostId(ad._hostIdx)
      if(h.length){
        ad._role=_role||h[0]
        
        let u=_aiAuthHandler._getUserDataMap(ad._hostIdx)
        u.find(x=>{
          if((_username&&x.username==_username)||(!_username&&x.role==ad._role)){
            ad.username=x.username
            ad.password=x.password
            ad.extra=x.extra
            ad.identifier=x.identifier
            ad._skipLogin="on"
            return 1
          }
        })
      }
    }
  },
  _getErgodicValueList:function(e){
    let vs=e._ergodicValueList
    if(!vs){
      let ee=_aiFlagHandler._parseBZFlag(e.dataset.bz||"")
      if(ee.length){
        if(ee.find(x=>{
          if(x.$field){
            if(Object.keys(x.$field).find(x=>x.includes("$ergodic"))){
              let xx=x.$field.$ergodic||x.$field["$ergodic-next"]
              vs=xx.value
              if(!vs){
                if(e.tagName=="SELECT"){
                  vs=[]
                  for(let x of e.options){
                    x=x.innerText.trim()
                    vs.push(x)
                  }
                  xx.value=vs
                }else{
                  vs=_cssHandler._isList(e)
                  if(vs){
                    xx.value=vs.map(x=>x.innerText)
                  }
                }
                
              }
              return 1
            }
          }
        })){
          if(!vs){
            vs=_cssHandler._isList(e)
            if(vs){
              vs=vs.map(x=>x.innerText)
            }else{
              return
            }
          }
          e._ergodicValueList=vs

        }
      }
    }
    return vs
  },
  _getErgodicValue:function(e){
    if(e._ergodicValue){
      return e._ergodicValue
    }
    let vs=_aiFlagHandler._getErgodicValueList(e)
    if(vs){
      if(e._ergodicIdx===undefined){
        e._ergodicIdx=0
      }else{
        e._ergodicIdx++
      }
      return vs[e._ergodicIdx]||vs[0]
    }
  },
  _isErgodicField:function(o){
    return (o.dataset.bz||"").match(/\$ergodic([^-]|$)/)
  },
  _hasNextErgodicValue:function(e){
    if(!_aiFlagHandler._isErgodicField(e)){
      return
    }
    let vs=_aiFlagHandler._getErgodicValueList(e)
    if(vs){
      let i=e._ergodicIdx
      return i===undefined||i+1<=vs.length
    }else{
      if(!_Util._isStdInputElement(e)){
        e._requestErgodicList=1
      }
      return e._requestErgodicList
    }
    
  },
  _getDefTmpScript:function(){
    let data = [{url:"/./",list:[{element:"A",bz:"$module-enter"}]}];
    return `let data = ${JSON.stringify(data,0,2).replace("\"/./\"","/./")};\n(${_Util._formatFun(_script.toString().replace(" _script",""))})();`
    function _script(){
      let href=location.href;
      data.forEach(p=>{
        if(!p.url||(p.url.constructor==RegExp&&href.match(p.url))||(p.url.constructor==Function&&p.url(href))){
          p.list.forEach(r=>{
            let os;
            if(r.element.constructor==Function){
              os=r.element()
            }else{
              os=$util.findDoms(r.element)
            }
            os.forEach((o,i)=>{
              let bz
              if(r.bz.constructor==Function){
                bz=r.bz(o,i,href)
              }else{
                bz=r.bz
              }
              if(r.hasAlias){
                bz=bz+":"+$util.getElementAlias(o)
              }
              o.dataset.bz=bz
            })
          })
        }
      })
    }
  },
  _setExeType:function(t){
    _aiFlagHandler._exeType=t
  },
  _setProcessData:function(ms){
    let _list=_aiFlagHandler._processData._list
    for(let k in _aiFlagHandler._moduleMap){
      let m=_aiFlagHandler._moduleMap[k]
      if(m._chk){
        let i=_list.findIndex(x=>x.code==m.code)
        if(i>=0){
          _list.splice(i,1,m)
        }else{
          _list.push(m)
        }
      }
    }
    _Util._resizeModelWindow()
  },
  _start:function(){
    _aiFlagHandler._processData._complete=0
    _aiFlagHandler._processData._status='_playing'
    let _startTime=Date.now()
    //TODO: check button position
    _Util._confirmMessage({
      _tag:"div",
      _attr:{
        style:"min-height:50px;max-height:"+(window.innerHeight-200)+"px;overflow:auto;"
      },
      _items:[
        {
          _tag:"div",
          _attr:{
            class:"bz-h-h-tabs bz-std-tabs"
          },
          _items:[
            {
              _if:"_aiFlagHandler._processData._complete",
              _tag:"div",
              _attr:{
                class:"bz-note-text bz-bottom-space-10"
              },
              _html:function(){
                return "<div>"+_Util._formatMessage(_bzMessage._aiFlag._complete,_Util._formatTimer(Date.now()-_startTime))+"</pre>"
              }
            },
            //tabs
            {
              _tag:"div",
              _attr:{
                class:"bz-h-h-tab-items"
              },
              _items:[
                {
                  _tag:"div",
                  _attr:{
                    class:"'bz-h-h-tab-item '+(_aiFlagHandler._processData._curTab==_data._item?'white-active':'')"
                  },
                  _text:"_bzMessage._aiFlag._tabs[_data._item]",
                  _dataRepeat:function(){
                    let d=_aiFlagHandler._processData,vs=[]
                    d._refresh
                    if(d._list.filter(m=>m._new).length){
                      vs.push("_new")
                    }
                    if(!_Util._isEmpty(_aiFlagHandler._data._updateInfo)){
                      vs.push("_update")
                    }
                    if(d._warnings.length){
                      vs.push("_warnings")
                    }
                    if(_aiFlagHandler._processData._status=="_pause"){
                      vs.push("_script")
                    }
                    if(!vs.includes(d._curTab)){
                      d._curTab=vs[0]
                    }
                    return vs
                  },
                  _jqext:{
                    click:function(){
                      _aiFlagHandler._processData._curTab=this._data._item
                      _Util._resizeModelWindow()
                    }
                  }
                }
              ]
            },
            //contents
            {
              _tag:"div",
              _attr:{
                class:"bz-h-h-tab-content",
                style:function(){
                  return `max-height:${window.innerHeight-250}px;padding:5px;width:calc(100% - 12px);`
                }
              },
              _items:[
                {
                  _tag:"div",
                  _attr:{
                    style:function(){
                      return `max-height:${window.innerHeight-250}px;overflow:auto;`
                    }
                  },
                  _items:[
                    //new items
                    {
                      _tag:"div",
                      _items:[
                        //module name
                        {
                          _tag:"div",
                          _attr:{
                            class:"bz-hover bz-node-title bz-nowrap",
                            style:"font-weight:bold;"
                          },
                          _items:[
                            {
                              _tag:"button",
                              _attr:{
                                class:"'btn btn-icon bz-small-btn bz-'+(_aiFlagHandler._processData[_data._item.code]?'open':'close')+'-node'"
                              }
                            },
                            {
                              _tag:"div",
                              _attr:{
                                style:"flex:1"
                              },
                              _items:[
                                {
                                  _text:"_ideModuleManagement._getStdDescription(_data._item)",
                                },
                                {
                                  _tag:"button",
                                  _attr:{
                                    class:"btn btn-icon bz-popout bz-small-btn bz-left-space-5",
                                    style:"margin-top:-3px;"
                                  },
                                  _jqext:{
                                    click:function(e){
                                      BZ._setHash(this._data._item)
                                      e.stopPropagation()
                                    }
                                  }
                                }
                              ]
                            }
                          ],
                          _jqext:{
                            click:function(){
                              _aiFlagHandler._processData[this._data._item.code]=!_aiFlagHandler._processData[this._data._item.code]
                              _Util._resizeModelWindow()
                            }
                          }
                        },
                        //module contents
                        {
                          _if:"_aiFlagHandler._processData[_data._item.code]",
                          _tag:"div",
                          _attr:{
                            class:"bz-node-sub-panel"
                          },
                          _items:[
                            //flow
                            {
                              _tag:"div",
                              _items:[
                                //title
                                {
                                  _tag:"div",
                                  _attr:{
                                    class:"bz-hover bz-node-title bz-nowrap",
                                    style:"color:#009;"
                                  },
                                  _items:[
                                    {
                                      _tag:"button",
                                      _attr:{
                                        class:"'btn btn-icon bz-small-btn bz-'+(_aiFlagHandler._processData[_data._item.code+'_flow']?'open':'close')+'-node"
                                      }
                                    },
                                    {
                                      _tag:"div",
                                      _attr:{
                                        style:"flex:1"
                                      },
                                      _text:function(d){
                                        return `${_bzMessage._scenario._title} (${_getScenarioList(d).length})`
                                      }
                                    }
                                  ],
                                  _jqext:{
                                    click:function(){
                                      let k=this._data._item.code+'_flow'
                                      _aiFlagHandler._processData[k]=!_aiFlagHandler._processData[k]
                                      _Util._resizeModelWindow()
                                    }
                                  }
                                },
                                //panel
                                {
                                  _if:"_aiFlagHandler._processData[_data._item.code+'_flow']",
                                  _tag:"div",
                                  _attr:{
                                    class:"bz-node-sub-panel"
                                  },
                                  _items:[
                                    {
                                      _tag:"div",
                                      _items:[
                                        {
                                          _tag:"a",
                                          _attr:{
                                            class:"bz-hover"
                                          },
                                          _items:[
                                            {
                                              _tag:"button",
                                              _attr:{
                                                class:"btn btn-icon bz-small-btn bz-scenario bz-right-space-5"
                                              }
                                            },
                                            {
                                              _tag:"span",
                                              _text:function(d){
                                                d=_ideObjHandler._getDataByPath(d._item.scenario.code)
                                                return _ideTestManagement._getStdDescription(d)
                                              }
                                            }
                                          ],
                                          _jqext:{
                                            click:function(){
                                              BZ._setHash(this._data._item.scenario.code)
                                            }
                                          }
                                        }
                                      ],
                                      _dataRepeat:function(d){
                                        return _getScenarioList(d)
                                      }
                                    }
                                  ]
                                }
                              ]
                            },
                            //operations
                            {
                              _tag:"div",
                              _items:[
                                //title
                                {
                                  _tag:"div",
                                  _attr:{
                                    class:"bz-hover bz-node-title bz-nowrap",
                                    style:"color:#009;"
                                  },
                                  _items:[
                                    {
                                      _tag:"button",
                                      _attr:{
                                        class:"'btn btn-icon bz-small-btn bz-'+(_aiFlagHandler._processData[_data._item.code+'_operations']?'open':'close')+'-node'"
                                      }
                                    },
                                    {
                                      _tag:"div",
                                      _attr:{
                                        style:"flex:1"
                                      },
                                      _text:function(_data){
                                        return `${_bzMessage._common._operations} (${_data._item.definition.operations.length})`
                                      }
                                    }
                                  ],
                                  _jqext:{
                                    click:function(){
                                      let k=this._data._item.code+'_operations'
                                      _aiFlagHandler._processData[k]=!_aiFlagHandler._processData[k]
                                      _Util._resizeModelWindow()
                                    }
                                  }
                                },
                                //list
                                {
                                  _if:"_aiFlagHandler._processData[_data._item.code+'_operations']",
                                  _tag:"div",
                                  _attr:{
                                    class:"bz-node-sub-panel"
                                  },
                                  _items:[
                                    {
                                      _tag:"div",
                                      _attr:{
                                        style:"line-height:20px;"
                                      },
                                      _items:[
                                        {
                                          _tag:"a",
                                          _attr:{
                                            class:"bz-hover"
                                          },
                                          _items:[
                                            {
                                              _tag:"button",
                                              _attr:{
                                                class:"btn btn-icon bz-small-btn bz-unit bz-right-space-5"
                                              }
                                            },
                                            {
                                              _tag:"span",
                                              _text:function(d){
                                                return _ideTestManagement._getStdDescription(d._item.testCode,d._supData._item.code)
                                              }
                                            }
                                          ],
                                          _jqext:{
                                            click:function(){
                                              let d=this._data
                                              BZ._setHash(d._supData._item.code+"."+d._item.testCode)
                                            }
                                          }
                                        }
                                      ],
                                      _dataRepeat:"_data._item.definition.operations"
                                    }
                                  ]
                                }
                              ]
                            },
                            //validations
                            {
                              _tag:"div",
                              _items:[
                                {
                                  _tag:"div",
                                  _attr:{
                                    class:"bz-hover bz-node-title bz-nowrap",
                                    style:"color:#009;"
                                  },
                                  _items:[
                                    {
                                      _tag:"button",
                                      _attr:{
                                        class:"'btn btn-icon bz-small-btn bz-'+(_aiFlagHandler._processData[_data._item.code+'_validation']?'open':'close')+'-node'"
                                      }
                                    },
                                    {
                                      _tag:"div",
                                      _attr:{
                                        style:"flex:1"
                                      },
                                      _text:function(_data){
                                        return `${_bzMessage._setting._objectLib._validation} (${_data._item.definition.contents.filter(t=>t.testVE).length})`
                                      }
                                    }
                                  ],
                                  _jqext:{
                                    click:function(){
                                      let k=this._data._item.code+'_validation'
                                      _aiFlagHandler._processData[k]=!_aiFlagHandler._processData[k]
                                      _Util._resizeModelWindow()
                                    }
                                  }
                                },
                                {
                                  _if:function(d){
                                    return _aiFlagHandler._processData[d._item.code+'_validation']
                                  },
                                  _tag:"div",
                                  _attr:{
                                    class:"bz-node-sub-panel"
                                  },
                                  _items:[
                                    {
                                      _tag:"div",
                                      _items:[
                                        {
                                          _tag:"a",
                                          _attr:{
                                            class:"bz-hover"
                                          },
                                          _items:[
                                            {
                                              _tag:"button",
                                              _attr:{
                                                class:"btn btn-icon bz-small-btn bz-validation bz-right-space-5"
                                              }
                                            },
                                            {
                                              _tag:"span",
                                              _text:function(d){
                                                return _ideTestManagement._getStdDescription(d._item.testVE,d._supData._item.code)
                                              }
                                            }
                                          ],
                                          _jqext:{
                                            click:function(){
                                              let d=this._data
                                              BZ._setHash(d._supData._item.code+"."+d._item.testVE)
                                            }
                                          }
                                        }
                                      ],
                                      _dataRepeat:function(d){
                                        return d._item.definition.contents.filter(t=>t.testVE)
                                      }
                                    }
                                  ]
                                }
                              ]
                            },
                            //fields
                            {
                              _tag:"div",
                              _items:[
                                {
                                  _tag:"div",
                                  _attr:{
                                    class:"bz-hover bz-node-title bz-nowrap",
                                    style:"color:#009;"
                                  },
                                  _items:[
                                    {
                                      _tag:"button",
                                      _attr:{
                                        class:"'btn btn-icon bz-small-btn bz-'+(_aiFlagHandler._processData[_data._item.code+'_fields']?'open':'close')+'-node'"
                                      }
                                    },
                                    {
                                      _tag:"div",
                                      _attr:{
                                        style:"flex:1"
                                      },
                                      _text:function(_data){
                                        return `${_bzMessage._common._fields} (${_data._item.definition.fields.length})`
                                      }
                                    }
                                  ],
                                  _jqext:{
                                    click:function(){
                                      let k=this._data._item.code+'_fields'
                                      _aiFlagHandler._processData[k]=!_aiFlagHandler._processData[k]
                                      _Util._resizeModelWindow()
                                    }
                                  }
                                },
                                {
                                  _if:"_aiFlagHandler._processData[_data._item.code+'_fields']",
                                  _tag:"div",
                                  _attr:{
                                    class:"bz-node-sub-panel"
                                  },
                                  _items:[
                                    {
                                      _tag:"div",
                                      _attr:{
                                        style:"line-height:20px;"
                                      },
                                      _items:[
                                        {
                                          _tag:"a",
                                          _items:[
                                            {
                                              _tag:"button",
                                              _attr:{
                                                class:"btn btn-icon bz-small-btn bz-keyboard bz-right-space-5"
                                              }
                                            },
                                            {
                                              _tag:"span",
                                              _text:"_data._item.name+' ('+_data._item.type+', '+_data._item.inputFormat+')'",
                                            }
                                          ],
                                          _jqext:{
                                            click:function(){
                                              let d=this._data
                                              BZ._setHash(d._supData._item.code,undefined,undefined,undefined,function(){
                                                _aiPageHandler._popFieldForm(d._item)
                                              })
                                            }
                                          }
                                        }
                                      ],
                                      _dataRepeat:function(d){
                                        return d._item.definition.fields
                                      }
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ],
                      _dataRepeat:function(d){
                        _aiFlagHandler._processData._refresh
                        if(_aiFlagHandler._processData._curTab=="_new"){
                          return _aiFlagHandler._processData._list.filter(m=>m._new)
                        }
                      }
                    },
                    //update items
                    {
                      _tag:"div",
                      _items:[
                        {
                          _tag:"div",
                          _attr:{
                            class:"bz-hover bz-node-title bz-nowrap",
                            style:"font-weight:bold;"
                          },
                          _items:[
                            {
                              _tag:"button",
                              _attr:{
                                class:"'btn btn-icon bz-small-btn bz-'+(_aiFlagHandler._processData[_data._key]?'open':'close')+'-node'"
                              },
                              _jqext:{}
                            },
                            {
                              _tag:"div",
                              _attr:{
                                style:"flex:1"
                              },
                              _items:[
                                {
                                  _text:"_aiGeneratorDataHandler._getModuleObject(_data._key)._data.name",
                                },
                                {
                                  _tag:"button",
                                  _attr:{
                                    class:"btn btn-icon bz-popout bz-small-btn bz-left-space-5",
                                    style:"margin-top:-3px;"
                                  },
                                  _jqext:{
                                    click:function(e){
                                      let d=_aiGeneratorDataHandler._getModuleObject(this._data._key)._data
                                      BZ._setHash(d.code)
                                      e.stopPropagation()
                                    }
                                  }
                                }
                              ]
                            }
                          ],
                          _jqext:{
                            click:function(){
                              let k=this._data._key
                              _aiFlagHandler._processData[k]=!_aiFlagHandler._processData[k]
                              _Util._resizeModelWindow()
                            }
                          }
                        },
                        {
                          _if:"_aiFlagHandler._processData[_data._key]",
                          _tag:"div",
                          _attr:{
                            class:"bz-node-sub-panel"
                          },
                          _items:[
                            {
                              _tag:"div",
                              _attr:{
                                class:"bz-hover"
                              },
                              _items:[
                                {
                                  _tag:"a",
                                  _attr:{
                                    "type-label":"_data._item._type=='_new'?_bzMessage._common._new:''",
                                    class:"bz-new-flag"
                                  },
                                  _text:"_data._item._text",
                                }
                              ],
                              _dataRepeat:"_data._item._items",
                              _jqext:{
                                click:function(){
                                  let d=this._data
                                  let m=_aiGeneratorDataHandler._getModuleObject(d._supData._key)
                                  BZ._setHash(m._data.code,undefined,undefined,undefined,function(){
                                    if(d._item._data){
                                      BZ._userHabit.curUIModelTab="page"
                                      _aiPageHandler._popItem(d._item._data.code,d._supData._key)
                                    }else{
                                      BZ._userHabit.curUIModelTab="flow"
                                      _aiFlowHandler._popItem(d._item._from,d._item.to)
                                    }
                                  })
                                }
                              }
                            }
                          ]
                        }
                      ],
                      _dataRepeat:function(){
                        _aiFlagHandler._processData._refresh
                        if(_aiFlagHandler._processData._curTab=="_update"){
                          let ms={}
                          for(let k in _aiFlagHandler._data._updateInfo){
                            let d=_aiFlagHandler._data._updateInfo[k]
                            let m=_aiFlagHandler._moduleMap[d.m]
                            let mm=ms[d.m],vs=(d.c||"").toString().split("/")
                            let v=vs.shift(),_msg="",_data;
                            if(!mm){
                              ms[d.m]=mm={_items:[]}
                            }
                            let g=m.definition[d.g],ps=""
                            if(g){
                              if(d.p){
                                ps=d.p.split(".")
                              }

                              if(g.constructor==Array){
                                g.find(x=>{
                                  if(x.code==v||x.id==v){
                                    _msg=x.name||_aiModelHandler._getPanelName(x,m)
                                    _data=x
                                    if(vs[0]){
                                      x[d.p].find(y=>{
                                        if(y.code==vs[0]){
                                          _msg+=", "+y.name
                                          _data=y
                                          return 1
                                        }
                                      })
                                    }
                                    return 1
                                  }
                                })
                              }else{
                                g=g[ps[0]].to[ps[1]]
                                if(g){
                                  g.find(y=>{
                                    if(y.key==v){
                                      _data=y.data.scenario.code
                                      _data=_ideObjHandler._getDataByPath(_data)
                                      if(_data){
                                        _msg=_data._data.name
                                        _data=0
                                      }
                                    }
                                  })
                                }
                              }
                            }
                            mm._items.push({
                              _type:d.t,
                              _text:_msg,
                              _data:_data,
                              _group:d.g,
                              _from:ps[0],
                              to:ps[1]
                            })
                          }
                          return ms
                        }
                      }
                    },
                    //warnings
                    {
                      _tag:"div",
                      _attr:{
                        style:"line-height:25px;"
                      },
                      _items:[
                        {
                          _tag:"span",
                          _text:function(d){
                            return _bzMessage._aiFlag._error[d._item._msg]+" ("+_descAnalysis._retrieveTextForElementPathItem(d._item._path)+")"
                          }
                        },
                        {
                          _tag:"button",
                          _attr:{
                            class:"btn btn-icon bz-small-btn bz-play bz-left-space-5"
                          },
                          _jqext:{
                            click:function(){
                              let d=this._data._item
                              _aiFlagHandler._exeActions(d._steps||[{_url:_aiFlagHandler._data.startUrl}],function(){
                                setTimeout(()=>{
                                  _bzDomPicker._flashTmpCover(d._path)
                                },1000)
                              })
                            }
                          }
                        }
                      ],
                      _dataRepeat:function(d){
                        _aiFlagHandler._processData._refresh
                        if(_aiFlagHandler._processData._curTab=="_warnings"){
                          return _aiFlagHandler._processData._warnings
                        }
                      }
                    },
                    //script
                    {
                      _if:function(){
                        _aiFlagHandler._processData._refresh
                        return _aiFlagHandler._processData._curTab=='_script'
                      },
                      _tag:"div",
                      _items:[
                        {
                          _tag:"a",
                          _text:"_bzMessage._aiDefinition._setTmpFlag",
                          _attr:{
                            class:"bz-clickable",
                            style:"position: absolute;right: 100px;margin-top: -28px;"
                          },
                          _jqext:{
                            click:function(){
                              _aiFlagHandler._assignFlagByScript(2)
                            }
                          }
                        },
                        {
                          _tag:"button",
                          _attr:{
                            class:"btn btn-icon bz-cross bz-small-btn",
                            title:"_bzMessage._method._cleanFlag",
                            style:"position: absolute;right: 60px;margin-top: -28px;"
                          },
                          _jqext:{
                            click:function(){
                              _aiFlagHandler._assignFlagByScript(1)
                            }
                          }
                        },
                        {
                          _tag:"button",
                          _attr:{
                            class:"btn btn-icon bz-merge-btn",
                            title:"_bzMessage._method._pickAndCopyElementPath",
                            style:"position: absolute;right: 20px;margin-top: -28px;"
                          },
                          _items:[
                            {
                              _tag:"span",
                              _attr:{
                                class:"bz-dompicker"
                              }
                            },
                            {
                              _tag:"span",
                              _attr:{
                                class:"bz-copy"
                              }
                            },
                          ],
                          _jqext:{
                            click:function(){
                              _bzDomPicker._pickDetails("_path",function(v){
                                _Util._copyData(v)
                              })
                            }
                          }
                        },
                        {
                          _tag:"textarea",
                          _attr:{
                            style:"height:300px;padding:5px;",
                            class:"bz-editor"
                          },
                          _dataModel:"_aiFlagHandler._data.tmpFlagScript",
                          _jqext:{
                            change:function(){
                              _extensionComm._setShareData({"_aiFlagHandler._data.tmpFlagScript":_aiFlagHandler._data.tmpFlagScript})
                            }
                          }
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },[{
      _title:" ",
      _class:"btn-icon bz-loading",
    },{
      _title:_bzMessage._method._stop,
      _class:"btn-secondary btn-icon-text bz-stop "+(_aiFlagHandler._exeType=="_pause"?"bz-hide-item":""),
      _click:function(c){
        if($(c).hasClass("bz-stop")){
          _aiFlagHandler._stop()
          $(".bz-step").remove()
        }else{
          c._ctrl._close()
        }
      }
    },{
      _title:_bzMessage._method._pause,
      _class:"btn-secondary btn-icon-text bz-pause "+(_aiFlagHandler._exeType=="_pause"?"bz-hide-item":""),
      _click:function(c){
        if($(c).hasClass("bz-pause")){
          _aiFlagHandler._pause()
          $(".bz-modal-footer").find(".bz-stop").hide()
          c.disabled=true
        }else{
          _aiFlagHandler._restart("_playing")
        }
      }
    },{
      _title:_bzMessage._test._play._stepByStep,
      _class:"btn-secondary btn-icon-text bz-step "+(_aiFlagHandler._exeType=="_pause"?"":"bz-hide-item"),
      _click:function(c){
        _aiFlagHandler._restart("_pause")
      }
    }],_bzMessage._aiFlag._scanApp,500,1,0,1);

    function _getScenarioList(d){
      let os=Object.values(d._item.definition.moduleDataFlow).filter(t=>t.to),vs=[]
      
      os.forEach(o=>{
        for(let k in o.to){
          o.to[k].forEach(x=>{
            if(x.data){
              if(x.data.scenario&&x.data.scenario.code){
                vs.push(x.data)
              }
            }
          })
        }
      })
      return vs
    }
  },
  _loadFlagScript:function(i){
    let n=i
    if(i===undefined){
      n=_aiAuthHandler._getCurHostIdx()
    }
    let s=_IDE._data._setting.authList[n]||{}
    s=(s.scan||{})
    if(s.tmpFlagScript){
      _aiFlagHandler._data.avoidBzFlagElement=s.avoidBzFlagElement
    }
    s=s.tmpFlagScript
    if($.isNumeric(s)){
      if(i===undefined){
        s=_aiFlagHandler._loadFlagScript(s)
      }
    }
    return s
  },
  _assignFlagByScript:function(_cleanFirst,s){
    s=s||_aiFlagHandler._data.tmpFlagScript
    if(!s){
      s=_aiFlagHandler._loadFlagScript()
    }
    _loadContent(s)
    
    function _loadContent(s){
      if(_Util._isUrl(s)){
        if(!_cleanFirst&&_aiFlagHandler._data._tmpFlagScript){
          return _doIt(_aiFlagHandler._data._tmpFlagScript)
        }
        return _Util._ajax({
          url:s,
          method:"GET",
          complete:function(x){
            _doIt(x.responseText)
          }
        })
      }else{
        _doIt(s)
      }
    }
    function _doIt(s){
      if(s){
        _aiFlagHandler._data._tmpFlagScript=s
        if(bzTwComm._isIDE()){
          _extensionComm._setShareData({"_aiFlagHandler._data.tmpFlagScript":s})
          return setTimeout(()=>{
            _extensionComm._setCmd("_aiFlagHandler._assignFlagByScript("+_cleanFirst+")")
          },10)
        }

        $("[data-bz]").toArray().forEach(x=>{
          if(x.dataset.newbz){
            delete x.dataset.bz
          }
        })
        if(_cleanFirst!=1){
          try{
            _Util._eval(s)
          }catch(ex){
            console.log(ex.stack)
            alert(ex.message+"\n\n"+ex.stack)
          }
        }
        if(_cleanFirst){
          $(".bz-plus").click()
          setTimeout(()=>{
            $(".bz-show-attribute").click()
            $(".bz-do-filter").click()
          },100)
        }
      }
    }
  },
  _restart:function(t){
    if(_aiFlagHandler._processData._complete){
      _aiFlagHandler._processData._complete=0
      _aiFlagHandler._identify(_aiFlagHandler._curContinueData.ms)
      return
    }
    _aiFlagHandler._setExeType(t)
    _aiFlagHandler._processData._status='_playing'
    _aiFlagHandler._hideShowLoading()
    _aiFlagHandler._continueProcess()
  },
  _pause:function(){
    _aiFlagHandler._processData._status='_pause'
    _aiFlagHandler._hideShowLoading()
  },
  _stop:function(){
    _aiFlagHandler._processData._status=0
    let c=$(".bz-modal-window .bz-stop")
    c.removeClass("bz-stop")
    $(".bz-step").remove()
    c.removeClass("btn-icon-text")
    c[0].innerText=_bzMessage._method._close
    $(c[0].parentNode.parentNode.parentNode).find(".bz-pause,.bz-play").remove()
    _aiFlagHandler._hideShowLoading()
  },
  _hideShowLoading:function(){
    let c=$(".bz-modal-window .bz-loading")
    if(_aiFlagHandler._processData._status=="_playing"){
      c.show()
      c=$(".bz-modal-footer .bz-play")[0]
      c.innerText=_bzMessage._method._pause
      $(c).removeClass("bz-play")
      
      $(c).addClass("bz-pause")
      $(".bz-step").hide()
    }else{
      c.hide()
      $(".bz-modal-footer").find(".bz-step,.bz-play,.bz-stop,.bz-pause").show()
      c=$(".bz-pause")[0]
      if(c){
        c.disabled=false
        $(c).removeClass("bz-pause")
        
        $(c).addClass("bz-play")
        c.innerText=_bzMessage._method._continue
      }
    }
  },
  _handleAuthTests:function(ad,_fun){
    BZ._launchCurEnvUrl(_IDE._data._setting.curEnvironment,function(){
      _aiFlagHandler._updateLogout(ad,()=>{
        _aiFlagHandler._updateLogin(ad,()=>{
          if(ad._completeLogin&&!ad._completeLogout){
            _aiFlagHandler._updateLogout(ad,()=>{
              _aiFlagHandler._updateLogin(ad,()=>{
                _fun()
              })
            })
          }else{
            _fun()
          }
        })
      })
    })
  },
  _updateLogout:function(ad,_fun){
    let a={
      _element:":attr(bz=$logout)",
      _endActions:[{
        _element:":attr(bz=$confirm)"
      }]
    }
    _aiFlagHandler._exeActions([a],()=>{
      _update()
    })
    
    function _update(){
      
      if(a._bkAction){
        ad._auth.signOut.actions[1].element=a._bkAction.element
      }else{
        return _fun()
      }
      if(a._endActions[0]._bkAction){
        ad._auth.signOut.actions[2].element=a._endActions[0]._bkAction.element
      }
      if(ad._preActions&&a._preActions[0]._bkAction){
        ad._auth.signOut.actions.splice(1,0,a._preActions[0]._bkAction)
      }
      ad._completeLogout=1
      _ideTestManagement._save(ad._auth.signOut,ad._auth.module,_fun)
    }
  },
  _updateLogin:function(ad,_fun){
    let as=[{_element:":attr(bz=$login-enter)"}]

    // as.push({_element:":attr(bz=$submit)"},{_element:":attr(bz=$identifier)"})

    _aiFlagHandler._exeActions(as,()=>{
      _aiFlagHandler._identifyPage(function(es){
        console.log(es)
      })
      // if(ad._completeLogin){
        // _fun()
      // }else{
        // _update()
      // }
    })
    function _update(){
      // if(as.find(x=>x.
      // ad._completeLogin=1
      // _fun()
    }
  },
  _buildExistModuleMap:function(_fun){
    let ms=_Util._clone(_IDE._data._curVersion.modules.filter(x=>{
      return _aiGeneratorDataHandler._isAIModule(x)
    }))
    ms.sort((a,b)=>{
      if(a.parentModule>b.parentModule){
        return 1
      }else if(a.parentModule<b.parentModule){
        return -1
      }else if(a.name>b.name){
        return 1
      }else{
        return -1
      }
    })
    ms=_CtrlDriver._buildProxy({ms:ms})
    ms=ms.ms
    let _done
    while(!_done){
      _done=1
      for(let i=0;i<ms.length;i++){
        let m=ms[i];
        if(m.parentModule){
          let n=ms.findIndex(x=>x.code==m.parentModule)
          if(n<i){
            while(n<i&&ms[n+1].parentModule==m.parentModule){
              n++
            }
            if(n!=i){
              ms.splice(i,1)
              ms.splice(n+1,0,m)
            }
          }else{
            _done=0
          }
        }
      }
    }
    ms.forEach(m=>{
      m._chk="on"
      m.definition.operations.forEach(t=>{
        if(t.api){
          t._disabled="on"
        }else{
          t._chk="on"
        }
      })
    })
    
    _aiFlagHandler._buildModuleMap(ms)
    
    if(ms.length){
      return _setUpdateModules()
    }

    _fun(ms)

    function _setUpdateModules(){
      _Util._confirmMessage({
        _update:function(){
          _Util._resizeModelWindow()
        },
        _tag:"div",
        _attr:{
          style:"max-height:500px"
        },
        _items:[
          //all
          {
            _tag:"div",
            _items:[
              {
                _tag:"label",
                _attr:{
                  style:"margin-left:2px;color:var(--highlight-border-color);"
                },
                _items:[
                  {
                    _tag:"input",
                    _attr:{
                      type:"checkbox",
                      checked:function(){
                        return !ms.find(x=>!x._chk)
                      }
                    },
                    _jqext:{
                      click:function(){
                        let v=this
                        setTimeout(()=>{
                          v=v.checked?"on":""
                          ms.forEach(x=>{
                            x._chk=v
                            x._open=v
                            if(v){
                              x.definition.operations.forEach(y=>y._chk=v)
                            }
                          })
                          _Util._resizeModelWindow()
                        },10)
                      }
                    }
                  },
                  {
                    _tag:"span",
                    _attr:{
                      style:"margin-left:3px;"
                    },
                    _text:"_bzMessage._common._all"
                  }
                ]
              },
              {
                _tag:"a",
                _attr:{
                  class:"pull-right"
                },
                _items:[
                  {
                    _tag:"div",
                    _attr:{
                      class:"btn btn-icon bz-small-btn bz-delete pull-left bz-right-space-5"
                    }
                  },
                  {
                    _tag:"span",
                    _attr:{
                      style:"position: relative;top: -3px;"
                    },
                    _text:"_bzMessage._method._deleteSelectItems"
                  }
                ],
                _jqext:{
                  click:function(){
                    let s=ms.filter(x=>{
                      if(x._chk){
                        x=_aiFlagHandler._moduleMap[x.alias]
                        if(x){
                          delete _aiFlagHandler._moduleMap[x.alias]
                          _deleteSubModules(x)
                          return 1
                        }
                      }
                    })
                    _ideModuleManagement._batchDelete(s,function(){
                      _Util._spliceAll(ms,x=>x._chk)
                      BZ._data._uiSwitch._refreshTimer=Date.now()
                    })
                    
                    function _deleteSubModules(m){
                      let mm=[]
                      _Util._spliceAll(ms,x=>{
                        if(x.parentModule==m.code){
                          delete _aiFlagHandler._moduleMap[x.alias]
                          mm.push(x)
                          return 1
                        }
                      })
                      mm.forEach(x=>_deleteSubModules(x))
                    }
                  }
                }
              }
            ]
          },
          //list
          {
            _tag:"div",
            _dataRepeat:function(){
              BZ._data._uiSwitch._refreshTimer
              return ms
            },
            _items:[
              {
                _tag:"div",
                _attr:{
                  style:function(d){
                    let i=_ideObjHandler._getModulePath(d._item.code).split("/")
                    i.shift()
                    i.shift()
                    
                    return "margin:5px 0;margin-left:"+(i.length*17)+"px"
                  }
                },
                _items:[
                  {
                    _tag:"div",
                    _attr:{
                      class:"bz-hover bz-node-title bz-nowrap"
                    },
                    _items:[
                      {
                        _tag:"input",
                        _attr:{
                          type:"checkbox",
                          style:"margin:2px;"
                        },
                        _dataModel:"_data._item._chk"
                      },
                      {
                        _if:"_data._item._chk",
                        _tag:"button",
                        _attr:{
                          class:function(d){
                            let c="btn btn-icon bz-small-btn "
                            if(d._item._open){
                              c+="bz-open-node"
                            }else{
                              c+="bz-close-node"
                            }
                            return c
                          }
                        },
                        _jqext:{
                          click:function(){
                            let d=this._data._item
                            d._open=!d._open
                            _Util._resizeModelWindow()
                          }
                        }
                      },
                      {
                        _tag:"div",
                        _attr:{
                          style:"color:var(--highlight-border-color);flex:1;",
                          class:"'bz-nowrap '+(_data._item._chk?'':'bz-left-space-5')"
                        },
                        _text:function(d){
                          d=d._item;
                          return `[${d.code}] ${d.name}`
                        },
                        _jqext:{
                          click:function(){
                            let d=this._data._item
                            d._open=!d._open
                            _Util._resizeModelWindow()
                          }
                        }
                      }
                    ]
                  },
                  {
                    _if:"_data._item._open&&_data._item._chk",
                    _tag:"div",
                    _attr:{
                      style:"margin-left:19px"
                    },
                    _items:[
                      {
                        _tag:"div",
                        _attr:{
                          class:"bz-hover"
                        },
                        _items:[
                          {
                            _tag:"label",
                            _items:[
                              {
                                _tag:"input",
                                _attr:{
                                  type:"checkbox",
                                  disabled:"_data._item._disabled",
                                  style:"margin-right:2px;margin-top:3px;"
                                },
                                _dataModel:"_data._item._chk"
                              },
                              //type icon
                              {
                                _tag:"button",
                                _attr:{
                                  class:"'btn btn-icon bz-small-btn bz-'+_data._item.type"
                                }
                              },
                              {
                                _text:function(d){
                                  d=d._item;
                                  return `[${d.testCode}] ${d.name}`
                                }
                              }
                            ]
                          }
                        ],
                        _dataRepeat:"_data._item.definition.operations"
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },[{
        _title:_bzMessage._method._continue,
        _click:function(c,o){
          c._ctrl._close()
          $(o).hide()
          _fun(ms)
        }
      }],_bzMessage._aiFlag._selectScope)
    }
  },
  _buildModuleMap:function(ms){
    ms=ms||_IDE._data._curVersion.modules
    _aiFlagHandler._moduleMap={}
    ms.forEach(x=>{
      if(!x.alias){
        x.alias=_glossaryHandler._getVariableName(x.name)
      }
      _aiFlagHandler._moduleMap[x.alias]=x
    })
  },
  _isPanel:function(v){
    return v&&v.match(/\$(auth|login-form|module|details|form|table|list) *$/)
  },
  _isEnter:function(v){
    return v&&v.match(/\$(login-enter|logout|form-tab|module-enter|details-enter|ex-details-enter|new|update|delete|submit|close|cancel|next|ex-insert|confirm|step-key|pre-step|end-step) *$/)
  },
  _isOperation:function(v){
    return v&&v.match(/\$(add|new|edit|update|modify|delete|remove)/)
  },
  _parseBZFlag:function(w){
    if(!w){
      return []
    }
    let c="",fs=[],tf,gs=[],pks=[];

    for(let i=0;i<w.length;i++){
      let v=w[i]
      if(":=,;()".includes(v)){
        if(_aiFlagHandler._isFlag(c)){
          _addFlag(c,v)
        }else{
          _setValue(c,v)
        }
        c=""
      }else if(!c&&v==" "){
        continue
      }else{
        c+=v
      }
    }
    if(_aiFlagHandler._isFlag(c)){
      _addFlag(c)
    }else{
      _setValue(c)
    }
    return fs;
    
    function _setValue(v,s){
      v=v.trim()
      if(v){
        if(tf){
          tf.value=tf.value||[]
          tf.value.push(v)
        }else{
          fs.push(v)
        }
      }else if(s=="("&&tf&&!gs.includes(tf)){
        gs.push(tf)
      }
      if(s==")"){
        gs.pop()
        tf=gs[gs.length-1]
      }
    }
    
    function _addFlag(v,s){
      v=v.trim()
      let p;
      if(tf&&tf.constructor==Object&&v=="$id"){
        tf[v]={}
        p=tf
      }else if(!tf||!gs.length){
        tf={}
        p=tf;
        fs.push(tf)
        tf[v]={}
      }else if(gs.length){
        tf=gs[gs.length-1]
        tf[v]={}
        p=tf
      }
      if(s=="("){
        gs.push(p[v])
        tf=p[v]
      }else if(s==")"){
        gs.pop()
        tf=gs[gs.length-1]
      }else if(","==s||";"==s){
        p[v]=1
        tf=p
      }else if(s==":"||s=="="){
        tf=tf[v]
      }
    }
  },
  _retrieveElementPathAndExeAction:function(_css,_method,_value,_fun){
    if(_css.constructor==String){
      _bzDomPicker._getTWElementPathByCSS(_css,function(x){
        if(x){
          _exeAction(x)
        }else{
          _fun()
        }
      })
    }else{
      _exeAction(_css)
    }
    function _exeAction(x){
      if(_method=="_set"){
        _ideTask._triggerTmpSetAction(x,_value,1,_final)
      }else{
        _ideTask._triggerTmpClickAction(x,1,_final)
      }
    }
    
    function _final(r,d,a){
      _fun(a)
    }
  },
  _exeActions:function(as,_fun,i){
    i=i||0
    let a=as[i]
    if(a){
      if(a._url){
        _extensionComm._openURL(a._url,0,function(){
          _aiFlagHandler._exeActions(as,_fun,i+1)
        });
        /*
        if(BZ.TW&&!BZ.TW.closed){
          _extensionComm._retrieveDataFromTW("location.href",function(v){
            if(v!=a._url){
              _extensionComm._openURL(a._url,0,function(){
                _aiFlagHandler._exeActions(as,_fun,i+1)
              });
            }else{
              _aiFlagHandler._exeActions(as,_fun,i+1)
            }
          })
        }else{
          _extensionComm._openURL(a._url,0,function(){
            _aiFlagHandler._exeActions(as,_fun,i+1)
          });
        }
        */
      }else{
        _doExSteps(a._preActions,0,()=>{
          _doEvent()
        })
      }
    }else{
      _fun&&_fun(as)
    }
    
    function _doEvent(_retry){
      if(_extensionComm._pageReady){
        setTimeout(()=>{
          _aiFlagHandler._retrieveElementPathAndExeAction(a._element,a._method,a._value,(aa)=>{
            a._bkAction=aa
            if(aa){
              _doExSteps(a._endActions,0,()=>{
                _aiFlagHandler._exeActions(as,_fun,i+1)
              })
            }else{
              _fun&&_fun(as)
            }
          })
        },_retry?2000:1000)
      }else{
        setTimeout(()=>{
          _doEvent(1)
        },100)
      }
    }
    
    function _doExSteps(s,i,_fun){
      let sa=s&&s[i]
      if(sa){
        _aiFlagHandler._retrieveElementPathAndExeAction(sa._element,sa._method,sa._value,(r,a)=>{
          sa._bkAction=a
          if(a){
            _doExSteps(s,i+1,_fun)
          }else{
            _fun()
          }
        })
      }else{
        _fun()
      }
    }
  },
  _assignElementPath:function(v,o,pp){
    // if(v&&v.$target){
      // o=$(o).find(v.$target)[0]||o
    // }
    if(_aiFlagHandler._data.avoidBzFlagElement){
      if(_cssHandler._hasAIFlag(o)&&!_Util._isInputObj(o)){
        pp._flagPath=_cssHandler._findPathByAIFlag(o,1)||pp._path
        let p=_Util._clone(pp._flagPath)
        p=p.map(x=>{
          if(x.replace){
            x=x.replace(/:bz\([^\)]+\)/g,"").replace(/:bz=\$[^=]+(=[^:]+)?/g,"")
          }
          return x
        })
        if($util.findDom(p)==o){
          pp._path=p
        }else{
          pp._path=_cssHandler._findPath(o)
        }
        return
      }
    }
    pp._flagPath=pp._path=_cssHandler._findPath(o)
  },
  _addWarning:function(k,_msg,o){
    let _key=k+_msg
    if(o){
      _key+=JSON.stringify(o._environment)+JSON.stringify(o._path)
    }

    _aiFlagHandler._data._warnings.push({
      _bzKey:k,
      bz:o&&_getBzFlag(o),
      _msg:_msg,
      _steps:o?_getSteps():[{_url:k}],
      _environment:o&&_Util._clone(o._environment),
      _key:_key,
      _path:o&&o._path
    })

    function _getSteps(){
      let s=_aiFlagHandler._data._curExeItem
      if(s&&s._steps){
        return s._steps
      }
    }
    
    function _getBzFlag(o){
      o=o&&o._element
      if(o&&o.dataset){
        return o.dataset.bz
      }
    }
  },
  _getFlagAttrValue:function(d,k){
    if(d[k]){
      if(d[k].value){
        return d[k].value[0]
      }
      return d[k]
    }
  },
  _updateValue:function(d,k,v,m,g,c,p){
    if(d[k]!=v){
      _aiFlagHandler._setModuleUpdate(m,"_update",g,c,p)
      d[k]=v
    }
  },
  _setModuleUpdate:function(m,t,g,c,p){
    if(m){
      m._update=1
      
      if(g){
        _aiFlagHandler._addUpdateInfo(m,t,g,c,p)
      }
    }
  },
  _addUpdateInfo:function(m,t,g,c,p){
    if(!m._new){
      let d=_aiFlagHandler._data._updateInfo
      let _key=m.code+"-"+g+"-"+c
      if(!d[_key]){
        d[_key]={
          t:t,
          m:m.alias,
          g:g,
          c:c,
          p:p
        }
      }
    }
  },
  _getPanel:function(_module,_panel){
    if(_module&&_module.constructor==String){
      _module=_aiFlagHandler._moduleMap[_module]||_aiGeneratorDataHandler._getModuleObject(_module)._data
    }
    if(_panel){
      _panel=_panel.code||_panel
      if(!_module.definition.contents.find(x=>{
        if(x.code==_panel){
          _panel=x
          return 1
        }
      })){
        _panel=0
      }
    }
    if(!_panel){
      _module.definition.contents.find(x=>{
        if(x.type=="modulePanel"){
          _panel=x
          return 1
        }
      })
    }
    let mp=_aiModelHandler._getItemPanelModel(_module.definition,_panel.code)
    return {
      _panel:_panel,
      _panelModel:mp
    }
  },
  _addListOrTable:function(_module,_type,_alias,_panel){
    if(!_module||_module.constructor==String){
      _module=_aiGeneratorDataHandler._getModuleObject(_module)
    }
    _module=_module._data||_module
    /*content*/
    _panel=_aiFlagHandler._getPanel(_module,_panel)
    
    let d={
      code:_aiAPI._newId(),
      type:_type,
      panel:[_panel._panel.code],
      name:_bzMessage._model._table._options[_type],
      alias:_alias||_type,
      fakeElement:"on"
    }
    let mp=_panel._panelModel

    if(mp){
      mp.items.push({
        group:"contents",
        code:d.code,
        items:[]
      })
      mp=mp.items[mp.items.length-1]
    }

    _module.definition.contents.push(d)
    return {
      _panel:d,
      _panelModel:mp
    }
  },
  _addOpr:function(_module,_type,_alias,_panel,_url){
    if(!_module||_module.constructor==String){
      _module=_aiGeneratorDataHandler._getModuleObject(_module)
    }
    _module=_module._data||_module

    _panel=_aiFlagHandler._getPanel(_module,_panel)
    
    let d={
      code:_aiAPI._newId(),
      type:_type,
      endSteps:[],
      preSteps:[],
      lanuchPanel:_aiAPI._newId(),
      level:_type=="add"?"module":"data",
      panel:[_panel._panel.code],
      name:_Util._formatMessage(_bzMessage._model._operation[_type],_module.name),
      alias:_alias||_type,
      url:_url,
      fakeElement:"on"
    }

    let _form={
      code:d.lanuchPanel,
      alias:d.alias,
      type:"form",
      asOneAction:"",
      buttons:[],
      formValues:{},
      from:[{
        code:d.code,
        module:_module.code||_module.alias
      }],
      items:[],
      speed:100,
      fakeElement:"on",
      name:_Util._formatMessage(_bzMessage._model._panelName,[d.name,_bzMessage._model._panelType.form])
    }

    let mp=_panel._panelModel,_model
    if(mp){
      _model={
        group:"operations",
        code:d.code
      }
      mp.items.push(_model)
    }
    mp={
      code:d.lanuchPanel,
      items:[],
      group:"contents",
      x:"300px",
      y:_module.definition.operations.length*300+50+"px",
      pin:1
    }
    _module.definition.models.push(mp)

    _module.definition.operations.push(d)
    _module.definition.contents.push(_form)
    return {
      _enter:d,
      _panel:_form,
      _panelModel:mp
    }
  },
  _addDetails:function(_module,_panel,_alias,_url){
    _alias=_alias||"details"
    if(!_module||_module.constructor==String){
      _module=_aiGeneratorDataHandler._getModuleObject(_module)
    }

    _module=_module._data||_module

    _panel=_aiFlagHandler._getPanel(_module,_panel)
    
    let _name=_Util._idToName(_Util._formatMessage(_bzMessage._model._enterDetailsName,_alias))

    let d={
      code:_aiAPI._newId(),
      type:"enterDetails",
      endSteps:[],
      preSteps:[],
      lanuchPanel:_aiAPI._newId(),
      panel:[_panel._panel.code],
      name:_name,
      alias:_alias,
      url:_url,
      fakeElement:"on"
    }
    let p={
      code:d.lanuchPanel,
      alias:d.alias,
      type:"dataPanel",
      from:[{
        code:d.code,
        module:_module.code||_module.alias
      }],
      items:[],
      name:_bzMessage._model._panelType.dataPanel+" - "+_Util._idToName(_alias),
      fakeElement:"on"
    }

    let mp=_panel._panelModel
    if(mp){
      mp.items.push({
        group:"contents",
        code:d.code
      })
      mp={
        code:d.lanuchPanel,
        group:"contents",
        items:[],
        x:"50px",
        y:"400px"
      }
      _module.definition.models.push(mp)
    }
    _module.definition.contents.push(d,p)

    return {
      _enter:d,
      _panel:p,
      _panelModel:mp
    }
  },
  _addModule:function(_name,_alias,_parentModule,_parentModulePanel){
    _name=_name||_Util._idToName(_alias)
    _alias=_alias||_Util._toCamelWords(_Util._toSingularWord(_name))

    let d={
      name:_name,
      alias:_alias,
      bt:"data",
      dataMap:[],
      defaultHostId:_aiFlagHandler._data._hostIdx,
      rootUrl:"/",
      tmpDataSize:10
    },_enter
    _aiGeneratorDataHandler._setInitAIDefinition(d)
    _definition=d.definition
    if(!_parentModule){
      c={
        code:"home",
        name:_bzMessage._model._panelType.home,
        type:"page"
      }
    }else{
      d.parentModule=_parentModule.code||_parentModule.alias
      c={
        code:_aiAPI._newId(),
        name:_bzMessage._model._panelType._mainModulePanel,
        module:d.parentModule
      }
    }
    let _enterModule=_aiAPI._newId(),
        _lanuchPanel=_aiAPI._newId()

    _definition.contents.push(c,{
      code:"api",
      name:"API",
      type:"page",
      alias:"api"
    })
    
    _definition.models.push({
      code:c.code,
      group:"contents",
      x:"50px",
      y:"50px",
      items:[]
    },{
      code:"api",
      group:"contents",
      items:[],
      x:"50px",
      y:"50px",
      pin:1
    })
    //add module enter
    _enter={
      code:_aiAPI._newId(),
      type:"enterModule",
      lanuchPanel:_aiAPI._newId(),
      panel:[c.code],
      alias:_alias,
      name:_Util._idToName(_alias),
      endSteps:[],
      preSteps:[],
      fakeElement:"on"
    }
    let _curExeItem=_aiFlagHandler._data._curExeItem
    if(_curExeItem&&_curExeItem._type=="$menu"){
      _enter.preSteps.push({
        type:1,
        event:{type: "mouse", action: "click"},
        element:_curExeItem._element
      })
    }
    
    _definition.contents.push(_enter,{
      code:_enter.lanuchPanel,
      type:"modulePanel",
      alias:_alias,
      from:[{
        code:_enter.code,
        module:_parentModule?(_parentModule.code||_parentModule.alias):undefined
      }],
      items:[],
      fakeElement:"on",
      name:_bzMessage._model._panelType.modulePanel
    })

    _definition.models[0].items.push({
      code:_enter.code,
      group:"contents"
    })
    _definition.models.push({
      code:_enter.lanuchPanel,
      group:"contents",
      items:[],
      x:"50px",
      y:"150px",
      pin:1
    })
    if(_parentModule){
      let mp
      if(_parentModulePanel){
        mp=_aiModelHandler._getItemPanelModel(_parentModule.definition,_parentModulePanel)
        if(!mp||_parentModule.definition.contents.find(y=>y.code==_parentModulePanel&&y.type=="form")){
          _parentModulePanel=0
        }
      }
      if(!_parentModulePanel){
        if(!_parentModule.definition.models.find(x=>{
          if(x.group=="contents"){
            return _parentModule.definition.contents.find(y=>{
              if(y.code==x.code&&y.type=="dataPanel"){
                _parentModulePanel=x
                mp=x
                return 1
              }
            })
          }
        })){
          let _list=_parentModule.definition.contents.find(x=>x.type=="list"||x.type=="table")
          if(!_list){
            _list=_aiFlagHandler._addListOrTable(_parentModule,"list","list")
            _list=_list._panel
          }
          mp=_aiFlagHandler._addDetails(_parentModule,_list.code,"details")._panelModel
        }
      }

      mp.items.push({
        group:"relatedModules",
        code:_enter.code
      })
        
      _definition.models[0].code=c.code=mp.code
      _enter.panel=[c.code]

      _parentModule.definition.relatedModules.push({
        module:_alias,
        code:_enter.code,
        type:"modulesub"
      })
      
    }
    if(_aiFlagHandler._data.fullHyApp){
      _definition.startPanel="url"
    }else{
      _definition.startPanel=_enter.code
    }
    d._chk="on"
    _aiFlagHandler._moduleMap[_alias]=d
    return d
  }
};var _aiFlowHandler={
  _data:_CtrlDriver._buildProxy({}),
  _getFromStatusByTargetStatus:function(s,m){
    s=s.id||s
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let ss=[]
    _Util._loopObj(m._data.definition.moduleDataFlow,(v,k)=>{
      if(v.to[s]){
        ss.push(k)
      }
    })
    return ss
  },
  _getFlowScenarioData:function(t){
    t=_ideObjHandler._getDataByPath(t)
    t._data.dataMap=t._data.dataMap||[]
    let d=t._data.dataMap[0]
    if(!d){
      return []
    }
    return _Util._csvToObj(d.value)
  },
  _setFlowScenarioData:function(t,v){
    t=_ideObjHandler._getDataByPath(t)
    t._data.dataMap=t._data.dataMap||[]
    let d=t._data.dataMap[0]
    if(!d){
      d={name:"data",type:"c",value:""}
      t._data.dataMap.push(d)
    }
    d.value=_csvEditor._objToCSV(v)
  },
  _isScenarioableField:function(p,f,m,cm){
    if(p=="data"){
      if(f.field=="$status"){
        let mm=m._data||m
        mm=mm.code||mm
        if(_statusManagement._isSimpleStatusModule(m)||mm==cm){
          return
        }
      }else{
        return
      }
    }
    return 1
  },
  _getInitData:function(s,_curModule){
    if(!s){
      return
    }
    let _list=[[s.scenario.curGiven],s.oprs,s.dependencies,s.scenario.given,s.scenario.when,s.scenario.then],
        ds={},fs={}
    _list.forEach((z,zi)=>{
      z&&z.forEach((x,xi)=>{
        if(x&&(x.test||x.code)){
          let m=x.test?_curModule:_ideObjHandler._getDataByPath(x.code.split(".")[0]);
          m&&(["data","scenarioFields"]).forEach((k,ki)=>{
            x[k]&&x[k].forEach(y=>{
              if(!_aiFlowHandler._isScenarioableField(k,y,m,_curModule.code)){
                return 
              }

              let f=_aiGeneratorDataHandler._getFieldByCode(y.field,m),
                  c=y.colName
              if(c){
                fs[c]=f
                if(y.value===undefined){
                  ds[c]="bz-default"
                }else{
                  ds[c]=y.value
                }
              }
            })
          });
        }
      })
    });
    
    (s.dependencies||[]).forEach(x=>{
      x.data.forEach(y=>{
        if(y.field=="$status"){
          if(!_statusManagement._isDefStatus(y.value,x.code)){
            fs.$status=1
            ds.$status=y.value
          }
        }else{
          fs[y.colName]=_aiGeneratorDataHandler._getFieldByCode(y.field,x.code)
          ds[y.colName]=y.value
        }
      })
    })
    
    fs.$result=1
    ds.$result="success"
    return {_fields:fs,_data:ds}
  },
  //s:flow;
  _getOptionData:function(_curModule,s){
    let _list=[[s.scenario.curGiven],s.oprs,s.dependencies,s.scenario.given,s.scenario.when,s.scenario.then],
        ds={}
    _list.forEach(z=>{
      z&&z.forEach(x=>{
        if(x&&(x.test||x.code)){
          let m=x.test?_curModule:_ideObjHandler._getDataByPath(x.code.split(".")[0]);
          (["data","scenarioFields"]).forEach(k=>{
            x[k]&&x[k].forEach(y=>{
              if(!_aiFlowHandler._isScenarioableField(k,y,m,_curModule.code)){
                return 
              }
              let f=_aiGeneratorDataHandler._getFieldByCode(y.field,m),
                  c=y.colName
              if(c){
                if(y.value===undefined&&!["$status"].includes(y.field)){
                  ds[c]="bz-default"
                }else if(y.field=="$status"){
                  ds[c]=_statusManagement._getModuleStatusList(m).map(o=>{
                    return {
                      name:o.name,
                      opr:o.opr
                    }
                  })
                  _Util._spliceAll(ds[c],o=>{
                    return o.name==y.value||o.opr=="delete"
                  })
                  ds[c]=ds[c].map(x=>x.name)
                  if(y.value){
                    ds[c].unshift(y.value)
                  }else{
                    y.value=ds[c][0]
                  }
                }else{
                  if(f&&f.type=="boolean"){
                    ds[c]=["on","off","bz-default","bz-skip","bz-stop"]
                  }else{
                    ds[c]=y.value
                  }
                }
              }
            })
          })
        }
      })
    });

    (s.dependencies||[]).forEach(x=>{
      x.data.forEach(y=>{
        if(y.field=="$status"){
          if(!_statusManagement._isDefStatus(y.value,x.code)){
            ds.$status=y.value
          }
        }else{
          ds[y.colName]=y.value
        }
      })
    })
    
    return ds
  },
  _buildDefScenarioData:function(_options){
    let dd={}
    for(var k in _options){
      let v=_options[k]
      if(v&&v.constructor==Array){
        v=v[0]
      }
      dd[k]=v
    }
    if(!dd.$result){
      dd.$result="success"
    }
    return dd
  },
  //s:status
  _getFlowByStatus:function(s,m){
    try{
      s=s.split(/[,-\.]/)
      m=_aiGeneratorDataHandler._getModuleObject(m)
      return m._data.definition.moduleDataFlow[s[0]].to[s[1]]
    }catch(e){}
  },
  _getFlowKey:function(s,k,m){
    if(!k){
      s=_aiFlowHandler._getFlowByStatus(s,m)
      if(s){
        k=(s.find(x=>x.main)||s[0]).key
      }
    }
    return k
  },
  _getFlowByKey:function(s,k,m){
    s=_aiFlowHandler._getFlowByStatus(s,m)
    if(s){
      k=(k?s.find(x=>x.key==k):s.find(x=>x.main))||s[0]
      return k&&k.data
    }
  },
  //s:status,t: solution key
  _getFlowByTest:function(s,t,m){
    try{
      s=s.split(/[,-\.]/)
      m=_aiGeneratorDataHandler._getModuleObject(m)
      let f=m._data.definition.moduleDataFlow[s[0]].to[s[1]]
      if(f){
        s=parseInt(s[2])
        f=f.find(x=>x.key==(s||"default"))
        if(f){
          return f.data
        }
      }
    }catch(e){}
  },
  _collectFullStatusPath:function(d,_list,w){
    _list=_list||[]
    
    if((!w||w=="fs")&&d.fs){
      d.fs.forEach(x=>{
        _aiFlowHandler._collectFullStatusPath(x,_list,"fs")
      })
    }
    _list.push(d.k);
    if((!w||w=="to")&&d.to){
      d.to.forEach(x=>{
        _aiFlowHandler._collectFullStatusPath(x,_list,"to")
      })
    }
    return _list
  },
  _getOprSettingDesc:function(d){
    let m=_IDE._data._curModule._data,
        s=d.data||[]

    if(!d.test){
      return "N/A"
    }else{
      d=_ideObjHandler._getDataByPath(d.test)._data.name
      s=s.map(x=>{
        if(x.field){
          let f=_aiAPI._getFieldByModuleAndFieldCodeRef(x.field,m.code)
          if(f){
            return f._fullData+" = "+x.value
          }
        }
      }).join(", ")
      if(s){
        s=" ["+_bzMessage._common._data+": "+s+"]"
      }
    }                    
    return d+s
  },
  _getScenarioField:function(d){
    if(d.type&&d.field){
      let m
      if(d.type=="given"){
        m=d.code.split(".")[0]
      }else{
        m=_ideObjHandler._getDataByPath(d.test)._parent
      }
      return _aiGeneratorDataHandler._getFieldByCode(d.field,m)
    }
  },
  _getScenarioFieldDesc:function(d){
    if(d.type&&d.field&&d.colName){
      let t="["+_bzMessage._scenario._group[d.type]+"] "+d.colName+" - ",
          m,f;
      if(d.type=="given"){
        m=_aiFlowHandler._getRelatedModuleDesc(d)
        f=_aiGeneratorDataHandler._getFieldByCode(d.field,d.code.split(".")[0])
        return t+BZ._groupWords([m,f.name])
      }
      m=_ideObjHandler._getDataByPath(d.test)
      f=_aiGeneratorDataHandler._getFieldByCode(d.field,m._parent)
      return t+BZ._groupWords([m._data.name,f.name])
    }
    return "N/A"
  },
  _getSetableDataFields:function(d,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let vs=[]
    d.map(f=>{
      if(f.field=="$status"){
        if(_statusManagement._isSimpleStatusModule(m)){
          return
        }
      }
      vs.push(f)
    })
    return vs
  },
  _getDepSettingDesc:function(d){
    if(d&&d.code){
      let w=_aiFlowHandler._getRelatedModuleDesc(d)
      if(w){
        let m=_ideObjHandler._getDataByPath(d.code.split(".")[0])
      
        if(d.data&&d.data.length){
          let vs=_aiFlowHandler._getSetableDataFields(d.data,m)
          if(vs.length){
            w+=" ["+_bzMessage._aiDefinition._setting._fields+": "+vs.map(f=>{
              let ff=m._data.definition.fields.find(x=>x.code==f.field)

              return ff||["$status"].includes(f.field)?(f.colName+" = "+f.value):_bzMessage._common._error
            }).join(", ")+"]"
          }
        }
        return w
      }
    }
  },
  _getRelatedModuleDesc:function(d,_curModule){
    let v=_aiFlowHandler._getRelatedModuleAndField(d)
    if(v){
      let w=v._module.name
      if(v._field){
        w+=" ["+_bzMessage._aiDefinition._forField+v._field.name+"]"
      }
      return w
    }
  },
  _getRelatedModuleAndField:function(d,_curModule){
    d=d.code.split(".")
    d={
      code:d[0],
      field:d[1]
    }
    let m=_ideObjHandler._getDataByPath(d.code)
    if(m){
      m={_module:m._data}
      if(d.field){
        let f=_aiGeneratorDataHandler._getFieldByCode(d.field,_curModule)
        if(f){
          m._field=f
        }
      }
      return m
    }
  },
  _getDisplayName:function(k,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let v=m._data.definition
    let o=v.moduleDataFlow[k]
    if(o){
      o=o.displayName
      if(!o){
        o=_statusManagement._getDataStatusByKey(k,m)
        if(o){
          o=o.name
        }
      }
      return o
    }
  },
  _getFlowScenarioName:function(k,f,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)._data
    let t=_aiGeneratorDataHandler._getModuleObject(m)._data.tests.find(x=>{
      return x.definition&&x.definition.id==f+","+k
    })
    if(t){
      return t.name
    }
    console.log("Status: "+m.name+", "+k+";")
    k=_statusManagement._getDataStatusByKey(k,m)
    let d=_statusManagement._getDataStatusByKey(f,m)
    if(f=="start"){
      _opr="add"
    }else if(k.opr=="delete"){
      _opr="delete"
    }else{
      _opr="edit"
    }
    let _name=_Util._formatMessage(_bzMessage._aiDefinition._scenarioName[_opr],[m.name,(d&&d.name)||"",k.name])
    _name=_name.replace(/\s+/g," ")
    if(m.tests.find(x=>{return x.name==_name})){
      if(_opr=="add"){
        _name=_Util._formatMessage(_bzMessage._aiDefinition._scenarioName.add2,[m.name,k.name])
      }
    }else{
      return _name
    }
    _name=_name.replace(/\s+/g," ")
    let _idx="",n=1
    while(m.tests.find(x=>{return x.name==_name+_idx})){
      _idx=" ("+n+")"
      n++
    }
    _name+=_idx
    return _name
    
  },
  _getFromStatusList:function(d,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)._data.definition.moduleDataFlow
    let _list=[]
    for(var k in m){
      if(m[k].to[d]){
        _list.push(k)
      }
    }
    return _list
  },
  _deleteItem:function(d){
    let ds=[]
    d.fs.forEach(f=>{
      ds.push({
        f:f,
        chk:"on"
      })
    })
    _Util._confirmMessage({
      _tag:"div",
      _items:[
        {
          _tag:"div",
          _attr:{
            "class":"col-xs-12"
          },
          _text:"_bzMessage._model._deleteFlowFromList"
        },
        {
          _tag:"div",
          _attr:{
            "class":"col-xs-12"
          },
          _items:[
            {
              _tag:"label",
              _items:[
                {
                  _tag:"input",
                  _attr:{
                    type:"checkbox"
                  },
                  _dataModel:"_data._item.chk"
                },
                {
                  _text:"_aiFlowHandler._getDisplayName(_data._item.f.k)"
                }
              ]
            }
          ],
          _dataRepeat:function(){
            return ds
          }
        }
      ]
    },[{
      _title:_bzMessage._method._delete,
      _class:"btn-warn",
      _click:function(c){
        _doIt()
        c._ctrl._close()
      }
    }])
    
    function _doIt(){
      let md=_IDE._data._curModule._data,ts=[]
      let f=md.definition.moduleDataFlow
      
      ds.forEach(x=>{
        if(x.chk){
          let to= f[x.f.k].to
          let v=to[d.k].scenario
          if(v){
            v=_ideObjHandler._getDataByPath(v.code)
            if(v){
              ts.push(v._data)
            }
          }
          delete to[d.k]
          if(_Util._isEmpty(to)){
            f[x.f.k].to=0
          }
        }
      })
      _ideTestManagement._deleteItems(ts,0,function(){
        _ideModuleManagement._save()
      },1)
    }
  },
  _getMainTestType:function(m){
    let ts=[]
    m=_aiGeneratorDataHandler._getModuleObject(m);
    m._data.definition.moduleDataTypes.forEach(x=>{
      if(x.default){
        ts.push(x)
      }
    })
    return ts.length&&ts.map(x=>{return x.id})
  },
  _getFlowGivens:function(f,_curFromFlow){
    let s=f.scenario,
        vs=_Util._simpleClone(f.dependencies)
        
    if(_curFromFlow!="start"){
      if(!vs.find(x=>s.curGiven.code.includes(x.code+".")&&s.curGiven.varName==x.varName)){
        vs.unshift(s.curGiven)
      }
    }
    s.given=s.given||[]
    s.given.forEach(x=>vs.push(x))
    vs.sort((a,b)=>{
      return (a.idx||0)-(b.idx||0)
    })
    vs.forEach((x,i)=>{
      x.idx=i
      x.stepKey="given"
    })

    return vs
  },
  _popItem:function(f,d,_new){
    _aiPageHandler._refreshWinData={_data:[f,d,_new],_fun:"_popRelatedModuleForm"}
    let _curModule=_IDE._data._curModule._data
    let _curDataModel="_IDE._data._curModule._data.definition.moduleDataFlow[BZ._data._uiSwitch._curFromFlow].to[BZ._data._uiSwitch._curStatusFlow][BZ._data._uiSwitch._curSolutionIdx]",
        _flow=_curModule.definition.moduleDataFlow,
        _relatedModules=_aiGeneratorDataHandler._getRelatedModules(),
        _uiSwitch=BZ._data._uiSwitch
        
    _uiSwitch._curFromFlow=f
    _uiSwitch._curStatusFlow=d
    _uiSwitch._curSolutionIdx=0
    _uiSwitch._flowItemTab=_new?'_role':_getCurOprList().length?'_scenario':'_operation'

    _aiPageHandler._popInWin(0,{
      _if:function(d,c,o){
        if(!_IDE._data._curModule||_curModule!=_IDE._data._curModule._data){
          o=$(".bz-flow-window")[0]
          if(o){
            $(_Util._getClosestElement(o,o,".btn-cancel")).click()
          }
          return
        }
        return _uiSwitch._curFromFlow
      },
      _tag:"div",
      _attr:{
        class:"bz-flow-window bz-v-panel"
      },
      _update:function(){
        _saveData()
      },
      _items:[
        {
          _if:function(){
            return _uiSwitch._curFromFlow
          },
          _tag:"div",
          _attr:{
            style:"flex:1",
            class:"bz-v-panel"
          },
          _items:[
            {
              _tag:"div",
              _attr:{
                style:"display:flex;"
              },
              _items:[
                //From
                {
                  _tag:"div",
                  _attr:{
                    "class":"input-group bz-flex-col"
                  },
                  _items:[
                    //label
                    {
                      _tag:"label",
                      _attr:{
                        "class":"input-group-addon"
                      },
                      _text:"_bzMessage._aiDefinition._fromStatus"
                    },
                    //select
                    {
                      _tag:"select",
                      _attr:{
                        "class":"form-control"
                      },
                      _update:function(){},
                      _dataModel:"BZ._data._uiSwitch._curFromFlow",
                      _items:[
                        {
                          _tag:"option",
                          _attr:{
                            value:"_data._item"
                          },
                          _text:"_aiFlowHandler._getDisplayName(_data._item)",
                          _dataRepeat:function(){
                            return _aiFlowHandler._getFromStatusList(_uiSwitch._curStatusFlow)
                          }
                        }
                      ]
                    }
                  ]
                },
                //current status
                {
                  _tag:"div",
                  _attr:{
                    "class":"input-group bz-flex-col"
                  },
                  _items:[
                    {
                      _tag:"label",
                      _attr:{
                        "class":"input-group-addon required"
                      },
                      _text:"_bzMessage._aiDefinition._toStatus"
                    },
                    {
                      _tag:"select",
                      _update:function(){},
                      _attr:{
                        "class":"form-control",
                        required:1,
                      },
                      _dataModel:"BZ._data._uiSwitch._curStatusFlow",
                      _items:[
                        {
                          _tag:"option",
                          _attr:{
                            value:"_data._item.id"
                          },
                          _text:"_data._item.name",
                          _dataRepeat:function(){
                            return Object.keys(_flow[_uiSwitch._curFromFlow].to).map(x=>{
                              return _curModule.definition.moduleDataStatus.find(y=>y.id==x)
                            })
                          }
                        }
                      ],
                      _jqext:{
                        change:function(){
                          _Util._resizeModelWindow()
                        }
                      }
                    }
                  ]
                }
              ]
            },
            //Solution
            {
              _tag:"div",
              _attr:{
                "class":"input-group",
                style:"display:flex;"
              },
              _items:[
                //label
                {
                  _if:function(){
                    return _uiSwitch._curFromFlow
                  },
                  _tag:"label",
                  _attr:{
                    "class":"input-group-addon",
                    style:function(){
                      if(_uiSwitch._curFromFlow&&_flow[_uiSwitch._curFromFlow].to[_uiSwitch._curStatusFlow].length>1){
                        return "flex:unset"
                      }else{
                        return "flex:1"
                      }
                    }
                  },
                  _text:"_bzMessage._common._solution"
                },
                //select
                {
                  _if:function(){
                    return _uiSwitch._curFromFlow&&_flow[_uiSwitch._curFromFlow].to[_uiSwitch._curStatusFlow].length>1
                  },
                  _tag:"select",
                  _attr:{
                    "class":"form-control",
                    style:"flex:1"
                  },
                  _update:function(){},
                  _dataModel:"BZ._data._uiSwitch._curSolutionIdx",
                  _items:[
                    {
                      _tag:"option",
                      _attr:{
                        value:"_data._idx"
                      },
                      _text:"_data._item.key+(_data._item.main?' ('+_bzMessage._common._main+')':'')",
                      _dataRepeat:function(){
                        return _flow[_uiSwitch._curFromFlow].to[_uiSwitch._curStatusFlow]
                      }
                    }
                  ]
                },
                {
                  _if:function(){
                    return _uiSwitch._curFromFlow&&_flow[_uiSwitch._curFromFlow].to[_uiSwitch._curStatusFlow].length>1
                  },
                  _tag:"div",
                  _attr:{
                    class:"input-group-addon-org",
                    style:"padding:5px 5px 0 5px;"
                  },
                  _items:[
                    {
                      _tag:"label",
                      _items:[
                        {
                          _tag:"input",
                          _attr:{
                            type:"checkbox"
                          },
                          _dataModel:_curDataModel+".main",
                          _jqext:{
                            click:function(){
                              _flow[BZ._data._uiSwitch._curFromFlow].to[BZ._data._uiSwitch._curStatusFlow].forEach((x,i)=>{
                                if(i!=_uiSwitch._curSolutionIdx){
                                  x.main=""
                                }
                              })
                            }
                          }
                        },
                        {
                          _text:"_bzMessage._common._main"
                        }
                      ]
                    }
                  ]
                },
                {
                  _tag:"div",
                  _attr:{
                    class:"input-group-addon-org",
                    style:"padding:5px 5px 0 5px;"
                  },
                  _items:[
                    {
                      _if:function(){
                        return _uiSwitch._curFromFlow&&_flow[_uiSwitch._curFromFlow].to[_uiSwitch._curStatusFlow].length>1
                      },
                      _tag:"button",
                      _attr:{
                        class:"btn btn-icon bz-small-btn bz-edit"
                      },
                      _jqext:{
                        click:function(){
                          _editFlowKey(1)
                        }
                      }
                    },
                    {
                      _if:function(){
                        return _uiSwitch._curFromFlow&&_flow[_uiSwitch._curFromFlow].to[_uiSwitch._curStatusFlow].length>1
                      },
                      _tag:"button",
                      _attr:{
                        style:"margin:0 5px;",
                        class:"btn btn-icon bz-small-btn bz-delete"
                      },
                      _jqext:{
                        click:function(){
                          let d=_flow[_uiSwitch._curFromFlow].to[_uiSwitch._curStatusFlow]
                          let dd=d[_uiSwitch._curSolutionIdx]
                          let v=_ideObjHandler._getDataByPath(dd.data.scenario.code)
                          _ideTestManagement._deleteItem(_curModule,v,function(){
                            d.splice(_uiSwitch._curSolutionIdx,1)
                            _ideModuleManagement._save()
                            _uiSwitch._curSolutionIdx=0
                            _Util._resizeModelWindow()
                          })
                        }
                      }
                    },
                    {
                      _tag:"button",
                      _attr:{
                        class:"btn btn-icon bz-small-btn bz-plus"
                      },
                      _jqext:{
                        click:function(){
                          _editFlowKey()
                        }
                      }
                    }
                  ]
                }
              ]
            },
            //Tabs
            {
              _tag:"div",
              _attr:{
                class:"bz-h-h-tabs bz-std-tabs bz-v-panel",
                style:"flex:1"
              },
              _items:[
                //Tabs
                {
                  _tag:"div",
                  _attr:{
                    "class":"bz-h-h-tab-items",
                    style:"border-bottom:var(--bz-border);"
                  },
                  _items:[
                    {
                      _if:function(){
                        return _uiSwitch._curFromFlow
                      },
                      _tag:"a",
                      _attr:{
                        "tab-info":function(d){
                          if(!_uiSwitch._curFromFlow){
                            return
                          }
                          let f=_getCurFlow()
                          switch(d._item){
                            case "_operation":
                              return _getCurOprList().length
                            case "_dependence":
                              return _getCurDependences().length||""
                            case "_role":
                              let rs=f.roles
                              return rs=="*"||_Util._isEmpty(rs)?"*":rs=="sign-out"?"":"🔒"
                            case "_scenario":
                              return f.scenario.enable?"✓":""
                            case "_updateData":
                              return _getCurPeriodOprList().length||""
                          }
                        },
                        class:"'bz-h-h-tab-item bz-tab-ex-info '+(BZ._data._uiSwitch._flowItemTab==_data._item?'white-active':'')"
                      },
                      _text:"_bzMessage._aiDefinition[_data._item]",
                      _dataRepeat:["_role","_operation","_dependence","_scenario","_updateData"],
                      _jqext:{
                        click:function(){
                          _uiSwitch._flowItemTab=this._data._item
                          _Util._resizeModelWindow()
                        }
                      }
                    }
                  ]
                },
                //Role
                {
                  _if:"BZ._data._uiSwitch._flowItemTab=='_role'",
                  _tag:"div",
                  _attr:{
                    class:"bz-h-h-tab-content",
                    style:"flex:1"
                  },
                  _items:[
                    {
                      _tag:"div",
                      _attr:{
                        "class":"col-xs-4"
                      },
                      _items:[
                        {
                          _tag:"label",
                          _attr:{
                            style:"margin:0 10px;"
                          },
                          _items:[
                            {
                              _tag:"input",
                              _attr:{
                                type:"checkbox",
                                value:"_data._key",
                                disabled:function(d){
                                  d=d._key
                                  let rs=_getCurFlow().roles
                                  return !_Util._isEmpty(rs)&&d!='*'&&rs!=d
                                },
                                checked:function(d){
                                  let rs=_getCurFlow().roles
                                  return rs=='*'||rs==d._key
                                }
                              },
                              _jqext:{
                                click:function(){
                                  let f=_getCurFlow()
                                  if(this.checked){
                                    f.roles=this._data._key
                                  }else{
                                    f.roles=""
                                  }
                                  _ideModuleManagement._save()
                                }
                              }
                            },
                            {
                              _text:"_data._item",
                            }
                          ]
                        }
                      ],
                      _dataRepeat:_bzMessage._aiDefinition._authOptions
                    },
                    {
                      _tag:"div",
                      _attr:{
                        "class":"col-xs-4"
                      },
                      _items:[
                        {
                          _tag:"label",
                          _attr:{
                            style:"margin:0 10px;"
                          },
                          _items:[
                            {
                              _tag:"input",
                              _attr:{
                                type:"checkbox",
                                value:"_data._item",
                                disabled:function(){
                                  return ['*','sign-in','sign-out'].includes(_getCurFlow().roles)
                                },
                                checked:function(d){
                                  let rs=_getCurFlow().roles
                                  return ['*','sign-in'].includes(rs)||rs.includes(d._item)
                                }
                              },
                              _jqext:{
                                click:function(){
                                  let _chk=this.checked
                                  let d=_getCurFlow()
                                  if(!d.roles||d.roles.constructor!=Array){
                                    d.roles=[]
                                  }
                                  if(this.checked){
                                    d.roles.push(this.value)
                                  }else{
                                    d.roles.splice(d.roles.indexOf(this.value),1)
                                  }
                                  _ideModuleManagement._save()
                                }
                              }
                            },
                            {
                              _text:"_data._item",
                            }
                          ]
                        }
                      ],
                      _dataRepeat:function(){
                        return _aiAuthHandler._getRolesByHostId(_curModule.defaultHostId)
                      }
                    }
                  ]
                },
                //operations
                {
                  _if:"BZ._data._uiSwitch._flowItemTab=='_operation'",
                  _tag:"div",
                  _attr:{
                    class:"bz-h-h-tab-content"
                  },
                  _items:[
                    //Operations list
                    {
                      _tag:"div",
                      _attr:{
                        "class":"bz-flow-opr-list"
                      },
                      _items:[
                        _getListViewDev({
                          _details:_getOprSettingDetailsViewDev(),
                          _descFun:_aiFlowHandler._getOprSettingDesc,
                          _listFun:_getCurOprList,
                          _dragOrder:1,
                          _keyField:"test",
                          _showIdx:1
                        }),
                        _getAddBtnViewDev({
                          _listFun:_getCurOprList,
                          _keyField:"test",
                          _title:_bzMessage._method._insertOpr,
                          _newItem:{
                            test:"",
                            data:[],
                            scenarioFields:[]
                          }
                        }),
                        {
                          _tag:"button",
                          _attr:{
                            class:"btn btn-primary btn-icon-text bz-small-btn bz-plus pull-left",
                            style:"margin:10px"
                          },
                          _text:"_bzMessage._method._createOpr",
                          _jqext:{
                            click:function(){
                              _aiModelHandler._createOpr(function(d){
                                _getCurOprList().push({
                                  test:_IDE._data._curModule._data.code+"."+d.code,
                                  varName:_aiGeneratorDataHandler._getCurModuleDataName(),
                                  stepKey:"when",
                                  scenarioFields:[],
                                  data:[]
                                })
                                _ideModuleManagement._save()
                              })
                            }
                          }
                        }
                      ]
                    }
                  ]
                },
                //dependency
                {
                  _if:"BZ._data._uiSwitch._flowItemTab=='_dependence'",
                  _tag:"div",
                  _attr:{
                    class:"bz-h-h-tab-content"
                  },
                  _items:[
                    //Dependence list
                    {
                      _tag:"div",
                      _attr:{
                        "class":"bz-flow-opr-list"
                      },
                      _items:[
                        _getListViewDev({
                          _details:_getDepSettingDetailsViewDev(),
                          _descFun:_aiFlowHandler._getDepSettingDesc,
                          _listFun:_getCurDependences,
                          _dragOrder:1,
                          _keyField:"code",
                          _showIdx:1
                        }),
                        _getAddBtnViewDev({
                          _listFun:_getCurDependences,
                          _title:_bzMessage._method._insertDep,
                          _keyField:"code",
                          _newItem:{
                            varName:"",
                            data:[],
                            scenarioFields:[]
                          }
                        }),
                        {
                          _tag:"button",
                          _attr:{
                            class:"btn btn-primary btn-icon-text bz-small-btn bz-plus pull-left",
                            style:"margin:10px"
                          },
                          _text:"_bzMessage._method._createDep",
                          _jqext:{
                            click:function(){
                              _aiModelHandler._createDepModule(function(d){
                                d=_ideModuleManagement._getItemByName(d[0].name)

                                let gs=_getCurDependences(),
                                    n=_aiAPI._getModuleVarName(d,1)
                                gs.push({
                                  code:d.code,
                                  varName:_aiGeneratorDataHandler._getCurModuleDataName(d),
                                  stepKey:"given",
                                  idx:gs.length,
                                  scenarioFields:[],
                                  data:[
                                    {
                                      field: "$status",
                                      colName: n+"_"+"status",
                                      value: "Created"
                                    }
                                  ]
                                })
                                _ideModuleManagement._save()
                              })
                            }
                          }
                        }
                      ]
                    }
                  ]
                },
                //Scenario
                {
                  _if:"BZ._data._uiSwitch._flowItemTab=='_scenario'",
                  _tag:"div",
                  _attr:{
                    class:"bz-h-h-tab-content"
                  },
                  _items:[
                    //Generate Scenario
                    {
                      _tag:"div",
                      _attr:{
                        "class":"input-group",
                        style:"margin:5px 10px"
                      },
                      _items:[
                        {
                          _tag:"label",
                          _attr:{
                            class:"input-group-addon"
                          },
                          _items:[
                            {
                              _tag:"input",
                              _attr:{
                                type:"checkbox"
                              },
                              _dataModel:function(){
                                if(_uiSwitch._curFromFlow){
                                  return _curDataModel+".data.scenario.enable"
                                }
                              },
                              _jqext:{
                                click:function(){
                                  let d=_getCurFlow()
                                  
                                  if(this.checked){
                                    let k=_flow[_uiSwitch._curFromFlow].to[_uiSwitch._curStatusFlow][_uiSwitch._curSolutionIdx].key
                                    _aiFlowHandler._generateScenarioTest(_uiSwitch._curFromFlow,_uiSwitch._curStatusFlow,k,_curModule,function(x){
                                      d.scenario.code=_curModule.code+"."+x.code
                                      d.scenario.enable="on"
                                      _ideModuleManagement._save()
                                    })
                                  }else{
                                    let t=_ideObjHandler._getDataByPath(d.scenario.code)
                                    if(t){
                                      delete t._data.definition
                                      _ideTestManagement._deleteItem(_curModule,t,function(){
                                        d.scenario.code=""
                                        d.scenario.enable=""
                                        _ideModuleManagement._save()
                                      })
                                    }
                                  }
                                  _Util._resizeModelWindow()
                                }
                              }
                            },
                            {
                              _text:"_bzMessage._aiDefinition._generateScenario"
                            }
                          ]
                        },
                        //scenario name
                        {
                          _if:function(){
                            return _uiSwitch._curFromFlow
                          },
                          _tag:"input",
                          _attr:{
                            "class":"form-control",
                            value:function(){
                              let t=_getCurScenario().code
                              return t?_ideObjHandler._getDataByPath(t)._data.name:""
                            }
                          },
                          _jqext:{
                            change:function(){
                              let t=_ideObjHandler._getDataByPath(_getCurScenario().code)
                              t._data.name=this.value
                              _ideTestManagement._save(t,_curModule)
                            }
                          }
                        },
                        {
                          _tag:"div",
                          _attr:{
                            class:"input-group-btn"
                          },
                          _items:[
                            {
                              _tag:"button",
                              _attr:{
                                class:"btn btn-icon bz-small-btn bz-scenario"
                              },
                              _jqext:{
                                click:function(){
                                  let d=this._data
                                  let v=_getCurScenario().code
                                  let t=_ideObjHandler._getDataByPath(v)
                                  _guiModuleHandler._openDetails({
                                    k:v,
                                    t:t._data
                                  })
                                }
                              }
                            },
                            {
                              _tag:"button",
                              _attr:{
                                class:"btn btn-icon bz-small-btn bz-play"
                              },
                              _jqext:{
                                click:function(){
                                  BZ._setHash(_getCurScenario().code)
                                  _Util._closeModelWindow()
                                  setTimeout(()=>{
                                    _ideTestManagement._playTest();
                                  },100)
                                }
                              }
                            }
                          ]
                        }
                      ]
                    },
                    //Actions
                    {
                      _if:function(){
                        return _uiSwitch._curFromFlow&&_getCurScenario().enable
                      },
                      _tag:"div",
                      _items:[
                        //Given
                        {
                          _tag:"fieldset",
                          _attr:{
                            class:"bz-flow-scenario-block"
                          },
                          _items:[
                            {
                              _tag:"legend",
                              _text:"_bzMessage._scenario._group.given"
                            },
                            _getAddBtnViewDev({
                              _listFun:_getExGivenItem,
                              _keyField:"code",
                              //_title:_bzMessage._method._addGiven,
                              _newItem:{type:"*",scenarioFields:[]},
                              _class:"bz-fieldset-btn btn-primary btn btn-icon bz-mini-btn bz-plus"
                            }),
                            //Given of base (curModule, dependencies)
                            {
                              _tag:"div",
                              _attr:{
                                class:"bz-block"
                              },
                              _items:[
                                {
                                  _tag:"div",
                                  _update:function(){},
                                  _attr:{
                                    "class":"bz-scenario-item-list"
                                  },
                                  _items:[
                                    _getListViewDev({
                                      _details:_getScenarioItemDetailsViewDev("_given",_getExGivenItem),
                                      _descFun:_getScenarioItemDesc,
                                      _listFun:_getGivens,
                                      _dataListFun:_getExGivenItem,
                                      _dragOrder:1,
                                      _keyField:"code",
                                      _group:"given"
                                    })
                                  ]
                                }
                              ]
                            },
                            //Given of auth
                            {
                              _tag:"div",
                              _attr:{
                                class:"bz-block"
                              },
                              _items:[
                                {
                                  _tag:"div",
                                  _update:function(){},
                                  _attr:{
                                    "class":"bz-scenario-item-list"
                                  },
                                  _items:[
                                    _getListViewDev({
                                      _details:_getScenarioActionDetailsViewDev("_given"),
                                      _descFun:_getScenarioAuthDesc,
                                      _listFun:_getAuthGivenItem,
                                      _group:"given"
                                    })
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        //When
                        {
                          _tag:"fieldset",
                          _attr:{
                            class:"bz-flow-scenario-block"
                          },
                          _items:[
                            {
                              _tag:"legend",
                              _text:"_bzMessage._scenario._group.when"
                            },
                            _getAddBtnViewDev({
                              _listFun:_getWhenExItems,
                              _keyField:"test",
                              _newItem:{scenarioFields:[]},
                              _class:"bz-fieldset-btn btn-primary btn btn-icon bz-mini-btn bz-plus"
                            }),
                            {
                              _tag:"div",
                              _attr:{
                                class:"bz-block"
                              },
                              _items:[
                                {
                                  _tag:"div",
                                  _update:function(){},
                                  _attr:{
                                    "class":"bz-scenario-item-list"
                                  },
                                  _items:[
                                    _getListViewDev({
                                      _details:_getScenarioItemDetailsViewDev("_when"),
                                      _descFun:_getScenarioItemDesc,
                                      _listFun:_getCurOprList,
                                      _keyField:"test",
                                      _group:"when"
                                    })
                                  ]
                                }
                              ]
                            },
                            {
                              _tag:"div",
                              _attr:{
                                class:"bz-block"
                              },
                              _items:[
                                {
                                  _tag:"div",
                                  _update:function(){},
                                  _attr:{
                                    "class":"bz-scenario-item-list"
                                  },
                                  _items:[
                                    _getListViewDev({
                                      _details:_getScenarioItemDetailsViewDev("_when",_getWhenExItems),
                                      _descFun:_getScenarioItemDesc,
                                      _listFun:_getWhenExItems,
                                      _keyField:"test",
                                      _group:"when"
                                    })
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        //Then
                        {
                          _tag:"fieldset",
                          _attr:{
                            class:"bz-flow-scenario-block"
                          },
                          _items:[
                            {
                              _tag:"legend",
                              _text:"_bzMessage._scenario._group.then"
                            },
                            _getAddBtnViewDev({
                              _listFun:_getThenItems,
                              _keyField:"test",
                              _newItem:{scenarioFields:[],varName:_aiGeneratorDataHandler._getCurModuleDataName(),forDelete:"on"},
                              _class:"bz-fieldset-btn btn-primary btn btn-icon bz-mini-btn bz-plus"
                            }),
                            {
                              _tag:"div",
                              _attr:{
                                class:"bz-block"
                              },
                              _items:[
                                {
                                  _tag:"div",
                                  _update:function(){},
                                  _attr:{
                                    "class":"bz-scenario-item-list"
                                  },
                                  _items:[
                                    _getListViewDev({
                                      _details:_getScenarioItemDetailsViewDev("_then",_getThenItems),
                                      _descFun:_getScenarioItemDesc,
                                      _listFun:_getThenItems,
                                      _keyField:"test",
                                      _group:"then"
                                    })
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        //Data
                        {
                          _tag:"fieldset",
                          _attr:{
                            class:"bz-flow-scenario-block"
                          },
                          _items:[
                            {
                              _tag:"legend",
                              _text:"_bzMessage._aiDefinition._scenarios._scenarioData"
                            },
                            _getAddBtnViewDev({
                              _listFun:_getThenItems,
                              _click:function(){
                                _setScenarioData()
                              },
                              _class:"bz-fieldset-btn btn-primary btn btn-icon bz-mini-btn bz-edit",
                              _style:function(){
                                let d=_aiFlowHandler._getInitData(_getCurFlow(),_curModule)
                                
                                if(_Util._isEmpty(d._fields)){
                                  return "display:none"
                                }
                                return "display:block"
                              }
                            }),
                            {
                              _tag:"div",
                              _attr:{
                                class:"bz-block"
                              },
                              _items:[
                                {
                                  _tag:"pre",
                                  _attr:{
                                    class:"bz-scenario-item-list",
                                    style:"margin:5px -20px 0 20px;line-height:25px"
                                  },
                                  _text:function(){
                                    // let d=_aiFlowHandler._getFlowScenarioData(_getCurScenario().code)||[]
                                    // if(!d.length){
                                      // d=[_aiFlowHandler._getInitData(_getCurFlow(),_curModule)._data]
                                    // }
                                    let d=[_aiFlowHandler._getInitData(_getCurFlow(),_curModule)._data]
                                    return _Util._formatMessage(
                                      _bzMessage._aiDefinition._dataDesc,
                                      [
                                        Object.keys(d[0]||{}).length,
                                        d.length
                                      ]
                                    )
                                  }
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                //Period operations
                {
                  _if:"BZ._data._uiSwitch._flowItemTab=='_updateData'",
                  _tag:"div",
                  _attr:{
                    class:"bz-h-h-tab-content"
                  },
                  _items:[
                    //Operations list
                    {
                      _tag:"div",
                      _attr:{
                        "class":"bz-flow-opr-list"
                      },
                      _items:[
                        _getListViewDev({
                          _header:{
                            _tag:"div",
                            _attr:{
                              style:"display:flex;"
                            },
                            _items:[
                              {
                                _tag:"label",
                                _attr:{
                                  class:"bz-header",
                                  style:"'flex:'+_data._item._size"
                                },
                                _text:"_data._item._text",
                                _dataRepeat:[
                                  {_size:3,_text:_bzMessage._common._test},
                                  {_size:1,_text:_bzMessage._common._type},
                                  {_size:1,_text:_bzMessage._aiDefinition._role}
                                ]
                              },
                              {
                                _tag:"button",
                                _attr:{
                                  class:"btn btn-icon bz-small-btn bz-delete",
                                  style:"visibility:hidden"
                                }
                              }
                            ]
                          },
                          _keyField:"test",
                          _details:_getPeriodOprSettingDetailsViewDev(),
                          _listFun:_getCurPeriodOprList
                        }),
                        _getAddBtnViewDev({
                          _listFun:_getCurPeriodOprList,
                          _keyField:"test",
                          _title:_bzMessage._method._addTest,
                          _newItem:{
                            test:"",
                            role:"*",
                            type:"*"
                          }
                        })
                      ]
                    },
                    {
                      _tag:"div",
                      _attr:{
                        class:"bz-note-text",
                        style:"position: absolute;bottom: 10px;width: calc(100% - 40px);"
                      },
                      _text:"_bzMessage._aiDefinition._prepareDataNote"
                    }
                  ]
                }
              ]
            }
          ],
          _jqext:{
            mousedown:function(e){
              BZ._data._uiSwitch._curSelectedFlowSettingItem=0
            }
          }
        },
        //Empty
        {
          _if:function(){
            return !_uiSwitch._curFromFlow
          },
          _tag:"div",
          _text:"N / A"
        }
      ]
    },_bzMessage._aiDefinition._flowSetting)
    
    function _editFlowKey(_update){
      let d=_flow[_uiSwitch._curFromFlow].to[_uiSwitch._curStatusFlow]
      BZ._data._uiSwitch._curKey=""
      if(_update){
        BZ._data._uiSwitch._curKey=d[_uiSwitch._curSolutionIdx].key
      }
      _Util._confirmMessage({
        _tag:"div",
        _attr:{
          class:"input-group"
        },
        _items:[
          {
            _tag:"label",
            _attr:{
              class:"input-group-addon"
            },
            _text:"_bzMessage._common._key"
          },
          {
            _tag:"input",
            _attr:{
              class:"form-control"
            },
            _dataModel:"BZ._data._uiSwitch._curKey"
          }
        ]
      },[{
        _title:_bzMessage._method._save,
        _click:function(c){
          if(_update){
            d[_uiSwitch._curSolutionIdx].key=BZ._data._uiSwitch._curKey
            _ideModuleManagement._save()
          }else{
            let dd=_Util._clone(d[_uiSwitch._curSolutionIdx])
            dd.key=BZ._data._uiSwitch._curKey
            d.push(dd)
            _uiSwitch._curSolutionIdx=d.length-1
            _uiSwitch._flowItemTab="_role"
            dd.data.oprs=[]

            _aiFlowHandler._generateScenarioTest(_uiSwitch._curFromFlow,_uiSwitch._curStatusFlow,dd.key,_curModule,function(t){
              dd.data.scenario.code=_curModule.code+"."+t.code
              _ideModuleManagement._save()
              _Util._resizeModelWindow()
            })
          }
          c._ctrl._close()
        }
      }])
      if(_update){
        
      }
    }
    
    function _getThenItems(){
      let s=_getCurScenario()
      s.then=s.then||[]
      _setStepKey(s.then,"then")
      return s.then
    }

    function _getWhenExItems(){
      let s=_getCurScenario()
      s.when=s.when||[]
      _setStepKey(s.when,"when")
      return s.when
    }
    
    function _setStepKey(vs,_group){
      vs.forEach((v,i)=>{
        v.stepKey=_group
      })
    }
    
    function _getScenarioAuthDesc(d){
      let w=_ideActionManagement._getAutoDescription(d)
      return _Util._toCapitalWord(w.replace(_bzMessage._scenario[d.stepKey][0],"").trim())
    }
    
    function _getScenarioItemDesc(d){
      let s=_getCurScenario()
      let w=_ideActionManagement._getAutoDescription(_aiGenerator._generateScenarioAction(s.code,_uiSwitch._curStatusFlow,d))
      return _Util._toCapitalWord(w.replace(_bzMessage._scenario[d.stepKey][0],"").trim())
    }
    
    function _getAuthGivenItem(){
      let f=_getCurFlow(),as=[]
      _aiGenerator._generateAuthAction(f,_curModule,0,0,as)
      return as
    }

    function _getGivens(){
      return _aiFlowHandler._getFlowGivens(_getCurFlow(),_uiSwitch._curFromFlow)
    }

    function _getExGivenItem(){
      let s=_getCurScenario()
      s.given=s.given||[]
      return s.given
    }

    function _handleFields(_save){
      let s=_getCurScenario()
      if(!s.enable){
        return _save&&_save()
      }
      let _options=_aiFlowHandler._getOptionData(_curModule,_getCurFlow())
      _options.$result="success"
      let t=_ideObjHandler._getDataByPath(s.code)

      let d=_Util._clone(t._data.dataMap||[]),
          op={}
      d=d[0]||{name:"data",type:"c",value:""}
      d=_Util._csvToObj(d.value)
      if(d.length){
        d.forEach(dd=>{
          for(var k in dd){
            if(_options[k]===undefined){
              delete dd[k]
            }
          }
          for(var k in _options){
            if(dd[k]===undefined){
              let v=_options[k]
              if(v&&v.constructor==Array){
                v=v[0]
              }
              dd[k]=v
            }
          }
        })
      }else{
        d.push(_aiFlowHandler._buildDefScenarioData(_options))
      }
      if(_save){
        _updateScenarioData(d,_save)
      }
      _options.$result=["success","failed","warning","error"]
      return {_data:d,_options:_options}
    }
    
    function _updateScenarioData(d,_fun){
      let s=_getCurScenario()
      let t=_ideObjHandler._getDataByPath(s.code)
      if(d&&d.length){
        t._data.dataMap=[{
          name:"data",
          type:"c",
          value:_csvEditor._objToCSV(d)
        }]
        t._data.loopData={
          loopStart:0,
          loopValue:"$test.data"
        }
      }else{
        t._data.dataMap=[]
        t._data.loopData={}
      }

      _ideTestManagement._save(t,_curModule,_fun)
    }
    function _setScenarioData(){
      let d=_handleFields()

      let _csvTable=_csvEditor._buildUI(d._data,1,d._options,0,0,{})
      
      _Util._confirmMessage({
        _tag:"div",
        _attr:{
          style:"height:500px;"
        },
        _items:[
          _csvTable._viewDef
        ]
      },[{
        _title:_bzMessage._method._done,
        _click:function(c){
          _updateScenarioData(_csvTable._getData())
          c._ctrl._close()
        }
      }],_bzMessage._aiDefinition._scenarios._scenarioData,"90%")
    }
    
    function _getScenarioItemDetailsViewDev(_type,_list){
      return [
        //module(given)
        {
          _if:function(d){
            let vs;
            if(_list){
              vs=_list()
            }
            return _type=='_given'&&vs&&vs.includes(d._item)
          },
          _tag:"select",
          _attr:{
            "class":"form-control",
            style:"flex:2"
          },
          _dataModel:"_data._item.code",
          _items:[
            {
              _tag:"option",
              _attr:{
                value:"_data._item.code"
              },
              _text:function(d){
                return _aiFlowHandler._getRelatedModuleDesc(d._item)
              },
              _dataRepeat:function(){
                let vs=_IDE._data._curVersion.modules.filter(x=>x.bt=="data").map(x=>{return {code:x.code}})
                return vs
              }
            }
          ],
          _jqext:{
            click:function(){
              this._data._item.varName=_aiGeneratorDataHandler._getCurModuleDataName(this.value)
            }
          }
        },
        {
          _if:function(d){
            let vs;
            if(_list){
              vs=_list()
            }
            return _type=='_given'&&(!_list||!vs.includes(d._item))
          },
          _tag:"input",
          _attr:{
            "class":"form-control",
            readonly:1,
            value:"_aiFlowHandler._getRelatedModuleDesc(_data._item)"
          }
        },
        //operations (when)
        {
          _if:function(){
            return _type=='_when'
          },
          _tag:function(){
            return _list?"select":"input"
          },
          _attr:{
            "class":"form-control",
            style:"flex:2",
            disabled:function(){
              return !_list
            },
            value:!_list&&function(d){
              return _ideObjHandler._getDataByPath(d._item.test)._data.name
            }
          },
          _dataModel:_list?"_data._item.test":"",
          _items:[
            {
              _tag:"option",
              _attr:{
                value:"_data._item.test"
              },
              _text:function(d){
                return _ideObjHandler._getDataByPath(d._item.test)._data.name
              },
              _dataRepeat:function(){
                return _list?_getCurOprList():[]
              }
            }
          ]
        },
        //validation (then)
        {
          _if:function(){
            return _type=='_then'
          },
          _tag:"select",
          _attr:{
            "class":"form-control",
            style:"flex:2"
          },
          _dataModel:"_data._item.test",
          _jqext:{
            change:function(){
              _ideModuleManagement._save()
            }
          },
          _items:[
            {
              _tag:"option",
              _attr:{
                value:function(d){
                  return d._item.m.code+"."+d._item.t.code
                }
              },
              _text:function(d){
                d=d._item
                return '['+d.m.code+"."+d.t.code+'] '+d.t.name
              },
              _dataRepeat:function(){
                let fs=[]
                _curModule.tests.forEach(t=>{
                  if(t.subtype=="validation"){
                    fs.push({m:_curModule,t:t})
                  }
                })
                _IDE._data._curVersion.modules.forEach(m=>{
                  if(m.bt=="data"&&m!=_curModule){
                    m.tests.forEach(t=>{
                      if(t.subtype=="validation"){
                        fs.push({m:m,t:t})
                      }
                    })
                  }
                })
                return fs
              }
            }
          ]
        },
        //colName Setting
        {
          _tag:"a",
          _attr:{
            "class":"'bz-flow-set-ex-data'+(_Util._isEmpty(_data._item.data)?'':' bz-with-value')",
            disabled:"!_data._item.code&&!_data._item.test"
          },
          _text:"_bzMessage._aiDefinition._colName",
          _jqext:{
            click:function(){
              let d=this._data._item
              if(d.code){
                let m=_ideObjHandler._getDataByPath(d.code.split(".")[0])
                if(!m){
                  return
                }
                let fs=_getModuleAndSubModuleFields(m._data)
                if(_type=="_given"&&_list){
                  fs.unshift({code:"$status",data:"$status",name:"$status"})
                }
                _doFieldMap({
                  _data:d,
                  _fields:fs,
                  _title:_bzMessage._aiDefinition._depDataSetting
                })
              }else if(d.test){
                let t=_ideObjHandler._getDataByPath(d.test)
                if(!t){
                  return
                }
                let fs=_getModuleAndSubModuleFields(t._parent._data)

                _doFieldMap({
                  _data:d,
                  _fields:fs,
                  _title:_bzMessage._aiDefinition._exColumns,
                  _type:_type
                })
              }
            }
          }
        },
        //delete button
        {
          _if:function(d){
            let vs;
            if(_list){
              vs=_list()
            }
            return _list&&vs.includes(d._item)
          },
          _tag:"button",
          _attr:{
            style:"margin:5px;",
            "class":"btn btn-icon bz-small-btn bz-delete"
          },
          _jqext:{
            click:function(){
              let d=_list().splice(this._data._idx,1)[0]
              
              _handleFields(function(){
                _saveData()
              })
            }
          }
        }
      ]
    }
    
    function _getScenarioActionDetailsViewDev(){
      return [
        {
          _tag:"div",
          _attr:{
            style:"flex:1"
          },
          _text:function(d){
            let t=_ideObjHandler._getDataByPath(d._item.refOfSuccess)
            return t._data.name
          }
        }
      ]
    }
    
    function _chkDuplicateColName(o,_alert){
      let s=_getCurFlow(),
          n=o.value,
          ds=[[s.scenario.curGiven],s.oprs,s.dependencies,s.scenario.given,s.scenario.when,s.scenario.then]

      return _findDuplicateInList(ds)
      
      function _findDuplicateInList(_list){
        if(_list.find(z=>{
          return z&&z.find(x=>{
            return x&&((x.data&&x.data.find(y=>{
              return y.colName==n&&y!=o._data._item
            }))||(x.scenarioFields&&x.scenarioFields.find(y=>{
              return y.colName==n&&y!=o._data._item
            })))
          })
        })){
          if(_alert){
            alert(_bzMessage._system._error._duplicateName,n)
          }
          return 1
        }
      }
    }
    
    function _updateScenarioColName(o,_alert){
      let d=o._oldValue,
          t=_getCurScenario().code

      let dd=_aiFlowHandler._getFlowScenarioData(t),
          _name=o.value,n=0
      
      while(_chkDuplicateColName(o,_alert)){
        if(!_alert){
          n++
          o.value=_name+"_"+n
        }else{
          o.value=o._data._item.colName=o._oldValue
          return
        }
      }
      o._data._item.colName=o._oldValue=o.value
      
      if(d){
        dd&&dd.forEach(x=>{
          x[o.value]=x[d]
          delete x[d]
        })
      }
      _aiFlowHandler._setFlowScenarioData(t,dd)
      _ideTestManagement._save(_ideObjHandler._getDataByPath(t),_curModule)
    }

    function _getDepSettingDetailsViewDev(){
      return [
        //module name
        {
          _tag:"select",
          _attr:{
            "class":"form-control"
          },
          _dataModel:"_data._item.code",
          _items:[
            {
              _tag:"option",
              _attr:{
                value:"_data._item.code"
              },
              _text:"_aiFlowHandler._getRelatedModuleDesc(_data._item)",
              _dataRepeat:function(){
                let ms=[]
                _relatedModules.forEach(x=>{
                  if(x.type!="modulesub"||_uiSwitch._curFromFlow!="start"){
                    ms.push(x)
                  }
                })
                
                _IDE._data._curVersion.modules.forEach(x=>{
                  if(x.bt=="data"&&!_relatedModules.find(y=>y.code==x.code)){
                    ms.push(x)
                  }
                })
                
                return ms
              }
            }
          ],
          _jqext:{
            change:function(){
              let d=this._data._item
              let s=this.value.split(".")[0]
              if(s){
                let m=_aiGeneratorDataHandler._getModuleObject(s)._data
                d.varName=_aiGeneratorDataHandler._getCurModuleDataName(m)
                s=_statusManagement._getModuleDefStatus(m)
                if(s){
                  let mn=_aiAPI._getModuleVarName(m,1)
                  d.data=[
                    {
                      field:"$status",
                      colName:_Util._formatMessage(_bzMessage._aiDefinition.$status,mn),
                      value:s.name
                    }
                  ]
                  d.scenarioFields=[]
                  return
                }
              }
              alert(_bzMessage._aiDefinition._statusSettingError,_ideObjHandler._getDataByPath(s)._data.name)
            }
          }
        },
        //data Setting
        {
          _tag:"a",
          _attr:{
            "class":"'bz-flow-set-ex-data'+(_Util._isEmpty(_data._item.data)?'':' bz-with-value')",
            disabled:"!_data._item.code"
          },
          _text:"_bzMessage._aiDefinition._depData",
          _jqext:{
            click:function(){
              let d=this._data._item
              if(d.code){
                let m=_ideObjHandler._getDataByPath(d.code)
                if(!m){
                  return
                }
                _doDataMap(_CtrlDriver._buildProxy({
                  _data:d,
                  _fields:_getModuleAndSubModuleFields(m._data),
                  _title:_bzMessage._aiDefinition._depDataSetting
                }))
              }
            }
          }
        },
        //delete button
        {
          _tag:"button",
          _attr:{
            style:"margin:5px;",
            "class":"btn btn-icon bz-small-btn bz-delete"
          },
          _jqext:{
            click:function(){
              let os=_getCurDependences(d)
              os.splice(this._data._idx,1)
              _Util._resizeModelWindow()
              _handleFields(function(){
                _saveData()
              })
            }
          }
        }
      ]
    }
    
    function _getModuleAndSubModuleFields(m){
      let fs=[]
      m.definition.fields.forEach(x=>{
        fs.push({
          code:m.code+"."+x.code,
          data:x.data,
          inputFormat:x.inputFormat,
          name:x.name
        })
      })
      let rs=m.definition.relatedModules||[]
      rs.find(x=>{
        if(x.type=="modulesub"){
          x=_aiGeneratorDataHandler._getModuleObject(x.module)
          if(x){
            x._data.definition.fields.forEach(y=>{
              fs.push({
                code:x._data.code+"."+y.code,
                inputFormat:y.inputFormat,
                name:BZ._groupWords([_aiGeneratorDataHandler._getCurModuleDataName(x),y.data]),
                data:y.data
              })
            })
          }
        }
      })
      return fs
    }
    
    function _getPeriodOprSettingDetailsViewDev(){
      return [
        //opr name
        {
          _tag:"select",
          _attr:{
            "class":"form-control",
            style:"flex:3"
          },
          _dataModel:"_data._item.test",
          _items:[
            {
              _tag:"option"
            },
            {
              _tag:"option",
              _attr:{
                value:"_data._item._code"
              },
              _text:"_data._item._name",
              _dataRepeat:function(d){
                let vs=[]
                
                _curModule.definition.operations.forEach(x=>{
                  if(x.type=="edit"){
                    vs.push(x)
                  }
                })
                vs= vs.map(y=>{
                  return {
                    _code:_curModule.code+"."+y.testCode,
                    _name:y.name
                  }
                })
                _insertRelationModuleOprs(_curModule,vs)
                return vs
              }
            }
          ]
        },
        //auth
        {
          _tag:"select",
          _attr:{
            "class":"form-control",
            style:"flex:1"
          },
          _dataModel:"_data._item.role",
          _items:[
            {
              _tag:"option",
              _text:"*",
              _attr:{
                value:"_data._key"
              },
              _text:"_data._item",
              _dataRepeat:_bzMessage._aiDefinition._authOptions
            },
            {
              _tag:"option",
              _text:"_data._item",
              _attr:{
                value:"_data._item"
              },
              _dataRepeat:function(){
                return _aiAuthHandler._getRolesByHostId(_curModule.defaultHostId)
              }
            }
          ]
        },
        //delete button
        {
          _tag:"button",
          _attr:{
            style:"margin:5px;",
            "class":"btn btn-icon bz-small-btn bz-delete"
          },
          _jqext:{
            click:function(){
              let os=_getCurPeriodOprList()
              os.splice(this._data._idx,1)
              _Util._resizeModelWindow()
              _ideModuleManagement._save()
            }
          }
        }
      ]      
    }
    function _getOprSettingDetailsViewDev(){
      return [
        //opr name
        {
          _tag:"select",
          _attr:{
            "class":"form-control",
            style:"flex:1"
          },
          _dataModel:"_data._item.test",
          _items:[
            {
              _tag:"option"
            },
            {
              _tag:"option",
              _attr:{
                value:"_data._item._code"
              },
              _text:"_data._item._name",
              _dataRepeat:function(d){
                let vs=[],_type,
                    s=_statusManagement._getDataStatusByKey(_uiSwitch._curStatusFlow,_curModule)
                if(_uiSwitch._curFromFlow=="start"){
                  _type="add"
                }else if(s.opr=="delete"){
                  _type="delete"
                }else{
                  _type="edit"
                }
                let os=_getCurOprList()
                
                _curModule.definition.operations.forEach(x=>{
                  if(x.type==_type){
                    if(!os.find(y=>{return y.test==_curModule.code+"."+x.testCode&&d._item.test!=y.test})){
                      vs.push(x)
                    }
                  }
                })
                vs= vs.map(y=>{
                  return {
                    _code:_curModule.code+"."+y.testCode,
                    _name:y.name
                  }
                })
                
                _insertRelationModuleOprs(_curModule,vs)
                
                return vs
              }
            }
          ],
          _jqext:{
            change:function(){
              let d=this._data._item
              if(!d.varName){
                let v=this.value||""
                v=v.split(".")[0]
                if(v){
                  d.varName=_aiGeneratorDataHandler._getCurModuleDataName(v)
                }
              }
            }
          }
        },
        //data Setting
        {
          _tag:"a",
          _attr:{
            "class":"'bz-flow-set-ex-data'+(_Util._isEmpty(_data._item.data)?'':' bz-with-value')",
            disabled:"!_data._item.test"
          },
          _text:"_bzMessage._aiDefinition._oprParameter",
          _jqext:{
            click:function(){
              let d=this._data._item
              let t=_ideObjHandler._getDataByPath(d.test)
              _doDataMap(_CtrlDriver._buildProxy({
                _fields:_getModuleAndSubModuleFields(t._parent._data),
                _title:_bzMessage._aiDefinition._oprParameterSetting,
                _data:d
              }))
            }
          }
        },
        //delete button
        {
          _tag:"button",
          _attr:{
            style:"margin:5px;",
            "class":"btn btn-icon bz-small-btn bz-delete"
          },
          _jqext:{
            click:function(){
              let os=_getCurOprList()
              os.splice(this._data._idx,1)
              _Util._resizeModelWindow()
              _handleFields(function(){
                _saveData()
              })
            }
          }
        }
      ]      
    }
    
    function _insertRelationModuleOprs(m,vs){
      m.definition.relatedModules.forEach(r=>{
        if(r.module){
          r=_aiGeneratorDataHandler._getModuleObject(r.module)||{}
          r=r._data
          if(r&&r.bt=="data"){
            
            r.definition.operations.forEach(x=>{
              vs.push({
                _code:r.code+"."+x.testCode,
                _name:BZ._groupWords([r.name,x.name])
              })
            })
          }
        }
      })
    }

    function _getListViewDev(_setting){
      return {
        _tag:"div",
        _items:[
          _setting._header||{_tag:"div",_attr:{style:"display:none;"}},
          {
            _tag:"div",
            _attr:{
              class:"bz-hover"
            },
            _dragOrder:_setting._dragOrder&&{
              _getListData:function(){
                return _setting._listFun()
              },
              _after:function(){
                _ideModuleManagement._save()
              }
            },
            _items:[
              {
                _if:function(d){
                  return !_setting._descFun||BZ._data._uiSwitch._curSelectedFlowSettingItem==d._item
                },
                _tag:"div",
                _attr:{
                  style:"display:flex;width:100%;"
                },
                _items:_setting._details
              },
              //description
              {
                _if:function(d){
                  if(_setting._descFun&&BZ._data._uiSwitch._curSelectedFlowSettingItem!=d._item){
                    if(!_setting._keyField||d._item[_setting._keyField]){
                      return 1
                    }
                    if(_setting._dataListFun){
                      _setting._dataListFun().splice(d._idx,1)
                    }else{
                      _setting._listFun().splice(d._idx,1)
                    }
                  }
                },
                _tag:"div",
                _attr:{
                  "class":"bz-nowrap bz-item-desc",
                  onmousedown:"BZ._data._uiSwitch._curSelectedFlowSettingItem=this._data._item"
                },
                _items:[
                  {
                    _if:function(){
                      return _setting._showIdx
                    },
                    _tag:"span",
                    _text:"_data._idx+1+'. '"
                  },
                  {
                    _text:"["
                  },
                  {
                    _tag:"a",
                    _text:function(d){
                      let t=d._item.test||d._item.code||d._item.refOfSuccess||""
                      if(!t.match(_IDE._testKeyRegex)){
                        t=_aiGenerator._getTestByType(t,"has")
                      }
                      return t
                    },
                    _jqext:{
                      mousedown:function(e){
                        let v=this.innerText.replace(/[\[\]]/g,"")
                        let t=_ideObjHandler._getDataByPath(v)
                        _guiModuleHandler._openDetails({
                          k:v,
                          t:t._data
                        })
                        e.stopPropagation()
                      }
                    }
                  },
                  {
                    _text:function(d){
                      return "] "+_setting._descFun(d._item,d._idx,_setting._group)
                    }
                  }
                ]
              }
            ],
            _dataRepeat:function(){
              let vs=_setting._listFun()
              return vs
            }
          }
        ],
        _jqext:{
          mousedown:function(e){
            e.stopPropagation()
          }
        }
      }
    }
    
    function _getAddBtnViewDev(_setting){
      return {
        _if:function(){
          return !_setting._keyField||!_setting._listFun().find(x=>{
            return !x[_setting._keyField]
          })
        },
        _tag:"button",
        _after:function(){
          _Util._resizeModelWindow()
        },
        _attr:{
          class:_setting._class||"btn btn-primary btn-icon-text bz-small-btn bz-plus pull-left",
          style:_setting._style||"margin:10px"
        },
        _text:function(){
          return _setting._title
        },
        _jqext:{
          click:_setting._click||function(){
            let os=_setting._listFun()
            let d=_Util._clone(_setting._newItem)
            if(d.forDelete&&_statusManagement._getDataStatusByKey(_uiSwitch._curStatusFlow).opr!="delete"){
              delete d.forDelete
            }
            os.push(d)
            BZ._data._uiSwitch._curSelectedFlowSettingItem=os[os.length-1]
            _Util._resizeModelWindow()
          }
        }
      }
      
    }
    
    function _doDataMap(_setting){
      let bk=_Util._clone(_setting._data)
      _Util._confirmMessage({
        _tag:"div",
        _data:_setting,
        _items:[
          {
            _tag:"div",
            _items:[
              //variable name
              {
                _tag:"div",
                _attr:{
                  class:"input-group"
                },
                _items:[
                  {
                    _tag:"label",
                    _attr:{
                      class:"input-group-addon required"
                    },
                    _text:function(d){
                      if(d._data.test){
                        return _bzMessage._aiDefinition._oprObjName
                      }else{
                        return _bzMessage._aiDefinition._assignVariableTo
                      }
                    }
                  },
                  {
                    _tag:"input",
                    _attr:{
                      class:"form-control",
                      required:1
                    },
                    _dataModel:"_data._data.varName"
                  }
                ]
              },
              //header
              {
                _tag:"div",
                _attr:{
                  style:"display:flex;line-height:30px;border-bottom:var(--bz-border);margin-bottom:10px;"
                },
                _items:[
                  {
                    _tag:"div",
                    _attr:{
                      style:"flex:1;font-weight:bold;padding-left:10px"
                    },
                    _text:"_bzMessage._model._field._title"
                  },
                  {
                    _tag:"div",
                    _attr:{
                      style:"flex:1;font-weight:bold;padding-left:10px"
                    },
                    _text:"_bzMessage._aiDefinition._colName"
                  },
                  {
                    _tag:"div",
                    _attr:{
                      style:"flex:1;font-weight:bold;padding-left:10px"
                    },
                    _text:"_bzMessage._common._value"
                  },
                  {
                    _tag:"div",
                    _attr:{
                      style:"width:20px"
                    }
                  }
                ]
              },
              //items
              {
                _tag:"div",
                _attr:{
                  style:function(d){
                    let m=(_setting._data.code||_setting._data.test).split(".")[0]
                    let c="margin-top:1px;display:",_display="flex"
                    if(d._item.field=="$status"){
                      if(_statusManagement._isSimpleStatusModule(m)){
                        _display="none"
                      }
                    }
                    return c+_display
                  }
                },
                _items:[
                  {
                    _if:"['$status'].includes(_data._item.field)",
                    _tag:"input",
                    _attr:{
                      class:"form-control",
                      style:"flex:1;height:25px;",
                      readonly:1,
                      value:"_data._item.field"
                    }
                  },
                  {
                    _if:"!['$status'].includes(_data._item.field)",
                    _tag:"select",
                    _attr:{
                      "class":"form-control",
                      style:"flex:1;"
                    },
                    _dataModel:"_data._item.field",
                    _items:[
                      {
                        _tag:"option",
                        _attr:{
                          value:"_data._item.code"
                        },
                        _text:"_data._item.name",
                        _dataRepeat:function(){
                          return _setting._fields
                        }
                      }
                    ],
                    _jqext:{
                      change:function(){
                        let v=this.value
                        v=_setting._fields.find(x=>{
                          return x.code==v
                        })
                        this._data._item.value=$util.generateWordsByRegex(v.inputFormat,v.name)
                        let o=this.nextSibling
                        o.value=v.data
                        _updateScenarioColName(o)
                      }
                    }
                  },
                  //Column name
                  {
                    _tag:"input",
                    _attr:{
                      "class":"form-control",
                      style:"flex:1;height:25px;",
                      required:1
                    },
                    _dataModel:"_data._item.colName",
                    _jqext:{
                      focus:function(){
                        this._oldValue=this.value
                      },
                      change:function(){
                        _updateScenarioColName(this,1)
                      }
                    }
                  },
                  //Value
                  {
                    _if:"!['$status'].includes(_data._item.field)",
                    _tag:"input",
                    _attr:{
                      "class":"form-control",
                      style:"flex:1;height:25px;",
                      required:1
                    },
                    _dataModel:"_data._item.value"
                  },
                  //Status Value
                  {
                    _if:"_data._item.field=='$status'",
                    _tag:"select",
                    _attr:{
                      "class":"form-control",
                      style:"flex:1"
                    },
                    _dataModel:"_data._item.value",
                    _items:function(d){
                      return _statusManagement._getUIOptions(_setting._data.code,"name")
                    }
                  },
                  //delete button
                  {
                    _tag:"button",
                    _attr:{
                      "class":"btn btn-icon bz-delete bz-small-btn",
                      style:"margin:5px"
                    },
                    _jqext:{
                      click:function(){
                        _setting._data.data.splice(this._data._idx,1)
                        _Util._resizeModelWindow()
                      }
                    }
                  }
                ],
                _dataRepeat:function(){
                  return _setting._data.data
                }
              }
            ]
          },
          //add button
          {
            _if:function(){
              return !_setting._data.data.find(x=>{
                return !x.field
              })
            },
            _tag:"a",
            _after:function(){
              _Util._resizeModelWindow()
            },
            _attr:{
              style:"padding:5px; float:left"
            },
            _items:[
              {
                _tag:"button",
                _attr:{
                  class:"btn btn-icon bz-small-btn bz-plus"
                }
              },
              {
                _text:"_bzMessage._method._add",
              }
            ],
            _jqext:{
              click:function(){
                _setting._data.data.push({})
                _Util._resizeModelWindow()
              }
            }
          },
          //Create field
          {
            _if:function(){
              return !_setting._data.data.find(x=>{
                return !x.field
              })
            },
            _tag:"a",
            _after:function(){
              _Util._resizeModelWindow()
            },
            _attr:{
              style:"padding:5px; float:left"
            },
            _items:[
              {
                _tag:"button",
                _attr:{
                  class:"btn btn-icon bz-small-btn bz-plus"
                }
              },
              {
                _text:"_bzMessage._method._createField",
              }
            ],
            _jqext:{
              click:function(){
                _aiModelHandler._createBaseField(_setting.code,function(d){
                  _setting._fields.push(d)
                })
              }
            }
          }
        ]
      },[{
        _title:_bzMessage._method._done,
        _click:function(c){
          if(_setting._data.data.find(x=>!x.field)){
            return alert(_bzMessage._system._error._requiredField,_bzMessage._model._field._title)
          }
          _handleFields(function(){
            _saveData()
          })
          c._ctrl._close()
        }
      }],_setting._title,0,0,function(c){
        _setting._data.data=bk.data
        _setting._data.varName=bk.varName
      })
    }

    function _doFieldMap(_setting){
      let bk=_Util._clone(_setting._data)
      BZ._data._uiSwitch._curScenarioTab="_data"
      BZ._data._uiSwitch._curSetting=_setting
      _setting=BZ._data._uiSwitch._curSetting
      _Util._confirmMessage({
        _tag:"div",
        _update:function(){},
        _data:_setting,
        _items:[
          {
            _tag:"div",
            _attr:{
              class:"bz-h-h-tabs bz-std-tabs",
              style:"margin-top:10px;"
            },
            _items:[
              //tabs
              {
                _tag:"div",
                _attr:{
                  class:"bz-h-h-tab-items"
                },
                _items:[
                  {
                    _tag:"div",
                    _attr:{
                      class:function(t){
                        var c="bz-h-h-tab-item"

                        if(t._item==BZ._data._uiSwitch._curScenarioTab){
                          c+=" white-active"
                        }

                        return c
                      },
                      onclick:"BZ._data._uiSwitch._curScenarioTab=this._data._item;_Util._resizeModelWindow();"
                    },
                    _text:"_bzMessage._setting._objectLib[_data._item]",
                    _dataRepeat:["_data","_preScript","_endScript"]
                  }
                ]
              },
              {
                _if:"BZ._data._uiSwitch._curScenarioTab=='_data'",
                _tag:"div",
                _attr:{
                  class:"bz-h-h-tab-content",
                  style:"padding:10px;width:calc(100% - 22px);"
                },
                _items:[
                  {
                    _tag:"div",
                    _items:[
                      //variable name
                      {
                        _tag:"div",
                        _attr:{
                          class:"input-group"
                        },
                        _items:[
                          {
                            _tag:"label",
                            _attr:{
                              class:"input-group-addon"
                            },
                            _text:function(d){
                              if(d._data.test){
                                return _bzMessage._aiDefinition._oprObjName
                              }else{
                                return _bzMessage._aiDefinition._assignVariableTo
                              }
                            }
                          },
                          {
                            _tag:"input",
                            _attr:{
                              class:"form-control",
                              readonly:"!BZ._isCheckout()"
                            },
                            _dataModel:"_data._data.varName"
                          },
                          {
                            _if:function(){
                              return _setting._type=="_then"
                            },
                            _tag:"label",
                            _attr:{
                              class:"input-group-addon"
                            },
                            _items:[
                              {
                                _tag:"input",
                                _attr:{
                                  type:"checkbox"
                                },
                                _dataModel:"_data._data.forDelete"
                              },
                              {
                                _text:"_bzMessage._aiDefinition._forDelete"
                              }
                            ]
                          }
                        ]
                      },
                      {
                        _if:function(){
                          let v= _setting._data.data
                          if(v&&_setting._data.code){
                            let m=_setting._data.code.split(".")[0]
                            if((_statusManagement._isSimpleStatusModule(m)||_getCurScenario().curGiven==_setting._data)&&Object.keys(v).length==2){
                              return
                            }
                            return 1
                          }
                        },
                        _tag:"fieldset",
                        _attr:{
                          class:"bz-flow-scenario-block",
                          style:"padding:5px 0;"
                        },
                        _items:[
                          {
                            _tag:"legend",
                            _text:"_bzMessage._aiDefinition._businessData"
                          },
                          //header
                          {
                            _tag:"div",
                            _attr:{
                              style:"display:flex;line-height:30px;border-bottom:var(--bz-border);margin-bottom:10px;"
                            },
                            _items:[
                              {
                                _tag:"div",
                                _attr:{
                                  style:"flex:1;font-weight:bold;padding-left:10px"
                                },
                                _text:"_bzMessage._model._field._title"
                              },
                              {
                                _tag:"div",
                                _attr:{
                                  style:"flex:1;font-weight:bold;padding-left:10px"
                                },
                                _text:"_bzMessage._aiDefinition._colName"
                              },
                              {
                                _tag:"div",
                                _attr:{
                                  style:"flex:1;font-weight:bold;padding-left:10px"
                                },
                                _text:"_bzMessage._common._value"
                              },
                              {
                                _tag:"div",
                                _attr:{
                                  style:"width:20px"
                                }
                              }
                            ]
                          },
                          //items
                          {
                            _tag:"div",
                            _attr:{
                              style:function(d){
                                let m=(_setting._data.code||_setting._data.test).split(".")[0]
                                let c="margin-top:1px;display:",_display="flex"
                                if(d._item.field=="$status"){
                                  if(_statusManagement._isSimpleStatusModule(m)||_getCurScenario().curGiven==_setting._data){
                                    _display="none"
                                  }
                                }
                                return c+_display
                              }
                            },
                            _items:[
                              //Field 
                              {
                                _tag:"input",
                                _attr:{
                                  class:"form-control",
                                  style:"flex:1;height:25px;",
                                  readonly:1,
                                  value:function(d){
                                    d=d._item.field
                                    let f=_setting._fields.find(x=>{
                                      return x.code==d
                                    })
                                    return (f&&f.name)||d
                                  }
                                }
                              },
                              //Column name
                              {
                                _tag:"input",
                                _attr:{
                                  "class":"form-control",
                                  style:"flex:1;height:25px;",
                                  readonly:1,
                                  value:"_data._item.colName"
                                }
                              },
                              //Value
                              {
                                _tag:"input",
                                _attr:{
                                  "class":"form-control",
                                  style:"flex:1;height:25px;",
                                  readonly:1,
                                  value:"_data._item.value"
                                },
                              },
                            ],
                            _dataRepeat:function(){
                              return _setting._data.data
                            }
                          }
                        ]
                      },
                      {
                        _tag:"fieldset",
                        _attr:{
                          class:"bz-flow-scenario-block",
                          style:"padding:5px 0;"
                        },
                        _items:[
                          {
                            _tag:"legend",
                            _text:"_bzMessage._aiDefinition._exColumns"
                          },
                          //header
                          {
                            _tag:"div",
                            _attr:{
                              style:"display:flex;line-height:30px;border-bottom:var(--bz-border);margin-bottom:10px;"
                            },
                            _items:[
                              {
                                _tag:"div",
                                _attr:{
                                  style:"flex:1;font-weight:bold;padding-left:10px"
                                },
                                _text:"_bzMessage._model._field._title"
                              },
                              {
                                _tag:"div",
                                _attr:{
                                  style:"flex:1;font-weight:bold;padding-left:10px"
                                },
                                _text:"_bzMessage._aiDefinition._colName"
                              },
                              {
                                _tag:"div",
                                _attr:{
                                  style:"width:20px"
                                }
                              }
                            ]
                          },
                          //items
                          {
                            _tag:"div",
                            _attr:{
                              style:"display:flex;margin-top:1px;"
                            },
                            _items:[
                              {
                                _tag:"select",
                                _attr:{
                                  "class":"form-control",
                                  style:"flex:1;"
                                },
                                _dataModel:"_data._item.field",
                                _items:[
                                  {
                                    _tag:"option",
                                    _attr:{
                                      value:"_data._item.code"
                                    },
                                    _text:"_data._item.name",
                                    _dataRepeat:function(){
                                      let fs=[]
                                      _setting._fields.forEach(f=>{
                                        if(!_setting._data.data||!_setting._data.data.find(x=>{
                                          return x.field==f.code
                                        })){
                                          fs.push(f)
                                        }
                                      })
                                      
                                      return fs
                                    }
                                  }
                                ],
                                _jqext:{
                                  change:function(){
                                    let v=this.value
                                    v=_setting._fields.find(x=>{
                                      return x.code==v
                                    })
                                    this._data._item.value=$util.generateWordsByRegex(v.inputFormat,v.name)
                                    let o=this.nextSibling
                                    o.value=v.data
                                    _updateScenarioColName(o)
                                  }
                                }
                              },
                              //Column name
                              {
                                _tag:"input",
                                _attr:{
                                  "class":"form-control",
                                  style:"flex:1;height:25px;",
                                  required:1
                                },
                                _dataModel:"_data._item.colName",
                                _jqext:{
                                  focus:function(){
                                    this._oldValue=this.value
                                  },
                                  change:function(){
                                    _updateScenarioColName(this,1)
                                  }
                                }
                              },
                              //delete button
                              {
                                _tag:"button",
                                _attr:{
                                  "class":"btn btn-icon bz-delete bz-small-btn",
                                  style:"margin:5px"
                                },
                                _jqext:{
                                  click:function(){
                                    _setting._data.scenarioFields.splice(this._data._idx,1)
                                    _Util._resizeModelWindow()
                                  }
                                }
                              }
                            ],
                            _dataRepeat:function(){
                              return _setting._data.scenarioFields
                            }
                          }
                        ]
                      }
                    ]
                  },
                  {
                    _if:function(){
                      return !_setting._data.scenarioFields.find(x=>{
                        return !x.field
                      })
                    },
                    _tag:"a",
                    _after:function(){
                      _Util._resizeModelWindow()
                    },
                    _attr:{
                      style:"padding:5px; float:left"
                    },
                    _items:[
                      {
                        _tag:"button",
                        _attr:{
                          class:"btn btn-icon bz-small-btn bz-plus"
                        }
                      },
                      {
                        _text:"_bzMessage._method._add",
                      }
                    ],
                    _jqext:{
                      click:function(){
                        _setting._data.scenarioFields.push({})
                        _Util._resizeModelWindow()
                      }
                    }
                  }
                ]
              },
              {
                _if:"BZ._data._uiSwitch._curScenarioTab=='_preScript'",
                _tag:"div",
                _attr:{
                  class:"bz-h-h-tab-content",
                  style:"min-height:230px"
                },
                _items:[
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curSetting._data.preScript",0,1)
                ]
              },
              {
                _if:"BZ._data._uiSwitch._curScenarioTab=='_endScript'",
                _tag:"div",
                _attr:{
                  class:"bz-h-h-tab-content",
                  style:"min-height:230px"
                },
                _items:[
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curSetting._data.endScript",0,1)
                ]
              }
            ]
          }
        ]
      },[{
        _title:_bzMessage._method._done,
        _click:function(c){
          if(_setting._data.scenarioFields.find(x=>!x.field)){
            return alert(_bzMessage._system._error._requiredField,_bzMessage._model._field._title)
          }
          _handleFields(function(){
            _saveData()
          })
          c._ctrl._close()
        }
      }],_setting._title,0,0,function(c){
        _setting._data.scenarioFields=bk.scenarioFields
        _setting._data.varName=bk.varName
      })
    }
    
    function _getCurFlow(){
      return _uiSwitch._curFromFlow&&_flow[_uiSwitch._curFromFlow].to[_uiSwitch._curStatusFlow][_uiSwitch._curSolutionIdx].data||{}
    }
    
    function _getCurPeriodOprList(){
      let s=_statusManagement._getDataStatusByKey(_uiSwitch._curStatusFlow)
      s.oprs=s.oprs||[]
      return s.oprs
    }
    
    function _getCurOprList(){
      let d=_getCurFlow()
      d.oprs=d.oprs||[]
      _setStepKey(d.oprs,"when")

      return d.oprs
    }
    
    function _getCurScenario(){
      let d=_getCurFlow()
      d.scenario=d.scenario||{}
      return d.scenario
    }
    
    function _getCurScenarioFields(){
      let d=_getCurScenario()
      d.fields=d.fields||[]
      return d.fields
    }

    function _getCurDependences(){
      let d=_getCurFlow()
      d.dependencies=d.dependencies||[]
      return _getCurFlow().dependencies
    }
    
    function _saveData(){
      let v=_uiSwitch._curSelectedFlowSettingItem
      _uiSwitch._curSelectedFlowSettingItem=0
      _ideModuleManagement._save(0,()=>{
        _uiSwitch._curSelectedFlowSettingItem=v
      })
    }
  },
  //f:from, t:to, d:flow data, m: module, _fun: callback Function
  _generateScenarioTest:function(f,t,k,m,_fun){
    _ideTestManagement._save({
      name:_aiFlowHandler._getFlowScenarioName(t,f)+(k&&k!="default"?" ("+k+")":""),
      enterPoint:{type:"follow"},
      type:"scenario",
      tag:_statusManagement._getDataStatusByKey(t).name,
      hostId:m.defaultHostId,
      definition:{code:f+"."+t+"."+k}
    },m,function(x){
      _fun&&_fun(x)
    })
  },
  _addItem:function(f){
    let _curModule=_IDE._data._curModule._data
    let ff=_curModule.definition.moduleDataFlow[f.k]
    _Util._confirmMessage({
      _tag:"div",
      _items:[
        //current status
        {
          _tag:"div",
          _attr:{
            "class":"input-group"
          },
          _items:[
            //label
            {
              _tag:"label",
              _attr:{
                "class":"input-group-addon required"
              },
              _text:"_bzMessage._common._status"
            },
            {
              _tag:"select",
              _attr:{
                "class":"form-control",
                required:1,
              },
              _dataModel:"BZ._data._uiSwitch._newFlowStatus",
              _items:function(){
                let vs=Object.keys(ff.to)
                vs.push(f.k+"")
                return _statusManagement._getUIOptions(0,"id",vs)
              }
            },
            {
              _tag:"div",
              _attr:{
                "class":"input-group-btn"
              },
              _items:[
                {
                  _tag:"button",
                  _attr:{
                    class:"btn btn-icon bz-plus bz-small-btn",
                    title:"_bzMessage._method._addStatus"
                  },
                  _jqext:{
                    click:function(){
                      _statusManagement._popModuleDataStatusForm(0,function(v){
                        BZ._data._uiSwitch._newFlowStatus=v.id
                        _Util._resizeModelWindow()
                      })
                    }
                  }
                }
              ]
            }
          ]
        }
      ]
    },[{
      _title:_bzMessage._method._save,
      _click:function(c){
        if(!ff.to){
          ff.to={}
        }
        let ns=_statusManagement._getDataStatusByKey(BZ._data._uiSwitch._newFlowStatus,_curModule)
        
        if(!ns){
          return alert(_bzMessage._system._error._requiredField,_bzMessage._common._status)
        }
        
        let d={
          roles:(_aiAuthHandler._getRolesByHostId(_curModule.defaultHostId)||[]).length?"sign-in":"*",
          oprs:[],
          dependencies:[],
          scenario:{
            enable:"on",
            data:[],
            given:[],
            when:[],
            then:[]
          }
        }
        
        if(f.k!="start"){
          d.scenario.curGiven={
            varName:_aiGeneratorDataHandler._getCurModuleDataName(),
            code:_aiGenerator._getTestByType(_curModule,"has"),
            type:"*",
            status:f.k,
            data:[{
              field:"$status",
              value:_statusManagement._getDataStatusByKey(f.k).name
            }],
            scenarioFields:[]
          }
        }else if(_curModule.parentModule){
          let pm=_ideObjHandler._getDataByPath(_curModule.parentModule)
          d.dependencies.push({
            code:_curModule.parentModule,
            data:[
              {field:"$status",colName:pm._data.name.toLowerCase()+"_"+"status",value:_statusManagement._getModuleDefStatus(pm).name}
            ],
            scenarioFields:[],
            varName: _aiGeneratorDataHandler._getCurModuleDataName(pm)
          })
        }
        _curModule.definition.operations.find(o=>{
          if((f.k=="start"&&o.type=="add")||(ns.opr=="delete"&&ns.opr==o.type)||(f.k!="start"&&ns.opr!="delete"&&o.type=="edit")){
            d.oprs.push({
              required:1,
              data:[],
              scenarioFields:[],
              test:_curModule.code+"."+o.testCode,
              varName:_aiGeneratorDataHandler._getCurModuleDataName()
            })
            return 1
          }
        })

        ff.to[ns.id]=[{data:d,key:"default"}]

        _aiFlowHandler._generateScenarioTest(f.k,ns.id,0,_curModule,function(x){
          d.scenario.code=_curModule.code+"."+x.code
          d.scenario.enable="on"
          _ideModuleManagement._save(0,function(){
            _aiFlowHandler._popItem(f.k,BZ._data._uiSwitch._newFlowStatus,1)
          })
        })
        
        c._ctrl._close()
      }
    }],_bzMessage._method._addFlow,400,0,0,1)
  },
  _drawGUI:function(_gList){
    setTimeout(()=>{
      _gList=_gList||BZ._data._uiSwitch._curFlowGUIData
      BZ._data._uiSwitch._curFlowGUIData=_gList
      _gList.forEach(x=>{
        x._fromObj=$("."+x.f+"-to-"+x.t)[0]
        x._toObj=$("."+x.t+"-from-"+x.f)[0],
        x._box=$("#b"+x.f)[0]
      })
      _ideGUIHandler._cleanCanvas()
      _ideGUIHandler._setData(_gList,1,["bz-gui-related","highlight"])
    },100)
  },
  _buildViewData:function(_flow){
    let _root={k:"start",c:0,id:"f-0",to:[]},r,_idx=1;
    let _list=[[_root]],gs=[],_max={v:1,r:0}
    
    _buildLevelGroup(_flow.start,gs,_root)
    
    while(gs.length){
      if(gs.length>_max.v){
        _max.r=_list.length
        _max.v=gs.length
      }

      _list.push(gs)
      let ns=gs,_remove=[]
      gs=[]
      ns.forEach(x=>{
        if(!_flow[x.k]){
          _remove.push(x)
          return
        }
        if(!_chkLoop(x,x.k)){
          _buildLevelGroup(_flow[x.k],gs,x)
        }
      })
      _Util._spliceAll(ns,x=>{
        return _remove.includes(x)
      })
    }

    for(let i=_max.r-1;i>=0;i--){
      r=_list[i]
      r.forEach(x=>{
        let v=0
        x.to.forEach(x=>{
          v+=x.c
        })
        if(x.to.length){
          x.c=v/x.to.length
        }
      })
      r.sort((a,b)=>{
        return a.c-b.c
      })
      let j=0,_rmin=0,_rmax;
      while(j<r.length){
        let cs=_getCloserGroup(r,j)
        if(cs.cs.length>1){
          if(r[cs.i]){
            _rmax=r[cs.i].c
          }else{
            _rmax=_max.v
          }
          _space=0
          if(_rmax-_rmin>cs.cs.length){
            _space=(_rmax-_rmin-cs.cs.length)/2
          }
          let n=0
          for(;j<cs.i;j++){
            if(r[j].c>_space+n){
              r[j].c=_space+n
              
            }
            if(j&&r[j].c<r[j-1].c+1){
              r[j].c=r[j-1].c+1
            }
            n++
          }
          _rmin=r[j-1].c+1
        }else{
          if(j&&r[j].c<r[j-1].c+1){
            r[j].c=r[j-1].c+1
          }
          _rmin=r[j++].c+1
        }
      }
    }

    for(let i=_max.r+1;i<_list.length;i++){
      r=_list[i]
      r.forEach(x=>{
        let v=0
        x.fs.forEach(x=>{
          v+=x.c
        })
        if(x.fs.length){
          x.c=v/x.fs.length
        }
      })
      r.sort((a,b)=>{
        return a.c-b.c
      })
      let j=0,_rmin=0,_rmax;
      while(j<r.length){
        let cs=_getCloserGroup(r,j)
        if(cs.cs.length>1){
          if(r[cs.i]){
            _rmax=r[cs.i].c
          }else{
            _rmax=_max.v
          }
          _space=0
          if(_rmax-_rmin>cs.cs.length){
            _space=(_rmax-_rmin-cs.cs.length)/2
          }
          let n=0
          for(;j<cs.i;j++){
            if(r[j].c>_space+n){
              r[j].c=_space+n
            }
            if(j&&r[j].c<r[j-1].c+1){
              r[j].c=r[j-1].c+1
            }
            n++
          }
          _rmin=r[j-1].c+1
        }else{
          if(j&&r[j].c<r[j-1].c+1){
            r[j].c=r[j-1].c+1
          }
          _rmin=r[j++].c+1
        }
      }
    }
    
    return _list
    function _getCloserGroup(vs,i){
      let o=vs[i],cs=[i]
      for(i=i+1;i<vs.length;i++){
        let oo=vs[i]
        if(oo.c-o.c<1){
          cs.push(i)
          o=oo
        }else{
          break
        }
      }
      return {cs:cs,i:i}
    }
    function _chkLoop(v,k){
      if(v.fs){
        return v.fs.find(f=>{
          return f.k==k||_chkLoop(f,k)
        })
      }
    }
    
    function _buildLevelGroup(vs,gs,f){
      if(vs.to){
        let ks=Object.keys(vs.to).forEach(x=>{
          let g=gs.find(y=>{
            return y.k==x
          })
          if(g){
            g.fs.push(f)
          }else{
            g={
              id:"f-"+_idx++,
              fs:[f],
              k:x,
              to:[],
              c:gs.length,
            }
            gs.push(g)
          }
          
          f.to.push(g)
        })
      }
    }
  },
  _getGUIDataList:function(_list){
    let _guiList=[],h=100,w=160
    _list.forEach((r,ri)=>{
      let _left=50
      r.forEach((x,xi)=>{
        if(x.fs){
          x.fs.forEach(f=>{
            _guiList.push({
              f:f.id,
              t:x.id,
            })
          })
        }
        x.x=_left+x.c*w
      })
    })
    return _guiList
  },
  _getFlowViewDef:function(_flow){
    return {
      _tag:"div",
      _items:[
        {
          _tag:"div",
          _items:[
            {
              _tag:"div",
              _attr:{
                id:"'b'+_data._item.id",
                "class":function(d){
                  let c='bz-flow-item'
                  d=d._item
                  
                  if(d.fs){
                    if(d.fs.find(f=>{
                      let o=_flow[f.k]
                      if(o){
                        o=o.to[d.k]
                        if(_Util._isEmpty(o)||!o.find(x=>!_Util._isEmpty(x.data.oprs)&&x.data.oprs.find(x=>x.test))){
                          return 1
                        }
                      }
                    })){
                      c+=" bz-gui-empty-test"
                    }
                  }

                  if(BZ._data._uiSwitch._curActiveFlow==d){
                    c+=" bz-gui-active"
                  }else if((BZ._data._uiSwitch._curActiveFlowPath||[]).includes(d.k)){
                    c+=" bz-gui-select-item"
                  }
                  return c
                },
                style:function(d){
                  let c="left:"+d._item.x+"px;top:"+(d._supData._idx*100+50)+"px;"
                  return c
                }
              },
              _items:[
                //from point
                {
                  _if:"_data._item.fs",
                  _tag:"div",
                  _attr:{
                    "class":"'bz-gui-from-panel'",
                    style:"left:var(--zoom-10);width:calc(100% - var(--zoom-20));top:var(--gui-from-panel-pos);"
                  },
                  _items:[
                    {
                      _tag:"div",
                      _attr:{
                        "class":"bz-gui-from-to-box"
                      },
                      _items:[
                        {
                          _tag:"button",
                          _attr:{
                            "class":function(d,cc,oo){
                              let c="btn btn-icon bz-gui-from-btn"
                              d._item.fs.forEach(f=>{
                                c+=" "+d._item.id+"-from-"+f.id
                              })
                              
                              return c
                            },
                          }
                        }
                      ]
                    }
                  ]
                },
                //to point
                {
                  _if:"_data._item.to.length",
                  _tag:"div",
                  _attr:{
                    "class":"'bz-gui-to-panel'",
                    style:"left:var(--zoom-10);width:calc(100% - var(--zoom-20));bottom:calc(var(--gui-to-panel-pos) - 8px);"
                  },
                  _items:[
                    {
                      _tag:"div",
                      _attr:{
                        "class":"bz-gui-from-to-box"
                      },
                      _items:[
                        {
                          _tag:"span",
                          _attr:{
                            "class":function(d,cc){
                              let s=BZ._data._uiSwitch,
                                  o=d._supData._item,
                                  c=""
                              d=d._item
                              c+=(o.id+"-to-"+d.id).replace(/\./g,"-")

                              o=_flow[o.k].to[d.k]
                              
                              if(_Util._isEmpty(o)&&o.find(x=>_Util._isEmpty(x.data.oprs))){
                                c+=" bz-miss-setting"
                              }else{
                                c+=" bz-unit"
                              }
                              return c
                            },
                            style:"cursor:pointer;"
                          },
                          _items:[
                            {
                              _if:function(d,c,o){
                                let i=d._supData._item.to.length
                                if(i=>10){
                                  i=i*2-9;
                                }
                                return i*8.5<_ideGUIHandler._data._item.width
                              },
                              _tag:"span",
                              _attr:{"class":"bz-gui-to-idx"}
                            },
                            {
                              _if:function(d){
                                let o=d._supData._item
                                o=_flow[o.k].to[d._item.k]
                                
                                return o.find(x=>x.data.scenario.enable)
                              },
                              _tag:"span",
                              _attr:{
                                class:"bz-gui-to-extra-btn bz-scenario"
                              }
                            },
                            {
                              _if:function(d){
                                let v=BZ._data._uiSwitch._curFlowFilterRole
                                if(v=="*"||!v||!d._item.fs){
                                  return
                                }
                                let o=d._supData._item
                                o=_flow[o.k].to[d._item.k]
                                if(v=="sign-in"){
                                  return o.find(x=>x.data.roles=="sign-in")
                                }else if(v=="sign-out"){
                                  return o.find(x=>x.data.roles=="sign-out")
                                }else if(o.find(x=>x.data.roles.includes(v))||o.find(x=>x.data.roles=="sign-in")){
                                  return 1
                                }
                              },
                              _tag:"div",
                              _attr:{
                                style:function(d){
                                  let v=-36
                                  let o=d._supData._item
                                  o=_flow[o.k].to[d._item.k]
                                  
                                  if(!o.find(x=>x.data.scenario.enable)){
                                    v=-14
                                  }
                                  return `position: relative;top:${v}px;margin-left:-1px;`
                                  
                                },
                                class:function(){
                                  let v=BZ._data._uiSwitch._curFlowFilterRole
                                  if(v=="sign-in"){
                                    v="bz-team"
                                  }else if(v=="sign-out"){
                                    v="bz-exit"
                                  }else{
                                    v="bz-role"
                                  }
                                  return `btn btn-icon bz-small-btn ${v}`
                                }
                              }
                            }
                          ],
                          _jqext:{
                            mouseover:function(){
                              if(!$(this).attr("title")){
                                let d=this._data;
                                let s=d._supData._item
                                let o=_flow[s.k].to[d._item.k]
                                let w="";
                                o.find(fd=>{
                                  fd=fd.data
                                  if(fd.oprs){
                                    w += _bzMessage._aiDefinition._operation+":\n"
                                      +"  "+(fd.oprs.map(x=>{
                                        return _aiFlowHandler._getOprSettingDesc(x)
                                      }).join("\n  ")||_bzMessage._aiDefinition._missingOprSetting)
                                  }
                                  if(fd.dependencies){
                                    w+="\n\n"+_bzMessage._aiDefinition._dependence+":\n"
                                      +"  "+(fd.dependencies.map(x=>{
                                        return _aiFlowHandler._getDepSettingDesc(x)
                                      }).join("\n  ")||_bzMessage._ref._none)
                                  }
                                  if(fd.scenario.enable&&fd.scenario.code){
                                    w+="\n\n"+_bzMessage._test._type.scenario+":\n"
                                      +"  "+_ideObjHandler._getDataByPath(fd.scenario.code)._data.name
                                  }
                                })
                                $(this).attr({title:w})
                              }
                            },
                            click:function(){
                              let d=this._data._item
                              setTimeout(()=>{
                                _aiFlowHandler._popItem(d.fs[0].k,d.k)
                              },10)
                            }
                          }
                        }
                      ],
                      _dataRepeat:"_data._item.to",
                    }
                  ]
                },
                {
                  _tag:"p",
                  _attr:{
                    "class":"bz-flow-item-txt"
                  },
                  _text:function(d){
                    return _aiFlowHandler._getDisplayName(d._item.k)
                  }
                },
                {
                  _tag:"div",
                  _attr:{
                    "class":"pull-right bz-flow-ctrl-bar"
                  },
                  _items:[
                    //plus
                    {
                      _if:function(d){
                        d=_statusManagement._getDataStatusByKey(d._item.k)
                        return !d||d.opr!="delete"
                      },
                      _tag:"button",
                      _attr:{
                        "class":"btn btn-icon bz-small-btn bz-plus",
                        title:"_bzMessage._method._addFlow"
                      },
                      _jqext:{
                        click:function(){
                          _aiFlowHandler._addItem(this._data._item)
                        }
                      }
                    },
                    //edit
                    {
                      _if:"_data._item.fs",
                      _tag:"button",
                      _attr:{
                        "class":"btn btn-icon bz-small-btn bz-edit",
                        title:"_bzMessage._method._editFlow"
                      },
                      _jqext:{
                        click:function(){
                          let d=this._data._item
                          _aiFlowHandler._popItem(d.fs[0].k,d.k)
                        }
                      }
                    },
                    //delete
                    {
                      _if:"_data._item.fs",
                      _tag:"button",
                      _attr:{
                        "class":"btn btn-icon bz-small-btn bz-delete",
                        title:"_bzMessage._method._deleteFlow"
                      },
                      _jqext:{
                        click:function(){
                          _aiFlowHandler._deleteItem(this._data._item)
                        }
                      }
                    }
                  ]
                }
              ],
              _jqext:{
                click:function(){
                  let fs=this._data._item.fs
                  let _uiSwitch=BZ._data._uiSwitch
                  _uiSwitch._curActiveFlow=this._data._item

                  _uiSwitch._curStatusFlow=_uiSwitch._curActiveFlow.k
                  _uiSwitch._curFromFlow=fs&&fs[0]&&fs[0].k

                  _uiSwitch._curActiveFlowPath=_aiFlowHandler._collectFullStatusPath(BZ._data._uiSwitch._curActiveFlow)
                  
                }
              },
              _dataRepeat:"_data._item"
            }
          ],
          _dataRepeat:function(){
            let _list=_aiFlowHandler._buildViewData(_flow)
            
            
            let _gList=_aiFlowHandler._getGUIDataList(_list)
            _aiFlowHandler._drawGUI(_gList)
            return _CtrlDriver._buildProxy(_list)
          }
        }
      ]
    }
  }
};/*
* Test case type:
* System control: suite, clean, static, tmp, fieldChecker
* Standard Operations: add, edit, delete, execute
* Auth: signIn, signOut
*/
var _aiGenerator={
  _generateAITest:function(t,m,_fun){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    if(!m._loaded){
      return _ideModuleManagement._loadItem(m,function(){
        _aiGenerator._generateAITest(t,m,_fun)
      })
    }
    if(!_aiDataHandler._dataReady){
      return setTimeout(function(){
        _aiGenerator._generateAITest(t,m,_fun)
      },100)
    }
    if(!t._data){
      t=_ideObjHandler._getDataByPath(m,t)
    }
    if(!t._data.definition){
      return _fun&&_fun()
    }
    if(m._data.bt=="summary"){
      _aiGenerator._generateSummary(t)
    }else{
      _aiGenerator._generateAIActions(t,m)
    }
    _aiGenerator._mergeToActions(t)
    if(_fun){
      _fun()
    }
  },
  _generateAITests:function(ms,_fun,mi,ti,_rebuild){
    mi=mi||0;
    ti=ti||0;
    for(let mj=mi||0;mj<ms.length;mj++){
      let m=ms[mj];
      for(let tj=ti||0;tj<m._data.tests.length;tj++){
        let t=m._data.tests[tj]
        t=_ideObjHandler._getDataByPath(m._data.code,t.code)
        if((_rebuild||!t._data.actions.length)&&_aiGeneratorDataHandler._isAIGenerateTest(t)){
          return setTimeout(()=>{
            _aiGenerator._generateAITest(t,m,function(){
              _aiGenerator._generateAITests(ms,_fun,mj,tj+1,_rebuild)
            })
          },1)
        }
      }
      ti=0
    }
    _fun&&_fun(ms)
  },
  _setStdActionSetting:function(as){
    as.forEach(a=>{
      a.failedReaction=a.failedReaction||0
    })
  },
  //t:test object, m: module
  _generateAIActions:function(t,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    if(!t._data){
      t=_ideObjHandler._getDataByPath(m,t)
    }
    if(BZ._isPlaying()&&!_Util._isEmpty(t._data.actions)){
      return
    }
    if(t._generateTime&&Date.now()-t._generateTime<2000){
      return
    }
    var as=[]
    let td=t._data.definition;
    //test panel model
    
    if(t._data.type=="api"){
      _aiGenerator._buildAPI(t)
    }else if(t._data.type=="scenario"){
      _aiGenerator._buildScenario(t,m)
    }else if(td.type=="has"){
      _aiGenerator._generateHas(t,m)
    }else if(td.type=="suite"){
      _aiGenerator._generateSuite(m,as)
      t._actions=as
    }else if(td.type=="static"){
      _aiGenerator._generateStaticActions(m,t)
    }else if(t._data.definition.type=="clean"){
      t._actions=[]
    }else if(t._data.definition.type=="testVE"){
      _aiGenerator._generateValidateExist(m,t)
    }else{
      let tpm=_aiModelHandler._getModelByCode(td.lanuchPanel,m._data.definition.models)
      let tpd=_aiGeneratorDataHandler._getContentByCode(td.lanuchPanel,m),_refresh
      
      as=as.concat(_aiStepHandler._getAllSolutionsToElement(td,m))||[];
      if(as){
        if(as[0].constructor==Array){
          as=as[0]
        }
      }
      if(as.length){
        if(m._data.definition.startPanel!="url"||t._data.definition.type=="delete"){
          if(as[0]._quickUrl){
            _refresh=as.shift()
            t._enterPoint={type:"follow"}
          }else{
            //set enterPoint and actions
            if(as[0].type=="followSameURL"){
              t._enterPoint=as.shift()
            }else{
              t._enterPoint=t._enterPoint||{type:"follow"}
            }
          }
          as.unshift({})
        }else{
          if(as[0]._quickUrl){
            _refresh=as.shift()
            t._enterPoint={type:"follow"}
          }else{
            t._enterPoint={type:"followSameURL",value:m._data.rootUrl}
            as.find((x,i)=>{
              if(x.code==td.code){
                as.splice(0,i)
                return 1
              }
            })
          }
        }
        as=_aiStepHandler._parseToActions(as,m)
      }

      t._actions=as

      let _defParameter={}
      //script for handle parameter as a String

  //** handle parameter at start **********************************************//
      _aiGenerator._fillPanel(tpd,tpm,m,as,_defParameter,td.type)

      if(_Util._isEmpty(_defParameter)){
        t._data.defParameter=""
      }else{
        t._data.defParameter=JSON.stringify(_defParameter,0,2)
      }

      if(_refresh){
        _aiGenerator._insertRefreshUrlElement(_refresh,as,m,t)
      }

      //insert handle data action
      _aiActionHandler._insertHandleParameterAction(td,t._parent,as);
  //---------------------------------------------------------------------------//
    }
    _doFinal(t)
    function _doFinal(t){
      //fill standard action setting
      _aiGenerator._setStdActionSetting(t._actions)
      
      t._data.enterPoint=t._enterPoint||t._data.enterPoint
      
      _aiGenerator._mergeToActions(t)
    }
  },
  _mergeToActions:function(t){
    t._aiInit=1
    let _curAction=_IDE._data._curAction,_curActionIdx
    if(_curAction){
      _curActionIdx=t._data.actions.indexOf(_curAction)
    }
    t._generateTime=Date.now()

    t._data.actions=t._actions;

    if(_curAction&&_curActionIdx>=0){
      _IDE._data._curAction=t._data.actions[_curActionIdx]
      _testTabHandler._data._curTab="config"
      BZ._data._uiSwitch._selectedItems=[_IDE._data._curAction]
    }
  },
  _generateStaticActions:function(m,t){
    var as=[]
    m=_aiGeneratorDataHandler._getModuleObject(m)
    m._data.definition.webpages.forEach(p=>{
      var es=_aiStepHandler._getAllSolutionsToElement(p,m)[0]
      var e=es.shift()
      _aiActionHandler._generateLoadPageAction(e,as)
      es=_aiStepHandler._parseToActions(es,m)
      es.forEach(e=>{as.push(e)})
      es[es.length-1].refOfError="./f/"
    })
    t._actions=as
  },
  _generateSummary:function(t){
    let as=[]
    _IDE._data._curVersion.modules.forEach(m=>{
      if(m.bt=="data"&&!m.parentModule){
        m.tests.forEach(tt=>{
          if(tt.type=="int"){
            let k=m.code+"."+tt.code
            as.push({
              type:4,
              refOfSuccess:k,
              ai:"call:"+m.code
            })
          }
        })
      }
    })
    t._actions=as
  },
  _generateSuite:function(m,as){
    let _testMap={},_delete=[],k,_clean;
    m._data.tests.forEach(t=>{
      if(!t.definition){
        return
      }
      if(t.type=="scenario"){
        k=m._data.code+"."+t.code
        let d={
          type:4,
          refOfSuccess:k+"/",
          ai:"call:"+k
        }
        if(t.type=="add"){
          as.unshift(d)
        }else{
          as.push(d)
        }
      }
    })
    
    m._data.definition.relatedModules.forEach(mv=>{
      if(mv.type=="modulesub"){
        mv=_ideObjHandler._getDataByPath(mv.module)
        if(mv){
          mv=mv._data
          mv.tests.forEach(t=>{
            if(t.type=="int"){
              let k=mv.code+"."+t.code
              as.push({
                type:4,
                refOfSuccess:k,
                ai:"call:"+mv.code
              })
            }
          })
        }
      }
    })
  },
  _getTestFields:function(m,t){
    t=t._data||t
    if(t.definition){
      if(t.type=="api"){
        let fs=[]
        if(t.definition.method=="GET"){
          fs=t.definition.query
        }else{
          fs=(t.definition.data||{}).fields||[]
        }
        fs=fs.filter(x=>x.code).map(x=>_aiGeneratorDataHandler._getFieldByCode(x.code,m))
        return fs
      }else{
        var p=t.definition&&t.definition.lanuchPanel
        
        if(!p&&t.definition.from){
          p=_aiGeneratorDataHandler._getContentByCode(t.definition.from,m)
          if(p){
            p=p.lanuchPanel
          }
          if(!p){
            return []
          }
        }
        
        if(p&&t.type=="unit"&&!["has"].includes(t.definition.type)){
          return _aiGenerator._getPanelFields(p,m)
        }
      }
    }else if(t.lanuchPanel){
      return _aiGenerator._getPanelFields(t.lanuchPanel,m)
    }
  },
  _getOutOprListInPanel:function(p,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    
    var fs=[]
    if(p.constructor!=Object){
      p=_aiModelHandler._getModelByCode(p,m._data.definition.models)
    }

    if(!p||!p.items){
      return fs
    }
    p.items.forEach(f=>{
      if(f.group=="buttons"){
        f=_aiGeneratorDataHandler._getItemByGroupAndCode("buttons",f.code,m)
        if(f&&f.type=="outopr"){
          fs.push(f)
        }else if(f.lanuchPanel){
          fs=fs.concat(_aiGenerator._getOutOprListInPanel(f.lanuchPanel,m))
        }
      }
    })
    return fs
    
    
  },
  //p: panel model,
  //m: module data, 
  //ps: parent panels
  //_curLevelOnly: select fields from the current level only
  _getPanelFields:function(p,m,ps,_curLevelOnly){
    if(!p){
      return []
    }
    m=_aiGeneratorDataHandler._getModuleObject(m)
    
    var fs=[]
    if(p.constructor!=Object){
      p=_aiModelHandler._getModelByCode(p,m._data.definition.models)
    }
    if(!p){
      return fs
    }
    var pd=_aiGeneratorDataHandler._getContentByCode(p.code,m)
    if(!p||!p.items){
      return fs
    }
    if(ps){
      ps=_Util._clone(ps)
      ps.push(_aiPageHandler._updateElementPathByDemoValue(pd.path))
    }
    p.items.forEach(f=>{
      if(f.group=="fields"){
        f=_aiGeneratorDataHandler._getItemByGroupAndCode("fields",f.code,m)
        if(ps){
          fs.push({_field:f,_panels:ps})
        }else{
          fs.push(f)
        }
      }else if(f.group=="buttons"&&!_curLevelOnly){
        f=_aiGeneratorDataHandler._getItemByGroupAndCode("buttons",f.code,m)
        if(f&&f.type!="outopr"&&f.lanuchPanel){
          let pfs=_aiGenerator._getPanelFields(f.lanuchPanel,m,ps,_curLevelOnly)
          fs=fs.concat(pfs)
        }
      }else if(f.items&&!_curLevelOnly){
        fs=fs.concat(_aiGenerator._getPanelFields(f,m,ps))
      }
    })
    return fs
  },
  //p: panel model,
  //m: module data, 
  //as: action list, 
  _fillPanel:function(pd,p,m,as,_defParameter,_type){
    if(!p){
      return
    }
    var _hasInnerPanel=0,fs=[]
    _aiGenerator._fillFields(pd,p,m,fs,_defParameter,_type);
    p.items&&p.items.forEach(pp=>{
      var ppd=_aiGeneratorDataHandler._getContentByCode(pp.code,m)
      if(ppd&&(pp.items)){
        _hasInnerPanel=1
        _aiGenerator._fillPanel(ppd,pp,m,fs,_defParameter)
      }
    })
    
    if(as[0]&&as[0].type!=7){
      fs.unshift({
        type:7,
        asOneAction:pd.asOneAction?"on":"",
        speed:pd.speed||200,
        description:_Util._formatMessage(_bzMessage._action._description._fillForm,pd.name),
        ai:"contents:"+pd.code,
        loopData:pd.preScript
      })
    }
    
    _aiStepHandler._assignFlag(pd,fs,0,m)

    fs.forEach(v=>{
      if(v.type==7){
        v.asOneAction=pd.asOneAction?"on":""
        v.speed=pd.speed||200
      }else{
        v.inGroup="on"
      }
    })

    _aiActionHandler._insertOutOpr(p,m,fs)

    _aiActionHandler._exInsertActions(pd,m,fs,_defParameter,_type)
    _aiActionHandler._insertFormTabActions(pd,m,fs,_defParameter,_type)

    _aiActionHandler._insertSubmitAction(pd,m,_hasInnerPanel,fs,_defParameter,_type)
    if(pd.endScript){
      fs.push({
        type:3,
        script:pd.endScript,
        flag:"handle-data-"+pd.name,
        ai:"contents:"+pd.code+",tab:endScript"
      })
    }
    as.push(...fs)
  },
  _getFieldDefParameter:function(f,c){
    let df=c.formValues[f.code],v
    if(df){
      v=df.defValue
      if(f.type.includes("module")){
        if(f.inputFormat){
          return f.inputFormat
        }else if(_aiAuthHandler._isAuthItem(f.module)){
          return "{{$project.$curtAppLoginUser."+f.mapLabel+"}}"
        }else{
          let mf=_aiGenerator._getRefField(f);
          if(mf){
            return "{{"+_aiGeneratorDataHandler._getCurSysCtrlDataName(f.module)+"."+mf.data+"}}"
          }
        }
      }else if(df.dynamicData){
        v=f.inputFormat
      }
    }
    if(v&&f.type=="object"&&v.constructor==String){
      try{
        v=_Util._eval("v="+v)
      }catch(e){}
    }
    return v
  },
  _getRefField:function(f){
    if(f.type.includes("module")){
      let mf=_aiGeneratorDataHandler._getFieldByCode(f.mapLabel,f.module);
      if(!mf){
        mf=_aiGeneratorDataHandler._getFieldByCode(f.mappingKey,f.module);
      }
      if(!mf){
        return alert(_bzMessage._aiDefinition._missLabelField+": "+_ideModuleManagement._getStdDescription(f.module))
      }
      return mf
    }
  },
  _isReadonly:function(f,c,m){
    if(f.type=='viewData'){
      return 1
    }
    
    if(c.constructor==String){
      c=_aiGeneratorDataHandler._getContentByCode(c,m)
    }
    c.formValues=c.formValues||[]
    let df=c.formValues[f.code]
    return df&&df.readonly
  },
  _getTestFieldSettingByTestPath:function(t,f){
    t=t.split(".")
    let m=_aiGeneratorDataHandler._getModuleObject(t[0]),c;
    t=m._data.definition.operations.find(x=>{
      return x.testCode==t[1]
    })
    if(t.api){
      if(t.query){
        c=t.query.find(x=>x.code==f.code||x.code==f)
      }
      if(!c&&t.path){
        c=t.path.find(x=>x.code==f.code||x.code==f)
      }
      if(!c&&t.data&&t.data.fields){
        c=t.data.fields.find(x=>x.code==f.code||x.code==f)
      }
    }else{
      c=t.lanuchPanel&&_getFieldInContent(t.lanuchPanel,f,m)
    }
    if(c){
      return c
    }else{
      let mm=_aiModelHandler._getModelByCode(t.lanuchPanel,m)
      if(mm.items.find(x=>{
        if(x.group=="button"&&(!x.module||x.module==m._data.code)){
          x=_aiGeneratorDataHandler._getItemByGroupAndCode("buttons",x.code,m)
          c=_getFieldInContent(x.lanuchPanel,f,m)
          if(c){
            f=c
            return 1
          }
        }
      })){
        return f
      }
    }
    
    function _getFieldInContent(c,f,m){
      c=_aiGeneratorDataHandler._getContentByCode(c,m)
      return c.formValues[f.code||f]
    }
  },
  //p: panel model,
  //m: module data, 
  //as: action list, 
  _fillFields:function(pd,p,m,as,_defParameter,_type){
    var _done={},_panelIdx=as.length
    var fs=_aiGenerator._getPanelFields(p,m,[],1)
        // c=_aiGeneratorDataHandler._getContentByCode(p.code)
        
    var _addTest=_aiGenerator._getTestByType(m,"add")
    fs.forEach(f=>{
      if(!f._field||f._field.disable||_aiGenerator._isReadonly(f._field,pd)){
        return
      }
      let _idx=as.length,dk="$parameter."+f._field.data
      _insertData(f._field,f._panels)
      if(as.length-_idx>1){
        for(let i=_idx;i<as.length;i++){
          let a=as[i]
          if(!a.alwaysExe&&!a.loopData&&(!a.event||!a.event.value||!a.event.value.includes("{{"+dk+"}}"))){
            a.loopData=dk+" == 'bz-skip' ? 0 : 1"
          }
        }
      }
    })

    function _insertData(f,ps){
      if(_done[f.data]||f.disable||_aiGenerator._isReadonly(f,pd)){
        return
      }
      _insertDependence(f.dependencies);
      f.preSteps=f.preSteps||[]
      
      var _data="$parameter."+f.data,fk,ss=[]
      if(f.module){
        p.items.find(b=>{
          if(b.group=="buttons"){
            b=_aiGeneratorDataHandler._getItemByGroupAndCode("buttons",b.code,m)
            if(b.operation&&b.lanuchModule==f.module+"."+f.code){
              _aiActionHandler._insertExBtnAction(ss,b,m)
            }
          }
        })
      }

      _aiStepHandler._stepsToActions(f,"preSteps",ss,ps,m)
      
      if(f.fields){
        _buildDeepDefParameter(f,_defParameter,_type,pd)
      }else if((_type=="edit"&&_addTest)||(!f.required&&f.dependencies&&f.dependencies.length)){
        _defParameter[f.data]="bz-skip"
      }else{
        _defParameter[f.data]=_aiGenerator._getFieldDefParameter(f,pd)
      }
      
      if(!f.fakeElement&&!f.disable){
        _aiActionHandler._generateSetAction(ss,f,ps,_data,m,pd)
        if(f.fields&&ss.length){
          ss=[{
            script:"if($parameter."+f.data+" && !$.isEmptyObject($parameter."+f.data+")){\n  "+ss.map(x=>{
              delete x.ai
              return _scriptActionHandler._actionToJS(x)
            }).join("\n  ").trim()+"\n}",
            type:3,
            runInIDE:"on"
          }]
        }
      }

      _done[f.data]=f
      _aiStepHandler._stepsToActions(f,"endSteps",ss,ps,m);

      // if(ss.length>1){
        // ss.forEach(x=>{x.inGroup="on"})
        // ss.unshift({
          // type:7,
          // loopData:`$parameter.${f.data} == "bz-skip" ? 0 : 1`,
          // ai:"set "+f.data+" group"
        // })
      // }
      ss.forEach(x=>{as.push(x)})
    }
    
    function _buildDeepDefParameter(f,p,_type,pd){
      let d={}
      f.fields.forEach(x=>{
        if(x.fields){
          _buildDeepDefParameter(x,d)
        }else if(_type=="edit"){
          d[x.data]="bz-skip"
        }else{
          d[x.data]=_aiGenerator._getFieldDefParameter(x,pd)
        }
      })
      if(f.type=="array"){
        p[f.data]=[d]
      }else{
        p[f.data]=d
      }
    }
    function _insertDependence(_dependences){
      _dependences=_dependences||[]
      _dependences.forEach(d=>{
        d.items.forEach(a=>{
          if(!a.module){
            _insertData(a.field)
          }
        })
      })
    }
  },
  //c:content,f:field
  _getDefValue:function(f,c,m,_formatOnly){
    if(c.constructor==String){
      c=_aiGeneratorDataHandler._getContentByCode(c,m)
    }
    
    let df,v
    if(c.formValues){
      df=c.formValues[f.code]
    }
    if(!df||df.dynamicData){
      v=f.inputFormat
    }else{
      v=df.defValue
    }
    if(f.type=="object"){
      v={}
      f.fields.forEach(x=>{
        v[x.data]=_aiGenerator._getDefValue(x,c,m,_formatOnly)
      })
    }else if(!df||df.dynamicData){
      if(f.type.includes("module")){
        if(f.mapLabel){
          return _aiGeneratorDataHandler._getFieldByCode(f.mapLabel,f.module).demoValue
        }else if(f.mappingKey){
          return _aiGeneratorDataHandler._getFieldByCode(f.mappingKey,f.module).demoValue
        }
      }else{
        return _formatOnly?v:$util.generateDataByRegex(v,f.name)
      }
    }else if(_Util._hasCode(v)){
      return _formatOnly?v:$util.generateDataByRegex(v,f.name)
    }
    return v||""
  },
  _generateInitData:function(m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let t=_aiGenerator._getTestByType(m,"add")
    
    if(t){
      let ff=_aiGenerator._getTestFields(m,_ideObjHandler._getDataByPath(t))
      let _data={}
      ff.forEach(f=>{
        let d=_aiGenerator._generateFieldData(m,f,_data)
        if(d){
          _data=d
        }
      })

      return _data&&_data[m._data.code]
    }
  },
  _generateFieldData:function(m,f,_data){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let mc=m._data.code
    _data=_Util._clone(_data||{})
    if(!_data[mc]){
      _data[mc]={}
    }
    let d=_data[mc][f.data]
    if(d===undefined){
      if(f.dependencies&&f.dependencies.length){
        _data=_setDataByTargetValue(f,"[enable]",_data);
        if(!_data){
          return
        }
        _data=_setDataByTargetValue(f,"[true]",_data);
        if(!_data){
          return
        }
      }
      let v;
      if(f.type=="boolean"){
        v="on"
      }else if(f.type.startsWith("module")){
        v=_aiGenerator._generateRefModuleData(m,f)
      }else{
        if(f.inputFormat){
          if(f.dynamicData){
            v=f.inputFormat
          }else{
            v=$util.generateWordsByRegex(f.inputFormat,f.name)
          }
        }else{
          v=f.defaultValue
        }
      }
      _data[mc][f.data]=v
    }
    return _data
    
    function _setDataByTargetValue(f,_targetValue,_data){
      let _hasTarget=0
      for(var i=0;i<f.dependencies.length;i++){
        let d=f.dependencies[i]
        if(d.targetValue==_targetValue){
          _hasTarget=1
          let ws=_aiGeneratorDataHandler._getSuiteDependenceSolution(d),wi,_chkModule=1;
          while(ws.length){
            if(_chkModule){
              wi=ws.find(w=>{
                return !w.find(c=>{
                  return !_chkModule||c.c.module!=m._data.code
                })
              })
            }else{
              wi=ws.shift()
            }
            if(wi){
              let dd=_aiGenerator._setDataByDependenceConditionList(wi,_data)
              if(dd){
                return dd
              }else{
                let j=ws.indexOf(wi)
                ws.splice(j,1)
                if(j!=ws.length){
                  _chkModule=0
                }
              }
            }else{
              _chkModule=0
            }
          }
        }
      }
      return !_hasTarget&&_data
    }
  },
  _generateRefModuleData(om,f){
    om=_aiGeneratorDataHandler._getModuleObject(om)
    if(!f.module){
      return
    }
    let rm=_aiGeneratorDataHandler._getModuleObject(f.module),
        _initData
    if(f.module&&f.mapLabel){
      // _initData= _aiGenerator._getInitData(f.module,_aiGeneratorDataHandler._getFieldByCode(f.mapLabel,f.module))
      _initData="#any-exist"
    }
    if(rm._data==_aiAuthHandler._getModule(om._data.defaultHostId)&&["username","identifier"].includes(f.mapLabel)){
      return "#curtAppLoginUser"
    }else{
      return "{{"+_aiGeneratorDataHandler._getCurSysCtrlDataName(rm)+"}}"
    }
  },
  //module,kf:specified field data name
  _getInitData(m,kf){
    let md=_aiGeneratorDataHandler._getModuleObject(m)._data.definition
    let d=$data(m)[md.initData]
    if(d){
      if(kf){
        if(d.constructor==Array){
          d=d[0]
        }
        return d[kf.data]
      }
      return d
    }
  },
  //cs: condition list, 
  //_data: target data, 
  //m: module code, option, if null, set any module data, if not null, set field of the module only, ;
  _setDataByDependenceConditionList:function(cs,_rootData){
    if(!cs.find(c=>{
      c=c.c
      let f=_aiGeneratorDataHandler._getDependenceField(c)
      if(!_rootData[c.module]){
        _rootData[c.module]=$project[_aiGeneratorDataHandler._getCurModuleDataName(c.module)]||{}
      }
      let _tagData=_rootData[c.module]
      let fd=_aiGeneratorDataHandler._getDataByField(_tagData,f,c.module)

      if(fd===undefined){
        if(c.valueType==0){
          fd=""
        }else if(c.valueType==1){
          fd=$util.generateWordsByRegex(f.inputFormat,f.name)||"on"
          if((fd=="off"||fd=="false")&&f.type=="boolean"){
            fd="on"
          }
        }else if(["==",">=","<="].includes(c.valueType)){
          fd=c.value
        }else if(c.valueType=="!="){
          fd=""
        }else if(c.valueType=="regex"){
          fd=$util.generateWordsByRegex(c.value,f.name)
        }else if(c.valueType=="script"){
          try{
            fd=_Util._eval("fd="+c.value)
          }catch(e){}
        }
        _aiGeneratorDataHandler._setDataByField(_tagData,f,fd,c.module)
      }else{
        if(fd=="bz-skip"){
          return 1
        }
        if(c.valueType==0){
          return fd&&((fd!="off"&&fd!="false")||f.type!="boolean")
        }else if(c.valueType==1){
          return !fd||((fd=="off"||fd=="false")&&f.type=="boolean")
        }else if(c.valueType=="regex"){
          let v=_Util._strToRegex(c.value)
          return !v||!fd.match(v)
        }else if(c.valueType=="script"){
          try{
            fd=_Util._eval("fd="+c.value)
            // return fd
          }catch(e){}
        }else{
          return !_Util._eval("fd"+c.valueType+"c.value",{c:c,fd:fd})
        }
      }
    })){
      return _rootData
    }
  },
  _getValidationTestFieldsAndPanel:function(m,t){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let tt=_aiGeneratorDataHandler._getItemByTestCode(t,m)
    if(!tt){
      return
    }
    var c,p;
    
    _name=tt.name
    
    if(tt.lanuchPanel){
      c=tt.lanuchPanel
      p=_aiGeneratorDataHandler._getContentByCode(c,m)
      if(!p){
        return
      }
    }else if(tt.panel){
      c=tt.panel[0]
      p=tt
    }else{
      c=tt.code
      p=tt
    }
    
    let tpm=_aiModelHandler._getModelByCode(p.lanuchPanel||c,m._data.definition.models)
    let _form=_aiGeneratorDataHandler._getContentByCode(tpm.code,m)
    var fs=_aiGenerator._getPanelFields(tpm,m,[])
    var _curFields=[];
    fs.forEach(f=>{
      f=f._field
      if(f&&(_form.type=="form"||(f.type!="boolean"||f.outputFormat))){
        _curFields.push(f)
      }
    })
    return {_fields:_curFields,_panel:p}
  },
  _getOperationUrl:function(v,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let _root=BZ._curEnv.items[m._data.defaultHostId].host
    if(v.startsWith("#root-url")){
      v=v.substring(9)
    }else{
      _root=_Util._mergeURL(_root,m._data.rootUrl)
    }
    return _Util._mergeURL(_root,v)
  },
  _insertRefreshUrlElement:function(_refresh,as,m,t){
    let v=_refresh.value||0
    if(v){
      v=JSON.stringify(v)
    }
    let _quickUrl=_aiGenerator._getOperationUrl(_refresh._quickUrl,m)
    let d={
      type:6,
      method:0,
      // loadURL:"{{$action}}",
      loadURL:_quickUrl,
      ai:"Refresh url element"
    }
    m=_aiGeneratorDataHandler._getModuleObject(m)
    t=t._data||t
    if(t.definition){
      d.ai="operations:"+t.definition.code
    }
    _aiActionHandler._assignAI(m._data.code,d,_refresh)
    as.unshift(d)
    /*
    if(v){
      d.loopData=`(()=>{\n`
                +`  if($project.$groupType=='given'){\n`
                +`    return "${_quickUrl}";\n`
                +`  }else{\n`
                +`    return ${v};\n`
                +`  }\n`
                +`\n})()`
      d.resultscript=`(()=>{\n`
                    +`  if($project.$groupType=='given'){\n`
                    +`    $util.gotoFlag("${_refresh._quickFlag}");\n`
                    +`  }\n`
                    +`})()`
      
    }else{
      d.loopData=`${_quickUrl}`
    }
    */
  },
  //m:module, opr: operation, as: action list
  _generateValidateExist:function(m,t){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    t._actions=[]
    let as=t._actions
    let fp=_aiGenerator._getValidationTestFieldsAndPanel(m,t._data.code)
    if(!fp){
      return
    }
    if(fp._fields.length){
      _validateFields(fp._panel,fp._fields,as,m)
    }
    
    fp._panel.buttons&&fp._panel.buttons.find(b=>{
      if(b.type=="close"||b.type=="cancel"){
        d=_aiActionHandler._generateClickAction(as,b,0,[fp._panel.path],m)
        return 1
      }
    })

    _aiActionHandler._insertHandleParameterAction(t._data.definition,t._parent,as);

    //p:target element, fs: fields, as: action list
    function _validateFields(p,fs,as,m){
      var ds="",pp,ea,_area,_panels=[],_refresh;
      pp=_aiStepHandler._getAllSolutionsToElement(p,m)[0];

      _area=pp[pp.length-1]
      ea=pp.pop()
      
      if(pp){
        if(pp[0].constructor==Array){
          pp=pp[0]
        }
      }
/**/
      if(pp[0]._quickUrl&&pp[0]._quickType!="enterModule"){
        t._enterPoint={type:"follow"}
        _refresh=pp.shift()
      }else{
        if(m._data.definition.startPanel=="url"){
          if(pp[0]&&pp[0]._quickFlag){
            t._enterPoint={type:"follow"}
            _refresh=pp.shift()
          }else{
            t._enterPoint={type:"followSameURL",value:m._data.rootUrl}
          }
        }else{
          //set enterPoint and actions
          if(pp[0].type=="followSameURL"){
            t._enterPoint=pp.shift()
          }else{
            t._enterPoint={type:"follow"}
          }
        }
        pp.unshift({})
        pp=_aiStepHandler._parseToActions(pp,m)
        pp.forEach(x=>{
          as.push(x)
        })
      }

      if(_refresh){
        _aiGenerator._insertRefreshUrlElement(_refresh,as,m,t)
      }
      if(p.preScript){
        as.push({
          type:3,
          script:p.preScript,
          ai:"pre-script",
          description:_bzMessage._setting._objectLib._preScript
        })
      }

      let _panel=_aiPageHandler._updateElementPathByDemoValue(ea.path),
          _flag=_aiGeneratorDataHandler._getContentByCode(ea.panel&&ea.panel[0])||ea
      if(_flag){
        _flag=BZ._groupWords([m._data.name,_flag.name])
      }
      

      fs.forEach(f=>{
        if(f.disable){
          return
        }
        let cf=p.formValues[f.code]
        if(cf){
          let _path;
          if(cf.path){
            _path=cf.path
          }else if(cf.pathType=="view"){
            _path=f.view
          }else if(cf.pathType=="input"){
            _path=f.path
          }
          if(_path){
            _addFieldValidation(f,_path,as,p)
            return
          }
        }
        var v=f.outputFormat,
            pv="$parameter."+f.data
        if(!v){
          ds+=pv
        }else{
          if(v.match(/^\{.+\}$/s)){
            try{
              v=_Util._eval("v="+v)
            }catch(e){}
          }else{
            v=v.replace(/\$input/g,pv)
          }
          ds+=v
        }
        ds+="\n"
      })
      ds=ds.trim()
      if(ds){
        as.push({
          type:0,
          method:0,
          flag:_flag,
          compareMark:"==",
          content:{type:"data"},
          element:_panel||["BZ.TW.document","BODY",0],
          expection:ds,
          description:_Util._formatMessage(
            _bzMessage._action._description._validateContent,
            ["["+_bzMessage._syntaxOption.format.data+"]",_area.name||""]
          ),
          ai:"module:"+(ea._tmpModule||m._data.code)+",contents:"+(ea.code||"body")
        })
      }
    }

    function _addFieldValidation(f,_path,as,p){
      as.push({
        ai:`module:${m._data.code},fields:${f.code},panel:${p.code}`,
        element:_path,
        type:0,
        method:0,
        compareMark:"==",
        content:{
          type:"data"
        },
        expection:`$parameter.${f.data}`
      })
    }
  },
  _prepareNewTest:function(_name,_data,ts){
    var _test=_ideTestManagement._getItemByName(_name)
    if(!_test){
      ts.push(_data)
      return 1
    }
  },
  _getTestByType:function(m,_type){
    m=_aiGeneratorDataHandler._getModuleObject(m)._data
    let d=m.tests.find(t=>{
      return t.definition.type==_type
    })
    if(d){
      return m.code+"."+d.code
    }
  },
  _fromApiTestToModel:function(r,t,m,_model,_fun){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    
    r=_Util._clone(r)
    r.api="on"
    r.code=_aiAPI._newId()
    r.headers=JSON.stringify(r.headers,0,2)
    r.joins=[]
    r.path=[]
    r.preScript=""
    
    let _tokenHost=_aiAuthHandler._getTokenHostIdxByUIHostIdx(m._data.defaultHostId)
    if(_tokenHost!==undefined){
      r.autoToken="on"
    }
    if(r.data){
      if(r.data.constructor==Array){
        r.data={
          inArray:"on",
          fields:_getFields(r.data[0])
        }
      }else{
        r.data={
          fields:_getFields(r.data)
        }
      }
    }else{
      r.data=[]
    }

    if(r.query){
      if(r.query.constructor==String){
        r.query=JSON.parse(r.query)
      }
      r.query=_getFields(r.query)
    }else{
      r.query=[]
    }
    
    _model.items.push({
      code:r.code,
      group:"operations"
    })
    
    t=t||{
      type:"api",
      name:r.name,
      dataMap:[],
      hostId:m._data.defaultHostId,
      synActionDesc:"on",
      subtype:r.method=="GET"?"validation":"operation",
      enterPoint:{type:"follow"},
    }
    t.actions=[]
    t.definition={
      code:r.code
    }

    _ideTestManagement._save(t,m,function(t){
      r.testCode=t.code
      _saveModule(r,t)
    })

    function _saveModule(r,t){
      m._data.definition.operations.push(r)
      _ideModuleManagement._save(m,function(){
        t.definition=r
        _fun&&_fun()
      })
    }
    
    function _getFields(d){
      let ds=[]
      for(let k in d){
        let f=_aiGeneratorDataHandler._getFieldByName(k,m)
        let ff={
          name:k
        }
        if(f){
          ff.code=f.code
          ff.sync="on"
        }else{
          ff.inputFormat=d[k]
        }
        ds.push(ff)
      }
      return ds
    }
  },
  _buildAPI:function(t){
    let m=t._parent._data
    let as=[{
          description:"Handler $parameter script",
          type:3,
          script:`$parameter = $aiAPI.preHandleParameter($parameter,"add","${m.alias||m.code}");`,
          runInIDE:"on",
          resultscript:"(()=>{\n  if($parameter=='bz-stop'){\n    $result.break = 'bz-stop';\n  }else if($util.isEmptyData($parameter)){\n    $result.status='warning';\n  }\n})()",
          ai:"no-setting,script: handle parameter"
        }],a=_Util._clone(t._data.definition)
    t._actions=as
    as.push({
      id:1,
      type:1,
      apiReplaceEvent:"on",
      requests:[a],
      ai:"operations:"+a.code,
      loopData:a.preScript
//      loopData:a.preScript||"$util.toErgodicList($parameter)"
      //loopData:a.preScript||"$parameter"
    })
    delete a.code
    delete a.name
    a.query=_setField(a.query,1)
    a.data=_setField(a.data)
    
    let p=_openAPIHandler._buildParameterData(t._parent._data,t._data.definition,m)
    t._data.defParameter=JSON.stringify(p,0,2)

    function _setField(o,_query){
      if(o){
        let r={};
        (o.fields||o).forEach(x=>{
          r[x.name]="{{$parameter."+x.name+"}}"
        })
        if(o.inArray){
          r=[r]
        }
        return r
      }
    }
  },
  _buildScenario:function(t){
    let _flow=t._data.definition.code,
        _loopData
    
    if(!t._data.dataMap||!t._data.dataMap.length||!(t._data.dataMap[0].value||"").trim()){
      _loopData=_aiFlowHandler._getInitData(_aiFlowHandler._getFlowByTest(_flow,t,t._parent),t._parent._data)||{};
      
      _loopData=_loopData._data
      if(!_Util._isEmpty(_loopData)){
        t._data.dataMap=[{name:"data",type:"c",value:_csvEditor._objToCSV([_loopData])}]
        t._data.loopData={
          loopStart:0,
          loopValue:"$test.data"
        }
        _ideDataManagement._addData(_IDE._getShortcutKey("",0,t),t)
      }else{
        t._data.dataMap=[]
        t._data.loopData={}
      }
    }else{
      _loopData=t._data.dataMap[0].value
      _loopData=_Util._csvToObj(_loopData)[0]
    }
    
    

    t._actions=_aiGenerator._getFlowActions(_flow,t,t._parent._data,_loopData)
  },
  //_flow: flow key
  _getFlowActions:function(_flow,t,m,_loopData){
    let _flowKey=_flow
    _flow=_aiFlowHandler._getFlowByTest(_flow,t,m);
    let _given=[_aiActionHandler._generateGroup("given")],
        _when=[_aiActionHandler._generateGroup("when")],
        _then=[_aiActionHandler._generateGroup("then")],
        _step="given";
    if(!_flow){
      return []
    }
    let _curTestPath=_flow.scenario.code
    //Given
    let gs=_aiFlowHandler._getFlowGivens(_flow,_flowKey.split(".")[0])
    gs.forEach(x=>{
      _given.push(_aiGenerator._generateScenarioAction(_curTestPath,_flowKey,x,_step,0,_loopData))
      _step="and"
    })
    
    _aiGenerator._generateAuthAction(_flow,m,_step,0,_given)

    //When
    _step="when"
    _flow.oprs&&_flow.oprs.forEach((x,i)=>{
      _when.push(_aiGenerator._generateScenarioAction(_curTestPath,_flowKey,x,_step,0,_loopData,i==_flow.oprs.length-1&&_Util._isEmpty(_flow.scenario.when)&&_Util._isEmpty(_flow.scenario.then)))
      _step="and"
    });
    
    _flow.scenario.when&&_flow.scenario.when.forEach((x,i)=>{
      _when.push(_aiGenerator._generateScenarioAction(_curTestPath,_flowKey,x,_step,0,_loopData,i==_flow.scenario.when.length-1&&_Util._isEmpty(_flow.scenario.then)))
      _step="and"
    });

    //Then
    _step="then"
    _flow.scenario.then&&_flow.scenario.then.forEach((x,i)=>{
      _then.push(_aiGenerator._generateScenarioAction(_curTestPath,_flowKey,x,_step,0,_loopData,i==_flow.scenario.then.length-1))
      _step="and"
    });
    
    _given=_given.concat(_when).concat(_then)
    _Util._spliceAll(_given,x=>!x)
    return _given
  },
  _generateHas:function(t,m){
    let as=t._actions=[],
        _key=_aiGeneratorDataHandler._getLabelFields(m,1),
        _edit=_aiGeneratorDataHandler._getTestsByDefType(m,"edit"),
        _comment=_bzMessage._aiDefinition._comment;

    as.push({
      type:3,
      description:_bzMessage._aiDefinition._comment._exeTests,
      refOfSuccess:"{{$test.tmpRefTest}}",
      successParameter:"$parameter",
      ai:"no-setting",
      runInIDE:"on"
    })
    // as[as.length-1].loopData="(()=>{\ndebugger;;\nreturn $aiAPI.getExeSolutionByParameter($parameter)\n})()"
    as[as.length-1].script="(()=>{\n"
                          +"  return function(callback){\n"
                          +"    $aiAPI.initCurModuleData(()=>{\n"
                          +"      $test.tmpRefTest = $aiAPI.getExeSolutionByParameter($parameter);\n"
                          +"      callback();\n"
                          +"    })\n"
                          +"  }\n"
                          +"})()"
  },
  _isMatchConditionValue:function(c,cv){
    let vt=c.valueType,
        v=c.value;

    if(vt==0){
      return !cv&&cv!==0
    }else if(vt==1){
      return cv
    }else if(vt=="regex"){
      return v&&cv.match(_Util._strToRegex(v))
    }else if(vt=="script"){
      try{
        return _Util._eval(v)
      }catch(e){}
    }else{
      return _Util._eval("cv"+vt+"v",{v:v,cv:cv})
    }
  },
  _getMatchConditionValue:function(c){
    let vt=c.valueType,
        v=c.value,
        f=_aiGeneratorDataHandler._getFieldByCode(c.field,c.module);

    if(vt==0){
      return ""
    }else if(vt==1){
      return $util.generateWordsByRegex(f.inputFormat,f.name)
    }else if(vt=="regex"){
      return $util.generateWordsByRegex(v,f&&f.name)
    }else if(vt=="script"){
      try{
        return _Util._eval(v)
      }catch(e){}
    }else if(vt=="!="){
      if(v){
        return ""
      }else{
        return $util.generateWordsByRegex(f.inputFormat,f.name)
      }
    }else{
      return v
    }
  },
  _generateAuthAction:function(_flow,m,_step,_requiredField,as){
    let r=_flow.roles||""
    if(r=="*"){
      r=""
    }
    if(r.constructor==Array){
      r=r.join(",")
    }
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let t=_aiAuthHandler._getTestCase(m._data.defaultHostId,"hasSign")
    let a={
      type:4,
      refOfSuccess:t,
      successParameter:r
    }
    if(!_requiredField){
      a.inGroup="on"
      a.stepKey=_step||"given"
      a.groupKey="given"
      a.ai="flow:1,tab:auth"
    }
    if(a.refOfSuccess&&_ideObjHandler._getDataByPath(a.refOfSuccess)){
      as.push(a)
    }
  },
  _generateScenarioAction:function(_curTestPath,_flowKey,g,_stepKey,_inRequiredFlow,_loopData,_lastAction){
    let m,_test,p="",
        _resultScript="",
        _actionScript,
        ps={};
    
    if(g.code){
      m=_aiGeneratorDataHandler._getModuleObject(g.code.split(".")[0])
      if(!m){
        return
      }
      let _status=g.status?_statusManagement._getDataStatusByKey(g.status,m):_statusManagement._getModuleDefStatus(m)

      ps.$status=_status.name
      
      _test=_aiGenerator._getTestByType(m,"has")
      let _testVarName=_aiAPI._getScenarioTransferDataName(g.varName,m,_curTestPath)
      _resultScript=`${_testVarName} = ${_aiGeneratorDataHandler._getCurSysCtrlDataName(m)}.$bzId;\n`
                   +`$aiAPI.updateDataStatus(${_aiGeneratorDataHandler._getCurSysCtrlDataName(m)}, "${_status.name}", "${m._data.code}")`
    }else if(g.test){
      _test=_ideObjHandler._getDataByPath(g.test)
      if(!_test){
        return
      }
      m=_test._parent
      let _testVarName=_aiAPI._getScenarioTransferDataName(g.varName,m,_curTestPath)
      
      _test=g.test
      if(g.stepKey=="when"){
        _actionScript=`${_aiGeneratorDataHandler._getCurSysCtrlDataName(m)} = $aiAPI.getModuleDataById(${_testVarName},"${m._data.alias||m._data.code}")`
        _flowKey=_flowKey.split(".")
        _flowKey=_statusManagement._getDataStatusByKey(_flowKey[1]||_flowKey[0],m)
        if(_flowKey){
          if(_flowKey.opr=="delete"){
            ps=`$aiAPI.getModuleDataById(${_testVarName})`
          }else{
            _resultScript=`    ${_testVarName} = ${_aiGeneratorDataHandler._getCurSysCtrlDataName(m)}.$bzId;\n`
                         +`    $aiAPI.updateDataStatus(${_aiGeneratorDataHandler._getCurSysCtrlDataName(m)}, "${_flowKey.name}","${m._data.code}")\n`
          }
        }
      }else if(g.stepKey=="then"){
        let gt=_ideObjHandler._getDataByPath(_curTestPath)
        if(g.forDelete){
          if(gt._parent._data==m._data){
            ps=`$project.${_aiGeneratorDataHandler._getlastDelModuleDataName()}`
          }else{
            ps=_aiGeneratorDataHandler._getCurSysCtrlDataName(m)
          }
        }else{
          if(gt._parent._data==m._data){
            ps=`$aiAPI.getModuleDataById(${_testVarName})`
          }else{
            ps=_aiGeneratorDataHandler._getCurSysCtrlDataName(m)
          }
        }
      }
    }else{
      return
    }
    if(g.stepKey!="then"){
      if(g.data){
        let vs=_aiFlowHandler._getSetableDataFields(g.data,m)
        vs.forEach(x=>{
          _buildParameter(x,m._data)
        })
      }
    }
    if(!_inRequiredFlow&&g.stepKey!="given"){
      let _code="",_code2="";
      if(_resultScript){
        _code=`\n  if($result.status == 'success'){\n${_resultScript}  }\n`
      }
      if(_lastAction){
        _code=`else if($loop && $loop.$result){\n`
             +`    $result.status = 'failed';\n`
             +`  }\n`
      }else{
        _code2=`    if($loop.$result != 'success' && $loop.$result != 'warning'){\n`
              +`      $result.bzStop = true;\n`
              +`      return;\n`
              +`    }\n`

      }
      _resultScript=`(()=>{\n`
                   +`  if($loop && $loop.$result && $result.status == $loop.$result){\n`
                   +`    $result.status = "success";\n`
                   +`${_code2}`
                   +`  }`
                   +`${_code||"\n"}`
                   +`})()`
    }
    let a={
      type:4,
      refOfSuccess:_test,
      successParameter:ps,
      ai:"flow:1,test:"+_test,
      resultscript:_resultScript,
      loopData:_actionScript
    }
    if(g.forDelete){
      a.refOfSuccess+="/f/../"
      a.refOfError="s/../"
      a.refOfFailed="s/../"
    }
    if(!_inRequiredFlow){
      a.groupKey=g.stepKey||_stepKey
      a.stepKey=_stepKey||g.stepKey
      a.inGroup="on"
    }    
    if(!_inRequiredFlow&&ps&&ps.constructor==Object){

      g.scenarioFields&&g.scenarioFields.forEach(x=>{
        _buildParameter(x,m._data)
      })
      _cleanEmptyObj(ps)
      a.successParameter=JSON.stringify(ps)
    }
    
    // if(g.stepKey=="then"&&g.forDelete){
      // a.refOfError="./s/"
      // a.refOfFailed="./s/"
      // a.refOfSuccess+="/./f/"
    // }

    return a
    function _cleanEmptyObj(d){
      if(d&&d.constructor==Array){
        _Util._spliceAll(d,x=>_Util._isEmpty(x))
      }else if(d && d.constructor==Object){
        for(let k in d){
          _cleanEmptyObj(d[k])
        }
      }
    }
    function _buildParameter(x,m){
      let v,cm=BZ._getCurModule()
      if((!cm||m.code!=cm._data.code)&&g.stepKey=="given"){
        v="{{$loop."+x.colName+"}}"
      }else if(_loopData&&_loopData[x.colName]!==undefined){
        v="{{$loop."+x.colName+"}}"
      }else{
        v=x.value
      }
      if(!x.colName){
        return
      }
      let _array=(x.colName.match(/_([0-9]+)$/)||[])[1]
      if(x.field=="$status"){
        ps.$status=x.value
        return
      }
      let f=_aiAPI._getFieldByModuleAndFieldCodeRef(x.field,m.code)
      if(f){
        let r=ps;
        f=f._fullData.split(".")
        let ff=f.pop(),pd=r,_lastKey
        f.forEach(ff=>{
          ps[ff]=ps[ff]||{}
          pd=ps
          _lastKey=ff
          ps=ps[ff]
        })
        if(_array){
          if(ps.constructor==Object){
            if(_Util._isEmpty(ps)){
              if(ps==r){
                r=ps=[]
              }else{
                ps=[]
                pd[_lastKey]=ps
              }
              let d={}
              d[ff]=v
              ps.push(d)
            }else{
              ps[ff]=v
              if(ps==r){
                r=[ps]
                ps=r
              }else{
                pd[_lastKey]=[ps]
              }
            }
          }else{
            if(!ps[_array]){
              ps[_array]={}
            }
            ps[_array][ff]=v
          }
        }else{
          if(ps.constructor==Array){
            ps.forEach(x=>x[ff]=v)
          }else{
            ps[ff]=v
          }
        }
        ps=r
      }else{
        ps[x.field]=v
      }
    }
  },
  _chkConflickRequestDataWithStatusData:function(_status,tk,p,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let ss=_aiFlowHandler._getFromStatusByTargetStatus(_status,m)
    let vs=[]
    ss.find(x=>{
      x=m._data.definition.moduleDataFlow[x]
      x=x&&x.to[_status]
      return !x||!x.find(xx=>{
        if(xx.key==tk){
          return xx.data.oprs.find(y=>{
            return y.data&&y.data.find(z=>{
              let f=_aiGeneratorDataHandler._getFieldByCode(z.field,m)
              if(f&&p[f.data]!==undefined&&p[f.data]!=z.value){
                vs.push(f.data+" = \""+p[f.data]+"\"")
                return 1
              }
            })
          })
        }
      })
    })
    if(vs.length){
      return vs
    }
  }
}

var _aiAPI={
  _curDataNameMap:{},
  _dataMap:{},
  _initMap:{},
  _varMap:{},
  _removed:{},
  _moduleToCurDataNameMap:{},
  _userList:[],
  async _searchData(v,_existOpt,_data,_key){
    let vv,_list=[],ks,m,_initMap=_aiAPI._initMap;
    
    if(v.constructor==String){
      if(!_apiDataHandler._parseExistExpression){
        return
      }
      v=_apiDataHandler._parseExistExpression(v)
    }
    if(!v){
      return
    }

    return bzTwComm._isIDE()&& await _return()

    async function _return(){
      let d=new BZApiDataPicker({
        _data:_data,
        _key:_key,
        _expression:v,
        _method:"_search",
        _existOpt:_existOpt
      })
      return new Promise(_resolve => {
        setTimeout(()=>{
          d._retrieveData()
        })
      })

      if(_data){
        if(_data.constructor!=Function){
          _data[_key]=d
        }
      }

      return d
    }
  },
  async _createData(v,_data,_key){
    let vv,ks,m;
    if(!BZ._isAutoRunning()&&v.constructor==String){
      return _apiDataHandler._askUseTmpData(0,_doIt)
    }
    
    return _doIt()
    
    async function _doIt(){
      if(v.constructor==String){
        if(!_apiDataHandler._parseExistExpression){
          return
        }
        v=_apiDataHandler._parseExistExpression(v)
      }
      if(!v){
        return
      }

      return await _return(_apiDataHandler._pickData(m,v,{_new:1}))
    }

    async function _return(){
      let _new;
      if(bzTwComm._isIDE()&&BZApiDataPicker){
        _new=new BZApiDataPicker({
          _data:_data,
          _key:_key,
          _expression:v,
          _method:"_new",
          _existOpt:{_new:1}
        })
        return new Promise(_resolve => {
          setTimeout(()=>{
            _new._newData()
          })
        })
      }
      
      if(_data&&_data.constructor!=Function){
        _data[_key]=_new
      }

      return _new
    }
  },
  async _getExistData(v,_existOpt,_data,_key){
    let vv,_list=[],ks,m,_initMap=_aiAPI._initMap;
    if(!BZ._isAutoRunning()&&v.constructor==String){
      return _apiDataHandler._askUseTmpData(0,async function(){
        return await _doIt(v)
      })
    }
    
    return await _doIt()
    
    async function _doIt(){
      if(v.constructor==String){
        if(!_apiDataHandler._parseExistExpression){
          return
        }
        v=_apiDataHandler._parseExistExpression(v)
      }
      if(!v){
        return
      }

      m=_aiAPI._dataMap[v.m]
      
      if(_Util._isEmpty(m)&&_aiAuthHandler._isLinkageModule(v.m)){
        m=_aiAuthHandler._getCurUser(v.m)
        m=m?[m]:[]
      }

      v= await _return(_apiDataHandler._pickData(m,v,_existOpt))
      return v
    }

    async function _return(_list){
      if(_Util._isEmpty(_list)){
        let iv=_initMap[v.m]||_existOpt._afterSearch

        if(!iv&&bzTwComm._isIDE()&&BZApiDataPicker){
          _initMap[v.m]=_list=new BZApiDataPicker({
            _data:_data,
            _key:_key,
            _expression:v,
            _initMap:_initMap,
            _method:"_init",
            _existOpt:_existOpt
          })
          return new Promise(_resolve => {
            setTimeout(()=>{
              _list._retrieveData(function(v){
                _setData(_data,_key,v)
                _resolve(v)
              })
            })
          })
        }else if(bzTwComm._isIDE()&&iv.constructor==BZApiDataPicker){
          iv._addItem(_data,_key,v,_existOpt)
          _list=iv
        }else{
          _list=null
        }
      }
      _setData(_data,_key,_list)
      if(!_list||(bzTwComm._isIDE()&&_list.constructor!=BZApiDataPicker)){
        if(!BZ._isAutoRunning()){
          m=_aiGeneratorDataHandler._getModuleObject(v.m)
          console.log("BZ-LOG: "+m._data.name+":"+(_list||[]).length)
        }
        _apiDataHandler._askTime=0
      }
      return _list
    }

    function _setData(_data,_key,_list){
      if(_data){
        if(_data.constructor!=Function){
          _data[_key]=_list
        }else if(bzTwComm._isIDE()&&(!_list||_list.constructor!=BZApiDataPicker)){
          try{
            _data(_list)
          }catch(e){
            alert(e.stack)
          }
        }
      }
    }

  },
  _getScenarioTransferDataName:function(_varName,m,t){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    return "$project."+(_varName||_aiGeneratorDataHandler._getCurModuleDataName(m))+(t+"").replace(/\./g,"")
  },
  _updateDataStatus:function(d,_status,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    d=_aiAPI._getModuleDataById(d.$bzId,m)
    d.$status=_status
    $project[_aiGeneratorDataHandler._getCurModuleDataName(m)].$status=_status
  },
  _newId:function(){
    this._key=this._key||Date.now()
    return this._key++
  },
  _getModuleVarName:function(m,_org){
    if(!m||!m.alias){
      m=_aiGeneratorDataHandler._getModuleObject(m)
      if(!m){
        return
      }
      m=m._data
    }
    m=_glossaryHandler._getVariableName(m.alias||m.name)
    return _org?m:_Util._toCapitalWord(m)
  },
  _initialData:function(_loadTmpData){
    console.log("BZ-LOG: init AI data")
    _aiAPI._missKey=""
    _aiAPI._curDataNameMap={}
    _aiAPI._moduleToCurDataNameMap={}
    _aiAPI._removed={}
    _aiAPI._dataMap={}
    _aiAPI._varMap={}
    _aiAPI._userList=[]
    _aiAPI._initMap={}
    _apiDataHandler._curExeApiMap={}

    try{
      if(_aiAuthHandler._data){
        _aiAuthHandler._data.forEach((a,i)=>{
          if(a.inAuth&&a.module){
            _aiAPI._userList[i]=_aiAuthHandler._getUserDataMap(i)
          }
        })
      }
      
      _IDE._data._curVersion.modules.forEach(mm=>{
        if(mm.bt=="data"){
          let k=_aiGeneratorDataHandler._getCurModuleDataName(mm);
          _aiAPI._curDataNameMap[k]={
            m:mm,
            _parent:mm.parentModule,
            _children:[],
            _includeList:[],
            _refList:[],
            _beIncludes:[],
            _beRefList:[]
          }
          _aiAPI._moduleToCurDataNameMap[mm.code]=k
          
          if(mm.definition.initData&&!mm.parentModule){
            let ds=$data(mm.code)[mm.definition.initData]
            if(ds.constructor==Array){
              ds.forEach(x=>{
                _aiAPI._addData(x,mm)
              })
            }else{
              _aiAPI._addData(ds,mm)
            }
          }
        }
      })

      for(let k in _aiAPI._curDataNameMap){
        let d=_aiAPI._curDataNameMap[k],kk;
        if(d.m.parentModule){
          kk=_aiAPI._moduleToCurDataNameMap[d.m.parentModule]
          _aiAPI._curDataNameMap[kk]._children.push(d.m.code)
        }
        d.m.definition&&d.m.definition.fields&&d.m.definition.fields.forEach(f=>{
          if(f.module){
            if(["module"].includes(f.type)){
              kk=_aiAPI._curDataNameMap[_aiAPI._moduleToCurDataNameMap[f.module]]
              if(f.moduleRelatineship=="include"){
                d._includeList.push(f.module)
                kk&&kk._beIncludes.push(d.m.code)
              }else if(f.moduleRelatineship=="ref"){
                d._refList.push(f.module)
                kk&&kk._beRefList.push(d.m.code)
              }
            }
          }
        })
      }
    }catch(e){
      console.log("BZ-LOG: Error - "+e.message)
      console.log("BZ-LOG:"+e.stack)
    }
    console.log("BZ-LOG: complete ai data init")
  },
  _getModuleRelationships:function(m){
    try{
      return _aiAPI._curDataNameMap[_aiAPI._moduleToCurDataNameMap[_aiGeneratorDataHandler._getModuleObject(m)._data.code]]
    }catch(e){}
  },
  _isMatchParameter:function(p,d){
    d=_aiAPI._retrieveFinalData(d)
    if(d&&d.constructor==Array){
      return !d.find(x=>!_aiAPI._isMatchParameter(x,m))
    }
    for(let k in d){
      if(p[k]&&p[k]!="bz-skip"&&p[k]!=d[k]){
        return
      }
    }
    return 1
  },
  //_aiAPI._dataMap[m]
  _getSysCtrlDataMap:function(m){
    m=_aiGeneratorDataHandler._getModuleObject(m)._data;
    let mc=m.code,mm
/*    
    for(var k in _aiAPI._curDataNameMap){
      let o=_aiAPI._curDataNameMap[k]
      if(o._children.includes(mc)||o._includeList.includes(mc)){
        let cn=_aiGeneratorDataHandler._getCurModuleDataName(o.m)
        if(_aiAPI._varMap[cn]){
          mm=o.m
        }
      }
    }
    if(mm){
      let pm=_aiAPI._dataMap[mm.code][_aiAPI._varMap[_aiGeneratorDataHandler._getCurModuleDataName(mm)]]
      pm[mc]=pm[mc]||{}
      return pm[mc]
    }
    */
    return _aiAPI._dataMap[mc]=_aiAPI._dataMap[mc]||{}
  },
  _getModuleDataById:function(v,m){
    let ds=_aiAPI._getSysCtrlDataMap(m)
    return _Util._clone(ds[v]||$project[_aiGeneratorDataHandler._getCurModuleDataName(m)])
  },
  //Data: $project.curProject
  _getCurSysCtrlData:function(m){
    m=_aiGeneratorDataHandler._getModuleObject(m)._data.code;
    let cn=_aiGeneratorDataHandler._getCurModuleDataName(m)
    cn=_aiAPI._varMap[cn]
    if(cn){
      return _aiAPI._dataMap[m][cn]
    }
    /*
    m=_aiGeneratorDataHandler._getModuleObject(m)._data.code;
    let d=_Util._eval(_aiGeneratorDataHandler._getCurSysCtrlDataName(m))
    if(d){
      _aiAPI._removed[m]=_aiAPI._removed[m]||{}
      if(_aiAPI._removed[m][d.$bzId]){
        d=undefined
      }
    }
    return d
    */
  },
  _overwriteExistValue:function(td,sd){
    for(var k in td){
      if(["#try-exist","#any-exist"].includes(td[k])){
        td[k]=sd[k]
      }
    }
  },
  _getModuleData:function(pm){
    pm=_aiGeneratorDataHandler._getCurModuleDataName(pm)
    return _aiAPI._dataMap[_aiAPI._varMap[pm]]
  },
  _retrieveFinalData:function(d,k){
    if(d&&d.constructor==String){
      try{
        d=_Util._eval("d="+d)
        return _aiAPI._retrieveFinalData(d,k)
      }catch(e){}
    }else{
      if(d.constructor==Array){
        return d
      }else if(k){
        if(d[k]){
          return d
        }else{
          for(let kk in d){
            let dd=d[kk]
            if(dd.constructor==Array&&dd.length){
              if(dd[0][k]){
                return dd
              }
            }
          }
        }
        return
      }

      return d
    }
  },
  _addData:function(d,m,_key){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    d=_aiAPI._retrieveFinalData(d,_key)
    

    if(d&&d.constructor==Array){
      let _keep=m._data.tmpDataSize||10
      if(d.length>_keep&&_keep!=-1){
        alert(_Util._formatMessage(_bzMessage._api._getDataSize,[d.length,m._data.name,_keep]))
        d.splice(_keep)
      }
      return d.find((x,i)=>{
        if(i>(_keep)&&_keep!=-1){
          return 1
        }
        _aiAPI._addData(x,m,_key)
      })
    }

    if(!BZ._isAutoRunning()){
      _tmpDataBase._updateItem(d,m,_key)
    }
    let cn=_aiGeneratorDataHandler._getCurModuleDataName(m)

    let mc=m._data.code,
        ds=_aiAPI._getSysCtrlDataMap(m)
      
    for(var k in d){
      if(["bz-skip","bz-skip-group","bz-stop"].includes(d[k])){
        delete d[k]
      }
    }
    if(!d.$bzId||!ds[d.$bzId]){
      if(!_key){
        _key=_aiGeneratorDataHandler._getBestKeyFieldName(m,d)
      }
      if(_key){
        for(let k in ds){
          if(ds[k][_key]==d[_key]){
            d.$bzId=k
            return _aiAPI._updateData(d,m,_key)
          }
        }
      }
    }


    d.$bzId=_aiAPI._newId()

    _statusManagement._assignDataStatus(d,m)
    _aiAPI._assignComboValue(d,m)
    _aiAPI._varMap[cn]=d.$bzId
    $project[cn]=d

    _aiAPI._setInitData(d,m)
    _aiAPI._setToParentData(d,m)

    ds[d.$bzId]=d
    if(m._data.definition){
      let sm=m._data.definition.synaModel
      if(sm){
        ds=_aiAPI._getSysCtrlDataMap(sm)
        ds[d.$bzId]=d
        _aiAPI._setInitData(d,sm)
        _aiAPI._setToParentData(d,sm)
      }
    }
    _aiAPI._handleExModuleData(d,m)
  },
  _assignComboValue:function(d,m){
    m=_aiGeneratorDataHandler._getModuleObject(m);
    m._data.definition&&m._data.definition.fields.forEach(x=>{
      if(x.type=="combo"&&x.inputFormat){
        try{
          if(x.inputFormat.constructor==String){
            _Util._eval("x.inputFormat="+x.inputFormat,{x:x})
          }
          x.inputFormat(d)
        }catch(e){
          alert(_bzMessage._action._comboIssue+":\n"+e.message)
        }
      }
    })
  },
  _updateData:function(d,m,_key){
    m=_aiGeneratorDataHandler._getModuleObject(m);
    let cn=_aiGeneratorDataHandler._getCurModuleDataName(m)

    let c=$project[cn]=$project[cn]||{},
        mc=m._data.code,
        ds=_aiAPI._getSysCtrlDataMap(m)

    if(!_key){
      _key=_aiGeneratorDataHandler._getBestKeyFieldName(m,d)
    }
    if(c.$bzId==d.$bzId||(_key&&(c[_key]==d[_key]))||(!d.$bzId&&!_key)){
      for(var k in d){
        if(!["bz-skip","bz-skip-group","bz-stop"].includes(d[k])){
          c[k]=d[k]
        }
      }
    }else{
      let _found
      for(let k in ds){
        if(ds[k].$bzId==d.$bzId||(_key&&(ds[k][_key]==d[_key]))){
          _found=1
          for(let kk in d){
            if(kk!="$bzId"&&d[kk]!="bz-skip"){
              ds[k][kk]=d[kk]
            }
          }
          break
        }
      }
      if(!_found){
        return _aiAPI._addData(d,m,_key)
      }
      c=d
    }

    d=c
    d.$bzId=d.$bzId||_aiAPI._newId()
    _aiAPI._assignComboValue(d,m)
    if(!BZ._isAutoRunning()){
      _tmpDataBase._updateItem(d,m)
    }

    $project[cn]=d
    _aiAPI._dataMap[mc]=_aiAPI._dataMap[mc]||{}
    _aiAPI._dataMap[mc][d.$bzId]=d
    ds[d.$bzId]=d
    
    _aiAPI._setToParentData(d,mc)
    _aiAPI._handleExModuleData(d,m)
  },
  _deleteData:function(d,m,_key){
    m=_aiGeneratorDataHandler._getModuleObject(m)._data
    let ds=_aiAPI._getSysCtrlDataMap(),
        cn=_aiGeneratorDataHandler._getCurModuleDataName()
    
    $project[_aiGeneratorDataHandler._getlastDelModuleDataName()]=_Util._clone(d)
    if(!d.$bzId){
      _key=_key||_aiGeneratorDataHandler._getBestKeyFieldName();
      if(_key){
        for(var k in ds){
          if(ds[k][_key]==d[_key]){
            d=ds[k]
            break
          }
        }
      }else{
        alert(_bzMessage._api._missKeyFieldInModule,m.name)
        return
      }
    }
    if(d.$bzId){
      if(!BZ._isAutoRunning()){
        _tmpDataBase._removeItem(d,m.code)
      }
      d=_aiAPI._dataMap[m.code][d.$bzId]
      _deleteBzData(d,m.code)

      for(var k in d){
        let dd=d[k]
        if(dd){
          if(dd.constructor==Object){
            _deleteBzIdGroup(dd,k)
          }
        }
      }

      let rm=_aiAPI._getModuleRelationships(m)
      if(rm&&rm._parent){
        for(var kk in _aiAPI._dataMap[rm._parent]){
          try{
            delete _aiAPI._dataMap[rm._parent][kk][m.code][d.$bzId]
          }catch(e){}
        }
      }
      rm&&rm._beIncludes.forEach(a=>{
        for(var kk in _aiAPI._dataMap[a]){
          try{
            delete _aiAPI._dataMap[a][kk][m.code][d.$bzId]
          }catch(e){}
        }
      })
    }

    function _deleteBzData(dd,mk){
      let i=dd.$bzId
      _deleteBzIdFromVarMap(i,mk)
      delete _aiAPI._dataMap[mk][i]
      _aiAPI._removed[mk]=_aiAPI._removed[mk]||{}
      _aiAPI._removed[mk][i]=dd
    }

    function _deleteBzIdGroup(o,k){
      for(var kk in o){
        if(o[kk]&&o[kk].$bzId){
          _deleteBzData(o[kk],k)
        }else{
          return
        }
      }
    }

    function _deleteBzIdFromVarMap(id,mk){
      mk=_aiGeneratorDataHandler._getCurModuleDataName(mk)
      let j=0;i=0
      while(j<5){
        if(_aiAPI._varMap[mk+(i||"")]==id){
          delete _aiAPI._varMap[mk+(i||"")]
          return
        }else if(_aiAPI._varMap[mk+(i||"")]===undefined){
          j++
        }
        i++
      }
    }
  },
  _handleExModuleData:function(d,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    for(let k in d){
      if(k.match(/^m[0-9]+$/)){
        let km=_aiGeneratorDataHandler._getModuleObject(k)
        if(km){
          let dm=d[k]
          if(!_isMapData(dm)){
            if(!dm.$bzId){
              _aiAPI._addData(dm,km)
            }else{
              _aiAPI._updateData(dm,km)
            }
          }
        }
      }
    }
    
    function _isMapData(d){
      if(!_Util._isEmpty(d)&&d.constructor==Object){
        d=Object.keys(d)
        return !d.find(x=>!$.isNumeric(x))
      }
    }
  },
  _setToParentData:function(d,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let c=m._data.code,
        pm=m._data.parentModule,
        pd=_findParentData(m)
    if(pd){
      if(pd.$bzId){
         let dd=_aiAPI._dataMap[pm][pd.$bzId]
         dd[c]=dd[c]||{}
        if(dd[c]==d){
          dd[c]={}
        }
        dd[c][d.$bzId]=d
        _aiAPI._setToParentData(dd,pm)
      }else{
        
      }
    }
    
    function _findParentData(m){
      m=_aiGeneratorDataHandler._getModuleObject(m)
      let pm=m._data.parentModule
      if(pm){
        let pn=_aiGeneratorDataHandler._getCurModuleDataName(pm)
        let pd=$project[pn]
        if(pd){
          return pd
        }else{
          pd=_findParentData(pm)
          if(pd){
            for(var k in pd[pm]){
              return pd[pm][k]
            }
          }
        }
      }
    }
  },
  _setInitData:function(d,m){
    let mr=_aiAPI._getModuleRelationships(m)
    m=_aiGeneratorDataHandler._getModuleObject(m)._data;
    if(mr){
      mr._children.forEach(mc=>{
        _initSubModuleData(mc)
      })
      mr._includeList.forEach(mc=>{
        _initSubModuleData(mc)
      })
    }
    
    function _initSubModuleData(mc){
      let mm=_ideObjHandler._getDataByPath(mc)._data;
      let mi=mm.definition.initData
      if(!d[mc]&&mi){
        let dd=$project[_aiGeneratorDataHandler._getNewModuleDataName(mm)]
        if(!dd){
          dd=$data(mc)[mi]
          if(dd){
            dd=_Util._clone(dd)
          }
        }
        if(dd){
          if(dd.constructor==Array){
            d[mc]=dd
          }else{
            d[mc]=[dd]
          }
          d[mc].forEach((dd,j)=>{
            dd.$bzId=dd.$bzId||_aiAPI._newId()
            
            for(var k in dd){
              if(dd[k]=="bz-skip"){
                delete dd[k]
              }
            }
            let ms={}
            mm.definition.fields.forEach(f=>{
              if(f.module&&f.module!=mc&&f.type!="viewData"){
                if(_aiAuthHandler._isAuthItem(f.module)){
                  if(dd[f.data]=="#curtAppLoginUser"){
                    let cu=_aiAuthHandler._getCurUser(mm.defaultHostId)
                    if(cu){
                      dd[f.data]=cu[f.mapLabel]
                      mm.definition.fields.forEach(x=>{
                        if(x.module==f.module&&!dd[x.data]){
                          dd[x.data]=cu[x.data]
                        }
                      })
                    }
                    ms[f.module]=cu
                  }else if(f.type!="viewData"){
                    let us=_aiAuthHandler._getUserDataMap(mm.defaultHostId)
                    for(var k in us){
                      k=us[k]
                      if(k[f.mapLabel]==dd[f.data]){
                        ms[f.module]=k
                        break
                      }
                    }
                  }
                }else{
                  let fm=_aiGeneratorDataHandler._getModuleObject(f.module)
                  if(fm._data.definition.initData){
                    let ds=$data(f.module)[fm._data.definition.initData]
                    if(ds.constructor==Object){
                      ds=[ds]
                    }
                    ds.find(di=>{
                      if(di[f.mapLabel]==dd[f.data]){
                        return ms[f.module]=di
                      }
                    })
                  }
                }
              }
            })
            
            mm.definition.fields.forEach(f=>{
              let md=ms[f.module]
              if(md){
                dd[f.data]=md[f.mapLabel]
              }
            })
            
            _aiAPI._setInitData(dd,mc)
          })
          let fd={},
              cn=_aiGeneratorDataHandler._getCurModuleDataName(mc)
              
          d[mc].forEach(di=>{
            di.$bzId=di.$bzId||_aiAPI._newId()
            fd[di.$bzId]=di
            
            $project[cn]=di
            _aiAPI._varMap[cn]=di.$bzId
            _aiAPI._dataMap[mc]=_aiAPI._dataMap[mc]||{}
            _aiAPI._dataMap[mc][di.$bzId]=di
            if(!BZ._isAutoRunning()){
              _tmpDataBase._updateItem(di,mc)
            }
          })
          d[mc]=fd
        }
      }
    }
  },
  _removeToken:function(){
    _aiAuthHandler._removeTokenByIdx(_aiAuthHandler._getTokenHostIdxByUIHostIdx())
  },
  _isAssignedData:function(d){
    return d&&_Util._findKeyInObj(d,(v)=>{
      return v==d.$bzId
    })
  },
  _getAuthFlowByRole:function(r){
    let m=_aiGeneratorDataHandler._getModuleObject()._data.defaultHostId
    let u=_aiAuthHandler._getCurUser(m)
    if(r&&r.$args){
      r=r.$args[0]
    }
    if(r&&_Util._isEmpty(r)){
      r=""
    }
    if(r&&r.constructor==String){
      r=[r]
    }
    if(u&&u.role&&(!r||r.includes("sign-in")||r.includes(u.role)||(u.role.constructor==Array&&u.role.find(x=>r.includes(x))))){
      //Already sign-in as required user
      return 0
    }else if(r.includes(_bzMessage._aiTask._signOut._key)&&!u&&u!==undefined){
      //Already sign-out
      return 0
    }else if(r.includes(_bzMessage._aiTask._signOut._key)){
      return [{code:_aiAuthHandler._getTestCase(m,"signOut")}]
    }else{
      return [{code:_aiAuthHandler._getTestCase(m,"signIn"),parameter:(r&&r.find(x=>x!="sign-in"))||$util.getRoles()[0]}]
    }
  },
  //assignAuthFlow
  _assignCurtUser:function(p){
    $project=$project||$data()
    let m=_aiGeneratorDataHandler._getModuleObject()._data.defaultHostId

    $project[_aiAuthHandler._getCurUserName(m)]=p
    if(!p){
      _aiAPI._removeToken();
    }
  },
  //ignore on delete action by Regex data
  _stopRegexAction:function(r,p,k){
    p=p[k]||p
    if(r.status!='success'&& p && p.match(/^\/.+\/$/s)){
      r.status = "success";
      r.break = 'bz-stop';
    }
  },
  //IDE auto call the function at beginning of each scenario to clean current data of each module (except curUser)
  _cleanAllCurDataFromSysMap:function(){
    _aiAPI._removed={}
    _aiAPI._varMap={}
    _aiAPI._missKey=""
    mc=BZ._getCurModule()._data.code;
    //reset module data
    _ideDataManagement._tmpTaskDataMap._app[mc]=$data(mc,0,1)
    let ms=_ideObjHandler._getSubModules(mc)
    
    ms.forEach(m=>{
      m=m._data.code
      _ideDataManagement._tmpTaskDataMap._app[m]=$data(m,0,1)
    })

    for(var n in _aiAPI._curDataNameMap){
      delete $project[n]
      let i=1,j=0
      while($project[n+i]!==undefined||j<5){
        if($project[n+i]===undefined){
          j++
        }else{
          delete $project[n+i]
        }
        i++
      }
    }
    for(var k in $project){
      if(k.match(/^\$(new|edit)/)){
        delete $project[k]
      }
    }
  },
  //1. check bz-stop
  //3. goto flag
  _preHandleParameter:function(p,_type,m){
    if(p&&p.constructor==Object){
      delete p.$bzId
      if(_Util._findValueInObj(p,v=>v=="bz-stop")){
        return "bz-stop"
      }
    }


    m=_aiGeneratorDataHandler._getModuleObject(m)
    let _data={},td=_type=="edit"?$project[_aiGeneratorDataHandler._getCurModuleDataName(m)]:{}
    // if(_type=="add"){
      // let _curData=$project[_aiGeneratorDataHandler._getCurModuleDataName(m)]
      // if(_curData){
        // let _stop=1
        // for(var k in p){
          // if(p[k]!="bz-skip"&&p[k]!="/{random}/"){
            // try{
              // if(_curData[k]!=p[k]&&(!_Util._isRegexData(p[k])||!(new RegExp(p[k].replace(/^\/|\/$/g,"")).match(_curData[k])))){
                // _stop=0
                // break
              // }
            // }catch(e){
              // _stop=0
              // break
            // }
          // }
        // }
        // if(_stop){
          // return $parameter="bz-stop"
        // }
      // }
    // }
    td=td||_Util._clone(p)
    _data[m._data.code]=td
    
    _buildData(p,td)
    Object.assign(p,_data[m._data.code])
    //return _data[m._data.code]
    return p
    //p:parameter, td: current data($curtProduct)
    function _buildData(p,td){
      for(var k in p){
        if(k=="$status"){
          td[k]=p[k]
        }else if(p[k]=="bz-skip"){
        }else if(p[k]&&[Object,Array].includes(p[k].constructor)){
        }else if(!_Util._isRegexData(p[k])){
          td[k]=_aiGeneratorDataHandler._formatDataByField(p[k],k,m);
        }
      }

      if(_aiGeneratorDataHandler._isAIModule(m)){
        for(var k in p){
          if(td[k]!==undefined){
            continue
          }else if(p[k]=="bz-skip"){
            continue
          }
          let f=_aiGeneratorDataHandler._getFieldByBindDataName(k,m)
          if(!f){
            if(!k.match(/^(m[0-9]+|\$[a-z0-9]+)$/i)){
              alert(_bzMessage._api._noField,k)
            }
            continue
          }
          _buildFieldData(p,td,k,f)
        }
      }
    }
    
    function _buildFieldData(p,td,k,f){
      if(f.dependencies&&f.dependencies.length){
        _setValueByDependences(f,p,td,k)
      }else if(f.type=="object"){
        td[k]={}
        f.fields.forEach(ff=>{
          _buildFieldData(p[k],td[k],ff.data,ff)
        })
      }else{
        let t=BZ._getCurTest(),tf=f
        if(t&&t._data.type!="_try"&&!t._data.definition.api){
          tf=_aiGenerator._getTestFieldSettingByTestPath(m._data.code+"."+t._data.code,f)
        }

        p[k]=="bz-skip"?tf.defValue||f.inputFormat:p[k]
        if(_Util._isRegexData(p[k])){
          p[k]=$util.generateWordsByRegex(p[k],f.name)
        }
        td[k]=p[k]=_aiGeneratorDataHandler._formatDataByField(p[k],f)
      }
    }
    
    function _setValueByDependences(f,p,td,k){
      _Util._spliceAll(f.dependencies||[],x=>x.items.find(y=>y.field==f.code));
      
      if(!f.dependencies||!f.dependencies.find(ss=>{
        let s=_aiGeneratorDataHandler._getSuiteDependenceSolution(ss,f.code);
        s.forEach(xx=>{
          xx.forEach(x=>{
            if(x.c.field==f.code){
              return
            }
            let ff=_aiGeneratorDataHandler._getFieldByCode(x.c.field,x.c.module)
            if(ff&&_data[x.c.module]&&_data[x.c.module][ff.data]===undefined){
              _setValueByDependences(ff,p,td,ff.data)
            }
          })
        })
        return s.find(ss=>{
          let dd=_aiGenerator._setDataByDependenceConditionList(ss,_data)
          if(dd){
            _data=dd
            //td=_data[m._data.code]
            Object.assign(p,td)
            if(f.fields){
              td[k]=f.type=="object"?{}:[]
              f.fields.forEach(ff=>{
                _buildFieldData(p[k],td[k],ff.data,ff)
              })
            }else{
              p[k]=td[k]=_aiGeneratorDataHandler._formatDataByField($util.generateWordsByRegex(p[k],k),f)
            }
            return 1
          }
        })
      })){
        td[k]=p[k]="bz-skip"
      }
    }
 },
  //c:"m1.15325345345345" (module code . field code)
  _getFieldByModuleAndFieldCodeRef(c,cm){
    c=(c+"").split(".")
    let mm=c[1]?c[0]:cm
    let m=_aiGeneratorDataHandler._getModuleObject(mm)
    
    let f=_aiGeneratorDataHandler._getFieldByCode(c[1]||c[0],m)
    return {
      code:f.code,
      data:f.data,
      name:f.name,
      inputFormat:f.inputFormat,
      _module:mm,
      _fullData:mm==cm?f.data:_aiGeneratorDataHandler._getCurModuleDataName(m)+"."+f.data
    }
  },
  _getCurDataByModuleCode:function(m){
    let d=_aiAPI._dataMap[m]
    if(!d){
      return 
    }
    if(Object.keys(d).length==1){
      return Object.values(d)[0]
    }
    let dn=_aiGeneratorDataHandler._getCurModuleDataName(m)
    if($project[dn]){
      return $project[dn]
    }
    m=_aiGeneratorDataHandler._getModuleObject(m)
    
    if(m._data.parentModule){
      let p=_aiAPI._getCurDataByModuleCode(m._data.parentModule)
      if(p){
        return p[m._data.code]
      }
    }
  },
  //d: data
  _fillSkipFieldsInCurTest:function(d){
    let dd=$project[_aiGeneratorDataHandler._getCurModuleDataName()]
    BZ._getCurModule()._data.definition.fields.forEach(f=>{
      f=f.data
      if(d[f]===undefined){
        if(dd){
          d[f]=dd[f]===undefined?"bz-skip":dd[f]
        }else{
          d[f]="bz-skip"
        }
      }
    })
  },
  _parseInnerData:function(v){
    if(v&&v.constructor==Object){
      for(var k in v){
        v[k]=_JSHandler._prepareData(v[k])
      }
    }else if(v&&v.constructor==String){
      v=_JSHandler._prepareData(v)
    }
    return v
  },
  _getAllDataOfCurModule:function(){
    let m=_aiGeneratorDataHandler._getModuleObject()
    if(m._data.definition){
      return Object.values(_aiAPI._getSysCtrlDataMap(m))
    }
    return []
  },
  //d: json data, rn: ref-name, mk: module key field name
  _getCurRefModuleData:function(d,rn,mk,_chkValue){
    let v={_finalModule:BZ._getCurModule()._data.code}
    if(d){
      if(!d[rn]||(d[rn]!=_chkValue&&_chkValue)){
        return 0
      }else{
        v[mk]=d[rn]
      }
      return [v]
    }
    return 0
  },
  _getApiExeSolutionByParameter:function(d,m){
    m=_aiGeneratorDataHandler._getModuleObject(m);
    
  },
  _isBaseRequestData:function(d,r,m){
    return _statusManagement._isRequestStatus(d.$status,r.$status,m)
  },
  _retrieveExistData:function(m,f,d){
    try{
      m=_aiGeneratorDataHandler._getModuleObject(m)
      let pm=m._data.parentModule;
      if(pm){
        pm=_getDataFromParent(pm,m._data.code)
      }else{
        pm=_aiAPI._getSysCtrlDataMap(m._data.code)
      }

      for(let k in pm){
        if(d==pm[k][f]){
          return pm[k]
        }
      }
    }catch(e){}
    
    function _getDataFromParent(v,sv){
      let p=_aiGeneratorDataHandler._getCurSysCtrlDataName(v);
      try{
        p=_Util._eval("p="+p)
      }catch(e){}
      if(!p){
        v=_aiGeneratorDataHandler._getModuleObject(v)
        if(v._data.parentModule){
          let vv=_getDataFromParent(v._data.parentModule,v._data.code)
          if(vv){
            let vs={}
            _Util._loopObj(vv,x=>{
              _Util._loopObj(x[sv],(y,k)=>{
                vs[k]=y
              })
            })
            return vs
          }
        }
      }else{
        return p[sv]
      }
      return p
    }
  },
  //***********************************************************************************************************//
  //Note: before a scenario start, all $project.curtData reference are removed in _ideTask._buildFullTestQueue
  //***********************************************************************************************************//
  _getExeSolutionByParameter:function(d,tk,m){
    tk=_aiFlowHandler._getFlowKey(tk);
    m=_aiGeneratorDataHandler._getModuleObject(m);
    let dd={},mc=m._data.code,as=[],
        _status=_statusManagement._getDataStatusByName(d.$status,m),
        _curModuleVarName=_aiGeneratorDataHandler._getCurModuleDataName(),
        _curTestId=Date.now()

    let rs=_aiGenerator._chkConflickRequestDataWithStatusData(_status.id,tk,d,m)
    if(rs){
      throw new Error(_Util._formatMessage(_bzMessage._aiDefinition._comment._conflictData,rs.join(", ")))
    }

    dd[mc]=_Util._clone(d)
    delete dd[mc].$status
    //1. insert all dependencies fields
    for(var k in d){
      if(k!="$status"){
        _setDependenceFields(k,d[k],dd,m)
      }
    }
    _ideReport._logDebug("Scenario data:",d)
    _ideReport._logDebug("---> parameter:",dd)
    
    //2. insert dependencies from other module
    for(var k in dd){
      if(k!=mc){
        if(!_ideObjHandler._isParentModule(mc,k)){
          as.push(_insertThereIs(k,dd[k]))
        }
      }
    }

    //2. get matched data from exist data map
    let _solution=[]

    _getMatchData({
      _parameter:dd[mc]||{},
      _status:_status,
      _ignores:[],
      _finalStatus:_status
    },m,_solution)

    if(_solution.length){
      _buildActions(m,as,_solution)
      try{
        if(_solution[0]._status=="start"&&m._data.definition.initData&&m._data.parentModule){
          if(as.find(a=>a.refOfSuccess.includes(m._data.parentModule+"."))){
            let nt;
            while(as.length){
              let t=as.pop()
              let tm=_ideObjHandler._getDataByPath(t.refOfSuccess)
              if(tm._parent._data.code==m._data.code){
                nt={
                  refOfSuccess:m._data.code+"."+BZ._getCurTest()._data.code,
                  type:4,
                  successParameter:d
                };
              }else if(!_aiAuthHandler._isAuthItem(tm)){
                if(nt){
                  as.push(nt)
                }
                break
              }
            }
          }
        }
      }catch(e){}

      let n=_Util._formatMessage(_bzMessage._aiDefinition._tmpTest,[
        _status.name,
        m._data.name
      ])
      if(as.length){
        as=m._data.code+"."+_ideTestManagement._generateTmpTest(m._data,n,as)
        console.log(as)
        return as
      }
    }

    function _setDependenceFields(f,v,d,m){
      f=_aiGeneratorDataHandler._getFieldByBindDataName(f,m)
      f&&f.dependencies&&f.dependencies.find(x=>{
        if((!v&&["[false]","[enable]",v].includes(x.targetValue))||(v&&["[true]","[enable]",v].includes(x.targetValue))){
          return x.items.find(y=>{
            let ff=_aiGeneratorDataHandler._getFieldByCode(y.field,y.module)
            d[y.module]=d[y.module]||{}
            let fd=d[y.module][ff.data]
            if(fd===undefined){
              if(y.valueType==0){
                fd=""
              }else if(y.valueType==1){
                fd=$util.generateWordsByRegex(ff.inputFormat,ff.name)||"on"
              }else if(["==",">=","<="].includes(y.valueType)){
                fd=y.value
              }else if(y.valueType=="!="){
                fd=""
              }else if(y.valueType=="regex"){
                fd=$util.generateWordsByRegex(y.value,ff.name)
              }else if(y.valueType=="script"){
                try{
                  fd=_Util._eval("fd="+y.value)
                }catch(e){}
              }
              d[y.module][ff.data]=fd
              _setDependenceFields(ff.data,fd,d,y.module)
            }
          })
        }
      })
    }

    function _getMatchData(d,m,_solution){
      let ds=_aiAPI._getSysCtrlDataMap(m)

      let vs=[],s,_opr
      _Util._loopObj(ds,x=>{
        if(_aiAPI._isBaseRequestData(x,{$status:d._status},m)){
          vs.push({
            _data:x,
            _miss:[],
            _status:d._status.name,
            _oprs:[]
          })
        }
      })
      
      if(vs.length){
        for(var k in d._parameter){
          if(!["$status"].includes(k)){
            vs.forEach(x=>{
              if(x._data[k]!=d._parameter[k]){
                x._miss.push(k)
              }
            })
          }
        }
        vs.sort((a,b)=>{
          return a._miss.length-b._miss.length
        })

        if(vs.find(x=>{
          if(!x._miss.find(y=>!d._ignores.includes(y))){
            _opr=x
            return 1
          }else{
            _opr=_Util._clone(x)
            if((d._status.oprs||[]).find(o=>{
              let _match=[]
              
              _Util._spliceAll(_opr._miss,(k=>{
                let kf=_aiGeneratorDataHandler._getFieldByBindDataName(k,m)
                let kk=_aiGenerator._getTestFieldSettingByTestPath(o.test,kf)
                if(!kf.disable&&kk&&!kk.readonly){
                  if(!d._ignores.includes(k)){
                    d._ignores.push(k)
                  }
                  _match.push(k)
                  return 1
                }
              }))
              if(_match.length){
                _opr._oprs.push({o:o,_match:_match})
              }
              if(!_opr._miss.find(y=>!_ignores.includes(y))){
                return 1
              }
            })){
              return 1
            }
          }
        })){
          if(_setRelateData(_opr._data,m)){
            s=1
            
            _solution.unshift(_opr)
          }
        }
      }
      
      if(!s){
        _solution.unshift({
          _status:d._status.id,
          _parameter:d._parameter
        })
        let ss=_aiFlowHandler._getFromStatusByTargetStatus(d._status,m),
            _newList=[];
        ss.find(x=>{
          if(x==d._finalStatus.id){
            return
          }
          if(x=="start"){
            let k=_getCreateSolution(d,m)
            if(k&&k._key==d._status.id){
              _solution.unshift({
                _status:"start",
                _parameter:d._parameter
              })
              return 1
            }else{
              _solution.length=0
            }
          }else{
            let _newSolution=[]
            _getMatchData({
              _parameter:d._parameter,
              _status:_statusManagement._getDataStatusByKey(x,m),
              _finalStatus:d._finalStatus,
              _ignores:_Util._clone(d._ignores)
            },m,_newSolution)
            if(_newSolution.length){
              _newSolution.reverse()
              if(!_newSolution[0]._data){
                let _flow=_aiFlowHandler._getFlowByKey(_newSolution[0]._status+"."+d._status.id,tk,m)
                if(_flow.oprs.find(o=>{
                  return o.data.find(y=>{
                    let f=_aiGeneratorDataHandler._getFieldByCode(y.field,m)
                    let pv=d._parameter[f.data]
                    if(!_isMatchValue(pv,y.value)){
                      return 1
                    }
                  })
                })){
                  return
                }
              }
              _newSolution.forEach(x=>{
                _solution.unshift(x)
              })
              return 1
            }
          }
        })
      }

      return s
    }
    
    function _setRelateData(d,m){
      if(d){
        let pm=m._data.parentModule
        if(pm){
          let pd=_aiAPI._getSysCtrlDataMap(pm)
          
          if(_Util._isEmpty(pd)){
            return
          }
          let pn=_aiGeneratorDataHandler._getCurModuleDataName(pm);
          if($project[pn]){
            let dd=$project[pn][m._data.code]
            if(dd&&dd.$bzId!=d.$bzId){
              dd=Object.values(dd)
              if(!dd.find(x=>x.$bzId==d.$bzId)){
                return 
              }
            }
          }else{
            pd=Object.values(pd)
            pd=pd.find(x=>{
              let dd=pd[m._data.code]
              if(dd&&dd.$bzId==d.$bzId){
                return 1
              }
            })
            if(pd){
              $project[pn]=pd
              pm=_ideObjHandler._getDataByPath(pm)
              if(!pm||!_setRelateData(pd,pm)){
                return
              }
            }else{
              return
            }
          }
        }
        for(let k in d){
          if(k.match(/^m[0-9]+$/)){
            k=_aiGeneratorDataHandler._getCurModuleDataName(k)
            $project[k]=d[k]
          }
        }
        return 1
      }
    }
    
    function _isMatchValue(pv,v){
      if(!pv||pv==v||v=="/{random}/"){
        return 1
      }else if(v.match(/^\/[^\/]\/$/)){
        try{
          return pv.match(new RegExp(v.substring(1,v.length-1)))
        }catch(e){}
      }
    }
    
    function _getCreateSolution(d,m){
      let o=m._data.definition.moduleDataFlow.start.to,ss

      let r=_Util._findInObj(o,(vv,k)=>{
        return vv.find(v=>{
          ss=v
          return 1
        })
      })
      if(r){
        r._value=ss
        return r
      }
    }
    
    function _buildActions(m,as,_solution){
      let _parameter
      _solution.forEach((x,i)=>{
        if(x._data){
          _insertSetCurDataByBZId(m,x._data.$bzId,as)
          x._oprs.forEach(y=>{
            as.push(_insertOprAction(y.o))
          })
        }else{
          if(!_parameter){
            _parameter=_Util._clone(x._parameter||{})
          }
          let _pre=_solution[i-1]
          if(_pre&&_pre._data){
            _pre._status=_statusManagement._getDataStatusByName(_pre._status).id
            _insertSolution(_pre,x,as,_parameter)
          }
          let _next=_solution[i+1]
          if(_next){
            _insertSolution(x,_next,as,_parameter)
          }
        }
      })
    }
    
    function _insertSolution(s1,s2,as,_parameter){
      let _flowKey=s1._status+"."+s2._status
      let _flow=_aiFlowHandler._getFlowByKey(_flowKey,tk)
      _flow.dependencies.forEach(y=>{
        let yy=_aiGenerator._generateScenarioAction(_curTestId,_flowKey,y,"given",1)
        while(as.length){
          let a=as.pop()
          let rv=a.refOfSuccess||""
          if(!rv.startsWith(y.code+".")&&!_aiAuthHandler._isAuthItem(rv)){
            as.push(a)
            break
          }
        }
        as.push(yy)
      })
      
      _aiGenerator._generateAuthAction(_flow,m,"given",1,as)
      
      _flow.oprs.forEach(y=>{
        y=_Util._clone(y)
        if(!_Util._isEmpty(_parameter)){
          _insertParameter(y,_parameter)
        }
        let aa=_aiGenerator._generateScenarioAction(_curTestId,_flowKey,y,"when",1)
        
        as.push(aa)
      });
      (_statusManagement._getDataStatusByKey(s2._status).oprs||[]).forEach(z=>{
        if(!_Util._isEmpty(_parameter)){
          z=_Util._clone(z)
          if(_insertParameter(z,_parameter)){
            as.push(_aiGenerator._generateScenarioAction(_curTestId,_flowKey,z,"given",1))
          }
        }
      });
    }
    
    function _insertInitSolution(){
      
    }
    
    function _insertParameter(d,p){
      let _found
      for(var k in p){
        let f=_aiGeneratorDataHandler._getFieldByBindDataName(k,m)
        if(f&&!f.disable){
          let fs=_aiGenerator._getTestFieldSettingByTestPath(d.test,f);
          if(fs&&!fs.readonly){
            d.data=d.data||[]
            d.data.push({
              field:m._data.code+"."+f.code,
              value:p[k],
              colName:k
            })
            _found=1
            delete p[k]
          }
        }
      }
      return _found
    }
    
    function _insertOprAction(a){
      return {
        type:4,
        refOfSuccess:a.test,
        successParameter:`$aiAPI.getUpdateParameter($aiAPI.getModuleDataById(${_aiAPI._getScenarioTransferDataName(_curModuleVarName,m,_curTestId)}),$parameter)`
      }
    }
    
    function _insertSetCurDataByBZId(m,v,as){
      m=_aiGeneratorDataHandler._getModuleObject(m)
      let pn=_aiGeneratorDataHandler._getCurSysCtrlDataName(m)
      
      as.push({
        description:_Util._formatMessage(_bzMessage._aiDefinition._actionDesc._getMatchData,pn),
        type:3,
        script:pn+` = $aiAPI.getModuleDataById("${v}","${m._data.alias||m._data.code}")`,
        runInIDE:"on",
        method:0
      })
    }

    function _insertThereIs(m,p){
      let h=_aiGenerator._getTestByType(m,"has")
      return {
        type:4,
        refOfSuccess:h,
        successParameter:p
      }
    }
    
  },
}

var _aiGeneratorDataHandler={
  _setInitAIDefinition:function(md){
    md.definition={
      fields:[],
      operations:[],
      contents:[],
      webpages:[],
      relatedModules:[],
      models:[],
      preScript:"function(data, test){\n  return data\n}",
      endScript:"function(data, test){\n  return data\n}",
      moduleDataFlow:{
        start:{
          displayName:_bzMessage._model._stdStatus.start,
          to:0
        },
        1:{
          to:0
        },
        2:{
          to:0
        }
      },
      identifyStatusScript:`function(d){\n return d.$status || "${_bzMessage._model._stdStatus.created}";\n}`,
      moduleDataStatus:[{
        name:_bzMessage._model._stdStatus.created,
        opr:"add",id:1,default:"on"
      },{
        name:_bzMessage._model._stdStatus.deleted,
        opr:"delete",id:2
      }],
      moduleDataTypes:[]
    }
  },
  _getStdPath:function(p,f,_field,c){
    let fp=f.path;
    if(c&&c.formValues){
      let cf=c.formValues[f.code]
      if(cf){
        if(cf.path){
          fp=cf.path
        }else if(cf.pathType=="view"){
          fp=f.view
        }else{
          fp=f.path
        }
      }
    }
    fp=_Util._clone(fp)
    
    if(_Util._isEmpty(fp)){
      while(p&&p.constructor==Array){
        p=p[0]
      }
      return [p||"BZ.TW.document",`:${_field?'input':'link'}(${f.name})`,0]
    }else if(fp.constructor==Array&&fp[0]&&fp[0].includes&&!fp[0].includes("BZ.TW.document")){
      if(p){
        while(p.constructor==Array&&!p[0]&&p.length){
          p=[...p]
          p.shift()
        }
        while(p.constructor==Array&&p[0]&&p[0].constructor==Array){
          p=p[0]
        }
        if(p&&p.constructor==Array){
          p=p.filter(x=>!$.isNumeric(x))
          p.push(...fp)
          fp=p
        }else{
          fp.unshift(p||"BZ.TW.document")
        }
      }
    }
    return fp
  },
  _getOuterOperationBtns:function(t){
    let ms=t._parent._data.definition.models
    let md=_aiModelHandler._getModelByCode(t._data.definition.lanuchPanel,ms)
    let bs=[]
    
    _getExBtnsInModel(md,bs)
    
    function _getExBtnsInModel(md,bs){
      md.items.forEach(b=>{
        if(b.group=="buttons"){
          b=_aiGeneratorDataHandler._getItemByGroupAndCode("buttons",b.code)
          if(b.type=="next"){
            let mmd=_aiModelHandler._getModelByCode(b.lanuchPanel,ms)
            _getExBtnsInModel(mmd,bs)
          }else if(b.type=="outopr"&&b.operation){
            bs.push(b)
          }
        }
      })
    }
    
    return bs

  },
  _getOperationByPanel:function(p){
    let c=_aiGeneratorDataHandler._getContentByCode(p.code||p)
    if(c&&c.from&&c.from[0]){
      return _aiGeneratorDataHandler._getItemByGroupAndCode("operations", c.from[0].code)
    }
  },
  _isAIGenerateTest:function(t,m){
    m=m||_ideObjHandler._getModuleByTest(t)
    
    t=t._data||t
    if(t.code&&t.code[0]=='t'&&_aiGeneratorDataHandler._isAIModule(m)){
      return t.definition
      // t=t.definition
      // return t&&["static","suite","add","has","edit","delete","fieldChecker","clean","execute","testVE"].includes(t.type)
    }
  },
  _isAIModule:function(m){
    m=m||_IDE._data._curModule
    if(m){
      m=m._data||m;
      return !["auth","",null,undefined,"feature"].includes(m.bt)
    }
  },
  //t:type,m:module
  _getRelatedModules:function(t,m,_withGlobalModule){
    m=_aiGeneratorDataHandler._getModuleObject(m)._data
    let vs=[]
    m.definition.relatedModules.forEach(r=>{
      if(r.module&&(!t||r.type==t)){
        vs.push({code:r.module,type:r.type})
      }
    })
    m.definition.fields.forEach(f=>{
      if(f.module&&f.module!=m.code){
//        vs.push({code:f.module+"."+f.code,type:f.type})
        let mm=_aiGeneratorDataHandler._getModuleObject(f.module)
        if(mm&&mm._data.bt=="data"){
          vs.push({code:f.module,type:f.type})
        }
      }
    })
    let p=m.parentModule
    while(p){
      p=_aiGeneratorDataHandler._getModuleObject(p)
      if(p){
        vs.push({
          code:p._data.code,
          type:"parentModule"
        })
        p=p._data.parentModule
      }      
    }
    if(_withGlobalModule){
      _IDE._data._curVersion.modules.forEach(x=>{
        if(x.bt=="setting"||x.bt=="account"){
          vs.push({code:x.code,type:x.bt})
        }
      })
    }
    return vs
  },
  _isProtectedTest:function(t,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    t=t._data||t
    let td=t.definition
    if(td){
      if(td.from){
        return _aiGeneratorDataHandler._getItemByGroupAndCode("contents",td.from,m)
      }else if(!td.code){
        return td.type!="clean"
      }else if((td.code+"").includes(",")){
        td=_aiFlowHandler._getFlowByStatus(td.code)
        if(td){
          return td.find(x=>x.data.scenario==m._data.code+"."+t.code)
        }
      }else{
        return _aiGeneratorDataHandler._getItemByGroupAndCode("operations",td.code,m)
      }
    }
  },
  _getFieldByBindDataName:function(bn,m){
    var fs=[];
    m=_aiGeneratorDataHandler._getModuleObject(m)
    return m._data.definition&&(m._data.definition.fields||[]).find(f=>{
      return f.data==bn&&f.type!="viewData"
    })
  },
  _getBestKeyFieldName:function(m,d){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let k,u,l,id,_name,_key,_ssid;
    if(m._data.definition){
      (m._data.definition.fields||[]).find(x=>{
        if(x.key){
          k=x
          return 1
        }else if(!u&&x.unique){
          u=x
        }else if(!l&&x.label){
          l=x
        }else if(x.data=="id"){
          id=x
        }else if(x.data=="ssid"){
          _ssid=x
        }else if(x.data=="key"){
          _key=x
        }else if(x.data=="name"){
          _name=x
        }
      })
    }else{
      k={data:m._data.keyField}
    }
    return (k||u||l||id||_ssid||_key||_name||{}).data||(d&&(d.id?"id":d.ssid?"ssid":d.key?"key":d.name?"name":d.title?"title":d.lable?"label":""))
  },
  _getKeyField:function(m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    return m._data.definition.fields.find(x=>x.key)
  },
  _getLabelFields:function(m,_noAlert){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    if(!m||!m._data.definition||!m._data.definition.fields){
      return []
    }
    var fs=m._data.definition.fields,kf=[],uq
    for(var i=0;fs&&i<fs.length;i++){
      if(fs[i].label){
        kf.push(fs[i])
      }else if(fs[i].unique||fs[i].key){
        uq=fs[i]
      }
    }
    if(!kf.length&&uq){
      kf.push(uq)
    }
    if(!_noAlert&&!kf.length){
      alert(_bzMessage._aiDefinition._missLabelField)
    }
    return kf
  },
  _getUniqueFields:function(m,_noAlert){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    var fs=m._data.definition.fields,kf=[]
    for(var i=0;fs&&i<fs.length;i++){
      if(fs[i].unique||fs[i].key){
        kf.push(fs[i])
      }
    }
    if(!_noAlert&&!kf.length){
      alert(_bzMessage._aiDefinition._missLabelField)
    }
    return kf
  },
  _getDataFields:function(m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    var fs=m._data.definition.fields,kf=[]
    for(var i=0;fs&&i<fs.length;i++){
      if(fs[i].data){
        kf.push(fs[i])
      }
    }
    return kf
  },
  _getDependenceByCode:function(ds,c){
    for(var i=0;i<ds.length;i++){
      if(ds[i].code==c){
        return ds[i]
      }
    }
  },
  _getModuleObject:function(m){
    m=m||BZ._getCurModule()
    if(m&&(m.constructor==String||m.code)){
      m=m.code||m
      if(m.match(/^(m[0-9]+|com|bug|ctrl)(\.[0-9]+)?$/)){
        let mm=_ideObjHandler._getDataByPath(m)
        if(!mm&&bzTwComm._isExtension()){
          mm=_IDE._data._curVersion.modules.find(x=>x.code==m)
          if(mm){
            mm={
              _data:mm
            }
          }
        }
        m=mm
      }else{
        m=_ideModuleManagement._getItemByAlias(m)
        if(m){
          m=_ideObjHandler._getDataByPath(m.code)
        }
      }
    }
    return m
  },
  _getEnterModuleElements:function(m){
    let es=_aiGeneratorDataHandler._getContentElements("enterModule",m)
    
    es= es||_aiGeneratorDataHandler._getContentElements(["list","table"],m);
    if(!es||!es.length){
      
    }else{
      return es
    }
  },
  _getItemByCode:function(c,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)._data;
    let o;
    _Util._findDeepObj(m.definition,function(v,k,pk,ps,oo){
      if(k=="code"&&v==c){
        o=oo
        return 1
      }
    },1)
    return o
  },
  //m: module, f: field code
  _getFieldByCode:function(f,m){
    try{
      m=_aiGeneratorDataHandler._getModuleObject(m)._data;
      f=(f+"").split(".")
      f=f[1]||f[0]
      return _getSubField(m.definition.fields,f)
    }catch(e){}
    
    function _getSubField(fs,f){
      for(var i=0;i<fs.length;i++){
        let fv=fs[i]
        if(fv.code==f){
          return fv
        }else if(fv.fields){
          fv=_getSubField(fv.fields,f)
          if(fv){
            return fv
          }
        }
      }
    }
  },
  _getDataPathByCode:function(f,m){
    try{
      m=_aiGeneratorDataHandler._getModuleObject(m)._data;
      let ps=_getSubField(m.definition.fields,f,[])
      return ps.map(x=>x.data).join(".")
    }catch(e){}
    
    function _getSubField(fs,f,ps){
      for(var i=0;i<fs.length;i++){
        let fv=fs[i]
        if(fv.code==f){
          ps.push(fv)
          return ps
        }else if(fv.fields){
          let p=[fv]
          p=_getSubField(fv.fields,f,p)
          if(p){
            ps=ps.concat(...p)
            return ps
          }
        }
      }
    }
  },
  _formatDataByField:function(d,f,m){
    if(d&&d!="bz-skip"&&d!="bz-stop"){
      if(f.constructor==String){
        f=_aiGeneratorDataHandler._getFieldByCode(f,m)||_aiGeneratorDataHandler._getFieldByName(f,m)
      }
      if(f){
        if(f.type=="number"){
          d=parseInt(d)
        }else if(f.type=="float"){
          d=parseFloat(d)
        }else if(f.type=="boolean"){
          if(!d||(""+d).match(/^(0|false|off)$/i)){
            d=false
          }else{
            d=true
          }
        }
      }
    }
    return d
  },
  _getFieldByName:function(f,m){
    try{
      m=_aiGeneratorDataHandler._getModuleObject(m)._data;
      return m.definition.fields.find(x=>x.name==f||x.data==f)
    }catch(e){}
  },
  _getParentData:function(d,f,m,_build){
    if(f&&f.parentField){
      let pf=f.parentField.map(x=>_aiGeneratorDataHandler._getFieldByCode(x,m))
      pf.forEach(x=>{
        if(_build&&!d[x.data]){
          d[x.data]={}
        }
        d=(d||{})[x.data]
      })
    }
    return d
  },
  _getDataByField:function(d,f,m){
    if(f){
      d=_aiGeneratorDataHandler._getParentData(d,f,m)
      return (d||{})[f.data]
    }
  },
  _setDataByField:function(d,f,v,m){
    if(f){
      d=_aiGeneratorDataHandler._getParentData(d,f,m,1)
      d[f.data]=v
    }
  },
  _getDependenceField:function(d){
    return _aiGeneratorDataHandler._getFieldByCode(d.field,d.module)
  },
  //m:module, t: type
  _getContentElements:function(t,m){
    m=_aiGeneratorDataHandler._getModuleObject(m);
    if(!m){
      return
    }
    let cs=m._data.definition.contents,es=[],ls=[];
    for(var i=0;cs&&i<cs.length;i++){
      let c=cs[i]
      if(t==c.type||(t.constructor==Array&&t.includes(c.type))){
        es.push(c)
      }
    }
    return es.length?es:0
  },
  _getContentByCode:function(c,m){
    return _aiGeneratorDataHandler._getItemByGroupAndCode("contents",c,m)
  },
  _getContentByType:function(t,m){
    let ts=[]
    m=m&&m.definition?m:_aiGeneratorDataHandler._getModuleObject(m);
    m=m._data||m
    m.definition.contents.forEach(x=>{
      if(x.type==t){
        ts.push(x)
      }
    })
    return ts
  },
  _getItemByGroupAndCode:function(g,c,m){
    if(!m||m.constructor!=Object){
      m=_aiGeneratorDataHandler._getModuleObject(m);
    }
    if(!m){
      return
    }
    m=m._data||m
    let cs;
    if(g.includes("buttons")){
      if(g=="buttons"){
        g=""
      }else{
        g.splice(g.indexOf("buttons"),1)
        g=g.pop()
      }
      if(m.definition.contents.find(cc=>{
        if(cc.type=="form"){
          return cc.buttons&&cc.buttons.find(b=>{
            if(b.code==c){
              g=b
              return 1
            }
          })
        }
      })){
        return g
      }
    }
    if(g=="fields"){
      return _aiGeneratorDataHandler._getFieldByCode(c,m)
    }else if(g){
      return m.definition[g].find(cc=>{
        return cc.code==c||cc[c]||(cc.extra&&cc.extra.code==c)
      })
    }
  },
  _getItemByTestCode:function(c,m){
    m=_aiGeneratorDataHandler._getModuleObject(m);
    
    return m._data.definition.operations.find(v=>{
      if(v.testVE==c||v.testCode==c){
        return 1
      }
    })||m._data.definition.contents.find(v=>{
      if(v.testVE==c||v.testCode==c){
        return 1
      }
    })

  },
  _getContentByExist:function(cm,m){
    var rs=[]
    m=_aiGeneratorDataHandler._getModuleObject(m);
    if(!m){
      return
    }
    m._data.definition.contents.forEach(c=>{
      if(cm[c.code]){
        rs.push(c)
      }
    })
    return rs
  },
  //m:module
  //t:type, return all on empty
  //_subtype: Sub-type
  _getTestsByDefType:function(m,t,_subtype){
    m=_aiGeneratorDataHandler._getModuleObject(m);
    if(!m){
      return
    }
    let cs=m._data.tests,es=[]
    for(var i=0;cs&&i<cs.length;i++){
      let c=cs[i]
      if(c.type=="unit"&&c.definition&&(!t||t.includes(c.definition.type))&&(!_subtype||c.subtype==_subtype)){
        es.push(c)
      }
    }
    if(es.length){
      return es
    }
  },
  //
  _getRefInModule:function(_fromModule,_toModule){
    _fromModule=_aiGeneratorDataHandler._getModuleObject(_fromModule)._data.definition.relatedModules
    _toModule=_aiGeneratorDataHandler._getModuleObject(_toModule)._data.code
    for(var i=0;i<_fromModule.length;i++){
      if(_fromModule[i].code==_toModule){
        return _fromModule[i]
      }
    }
  },
  _getDependenceLoop:function(d,f,_list){
    var ff=_aiGeneratorDataHandler._getDependenceField(d),
        _list=_list||[]
    if(ff){
      var fd=ff.dependencies
      if(fd){
        if(fd.items.find(o=>{
          return o.field==f.code||_aiGeneratorDataHandler._getDependenceLoop(o,f,_list)
        })){
          _list.push(ff)
        }
      }
    }
    if(_list.length){
      _list.push(f)
      return _list
    }
  },
  _getDependencesByField:function(f,dps){
    let ls=[],
        ds=f.dependencies
    for(var i=0;ds&&i<ds.length;i++){
      var dd=ds[i]
      if(!dd.items.find(d=>{
        return !_aiGeneratorDataHandler._getDependenceField(d)
      })){
        if(dps){
          dps.push(dd)
          dd.items.forEach(i=>{
            let ff=_aiGeneratorDataHandler._getDependenceField(i)
            _aiGeneratorDataHandler._getDependencesByField(ff,dps)
          })
        }else{
          ls.push(dd)
        }
      }
    }
    return dps||ls
  },
  _isConflictDependence:function(d1,d2){
    d1._targetValue=d1._targetValue||"[enable]"
    d2._targetValue=d2._targetValue||"[enable]"
    if(((d1._targetValue=="[enable]"||d2._targetValue=="[enable]")&&(d1._targetValue!="[false]"&&d2._targetValue!="[false]"))||d1._targetValue==d2._targetValue){
      if(d1.c.valueType!=d2.c.valueType){
        if(d1.c.valueType==0||d2.c.valueType==0){
          return 1
        }
      }else if(d1.c.valueType=="!="){
      }else if(!"01".includes(d1.c.valueType)){
        if(d1.c.value!=d2.c.value&&d1.c.value&&d2.c.value){
          return 1
        }
      }
    }
  },
  //d: dependency condition, _owner: the dependency belong to, _ownerType: the ownerType(_operation,_field,_content,_module)
  _getSuiteDependenceSolution:function(d,_owner,_ownerType){
    let ws=_getAllDependenceSolutions(d,_owner),
        cfs=[], //conflict list
        _success=[]
    ws.forEach(cs=>{
      //condition map
      let cm={}
      for(var i=0;i<cs.length;i++){
        let c=cs[i]
        if(!cm[c.c.field]){
          cm[c.c.field]=[c]
        }else{
          cm[c.c.field].push(c)
        }
      }
      for(var k in cm){
        let cc=cm[k]
        while(cc.length>1){
          let c=cc.pop()
          if(cc.find(ci=>{
            if(_aiGeneratorDataHandler._isConflictDependence({_targetValue:c.d.targetValue,c:c.c},{_targetValue:ci.d.targetValue,c:ci.c})){
              cfs.push({c1:c,c2:ci})
              return 1
            }
          })){
            return
          }
        }
      }
      _success.push(cs)
    })
    
    if(!_success.length&&_owner){
      return _alert(cfs)
    }
    
    return _success

    function _getAllDependenceSolutions(d,_from,w,ws){
      ws=ws||[]
      if(!w){
        w=[]
        ws.push(w)
      }
      let _continue
      d.items.forEach(v=>{
        if(!w.find(x=>x.c==v)){
          //c:condition, d, dependency, _from: dependency belong to
          w.push({c:v,d:d,_owner:_from})
          _continue=1
        }
      })
      if(!_continue){
        return
      }
      d.items.forEach(v=>{
        let df=_aiGeneratorDataHandler._getDependenceField(v)
        if(df){
          for(var i=0;df.dependencies&&i<df.dependencies.length;i++){
            let dff=df.dependencies[i]
            if(dff.targetValue=="[true]"&&v.valueType==0){
              continue
            }else if(dff.targetValue=="[false]"&&v.valueType!=0){
              continue
            }
            if(!i){
              _getAllDependenceSolutions(dff,df,w,ws)
            }else{
              let ww=Object.assign([],w)
              ws.push(ww)
              _getAllDependenceSolutions(dff,df,ww,ws)
            }
          }
        }
      })
      return ws
    }

    function _alert(cfs){
      var s=_bzMessage._setting._objectLib[_ownerType]._setting+" - "+ _owner.name+":\n\n"
      cfs.forEach((cf,i)=>{
        let f=_aiGeneratorDataHandler._getDependenceField(cf.c1.c)
        s+=cf.c1._owner.name+" => "+f.name+": "+_bzMessage._setting._objectLib._field._valueType[cf.c1.c.valueType]+(!'01'.includes(cf.c1.c.valueType)?","+cf.c1.c.valueType+(cf.c1.c.value||_bzMessage._dataBind._empty):"")+"\n"
        s+="vs\n"
        s+=cf.c2._owner.name+" => "+f.name+": "+_bzMessage._setting._objectLib._field._valueType[cf.c2.c.valueType]+(!'01'.includes(cf.c2.c.valueType)?","+cf.c2.c.valueType+(cf.c2.c.value||_bzMessage._dataBind._empty):"")+"\n"
        if(i){
          s+="---"
        }
      })
      alert(_bzMessage._aiDefinition._dependConflictData,s)
    }
  },
  _validDependences:function(t,d,_parentObj){
    let gs=[],_name;
    if(t=="_field"){
      var f=BZ._data._uiSwitch._curField
      var ds=_aiGeneratorDataHandler._getDependenceLoop(d,f)
      if(ds){
        alert(_bzMessage._aiDefinition._dependLoopError,ds.map(d=>{return d.name}).join(" -> "))
        return
      }
    }
    let ws=_aiGeneratorDataHandler._getSuiteDependenceSolution(d,_parentObj,t)
    if(!ws||!ws.length){
      return
    }
    if(t=="_operation"){
      _aiGeneratorDataHandler._deepValidDependenceForOperation(_parentObj,ws)
    }
    
    return !d.items.find(a=>{
      if((!a.moduleData||a.moduleData=="specialData")){
        var _regMsg=_bzMessage._system._error._requiredField
        if(!a.field&&a.valueType!="script"){
          return alert(_regMsg,_bzMessage._setting._objectLib._field._title)
        }else if(a.valueType===undefined){
          return alert(_regMsg,_bzMessage._setting._objectLib._field._valueTypeTitle)
        }else if(!a.value&&!"01".includes(a.valueType)){
          return alert(_regMsg,_bzMessage._common._value)
        }
      }
    })
  },
  _deepValidDependenceForOperation:function(o,ws){
    if(!o.dependencies||!o.dependencies.length){
      return
    }
    if(!ws){
      ws=[]
      o.dependencies.forEach(d=>{
        let ww=_aiGeneratorDataHandler._getSuiteDependenceSolution(d,o,"_operation")
        if(ww.length){
          ws=ws.concat(ww)
        }
      })
      return _aiGeneratorDataHandler._deepValidDependenceForOperation(o,ws)
    }
    
    let dps=_aiModelHandler._getParentDependenceTree(o),_issues=[];
    while(dps.pds){
      _issues=_chkIssues(dps.pds,dps.f,0,ws,_issues)
      dps=dps.ds
    }

    let fs=_aiGenerator._getPanelFields(o.lanuchPanel)
    fs.forEach(f=>{
      _issues=_chkIssues(f.dependencies,f,fs,ws,_issues)
    })

    if(_issues.length){
      let s=_bzMessage._setting._objectLib._operation._setting+" - "+ o.name+":\n\n"
      _issues.forEach((i,j)=>{
        if(j){
          s+="---\n"
        }
        let f=_aiGeneratorDataHandler._getDependenceField(i.i)
        s+=_Util._formatMessage(_bzMessage._aiDefinition._inDisable,[i.f.name])+"\n"
        s+=f.name+": "+_bzMessage._setting._objectLib._field._valueType[i.i.valueType]+(!"01".includes(i.i.valueType)?","+i.i.valueType+(i.i.value||_bzMessage._dataBind._empty):"")+"\n"
        s+=o.name+": "+_bzMessage._setting._objectLib._field._valueType[i.c.c.valueType]+(!"01".includes(i.c.c.valueType)?","+i.c.c.valueType+(i.c.c.value||_bzMessage._dataBind._empty):"")+"\n"
      })

      alert(_bzMessage._aiDefinition._dependenceCauseDisable+"\n\n"+s)
    }
    return !_issues.length
    
    function _chkIssues(ds,f,fs,ws,_issues){
      let _issue=[]
      if(!ds||!ds.length||ds.find(d=>{
        return d.items.find(i=>{
          if(ws.find(w=>{
            return !w.find(c=>{
              if(c.c.field==i.field){
                let ff=_aiGeneratorDataHandler._getFieldByCode(i.field)
                
                if((!fs||!fs.includes(ff))&& _aiGeneratorDataHandler._isConflictDependence({_targetValue:c.d.targetValue,c:c.c},{_targetValue:d.targetValue,c:i})){
                  _issue.push({f:f,i:i,c:c})
                  return 1
                }
              }
            })
          })){
            _issue.length=0
            return 1
          }
        })
      })){
      }else{
        _issues=_issues.concat(_issue)
      }
      return _issues
    }
  },
  //$curProject
  _getCurModuleDataName:function(m){
    return "$curt"+_aiAPI._getModuleVarName(m)
  },
  //$lastDelProject
  _getlastDelModuleDataName:function(m){
    return "$lastDel"+_aiAPI._getModuleVarName(m)
  },
  //$newProject
  _getNewModuleDataName:function(m){
    return "$new"+_aiAPI._getModuleVarName(m)
  },
  //$editProject
  _getEditModuleDataName:function(m){
    return "$edit"+_aiAPI._getModuleVarName(m)
  },
  //Name: $project.curProject
  _getCurSysCtrlDataName:function(m){
    return "$project."+ _aiGeneratorDataHandler._getCurModuleDataName(m)
  }
}

var _aiActionHandler={
  _generateParameterName:function(t,_parameter){
    var n=_glossaryHandler._getVariableName(t.name)
    return "$module."+n+(_parameter||"")
  },
  //Ref action
  //refresh/load page
  _generateLoadPageAction:function(e,as){
    e={
      type:6,
      loadURL:e.value||e,
      ai:"loadpage"
    }
    as&&as.push(e)
    return e
  },
  _insertOutOpr:function(p,m,as){
    p.items.find(b=>{
      if(b.group=="buttons"){
        b=_aiGeneratorDataHandler._getItemByGroupAndCode("buttons",b.code,m)
        if(b.type=="insert"||(b.operation&&b.lanuchModule&&!b.lanuchModule.split(".")[1])){
          _aiActionHandler._insertExBtnAction(as,b,m)
        }
      }
    })
  },
  _exInsertActions:function(td,m,as,_defParameter,_type){
    td.buttons=td.buttons||[]
    td.buttons.forEach(x=>{
      if(x.type=="ex-insert"){
        let aa=[{
          type:7,
          description:_Util._formatMessage(_bzMessage._action._description._fillForm,x.name),
          ai:`contents:${x.lanuchPanel}`
        },{
          type:1,
          element:x.path,
          event:{
            action:"click",
            type:"mouse"
          },
          ai:`buttons:${x.code},panel:${x.lanuchPanel}`
        }]
        if(x.maybeNoExist){
          aa[1].refOfFailed="s/./"
          aa[1].refOfError="s/./"
          aa[1].failedReaction=1
        }
        
        let pd=_aiGeneratorDataHandler._getContentByCode(x.lanuchPanel,m);
        if(pd.asOneAction){
          aa[0].asOneAction=pd.asOneAction
          aa[0].speed=pd.speed
        }
        let md=_aiModelHandler._getModelByCode(x.lanuchPanel,m);
        _aiGenerator._fillPanel(pd,md,m,aa,_defParameter,_type)
        
        aa.forEach(x=>x.inGroup="on")

        as.push(...aa)
      }
    });
  },
  _insertFormTabActions:function(td,m,as,_defParameter,_type){
    td.buttons.forEach(x=>{
      if(x.type=="form-tab"){
        let aa=[{
          type:7,
          description:_Util._formatMessage(_bzMessage._action._description._fillForm,x.name),
          ai:`contents:${x.lanuchPanel}`
        },{
          type:1,
          element:x.path,
          event:{
            action:"click",
            type:"mouse"
          },
          ai:`buttons:${x.code},panel:${x.lanuchPanel}`
        }]
        let pd=_aiGeneratorDataHandler._getContentByCode(x.lanuchPanel,m);
        let md=_aiModelHandler._getModelByCode(x.lanuchPanel,m);
        _aiGenerator._fillPanel(pd,md,m,aa,_defParameter,_type)
        
        aa.forEach(x=>x.inGroup="on")

        as.push(...aa)
      }
    });
  },
  _insertSubmitAction:function(td,m,_hasInnerPanel,aa,_defParameter,_type){
    if(!td.buttons){
      return
    }
    let as=[]
    //Insert outer operations
    m=_aiGeneratorDataHandler._getModuleObject(m);

    var d,b=td.buttons&&td.buttons.find(i=>{return ["next","confirm","submit"].includes(i.type)}),
        ps=[td.path];

    if(b){
      _aiStepHandler._stepsToActions(b,"preSteps",as,ps,m)
      if(b.type=="confirm"){
        d=_aiActionHandler._insertConfirmAction(b,m,as)
      }else{
        d=_aiActionHandler._generateClickAction(as,b,0,ps,m)
      }
      if(b.type!="next"){
        d.loopData=`(()=>{\n`
                  +`  if($parameter.$ignoreSubmit){\n`
                  +`    delete $parameter.$ignoreSubmit;\n`
                  +`    $project.${_aiGeneratorDataHandler._getCurModuleDataName(m)}= $parameter\n`
                  +`    return "bz-skip"\n`
                  +`  }\n`
                  +`})()`
      }
      if(b.finalPanel){
        d.resultscript="$project.$flag='"+BZ._groupWords([m._data.name,_aiGeneratorDataHandler._getContentByCode(b.finalPanel,m).name])+"'"
      }
      
      _aiStepHandler._stepsToActions(b,"endSteps",as,ps,m)
    }

    //insert next panel 
    if(b&&b.lanuchPanel){
      let cp=_aiGeneratorDataHandler._getContentByCode(b.lanuchPanel,m)
      let mp=_aiModelHandler._getModelByCode(b.lanuchPanel,m._data.definition.models)
      as.unshift({
        type:7,
        description:_Util._formatMessage(_bzMessage._action._description._fillForm,_bzMessage._method._next),
        ai:`contents:${b.lanuchPanel}`
      })
      _aiGenerator._fillPanel(cp,mp,m,as,_defParameter,td.type)
    }
    aa.push(...as)
  },
  _insertExBtnAction:function(as,b,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    _aiStepHandler._stepsToActions(b,"preSteps",as,0,m)
    
    if(b.operation&&b.lanuchModule){
      let ot=_aiGeneratorDataHandler._getItemByGroupAndCode("operations",b.operation,b.lanuchModule)
      let om=_aiGeneratorDataHandler._getModuleObject(b.lanuchModule),
          _varName,_mapLabel=""
      if(ot){
        let p=b.dynamicData?"":b.defValue
        let f=b.lanuchModule.split(".")[1],ff;
        if(f){
          f=_aiGeneratorDataHandler._getFieldByCode(f,m)
        }

        let _group={
          type:7,
          loopData:"",
          ai:"no-setting, Call outer group: "+b.operation,
        },_code
        as.push(_group)
        if(f){
          //Outer call group
          _varName="$parameter."+f.data
          ff=_aiGeneratorDataHandler._getFieldByCode(f.mapLabel,om)
          _mapLabel=', "'+ff.data+'"'
          _code=f.required?"{}":0


          _code=`return ${_varName}||${_code}`

          _group.loopData=`(()=>{\n`
                         +`  if(${_varName}){\n`
                         +`    if($aiAPI.retrieveExistData("${om._data.code}"${_mapLabel},${_varName})){\n`
                         +`      return 0;\n`
                         +`    }\n`
                         +`  }\n`
                         +`  ${_code};\n`
                         +`})()`
        }else{
          if(b.defValue){
            _varName=b.defValue
          }else if(!b.requiredOperation){
            _varName="$project."+_aiGeneratorDataHandler._getCurModuleDataName(b.lanuchModule)
          }else{
            _varName=""
          }
          if(!b.requiredOperation){
            _group.loopData=`(()=>{\n`
                           +`  if(!${_varName} || ${_varName} == 'bz-skip'){\n`
                           +`    return 0;\n`
                           +`  }\n`
                           +`})()`
          }
        }

        _group.description=_Util._formatMessage(_bzMessage._aiDefinition._toGenerateDataByOuterOperation,[om._data.name,ot.name,_varName])
        _aiStepHandler._stepsToActions(b,"preSteps",as,[],0,1)
        let _idx=as.length
        _aiActionHandler._generateClickAction(as,b,0,[],0,1)
        _aiStepHandler._stepsToActions(b,"endSteps",as,[],0,1)
        
        let _flag=BZ._groupWords([om._data.name,_aiGeneratorDataHandler._getContentByCode(ot.lanuchPanel,b.lanuchModule).name]);
        let _setParentData=_aiGeneratorDataHandler._getCurSysCtrlDataName(m)+" = $parameter;\n"
        let _loopData="",_prepareData="",_return;
        if(f){
          _loopData=_flag
                   +_setParentData
                   +`\n$group = $aiAPI.toJSONParameter($group${_mapLabel}${b.parentCtrl?', 1':''})`
        }else{
          if(_varName){
            _flag=`$project.$flag = "${_flag}";\n`;
            if(_varName.includes("$project.")){
              _prepareData=`  let v = Object.assign({}, ${_varName});\n`
              _return=`  return $aiAPI.toJSONParameter(v, 0${b.parentCtrl?', 1':''});\n`
            }else{
              _prepareData=`  ${_varName} = $aiAPI.toJSONParameter(${_varName}, 0${b.parentCtrl?', 1':''});\n`
              _return=`  return ${_varName};\n`
            }
          }else{
            _return =_aiGeneratorDataHandler._getCurModuleDataName(om)
            _return =`  let parameter = $parameter.${_return} || {};\n`
                    +`  if(parameter.constructor != Array){\n`
                    +`    parameter = [parameter];\n`
                    +`  }\n`
                    +`  $util.removeDuplicateData(parameter);\n`
                    +`  parameter.forEach(x=>{\n`
                    +`    x.$asSubForm = true;\n`
                    +`    x.$ignoreSubmit = ${b.parentCtrl?true:false};\n`
                    +`    x.$flag = "${_flag}";\n`
                    +`  })\n`
                    +"  return parameter;\n"
            _flag=""
          }
          _loopData=`(function(){\n`
                   +`  ${(_flag?_flag+"\n  ":"")+_setParentData}`
                   +_prepareData
                   +_return
                   +`})()`
        }
        let d={
          type:4,
          loopData:_loopData,
          refOfSuccess:om._data.code+"."+ot.testCode+"/",
          inGroup:"on",
          successParameter:f?"$group":"$action"
        }
        _aiActionHandler._assignAI(m._data.code,d,b)
        if(_varName){
          d.resultscript=_varName+" = "+_aiGeneratorDataHandler._getCurSysCtrlDataName(om)
          if(f){
            d.resultscript+="."+ff.data+";"
          }
        }else{
          d.resultscript=`$parameter.${om._data.code} = ${_aiGeneratorDataHandler._getCurSysCtrlDataName(om)}`
        }

        as.push(d)
      }
    }else{
      _aiActionHandler._generateClickAction(as,b,0,0,m)
    }
    _aiStepHandler._stepsToActions(b,"endSteps",as,0,m)
    
  },
  _insertConfirmAction:function(p,m,as){
    if(p.confirmMsg){
      let _path=[p.path[0],"BODY:Contains("+p.confirmMsg+")",0]
      if(p.panel&&p.panel[0]){
        let pp=_aiGeneratorDataHandler._getContentByCode(p.panel[0],m).path
        if(pp&&!pp.join(" ").includes(p.confirmMsg)){
          _path=_Util._clone(pp)
          let _idx=_path.pop(),_lastPath;
          if($.isNumeric(_idx)){
            _lastPath=_path.pop()
          }else{
            _lastPath=_idx
          }
          _lastPath+=":Contains("+p.confirmMsg+")"
          _path.push(_lastPath)
        }
      }
      m=_aiGeneratorDataHandler._getModuleObject(m)
      
      let s={
        type:0,
        compareMark:"==",
        method:0,
        content:{
          type:"exist"
        },
        element:_path,
        failedReaction:0,
        loopData:"$parameter&&$parameter.match&&$parameter[0]=='/'?0:1"
      }
      _aiActionHandler._assignAI((p._tmpModule||m._data.code),s,p)
      
      as.push(s)
    }
    return _aiActionHandler._generateClickAction(as,_Util._clone(p),0,[_aiPageHandler._updateElementPathByDemoValue(p.path)],m)
  },
  _assignAI:function(m,s,f,_tab,_detail,_idx){
    let _aiKey="buttons"
    if(f.testCode){
      _aiKey="operations"
    }else if(f.data){
      _aiKey="fields"
    }else if((f.type||"").includes("enter")){
      _aiKey="contents"
    }
    s.ai=`module:${m},${_aiKey}:${f.code},tab:${_tab||""},detail:${_detail||""}${_idx!==undefined?",idx:"+_idx:""}`
  },
  _generateClickAction:function(as,p,c,_panels,m,_inGroup){
    if(p.fakeElement){
      return
    }
    m=_aiGeneratorDataHandler._getModuleObject(m)
    if(_panels){
      _panels.forEach((p,i)=>{
        _panels[i]=_aiPageHandler._updateElementPathByDemoValue(p)
      })
    }
    let s={
      type:1,
      event:{type: "mouse", action: "click"},
      element:_aiPageHandler._updateElementPathByDemoValue(_aiGeneratorDataHandler._getStdPath(_panels,p)),
      panels:_panels,
      qpath:p.qpath,
      max:p.max,
      min:p.min,
      autoDelay:p.autoDelay
    }
    _aiActionHandler._assignAI((p._tmpModule||m._data.code),s,p)
    _aiActionHandler._setAdvElement(s,p)

    if(_inGroup){
      s.inGroup="on"
    }
    if(p.advanced){
      let o=_Util._strToJson(p.advanced)
      if(o&&o.constructor==Object){
        Object.assign(s,o)
      }
    }
    as&&as.push(s)
    return s
  },
  _generateSetAction:function(ss,f,ps,d,m,c){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    if(f.fields){
      return f.fields.forEach(x=>{
        if(!x.disable||!_aiGenerator._isReadonly(x,c)){
          _aiActionHandler._generateSetAction(ss,x,ps,d+"."+x.data,m,c)
        }
      })
    }
    let s= {
      type:1,
      event:{type:"change",value:"{{"+d+"}}",autoBlur:"on"},
      qpath:f.qpath,
      panels:ps,
      ai:"module:"+m._data.code+",fields:"+f.code+",panel:"+c.code,
      max:f.max,
      min:f.min,
      autoDelay:f.autoDelay
    }
    if(!f.fakeElement){
      s.element=_aiPageHandler._updateElementPathByDemoValue(_aiGeneratorDataHandler._getStdPath(ps,f,1,c))
    }
    _aiActionHandler._setAdvElement(s,f)
    ss.push(s)
    return s
  },
  _setAdvElement:function(s,f){
    if(f.maybeNoExist){
      s.refOfError="./s/"
      s.refOfFailed="./s/"
      s.failedReaction=1
    }
    s.loopData=f.preScript
    s.resultscript=f.endScript
    if(f.advanced){
      let o=_Util._strToJson(f.advanced)
      if(o&&o.constructor==Object){
        Object.assign(s,o)
      }
    }
  },
  _generateGroup:function(t,_flow){
    let v=_bzMessage._scenario._group[t]
    return {
      type:7,
      description:v,
      ai:`flow:1,tab:scenario,detail:${t}`,
      groupType:t
    }
  },
  _insertHandleParameterAction:function(o,m,as){
    as.unshift({
      description:_bzMessage._setting._objectLib._handleParameter,
      type:3,
      script:o.handleParameter||_aiActionHandler._getStdHandleParameterScript(o,m._data),
      runInIDE:"on",
      resultscript:"(()=>{\n"
                  +"  if($parameter=='bz-stop'){\n"
                  +"    $result.break = 'bz-stop';\n"
                  +"  }else if($util.isEmptyData($parameter)){\n"
                  +"    $result.status='warning';\n"
                  +"  }\n"
                  +"})()",
      ai:`operations:${o.code},tab:handleParameter`
    })
    if(o.type!="testVE"){
      as.push({
        description:_bzMessage._setting._objectLib._handleData,
        type:3,
        flag:"Handle-data",
        runInIDE:"on",
        script:o.handleData||_aiActionHandler._getStdHandleDataScript(o.type,m._data),
        ai:`operations:${o.code},tab:handleData`
      })
    }
  },
  _getStdHandleParameterScript:function(o,m){
    return `$parameter = $aiAPI.preHandleParameter($parameter,"${o.type}","${m.alias||m.code}");\n`
          +`$util.gotoFlag($parameter.$flag || $project.$flag);\n`
          +`$project.$flag = 0;\n`
  },
  _getStdHandleDataScript:function(t,m){
    if(t=="add"){
      return `$aiAPI.addData($parameter,'${m.alias||m.code}')`
    }else if(t=="delete"){
      return `$aiAPI.deleteData($parameter,'${m.alias||m.code}')`
    }else{
      return "$aiAPI.updateData($parameter)"
      return `$aiAPI.updateData($parameter,'${m.alias||m.code}')`
    }
  }
}

var _aiResultHandler={
  //v:validate role name
  //o:operation definition or test code
  //m: module
  _getAuthValidationResult:function(v,o,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    //o = Test case
    if(o.constructor==String){
      o=_aiGeneratorDataHandler._getItemByTestCode(o,m)
    }
    return o.enableAuth[v]
  },
  _getAuthValidationResultString:function(v,o,m,_resultOnly){
    let _msg=_bzMessage._root._dictionary._options.info
    _msg=_aiResultHandler._getAuthValidationResult(v,o,m)?_msg.success:_msg.fail
    if(!_resultOnly){
      _msg=_Util._formatMessage(_bzMessage._aiDefinition._expectedResult, [_msg])
    }
    return _msg
  },
  _getAuthValidationResultValue:function(v,o,m){
    return _aiResultHandler._getAuthValidationResult(v,o,m)?"success":"failed"
  },
}

var _aiStepHandler={
  //e:definition data
  _getAllSolutionsToElement:function(e,m,_panel,_url){
    m=_aiGeneratorDataHandler._getModuleObject(m);
    if(!m){
      return
    }
    var ps=[],es,ss,_code;
    if(!e.panel&&!_panel){//field
      if(e.from){
        e.from.forEach(f=>{
          var opr=_aiGeneratorDataHandler._getItemByGroupAndCode(["operations","buttons"],f.code,f.module||m._data.code)
          if(!opr){
            opr=_aiGeneratorDataHandler._getContentByCode(f.code,m)
          }
          if(opr){
            ps=_aiStepHandler._getAllSolutionsToElement(opr,f.module||m,0,_url)
            ps.forEach(pp=>{
              pp.push(e)
            })
            if(!ss){
              ss=ps
            }else{
              ps.forEach(pp=>{
                ss.push(pp)
              })
            }
          }
        })
        return ss
      }else{
        if(m._data.definition.startPanel=="url"){
          var _host=BZ._curEnv.items[m._data.defaultHostId].host
          let d={
            type:"followSameURL",
            value:_Util._mergeURL(_host,m._data.rootUrl)
          }
          if(_url){
            d.value=d._quickUrl=_url._quickUrl;
            d._quickFlag=_url._quickFlag
            d._quickType=_url._quickType
          }
          ps.unshift(d)
        }else if(!m._data.definition.startPanel){
          alert(_bzMessage._aiDefinition._missStartPanel,m._data.name)
        }
        return [ps]
      }
    }
    var p=_aiGeneratorDataHandler._getContentByCode(_panel||e.panel[0],m),pps
    p=_Util._clone(p)
    p._tmpModule=m._data.code
    if(!_url&&e.url){
      _url={
        _quickType:e.type,
        _quickUrl:e.url,
        _quickFlag:BZ._groupWords([m._data.name,(_aiGeneratorDataHandler._getContentByCode(e.lanuchPanel,m)||{}).name])
      }
      if(_Util._isEmpty(e.path)&&!e.fakeElement){
        _url.type="follow"
        return [[_url]]
      }
    }
    if(p.module){
      var pp=_aiGeneratorDataHandler._getContentByCode(p.code,p.module)
      pps=_aiStepHandler._getAllSolutionsToElement(pp,p.module,0,_url)
    }else{
      pps=_aiStepHandler._getAllSolutionsToElement(p,m,0,_url)
    }
    pps.forEach(pp=>{
      e=Object.assign({},e)
      e._tmpModule=m._data.code
      pp.push(e)
    })
    
    return pps
  },
  _parseSolutionMap:function(ps){
    let pps=ps,pm=[]
    if(ps[0].constructor==Array){
      ps=[].concat(ps)
      ps.forEach((p,i)=>{
        ps[i]=[].concat(p).reverse()
      })
    }
    for(var i=0;i<ps.length;i++){
      var pi=ps[i],_point=-1,o=[]
      
      ps[i].forEach(v=>{
        if(v.testCode||v._quickFlag||(v.lanuchModule&&v.type=="outopr")){
          o.unshift(v.name||v._quickFlag)
        }
      })

      pm.push({_name:o.join(" → "),_data:pps[i]})
    }
    return pm;
  },
  //for do try only
  _insertDependence:function(p,m,as,_panels,_assignDemoValue){
    if((p.dependencies||[]).length){
      p.dependencies.find(d=>{
        if(d.targetValue!==undefined&&d.targetValue!="[false]"){
          return d.items.find(v=>{
            var f=_aiGeneratorDataHandler._getDependenceField(v)
            if(f){
              let aaa=[]
              _aiStepHandler._insertDependence(f,v.module,as,_panels,_assignDemoValue)
              _aiStepHandler._stepsToActions(f,"preSteps",aaa,_panels)
              let vv
              if(_assignDemoValue){
                vv=_getDemoValue(f)
              }
              if(vv){
              }else if(v.valueType==1){
                vv=f.type=="boolean"?"on":($util.generateWordsByRegex(f.inputFormat,f.name)||"on")
              }else if(v.valueType==0){
              }else if(v.valueType=="regex"){
                vv=$util.generateWordsByRegex(v.value,f.name)
              }else if(v.valueType=="script"){
                try{
                  vv=_Util._eval("vv="+v.value)
                }catch(e){}
              }else if(v.valueType=="!="){
                if(!v.value){
                  vv=$util.generateWordsByRegex(f.inputFormat,f.name)
                }
              }else{
                vv=v.value
              }
              m=_aiGeneratorDataHandler._getModuleObject(m)         
              aaa.push({
                type:1,
                event:{type:"change",autoBlur:"on",value:vv},
                element:_aiPageHandler._updateElementPathByDemoValue(f.path,_assignDemoValue),
                ai:"module:"+m._data.code+",fields:"+p.code+",tab:dependencies",
                qpath:f.qpath
              })
              _aiStepHandler._stepsToActions(f,"endSteps",aaa,_panels)
              
              //NOTE:
              //not push actions into the list directly! 
              //because the dependencies fields maybe not in the last panel
              for(let i=as.length-1;i>=0;i--){
                let a=as[i]
                let p=a._curPanel
                if(p&&p.code){
                  let tm=_aiGeneratorDataHandler._getModuleObject(p._tmpModule);
                  p=_aiModelHandler._getModelByCode(p.code,p._tmpModule);
                  if(p.items.find(x=>{
                    if(x.group=="fields"&&x.code==f.code){
                      if(as[i].event.type=="mouse"){
                        as.splice(i,0,...aaa)
                      }else{
                        as.splice(i+1,0,...aaa)
                      }
                      aaa.forEach(y=>{
                        y._curPanel=a._curPanel
                      })
                      return 1
                    }
                  })){
                    return 1
                  }
                }
              }
              as.push(...aaa)

              return 1
            }
          })
        }
      })
    }
    
    function _getDemoValue(f){
      if(f.demoValue){
        return f.demoValue
      }
      if(f.type.includes("module")&&f.module&&f.mappingKey||f.keyField){
        let m=_aiGeneratorDataHandler._getModuleObject(f.module)
        if(m){
          f=_aiGeneratorDataHandler._getFieldByCode(f.mappingKey||f.keyField,m)
          if(f){
            return f.demoValue
          }
        }
      }
    }
  },
  _parseToActions:function(ps,m,_insertDependence,_assignDemoValue){
    let as=[],_curPanels=[],_lastPanel
    ps.forEach(p=>{
      var pp=p
      var aa=_Util._clone(p);
      if(_aiModelHandler._isPanel(aa)){
        _curPanels.push(aa.path)
        _curPanelName=aa.name
        if(_insertDependence){
          let a=as[as.length-1]
          if(a&&!a._curPanel){
            a._curPanel=_lastPanel||1
          }
          _lastPanel=aa
        }
      }else{
        if(_insertDependence){
          _aiStepHandler._insertDependence(p,m,as,_curPanels,_assignDemoValue)
        }
        let _panelIdx=as.length
        _aiStepHandler._stepsToActions(aa,"preSteps",as,_curPanels,m)
        if(!aa.fakeElement&&aa.code){
          _aiActionHandler._generateClickAction(as,aa,aa.code,_curPanels,m)
        }
        _aiStepHandler._stepsToActions(aa,"endSteps",as,_curPanels,m)
        
        if(aa.panel){
          p=_aiGeneratorDataHandler._getContentByCode(aa.panel[0])
          _aiStepHandler._assignFlag(p,as,_panelIdx,m)
        }
        
        _curPanels=[]
      }
    })
    // _curPanels.forEach(p=>{
      // p=p||{}
      // _aiActionHandler._generateClickAction(as,p,p.code,_curPanels,m)
    // })

    return as
  },
  _assignFlag:function(p,as,_idx,m){
    if(p){
      if(!p.name){
        p=_aiGeneratorDataHandler._getContentByCode(p.code,m)
      }
      if(p&&p.name&&as[_idx]){
        m=_aiGeneratorDataHandler._getModuleObject(m)
        as[_idx].flag=BZ._groupWords([m._data.name,p.name])
      }
    }
  },
  _stepsToActions:function(f,k,as,_curPanels,m,_inGroup){
    let _steps=f[k];
    m=_aiGeneratorDataHandler._getModuleObject(m)
    _steps&&_steps.forEach((s,i)=>{
      s=_Util._clone(s)
      // if(s.event&&s.event.value){
        // let w=_aiPageHandler._updateCodeByWord(s.event.value)
        // if(w!=s.event.value){
          // s.event.value=w
        // }
      // }
      // if(s.element){
        // s.element=_Util._clone(s.element)
      // }
      s.panels=_curPanels
      if(s.maybeNoExist||f.maybeNoExist){
        s.refOfFailed="s/./"
        s.refOfError="s/./"
        s.failedReaction=1
      }
      
      if(s.advanced){
        let o=_Util._strToJson(s.advanced)
        if(o&&o.constructor==Object){
          Object.assign(s,o)
        }
        delete s.advanced
      }
      
      _aiActionHandler._assignAI(m._data.code,s,f,"action",k,i)
      if(_inGroup){
        s.inGroup="on"
      }

      as.push(s)
    })
  },
  _exeSolution:function(ps,_finalElementObj,_enter,_fun){
    var e=ps[0],m=_IDE._data._curModule
    var as=_aiStepHandler._parseToActions(ps,m,m._data.definition.fields.includes(_finalElementObj),1)
    as.forEach(a=>{
      if(a.element){
        a.element=_aiPageHandler._updateElementPathByDemoValue(a.element,1)
      }
    })
    e.type="followSameURL"

    m=_aiGeneratorDataHandler._getModuleObject(e._tmpModule||m)

    e.value=_aiGenerator._getOperationUrl(e._quickUrl||e.value||"",m)
    e.value=_aiPageHandler._updateByDemoValue(e.value)
    _ideTask._tryClickElements(as,e,_finalElementObj,_enter,_fun)
  }
}

var _testCaseBodyHandler={
  _map:{
    suite:"_mainSuite",
    tmp:"_tmpTestCase"
  },
  _getTest:function(m,n,dt,t,st){
    m=m._data||m
    return {
      name:n,
      enterPoint:{type:"follow",value:m.rootUrl},
      hostId:m.defaultHostId,
      type:t,
      subtype:st,
      definition:{type:dt}
    }
  },
  _getAIInitTests:function(m){
    
    return [
      _testCaseBodyHandler._getTest(m,_bzMessage._aiDefinition._mainSuite,"suite","int"),
      _testCaseBodyHandler._getTest(m,_Util._formatMessage(_bzMessage._aiDefinition._has,m.name),"has","unit","ctrl")
    ]
  },
  _getClearData:function(m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    return {
      name:_bzMessage._aiDefinition._cleanData,
      enterPoint:{
        type:"followSameURL",
        value:m._data.rootUrl
      },
      hostId:m.defaultHostId,
      type:"unit",
      // loopData:{loopStart:0,loopValue:"$module.clean"},
      loopData:{},
      definition:{type:"clean"}
    }
  },
  //o: definition object
  //dt: definition type (testVE), 
  //m: module
  _getValidation:function(o,dt,m){
    m=!m||m.constructor==String?_aiGeneratorDataHandler._getModuleObject(m):m
    m=m._data||m
    return {
      name:o[dt],
      enterPoint:{
        type:"follow",
        value:m.rootUrl
      },
      hostId:m.defaultHostId,
      type:"unit",
      subtype:"validation",
      definition:{type:dt,from:o.code},
      tag:_bzMessage._aiDefinition._validTag
    }
  }
};var _aiModelHandler={
  _buildMissingTest:function(m,_fun){
    let os=[],vs=[],fs=[]
    m.definition.operations.forEach(o=>{
      if(!_ideObjHandler._getDataByPath(m.code+"."+o.testCode)){
        os.push(o)
      }
    })
    m.definition.contents.forEach(o=>{
      if(o.testVE){
        if(!_ideObjHandler._getDataByPath(m.code+"."+o.testVE)){
          vs.push(o)
        }
      }
    })
    for(let k in m.definition.moduleDataFlow){
      let f=m.definition.moduleDataFlow[k]
      for(let kk in f.to){
        let ff=f.to[kk]
        ff.forEach(x=>{
          x=x.data.scenario
          if(!_ideObjHandler._getDataByPath(x.code)){
            let s1=_IDE._data._curModule._data.definition.moduleDataStatus.find(y=>y.id==k),
                s2=_IDE._data._curModule._data.definition.moduleDataStatus.find(y=>y.id==kk)
            
            if(!s2){
              return
            }
            let _tag=s2.opr,_name
            if(s1){
              _name=_Util._formatMessage(_bzMessage._aiDefinition._scenarioName[_tag],[s1.name,s2.name])
            }else if(k!="start"){
              return
            }else{
              if(kk==1){
                _name=_Util._formatMessage(_bzMessage._aiDefinition._scenarioName.add,[m.name])
              }else{
                _name=_Util._formatMessage(_bzMessage._aiDefinition._scenarioName.add2,[m.name,s2.name])
              }
            }
            
            fs.push({
              o:x,
              _name:_name,
              _tag:_tag,
              _code:k+"."+kk+"."+x.key
            })
          }
        })
      }
    }

    _buildTest(os,function(){
      _buildValidation(vs,function(){
        _buildFlow(fs,function(){
          _fun()
        })
      })
    })
    
    function _buildTest(os,_fun){
      let o=os.shift()
      if(o){
        let t=_ideTestManagement._getItemByName(o.name,m)
        if(t){
          o.testCode=t.code
          _buildTest(os,_fun)
        }else{
          _ideTestManagement._save({
            name:o.name,
            subtype:"operation",
            tag:o.type,
            type:"unit",
            dataMap:[],
            actions:[],
            definition:{
              code:o.code
            },
            enterPoint:{type:"follow"},
            speed:100,
            loopData:{}
          },m,function(t){
            o.testCode=t.code
            _buildTest(os,_fun)
          })
        }
      }else{
        _fun()
      }
    }
    function _buildValidation(os,_fun){
      let o=os.shift()
      if(o){
        let _name=_Util._formatMessage(_bzMessage._aiDefinition._validationName,[m.name+ ' - '+o.name])
        let t=_ideTestManagement._getItemByName(_name,m)
        if(t){
          o.tetVE=t.code
          _buildValidation(os,_fun)
        }else{
          _ideTestManagement._save({
            name:_name,
            subtype:"validation",
            tag:"Validation",
            type:"unit",
            dataMap:[],
            actions:[],
            definition:{
              type:"testVE",
              from:o.code
            },
            enterPoint:{type:"follow"},
            speed:100,
            loopData:{}
          },m,function(t){
            o.tetVE=t.code
            _buildValidation(os,_fun)
          })
        }
      }else{
        _fun()
      }
    }
    function _buildFlow(os,_fun){
      let o=os.shift()
      if(o){
        let t=_ideTestManagement._getItemByName(o._name,m)
        if(t){
          o.o.code=m.code+"."+t.code
          _buildFlow(os,_fun)
        }else{
          _ideTestManagement._save({
            name:o._name,
            tag:o._tag,
            type:"scenario",
            dataMap:[],
            actions:[],
            definition:{
              code:o._code
            },
            enterPoint:{type:"follow"},
            speed:100,
            loopData:{
                "loopStart": 0,
                "loopValue": "$test.data"
            }
          },m,function(t){
            o.o.code=m.code+"."+t.code
            _buildFlow(os,_fun)
          })
        }
      }else{
        _fun()
      }
    }
  },
  _getFieldRefTimes:function(f){
    let n=0
    _IDE._data._curModule._data.definition.models.forEach(x=>{
      x.items.find(y=>{
        if(y.code==f.code&&y.group=="fields"){
          n++
        }else if(y.items){
          y.items.find(z=>{
            if(z.code==f.code&&z.group=="fields"){
              n++
            }
          })
        }
      })
    })
    return n
  },
  _getPanelFromObj:function(p,md){
    if(!p){
      return
    }
    p=md.contents.find(x=>x.code==p)
    if(p.from[0]){
      p=p.from[0].code
      md.operations.find(o=>{
        if(o.code==p){
          p=o
          return 1
        }
      })||md.contents.find(o=>o.buttons&&o.buttons.find(y=>{
        if(y.code==p){
          p=y
          return 1
        }
      }));
      return p
    }
  },
  _assignNewPanelPos:function(_fromModel,md,p){
    let fp=(md.contents.find(x=>x.code==p.code)||{}).from||[]
    
    let s=_fromModel.items.filter(x=>["operations","enterDetails"].includes(x.group)&&!fp.find(y=>y.code==x.code))
    s=s.pop()
    
    if(!p.x){
      p.x=parseInt(_fromModel.x)+250+"px"
    }else{
      p.x=parseInt(p.x)+parseInt(_fromModel.x)+"px"
    }
    if(!s){
      let y=0;
      md.models.forEach(x=>{
        if(x.x==p.x){
          if(parseInt(y)<parseInt(x.y)){
            y=x.y
          }
        }
      })
      if(y){
        p.y=parseInt(y)+200+"px"
      }else{
        p.y="50px"
      }
    }else{
      s=md[s.group].find(x=>x.code==s.code);
      s=md.models.find(y=>y.code==s.lanuchPanel)
      p.y=parseInt(p.y||0)+parseInt(s.y)+s.items.length*30+30+"px"
    }
    
    let pp=_aiModelHandler._getItemPanelModel(md,_fromModel.code,1)
    if(pp&&pp!=_fromModel){
      _aiModelHandler._assignNewPanelPos(pp,md,p)
    }
  },
  _isSubModuleRootModel:function(o){
    let m=_IDE._data._curModule._data
    let mm=m.definition.models[0]
    return m.parentModule&&(o==mm||o==mm.code)
  },
  _buildTmpParameter:function(m){
    if(!BZ._isPlaying()&&!BZ._isPausing()){
      m=_aiGeneratorDataHandler._getModuleObject(m)
      let d={}
      m._data.definition.fields.forEach(x=>{
        d[x.data]=x.inputFormat
      })
      window.$parameter=d
      window.$project=window.$project||$data()
      _IDE._data._curVersion.modules.forEach(m=>{
        if(m.bt=="data"){
          let k=_aiGeneratorDataHandler._getCurModuleDataName(m)
          $project[k]={}
          m.definition.fields.forEach(x=>{
            $project[k][x.data]=x.demoValue||x.inputFormat
          })
        }
      })

      $util.getCurEnvironment().items.forEach((v,i)=>{
        _ideTask._setTmpUser(i)
      })
    }
  },
  _doBatchUpdateField:function(){
    let _uiSwitch=BZ._data._uiSwitch,
        k=_uiSwitch._batchUpdateType,
        _from=_uiSwitch._batchUpdateFrom,
        _clone,
        fs=_IDE._data._curModule._data.definition.fields,
        to=_uiSwitch._batchUpdateTo;

    if(['path','inputFormat','outputFormat','preSteps','endSteps','dependencies'].includes(k)){
      _clone=fs.find(f=>f.code==_uiSwitch._batchUpdateClone)
    }else if(['fakeElement','disable','type','required'].includes(k)){
      _from=""
    }
    if(!_clone&&!_from&&!_uiSwitch._batchUpdateTo&&!['fakeElement','disable','required'].includes(k)){
      _Util._confirmMessage(_Util._formatMessage(_bzMessage._model._confirmReplaceToEmpty,_bzMessage._setting._objectLib[k]||_bzMessage._setting._objectLib._field[k]),[{
        _click:function(c){
          c._ctrl._close()
          _doIt()
        }
      }])
    }else{
      _doIt()
    }

    function _setStdValue(){
      if(!_from&&['path','preSteps','endSteps','dependencies'].includes(k)){
        to=[]
      }else if(!to){
        to=""
      }else if(['fakeElement','disable','required'].includes(k)){
        to="on"
      }
      if(_Util._isRegexData(_from)){
        _from=_Util._eval(_from+"="+_from)
      }
    }

    function _doIt(){
      _setStdValue()
      _IDE._data._curModule._selectedFields.forEach(f=>{
        f=fs.find(x=>x.code==f)
        let too=to
        if(too=="#name"){
          too=f.name
        }else if(too=="#data"){
          too=f.data
        }else if(too=="#type"){
          too=f.type
        }
        let v=f[k]
        if(_clone){
          v=_Util._clone(_clone[k])
          if(_from){
            v=_replace(v,_from,too)
          }
        }else if(_from){
          v=_replace(v,_from,too)
        }else{
          v=too
        }
        f[k]=v
      })
      _ideModuleManagement._save()
    }

    function _replace(v,_from,to){
      if(v){
        if(v.constructor==Array){
          v.forEach((x,i)=>{
            if(x&&x.constructor==String){
              v[i]=x.replace(_from,to)
            }
          })
        }else{
          v=v.replace(_from,to)
        }
      }
      return v
    }
    
  },
  _doBatchUpdate:function(_this,_isFieldDataName){
    if(_this._oldValue==_this.value){
      return
    }
    let o=_isFieldDataName?_this._oldValue:"$project.$curt"+_Util._toCapitalWord(_this._oldValue),
        n=_isFieldDataName?_this.value:"$project.$curt"+_Util._toCapitalWord(_this.value);
    if(!o){
      _this._oldValue=_this.value
      return
    }else if(!n){
      return
    }
    let _list=_isFieldDataName?_aiModelHandler._getRefDataModules(o):_aiModelHandler._getRefCodeModule(o)
    if(_list.length){
      _Util._confirmMessage({
        _tag:"div",
        _items:[
          {
            _tag:"div",
            _text:function(){
              return _Util._formatMessage(_bzMessage._model._updataRefData,[o,n])
            }
          },
          {
            _tag:"hr"
          },
          {
            _tag:"div",
            _text:"_data._idx+1+'. '+_data._item.name",
            _dataRepeat:_list
          }
        ]
      },[{
        _title:_bzMessage._method._done,
        _click:function(c){
          if(_isFieldDataName){
            _aiModelHandler._updateRefData(o,n,0,_list,function(){
              _this._oldValue=_this.value
              c._ctrl._close()
            })
          }else{
            _aiModelHandler._updateRefCode(o,n,_list,function(){
              _this._oldValue=_this.value
              c._ctrl._close()
            })
          }
        }
      }])
    }else{
      _this._oldValue=_this.value
    }
  },
  _updateRefData:function(o,n,m,_list,_fun){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let mn=_aiGeneratorDataHandler._getCurModuleDataName(m);
    _loop()
    function _loop(){
      let x=_list.pop()
      if(x){
        if(x.code==m._data.code){
          _replaceValue(x.definition||{},`$parameter.${o}`,`$parameter.${n}`)
        }
        _replaceValue(x.definition,`$project.${mn}.${o}`,`$project.${mn}.${n}`)
        _ideModuleManagement._save(x,function(){
          _loop()
        },1)
      }else{
        _fun()
      }
    }
    
    function _replaceValue(d,ov,nv){
      if(d){
        if(d.constructor==Object||d.constructor==Array){
          for(let k in d){
            d[k]=_replaceValue(d[k],ov,nv)
          }
        }else if(d.constructor==String){
          d=d.split(ov)
          let w=d.shift()
          d.forEach(x=>{
            if(!x||!_Util._removeSign(x[0])){
              w+=nv
            }else{
              w+=ov
            }
            w+=x
          })
          d=w
        }
      }
      return d
    }
  },
  _getRefDataModules:function(o,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    
    let _list=[],
        mn=_aiGeneratorDataHandler._getCurModuleDataName(m);

    _IDE._data._curVersion.modules.forEach(x=>{
      if(x.code==m._data.code){
        if(_findValue(x.definition||{},`$parameter.${o}`)){
          _list.push(x)
          return
        }
      }
      if(x.bt=="data"&&x.definition){
        if(_findValue(x.definition,`$project.${mn}.${o}`)){
          _list.push(x)
        }
      }
    })
    
    return _list
    
    function _findValue(d,ov){
      if(d){
        if(d.constructor==Object||d.constructor==Array){
          for(let k in d){
            if(_findValue(d[k],ov)){
              return 1
            }
          }
        }else if(d.constructor==String){
          d=d.split(ov)
          d.shift()
          return d.find(x=>{
            if(!x||!_Util._removeSign(x[0])){
              return 1
            }
          })
        }
      }
    }
  },
  _updateRefCode:function(o,n,_list,_fun){
    _loop()
    function _loop(){
      let x=_list.pop()
      if(x){
        _replaceValue(x.definition||{},o,n)

        _ideModuleManagement._save(x,function(){
          _loop()
        },1)
      }else{
        _fun()
      }
    }
    
    function _replaceValue(d,ov,nv){
      if(d){
        if(d.constructor==Object||d.constructor==Array){
          for(let k in d){
            d[k]=_replaceValue(d[k],ov,nv)
          }
        }else if(d.constructor==String){
          d=d.split(ov)
          let w=d.shift()
          d.forEach(x=>{
            if(!x||!_Util._removeSign(x[0])){
              w+=nv
            }else{
              w+=ov
            }
            w+=x
          })
          d=w
        }
      }
      return d
    }
  },
  _getRefCodeModule:function(o){
    let _list=[]

    _IDE._data._curVersion.modules.forEach(x=>{
      if(x.bt=="data"&&x.definition){
        if(_findValue(x.definition,o)){
          _list.push(x)
        }
      }
    })
    
    return _list
    
    function _findValue(d,ov){
      if(d){
        if(d.constructor==Object||d.constructor==Array){
          for(let k in d){
            if(_findValue(d[k],ov)){
              return 1
            }
          }
        }else if(d.constructor==String){
          d=d.split(ov)
          d.shift()
          return d.find(x=>{
            if(!x||!_Util._removeSign(x[0])){
              return 1
            }
          })
        }
      }
    }
  },
  _storeRelatedModules:function(ns,_fun){
    let _curModule=_aiGeneratorDataHandler._getModuleObject()._data;
    let md=_curModule.definition
    _ideModuleManagement._batchCreate(ns,0,function(){
      _buildSuiteTests(ns,0,function(){
        md.relatedModules.forEach(r=>{
          var rr=_aiModelHandler._getModelByCode(r.lanuchPanel)
          if(rr){
            rr.module=r.module
          }
        })
        _fun(ns)
      })
    })
    
    function _buildSuiteTests(ns,i,_fun){
      if(ns[i]){
        var sm=_ideModuleManagement._getItemByName(ns[i].name);
        
        return _ideTestManagement._batchCreate(
          _testCaseBodyHandler._getAIInitTests(sm),sm,0,
          function(){
            _buildSuiteTests(ns,i+1,_fun)
          }
        )
      }
      BZ._setHash(_curModule.code)
      md.relatedModules.forEach(m=>{
        if(m.name){
          m.module=_ideModuleManagement._getItemByName(m.name).code
          delete m.name
        }
      })
      _fun()
    }
   
  },
  _saveNewOpr:function(v,_fun){
    v.alias=v.type
    let _curModule=_aiGeneratorDataHandler._getModuleObject()._data;
    let ts=[],t;
    v.name=BZ._nameFormat(v.name)
    v=_aiModelHandler._insertNewModelItemIntoCurPanel("operations",v)
    if(v){
      let _tag=_bzMessage._root._dictionary._options.operation[v.type]
//******************Generate main function test case*************************//
      if(!_aiGenerator._prepareNewTest(v.name,{
        name:v.name,
        enterPoint:{type:"follow"},
        type:"unit",
        subtype:"operation",
        tag:_tag,
        hostId:_curModule.defaultHostId,
        definition:{code:v.code}
      },ts)){
        return alert(_bzMessage._system._error._duplicateName,v.name)
      }
      v.testCode=v.name
      Object.assign(v,{
        level:v.type=="add"?"module":"data",
        endSteps:[]
      })
//---------------------------------------------------------------------------//

      var gs=["testCode"]

      _ideTestManagement._batchCreate(
        ts,_curModule,0,function(){
          gs.forEach(w=>{
            if(v[w]){
              t=_ideTestManagement._getItemByName(v[w])
              if(t){
                v[w]=t.code
              }
            }
          })
          _fun(t)
        }
      )
    }else{
      _fun(t)
    }
  },
  _createOpr:function(_fun){
    let d=_CtrlDriver._buildProxy({
      code:Date.now(),
      path:[],
      type:"edit"
    })
    _Util._confirmMessage({
      _tag:"div",
      _data:d,
      _items:[
        {
          _tag:"div",
          _attr:{
            class:"input-group"
          },
          _items:[
            {
              _tag:"label",
              _attr:{
                class:"input-group-addon required"
              },
              _text:"_bzMessage._common._type"
            },
            {
              _tag:"select",
              _after:function(o){
                setTimeout(()=>{
                  $(o).change()
                },10)
              },
              _attr:{
                class:"form-control",
                required:1
              },
              _dataModel:"_data.type",
              _items:[
                {
                  _tag:"option",
                  _attr:{
                    value:"_data._item"
                  },
                  _text:"_bzMessage._setting._objectLib._options.operation[_data._item]",
                  _dataRepeat:["add","edit","delete"]
                }
              ],
              _jqext:{
                change:function(){
                  d.name=_Util._toCapitalWord(_Util._formatMessage(_bzMessage._aiDefinition._oprName,[_bzMessage._setting._objectLib._options.operation[this.value],_IDE._data._curModule._data.name]))
                }
              }
            }
          ]
        },
        {
          _tag:"div",
          _attr:{
            class:"input-group"
          },
          _items:[
            {
              _tag:"label",
              _attr:{
                class:"input-group-addon required"
              },
              _text:"_bzMessage._common._name"
            },
            {
              _tag:"input",
              _attr:{
                required:1,
                class:"form-control"
              },
              _dataModel:"_data.name"
            }
          ]
        }
      ]
    },[{
      _title:_bzMessage._method._save,
      _click:function(c){
        if(!d.name){
          return alert(_bzMessage._system._error._requiredField,_bzMessage._common._name)
        }
        if(!d.type){
          return alert(_bzMessage._system._error._requiredField,_bzMessage._common._type)
        }
        _aiModelHandler._saveNewOpr(d,_fun)
        c._ctrl._close()
      },
    }],_bzMessage._method._createOpr)
  },
  _saveNewDepModule:function(m,ns,_fun){
    let md=_IDE._data._curModule._data.definition,
        rm=_ideModuleManagement._getItemByName(m.name),
        _curModule=_aiGeneratorDataHandler._getModuleObject()._data;
    let _curPanel;
    if(BZ._userHabit.curUIModelTab=="flow"){
      let t=md.models[0]
      if(t.module){
        t=md.models[1]||t
      }
      _curPanel=t.code
    }else{
      _curPanel=BZ._data._uiSwitch._curModelPanel.code
    }
    if(rm){
      if(m.type!="modulesub"||(rm.parentModule==_curModule.code&&m.type=="modulesub")){
        m.module=rm.code
        if(rm.definition.relatedModules.find(x=>{
          if(x.type=="parentModule"){
            x.module=_curModule.code
          }
        })){
          rm.definition.relatedModules.push({
            module:_curModule.code,
            type:"parentModule",
            code:_aiAPI._newId()
          })
        }
        let mo=rm.definition.models
        mo[0].module=_curModule.code
        mo.find(x=>{
          if(x.type=="enterModule"){
            x.from=x.from||[]
            
            x.from[0].module=_curModule.code
            m.lanuchPanel=x.code
            return 1
          }
        })

        rm.definition.contents.find(c=>{
          if(c.code==mo[0].code){
            c.module=_curModule.code
            return 1
          }
        })
        // _updateModules.push(rm)
      }else{
        o.relatedModules.pop()
        alert(_bzMessage._system._error._duplicateName,m.name)
        return
      }
    }
    m=_aiModelHandler._insertNewModelItemIntoCurPanel("relatedModules",m)

    //build module
    if(m&&!m.module){
      var nm={
        name:m.name,
        alias:_glossaryHandler._getVariableName(m.name),
        rootUrl:_curModule.rootUrl,
        defaultHostId:_curModule.defaultHostId,
        bt:"data"
      }

      var _panel=md.contents.pop()
      var _startPanel={
        code:_curPanel,
        module:_curModule.code
      }
      var _enter={
        type:"enterModule",
        code:m.code,
        lanuchPanel:_panel.code,
        panel:[_curPanel],
        path:m.path,
        qpath:m.qpath,
        preSteps:[],
        name:_bzMessage._model._enter._options.enterModule
      };
      _aiGeneratorDataHandler._setInitAIDefinition(nm)
      
      nm.definition.models=[
        //outer panel (as start panel for submodule)
        {
          code:_curPanel,
          module:_curModule.code,
          group:"contents",
          items:[
            {
              code:_enter.code,
              group:"contents",
            }
          ],
          x:"50px",
          y:"50px"
        },
        {
          from:[{code:_enter.code,module:_curModule.code}],
          code:_panel.code,
          group:"contents",
          items:[],
          x:"300px",
          y:"80px"
        }
      ]
      nm.definition.contents=[_startPanel,_enter,_panel]
      nm.definition.relatedModules=[{module:_curModule.code,type:"parentModule",code:_aiAPI._newId()}]

      if(m.type=="modulesub"){
        nm.parentModule=_IDE._data._curModule._data.code;
        nm.definition.startPanel=_curPanel
      }else{
        nm.definition.relatedModules[0].type=m.type
      }
      ns&&ns.push(nm)
      if(_fun){
        _aiModelHandler._storeRelatedModules([nm],function(d){
          _fun(d)
        })
      }
    }
  },
  _createDepModule:function(_fun){
    let d=_CtrlDriver._buildProxy({
      code:Date.now(),
      path:[],
      type:"edit"
    })
    _Util._confirmMessage({
      _tag:"div",
      _data:d,
      _items:[
        {
          _tag:"div",
          _attr:{
            class:"input-group"
          },
          _items:[
            {
              _tag:"label",
              _attr:{
                class:"input-group-addon required"
              },
              _text:"_bzMessage._common._type"
            },
            {
              _tag:"select",
              _attr:{
                class:"form-control",
                required:1
              },
              _dataModel:"_data.type",
              _items:[
                {
                  _tag:"option",
                  _attr:{
                    value:"_data._key"
                  },
                  _text:"_data._item",
                  _dataRepeat:_bzMessage._model._module._options
                }
              ]
            }
          ]
        },
        {
          _tag:"div",
          _attr:{
            class:"input-group"
          },
          _items:[
            {
              _tag:"label",
              _attr:{
                class:"input-group-addon required"
              },
              _text:"_bzMessage._common._name"
            },
            {
              _tag:"input",
              _attr:{
                required:1,
                class:"form-control"
              },
              _dataModel:"_data.name"
            }
          ]
        }
      ]
    },[{
      _title:_bzMessage._method._save,
      _click:function(c){
        if(!d.name){
          return alert(_bzMessage._system._error._requiredField,_bzMessage._common._name)
        }
        if(!d.type){
          return alert(_bzMessage._system._error._requiredField,_bzMessage._common._type)
        }
        _aiModelHandler._saveNewDepModule(d,0,_fun)
        c._ctrl._close()
      },
    }],_bzMessage._method._createOpr)
  },
  _deleteDataStatus:function(_idx){
    _Util._confirmMessage(_bzMessage._system._info._confirmDelete,[{
      _title:_bzMessage._method._delete,
      _class:"btn-warn",
      _click:function(c){
        let d=_IDE._data._curModule._data.definition
        let s=d.moduleDataStatus.splice(_idx,1)[0]

        delete d.moduleDataFlow[s.id]
        for(var k in d.moduleDataFlow){
          let td=d.moduleDataFlow[k]
          if(td.to){
            delete td.to[s.id]
            if(_Util._isEmpty(td.to)){
              td.to=0
            }
          }
        }
        _ideModuleManagement._save()
        
        c._ctrl._close()
      }
    }])
  },
  _isRelatable:function(p,r){
    p=_ideObjHandler._getDataByPath(p)
    r=_ideObjHandler._getDataByPath(r)
    if(p&&r){
      p=p._data
      r=r._data
      if(!r.parentModule||p.parentModule==r.parentModule||p.code==r.parentModule){
        return 1
      }else{
        r=r.parentModule
        
        let rr=_ideObjHandler._getDataByPath(r)
        if(rr&&rr._data.parentModule){
          if(_aiModelHandler._isRelatable(p.code,r)){
            return 1
          }else if(p.parentModule){
            return _aiModelHandler._isRelatable(p.parentModule,r)
          }
        }
      }
    }
  },
  _openModuleSetting:function(_fun){
    if(!_aiModelHandler._moduleSettingWin||_aiModelHandler._moduleSettingWin.closed){
      _aiModelHandler._moduleSettingWin=_Util._popWin("","_moduleModelSettingPanel",0,650,650,_ideModuleModelSettingViewDef);
    }
    _aiModelHandler._moduleSettingWin.focus()
    _fun&&_fun(_aiModelHandler._moduleSettingWin)
  },
  //for checking ui
  _isDisableByDependence:function(f,_setCurValue){
    var ds=BZ._data._uiSwitch._modelsDependences||{},
        dps=f.dependencies
    
    if(dps&&dps.length&&!dps.find(d=>{
      return !d.items.find(o=>{
        let md=ds[o.module]
        if(md){
          let fd=md[o.field]
          if(fd){
            try{
              if(o.valueType==0){
                return fd._value
              }else if(o.valueType==1){
                return !fd._value
              }else if(o.valueType=="regex"){
                return !o.value||!fd._value.match(_Util._strToRegex(o.value))
              }else if(o.valueType=="script"){
                return _Util._eval(o.value)
              }else{
                return !_Util._eval("fd._value"+o.valueType+"o.value",{fd:fd,o:o})
              }
            }catch(e){
            }
          }
        }
      })
    })){
      if(_setCurValue){
        dps.forEach(d=>{
          if(d.targetValue=="[true]"){
            _setCurValue._value="undefined"
          }else if(d.targetValue=="[false]"){
            _setCurValue._value="on"
          }
        })
      }
      return 1
    }
  },
  _getDependenceValue:function(a){
    var vv;
    if(a.moduleData&&a.moduleData!="specialData"){
      vv=a.moduleData
    }else{
      vv=a.valueType==0?"":a.valueType==1?"on":a.value
    }
    return vv
  },
  //o: operation
  _getParentDependenceTree:function(o,ds){
    ds=ds||o.dependencies
    o.panel.forEach(p=>{
      let c=_aiGeneratorDataHandler._getContentByCode(p)
      if(c.from){
        c.from.forEach(f=>{
          let c=_aiGeneratorDataHandler._getContentByCode(f.code,f.module)
          if(!c){
            c=_aiGeneratorDataHandler._getContentByCode(f.code)
          }
          if(c){
            if(c.dependencies&&c.dependencies.length){
              ds={
                pds:c.dependencies,
                ds:ds,
                f:c
              }
            }
            ds=_aiModelHandler._getParentDependenceTree(c,ds)
          }
        })
      }else if(c.panel){
        ds=_aiModelHandler._getParentDependenceTree(c,ds)
      }
    })
    return ds
  },
  _addDependenceItem:function(a){
    var _switch=BZ._data._uiSwitch
    var ds=_switch._modelsDependences
    var _cmds=_switch._curModelDependenceMap
    var m=_aiGeneratorDataHandler._getModuleObject(a.module)
    var c=m._data.code,cc=_IDE._data._curModule._data.code
    if(_cmds._code!=cc){
      _cmds._code=cc
      _cmds._data={}
    }
    _cmds=_cmds._data
    
    var ms=ds[c]=ds[c]||{},vv
    var f=a.field||""
    ms[f]=ms[f]||{_options:f?["","on","undefined"]:Object.keys(_bzMessage._setting._objectLib._moduleData)}
    
    c=c+"."+f
    var v=_cmds[c]=_cmds[c]||ms[f]
    v._module=m;
    if(f){
      if(!v._field){
        v._field=_aiGeneratorDataHandler._getItemByGroupAndCode("fields",f,m)
      }
      if(!v._field){
        delete _cmds[c]
        return
      }
    }
    vv=_aiModelHandler._getDependenceValue(a)||""
    
    vv=vv.replace(/^\/(.+)\/$/,"$1").split("|")
    vv.forEach(x=>{
      if(!v._options.includes(x)){
        v._options.push(x)
      }
      v._value=x
    })
  },
  _buildCurDependenceCondition:function(){
    var _switch=BZ._data._uiSwitch
    _switch._modelsDependences=_switch._modelsDependences||{}
    _switch._curModelDependenceMap=_switch._curModelDependenceMap||{}
    var d=_IDE._data._curModule._data.definition
    for(var k in d){
      var v=d[k]
      v.forEach&&v.forEach(i=>{
        if(i.dependencies){
          i.dependencies.forEach(dp=>{
            dp.items.forEach(p=>{
              _aiModelHandler._addDependenceItem(p)
            })
          })
        }
        if(i.fields){
          _pickDepInFields(i.fields)
        }
      })
    }
    
    function _pickDepInFields(fs){
      fs.forEach(x=>{
        if(x.type=="object"){
          _pickDepInFields(x.fields)
        }else{
          if(x.dependencies){
            x.dependencies.forEach(dp=>{
              dp.items.forEach(p=>{
                _aiModelHandler._addDependenceItem(p)
              })
            })
          }
        }
      })
    }
  },
  //v: panel code
  _getItemPanelModel:function(md,v,_findParent){
    let r;
    _findInItems(md.models,v)
    
    return r
    function _findInItems(ss,v){
      return ss&&ss.find(x=>{
        if(x.code==v){
          if(!_findParent){
            r=x
          }
          return 1
        }
        if(_findInItems(x.items,v)){
          if(!r){
            r=x
          }
          return 1
        }
      })
    }
  },
  //pc:panel code
  _isDataPanel:function(pc){
    pc=_aiGeneratorDataHandler._getContentByCode(pc)
    if(pc){
      if(['form','table','list','dataPanel'].includes(pc.type)){
        return 1
      }else if('innerPanel'==pc.type&&pc.panel){
        return _aiModelHandler._isDataPanel(pc.panel[0])
      }
    }
  },
  _isClosablePanel:function(p){
    for(var i=0;p.items&&i<p.items.length;i++){
      var o=p.items[i]
      if(o.group=="operations"){
        return
      }else if(o.group=="contents"){
        o=_aiGeneratorDataHandler._getContentByCode(o.code)
        if(o){
          if(_aiModelHandler._isEnterType(o.type)){
            return
          }else if(_aiModelHandler._isPanel(o)){
            if(!_aiModelHandler._isClosablePanel(o.code)){
              return
            }
          }
        }
      }else if(o.group=="buttons"){
        let b=_aiGeneratorDataHandler._getItemByGroupAndCode("buttons",o.code)
        if(b&&b.lanuchPanel){
          return
        }
      }
    }
    return 1
  },
  _getPanelName:function(d,_module,_noOuterProjectName){
    var _msg=_bzMessage._model._panelType,_name=""
    _module=_aiGeneratorDataHandler._getModuleObject(_module)
    var dd=_aiGeneratorDataHandler._getContentByCode(d.code,_module)
    if(!dd){
      dd=_aiGeneratorDataHandler._getItemByGroupAndCode("operations",d.operation,_module)
      if(!dd){
        return ""
      }else{
        return BZ._groupWords([_module._data.name,dd.name])
      }
    }else if(dd.name){
      return (_module!=_IDE._data._curModule?_module._data.name+" • ":"")+dd.name
    }
    if(d.code=="home"){
      _name=_msg.home
    }else{
      var m=_aiGeneratorDataHandler._getModuleObject(d.module||_module)
      if(m){
        var p=_aiGeneratorDataHandler._getContentByCode(d.code,m)
        if(p){
          var t=p.type
          if(p.from){
            if(p.type=="form"){
              let f=p.from[0]
              if(f){
                p=_aiGeneratorDataHandler._getItemByGroupAndCode(["operations","buttons"],f.code,f.module)
              }else{
                p=0
              }
            }else{
              p=_aiGeneratorDataHandler._getContentByCode(p.from[0].code,p.from[0].module)
            }
            if(p&&t=="form"&&(_noOuterProjectName||m._data.code==_module._data.code)){
              _name=_Util._formatMessage(_bzMessage._model._panelName,[p.name,_bzMessage._model._panelType[t]])
            }else{
              _name=_bzMessage._model._panelType[t]
            }
          }else{
            _name=p.name||_msg._mainModulePanel
          }
          if(!_noOuterProjectName&&m._data.code!=_module._data.code){
            _name=BZ._groupWords([m._data.name,_name])
          }
        }
      }
    }

    return _name||_bzMessage._model._noExit
  },
  _drawGUI:function(){
    var s=BZ._data._uiSwitch
    clearTimeout(_aiModelHandler._modelGUITime)
    _aiModelHandler._modelGUITime=setTimeout(()=>{
      _ideGUIHandler._cleanCanvas()
      _ideGUIHandler._setData(_aiModelHandler._getGUIData())
    },50)
    // s._modelGUITime=Date.now()
    // _doIt()
    // function _doIt(){
    //   if(BZ._data._uiSwitch._inTestListDiagram!="model"){
    //     return
    //   }
    //   if(s._modelGUITime2!=s._modelGUITime){
    //     return setTimeout(function(){
    //       _ideGUIHandler._cleanCanvas()
    //       _ideGUIHandler._setData(_aiModelHandler._getGUIData())
    //     },10)
    //   }
    //   _ideGUIHandler._cleanCanvas()
    //   _ideGUIHandler._setData(_aiModelHandler._getGUIData())
    // }
  },
  _refreshGUI:function(){
    BZ._data._uiSwitch.inFlowView=1
    setTimeout(()=>{
      BZ._data._uiSwitch.inFlowView=0
      _aiPageHandler._refreshPopWin()
    },200)
  },
  _getGUIData:function(){
    var os=[]
    var hs=$(".bz-model-panel")
    for(var i=0;i<hs.length;i++){
      var h=hs[i]
      if(!h.id){
        continue
      }
      var f=$("."+h.id)
      for(var j=0;j<f.length;j++){
        if(_Util._isHidden(h)){
          continue
        }
        // let _box=_Util._getClosestElement(f[j],f[j],".bz-model-panel")[0]
        // if($(_box).hasClass("bz-inner-panel")){
          // _box=$(".bz-inner-panel").toArray().find(x=>{
            // return !$(x).hasClass("bz-inner-panel")&&$(x).find(_box)[0]
          // })
        // }
        let d={
          _fromObj:f[j],
          _toObj:h,
          // _box:_box,
          _fromLeft:$(f[j]).hasClass("bz-item-left-point")
        };
        if(f[j]._data._item==BZ._data._uiSwitch._activeModelItem){
          d._color="#0069FF"
        }
        os.push(d)
      }
    }
    return os;
  },
  _dropPanel:function(o,e){
    if(!BZ._data._uiSwitch._curDragCode){
      return
    }
    var c=BZ._data._uiSwitch._curDragCode.split(":")
    var d=_aiGeneratorDataHandler._getItemByGroupAndCode(c[0],c[2])
    var v=BZ._data._uiSwitch._insert,_idx=0
    for(var i=0;i<v._data._panel.items.length;i++){
      if(v._data._panel.items[i].code==v._data._item.code){
        _idx=i
        if(v._pos=="bottom"){
          _idx++
        }
        break;
      }
    }
    _aiModelHandler._moveItem(d,c[1],o._data._item.code,_idx)
    setTimeout(function(){
      _aiModelHandler._drawGUI()
    },100)
    delete BZ._data._uiSwitch._curDragCode
  },
  _dragoverPanel:function(o,e){
    if(!BZ._data._uiSwitch._curDragCode){
      return
    }
    var c=BZ._data._uiSwitch._curDragCode.split(":")
    if(o.tagName=="CANVAS"){
      if(c[0]=="models"){
        e.preventDefault();
      }
    }else{
      if(c[0]!="models"){
        var d=_aiGeneratorDataHandler._getItemByGroupAndCode(c[0],c[2])
        if(d){
          if(_aiModelHandler._isPanelEnter(o._data._item.code,d)){
            return
          }else if(_aiModelHandler._isSubModuleRootModel(o._data._item)){
            return
          }
        }
        e.preventDefault();
      }
    }
  },
  _dragoverItem:function(o,e){
    var r=o.getBoundingClientRect()
    var v=BZ._data._uiSwitch._insert=BZ._data._uiSwitch._insert||{}
    v._data=o._data
    if(r.height/2+r.top>e.clientY){
      v._pos="top"
    }else{
      v._pos="bottom"
    }
  },
  _dragleaveItem:function(o){
    BZ._data._uiSwitch._insert=0
    setTimeout(()=>{
      _ideModuleManagement._save()
    },1000)
  },
  _isFormButton:function(d){
    return _bzMessage._model._trigger[d.type]
  },
  _isPanelEnter:function(p,e){
    p=_aiGeneratorDataHandler._getContentByCode(p)
    if(p){
      if(p.code==e.lanuchPanel){
        return 1
      }
      if(p.type=="form"&&!_IDE._data._curModule._data.definition.fields.includes(e)&&!_aiModelHandler._isFormButton(e)){
        return 1
      }
      for(var i=0;p.from&&i<p.from.length;i++){
        let f=p.from[i]
        var c=_aiGeneratorDataHandler._getContentByCode(f.code,f.model)
        if(!c){
          c=_aiGeneratorDataHandler._getItemByGroupAndCode("relatedModules",f.code,f.model)
        }
        if(!c){
          c=_aiGeneratorDataHandler._getItemByGroupAndCode(["operations","buttons"],f.code,f.model)
        }
        if(c){
          for(var j=0;j<c.panel.length;j++){
            if(_aiModelHandler._isPanelEnter(c.panel[j],e)){
              return 1
            }
          }
        }
      }
    }
  },
  _drageleavePanel:function(o){
    $(o).removeClass("bz-model-drop-in-panel")
  },
  //c: panel item
  //g: group, default is contents
  //ps: result, the item panels (function self assign it)
  //cc: for deep search (function self assign it)
  _getModelPanel:function(c,g,ps,cc){
    g=g||"contents"
    ps=ps||[]
    c=_aiGeneratorDataHandler._getItemByGroupAndCode(g,c)
    if(c){
      for(var i=0;c.panel&&i<c.panel.length;i++){
        var p=_aiModelHandler._getModelByCode(c.panel[i])
        if(p){
          if(cc){
            _filterModel(p)
          }else{
            ps.push(p)
          }
        }else{
          _aiModelHandler._getModelPanel(c.panel[i],"contents",ps,c.code)
          if(cc){
            _filterModel(ps.pop())
          }
        }
      }
    }
    return ps
    function _filterModel(p){
      for(var i=0;i<p.items.length;i++){
        if(p.items[i].code==c){
          ps.push(p.items[i])
          return
        }
      }
    }
  },
  //e:event, c:code
  _dragstartPanel:function(e,c){
    BZ._data._uiSwitch._curDragCode=c
    e.target._orgPos={x:e.clientX,y:e.clientY}
    e.stopPropagation()
    $(e.target).addClass("bz-dragging-item")
  },
  _drageendPanel:function(e){
    $(e.target).removeClass("bz-dragging-item")

    var c=BZ._data._uiSwitch._curDragCode
    if(c){
      c=c.split(":")
      if(c[0]=="models"){
        c=_aiModelHandler._getModelByCode(c[1])
        if(c){
          var x=parseInt($(e.target).css("left"))+e.clientX-e.target._orgPos.x+"px"
          var y=parseInt($(e.target).css("top"))+e.clientY-e.target._orgPos.y+"px"
          var o=e.target._data._item;
          var dx=parseInt(x)-(parseInt(o.x)||0)
          var dy=parseInt(y)-(parseInt(o.y)||0)
          _aiModelHandler._movePanel(o,dx,dy)
          _aiModelHandler._drawGUI()
          // _aiModelHandler._refreshGUI()
        }
      }
      delete BZ._data._uiSwitch._curDragCode
    }
    BZ._data._uiSwitch._insert=0
  },
  _movePanel:function(o,dx,dy){
    var od=_aiGeneratorDataHandler._getContentByCode(o.code);
    
    if(!od||!od.panel||!od.panel.length){
      o.x=(parseInt(o.x)||0)+dx
      o.y=(parseInt(o.y)||0)+dy
      if(o.x<0){
        o.x=0
      }
      if(o.y<0){
        o.y=0
      }
      o.x+="px"
      o.y+="px"
    }
    o.items&&o.items.forEach(v=>{
      if(v.items){
        _aiModelHandler._movePanel(v,dx,dy)
      }else{
        var vd=_aiGeneratorDataHandler._getItemByGroupAndCode(v.group,v.code)
        if(vd&&vd.lanuchPanel){
          var oo=_aiModelHandler._getModelByCode(vd.lanuchPanel)
          _aiModelHandler._movePanel(oo,dx,dy)
        }
      }
    })
  },
  _getStartOptions:function(){
    var os=[{
      _tag:"option",_attr:{value:"url"},
      _text:"_bzMessage._module._general._moduleLink"
    }];
    
    _IDE._data._curModule._data.definition.contents.forEach(x=>{
      if(x.type=="enterModule"){
        os.push({
          _tag:"option",
          _attr:{
            value:x.code
          },
          _text:"_bzMessage._model._enter._options.enterModule"
        })
      }
    })

    return os
  },
  _isEnterType:function(t){
    return _bzMessage._model._enter._options[t]||t=="next"||t=="form-tab"||t=="ex-insert"
  },
  _isPanel:function(t){
    if(t){
      t=t.type||t
      return _bzMessage._model._panelType[t]||_bzMessage._model._panel._options[t]
    }
  },
  _getModelByCode:function(c,ms){
    if(!c){
      return
    }
    c=c.code||c
    ms=ms||_IDE._data._curModule._data.definition.models
    if(ms&&ms.constructor!=Array){
      ms=_ideObjHandler._getDataByPath(ms)._data.definition.models
    }
    for(var i=0;i<ms.length;i++){
      if(ms[i].code==c){
        return ms[i]
      }else if(ms[i].items){
        var gg=_aiModelHandler._getModelByCode(c,ms[i].items)
        if(gg){
          return gg
        }
      }
    }
  },
  _getItemObjectFromPanelRef:function(o){
    var m=_aiGeneratorDataHandler._getModuleObject(o.module)
    if(m){
      if(o.operation){
        return m._data.definition.operations.find(p=>{return p.code==o.operation})
      }
      return m._data.definition[o.group].find(p=>{return p.code==o.code})
    }
  },
  //m:button model
  _removeOutOperationFrom:function(d,_fun){
    //1. get out operation
    let o=_aiGeneratorDataHandler._getItemByGroupAndCode("operations",d.operation,d.lanuchModule)
    //2. get operation content
    let om=_aiGeneratorDataHandler._getContentByCode(o.lanuchPanel,d.lanuchModule)
    //3. remove 'from' from model
    om.from.find((f,i)=>{
      if(f.code==d.code){
        return om.from.splice(i,1)
      }
    })
    
    _IDE._data._curModule._data.definition.models.find(v=>{
      if(v.code==d.lanuchPanel){
        delete v.module
        delete v.operation
        return 1
      }
    })

    om=_ideObjHandler._getDataByPath(d.lanuchModule)
    delete d.operation
    delete d.lanuchModule
    _ideModuleManagement._save(om,function(){
      _fun&&_fun()
    },1)
  },
  //m:button module
  _addOutOperationFrom:function(d,m,_fun){
    //1. get out operation
    let o=_aiGeneratorDataHandler._getItemByGroupAndCode("operations",d.operation,d.lanuchModule)
    //2. get operation content
    let om=_aiGeneratorDataHandler._getContentByCode(o.lanuchPanel,d.lanuchModule)
    //3. remove 'from' from model
    if(!om.from.find((f,i)=>{
      return f.code==d.code
    })){
      om.from.push({code:d.code,module:m})
    }
    _IDE._data._curModule._data.definition.models.find(v=>{
      if(v.code==d.lanuchPanel){
        v.module=d.lanuchModule
        v.operation=d.operation
        return 1
      }
    })
    om=_ideObjHandler._getDataByPath(d.lanuchModule)
    _ideModuleManagement._save(om,function(){
      _fun&&_fun()
    },1)
  },
  //d: launch from button/link
  //g: group
  //t: current panel
  _newModel:function(d,g,t,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    var md=m._data.definition
    var p={
      from:[{code:d.code,module:m._data.code}],
      code:_aiAPI._newId(),
      items:[],
      type:g=="operations"||g=="buttons"?"form":g=="relatedModules"||["enterModule"].includes(d.type)?"modulePanel":"dataPanel"
    }
    if(p.type=="form"){
      p.formValues={
        dynamicData:"on"
      }
      p.alias=d.alias
    }
    var i=0
    if(t.constructor!=Object){
      t=_aiModelHandler._getModelByCode(t,md.models)
    }
    t.items.forEach(x=>{
      if(!["webpages","relatedModules","fields"].includes(x.group)){
        i++
      }
    })
    while(1){
      let ct=_aiGeneratorDataHandler._getContentByCode(t.code,m)
      if(ct.panel&&ct.panel.length){
        t=_aiModelHandler._getModelByCode(ct.panel[0],md.models)
      }else{
        break
      }
    }
    let dd={
      code:d.lanuchPanel||p.code,
      group:"contents",
      items:[],
      x:(parseInt(t.x)||0)+250+"px",
      y:(parseInt(t.y)||0)+30+(i*80)+"px",
      pin:p.type=="form"
    }
    if(d.module&&d.lanuchPanel){
      dd.module=d.module
    }

    md.models.push(dd)
    md.contents.push(p)
    d.lanuchPanel=d.lanuchPanel||p.code
    p.name=_aiModelHandler._getPanelName(p,m)
    return p
  },
  //md: module definition, g:group, d: data
  _insertNewModelItemIntoCurPanel:function(g,d,m,_panel,ts){
    m=m||_IDE._data._curModule._data
    let md=m.definition,
        t=_panel,
        nb=g!="buttons";
    if(!t){
      t=BZ._data._uiSwitch._curModelPanel
      if(BZ._userHabit.curUIModelTab=="flow"){
        t=md.models[0]
        if(t.module){
          t=md.models[1]||t
        }
      }
    }
    d.code=d.code||_aiAPI._newId();
    if(t.name&&!["fields"].includes(g)){
      t.alias=t.alias||_glossaryHandler._getVariableName(t.name)
      t.name=_Util._toCapitalWord(t.name)
    }
    t.items=t.items||[]
    if(nb){
      md[g]=md[g]||[]
    }
    var _exist=nb&&_Util._getExistItemInList(d,"name",md[g]),
        _unedit=d.unedit
    if(_exist&&(g=="fields"|| d.panel)){
      if(_Util._isEmpty(_exist.path)&&!_Util._isEmpty(d.path)){
        _exist.path=d.path
      }
      d=_exist;
      if(d.panel){
        if(d.panel.includes(t.code)){
          return
        }else{
          d.panel.push(t.code)
        }
      }else{
        d.panel=[t.code]
      }
    }else{
      //build item data
      d.panel=[t.code]
      
      d.preSteps=[]

      if(["fields"].includes(g)){
        d.dependencies=[]
      }
      //insert into module definition group
      nb&&md[g].push(d)
      //build new panel
      if(["relatedModules","operations"].includes(g)||_aiModelHandler._isEnterType(d.type)){
        _aiModelHandler._newModel(d,g,t,m)
      }else if(g=="contents"){
        d.fieldMap={}
      }
      
    }
    
    //insert into curModelPanel
    let dd={
      code:d.code,
      group:g
    }
    t.items.push(dd)
    if(["list","table"].includes(d.type)){
      dd.items=[]
      dd.x=dd.y=0
    }
    if(g=="fields"){
      let c=_aiGeneratorDataHandler._getContentByCode(t.code)
      c.formValues=c.formValues||{}
      delete c.formValues.dynamicData
      c.formValues[d.code]={
        dynamicData:!(d.type||"").match(/module|file/)?"on":undefined,
        readonly:_unedit
      }
      delete d.unedit
    }
    if(!_exist){
      if(ts&&["table","list","enterDetails"].includes(d.type)){
        d.testVE=_Util._formatMessage(_bzMessage._aiDefinition._validationName,[m.name+ ' - '+d.name])
        let tt=_ideTestManagement._getItemByName(d.testVE,m)
        if(!tt){
          ts.push(_testCaseBodyHandler._getValidation(d,"testVE",m))
        }
      }
      if(d.type=="enterModule"){
        if(!md.startPanel){
          md.startPanel=d.code
        }
      }
      return d
    }
  },
  _addModelItem:function(_model,_fun){
    if(_model.code=="api"){
      let d=_CtrlDriver._buildProxy({
        name:"",
        method:"GET",
        host:_IDE._getDefaultAPIHostIdx(),
        url:"/",
        api:"on",
        code:_aiAPI._newId(),
        contentType:"application/json",
        headers:"{\n  \"Accept\":\"application/json\",\n  \"Authorization\" : \"##BZ-TOKEN##\"\n}",
        joins:[],
        path:[],
        data:{},
        query:[],
        testCode:"",
        type:"testVE"
      })

      let _tokenHost=_aiAuthHandler._getTokenHostIdxByUIHostIdx(d.host)
      
      if(_tokenHost!==undefined){
        d.autoToken="on"
      }

      _importApiHandler._import(function(r){
        d.name=r._name
        r=r._data
        if(!r){
          _buildEmptyApi(d)
        }else{
          r=r[0]
          r.name=d.name
          _aiGenerator._fromApiTestToModel(r,0,0,_model,function(){
            _aiModelHandler._refreshGUI()
          })
        }
      },1)
    }else{
      _aiPageHandler._contentViewDef._data=0
      _aiPageHandler._confirmContent({
        _subModules: [],
        _contents: [],
        _fields: [],
        _webpages: [],
        _operations: []
      },_model,_fun)
    }

    function _buildEmptyApi(d){
      BZ._data._uiSwitch._newApi=d
      _Util._confirmMessage(_stdComponent._getBoxViewDef({
        _data:BZ._data._uiSwitch._newApi,
        _items:[
          {
            _label:"_bzMessage._common._name",
            _dataModel:"_data.name"
          },
          {
            _label:"_bzMessage._common._method",
            _type:"select",
            _dataModel:"_data.method",
            _text:"_data._item",
            _value:"_data._item",
            _dataRepeat:function(){
              return ["GET","POST","PUT","DELETE","OPTIONS","PATCH"]
            }
          },
          //host
          {
            _label:"_bzMessage._test._general._apiHost",
            _type:"select",
            _value:"_data._idx",
            _text:"_data._item.host",
            _dataRepeat:function(){
              return _IDE._data._setting.environments[_IDE._data._setting.curEnvironment].items
            },
            _dataModel:"_data.host"
          },
          {
            _label:"_bzMessage._common._url",
            _dataModel:"_data.url"
          }
        ]
      }),[{
        _click:function(c){
          let m=_IDE._data._curModule
          if(d.method=="POST"){
            d.type="add"
          }else if(d.method=="DELETE"){
            d.type="delete"
          }
          d.responseScript=_ideActionManagement._getStdAPIScript(0,d.method)
          _ideTestManagement._save({
            type:"api",
            name:d.name,
            subtype:d.method=="GET"?"validation":"operation",
            definition:{
              code:d.code
            }
          },m,function(t){
            BZ._data._uiSwitch._newApi.testCode=t.code
            m._data.definition.operations.push(BZ._data._uiSwitch._newApi)
            _model.items.push({
              code:d.code,
              group:"operations"
            })
            _ideModuleManagement._save(0,function(){
              _aiModelHandler._refreshGUI()
            })
            c._ctrl._close()
          })
        }
      }])
    }
  },
  _addItemFromUI:function(_item){
    _bzDomPicker._pickDetails("_pageAnalysis",function(o){
      _aiPageHandler._confirmContent(o,_item)
    })
  },
  //d: data, f: from panel, t: to panel
  _moveItem:function(d,f,t,_idx){
    if(f!=t){
      if(!d.panel.includes(t)){
        d.panel.push(t)
      }
      for(var i=0;i<d.panel.length;i++){
        if(d.panel[i]==f){
          d.panel.splice(i,1)
          break
        }
      }
    }
    f=_aiModelHandler._getModelByCode(f)
    t=_aiModelHandler._getModelByCode(t)
    for(var i=0;i<f.items.length;i++){
      if(f.items[i].code===d.code){
        var dd=f.items.splice(i,1)
        if(f!=t){
          t.items=t.items||[]
        }else if(_idx>i){
          _idx--
        }
        if(!t.items.find(v=>{
          return v.code==d.code
        })){
          t.items.splice(_idx,0,dd[0])
        }
        
        break
      }
    }
    _aiModelHandler._refreshPanelUI(f)
    if(f!=t){
      _aiModelHandler._refreshPanelUI(t)
    }
  },
  _refreshPanelUI:function(d,_fun){
    /**/
    var o=_aiGeneratorDataHandler._getContentByCode(d.code)
    if(["table","list","innerPanel"].includes(o.type)){
      if(o.panel&&o.panel[0]){
        return _aiModelHandler._refreshPanelUI({code:o.panel[0]})
      }
    }
    d=_aiModelHandler._getModelByCode(d.code)
    /**/
    if(!d.code){
      return
    }
    var c=d.code
    d.code=""
    setTimeout(function(){
      d.code=c
      setTimeout(function(){
        _aiModelHandler._drawGUI()
        _fun&&_fun()
      },100)
    },20)
  },
  //check whether it is start panel
  _isStartPanel:function(d){
    return d.code==_IDE._data._curModule._data.definition.startPanel
  },
  _isOuterPanel:function(d){
    return d.module&&d.module!=_IDE._data._curModule._data.code
  },
  _isLanuchFromCurModule:function(t,p){
    if(!t||!p){
      return
    }
    if(t==p||t==p.code){
      return 1
    }
    
    let c=_aiGeneratorDataHandler._getContentByCode(t.code||t)
    if(c&&c.from){
      return c.from.find(x=>{
        let xx=_aiModelHandler._getButtonForm(x.code)
        if(xx){
          if(xx.code==p.code||_aiModelHandler._isLanuchFromCurModule(xx,p)){
            return 1
          }
        }else{
          xx=_aiGeneratorDataHandler._getItemByGroupAndCode("operations",x.code)
          if(xx){
            return xx.panel.find(y=>{
              if(y==p.code){
                return 1
              }
              return _aiModelHandler._isLanuchFromCurModule(y,p)
            })
          }
        }
      })
    }
  },
  _showDetails:function(o,g){
    if(g=="operations"){
      _aiPageHandler._popOperationForm(o)
    }else if(g=="fields"){
      _aiPageHandler._popFieldForm(o)
    }else if(g=="relatedModules"){
      _aiPageHandler._popRelatedModuleForm(o)
    }else if(g=="webpages"){
      _aiPageHandler._popPageForm(o)
    }else if(g=="buttons"){
      _aiPageHandler._popButton(o)
    }else{
      _aiPageHandler._popContentForm(o)
    }
  },
  _getButtonForm:function(b){
    return _IDE._data._curModule._data.definition.contents.find(c=>{
      return c.buttons&&c.buttons.find(bb=>{
        return bb==b||bb.code==b
      })
    })
  },
  _isEditablePanel:function(d){
    if(!d._idx){
      return !d._item.module
    }
    return 1
  },
  //d: data, _panel: model panel
  _deleteItem:function(d,_panel,g,_curModule,_fun){
    if(!d){
      return
    }
    _curModule=_curModule||_IDE._data._curModule
    //remove ref from panel
    for(var i=0;_panel&&i<_panel.items.length;i++){
      if(_panel.items[i].code==d.code){
        var dd=_panel.items.splice(i,1)[0]
        while(dd.items&&dd.items.length){
          var o=dd.items.shift()
          var gg=o.group
          o=_aiGeneratorDataHandler._getItemByGroupAndCode(gg,o.code)
          if(o){
            _aiModelHandler._deleteItem(o,dd,gg)
          }
        }
        break
      }
    }
    let _removeModule;
    //remove panel
    if(_panel&&d.panel){
      var _idx=d.panel.indexOf(_panel.code),tk;
      
      if(g=="buttons"){
        let bs=_aiGeneratorDataHandler._getContentByCode(_panel.code).buttons
        bs.splice(bs.findIndex(b=>{
          return b==d
        }),1)
        
        _curModule._data.definition.contents.find((a,i)=>{
          if(a.code==d.lanuchPanel){
            return _curModule._data.definition.contents.splice(i,1)
          }
        })
        _curModule._data.definition.models.find((a,i)=>{
          if(a.code==d.lanuchPanel){
            return _curModule._data.definition.models.splice(i,1)
          }
        })
      }

      d.panel.splice(_idx,1)
    }
    //remove from group
    if(!d.panel){
      _aiModelHandler._deleteItems(d,function(){
        _aiModelHandler._deleteModel(d.code)
        
        _addSavingModule(_curModule)

        if(d.testCode){
          _curModule._data.definition.operations.splice(_curModule._data.definition.operations.indexOf(d),1)
          d=_ideObjHandler._getDataByPath(_curModule._data.code,d.testCode)
          _ideTestManagement._deleteItem(_curModule,d,function(){
            _ideModuleManagement._save(0,function(){
              _aiModelHandler._refreshGUI()
            })
          })
          return
        }
      },1)
    }else if(!d.panel.length&&g!="buttons"&&g!="fields"){
      g=_curModule._data.definition[g]
      for(var i=0;i<g.length;i++){
        if(g[i]==d){
          g.splice(i,1)
          if(_curModule._data.definition.relatedModules==g){
            _removeModule=1
          }
          break
        }
      }
    }
    
    _addSavingModule(_curModule)
    
    //Delete panel
    if(d.lanuchPanel){
      if(d.type=="modulesub"){
        _Util._spliceAll(_curModule._data.definition.models,v=>{return v.code==d.lanuchPanel})
        let m=_ideObjHandler._getDataByPath(d.module)
        let mo=m._data.definition.models[0]
        if(mo.module==_curModule._data.code){
          mo.module=""
        }
        mo=m._data.definition.models[1]
        mo.from.find(v=>{if(v.module==_curModule._data.code){v.module="";return 1;}})
        m._data.definition.contents.find(c=>{
          if(c.module==_curModule._data.code){
            c.module=""
            return 1
          }
        })
        _addSavingModule(m)
      }else{
        var m=d.lanuchModule?_ideObjHandler._getDataByPath(d.lanuchModule):_curModule;
        if(m){
          var md=m._data.definition;
          var ms=md.models,dd,_lanuch,_code
          if(d.operation){
            dd=_aiGeneratorDataHandler._getItemByGroupAndCode("operations",d.operation,d.lanuchModule)
            _lanuch=dd.lanuchPanel
            _code=d.code
          }else{
            _code=_lanuch=d.lanuchPanel
          }
          for(var i=0;i<ms.length;i++){
            var mo=ms[i]
            if(mo.code==_lanuch){
              var moc=_aiGeneratorDataHandler._getContentByCode(mo.code,m)
              
              if(mo.module&&mo.module!=m._data.code){
                var mm=_aiGeneratorDataHandler._getModuleObject(mo.module)
                if(mm){
                  var _rmEnter=_aiGeneratorDataHandler._getContentByCode(d.code,mo.module)
                  var _rmPanel=_aiModelHandler._getModelByCode(_rmEnter.panel[0],mm._data.definition.models)
                  _aiModelHandler._deleteItem(_rmEnter,_rmPanel,"contents",mm)
                  if(!_rmPanel.items.length){
                    var mms=mm._data.definition.models
                    for(var j=0;j<mms.length;j++){
                      if(mms[j].code==_rmPanel.code){
                        mms.splice(j,1)
                      }
                    }
                  }
                }
              }else{
                moc.from.splice(moc.from.findIndex(f=>{return f.code==d.code}),1)
                if(!moc.from.length){
                  while(mo.items&&mo.items.length){
                    var o=mo.items[0]
                    g=o.group
                    o=_aiGeneratorDataHandler._getItemByGroupAndCode(o.group,o.code)
                    if(!o){
                      mo.items.shift()
                    }else{
                      _aiModelHandler._deleteItem(o,mo,g)
                    }
                  }
                  var mg=md[mo.group]
                  for(var j=0;j<mg.length;j++){
                    if(mg[j].code==mo.code){
                      mg.splice(j,1)
                      break
                    }
                  }
                }
              }
              if(!moc.from.length){
                ms.splice(i,1)
              }
              break
            }
          }
        }
      }
    }
    [d.testCode,d.scenario,d.testVE].forEach(dv=>{
      if(!dv){
        return
      }
      _aiModelHandler._savingTests=_aiModelHandler._savingTests||[]
      tk=_curModule._data.code+","+dv
      if(!_aiModelHandler._savingTests.includes(tk)){
        _aiModelHandler._savingTests.push(tk)
      }
    })

    // if(d.type=="modulesub"&&d.module!=m.code){
      // _aiModelHandler._deletingModules=_aiModelHandler._deletingModules||[]
      // if(!_aiModelHandler._deletingModules.includes(d.module)){
        // _aiModelHandler._deletingModules.push(d.module)
      // }
    // }
    if(d.operation){
      _addSavingModule(d.lanuchModule)
    }
    clearTimeout(_aiModelHandler._saving)

    _aiModelHandler._saving=setTimeout(function(){
      _deleteTests()
    },100)

    function _deleteTests(){
      if(_aiModelHandler._savingTests&&_aiModelHandler._savingTests.length){
        var tk=_aiModelHandler._savingTests.pop().split(",")
        _ideTestManagement._deleteItem(tk[0],tk[1],function(){
          _deleteTests()
        })
      }else{
        if(_aiModelHandler._savingModules&&_aiModelHandler._savingModules.length){
          _ideModuleManagement._batchSave(_aiModelHandler._savingModules,function(){
            _deleteTests()
          })
        // }else if(_aiModelHandler._deletingModules&&_aiModelHandler._deletingModules.length){
          // _ideModuleManagement._batchDelete(_aiModelHandler._deletingModules,function(){
            // _doIt()
          // })
        }else{
          _doIt()
        }
      }
    }
    function _doIt(){
      if(_fun){
        _fun()
      }else{
        _aiModelHandler._refreshGUI()
      }
    }
    
    function _addSavingModule(m){
      if(m.constructor==String){
        m=_aiGeneratorDataHandler._getModuleObject(m)
      }
      _aiModelHandler._savingModules=_aiModelHandler._savingModules||[]
      if(!_aiModelHandler._savingModules.includes(m)){
        _aiModelHandler._savingModules.push(m)
      }
    }
  },
  _deleteItemFromUI:function(o,_panel,g,_uiItem){
    var m=_IDE._data._curModule
    _aiModelHandler._deleteItem(o,_panel,g,m,function(){
      // if(_uiItem){
      //   //_Util._getClosestElement(_uiItem,_uiItem,".bz-model-item").remove()
      //   if(!_aiModelHandler._hasLanuchPanel(_uiItem._data._item)){
      //     return _aiModelHandler._drawGUI()
      //   }
      // }
      // _aiModelHandler._refreshGUI() 
    })
  },
  _deleteModel:function(c){
    let md=_IDE._data._curModule._data.definition
    var ms=
    md.models.find((v,i)=>{
      if(v.code==c){
        return md.models.splice(i,1)
      }
    })
    md.contents.find((v,i)=>{
      if(v.code==c){
        return md.contents.splice(i,1)
      }
    })
  },
  _deletePanel:function(o){
    _Util._confirmMessage(_bzMessage._model._confirmDelete,[{
      _title:_bzMessage._method._yes,
      _click:function(c){
        _aiModelHandler._deleteItems(o,function(){
          var vs=["models","contents"]
          vs.forEach(n=>{
            var ms=_IDE._data._curModule._data.definition[n]
            for(var i=0;i<ms.length;i++){
              if(ms[i].code==o.code){
                ms.splice(i,1)
                break
              }
            }
          })
        })
        c._ctrl._close()
      }
    }])
  },
  _deleteItems:function(p,_fun,_noRefresh){
    let md=_IDE._data._curModule._data.definition
    var d=p.items&&p.items[0]
    if(d){
      var g=d.group
      d=_aiGeneratorDataHandler._getItemByGroupAndCode(g,d.code)
      if(d){
        _aiModelHandler._deleteItem(d,p,g,0,function(){
          _aiModelHandler._deleteItems(p,_fun)
        })
      }else{
        _doFinal()
      }
    }else{
      _doFinal()
    }
    
    function _doFinal(){
      let i=md.models.indexOf(p)
      if(i>=0){
        if(!md.contents.find(x=>{
          if(x.code==p.code){
            x=x.from[0]
            if(x){
              let m=_aiGeneratorDataHandler._getModuleObject(x.module)._data
              return m.definition.operations.find(y=>y.code==x.code)||m.definition.contents.find(y=>y.code==x.code)
            }
          }
        })){
          md.models.splice(i,1)
          if(!p.code){
            _Util._spliceAll(md.models,x=>!x.code)
          }
        }
      }
      if(_fun){
        _fun()
      }
      if(!_noRefresh){
        _aiModelHandler._refreshGUI()
      }
    }
  },
  _clearPanel:function(p){
    _Util._confirmMessage(_bzMessage._model._confirmClear,[{
      _title:_bzMessage._method._yes,
      _click:function(c){
        _aiModelHandler._deleteItems(p)
        c._ctrl._close()
      }
    }])
  },
  //p: current Panel
  _getParentPanels:function(p){
    var ps=[]
    while(p){
      var c=_aiGeneratorDataHandler._getContentByCode(p)
      if(c){
        ps.unshift(c.path)
        p=c.panel
        p=p&&p[0]
      }else{
        break
      }
    }
    return ps
  },
  _deleteField:function(f,_save){
    let m=_IDE._data._curModule._data.definition
    f=m.fields.splice(f,1)[0]
    if(f){
      m.contents.forEach(x=>{
        if(x.formValues){
          delete x.formValues[f.code]
          if(_Util._isEmpty(x.formValues)){
            x.formValues.dynamicData="on"
          }
        }
      })
      m.models.forEach(x=>{
        _removeFromModel(f,x)
      })
      if(_save){
        _ideModuleManagement._save()
      }
    }
    function _removeFromModel(f,x){
      x.items&&x.items.find((y,i)=>{
        if(y.code==f.code&&y.group=="fields"){
          x.items.splice(i,1)
          return 1
        }else{
          _removeFromModel(f,y)
        }
      })
    }
  },
  _deleteSelectedFields:function(fs){
    fs.forEach(x=>{
      _aiModelHandler._deleteField(_IDE._data._curModule._data.definition.fields.findIndex(y=>y.code==x))
    })
    fs.length=0
    _ideModuleManagement._save()
  },
  _createBaseField:function(m,_fun){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let d=_CtrlDriver._buildProxy({
      type:"string",
      code:Date.now()
    })
    BZ._data._uiSwitch._tmpNewField=d
    // let _viewDef={
    //   _dataRoot:"BZ._data._uiSwitch._tmpNewField",
    //   _messageRoot:"_bzMessage._setting._objectLib._field",
    //   _src:_aiPageHandler._getFieldBaseSettingViewDef(d,"BZ._data._uiSwitch._tmpNewField")._src
    // }
    let _viewDef=_aiPageHandler._getFieldBaseSettingViewDef(d,"BZ._data._uiSwitch._tmpNewField")._src
    //_viewDef=_uiHandler._buildFormView(_viewDef,_addOnFormTemplate)
    
    _viewDef._attr={
      style:"height:80px"
    }

    _Util._confirmMessage(_viewDef,[{
      _title:_bzMessage._method._save,
      _click:function(c){
        m._data.definition.fields.push(d)
        _ideModuleManagement._save(m,function(){
          _fun&&_fun(d)
        })
        c._ctrl._close()
      }
    }],_bzMessage._method._newField)
  },
  //Panel !!!!
  _getPanelViewDef:function(r,_panelCode){
    return {
      _if:function(d){
        return BZ._data._uiSwitch._inTestListDiagram=='model'&&_IDE._data._curModule
      },
      _tag:"div",
      _after:function(o){
        if(o._data._item==BZ._data._uiSwitch._curRefModel){
          _Util._setToTop(o)
        }
      },
      _attr:{
        id:"'t'+_data._item.code",
        "class":function(d,ct,o){
          try{
            let dd=d;
            d=d._item
            if(!_aiModelHandler._getModelByCode(d.code)){
              $(o).remove()
              return
            }
            let _panelType=(_aiGeneratorDataHandler._getContentByCode(d.code)||{}).type
            var c='bz-model-panel'
            if(BZ._data._uiSwitch._curModelPanel==d){
              c+=" bz-model-active"
            }else if(BZ._data._uiSwitch._curRefModel==d){
              c+=" bz-model-ref"
            }else if(_panelType=="form"&&!d.pin){
              c+=" bz-model-hide"
            }
            if(_aiModelHandler._isOuterPanel(d)){
              c+=" bz-model-outer"
              if(d.module){
                if(!d.items||!d.items.length){
                  c+=" bz-model-hide"
                }else{
                  c+=" bz-model-module"
                }
              }
            }else{
              var o=_aiGeneratorDataHandler._getContentByCode(d.code,d.module)
              if(!o){
                return c
              }
              if(!o.path&&!_aiModelHandler._isStartPanel(d)){
                c+=' bz-no-element'
              }
              if(_panelCode){
                c+=" bz-inner-panel"
              }
            }
            return c
          }catch(ex){}
        },
        style:function(d){
          var o=BZ._data._uiSwitch._activeModelItem,
              c="",
              y=(d._item.y||0),
              x=d._item.x||0;
          setTimeout(()=>{
            if(o&&o.lanuchPanel){
              o=_aiModelHandler._getModelByCode(o.lanuchPanel)
            }else{
              o=0
            }
            if(BZ._data._uiSwitch._curRefModel!=o){
              BZ._data._uiSwitch._curRefModel=o
            }
          })
          
          return "top:"+y+";left:"+x+";"
        },
        droppable:true,
        ondrop:"_aiModelHandler._dropPanel(this,event)",
        ondragover:"_aiModelHandler._dragoverPanel(this,event)",
        ondragstart:"_aiModelHandler._dragstartPanel(event,"+(_panelCode?"'contents:"+_panelCode+":'":"'models:'")+"+this._data._item.code)",
        //ondragleave:"_aiModelHandler._drageleavePanel(this)",
        ondragend:"_aiModelHandler._drageendPanel(event)"
      },
      _items:[
        //header
        {
          _tag:"div",
          _attr:{
            "class":"bz-model-panel-header",
            style:function(d){
              try{
                let o=d._item
                var p=_aiGeneratorDataHandler._getContentByCode(o.code,o.module)
                if(!p){
                }else if(p.from&&p.from[0]){
                }else{
                  if(p.panel){
                    return "cursor:default"
                  }
                }              
              }catch(ex){}
            }
          },
          _items:[
            //edit
            {
              _tag:"button",
              _attr:{
                "class":"btn btn-icon bz-small-btn bz-edit bz-space-5 bz-model-edit",
                title:"_bzMessage._method._edit",
              },
              _jqext:{
                click:function(e){
                  _aiPageHandler._popPanel(this._data._item)
                }
              }
            },
            //icon
            {
              _tag:"a",
              _attr:{
                "class":function(d){
                  try{
                    var c="btn-icon bz-small-btn bz-no-edit bz-space-5 "
                    var o=_aiModelHandler._getItemObjectFromPanelRef(d._item)
                    if(!o){
                      return c
                    }
                    if(d._item.operation){
                      if(o.type=="add"){
                        c+="bz-plus"
                      }else if(o.type=="edit"){
                        c+="bz-plus"
                      }else if(o.type=="delete"){
                        c+="bz-cross"
                      }else{
                        c+="bz-plus"
                      }
                    }else if(o.code=='home'){
                      let v=_IDE._data._curModule._data.definition.startPanel
                      if(v=="url"){
                        c+="bz-link"
                      }else if(v){
                        c+="bz-entry"
                      }
                    }else if(o.code=="api"){
                      c+="bz-api"
                    }else if(o.type=='table'){
                      c+="bz-table-dark"
                    }else if(o.type=='list'){
                      c+="bz-list"
                    }else{
                      if(o.asOneAction){
                        c+="bz-flash"
                      }else{
                        c+='bz-panel'
                      }
                    }
                    if(d._item.module){
                      let m=_ideObjHandler._getDataByPath(d._item.module)
                      if(m){
                        c+=m._data.definition.initData?' bz-data-point':''
                      }
                    }
                    return c
                  }catch(ex){}
                },
                style:"cursor:default;"
              }
            },
            //name
            {
              _tag:"span",
              _attr:{
                style:"color:var(--text-color)",
                "class":"bz-model-header-text"
              },
              _items:[
                {
                  _tag:"span",
                  _attr:{
                    class:function(d){
                      try{
                        var o=_aiModelHandler._getItemObjectFromPanelRef(d._item)
                        if(o&&o.code=="api"){
                        }else if(o&&o.fakeElement){
                          return "bz-fake-element"
                        }else if(o&&!o.fakeElement&&_Util._isEmpty(o.path)&&_Util._isEmpty(o.url)&&d._item.code!="home"&&d._item.code!=_IDE._data._curModule._data.definition.models[0].code){
                          return "bz-miss-path"
                        }else if(d._item.code=="home"&&!_IDE._data._curModule._data.definition.startPanel){
                          return "bz-miss-path"
                        }
                      }catch(ex){}
                    }
                  },
                  _text:function(d){
                    try{
                      return _aiModelHandler._getPanelName(d._item,d._item.module)
                    }catch(ex){}
                  }
                }
              ],
              _jqext:{
                mousedown:function(e){
                  if(_aiPageHandler._isSettingWinOpen()){
                    _aiPageHandler._popPanel(this._data._item)
                  }
                }
              }
            },
            //outer-module
            {
              _if:function(d){
                return d._item.module&&d._item.code!=_IDE._data._curModule._data.definition.models[0].code
              },
              _tag:"button",
              _attr:{
                class:"btn btn-icon bz-small-btn btn-none bz-popout",
                title:"_bzMessage._model._gotoRefModule"
              },
              _jqext:{
                click:function(e){
                  BZ._setHash(this._data._item.module)
                }
              }
            },
            //operation buttons
            {
              _if:"!_data._item.module",
              _tag:"div",
              _attr:{
                "class":"bz-ai-panel-ctrl"
              },
              _items:[
                //play
                {
                  _if:function(d){
                    let md=_IDE._data._curModule._data.definition
                    return md&& d._item.code!="api"&&d._item!=md.models[0]
                  },
                  _tag:"button",
                  _attr:{
                    class:"btn btn-icon bz-small-btn btn-none bz-model-menu bz-play",
                    title:"_bzMessage._method._tryPath"
                  },
                  _jqext:{
                    click:function(e){
                      var d=_aiGeneratorDataHandler._getContentByCode(this._data._item.code)
                      _aiPageHandler._doTry(d)
                    }
                  }
                },
                //keyboard
                {
                  _if:function(d){
                    try{
                      if(d._item.code=="home"){
                        return
                      }
                      let c=_aiGeneratorDataHandler._getContentByCode(d._item.code)
                      return c&&c.type=="form"
                    }catch(ex){}
                  },
                  _tag:"button",
                  _attr:{
                    "class":"btn btn-icon bz-small-btn btn-none bz-model-menu bz-keyboard",
                    title:"_bzMessage._method._tryFillForm"
                  },
                  _jqext:{
                    click:function(e){
                      let d=this._data._item
                      let c=_aiGeneratorDataHandler._getContentByCode(d.code)
                      _aiPageHandler._exeTmpForm(d.items,c)
                    }
                  }
                },
                //validation
                {
                  _if:function(d){
                    if(d._item.code=="home"){
                      return
                    }
                    try{
                      d=_aiGeneratorDataHandler._getContentByCode(d._item.code)
                      if(d){
                        if(d.testVE){
                          return 1
                        }else if(d.from){
                          return d.from.find(x=>{
                            x=_aiGeneratorDataHandler._getContentByCode(x.code)
                            if(x){
                              return x.testVE
                            }
                          })
                        }
                      }
                    }catch(ex){}
                  },
                  _tag:"button",
                  _attr:{
                    "class":"btn btn-icon bz-small-btn btn-none bz-model-menu bz-validation",
                    title:function(d){
                      d=_aiModelHandler._getValidateTestFromModelItem(d._item)
                      if(d){
                        return _bzMessage._common._view+': '+d._data.name
                      }
                    }
                  },
                  _jqext:{
                    click:function(e){
                      let o=_aiModelHandler._getValidateTestFromModelItem(this._data._item)
                      let k=_IDE._getShortcutKey(".",0,o)
                      
                      _guiModuleHandler._openDetails({
                        k:k,
                        t:o._data,
                        td:o,
                        from:[]
                      })
                      
                    }
                  }
                },
                //copy
                {
                  _tag:"button",
                  _attr:{
                    class:"btn btn-icon bz-small-btn bz-copy"
                  },
                  _jqext:{
                    click:function(){
                      _aiModelHandler._copy(this._data._item,"contents")
                    }
                  }
                },
                //paste
                {
                  _tag:"button",
                  _attr:{
                    class:"btn btn-icon bz-small-btn bz-paste",
                    disabled:"!_aiModelHandler._isPasteable(_data._item)"
                  },
                  _jqext:{
                    click:function(){
                      _aiModelHandler._paste(this._data._item,"contents")
                    }
                  }
                },
                //delete all
                {
                  _if:"_data._item.items.length",
                  _tag:"button",
                  _attr:{
                    "class":"btn btn-icon bz-small-btn btn-none bz-model-menu bz-delete",
                    title:"_bzMessage._method._deleteSubItems"
                  },
                  _jqext:{
                    click:function(e){
                      _aiModelHandler._clearPanel(this._data._item)
                    }
                  }
                },
                //delete self
                {
                  _if:function(d){
                    d=d._item
                    if(d.items&&!d.items.length){
                      if(!_panelCode){
                        var a=_aiGeneratorDataHandler._getItemByGroupAndCode("contents",d.code)
                        
                        return !a || a.panel||(a.from&&!a.from.length)
                      }
                      return 1
                    }
                  },
                  _tag:"button",
                  _attr:{
                    "class":"btn btn-icon bz-small-btn btn-none bz-model-menu bz-delete",
                    title:"_bzMessage._method._delete"
                  },
                  _jqext:{
                    click:function(e){
                      var c=this._data._item.code
                      var o=_aiGeneratorDataHandler._getContentByCode(c)
                          
                      if(o){
                        _aiModelHandler._deleteItemFromUI(o,_aiModelHandler._getModelByCode(_panelCode),"contents")
                      }else{
                        _aiModelHandler._deleteModel(c)
                        _ideModuleManagement._save(0,function(){
                          _aiModelHandler._refreshGUI()
                        })
                      }
                    }
                  }
                },
                //pin
                {
                  _if:function(d){
                    try{
                      var o=_aiModelHandler._getItemObjectFromPanelRef(d._item)
                      if(!o){
                        return 
                      }
                      if(o.type=='form'||(o.type=="modulePanel"&&d._item.module!=_IDE._data._curModule._data.code&&d._item.module)){
                        return 1
                      }
                    }catch(ex){}
                  },
                  _tag:"button",
                  _attr:{
                    title:function(d){
                      if(d._item.pin){
                        return _bzMessage._method._pinOffDetails
                      }else{
                        return _bzMessage._method._pinOnDetails
                      }
                      
                    },
                    "class":function(d){
                      var c="btn-icon bz-small-btn btn-none "
                      var o=_aiModelHandler._getItemObjectFromPanelRef(d._item)
                      if(!o){
                        return c
                      }
                      if(d._item.pin){
                        c+="bz-gui-pin-on"
                      }else{
                        c+="bz-gui-pin-off"
                      }
                      return c
                    }
                  },
                  _jqext:{
                    mousedown:function(e){
                      let _this=this._data._item
                      _this.pin=!_this.pin
                      if(!_this.pin){
                        $(".bz-model-panel-header:eq(0)").mousedown()
                      }
                      _ideModuleManagement._save(0,function(){
                      })
                      e.stopPropagation()
                      e.preventDefault()
                    }
                  }
                }
              ]
            }
          ],
          _jqext:{
            mouseover:function(){
              this.parentElement.draggable=true
            },
            mouseout:function(){
              this.parentElement.draggable=false
            },
            dblclick:function(){
              let _this=this
              if($(_this).find(".bz-play")[0]){
                let dd=_this._data._item
                let d=_aiGeneratorDataHandler._getContentByCode(dd.code)
                    
                _aiPageHandler._doTry(d,0,1,function(){
                  if($(_this).find(".bz-keyboard")[0]){
                    let c=_aiGeneratorDataHandler._getContentByCode(dd.code)
                    _aiPageHandler._exeTmpForm(dd.items,c)
                  }else{
                    let p=_aiGeneratorDataHandler._getContentByCode(dd.panel[0],dd.module)
                    _aiPageHandler._exeTmpClick(dd,p)
                  }
                })
              }                  
            },
            mousedown:function(e){
              _Util._setToTop(this.parentElement)
              var o=this._data._item
              var _switch=BZ._data._uiSwitch
              _switch._curModelPanel=o
              _switch._curModelItemPanel=_switch._curModelPanel
              
              var p=_aiGeneratorDataHandler._getContentByCode(o.code,o.module)
              if(!p){
                return
              }else if(p.from&&p.from[0]){
                let f=p.from[0]
                if(p.type=="form"){
                  p=_aiGeneratorDataHandler._getItemByGroupAndCode(["operations","buttons"],f.code,f.module)
                }else{
                  p=_aiGeneratorDataHandler._getContentByCode(f.code,f.module)
                }
                _switch._activeModelItem=p||_switch._activeModelItem
              }else{
                _switch._activeModelItem=0
                if(p.panel){
                  e.stopPropagation()
                  e.preventDefault()
                }
              }
              o=_aiGeneratorDataHandler._getItemByGroupAndCode(o.group,o.code,o.module)
              var os=[],p=o.path,ps=_aiModelHandler._getParentPanels(_panelCode);
              if(p){
                os.push({path:p,panels:ps})
              }
              if(o.buttons){
                o.buttons.forEach(p=>{
                  if(p.path){
                    os.push({path:p.path,panels:ps})
                  }
                })
              }
              _bzDomPicker._showTmpCover(os)
              _aiModelHandler._drawGUI()
              
              // _aiPageHandler._buildTmpEnvData(_IDE._data._curModule._data.definition.fields,o)
            },
          }
        },
        //body
        {
          _if:"!_data._item.mini&&_data._item.items&&_data._item.items.length&&_data._item.code",
          _tag:"div",_attr:{"class":"bz-model-panel-body"},
          _items:function(d){
            return _aiModelHandler._getModelItems(d._item)
          }
        },
        //Add inner item button
        {
          _if:function(_data){
            try{
              if(_aiModelHandler._isSubModuleRootModel(_data._item)){
                return
              }
              var od=_aiGeneratorDataHandler._getContentByCode(_data._item.code)
              if(!_data._item.items.length){
                return 1
              }
              let _uiSwitch=BZ._data._uiSwitch
              if(_uiSwitch._curModelPanel==_data._item){
                return 1
              }
              if(!_uiSwitch._curModelPanel&&_uiSwitch._curModelItemPanel==_data._item){
                return 1
              }
            }catch(ex){}
          },
          _tag:"div",
          _attr:{
            "class":"bz-model-panel-body bz-model-add-item"
          },
          _items:[
            {
              _tag:"button",
              _attr:{
                "class":"btn btn-icon bz-small-btn bz-plus bz-space-5",
                title:"_bzMessage._method._addElement",
                style:"width:30px;position:absolute;margin-left:calc(50% - 15px);"
              },
              _jqext:{
                click:function(){
                  _aiModelHandler._addModelItem(this._data._item)
                }
              }
            },
            {
              _if:function(d){
                d=_aiGeneratorDataHandler._getContentByCode(d._item.code)
                if(d&&d.type=="form"){
                  return 1
                }
              },
              _tag:"a",
              _attr:{
                style:"position:absolute;right:5px;margin-top:5px;font-size: 11px;color: var(--active-color);"
              },
              _text:"_bzMessage._method._scan",
              _jqext:{
                click:function(){
                  _aiModelHandler._scan(this._data._item)
                }
              }
            }
          ]
        }
      ],
      _dataRepeat:function(){
        setTimeout(function(){
         _aiModelHandler._drawGUI()
        },100)
        if(r){
          return r
        }
        let m=_IDE._data._curModule._data.definition
        if(m&&m.models){
          if(BZ._userHabit.curUIModelTab=='page'){
            return m.models.filter(x=>{
              if(x.code!="api"){
                if(x.pin||x==BZ._data._uiSwitch._curModelPanel||x==BZ._data._uiSwitch._curRefModel){
                  return 1
                }
                x=_aiGeneratorDataHandler._getContentByCode(x.code,x.module)
                return x.type!="form"
              }
            })
          }else{
            return m.models.filter(x=>x.code=="api")
          }
        }
      },
    }
  },
  _getValidateTestFromModelItem:function(d){
    let c=_aiGeneratorDataHandler._getContentByCode(d.code)
    if(!c.testVE){
      c.from.find(x=>{
        x=_aiGeneratorDataHandler._getContentByCode(x.code)
        if(x&&x.testVE){
          c=x
          return x
        }
      })
    }
    let k=_IDE._data._curModule._data.code+"."+c.testVE
    return _ideObjHandler._getDataByPath(k)
  },
  _scan:function(d){
    let _aiApp=_IDE._data._setting.content.aiApp
    BZ._data._uiSwitch._tmpCss={
      requiredField:_aiApp.requiredField,
      customize:_Util._clone(_aiApp.customize),
      formTab:_Util._clone(_aiApp.formTab)
    }
    
    let _tmpCss=BZ._data._uiSwitch._tmpCss;

    _Util._confirmMessage({
      _tag:"div",
      _items:[
        {
          _tag:"div",
          _items:[
            //required fields
            {
              _tag:"div",
              _attr:{
                class:"bz-css-picker-box"
              },
              _items:[
                _uiHandler._getPickCss({
                  _title:"_bzMessage._model._requiredMarkDesc",
                  _label:_bzMessage._model._requiredMark,
                  _model:"BZ._data._uiSwitch._tmpCss.requiredField"
                })
              ]
            },
            //customize input/dropdown list
            {
              _tag:"div",
              _items:[
                {
                  _tag:"div",
                  _items:[
                    {
                      _tag:"div",
                      _attr:{
                        class:"bz-css-picker-box",
                        style:"margin-top:10px;"
                      },
                      _items:function(d){
                        return [
                          _uiHandler._getPickCss({
                            _title:"_bzMessage._model._customizeDesc",
                            _label:_bzMessage._model._customizeInput,
                            _model:function(v){
                              return "BZ._data._uiSwitch._tmpCss.customize["+d._idx+"]"
                            },
                            _delete:function(){
                              BZ._data._uiSwitch._tmpCss.customize.splice(d._idx,1)
                              _Util._resizeModelWindow()
                            }
                          })
                        ]
                      },
                      _dataRepeat:"BZ._data._uiSwitch._tmpCss.customize"
                    }
                  ]
                },
                {
                  _if:function(){
                    return BZ._data._uiSwitch._tmpCss.customize.find(x=>!x)!==''
                  },
                  _tag:"button",
                  _attr:{
                    class:"btn btn-icon bz-plus-black btn-icon-text bz-small-btn bz-trigger-btn bz-top-space-10"
                  },
                  _text:"_bzMessage._method._addCustomize",
                  _jqext:{
                    click:function(){
                      BZ._data._uiSwitch._tmpCss.customize.push("")
                      _Util._resizeModelWindow()
                    }
                  }
                }
              ]
            },
            //form tab
            {
              _tag:"div",
              _items:[
                {
                  _tag:"div",
                  _items:[
                    {
                      _tag:"div",
                      _attr:{
                        class:"bz-css-picker-box",
                        style:"margin-top:10px;"
                      },
                      _items:function(d){
                        return [
                          _uiHandler._getPickCss({
                            _title:"_bzMessage._model._formTabDesc",
                            _label:_bzMessage._model._formTab,
                            _model:function(v){
                              return "BZ._data._uiSwitch._tmpCss.formTab["+d._idx+"]"
                            },
                            _delete:function(){
                              BZ._data._uiSwitch._tmpCss.formTab.splice(d._idx,1)
                              _Util._resizeModelWindow()
                            }
                          })
                        ]
                      },
                      _dataRepeat:"BZ._data._uiSwitch._tmpCss.formTab"
                    }
                  ]
                },
                {
                  _if:function(){
                    return BZ._data._uiSwitch._tmpCss.formTab.find(x=>!x)!==''
                  },
                  _tag:"button",
                  _attr:{
                    class:"btn btn-icon bz-plus-black btn-icon-text bz-small-btn bz-trigger-btn bz-top-space-10"
                  },
                  _text:"_bzMessage._method._addCustomize",
                  _jqext:{
                    click:function(){
                      BZ._data._uiSwitch._tmpCss.formTab.push("")
                      _Util._resizeModelWindow()
                    }
                  }
                }
              ]
            }
          ]
        },
        {
          _if:function(){
            return d.items.length
          },
          _tag:"hr",
        },
        {
          _if:function(){
            return d.items.length
          },
          _tag:"div",
          _attr:{
            class:"alert-warning-strong bz-note-text"
          },
          _text:"_bzMessage._model._confirmScan"
        },
      ]
    },[{
      _title:_bzMessage._method._continue,
      _click:function(c){
        c._ctrl._close()
        if(JSON.stringify(_tmpCss.customize)!=JSON.stringify(_aiApp.customize)||_tmpCss.requiredField!=_aiApp.requiredField||_tmpCss.formTab!=_aiApp.formTab){
          _aiApp.requiredField=_tmpCss.requiredField
          _aiApp.customize=_tmpCss.customize
          _aiApp.formTab=_tmpCss.formTab
          return _ideVersionManagement._save(function(){
            _doScan()
          })
        }
        _doScan()
      }
    }],_bzMessage._model._scanForm)
    
    function _doScan(){
      _aiFlagHandler._scanForm(function(v){
        let _path=_aiGeneratorDataHandler._getContentByCode(d.code).path
        let m=_IDE._data._curModule._data
        m.definition=v._moduleMap[m.alias].definition
        let c=_aiGeneratorDataHandler._getContentByCode(d.code)

        Object.keys(c.formValues).forEach(f=>{
          m.definition.fields.find(x=>{
            if(x.code==f&&x.path[0].includes("BZ.TW.document")){
              x.path.shift()
              return 1
            }
          });
          c.buttons.forEach(x=>{
            if(x.path[0].includes("BZ.TW.document")){
              x.path.shift()
            }
          })
        })

        if(!_Util._isEmpty(_path)){
          c.path=_path
        }

        _ideModuleManagement._save(0,function(){
          _aiModelHandler._refreshGUI()
          alert(_bzMessage._common._complete)
        })
      },d)
    }
  },
  ////Panel Item !!!!
  //_panel: element panel
  //g: type (operations, operations, webpages, fields ....)
  //o: the element
  _getModelItemViewDef:function(_panel,g,o,_hasBorder){
    var pd=_aiGeneratorDataHandler._getContentByCode(_panel.code),
        _uiSwitch=BZ._data._uiSwitch
    return {
      _tag:"div",
      _data:{_item:o,_panel},
      _after:function(o){
        setTimeout(()=>{
          if($(o).hasClass("active")){
            _Util._scrollUpSelectedItem(o.parentElement,o)
          }
        },100)
      },
      _attr:{
        "class":function(d,cc,oo){
          d=d._item
          if(!_panel.items.find(x=>x.code==d.code)){
            $(oo).remove()
            _aiModelHandler._drawGUI()
            return
          }
          var c="bz-model-item"
          if(_uiSwitch._activeModelItem==o){
            c+=" active"
          }
          if(_aiModelHandler._isDisableByDependence(o)){
            c+=" bz-grey"
          }
          if(d.disable){
            c+=" bz-model-item-disable"
          }
          if(d.preSteps&&d.preSteps.length){
            c+=" bz-pre-steps"
          }
          if(d.endSteps&&d.endSteps.length){
            c+=" bz-end-steps"
          }
          return c
        },
        style:function(d){
          var v=_uiSwitch._insert,c="";
          if(_hasBorder){
            c="border-top:var(--bz-border);"
          }
          if(v&&v._data._item==o&&v._data._panel==_panel){
            return "border:0;border-"+v._pos+":2px dotted var(--active-color);"+c
          }
          return "border:0;"+c;
        },
        draggable:true,
        ondragend:"_aiModelHandler._dragleaveItem()",
        ondragover:"_aiModelHandler._dragoverItem(this,event)",
        ondragstart:"_aiModelHandler._dragstartPanel(event,'"+(g+":"+_panel.code+":"+o.code)+"')"
      },
      _items:[
        //icon
        {
          _tag:"a",
          _attr:{
            "after-text":"_bzMessage._common._wordSign",
            "class":function(d){
              var c="btn-icon bz-small-btn pull-left bz-no-edit "
              if(g=="operations"){
                let t=_ideObjHandler._getDataByPath(_IDE._data._curModule._data.code,o.testCode)
                if(o.level=="multiple"){
                  c+="bz-model-multiple-opr "
                }
                c+="bz-operation-icon "
                if(o.type=="delete"){
                  c+="bz-cross"
                }else if(o.type=="edit"){
                  c+="bz-edit"
                }else if(o.type=="add"){
                  c+="bz-plus"
                }else if(o.type=="search"){
                  c+="bz-search"
                }else if(o.type=="filter"){
                  c+="bz-filter"
                }else if(o.type=="testVE"){
                  c+="bz-validation"
                }else{
                  c+="bz-unit"
                }
                if(_aiModelHandler._isDisableByDependence(o)){
                  c+=" bz-model-item-disable"
                }
              }else if(g=="fields"){
                let to=_aiGeneratorDataHandler._getOperationByPanel(_panel)
                if(pd.type!="form"||_aiGenerator._isReadonly(o,pd)){
                  c+="bz-word"
                }else if(o.label){
                  c+="bz-tag"
                }else{
                  if(["viewData"].includes(o.type)){
                    c+="bz-view"
                  }else if(o.type.startsWith("module")){
                    if(!o.module){
                      c+="bz-module bz-disabled-icon"
                    }else{
                      c+="bz-ai-model"
                    }
                  }else if(["form"].includes(pd.type)){
                    c+="bz-keyboard"
                  }else{
                    c+="bz-field"
                  }
                }
              }else if(g=="relatedModules"){
                c+="bz-ai-model"
              }else if(g=="webpages"){
                c+="bz-link"
              }else if(g=="buttons"){
                if(o.lanuchPanel){
                  if(o.operation){
                    c+="bz-unit"
                  }else if(o.type=="next"){
                    c+="bz-assign"
                  }else if(o.type=="form-tab"){
                    c+="bz-form-tab"
                  }else if(o.type=="ex-insert"){
                    c+="bz-assign"
                  }
                }else if(o.type=="close"){
                  c+="bz-close"
                }else{
                  c+="bz-button"
                }
              }else{
                c+="bz-entry"
              }
              return c+" bz-space-5"
            },
            style:function(){
              let c="cursor:default;"
              if(g=="operations"){
                if(!o.testCode||!_ideObjHandler._getDataByPath(_IDE._data._curModule._data.code,o.testCode)){
                  c+="background-color:#CCC"
                }
              }
              return c
            }
          }
        },
        //edit
        {
          _tag:"button",
          _attr:{
            "class":"btn btn-icon bz-small-btn btn-none bz-edit bz-model-edit bz-space-5",
            title:"_bzMessage._method._edit",
            style:"float:left;"
          }
        },
        //text
        {
          _tag:"div",
          _attr:{
            "init-text":function(d){
              if(d._item.asStdFun&&d._item.method=='GET'){
                return _bzMessage._common._initial
              }
            },
            "class":function(d){
              var c="text "
              if(o.dependencies&&o.dependencies.length){
                c+="dependency "
              }

              if(o.required){
                c+="item-required "
              }

              if(d._item.asStdFun&&d._item.method=='GET'){
                c+="bz-initial "
                
                if(!d._item.initParameter){
                  c+="bz-miss-setting"
                }
              }

              return c
            }
          },
          _items:[
            {
              _tag:"span",
              _attr:{
                class:function(d){
                  if(_panel.code=="api"){
                  }else if(o.fakeElement){
                    return "bz-fake-element"
                  }else if(_Util._isEmpty(o.path)&&_Util._isEmpty(o.url)&&!o.fakeElement){
                    if(d._panel&&d._panel.items.find(x=>x.code==d._item.code&&x.group=="relatedModules")){
                      return
                    }
                    return "bz-miss-path"
                  }else if(!_Util._isEmpty(o.url)){
                    return "bz-model-url-item"
                  }
                }
              },
              _text:function(){
                if(g=="relatedModules"){
                  var m=_ideObjHandler._getDataByPath(o.module);
                  if(m){
                    return m._data.name
                  }else{
                    return _bzMessage._model._noExit
                  }
                }else if(g=="operations"){
                  var t=_ideObjHandler._getDataByPath(_IDE._data._curModule._data.code,o.testCode)
                  if(t){
                    return t._data.name
                  }
                }else if(g=="buttons"&&o.type=="confirm"){
                  return o.name+" ("+(o.confirmMsg||" - ")+")"
                }else{
                  return o.name
                }
              },
            }
          ]
        },
        //link-pointer
        {
          _if:function(){
            return _aiModelHandler._hasLanuchPanel(o)
          },
          _tag:"div",
          _attr:{
            "class":function(d){
              var c="bz-item-right-point"
              if(o.finalPanel){
                c="bz-item-left-point"
              }else if(d._item.type=="modulesub"||d._item.testCode){
                if(_uiSwitch._activeModelItem!=d._item){
                  let x=_aiModelHandler._getModelByCode(d._item.lanuchPanel)
                  if(!x||!x.pin){
                    c=""
                  }
                }
              }else if(d._item.type=="outopr"){
                c=""
              }
              c+=" t"+(o.lanuchPanel||o.finalPanel)
              return c
            }
          }
        },
        //attribute button
        {
          _tag:"div",
          _attr:{
            "class":"bz-ai-panel-ctrl"
          },
          _items:[
            //play
            {
              _if:function(){
                return !_aiModelHandler._isSubModuleRootModel(_panel)
              },
              _tag:"button",
              _attr:{
                "class":"btn btn-icon bz-small-btn btn-none bz-model-menu bz-play",
                title:function(){
                  if(_panel.code!="api"){
                    return _bzMessage._method._tryPath
                  }else{
                    return _bzMessage._method._tryIt
                  }
                }
              },
              _jqext:{
                click:function(e){
                  if(_panel.code=="api"){
                    _aiPageHandler._exeTmpAPIRequest(this._data._item)
                  }else{
                    _aiPageHandler._doTry(o,_panel.code)
                  }
                }
              }
            },
            //keyboard
            {
              _if:function(){
                return g=="fields"&&pd.type=="form"
              },
              _tag:"button",
              _attr:{
                "class":"btn btn-icon bz-small-btn btn-none bz-model-menu bz-keyboard",
                title:"_bzMessage._method._tryFillValue"
              },
              _jqext:{
                click:function(e){
                  _aiPageHandler._exeTmpSetInput(o,pd)
                }
              }
            },
            //test unit
            {
              _if:function(d){
                return d._item.testCode
              },
              _tag:"button",
              _attr:{
                "class":"btn btn-icon bz-small-btn btn-none bz-model-menu bz-unit",
                title:"_bzMessage._common._view+': '+_data._item.name"
              },
              _jqext:{
                click:function(e){
                  let d=this._data._item
                  let k=_IDE._data._curModule._data.code+"."+d.testCode
                  let o=_ideObjHandler._getDataByPath(k)
                  
                  _guiModuleHandler._openDetails({
                    k:k,
                    t:o._data,
                    td:o,
                    from:[]
                  })
                  
                }
              }
            },
            //test unit
            {
              _if:function(d){
                d=d._item
                return d.type=="outopr"&&d.operation&&d.lanuchModule
              },
              _tag:"button",
              _attr:{
                "class":"btn btn-icon bz-small-btn btn-none bz-model-menu bz-unit",
                title:function(d){
                  d=d._item
                  let m=_aiGeneratorDataHandler._getModuleObject(d.lanuchModule)
                  if(m){
                    d=m._data.definition.operations.find(x=>x.code==d.operation)
                    if(d){
                      return "["+m._data.code+"."+d.testCode+"] "+d.name
                    }
                  }
                }
              },
              _jqext:{
                click:function(e){
                  let d=this._data._item
                  let m=_aiGeneratorDataHandler._getModuleObject(d.lanuchModule)
                  if(m){
                    d=m._data.definition.operations.find(x=>x.code==d.operation)
                    let k=m._data.code+"."+d.testCode
                    let o=_ideObjHandler._getDataByPath(k)
                        
                    
                    _guiModuleHandler._openDetails({
                      k:k,
                      t:o._data,
                      td:o,
                      from:[]
                    })
                  }
                }
              }
            },
            //popout
            {
              _if:function(d){
                return d._item.module
              },
              _tag:"button",
              _attr:{
                "class":"btn btn-icon bz-small-btn btn-none bz-model-menu bz-popout",
                title:"_bzMessage._model._gotoRefModule"
              },
              _jqext:{
                mousedown:function(e){
                  BZ._setHash(this._data._item.module)
                  e.stopPropagation()
                  e.preventDefault()
                }
              }
            },
            //copy
            {
              _tag:"button",
              _attr:{
                class:"btn btn-icon bz-small-btn bz-copy"
              },
              _jqext:{
                click:function(){
                  _aiModelHandler._copy(this._data._item,g)
                }
              }
            },
            //delete
            {
              _if:function(){
                return !_aiModelHandler._isSubModuleRootModel(_panel)
              },
              _tag:"button",
              _attr:{
                "class":"btn btn-icon bz-small-btn btn-none bz-model-menu bz-delete",
                title:"_bzMessage._method._delete"
              },
              _jqext:{
                click:function(e){
                  _aiModelHandler._deleteItemFromUI(o,_panel,g,this)
                }
              }
            }
          ]
        }
      ],
      _jqext:{
        mouseover:function(e){
          if(pd.path){
            let d=_Util._clone(this._data._item)
            clearTimeout(window._mouseoverElementTimer)
            window._mouseoverElementTimer=setTimeout(()=>{
              d=_aiGeneratorDataHandler._getStdPath(_Util._clone(pd.path),d,1,pd)
              _bzDomPicker._flashTmpCover(d)
            },300)
          }
        },
        mouseout:function(){
          clearTimeout(window._mouseoverElementTimer)
        },
        mousedown:function(e){
          $(_Util._getClosestElement(this,this,".bz-model-panel-header")).mousedown();
          setTimeout(()=>{
            _uiSwitch._activeModelItem=o
            if(!o.fakeElement&&_panel.code!="api"){
              let p=_aiGeneratorDataHandler._getStdPath(pd.path,o,o==_uiSwitch._curField,pd)
              p=_aiPageHandler._updateElementPathByDemoValue(p,1)
              _bzDomPicker._flashTmpCover({path:p,panels:_aiModelHandler._getParentPanels(_panel.code)},1)
            }
            e.stopPropagation()
            if(_aiPageHandler._isSettingWinOpen()||$(e.target).hasClass("bz-edit")){
              _aiModelHandler._showDetails(o,g)
            }
            if(_aiModelHandler._hasLanuchPanel(o)){
              return setTimeout(()=>{
                _aiModelHandler._drawGUI()
              },50)
            }
            
          },100)
        },
        dblclick:function(){
          if($(this).find(".bz-play")[0]){
            let dd=this._data._item
            if($(this).find(".bz-keyboard")[0]){
              _aiPageHandler._exeTmpSetInput(o,pd)
            }else{
              let p=_aiGeneratorDataHandler._getContentByCode(dd.panel[0],dd.module)
              _aiPageHandler._exeTmpClick(dd,p)
            }
          }                  
        }
      }
    }
  },
  _hasLanuchPanel:function(o){
    return (o.lanuchPanel||o.finalPanel)&&!_aiModelHandler._isOuterPanel(o)
  },
  _getModelItems:function(_panel){
    var _map={},md=_IDE._data._curModule._data.definition,g,ms,rs=[],rr=[],bs=[];
    _Util._spliceAll(_panel.items,o=>{
      return !_aiGeneratorDataHandler._getItemByGroupAndCode(o.group,o.code)
    })
    for(var i=0;i<_panel.items.length;i++){
      var o=_panel.items[i]
      g=o.group
      ms=_map[g]=_map[g]||[]
      var oo=_aiGeneratorDataHandler._getItemByGroupAndCode(g,o.code)
      if(g=="contents"&&!_aiModelHandler._isEnterType(oo.type)){
        rr.push(_aiModelHandler._getPanelViewDef([o],_panel.code))
      }else{
        ms.push(oo)
      }
    }
    let _hsaItem=0
    _map.operations&&_map.operations.forEach(o=>{
      _hsaItem=1
      rs.push(_aiModelHandler._getModelItemViewDef(_panel,"operations",o))
    })
    _map.contents&&_map.contents.forEach((o,j)=>{
      if(_aiModelHandler._isEnterType(o.type)){
        rs.push(_aiModelHandler._getModelItemViewDef(_panel,"contents",o,_hsaItem&&!j))
        _hsaItem=1
      }
    })
    _map.webpages&&_map.webpages.forEach((o,j)=>{
      rs.push(_aiModelHandler._getModelItemViewDef(_panel,"webpages",o,_hsaItem&&!j))
      _hsaItem=1
    })
    _map.fields&&_map.fields.forEach((o,j)=>{
      rs.push(_aiModelHandler._getModelItemViewDef(_panel,"fields",o,_hsaItem&&!j))
      _hsaItem=1
    })
    _map.relatedModules&&_map.relatedModules.forEach((o,j)=>{
      rs.push(_aiModelHandler._getModelItemViewDef(_panel,"relatedModules",o,_hsaItem&&!j))
      _hsaItem=1
    })

    _map.buttons&&_map.buttons.sort((a,b)=>{
      let _list=["insert","ex-insert","outopr","form-tab","confirm","next","submit","close","cancel"]
      return _list.indexOf(a.type)-_list.indexOf(b.type)
    }).forEach((o,j)=>{
      bs.push(_aiModelHandler._getModelItemViewDef(_panel,"buttons",o,_hsaItem&&!j))
    })
    rr.forEach(r=>{rs.push(r)})
    rs=[{
      _tag:"div",
      _attr:{
        class:"bz-model-fields-box"
      },
      _items:rs
    }]
    rs.push(...bs)
    return rs
  },
  _getOrThrowNoAIModuleError:function(m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    if(!m._data.definition){
      throw Error(_Util._formatMessage(_bzMessage._system._error._noAIModuleError,[m._data.code,m._data.name]))
    }
    return m
  },
  _copy:function(v,g){
    let md=_IDE._data._curModule._data.definition
    let d=_getItemData(v,g)

    _IDE._copy(d,0,"model")

    function _getItemData(v,g){
      let d=_Util._clone(_aiGeneratorDataHandler._getItemByGroupAndCode(g,v.code))
      g={
        data:d,
        g:g
      }

      if(v.items){
        v.items.forEach(x=>{
          if(["operations","fields","buttons"].includes(x.group)){
            g[x.group]=g[x.group]||[]
            g[x.group].push(_getItemData(x,x.group))
            delete d[x.group]
          }
        })
      }

      if(d.lanuchPanel){
        _assignPanelData(d,g)
      }
      return g
    }

    function _assignPanelData(d,g){
      g.panelDetails=_getItemData(_aiModelHandler._getModelByCode(d.lanuchPanel),"contents")
    }
  },
  _paste:function(v,g){
    let d=_IDE._data._clipData.items,
        m=_IDE._data._curModule._data,
        md=m.definition,
        _save;

    d=_Util._clone(d)
    _doPase(d,v,g)

    if(_save){
      _storeOperations()
    }

    function _storeOperations(){
      let o=md.operations.find(o=>!o.testCode);
      if(o){
        _ideTestManagement._save({
          name:o.name,
          enterPoint:{type:"follow"},
          type:"unit",
          subtype:"operation",
          tag:o.type,
          hostId:m.defaultHostId,
          definition:{code:o.code}
        },m,function(t){
          o.testCode=t.code
          _storeOperations()
        })
      }else{
        _ideModuleManagement._save()
        _aiModelHandler._refreshGUI()
      }
    }

    function _doPase(d,v,g){
      let vd=_aiGeneratorDataHandler._getItemByGroupAndCode(g,v.code)
      if(d.g=="fields"){
        _save=_doPasteField(v,vd,d.data)||_save
      }else if(d.g=="buttons"){
        _save=_doPasteButton(v,vd,d.data,d.panelDetails)||_save
      }else if(d.g=="operations"){
        _save=_doPasteOperation(v,vd,d.data,d.panelDetails)||_save
      }else{
        if(d.fields){
          d.fields.forEach(f=>{
            _save=_doPasteField(v,vd,f.data)||_save
          })
        }
        if(d.buttons){
          d.buttons.forEach(b=>{
            _save=_doPasteButton(v,vd,b.data,b.panelDetails)||_save
          })
        }
        if(d.operations){
          d.operations.forEach(o=>{
            _save=_doPasteOperation(v,vd,o.data,o.panelDetails)||_save
          })
        }
      }
    }

    function _doPasteOperation(v,vd,o,p){
      if(!md.operations.find(x=>x.name==o.name)){
        o.code=_aiAPI._newId()
        delete o.testCode
        o.panel=[v.code]

        md.operations.push(o)
        v.items.push({
          code:o.code,
          group:"operations"
        })
        _addPanel(p,o,v)
        return 1
      }
    }

    function _doPasteButton(v,vd,b,p){
      vd.buttons=vd.buttons||[]
      if(!vd.buttons.find(x=>x.name==b.name)){
        b.code=_aiAPI._newId()
        vd.buttons.push(b)
        v.items.push({
          code:b.code,
          group:"buttons"
        })
        _addPanel(p,b,v)
        return 1
      }
    }

    function _addPanel(p,_from,v){
      if(p){
        let pd=p.data
        pd.code=_from.lanuchPanel=_aiAPI._newId()
        pd.from=[
          {
            code:_from.code,
            module:m.code
          }
        ]
        if(pd.type=="form"){
          pd.formValues={dynamicData:"on"}
        }

        md.contents.push(pd)
        let pm={
          code:pd.code,
          group:"contents",
          items:[],
          x:parseInt(v.x)+250+"px",
          y:v.y
        }
        md.models.push(pm)
        if(p.fields){
          p.fields.forEach(f=>{
            _doPasteField(pm,pd,f.data)
          })
        }
        if(p.buttons){
          p.buttons.forEach(b=>{
            _doPasteButton(pm,pd,b.data,b.panelDetails)
          })
        }
        if(p.operations){
          p.operations.forEach(o=>{
            _doPasteOperation(pm,pd,o.data,o.panelDetails)
          })
        }
      }
    }

    function _doPasteField(v,vd,f){
      if(!md.fields.find(x=>{
        if(x.name==f.name){
          f=x
          return 1
        }
      })){
        md.fields.push(f)
        f.dependencies=[]
        f.code=_aiAPI._newId()
      }
      if(!v.items.find(x=>x.code==f.code)){
        v.items.push({
          code:f.code,
          group:"fields"
        })
        if(vd.type=="form"){
          vd.formValues=vd.formValues||{}
          delete vd.formValues.dynamicData
          vd.formValues[f.code]={
            dynamicData:"on"
          }
        }
        return 1
      }
    }
  },
  _isPasteable:function(v){
    let d=_IDE._data._clipData
    if(d&& d.level=='model'){
      d=d.items
      let dd=_aiGeneratorDataHandler._getItemByGroupAndCode("contents",v.code)
      if(dd.type==d.data.type){
        return 1
      }
      if(dd.type=="form"){
        return ["fields","buttons"].includes(d.g)||"form"==d.data.type
      }
      if(dd.type=="page"){
        return d.data.type=="enterModule"
      }
      if(dd.type=="modulePanel"){
        return ["list","table"].includes(d.data.type)||d.g=="operations"
      }
      if(["dataPanel","list","table"].includes(dd.type)){
        return ["fields","operations"].includes(d.g)
      }
      return d.g!="buttons"
    }
  }
};

//const _aiModelPanelViewDef=;//*********************************************************************///
//search word list:
//_contentViewDef
//*********************************************************************///

var _aiPageHandler={
  _data:_CtrlDriver._buildProxy({}),
  _operationKeys:["add","edit","delete"],
  _finalOperationKeys:["add","edit","delete"],
  _isCheckout:function(){
    return BZ._isCheckout(_IDE._data._curModule)
  },
  _createStdModels:function(){
    let m=_IDE._data._curModule,_templateModule
    if(!m){
      return
    }
    m=m._data
    let md=m.definition

    if(BZ._isAutoRunning()||BZ._isPlaying()||m.bt!="data"||!md||md.operations.length){
      return
    }
    let _enter=md.contents.find(x=>x.type=="enterModule"),
        _aiApp=_IDE._data._setting.content.aiApp
    BZ._data._uiSwitch._tmpModels={
      _operationMap:{
        add:{
          _chk:"on",
          _name:_getOperationName("add")
        },
        edit:{
          _chk:"on",
          _name:_getOperationName("edit")
        },
        delete:{
          _chk:"on",
          _name:_getOperationName("delete")
        }
      },
      _menuChk:_aiApp.menu&&"on",
      _menuCss:_aiApp.menu
    };

    let _tmpModels=BZ._data._uiSwitch._tmpModels._operationMap
    
    let _templates=_IDE._data._curVersion.modules.filter(x=>x.bt=='data'&&x.definition.operations.length)

    _Util._confirmMessage({
      _tag:"div",
      _update:function(){
        _Util._resizeModelWindow()
      },
      _data:_tmpModels,
      _items:[
        {
          _tag:"h3",
          _text:"_bzMessage._model._askCreateStdModels"
        },
        {
          _tag:"div",
          _items:[
            {
              _tag:"div",
              _attr:{
                style:"margin:5px;"
              },
              _items:[
                {
                  _tag:"label",
                  _attr:{
                    class:"input-group",
                    style:"display:flex;"
                  },
                  _items:[
                    {
                      _tag:"input",
                      _attr:{
                        type:"checkbox",
                        style:"margin-top:8px"
                      },
                      _dataModel:"_data._item._chk"
                    },
                    {
                      _tag:"div",
                      _attr:{
                        class:function(d){
                          d=d._key
                          return 'bz-icon bz-small-btn bz-'+(d=="add"?"plus":d)
                        },
                        style:"margin-top:8px"
                      }
                    },
                    {
                      _tag:"input",
                      _attr:{
                        class:"bz-samply-input",
                        style:"flex:1"
                      },
                      _dataModel:"_data._item._name"
                    }
                  ]
                }
              ],
              _dataRepeat:"BZ._data._uiSwitch._tmpModels._operationMap"
            }
          ]
        },
        {
          _if:function(){
            return !_enter
          },
          _tag:"hr"
        },
        {
          _if:function(){
            return !_enter
          },
          _tag:"div",
          _attr:{
            class:function(){
              if(BZ._data._uiSwitch._tmpModels._menuChk){
                return "bz-css-picker-box"
              }
            }
          },
          _items:[
            _uiHandler._getPickCss({
              _title:"_bzMessage._model._appMenuDesc",
              _label:_bzMessage._model._appMenu,
              _chk:"BZ._data._uiSwitch._tmpModels._menuChk",
              _model:"BZ._data._uiSwitch._tmpModels._menuCss"
            })
          ]
        },
        {
          _tag:"div",
          _items:[
            _stdComponent._getSelectViewDef({
              _if:function(){
                return _templates.length
              },
              _label:"_bzMessage._common._template",
              _value:"_data._item.code",
              _text:"_ideModuleManagement._getStdDescription(_data._item)",
              _dataModel:"BZ._data._uiSwitch._tmpModels._template",
              _dataRepeat:function(){
                return _templates
              },
              _boxStyle:"margin:10px 0",
              _empty:1
            }),
            {
              _tag:"div",
              _attr:{
                class:"bz-note-text"
              },
              _text:"_bzMessage._model._templateDesc"
            }
          ]
        },
      ]
    },[{
      _title:_bzMessage._method._yes,
      _click:function(c){
        c._ctrl._close()
        _prepareTempateData()
        if(!_enter){
          if(BZ._data._uiSwitch._tmpModels._menuChk){
            if(BZ._data._uiSwitch._tmpModels._menuCss!=_aiApp.menu){
              _aiApp.menu=BZ._data._uiSwitch._tmpModels._menuCss
              return _ideVersionManagement._save(function(){
                _createEnter()
              })
            }
          }
          _createEnter()
        }else{
          _createModuleItems()
        }
      }
    }],0,0,0,0,1);
    
    function _prepareTempateData(){
      let t=BZ._data._uiSwitch._tmpModels._template
      
      if(t){
        _templateModule={}
        let to=_ideObjHandler._getDataByPath(t)._data
        let tn=_aiGeneratorDataHandler._getCurModuleDataName(to),
            mn=_aiGeneratorDataHandler._getCurModuleDataName(m)
        t=to.definition
        t.operations.forEach(x=>{
          if(["add","edit","delete"].includes(x.type)){
            _templateModule[x.type]={
              _path:x.path,
              _panel:x.panel
            }
          }
        });
        _templateModule.startPanel=t.startPanel
        let tt=t.contents.find(x=>x.type=="enterDetails")
        if(tt){
          _templateModule._details={
            _path:tt.path,
            _panel:tt.panel
          }
        }        
        Object.values(_templateModule).forEach(x=>{
          x._path=(x._path||[]).map(x=>{
            if(x.constructor==String){
              if(x.includes(tn)){
                x=x.replace(tn,mn)
              }else if(x.includes(to.name)){
                x=x.replace(to.name,m.name)
              }else if(x.includes(t.alias)){
                x=x.replace(to.alias,m.alias)
              }
            }
            return x
          });
          x._panel=(x._panel||[]).map(p=>{
            p=t.contents.find(y=>y.code==p)
            if(p){
              return _Util._clone(p)
            }
          }).filter(x=>x)
        })
      }
    }
    
    function _getOperationName(v){
      let r=m.name;
      _IDE._data._curVersion.modules.find(x=>{
        if(x.bt=="data"){
          return x.tests.find(t=>{
            if(t.subtype=="operation"&&t.alias==v){
              if(!t.name.toLowerCase().includes(m.name.toLowerCase())){
                r=""
              }
              return 1
            }
          })
        }
      })

      return _Util._formatMessage(_bzMessage._model._operation[v],[r]).trim()
    }

    function _createModuleItems(){
      _insertStdField()
      BZ._userHabit.curUIModelTab="page"
      setTimeout(()=>{
        let _modulePanel=_aiModelHandler._getModelByCode(_aiGeneratorDataHandler._getContentByType("modulePanel")[0].code)
        _modulePanel.x="50px"
        _modulePanel.y="150px"

        _aiModelHandler._addModelItem(_modulePanel,function(){
          _createDetails()
        });

        let _subModules=_aiPageHandler._contentViewDef._data._subModules,_table;

        if(_tmpModels.add._chk){
          _subModules.push({
            code:_aiAPI._newId(),
            path:(_templateModule&&_templateModule.add&&_templateModule.add._path)||["BZ.TW.document",":link("+_tmpModels.add._name+")",0],
            type:"add",
            name:_tmpModels.add._name
          });
        }
        if(_templateModule){
          for(let k in _templateModule){
            let o=_templateModule[k]
            if(o._panel){
              o._panel.forEach(x=>{
                if(["table","list"].includes(x.type)){
                  if(!_subModules.find(y=>y.code==x.code)){
                    _table=x
                    _subModules.push(x)
                  }
                }
              })
            }
          }
        }

        if(!_table){
          _subModules.push(
            {
              code:_aiAPI._newId(),
              path:["BZ.TW.document","TABLE"],
              type:"table",
              name:_bzMessage._model._panelType.table
            }
          )
        }

        $(".bz-add-elements").click()
      },100)
    }
    
    function _createDetails(){
      if(!_templateModule||_templateModule._details||((_tmpModels.edit._chk||_tmpModels.delete._chk)&&!_templateModule.edit&&!_templateModule.delete)){
        let _table=_templateModule&&_templateModule._details?_templateModule._details._panel[0].type:"table"
        _table=_aiModelHandler._getModelByCode(_aiGeneratorDataHandler._getContentByType(_table)[0].code)
        _aiModelHandler._addModelItem(_table,function(){
          let _dataPanel=_aiModelHandler._getModelByCode(_aiGeneratorDataHandler._getContentByType("dataPanel")[0].code)
          _dataPanel.x="50px"
          _dataPanel.y="350px"
          _createEditOpr(_dataPanel)
        });
        _aiPageHandler._contentViewDef._data._subModules=[{
          code:_aiAPI._newId(),
          path:[],
          type:"enterDetails",
          name:_bzMessage._model._enter._options.enterDetails
        }];

        $(".bz-add-elements").click()
      }else{
        _createEditOpr()
      }
    }
    
    function _getOprPanel(_type){
      if(_templateModule){
        let o=md.contents.find(x=>{
          if(_templateModule[_type]){
            return _templateModule.edit._panel.find(y=>x.type==y.type)
          }else if(_templateModule.edit){
            return (_templateModule.edit||_templateModule.delete)._panel.find(y=>x.type==y.type)
          }
        })
        return _aiModelHandler._getModelByCode(o.code,m)
      }
    }
    function _createEditOpr(_dataPanel){
      if(!_tmpModels.edit._chk){
        return _createDeleteOpr(_dataPanel)
      }

      _aiModelHandler._addModelItem(_getOprPanel("edit")||_dataPanel,function(){
        _createDeleteOpr(_dataPanel)
      });

      _aiPageHandler._contentViewDef._data._subModules=[{
        code:_aiAPI._newId(),
        path:(_templateModule&&_templateModule.edit&&_templateModule.edit._path)||["BZ.TW.document",":link("+_bzMessage._method._edit+")",0],
        type:"edit",
        name:_tmpModels.edit._name
      }];


      $(".bz-add-elements").click()
    }

    function _createDeleteOpr(_dataPanel){
      if(!_tmpModels.delete._chk){
        return _createFlow()
      }

      _aiModelHandler._addModelItem(_getOprPanel("delete")||_dataPanel,function(){
        setTimeout(()=>{
          let _removes=[],j=0
          md.contents.forEach((x,i)=>{
            if(x.type=="form"){
              x=_aiModelHandler._getModelByCode(x)
              if(x){
                x.x="300px"
                x.y=50+150*j+"px"
                j++
              }else{
                _removes.push(i)
              }
            }
          });
          if(_removes.length){
            _removes.reverse()
            _removes.forEach(x=>md.contents.splice(x,1))
          }
          _createFlow()
        },1000)
      });

      _aiPageHandler._contentViewDef._data._subModules=[{
        code:_aiAPI._newId(),
        path:(_templateModule&&_templateModule.delete&&_templateModule.delete._path)||["BZ.TW.document",":link("+_bzMessage._method._delete+")",0],
        type:"delete",
        name:_tmpModels.delete._name
      }];


      $(".bz-add-elements").click()
    }
    
    function _createFlow(){
      if(_tmpModels.add._chk&&!_IDE._data._curModule._data.definition.moduleDataFlow.start.to[1]){
        BZ._userHabit.curUIModelTab="flow"
        setTimeout(()=>{
          $("#bf-0 .bz-plus").click()
          setTimeout(()=>{
            $util.triggerChangeEvent($("select")[0],_bzMessage._model._stdStatus.created)
            setTimeout(()=>{
              $("button.btn-primary").click()
              setTimeout(()=>{
                _addDeleteFlow(Date.now())
              },1000)
            },1000)
          },1000)
        },1000)
      }else{
        _ideModuleManagement._save(m,function(){
          _complete()
        })
      }
    }
    
    function _complete(){
      alert(_bzMessage._common._complete)
      _aiModelHandler._refreshGUI()
    }
    
    function _addDeleteFlow(t){
      if(_tmpModels.delete._chk){
        let o=$("#bf-1 .bz-plus")
        if(o[0]){
          o.click()
          setTimeout(()=>{
            $util.triggerChangeEvent($("select")[0],_bzMessage._model._stdStatus.deleted)
            setTimeout(()=>{
              $("button.btn-primary").click()
              _complete()
            },100)
          },1000)
        }else if(Date.now()-t<60000&&_IDE._data._curModule&&_IDE._data._curModule._data==m&&!_IDE._data._curTest){
          setTimeout(()=>{
            _addDeleteFlow(t)
          },100)
        }
      }else{
        _complete()
      }
    }


    function _createEnter(){
      _aiModelHandler._addModelItem(md.models.find(x=>x.code==md.contents[0].code),function(){
        _enter=md.contents.find(x=>x.type=="enterModule")
        if(BZ._data._uiSwitch._tmpModels._menuChk){
          _enter.preSteps=[{
            element:["BZ.TW.document",_aiApp.menu,0],
            event:{
              type:"mouse",
              action:"click",
            },
            type:1
          }];
        }else if(_templateModule&&_templateModule._startPanel=="url"){
          m.definition.startPanel="url"
        }
        _createModuleItems()
      });
      let _name=m.name
      _names=_name.plural()
      _name=_name.plural(1)
      if(_name!=_names){
        _name=_name+"|"+_names
      }
      _aiPageHandler._contentViewDef._data._subModules=[{
        code:_aiAPI._newId(),
        path:["BZ.TW.document",":link("+_name+")"],
        type:"enterModule",
        name:_bzMessage._model._enter._options.enterModule
      }]
      $(".bz-add-elements").click()
    }
    
    function _insertStdField(){
      if(!md.fields.length){
        md.fields.push({
          code:_aiAPI._newId(),
          name:_bzMessage._common._name,
          data:"name",
          dependencies:[],
          endSteps:[],
          preSteps:[],
          inputFormat:_aiPageHandler._getFormat("name","string"),
          label:"on",
          path:["BZ.TW.document",":input("+_bzMessage._common._name+")"],
          required:"on",
          type:"string"
        })
      }
    }
  },
  _getAIObjByAction:function(a){
    if(!a.ai||a.ai.includes("no-setting")){
      return
    }
    let d={},_uiSwitch=BZ._data._uiSwitch
    a.ai.split(",").forEach(x=>{
      x=x.split(":")
      d[x[0]]=x[1]
    })
    
    let m=((d.module||d.test||d.call||"").match(/m[0-9]+/)||[])[0]
    
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let md=_aiGeneratorDataHandler._getModuleObject(d.module)._data.definition,o;
    if(d.fields){
      o= md.fields.find(x=>x.code==d.fields)
    }else if(d.operations){
      o=md.operations.find(x=>x.code==d.operations)
    }else if(d.contents){
      o=md.contents.find(x=>x.code==d.contents)
    }else if(d.buttons){
      md.contents.find(x=>{
        o=x.buttons&&x.buttons.find(y=>y.code==d.buttons)
        return o
      })
    }
    if(d.detail=="preSteps"&&o.preSteps){
      o=o.preSteps[d.idx]
    }else if(d.detail=="endSteps"&&o.endSteps){
      o=o.endSteps[d.idx]
    }
    return o
  },
  _getAIObjPanelByAction:function(a){
    a=a.ai.match(/panel:([0-9]+)/)||[]
    a=a[1]
    if(a){
      a=_aiGeneratorDataHandler._getContentByCode(a)
      return a
    }
  },
  _popActionAISetting:function(a,t,_chkPop,_fun){
    if(_chkPop&&!_aiPageHandler._isSettingWinOpen()){
      return
    }
    if(!a.ai||a.ai.includes("no-setting")){
      return
    }
    let d={},_uiSwitch=BZ._data._uiSwitch
    a.ai.split(",").forEach(x=>{
      x=x.split(":")
      d[x[0]]=x[1]
    })

    let m=((d.module||d.test||d.call||"").match(/m[0-9]+/)||[])[0]
    
    m=_aiGeneratorDataHandler._getModuleObject(m)
    
    let md=_aiGeneratorDataHandler._getModuleObject(d.module)._data.definition,os;

    if(d.panel){
      let p=_aiGeneratorDataHandler._getContentByCode(d.panel,d.module)
      _uiSwitch._curModelItemPanel=p
      _uiSwitch._curModelPanel=_uiSwitch._curModelItemPanel
    }

    if(d.call){
    }else if(d.flow){
      t=t.definition.code.split(".")
      _aiFlowHandler._popItem(t[0],t[1])
      if(!t[2]||t[2]=="default"){
        BZ._data._uiSwitch._curSolutionIdx=0
      }else{
        BZ._data._uiSwitch._curSolutionIdx=t[2]
      }

      if(d.tab=="auth"){
        _uiSwitch._flowItemTab='_role'
      }else if(d.tab=="scenario"){
        _uiSwitch._flowItemTab='_scenario'
      }
    }else{
      _aiPageHandler._popItem(d.operations||d.contents||d.buttons||d.fields,m)
    }
    if(d.tab=="action"){
      _uiSwitch._curDetailsTab="_action"
      BZ._data._uiSwitch._viewAISettingTab="_setting"
      setTimeout(()=>{
        _aiPageHandler._curPopWin.$(_aiPageHandler._curPopWin.document.body).find(`.${d.detail}`).click()
      },100)
    }else if(d.tab=="preScript"){
      _uiSwitch._curDetailsTab="_preScript"
    }else if(d.tab=="endScript"){
      _uiSwitch._curDetailsTab="_endScript"
    }else if(d.tab=="handleParameter"){
      _uiSwitch._curDetailsTab="_handleParameter"
    }else if(d.tab=="handleData"){
      _uiSwitch._curDetailsTab="_handleData"
    }else if(d.tab=="dependencies"){
      _uiSwitch._curDetailsTab="_dependencies"
    }
    setTimeout(()=>{
      _fun&&_fun()
    },100)
  },
  _collectGroupPathWord:function(d){
    let ws={},_curPanel=_aiPageHandler._getCurPanelData()
    var dt=["table","list"].includes(_curPanel.type)?"data":"app"
    
    for(var k in d){
      d[k].forEach&&d[k].forEach(v=>{
        if(!v.path){
          return
        }
        for(var i=v.path.length-1;i>=0;i--){
          var _ask=0
          var p=v.path[i]
          if(p.replace){
            p=p.replace(/\:bz\([^\)]+\)/g,"")
            var w=_descAnalysis._retrieveTextForElementPathItem(p)
            if(w){
              if((v.name||"").toLowerCase()==w.toLowerCase()){
                if(k!="_operations"&&dt=="data"){
                  _ask=1
                }
                _label=w
              }else if(dt=="data"){
                _ask=1
              }else{
//                v.path.splice(i--,1)
              }
              
              if(_ask){
                ws[w]={_type:dt,_example:v.path,word:w,_oldWord:w}
              }
            }
          }
        }
      })
    }
    return ws;
  },
  _popPreWord:function(d,_fromPanel,_fun){
    let wo=_aiPageHandler._collectGroupPathWord(d), 
        wos=_CtrlDriver._buildProxy({ws:[]})
    for(var k in wo){
      if(_aiPageHandler._getFieldByDemoValue(k)){
        delete wo[k]
      }
    }
    let ws=wos.ws;
    for(var k in wo){
      var wv=wo[k]
      ws.push(wv)
    }

    if(ws.length){
      BZ._data._uiSwitch._tmpList=ws
      //TODO: check button position
      _Util._confirmMessage({
        _tag:"div",
        _attr:{style:"max-height: 400px;overflow-y: auto;"},
        _items:[
          {
            _tag:"div",
            _attr:{"class":"bz-flex-tr"},
            _items:[
              {
                _tag:"div",
                _attr:{"class":"bz-left-space-10",style:"flex:1"},
                _text:"_bzMessage._common._type",
              },
              {
                _tag:"div",
                _attr:{style:"flex:2"},
                _items:[
                  {
                    _tag:"span",
                    _attr:{"class":"bz-left-space-10"},
                    _text:"_bzMessage._module._words+' / '+_bzMessage._model._field._title",
                  }
                ]
              }
            ]
          },
          {
            _tag:"div",
            _attr:{"class":"bz-flex-tr"},
            _dataRepeat:function(){return wos.ws},
            _items:[
              {
                _tag:"div",
                _attr:{
                  style:"flex:1",
                  "class":"input-group"
                },
                _items:[
                  {
                    _tag:"select",
                    _attr:{
                      "class":"form-control",
                      disabled:"!_aiPageHandler._isCheckout()"
                    },
                    _dataModel:"_data._item._type",
                    _items:[
                      {
                        _tag:"option",
                        _attr:{value:"_data._key"},
                        _text:"_data._item",
                        _dataRepeat:_bzMessage._model._wordType
                      }
                    ]
                  }
                ]
              },
              {
                _tag:"div",
                _attr:{
                  style:"flex:2;display:flex;",
                  "class":"input-group"
                },
                _items:[
                  {
                    _tag:"input",
                    _attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control",style:"flex:1"},
                    _dataModel:"_data._item.word",
                    _jqext:{
                      focus:function(){
                        _bzDomPicker._flashTmpCover(this._data._item._example,1)
                      }
                    }
                  },
                  {
                    _if:"_data._item._type=='data'",
                    _tag:"select",
                    _attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control",style:"flex:1",required:1},
                    _items:[
                      {
                        _tag:"option",
                        _attr:{value:"_data._item.code"},
                        _text:"_data._item.name",
                        _dataRepeat:"_IDE._data._curModule._data.definition.fields"
                      }
                    ],
                    _dataModel:"_data._item.field"
                  },
                  {
                    _tag:"button",
                    _attr:{
                      "class":"btn btn-icon bz-delete bz-small-btn pull-right bz-top-space-5",
                      title:"_bzMessage._method._delete"
                    },
                    _jqext:{
                      click:function(){
                        var w=this._data._item
                        for(var k in d){
                          let v=d[k];
                          v.forEach&&v.forEach(function(vv){
                            for(var n=0;n<vv.path.length;n++){
                              let www=_descAnalysis._retrieveTextForElementPathItem(vv.path[n]+"")
                              if(www==w._oldWord){
                                www=vv.path[n].replace(www,"lws")
                                vv.path[n]=www.replace(new RegExp(":[a-z]+\\(lws\\)","i"),"")
                              }
                            }
                          })
                        }
                        ws.splice(this._data._idx,1)
                      }
                    }
                  }
                ]
              }
            ]            
          }
        ]
      },[
        {
          _title:_bzMessage._method._redo2,
          _class:"btn-secondary",
          _click:function(c){
            _aiModelHandler._addItemFromUI(_fromPanel)
            c._ctrl._close()
          }
        },
        {
          _title:_bzMessage._method._continue,
          _click:function(c){
            let md=_IDE._data._curModule._data.definition;

            if(ws.find(v=>{
              return v._type=="data"&&!v.field
            })){
              return alert(_bzMessage._system._error._requiredField,_bzMessage._model._field._title)
            }
            _code=Date.now()
            ws.forEach(w=>{
              let _extra={code:_code++}
              if(w._type=="data"){
                for(var i=0;i<d._subModules.length;i++){
                  var sm=d._subModules[i]
                  if(sm.name==w._oldWord){
                    d._subModules.splice(i--,1)
                    d._contents.push(sm)
                    sm.code=_code++
                    sm.type="enterDetails"
                    sm.name=_bzMessage._model._enter._options.enterDetails
                  }
                }
              }else{
                return
              }
              for(var k in d){
                var ds=d[k]
                if(ds&&ds.constructor==Array){
                  ds.forEach(dd=>{
                    dd.path.forEach((p,q)=>{
                      if(_descAnalysis._retrieveTextForElementPathItem(p)==w._oldWord){
                        var r=new RegExp("([=\(])"+w._oldWord+"([\)])")
                        var f=_aiGeneratorDataHandler._getFieldByCode(w.field)
                        f.demoValue=w.word
                        dd.path[q]=dd.path[q].replace(r,"$1{{$project."+_aiGeneratorDataHandler._getCurModuleDataName()+"."+f.name+"}}$2")
                      }
                    })
                  })
                }
              }
            })
            _doFinal(d)
            c._ctrl._close()
          }
        }
      ],_bzMessage._setting._objectLib._confirmElementWord)
    }else{
      _doFinal(d)
    }
    function _doFinal(d){
      //update element path in word code
      for(var k in d){
        var o=d[k]
        o.forEach&&o.forEach(v=>{
          _aiPageHandler._updateElementPathWordByCode(v.path);
        })
      }
      _fun()
    }
  },
  /**********************************
  * Main update
  **********************************/
  _confirmContent:function(d,_fromPanel,_fun){
    BZ._data._uiSwitch._curModelPanel=_fromPanel||BZ._data._uiSwitch._curModelPanel
    BZ._data._uiSwitch._curModelItemPanel=BZ._data._uiSwitch._curModelPanel
    var _curModule=_IDE._data._curModule._data,
        mp=BZ._data._uiSwitch._curModelPanel,gs,
        _updateModules=[_curModule];
    var mpd=_aiGeneratorDataHandler._getContentByCode(mp.code);

    const o=_curModule.definition;
    _aiPageHandler._popPreWord(d,_fromPanel,function(){
      o.fields=o.fields||[]
      o.operations=o.operations||[]
      o.relatedModules=o.relatedModules||[]
      o.webpages=o.webpages||[]
      
      if(!d._url&&_aiPageHandler._contentViewDef._data){
        for(let k in d){
          _aiPageHandler._contentViewDef._data[k]=_aiPageHandler._contentViewDef._data[k]||[]
          d[k].forEach(x=>{
            _aiPageHandler._contentViewDef._data[k].push(x)
          })
        }
        _Util._resizeModelWindow()
        return
      }
      _Util._closeModelWindow()


      d._buttons=[]
      for(var k in d){
        if(d[k]&&d[k].constructor==Array){
          d[k].forEach(x=>{
            delete x._pickModule
          })
        }
      }
      if(d._operations){
        for(var i=0;i<d._operations.length;i++){
          var oo=d._operations[i]
          if(!_aiPageHandler._operationKeys.includes(oo.type)){
            d._operations.splice(i--,1)
            if(oo.type=="download"){
              d._subModules.push(oo)
            }else if(_bzMessage._model._trigger._options[oo.type]){
              d._buttons.push(oo)
            }else{
              oo.type="enterModule"
              d._contents.push(oo)
            }
          }else if(mpd.type=="form"){
            let f=mpd.from[0]
            var opr=_aiGeneratorDataHandler._getItemByGroupAndCode(["operations","buttons"],f.code,f.module)
            if(opr){
              d._buttons.push(oo)
              if(opr.type=="delete"){
                oo.type="confirm"
              }else{
                oo.type="submit"
              }
              d._operations.splice(i--,1)
            }
          }else if(oo.type!="execute"){
            if(!oo.name.toLowerCase().plural().includes(_curModule.name.plural().toLowerCase())){
              oo.name+=" - "+_curModule.name
            }
          }
        }
      }

      var _curSubModules=_ideObjHandler._getSubModules()

      for(var i=0;d._subModules&&i<d._subModules.length;i++){
        var m=d._subModules[i]
            
        if(mp.code=="home"){
          m.type="enterModule"
          continue
        }
        if(m.type=="innerPanel"){
          if(!["home","url"].includes(mp.code)&&!_aiGeneratorDataHandler._getContentByCode(mp.code,mp.module).path){
            m.type="curPanel"
            if(mpd){
              m.name=_aiModelHandler._getPanelName(mp,_curModule)
            }
          }
          if(!mpd.path){
            d._panel=m
          }
          d._subModules.splice(i--,1)
        }
      }
      
      d._contents&&d._contents.forEach(c=>{
        if(!c.name){
          c.name=_bzMessage._model._panelType[c.type]
        }
        d._subModules.push(c)
      })

      d._contents=[]
      
      d=_CtrlDriver._buildProxy(d)
      if($(".pre-definition-list")[0]){
        for(var k in d){
          if(d[k].constructor==Array){
            if(d[k].length){
              d[k].forEach(a=>{
                _aiPageHandler._contentViewDef._data[k].push(a)
              })
            }
          }else{
            _aiPageHandler._contentViewDef._data[k]=d[k]
          }
        }
        setTimeout(()=>{
          _Util._resizeModelWindow()
        },10)
        return
      }
      
      _aiPageHandler._contentViewDef._data=d
      
      if(mpd.type=="form"){
        ["_subModules","_contents","_operations","_webpages"].forEach(x=>{
          _Util._spliceAll(d[x],y=>{
            return 1
          })
        })
        d._buttons.forEach(y=>{
          if(!_bzMessage._model._trigger._options[y.type]){
            y.type="outopr"
          }
        })
      }else{
        d._buttons.forEach(x=>{
          d._subModules.push(x)
        })
        d._buttons=[]
        d._operations.forEach(x=>{
          d._subModules.push(x)
        })
        d._operations=[]
      }
      
      BZ._data._uiSwitch._inBatchModels=0
      _Util._confirmMessage(
        _aiPageHandler._contentViewDef,
        [
          //ok button
          {
            _title:_bzMessage._method._save,
            _class:"bz-add-elements btn-primary",
            _click:function(cc){
              for(var k in d){
                if(d[k].constructor==Array){
                  for(var i=0;i<d[k].length;i++){
                    let o=d[k][i]
                    if(!o.name&&o.module){
                      let m=_ideObjHandler._getDataByPath(o.module)
                      if(m){
                        o.name=m._data.name
                      }
                    }
                    if(!o.name){
                      return alert(_Util._formatMessage(_bzMessage._system._error._requiredField,[_bzMessage._common._name]))
                    }
                  }
                }
              }
              
              _lockData()
              
              cc._ctrl._close()
            }
          },
          {
            _title:_bzMessage._method._next,
            _class:"btn-secondary bz-next-txt-to-fields bz-hide-item",
            _click:function(c){
              $(".bz-add-elements").show()
              $(".bz-next-txt-to-fields").hide()
              
              _parseTextToFields(BZ._data._uiSwitch._batchType,$(".bz-text-fields").val())
            }
          }
        ],
        _bzMessage._setting._objectLib._confirmElement
      )
    })
    
    function _parseTextToFields(_type,v){
      let os
      if(_type=="field"){
        os=_aiPageHandler._contentViewDef._data._fields
        _type="string"
      }else{
        os=_aiPageHandler._contentViewDef._data._subModules
      }
      v.trim().split("\n").forEach(x=>{
        x=x.trim()
        
        let d={
          code:_aiAPI._newId(),
          path:[],
          type:_type,
          name:_Util._toCapitalWord(x)
        }
        if(_type=="string"){
          if(x.includes("*")){
            d.required="on"
            d.name=d.name.replace(/\*/g,"")
          }
          d.data=_glossaryHandler._getVariableName(x.plural(1))
          if(!_Util._isEmpty(mpd.path)){
            d.path=_aiGeneratorDataHandler._getStdPath(mpd.path,d,1)
          }
        }
        os.push(d)
      })

      BZ._data._uiSwitch._inBatchModels=0
      _Util._resizeModelWindow()
    }
    
    function _autoPick(){
      if(BZ.TW&&!BZ.TW.closed){
        _aiModelHandler._addItemFromUI(_fromPanel,"",1)
      }else{
        //TODO
        BZ._launchCurEnvUrl()
      }
    }
    
    function _lockData(){
      if(_curModule.lockBy&&_curModule.lockBy!=curUser.code&&_userManagement._isOnline(_curModule.lockBy)){
        alert(_bzMessage._common._othLocked)
      }else{
        _doIt()
      }
    }
    
    function _doIt(){
      var ns=_preHandleRelatedModules(d)
      _handleContents(d,function(){
        _handleOperations(d,function(){
          _handleWebpages(d,function(){
            _handleFields(d)
            _ideModuleManagement._batchSave(_updateModules,function(){
              if(ns.length){
                _aiModelHandler._storeRelatedModules(ns,function(){
                  _doFinal()
                })
              }else{
                _doFinal()
              }
            })
          })
        })
      })
    }
    
    function _doFinal(){
      _ideModuleManagement._save(_curModule,function(){
        _afterStore()
      })
    }
    
    function _afterStore(){
      setTimeout(function(){
        _aiModelHandler._refreshGUI()
        setTimeout(function(){
          if(_fun){
            _fun()
          }else{
            d=d._operations.find(x=>{
              return x.type!="delete"
            })
          }
        },100)
      },1000)
    }
    
    function _handleContents(d,_fun){
      if(d._panel){
        if(d._panel.type=="curPanel"){
          mp=_aiGeneratorDataHandler._getContentByCode(mp.code,mp.module)
          mp.name=mp.name||d._panel.name
          mp.path=d._panel.path
          mp.qpath=d._panel.qpath
        }else{
          var v=_aiModelHandler._insertNewModelItemIntoCurPanel("contents",d._panel)
          if(!v){
            return alert(_bzMessage._system._error._duplicateName,d._panel.name)
          }
          for(var j=0;j<mp.items.length;j++){
            if(mp.items[j].code==v.code){
              mp=BZ._data._uiSwitch._curModelPanel=mp.items[j]
              BZ._data._uiSwitch._curModelItemPanel=BZ._data._uiSwitch._curModelPanel
              mpd=_aiGeneratorDataHandler._getContentByCode(mp.code);
              break
            }
          }
        }
      }

      var cs=d._contents,ts=[]
      for(var i=0;i<cs.length;i++){
        var v=cs[i]
        if(_bzMessage._setting._objectLib._dataType[v.type]){
          v.data=_glossaryHandler._getVariableName(v.name).toLowerCase()
          d._fields.push(v)
        }else if(_bzMessage._model._trigger._options[v.type]){
          d._buttons.push(v)
        }else if(_bzMessage._root._dictionary._options.operation[v.type]){
          d._operations.push(v)
        }else{
          continue
        }
        cs.splice(i--,1)
      }

      if(d._buttons&&d._buttons.length){
        if(["innerPanel","form"].includes(mpd.type)){
          d._buttons.forEach(b=>{
            mpd.buttons=mpd.buttons||[]
            mpd.buttons.push(b)
            if(b.type=="next"||b.type=="form-tab"||b.type=="ex-insert"){
              b.lanuchModule=_IDE._data._curModule._data.code
            }
            _aiModelHandler._insertNewModelItemIntoCurPanel("buttons",b)
          })
        }
      }
      
      cs.forEach(v=>{
        _aiModelHandler._insertNewModelItemIntoCurPanel("contents",v,_curModule,0,ts)
      })
      
      if(ts.length){
        _ideTestManagement._batchCreate(
          ts,_curModule,0,function(){
            cs.forEach(v=>{
              var gs=["testVE"]
              gs.forEach(w=>{
                if(v[w]){
                  let t=_ideTestManagement._getItemByName(v[w])
                  if(t){
                    v[w]=t.code
                  }
                }
              })
            })
            _fun()
          }
        )
      }else{
        _fun()
      }
    }
    
    function _handleOperations(d,_fun,i){
      i=i||0
      if(i<d._operations.length){
        _aiModelHandler._saveNewOpr(d._operations[i],function(){
          _handleOperations(d,_fun,i+1)
        })
      }else{
        setTimeout(function(){
          BZ._setHash(_curModule.code)
          _fun()
        },200)
      }
    }
    
    function _preHandleRelatedModules(d,_fun){
      var ms=d._subModules,ns=[]
      
      for(var i=0;i<ms.length;i++){
        var m=ms[i]
        if(["page","download"].includes(m.type)){
          d._webpages.push(m)
          continue
        }else if(m.type.endsWith("input")){
          d._fields.push(m)
          m.data=_glossaryHandler._getVariableName(m.name).toLowerCase()
          continue
        }else if(!m.type.startsWith("module")){
          d._contents.push(m)
          continue
        }else{
          _aiModelHandler._saveNewDepModule(m,ns)
        }
      }
      return ns
    }


    function _handleFields(d){
      d._fields.forEach(function(v){
        if(!_Util._isEmpty(v.path)&&v.path[0].includes("BZ.TW.document")){
          v.path.shift()
        }else{
          v.path=[":input("+v.name+")",0]
        }
        if(v.type=="string"&&!_aiGeneratorDataHandler._getLabelFields(_curModule,1)[0]){
          v.label="on"
        }
        if(v.type=="string"){
          v.ergodic=_aiPageHandler._getErgodic(v.name)
        }else if(v.type=="object"){
          v.fields=[]
        }
        
        if(!v.inputFormat){
          v.inputFormat=_aiPageHandler._getFormat(v.name,v.type,v)
        }
        
        _aiModelHandler._insertNewModelItemIntoCurPanel("fields",v)
      })
    }
    
    function _handleWebpages(d,_fun){
      d._webpages.forEach(function(v){
        _aiModelHandler._insertNewModelItemIntoCurPanel("webpages",v)
      })
      if(d._webpages.length){
        if(!_aiGeneratorDataHandler._getTestsByDefType(0,"static")){
          return _ideTestManagement._batchCreate(
            [{
              name:_bzMessage._aiDefinition._staticPage,
              enterPoint:{value:_curModule.rootUrl,type:"follow"},
              hostId:_curModule.defaultHostId,
              type:"unit",
              subtype:"operation",
              definition:{type:"static"}
            }],_curModule,0,function(){
              _fun()
            }
          )
        }
      }
      _fun()
    }
    
  },
  _popInWin:function(_obj,_view,_name){
    let _curModule=_IDE._data._curModule
    _view={
      _if:function(){
        if(_IDE._data._curModule!=_curModule){
          return _aiPageHandler._curPopWin.close()
        }
        return 1
      },
      _update:_view._update||function(){
        _ideModuleManagement._save()
      },
      _tag:"div",
      _attr:{
        class:"bz-pop-window-box bz-v-panel",
        style:"height: calc(100% - 20px);width:100%;"
      },
      _items:[
        //bar
        {
          _tag:"div",
          _attr:{
            class:"ai-module-tab-bar",
            style:"margin:0 0 10px 0"
          },
          _items:[
            {
              _tag:"a",
              _attr:{
                class:function(d){
                  let c="bz-tab"
                  if(BZ._data._uiSwitch._viewAISettingTab==d._item){
                    c+=" active"
                  }
                  return c
                },
                // style:"padding: 2px 10px;"
              },
              _text:"_bzMessage._method[_data._item]",
              _dataRepeat:function(){
                let v=["_setting","_viewSource"]
                if(!_obj){
                  v.pop()
                }
                return v
              },
              _jqext:{
                click:function(){
                  BZ._data._uiSwitch._viewAISettingTab=this._data._item
                }
              }
            }
          ]
        },
        {
          _if:"BZ._data._uiSwitch._viewAISettingTab=='_setting'",
          _tag:"div",
          _attr:{
            class:"bz-v-panel",
            style:"flex:1"
          },
          _items:[_view]
        },
        {
          _if:"BZ._data._uiSwitch._viewAISettingTab=='_viewSource'",
          _tag:"div",
          _attr:{
            style:"flex:1"
          },
          _items:[
            {
              _tag:"textarea",
              _attr:{
                class:"bz-insert-src bz-no-border-select",
                style:"border: var(--bz-border);height: calc(100% - 10px) !important;position: relative;left: 0;"
              },
              _text:function(){
                return JSON.stringify(_obj,0,2)
              },
              _jqext:{
                blur:function(){
                  let d=_obj

                  try{
                    let v
                    v=_Util._eval("v="+this.value)
                    _Util._mergeDeep(d,v)
                    let m=_IDE._data._curModule._data
                    _ideModuleManagement._save(m,function(){
                      if(d.testCode){
                        let t=_ideObjHandler._getDataByPath(m.code,d.testCode)
                        if(t._data.name!=d.name){
                          t._data.name=d.name
                          _ideTestManagement._save(t,_curModule)
                        }
                      }
                    })
                  }catch(e){
                    alert(e.message)
                  }
                }
              }
            }
          ]
        }
      ]
    }
    
    if(_aiPageHandler._isSettingWinOpen()){
      _aiPageHandler._curPopWin.document.body.innerHTML=""
      _CtrlDriver._execute({},{},_view,_aiPageHandler._curPopWin.document.body);
      return _aiPageHandler._curPopWin.focus()
    }
    BZ._data._uiSwitch._viewAISettingTab="_setting"
    _aiPageHandler._curPopWin=_Util._popWin("","_aiModel",0,650,600,_view,_name)
  },
  _refreshPopWin:function(){
    let w=_aiPageHandler._curPopWin
    if(w&&!w.closed){
      setTimeout(()=>{
        w=_aiPageHandler._refreshWinData._data
        w.forEach((x,i)=>{
          if(x&&x.code){
            w[i]=_aiGeneratorDataHandler._getItemByCode(x.code)||x
          }
        })
        _aiPageHandler[_aiPageHandler._refreshWinData._fun](...w)
      })
    }
  },
  _isSettingWinOpen:function(){
    return _aiPageHandler._curPopWin&&!_aiPageHandler._curPopWin.closed
  },
  //pop panel
  _popPanel:function(d){
    _aiPageHandler._refreshWinData={_data:[d],_fun:"_popPanel"}
    d.items=d.items||[]
    var p=_aiGeneratorDataHandler._getContentByCode(d.code);
    if(!p){
      p=_IDE._data._curModule._data.definition.relatedModules.find(a=>{
        return a.lanuchPanel==d.code
      })
      if(p){
        _aiModelHandler._showDetails(p,"relatedModules")
      }else{
        _Util._closeModelWindow()
      }
      return
    }
    BZ._data._uiSwitch._curPanel=p
    BZ._data._uiSwitch._formButtons=[];

    var _curModule=_IDE._data._curModule._data,
        _tabs=["_relatedFields","_preScript","_endScript"]
    if(p.type!="form"){
      _tabs.pop()
    }
    BZ._data._uiSwitch._curDefElement=0
    if(!_tabs.includes(BZ._data._uiSwitch._curDetailsTab)){
      BZ._data._uiSwitch._curDetailsTab=_tabs[0]
    }
    var _view={
      _if:function(){
        if(_curModule!=_IDE._data._curModule._data){
          _Util._closeModelWindow()
        }
        return 1
      },
      _tag:"div",
      _attr:{
        "class":"bz-model-pop-panel"
      },
      _data:p,
      _items:[
        {
          _tag:"div",
          _attr:{
            style:"display:flex;"
          },
          _items:[
            //name
            {
              _tag:"div",_attr:{"class":"input-group",style:"flex:1"},
              _items:[
                {
                  _tag:"div",_attr:{"class":"input-group-addon"},
                  _items:[
                    {_tag:"label",_text:"_bzMessage._common._name"}
                  ]
                },
                {
                  _tag:"input",_attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control"},
                  _dataModel:"_data.name",
                  _formatGet:function(v){
                    if(!v){
                      p.name=v=_aiModelHandler._getPanelName(d)
                    }
                    return v
                  }
                }
              ]
            },
            //alias
            {
              _if:"!_data.type||_data.type!='page'",
              _tag:"div",_attr:{"class":"input-group",style:"flex:1"},
              _items:[
                {
                  _tag:"div",_attr:{"class":"input-group-addon"},
                  _items:[
                    {_tag:"label",_text:"_bzMessage._common._alias"}
                  ]
                },
                {
                  _tag:"input",_attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control"},
                  _dataModel:"_data.alias",
                  _formatGet:function(v){
                    if(!v){
                      p.alias=v=_glossaryHandler._getVariableName(_aiModelHandler._getPanelName(d))
                    }
                    return v
                  }
                }
              ]
            }
          ]
        },
        //Path
        {
          _if:function(){
            return d.code!='home'&&d.code!='api'&&d.code!=_IDE._data._curModule._data.definition.models[0].code
          },
          _tag:"div",
          _items:function(){
            return _aiPageHandler._getPathViewDef(p)
          }
        },
        //Fields
        {
          _if:"_aiModelHandler._isDataPanel(_data.code)",
          _tag:"div",
          _attr:{
            "class":"bz-h-h-tabs bz-std-tabs",
            style:"margin-top:10px;"
          },
          _items:[
            //tabs
            {
              _tag:"div",
              _attr:{"class":"bz-h-h-tab-items"},
              _items:[
                //tabs
                {
                  _tag:"div",
                  _attr:{
                    "class":function(t){
                      var c="bz-h-h-tab-item"

                      if(t._item==BZ._data._uiSwitch._curDetailsTab){
                        c+=" white-active"
                      }

                      return c
                    },
                    onclick:"BZ._data._uiSwitch._curDetailsTab=this._data._item;_Util._resizeModelWindow();"
                  },
                  _text:"_bzMessage._setting._objectLib[_data._item]",
                  _dataRepeat:_tabs
                }
              ]
            },
            //Content
            {
              _tag:"div",
              _attr:{"class":"bz-h-h-tab-content",style:"height:230px;"},
              _items:[
                //Related Fields
                {
                  _if:"BZ._data._uiSwitch._curDetailsTab=='_relatedFields'",
                  _tag:"div",_attr:{style:"height:calc(100% - 20px);overflow:auto;padding: 10px;"},
                  _items:[
                    //fields
                    {
                      _tag:"label",
                      _attr:{
                        "class":"col-xs-4 bz-td",
                        title:"_data._item.name"
                      },
                      _dataRepeat:function(){
                        var vs=[],fs=_IDE._data._curModule._data.definition.fields
                        d.items.forEach(v=>{
                          for(var i=0;i<fs.length;i++){
                            if(fs[i].code==v.code){
                              vs.push(fs[i])
                              break
                            }
                          }
                        })
                        fs.forEach(f=>{
                          if(!vs.includes(f)){
                            vs.push(f)
                          }
                        })
                        return vs
                      },
                      _items:[
                        {
                          _tag:"input",
                          _attr:{
                            disabled:"!_aiPageHandler._isCheckout()",
                            type:"checkbox",
                            checked:function(v){
                              for(var i=0;i<d.items.length;i++){
                                if(d.items[i].code==v._item.code){
                                  return true
                                }
                              }
                            }
                          },
                          _jqext:{
                            click:function(){
                              var _this=this;
                              setTimeout(function(){
                                if(_this.checked){
                                  d.items.push({
                                    code:_this._data._item.code,
                                    group:"fields"
                                  })
                                }else{
                                  for(var i=0;i<d.items.length;i++){
                                    if(d.items[i].code==_this._data._item.code){
                                      d.items.splice(i,1)
                                      break
                                    }
                                  }
                                }
                                _aiModelHandler._refreshPanelUI(d,function(){
                                  _ideModuleManagement._save(_IDE._data._curModule._data)
                                })
                              },20)
                            }
                          }
                        },
                        {_text:"_data._item.name"}
                      ]
                    }
                  ]
                },
                _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curPanel.preScript","_preScript"),
                _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curPanel.endScript","_endScript")
              ]
            },
            {
              _if:"_data.type=='form'",
              _tag:"div",
              _attr:{
                "class":"col-xs-12",
                style:"margin-bottom:0;"
              },
              _items:[
                {
                  _tag:"a",
                  _attr:{
                    class:"btn btn-icon-text bz-keyboard pull-right",
                    style:"margin-top: -5px;padding-top: 0;padding-bottom: 0;line-height: 25px;"
                  },
                  _text:"_bzMessage._method._tryFillForm",
                  _jqext:{
                    click:function(){
                      _aiPageHandler._exeTmpForm(d.items,p)
                    }
                  }
                }
              ]
            },
            {
              _if:"_data.type=='form'",
              _tag:"div",
              _attr:{
                "class":"col-xs-12",
                style:"margin-top:0;margin-bottom:15px;"
              },
              _items:[
                {
                  _tag:"label",
                  _attr:{
                    style:"position:relative;top:5px;"
                  },
                  _update:function(){
                    p.speed=p.speed||150
                    _ideModuleManagement._save()
                  },
                  _items:[
                    {
                      _tag:"input",
                      _attr:{
                        disabled:"!_aiPageHandler._isCheckout()",type:"checkbox"
                      },
                      _dataModel:"_data.asOneAction"
                    },
                    {
                      _text:"_bzMessage._com._asOneAction"
                    }
                  ]
                },
              ]
            },
            {
              _if:"_data.asOneAction",
              _tag:"div",
              _attr:{
                class:"input-group"
              },
              _items:[
                {
                  _tag:"label",
                  _attr:{
                    class:"input-group-addon"
                  },
                  _text:"_bzMessage._action._speed+' ('+_data.speed+'ms)'"
                },
                {
                  _tag:"div",
                  _attr:{
                    class:"form-control",
                    style:"width:calc(100% - 8px);"
                  },
                  _items:[
                    {
                      _tag:"input",
                      _dataModel:"_data.speed",
                      _attr:{
                        type:"range",
                        style:"padding:0;width:calc(100% - 10px);margin:5px;",
                        min:"50",
                        max:"1000",
                        step:"50"
                      }
                    }
                  ]
                }
              ]
            },
            {
              _if:function(d){
                if(d.type=='form'){
                  d=_aiGeneratorDataHandler._getOperationByPanel(d)
                  return d&&d.type!="add"
                }
              },
              _tag:"div",
              _attr:{
                "class":"col-xs-12",
                style:"margin:0;"
              },
              _items:[
                {
                  _tag:"label",
                  _attr:{
                    style:"position:relative;top:5px;"
                  },
                  _items:[
                    {
                      _tag:"input",
                      _attr:{
                        disabled:"!_aiPageHandler._isCheckout()",
                        type:"checkbox",
                        checked:"_data.testVE"
                      },
                      _jqext:{
                        click:function(){
                          let v=this._data,ts=[],
                              _curModule=_IDE._data._curModule,
                              w="testVE"
                          if(v[w]){
                            _ideTestManagement._deleteItem(_curModule._data,v[w],function(){
                              v[w]=0
                              delete v[w]
                              _ideModuleManagement._save()
                            })
                          }else{
                            v[w]=_Util._formatMessage(_bzMessage._aiDefinition._validationName,v.name)
                            _aiGenerator._prepareNewTest(v[w],_testCaseBodyHandler._getValidation(v,w),ts)
                            _ideTestManagement._batchCreate(
                              ts,_curModule,0,function(){
                                let t=_ideTestManagement._getItemByName(v[w])
                                if(t){
                                  v[w]=t.code
                                  _ideModuleManagement._save()
                                }
                              }
                            )
                          }
                        }
                      }
                    },
                    {
                      _text:"_bzMessage._model._supportVE"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    }
    
    _aiPageHandler._popInWin(p,_view,_bzMessage._model._panel._setting,"_panel")
    //_Util._confirmMessage(_view,_aiPageHandler._getCopyPasteBtn(d),_bzMessage._model._panel._setting,500,"_close",0,1)
  },
  _popButton:function(d){
    _aiPageHandler._refreshWinData={_data:[d],_fun:"_popButton"}
    BZ._data._uiSwitch._curButton=d
    let m=_IDE._data._curModule._data,
        _relatedModules=_aiGeneratorDataHandler._getRelatedModules()
    if(d.type=="outopr"){
      if(!d.lanuchPanel){
        _aiModelHandler._newModel(d,"buttons",_aiModelHandler._getModelByCode(d.panel[0]))
      }
    }
    BZ._data._uiSwitch._curDefElement=`:link(${d.name})`
    BZ._data._uiSwitch._curDetailsTab="_action"
    
    function _forFieldOperation(v){
      return v&&v.split(".")[1]
    }
    
    var _view={
      _tag:"div",
      _attr:{
        "class":"bz-v-panel",
        style:"flex:1"
      },
      _data:d,
      _items:[
        {
          _tag:"div",
          _attr:{
            style:"display:flex;"
          },
          _items:[
            //name
            {
              _tag:"div",_attr:{"class":"input-group",style:"flex:1"},
              _items:[
                {
                  _tag:"div",_attr:{"class":"input-group-addon"},
                  _items:[
                    {_tag:"label",_text:"_bzMessage._common._name"}
                  ]
                },
                {
                  _tag:"input",_attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control"},
                  _dataModel:"_data.name"
                }
              ]
            },
            //alias
            {
              _tag:"div",_attr:{"class":"input-group",style:"flex:1"},
              _items:[
                {
                  _tag:"div",_attr:{"class":"input-group-addon"},
                  _items:[
                    {_tag:"label",_text:"_bzMessage._common._alias"}
                  ]
                },
                {
                  _tag:"input",_attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control"},
                  _dataModel:"_data.alias",
                  _formatGet:function(v){
                    if(!v){
                      p.alias=v=_glossaryHandler._getVariableName(d.name)
                    }
                    return v
                  }
                }
              ]
            }
          ]
        },
        //type
        {
          _tag:"div",_attr:{"class":"input-group"},
          _items:[
            {
              _tag:"div",_attr:{"class":"input-group-addon"},
              _items:[
                {_tag:"label",_text:"_bzMessage._common._type"}
              ]
            },
            {
              _tag:"select",_attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control"},
              _dataModel:"_data.type",
              _cancelUpdate:1,
              _jqext:{
                change:function(){
                  let nv=this.value,ms=_IDE._data._curModule._data.definition.models
                  //get model
                  let m=ms.find(v=>{return v.code==d.code})
                  if(d.type=="confirm"){
                    delete d.confirmMsg
                  }
                  if(nv=="outopr"){
                    if(!m){
                      _aiModelHandler._newModel(d,"buttons",_aiModelHandler._getModelByCode(d.panel[0]))
                      _aiModelHandler._refreshGUI()
                    }
                    d.dynamicData="on"
                  }else{
                    if(d.operation){
                      return _aiModelHandler._removeOutOperationFrom(d,function(){
                        _ideModuleManagement._save()
                        _Util._resizeModelWindow()
                      })
                    }
                    if((nv=="next"||nv=="form-tab"||nv=="ex-insert")&&!d.lanuchPanel){
                      d.lanuchModule=_IDE._data._curModule._data.code
                      _aiModelHandler._newModel(d,"buttons",_aiModelHandler._getModelByCode(d.panel[0]))
                      _aiModelHandler._refreshGUI()
                    }
                  }
                  
                  _Util._resizeModelWindow()
                }
              },
              _items:[
                {
                  _tag:"option",
                  _attr:{value:"_data._item"},
                  _text:"_bzMessage._model._trigger._options[_data._item]",
                  _dataRepeat:["submit","confirm","next","outopr","close","insert","ex-insert","form-tab"]
                }
              ]
            },
          ]
        },
        {
          _if:"BZ._data._uiSwitch._curButton.type=='outopr'",
          _tag:"div",
          _attr:{
            class:"col-xs-12"
          },
          _items:[
            {
              _if:function(){
                return !_forFieldOperation(d.lanuchModule)
              },
              _tag:"label",
              _attr:{
                style:"margin:0 10px;"
              },
              _items:[
                {
                  _tag:"input",
                  _attr:{
                    disabled:"!_aiPageHandler._isCheckout()",
                    type:"checkbox"
                  },
                  _dataModel:"_data.requiredOperation"
                },
                {
                  _text:"_bzMessage._aiDefinition._requiredOperation"
                }
              ]
            },
            {
              _tag:"label",
              _items:[
                {
                  _tag:"input",
                  _attr:{disabled:"!_aiPageHandler._isCheckout()",type:"checkbox"},
                  _dataModel:"_data.parentCtrl"
                },
                {
                  _text:"_bzMessage._aiDefinition._parentCtrl"
                }
              ]
            }
          ]
        },
        //form-module
        {
          _if:"_data.type=='outopr'",
          _tag:"div",_attr:{"class":"input-group"},
          _items:[
            //label
            {
              _tag:"label",
              _attr:{"class":"input-group-addon"},
              _required:1,
              _text:"_bzMessage._model._formModel"
            },
            //module dropdown list 
            {
              _tag:"select",
              _attr:{
                "class":"form-control",
                required:1,
                disabled:"!_aiPageHandler._isCheckout()||_data.type!='outopr'"
              },
              _dataModel:"_data.lanuchModule",
              _items:[
                {
                  _if:"_data.type=='outopr'",
                  _tag:"option",
                  _attr:{
                    value:"_newModel",
                    "class":"bz-new-option"
                  },
                  _text:"'['+_bzMessage._method._newModule+' ...]'"
                },
                {
                  _tag:"option",
                  _attr:{
                    value:"_data._item.code"
                  },
                  _text:"_Util._generateIndentation(_data._item.type=='modulesub'?1:0)+_aiFlowHandler._getRelatedModuleDesc(_data._item)",
                  _dataRepeat:function(){
                    return _relatedModules
                  }
                }
              ],
              _cancelUpdate:1,
              _jqext:{
                change:function(){
                  let cm=_IDE._data._curModule._data,
                      nv=this.value,
                      ov=d.lanuchModule
                  if(nv=="_newModel"){
                    this.value=ov
                    return _ideModuleManagement._newDetails("data",cm.defaultHostId,function(m){
                      _doIt(m.code,ov)
                    })
                  }
                  _doIt(nv,ov)
                  
                  function _doIt(nv,ov){
                    if(ov&&d.operation){
                      return _aiModelHandler._removeOutOperationFrom(d,function(){
                        _doIt1()
                      })
                    }
                    _doIt1()
                  }
                  
                  function _doIt1(){
                    ms=_IDE._data._curModule._data.definition.models
                    //get model
                    let m=ms.find(v=>{return v.code==d.lanuchPanel})
                    d.lanuchModule=m.module=nv
                    delete m.operation
                    d.operation=""
                    delete d.operation
                    _ideModuleManagement._save()
                  }
                }
              }
            },
            //check module ref button
            {
              _tag:"div",
              _attr:{
                "class":"input-group-btn",
                disabled:"!_data.lanuchModule||_data.lanuchModule==_IDE._data._curModule._data.code"
              },
              _items:[
                {
                  _tag:"button",
                  _attr:{"class":"btn btn-icon bz-small-btn bz-entry"},
                  _jqext:{
                    click:function(){
                      BZ._setHash(d.lanuchModule)
                      _Util._closeModelWindow(this)
                    }
                  }
                }
              ]
            }
          ]
        },
        //launch form
        {
          _if:"['form-tab','next','ex-insert'].includes(_data.type)",
          _tag:"div",
          _attr:{"class":"input-group"},
          _items:[
            {
              _tag:"label",
              _required:1,
              _attr:{"class":"input-group-addon"},
              _text:"_bzMessage._model._button._lanuchForm"
            },
            {
              _tag:"select",
              _attr:{
                "class":"form-control",
                disabled:function(){
                  return !_aiPageHandler._isCheckout()||d.type=="close"||d.type=="submit"
                },
                required:1
              },
              _dataModel:"_data.lanuchPanel",
              _jqext:{
                change:function(){
                  if(this.value){
                    d.lanuchModule=_IDE._data._curModule._data.code
                    _aiPageHandler._changeLanuchPanel(d,this.value)
                  }else{
                    _aiPageHandler._changeLanuchPanel(d,-1)
                    d.lanuchModule=""
                  }
                }
              },
              _items:[
                {
                  _tag:"option",
                  _attr:{value:"_newButton","class":"bz-new-option"},
                  _text:"_bzMessage._method._newForm"
                },
                {
                  _tag:"option",
                  _attr:{value:"_data._item.code"},
                  _text:function(dd){
                    let mc=_IDE._data._curModule._data.code,
                        o=_aiGeneratorDataHandler._getContentByCode(dd._item.code,mc)
                    return o&&o.name
                  },
                  _dataRepeat:function(){
                    let fs=[],mc=_IDE._data._curModule._data.code
                    
                    var mm=_ideObjHandler._getDataByPath(mc)
                    mm&&mm._data.definition.contents.forEach(p=>{
                      if(p.type=="form"){
                        fs.push(p)
                      }
                    })
                    return fs
                  }
                }
              ]
            },
            {
              _tag:"div",
              _attr:{"class":"input-group-btn"},
              _items:[
                {
                  _tag:"button",
                  _attr:{"class":"btn btn-icon bz-small-btn bz-entry"},
                  _jqext:{
                    click:function(){
                      _aiPageHandler._popPanel(_aiModelHandler._getModelByCode(this._data.lanuchPanel))
                    }
                  }
                }
              ]
            }
          ]
        },
        //final panel
        {
          _tag:"div",
          _attr:{"class":"input-group"},
          _items:[
            {
              _tag:"label",
              _attr:{"class":"input-group-addon"},
              _text:"_bzMessage._model._button._gotoPanel"
            },
            {
              _tag:"select",
              _attr:{
                "class":"form-control",
                disabled:function(){
                  return !_aiPageHandler._isCheckout()||!(["submit","confirm","close"].includes(d.type)&&!d.lanuchPanel)
                },
              },
              _dataModel:"_data.finalPanel",
              _jqext:{
                change:function(){
                  _aiModelHandler._refreshGUI()
                }
              },
              _items:[
                {
                  _tag:"option"
                },
                {
                  _tag:"option",
                  _attr:{value:"_data._item.code"},
                  _text:function(dd){
                    let mc=_IDE._data._curModule._data.code,
                        o=_aiGeneratorDataHandler._getContentByCode(dd._item.code,mc)
                    
                    return o.name
                  },
                  _dataRepeat:function(){
                    let fs=[],mc=_IDE._data._curModule._data.code
                    
                    var mm=_ideObjHandler._getDataByPath(mc)
                    mm&&mm._data.definition.contents.forEach(p=>{
                      if(p.type&&(p.type.includes("Panel")||["table","list"].includes(p.type))){
                        fs.push(p)
                      }
                    })
                    return fs
                  }
                }
              ]
            },
            {
              _tag:"div",
              _attr:{"class":"input-group-btn"},
              _items:[
                {
                  _tag:"button",
                  _attr:{"class":"btn btn-icon bz-small-btn bz-entry"},
                  _jqext:{
                    click:function(){
                      _aiPageHandler._popPanel(_aiModelHandler._getModelByCode(this._data.finalPanel))
                    }
                  }
                }
              ]
            }
          ]
        },
        //outer operation
        {
          _if:function(){
            return d.type=="outopr"
          },
          _tag:"div",
          _attr:{"class":"input-group"},
          _items:[
            {
              _tag:"label",
              _required:1,
              _attr:{"class":"input-group-addon"},
              _text:"_bzMessage._setting._objectLib._operation._title"
            },
            {
              _tag:"select",
              _attr:{
                "class":"form-control",
                disabled:"!_aiPageHandler._isCheckout()||!_data.lanuchModule",
                required:1
              },
              _dataModel:"_data.operation",
              _cancelUpdate:1,
              _jqext:{
                change:function(){
                  let m=d.lanuchModule,nv=this.value
                  if(d.operation){
                    return _aiModelHandler._removeOutOperationFrom(d,function(){
                      _doIt()
                    })
                  }
                  _doIt()
                  function _doIt(){
                    d.lanuchModule=m
                    d.operation=nv
                    _aiModelHandler._addOutOperationFrom(d,_IDE._data._curModule._data.code,function(){
                      _ideModuleManagement._save()
                      _aiModelHandler._refreshGUI()
                    })
                  }
                }
              },
              _items:[
                {
                  _tag:"option",
                },
                {
                  _tag:"option",
                  _attr:{value:"_data._item.code"},
                  _text:function(d){
                    return _ideObjHandler._getDataByPath(d._supData.lanuchModule.split(".")[0],d._item.testCode)._data.name
                  },
                  _dataRepeat:"_ideObjHandler._getDataByPath(_data.lanuchModule)._data.definition.operations"
                }
              ]
            },
            {
              _tag:"div",
              _attr:{"class":"input-group-btn"},
              _items:[
                {
                  _tag:"button",
                  _attr:{"class":"btn btn-icon bz-small-btn bz-entry bz-operation"},
                  _jqext:{
                    click:function(){
                      if(d.type=="outopr"){
                        let m=d.lanuchModule.split(".")[0]
                        let o=_aiGeneratorDataHandler._getItemByGroupAndCode("operations",d.operation,m)
                        m+="."+o.testCode
                        let td=_ideObjHandler._getDataByPath(m)
                        _guiModuleHandler._openDetails({k:m,t:td._data,td:td})
                      }else{
                        _aiPageHandler._popPanel(_aiModelHandler._getModelByCode(d.lanuchPanel))
                      }
                    }
                  }
                }
              ]
            }
          ]
        },
        //confirm options
        {
          _if:"_data.type=='confirm'",
          _tag:"div",_attr:{"class":"input-group"},
          _items:[
            {
              _tag:"div",_attr:{"class":"input-group-addon"},
              _items:[
                {
                  _tag:"label",
                  _attr:{
                    class:"required"
                  },
                  _text:"_bzMessage._setting._objectLib._page._confirmMsg"
                }
              ]
            },
            {
              _tag:"input",
              _attr:{
                disabled:"!_aiPageHandler._isCheckout()",
                "class":"form-control",
                required:1
              },
              _dataModel:"_data.confirmMsg"
            }
          ]
        },
        //element
        {
          _tag:"div",
          _items:function(){
            return _aiPageHandler._getPathViewDef(d)
          }
        },
        //Tabs
        {
          _tag:"div",
          _attr:{
            "class":"bz-h-h-tabs bz-std-tabs bz-v-panel",
            style:"margin-top:10px;flex:1"
          },
          _items:[
            //tab header
            {
              _tag:"div",
              _attr:{"class":"bz-h-h-tab-items"},
              _items:[
                {
                  _tag:"div",
                  _attr:{
                    "class":function(t){
                      var c="bz-h-h-tab-item"

                      if(t._item==BZ._data._uiSwitch._curDetailsTab){
                        c+=" white-active"
                      }

                      return c
                    },
                  },
                  _text:"_bzMessage._setting._objectLib[_data._item]",
                  _dataRepeat:function(){
                    let _tabs=["_action","_preScript","_endScript"]
                    if(d.fakeElement){
                      _tabs=["_action"]
                    }
                    if(d.type=="outopr"){
                      _tabs.push("_valueTab")
                    }
                    _aiPageHandler._setCurTab(_tabs)
                    return _tabs
                  },
                  _jqext:{
                    click:function(){
                      let v=this._data._item
                      BZ._data._uiSwitch._curDetailsTab=v
                      if(_IDE._data._curAction){
                        let t=_IDE._data._curTest,_key
                        _testTabHandler._data._curTab="config"
                        if(t&&_aiGeneratorDataHandler._isAIGenerateTest(t)){
                          switch(v){
                            case "_preScript":
                            case "_endScript":
                              _testTabHandler._data._curCfgTab="script"
                              break
                            default:
                              _testTabHandler._data._curCfgTab="main"
                          }
                          let os=[]
                          t._data.actions.forEach(x=>{
                            if(_testTabHandler._data._curCfgTab=="script"&&x.ai.includes("tab:action")){
                            }else{
                              os.push(x)
                            }
                          })
                          if(os.length==1){
                            _ideActionManagement._setCurAction(os[0])
                          }else{
                            BZ._data._uiSwitch._selectedItems.push(...os)
                          }
                        }
                      }
                    }
                  }
                }
              ]
            },
            //Content
            {
              _tag:"div",_attr:{"class":"bz-h-h-tab-content",style:"height:135px"},
              _items:[
                //Action
                _aiPageHandler._getActionExpendContent(d,"BZ._data._uiSwitch._curButton",1),
                {
                  _if:"BZ._data._uiSwitch._curDetailsTab=='_valueTab'",
                  _tag:"div",
                  _attr:{
                    style:"padding:5px 7px"
                  },
                  _items:[
                      //fields
                      //Default value (form default value)
                    {
                      _tag:"div",
                      _attr:{
                        "class":"input-group"
                      },
                      _items:[
                        //label
                        {
                          _tag:"label",
                          _attr:{
                            "class":function(){
                              let cc='input-group-addon'
                              if(d.required){
                                cc+=' required'
                              }
                              return cc
                            }
                          },
                          _text:"_bzMessage._aiDefinition._triggerByData"
                        },
                        //input
                        {
                          _tag:"select",
                          _attr:{
                            "class":"form-control",
                            required:function(){
                              return !d.required
                            },
                            disabled:"!_aiPageHandler._isCheckout()"
                          },
                          _dataModel:"BZ._data._uiSwitch._curButton.defValue",
                          _items:[
                            {
                              _tag:"option"
                            },
                            {
                              _tag:"option",
                              _attr:{
                                value:"_data._item"
                              },
                              _text:"_data._item",
                              _dataRepeat:function(){
                                let vs=new Set()
                                m.definition.fields.forEach(x=>{
                                  if(x.type=="fake"){
                                    vs.add("$parameter."+x.data)
                                  }
                                })
                                vs.add("$project."+_aiGeneratorDataHandler._getCurModuleDataName(d.lanuchModule))
                                _IDE._data._curVersion.modules.forEach(x=>{
                                  if(x.bt=="data"&&x!=m){
                                    vs.add("$project."+_aiGeneratorDataHandler._getCurModuleDataName(x))
                                  }
                                })
                                return [...vs]
                              }
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curButton.preScript","_preScript"),
                _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curButton.endScript","_endScript")
              ]
            },
          ]
        }
      ]
    }

    _aiPageHandler._popInWin(d,_view,_bzMessage._model._button._buttonSetting,"_button")
//    _Util._confirmMessage(_view,_aiPageHandler._getCopyPasteBtn(d),_bzMessage._model._button._buttonSetting,500,"_close",0,1)
  },
  /*
  _getOuterElementViewDef:function(dm){
    return {
      _tag:"label",
      _attr:{
        style:"top:-35px;right:18px;position:absolute;"
      },
      _items:[
        {
          _tag:"input",
          _attr:{disabled:"!_aiPageHandler._isCheckout()",type:"checkbox"},
          _dataModel:dm+".asOuter"
        },
        {_text:"_bzMessage._model._outerItem"}
      ]
    }
  },
  */
  _getCurContent:function(){
    let d=BZ._data._uiSwitch
    d=d._curModelItemPanel||d._curModelPanel
    return d&&_aiGeneratorDataHandler._getContentByCode(d.code)
  },
  _getFieldBaseSettingViewDef:function(d,dp,c,_parentPath){
    let m=_IDE._data._curModule._data

    var _view={
      _dataRoot:dp,
      _messageRoot:"_bzMessage._setting._objectLib._field",
      _items:[
        //name
        {
          _name:"name",
          _required:1,
          _attr:{disabled:"!_aiPageHandler._isCheckout()"},
          _col:6
        },
        //type
        {
          _required:1,
          _name:"type",
          _col:6,
          _attr:{
            disabled:"!_aiPageHandler._isCheckout()"
          },
          _messageRoot:"_bzMessage._setting._objectLib._dataType",
          _options:Object.keys(_bzMessage._setting._objectLib._dataType),
          _jqext:{
            change:function(){
              if(this.value=="array"){
                d.subtype=d.type
              }else{
                delete d.mappingKey
                _CtrlDriver._updateObj(d,"module")
                delete d.mapLabel
                delete d.moduleRelatineship

                delete d.subtype
              }
              if(this.value.startsWith("module")||this.value=="file"){
                delete d.inputFormat
                delete d.ergodicMap
                delete d.key
                if(c){
                  delete c.formValues[d.code].dynamicData
                }
              }
              if(this.value.startsWith("module")){
                delete d.outputFormat
              }
              
              if(this.value=="object"){
                d.fields=[]
                _CtrlDriver._updateObj(d,"label")
                _CtrlDriver._updateObj(d,"key")

                delete d.inputFormat
                delete d.outputFormat
              }else{
                delete d.fields
              }
              
              if(this.value=="enum"){
                if(!d.inputFormat){
                  d.inputFormat="/{random}/"
                }
              }else if(this.value=="boolean"){
                d.inputFormat="/true|false/"
              }else if(this.value=="combo"){
                d.inputFormat="function(data){\n"+_bzMessage._model._comboFun+"\n  data."+d.data+" = data.xxxx + ' ' + data.xxxx\n}"
              }else{
                if(d.inputFormat=="/{random}/"){
                  d.inputFormat=""
                }
              }

              _aiPageHandler._popFieldForm(d,_parentPath)
            }
          }
        },
        //Data
        {
          _if:dp+".type!='viewData'",
          _required:1,
          _name:"data",
          _attr:{
            disabled:"!_aiPageHandler._isCheckout()"
          },
          _col:6,
          _jqext:{
            focus:function(){
              if(!this._oldValue){
                this._oldValue=this.value
              }
            },
            change:function(e){
              d.data=this.value=_glossaryHandler._getVariableName(this.value,1)
              
              _aiModelHandler._doBatchUpdate(this,1)
            }
          }
        },
        //subtype
        {
          _if:dp+".type=='array'",
          _required:1,
          _name:"subtype",
          _attr:{
            disabled:"!_aiPageHandler._isCheckout()"
          },
          _messageRoot:"_bzMessage._setting._objectLib._dataType",
          _options:Object.keys(_bzMessage._setting._objectLib._dataType),
          _col:6,
          _jqext:{
            change:function(e){
              delete d.mappingKey
              delete d.module
              if(this.value=="object"){
                d.fields=[]
                delete d.inputFormat
                delete d.outputFormat
              }else{
                delete d.fields
              }
            }
          }
        },
        /*
        //Ergodic
        {
          _if:function(){
            return ["string","number","float","text"].includes(d.type)
          },
          _name:"ergodic",
          _options:function(){
            return [{
              _tag:"option"
            },{
              _tag:"option",
              _attr:{value:"_data._item.key"},
              _text:"_data._item.key",
              _dataRepeat:"_IDE._data._setting.ergodicMap"
            }]
          },
          _col:6
        }
        /**/
      ]
    }
    _view=_uiHandler._buildFormView(_view,_addOnFormTemplate)
  return {_src:_view}
  },
  _popQuerySetting:function(d,_tab){
    let _inPost=_tab=="data.fields"
    
    BZ._data._uiSwitch._curRefModuleSettingData=d
    d.sync=(d.sync||_inPost)&&"on"
    BZ._data._uiSwitch._tmpFieldType=d.module?"module":"string";
    let _view={
      _update:function(){
        _ideModuleManagement._save()
      },
      _tag:"div",
      _data:d,
      _items:[
        ...(_stdComponent._getInputViewDef([{
          _type:"checkbox",
          _dataModel:"_data.required",
          _label:"_bzMessage._common._required"
        },{
          _if:function(){
            return _tab!=="path"
          },
          _type:"checkbox",
          _dataModel:"_data.inArray",
          _label:"_bzMessage._aiDefinition._inArray",
        },{
          _src:{
            _if:function(){
              return _tab!=="path"
            },
            _tag:"div",
            _attr:{
              class:"col-xs-12"
            },
            _items:[
              {
                _tag:"label",
                _items:[
                  {
                    _tag:"input",
                    _attr:{
                      type:"checkbox",
                      checked:"_data.defValue!==undefined"
                    },
                    _jqext:{
                      click:function(){
                        if(this.checked){
                          let d=this._data
                          d.defValue=_apiHandler._getAPIDefValue(d)
                        }else{
                          this._data.defValue=""
                          delete this._data.defValue
                        }
                        _ideModuleManagement._save()
                        _Util._resizeModelWindow(0,_aiPageHandler._curPopWin.document)
                      }
                    }
                  },
                  {
                    _text:"_bzMessage._api._defValue"
                  }
                ]
              },
              {
                _if:"_data.defValue!==undefined",
                _tag:"a",
                _attr:{
                  style:"float: right"
                },
                _text:"_bzMessage._method._reset",
                _jqext:{
                  click:function(){
                    let d=this._data
                    d.defValue=_apiHandler._getAPIDefValue(d)
                    _ideModuleManagement._save()
                    _Util._resizeModelWindow(0,_aiPageHandler._curPopWin.document)
                  }
                }
              }
            ]
          }
        },
        {
          _src:{
            _if:function(d){
              return _tab!=="path"&&d.defValue!==undefined
            },
            _tag:"textarea",
            _attr:{
              style:"width: 100% !important;height: 100px;"
            },
            _dataModel:"_data.defValue"
          }
        },
        {
          _type:"select",
          _label:"_bzMessage._model._field._title",
          _dataModel:"_data.code",
          _disabled:_inPost,
          _value:"_data._item.code",
          _text:"_data._item.name",
          _dataRepeat:"_IDE._data._curModule._data.definition.fields",
          _empty:1,
          _btn:{
            _if:"_data.code",
            _icon:"bz-keyboard",
            _jqext:{
              click:function(){
                _aiPageHandler._popItem(this._data.code)
              }
            }
          }
        },{
          _type:"checkbox",
          _disabled:_inPost||"!_data.code",
          _dataModel:"_data.sync",
          _label:"_bzMessage._api._syncField",
          _jqext:{
            click:function(){
              let _this=this;
              setTimeout(()=>{
                if(_this.checked){
                  for(let k in d){
                    if(!["code","required","inArray","name","sync"].includes(k)){
                      _CtrlDriver._updateObj(d,k)
                    }
                  }
                }else{
                  let f=_aiGeneratorDataHandler._getFieldByCode(d.code)
                  if(f.type=="module"||f.subtype=="module"){
                    BZ._data._uiSwitch._tmpFieldType="module"
                    d.module=f.module
                    d.mappingKey=f.mappingKey
                    d.inputFormat=f.inputFormat
                  }
                }
                _Util._resizeModelWindow()
              })
            }
          }
        },{
          _if:"!_data.sync",
          _type:"select",
          _label:"_bzMessage._common._type",
          _dataModel:"BZ._data._uiSwitch._tmpFieldType",
          _exDisabled:"_data.sync",
          _value:"_data._item",
          _text:"_bzMessage._setting._objectLib._dataType[_data._item]",
          _dataRepeat:["string","module"],
          _jqext:{
            change:function(){
              if(this.value=="module"){
                d.inputFormat=""
              }else{
                _CtrlDriver._updateObj(d,["module","inputFormat","mappingKey"])
              }
            }
          }
        },{
          _if:"!_data.sync&&BZ._data._uiSwitch._tmpFieldType=='string'",
          _label:"_bzMessage._setting._objectLib._field.inputFormat",
          _dataModel:"_data.inputFormat",
          _exDisabled:"_data.sync",
          _type:"textarea"
        },{
          _if:"_data.sync",
          _type:"input",
          _label:"_bzMessage._common._type",
          _dataModel:"BZ._data._uiSwitch._curField.type",
          _disabled:1,
        },{
          _if:"_data.sync&&BZ._data._uiSwitch._curField.subtype",
          _type:"input",
          _label:"_bzMessage._common._subType",
          _dataModel:"BZ._data._uiSwitch._curField.subtype",
          _disabled:1,
        },{
          _if:"_data.sync&&BZ._data._uiSwitch._curField.type!='module'&&BZ._data._uiSwitch._curField.subtype!='module'",
          _label:"_bzMessage._setting._objectLib._field.inputFormat",
          _dataModel:"BZ._data._uiSwitch._curField.inputFormat",
          _disabled:1,
          _type:"textarea"
        }])),
        {
          _if:function(){
            if(d.sync){
              let f=_aiGeneratorDataHandler._getFieldByCode(d.code)
              if(f!=BZ._data._uiSwitch._curField){
                BZ._data._uiSwitch._curField=f
              }
              
              return f.type=='module'
            }
          },
          _tag:"div",
          _items:function(){
            return _aiPageHandler._getRefSettingViewDef(BZ._data._uiSwitch._curField,"BZ._data._uiSwitch._curField",1)
          }
        },
        {
          _if:function(d){
            return !d.sync&&BZ._data._uiSwitch._tmpFieldType=='module'
          },
          _tag:"div",
          _items:_aiPageHandler._getRefSettingViewDef(d,"BZ._data._uiSwitch._curRefModuleSettingData")
        }
      ]
    }
    _Util._confirmMessage(_view,[])
//    _aiPageHandler._popInWin(d,_bzMessage._api._querySetting,d.name,"_query")
  },
  //Field form
  _popFieldForm:function(d,_parentPath){
    _aiPageHandler._refreshWinData={_data:[d,_parentPath],_fun:"_popFieldForm"}
    d=d._item||d
    BZ._data._uiSwitch._curField=d
    BZ._data._uiSwitch._curDefElement=d.type=="object"?"":`:input(${d.name})`
    let m=_IDE._data._curModule._data
    
    let c=_aiPageHandler._getCurContent()
    if(c&&c.code=="api"){
      c=0
    }
    if(c){
      c.formValues=c.formValues||{}
      c.formValues[d.code]=c.formValues[d.code]||{}
      _setDefValueOfModule(c)
      BZ._data._uiSwitch._curFormContent=c
    }
    
    function _setDefValueOfModule(c,_force,_required){
      if(!c){
        return
      }
      c=c.formValues[d.code]
      if((_force||!c.defValue)&&d.type.includes('module')){
        if(d.required,_required){
          c.defValue=_aiGeneratorDataHandler._getCurSysCtrlDataName(d.module)
        }else{
          c.defValue="/{random}/"
        }
      }
    }
    
    function _setRequiredField(_required){
      m.definition.operations.forEach(x=>{
        if(x.api&&x.method=="POST"){
          x.data&&x.data.fields.find(y=>{
            if(y.code==d.code){
              y.required=_required&&"on"
              return 1
            }
          })
        }
      })
    }
    var _view={
      _dataRoot:"BZ._data._uiSwitch._curField",
      _messageRoot:"_bzMessage._setting._objectLib._field",
      _items:[
        // {
          // _src:_aiPageHandler._getOuterElementViewDef("BZ._data._uiSwitch._curField")
        // },
        {
          _src:{
            _tag:"div",
            _attr:{
              style:"position: absolute;right: 10px;top: 10px;"
            },
            _items:[
              _stdComponent._getCheckboxRadioViewDef({
                _dataModel:"BZ._data._uiSwitch._curField.disable",
                _boxClass:"pull-right bz-left-space-10",
                _label:"_bzMessage._method._disabled",
              })
            ]
          }
        },
        {
          _src:{
            _if:function(){
              return !_Util._isEmpty(_parentPath)
            },
            _tag:"div",
            _attr:{
              class:"bz-obj-path"
            },
            _items:[
              {
                _tag:"span",
                _attr:{
                  style:"margin-right:10px;"
                },
                _text:"_bzMessage._innerWin._dataPath+':'"
              },
              {
                _tag:"span",
                _attr:{
                  class:"bz-obj-item"
                },
                _items:[
                  {
                    _tag:"a",
                    _attr:{
                      class:"bz-hover"
                    },
                    _text:"_data._item.name",
                    _jqext:{
                      click:function(){
                        let _idx=_parentPath.indexOf(this._data._item.code)
                        _parentPath.splice(_idx)
                        _aiPageHandler._popFieldForm(this._data._item,_parentPath)
                        
                      }
                    }
                  }
                ],
                _dataRepeat:function(){
                  return _parentPath.map(x=>_aiGeneratorDataHandler._getFieldByCode(x))
                }
              }
            ]
          }
        },
        _aiPageHandler._getFieldBaseSettingViewDef(d,"BZ._data._uiSwitch._curField",c,_parentPath),
        //options(label, unique,required,system)
        {
          _src:{
            _tag:"div",
            _attr:{style:"display:flex;line-height:30px;"},
            _items:[
              //Label
              {
                _tag:"div",
                _attr:{style:"flex:1;white-space:nowrap;"},
                _items:[
                  {
                    _tag:"label",
                    _items:[
                      {
                        _tag:"input",
                        _attr:{disabled:"!_aiPageHandler._isCheckout()",type:"checkbox"},
                        _dataModel:"BZ._data._uiSwitch._curField[_data._item]",
                        _jqext:{
                          click:function(){
                            if(this._data._item=="required"){
                              _setDefValueOfModule(BZ._data._uiSwitch._curFormContent,1,this.checked)
                              _setRequiredField(this.checked)
                            }else if(this._data._item=="key"){
                              m.definition.fields.forEach(f=>{
                                f!=d&&_CtrlDriver._updateObj(f,"key")
                              })
                              _CtrlDriver._updateObj(d,"required")
                              _CtrlDriver._updateObj(d,"unique")
                            }
                          }
                        }
                      },
                      {
                        _text:"_bzMessage._setting._objectLib._field[_data._item]"
                      }
                    ]
                  }
                ],
                _dataRepeat:function(){
                  if(["object","array"].includes(d.type)){
                    if(d.label){
                      delete d.label
                    }
                    if(d.type=="module"){
                      return ["key","required"]
                    }
                    return ["required"]
                  }else if(d.key){
                    return ["key","label"]
                  }else{
                    return ["key","label","unique","required"]
                  }
                }
              }
            ]
          }
        },
        //Path
        {
          _src:{
            _if:"BZ._data._uiSwitch._curFormContent",
            _tag:"div",
            _items:function(){
              let c=BZ._data._uiSwitch._curFormContent
                  
              let f=c.formValues[d.code]||{},
                  _opts=c.type=="form"?"_form":"_view"
                  _curData=f.path?f:d;
                  k=f.pathType=="view"?"view":"path"
              if(k=="view"){
                f.view=f.view||[]
              }
              return _aiPageHandler._getPathViewDef(_curData,k,0,_opts,f.path?"cur":(f.pathType||""),_parentPath)
            }
          }
        },
        //demo value 
        {
          _src:_stdComponent._getInputViewDef(
            {
              _if:function(){
                return (!c||c.code!="api")&&!['object','array'].includes(d.type)&&!(d.inputFormat||"").match(/^\/([^\|]+\|)+.+\/$/)
              },
              _label:"_bzMessage._setting._objectLib._field.demoValue",
              _dataModel:"BZ._data._uiSwitch._curField.demoValue",
              _btn:{
                _icon:"bz-keyboard bz-left-space-5",
                _large:1,
                _jqext:{
                  click:function(){
                    _aiPageHandler._exeTmpSetInput(d,c,BZ._data._uiSwitch._curField.demoValue)
                  }
                }
              }
            }
          )
        },
        //demo value 
        {
          _src:_stdComponent._getSelectViewDef(
            {
              _if:function(){
                return (!c||c.code!="api")&&d.inputFormat&&d.inputFormat.match(/^\/([^\|]+\|)+.+\/$/)
              },
              _label:"_bzMessage._setting._objectLib._field.demoValue",
              _dataModel:"BZ._data._uiSwitch._curField.demoValue",
              _dataRepeat:function(){
                return d.inputFormat.substring(1,d.inputFormat.length-1).split("|")
              },
              _text:"_data._item",
              _value:"_data._item",
              _btn:{
                _icon:"bz-keyboard bz-left-space-5",
                _large:1,
                _jqext:{
                  click:function(){
                    _aiPageHandler._exeTmpSetInput(d,c,BZ._data._uiSwitch._curField.demoValue)
                  }
                }
              }
            }
          )
        },
        //Value, Action, Pre-Step, Dependence
        {
          _src:{
            _tag:"div",
            _attr:{
              "class":"bz-h-h-tabs bz-std-tabs bz-v-panel",
              style:"margin-top:5px;flex:1;"
            },
            _items:[
              //tabs
              {
                _tag:"div",
                _attr:{"class":"bz-h-h-tab-items"},
                _items:[
                  {
                    _tag:"div",
                    _attr:{
                      "class":function(t){
                        var c="bz-h-h-tab-item"

                        if(t._item==BZ._data._uiSwitch._curDetailsTab){
                          c+=" white-active"
                        }
                        if(t._item=="_dependence"){
                          if(d.dependencies&&d.dependencies.length){
                            c+=" bz-tab-point-blue"
                          }
                        }else if(t._item=="_action"){
                          if((d.preSteps&&d.preSteps.length)||(d.endSteps&&d.endSteps.length)||d.maybeNoExist){
                            c+=" bz-tab-point-blue"
                          }
                        }else if(t._item=="_preScript"){
                          if(d.preScript){
                            c+=" bz-tab-point-blue"
                          }
                        }else if(t._item=="_endScript"){
                          if(d.endScript){
                            c+=" bz-tab-point-blue"
                          }
                        }
                        return c
                      },
                    },
                    _text:function(_data){
                      if(_data._item=="_moduleRef"){
                        return _bzMessage._model._moduleRef
                      }else if((d.subtype=="object"||d.type=="object")&&!_data._idx){
                        return _bzMessage._model._subField;
                      }else{
                        let w=_bzMessage._setting._objectLib
                        return w[_data._item]||w._field[_data._item]
                      }
                    },
                    _dataRepeat:function(){
                      let _tabs=["_valueTab"]
                      if(d.type=="module"||d.subtype=="module"){
                        _tabs=["_moduleRef"]
                      }else if(d.type=="object"||d.subtype=="object"){
                        _tabs=["_fields","inputFormat"]
                      }
                      if(c){
                        _tabs.push("_action")
                        if(!d.fakeElement){
                          _tabs.push("_preScript","_endScript")
                        }
                      }
                      _tabs.push("_dependence")
                      setTimeout(()=>{
                        let ct=BZ._data._uiSwitch._curDetailsTab
                        if(!_tabs.includes(ct)){
                          BZ._data._uiSwitch._curDetailsTab=_tabs[0]
                          _CtrlDriver._refreshData(BZ._data._uiSwitch,"_curDetailsTab")
                        }
                      })
                      return _tabs
                    },
                    _jqext:{
                      click:function(){
                        let v=this._data._item
                        BZ._data._uiSwitch._curDetailsTab=v
                        if(_IDE._data._curAction){
                          let t=_IDE._data._curTest,_key
                          _testTabHandler._data._curTab="config"
                          if(t&&_aiGeneratorDataHandler._isAIGenerateTest(t)){
                            switch(v){
                              case "_preScript":
                              case "_endScript":
                                _testTabHandler._data._curCfgTab="script"
                                break
                              default:
                                _testTabHandler._data._curCfgTab="main"
                            }
                            let os=[]
                            t._data.actions.forEach(x=>{
                              if(_testTabHandler._data._curCfgTab=="script"&&x.ai.includes("tab:action")){
                              }else{
                                os.push(x)
                              }
                            })
                            if(os.length==1){
                              _ideActionManagement._setCurAction(os[0])
                            }else{
                              BZ._data._uiSwitch._selectedItems.push(...os)
                            }
                          }
                        }
                      }
                    }
                  }
                ]
              },
              //Content
              {
                _tag:"div",
                _attr:{
                  "class":"bz-h-h-tab-content",
                  style:"'height:'+(BZ._data._uiSwitch._curField.type=='object'?'200px':'230px')"
                },
                _items:[
                  //value
                  {
                    _if:"BZ._data._uiSwitch._curDetailsTab=='_valueTab'",
                    _tag:"div",
                    _attr:{style:"overflow:hidden auto;padding: 10px;"},
                    _items:[
                      //Input Format
                      _stdComponent._getInputViewDef({
                        _label:"_bzMessage._setting._objectLib._field.inputFormat",
                        _required:1,
                        _dataModel:"BZ._data._uiSwitch._curField.inputFormat",
                        _btn:{
                          _icon:"bz-keyboard",
                          _icon:"bz-keyboard bz-left-space-5",
                          _large:1,
                          _jqext:{
                            click:function(){
                              _aiPageHandler._exeTmpSetInput(d,c,$util.generateDataByRegex(d.inputFormat))
                            }
                          }
                        },
                        _dataList:{
                          id:"BZ-attribute-list",
                          _dataRepeat:function(){
                            let vs=[]
                            if(d.type=="enum"){
                              vs=["/{random}/"]
                            }
                            _IDE._data._setting.attributeMap.forEach(x=>{
                              vs.push("/BZ-"+x.key+"/")
                            })
                            return vs
                          },
                          _text:"_data._item"
                        }
                      }),
                      //Output Format
                      {
                        _if:"['string','text','number','date'].includes(BZ._data._uiSwitch._curField.type)",
                        _tag:"div",
                        _attr:{
                          style:"height:calc(100% - 80px)"
                        },
                        _items:[
                          {
                            _tag:"label",
                            _attr:{
                              style:"line-height:30px"
                            },
                            _text:"_bzMessage._setting._objectLib._field.outputFormat",
                          },
                          _bzJSEditor._buildJSEditor({
                            _model:"BZ._data._uiSwitch._curField.outputFormat",
                            _insert:1,
                            _label:"",
                            _noBtn:1,
                            _boxHeight:"2px",
                            _preHeight:"calc(100% - 10px);",
                            _style:"height: calc(100% - 40px);border: var(--bz-border);"
                          }),
                        ]
                      },
                      _stdComponent._getInputViewDef({
                        _if:"BZ._data._uiSwitch._curFormContent",
                        _label:"_bzMessage._setting._objectLib._field.defValue",
                        _dataModel:function(){
                          if(!c.formValues[d.code].dynamicData||d.type.match('module')){
                            return "BZ._data._uiSwitch._curFormContent.formValues[BZ._data._uiSwitch._curField.code].defValue"
                          }else{
                            return "BZ._data._uiSwitch._curField.inputFormat"
                          }
                        },
                        _disabled:function(){
                          return !_aiPageHandler._isCheckout()||(c.formValues[d.code].dynamicData)
                        },
                        _exChk:{
                          _label:"_bzMessage._model._dynamicData",
                          _dataModel:"BZ._data._uiSwitch._curFormContent.formValues[BZ._data._uiSwitch._curField.code].dynamicData"
                        }
                      })
                    ]
                  },
                  //Object value
                  {
                    _if:"BZ._data._uiSwitch._curDetailsTab=='_fields'",
                    _tag:"div",
                    _attr:{style:"overflow:auto;padding: 10px;height:calc(100% - 10px);"},
                    _items:[
                      {
                        _tag:"div",
                        _items:[
                          {
                            //_if:"!_Util._hasCode(BZ._data._uiSwitch._curFormContent.formValues[BZ._data._uiSwitch._curField.code].defValue)",
                            _tag:"button",
                            _attr:{
                              "class":"btn btn-icon bz-small-btn bz-keyboard pull-right",
                              title:"_bzMessage._method._tryFillValue"
                            },
                            _jqext:{
                              click:function(){
                                _aiPageHandler._exeTmpSetInput(d,c)
                              }
                            }
                          },
                          {
                            _tag:"button",
                            _attr:{
                              class:"btn btn-icon bz-small-btn bz-plus pull-right"
                            },
                            _jqext:{
                              click:function(){
                                let f={type:"string",code:_aiAPI._newId(),endSteps:[],preSteps:[]}
                                if(BZ._data._uiSwitch._curFormContent){
                                  BZ._data._uiSwitch._curFormContent.formValues[f.code]={dynamicData:"on"}
                                }
                                d.fields=d.fields||[]
                                d.fields.push(f)
                                _parentPath=_parentPath||[]
                                _parentPath.push(d.code)
                                _aiPageHandler._popFieldForm(f,_parentPath)
                                _Util._resizeModelWindow()
                              }
                            }
                          }
                        ]
                      },
                      //sub-field list
                      {
                        _tag:"div",
                        _dragOrder:{
                          _getListData:function(){
                            return BZ._data._uiSwitch._curField.fields
                          },
                          _after:function(){
                            _ideModuleManagement._save()
                          }
                        },
                        _attr:{
                          style:"margin-right:10px;white-space:nowrap;float:left;"
                        },
                        _items:[
                          {
                            _tag:"label",
                            _attr:{
                              class:"_data._item.required?'required':''"
                            },
                            _items:[
                              {
                                _tag:"a",
                                _attr:{
                                  class:"bz-right-space-5 bz-clickable"
                                },
                                _text:"_data._item.name",
                                _jqext:{
                                  click:function(){
                                    _parentPath=_parentPath||[]
                                    _parentPath.push(d.code)
                                    _aiPageHandler._popFieldForm(this._data._item,_parentPath)
                                  }
                                }
                              }
                            ]
                          },
                          {
                            _tag:"button",
                            _attr:{
                              class:"btn btn-icon bz-small-btn bz-delete"
                            },
                            _jqext:{
                              click:function(){
                                BZ._data._uiSwitch._curField.fields.splice(this._data._idx)
                                _ideModuleManagement._save()
                              }
                            }
                          }
                        ],
                        _dataRepeat:"BZ._data._uiSwitch._curField.fields"
                      }
                    ]
                  },
                  //Ref-module
                  {
                    _if:"BZ._data._uiSwitch._curDetailsTab=='_moduleRef'",
                    _tag:"div",
                    _attr:{style:"overflow:auto;padding: 10px;height:calc(100% - 10px);"},
                    _items:function(){
                      return _aiPageHandler._getRefSettingViewDef(d,"BZ._data._uiSwitch._curField")
                    }
                  },
                  //Action
                  _aiPageHandler._getActionExpendContent(d,"BZ._data._uiSwitch._curField",1),
                  {
                    _if:"BZ._data._uiSwitch._curDetailsTab=='inputFormat'",
                    _tag:"div",
                    _attr:{style:"overflow:auto;padding: 10px;height:calc(100% - 10px);"},
                    _items:[
                      {
                        _tag:"a",
                        _attr:{
                          style:"float:right;margin-right:10px;"
                        },
                        _text:"_bzMessage._method._reset",
                        _jqext:{
                          click:function(){
                            let dd={}
                            d.fields.forEach(x=>{
                              if(x.required){
                                dd[x.data]=_Util._strToJson(x.inputFormat)
                              }else{
                                dd[x.data]="bz-skip"
                              }
                            })
                            if(d.type=="array"){
                              dd=[dd]
                            }
                            d.inputFormat=JSON.stringify(dd,0,2)
                            _ideModuleManagement._save()
                          }
                        }
                      },
                      {
                        _tag:"textarea",
                        _attr:{
                          style:"height:150px",
                          class:"bz-editor",
                          spellcheck:false
                        },
                        _dataModel:"BZ._data._uiSwitch._curField.inputFormat"
                      }
                    ]
                  },
                  _aiPageHandler._getDependencePanel(d,'_field'),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curField.preScript","_preScript"),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curField.endScript","_endScript")
                ]
              }
            ]
          }
        }
      ]
    }
    _view=_uiHandler._buildFormView(_view,_addOnFormTemplate)
    _view._attr={class:"bz-v-panel",style:"flex:1"}
    _aiPageHandler._popInWin(d,_view,_bzMessage._setting._objectLib._field._setting,"_field")
//    _Util._confirmMessage(_view,_aiPageHandler._getCopyPasteBtn(d),_bzMessage._setting._objectLib._field._setting,500,"_close",0,1,document.body)
    
  },
  _getRefSettingViewDef:function(d,_dataModel,_disabled){
    let vs=[]
    return [
      //module
      ...(_stdComponent._getInputViewDef([
        //module name
        {
          _if:function(){
            return d.type||BZ._data._uiSwitch._tmpFieldType!='string'
          },
          _label:"_bzMessage._common._module",
          _type:"select",
          _disabled:_disabled||"!_aiPageHandler._isCheckout()",
          _required:1,
          _dataModel:_dataModel+".module",
          _empty:1,
          _value:"_data._item._code",
          _text:"(_data._item._parent?'.... ':'')+_data._item._name",
          _dataRepeat:function(){
            if(!_IDE._data._curModule){
              return
            }
            let au=_aiAuthHandler._data[_IDE._data._curModule._data.defaultHostId].module
            let vv=[]
            _ideObjHandler._treeList.forEach(v=>{
              if(v.bt=="data"||v._code==au){
                vv.push(v)
              }
            })
            
            return vv
          },
          _jqext:{
            change:function(){
              _CtrlDriver._updateObj(d,["inputFormat","mappingKey"])
              if(d.type){
                _CtrlDriver._refreshData(BZ._data._uiSwitch,"_curDetailsTab",function(){
                  _Util._resizeModelWindow()
                })
              }else{
                _CtrlDriver._refreshData(BZ._data._uiSwitch,"_tmpQuerySetting",function(){
                  _Util._resizeModelWindow()
                })
              }
            }
          },
          _btn:{
            _if:_dataModel+".module",
            _icon:"bz-ai-model",
            _jqext:{
              click:function(){
                $("Button.btn-cancel").click()
                BZ._setHash(d.module)
              }
            }
          }
        },
        {
          _src:{
            _tag:"div",
            _items:function(){
              if(d.module){
                var cm=d.module;
                vs.length=0
                if(cm){
                  cm=_ideObjHandler._getDataByPath(cm)._data
                  if(cm.definition&&cm.definition.type!="auth"){
                    cm.definition.fields.forEach(f=>{
                      if(f.label){
                        vs.unshift(f)
                      }else{
                        vs.push(f)
                      }
                    })
                  }else if(cm.definition&&cm.definition.type=="auth"){
                    let us=_aiAuthHandler._getUserDataMap(cm.defaultHostId)||{}
                    vs= (Object.keys(us[0])||[]).map(x=>{
                      return {
                        code:x,
                        data:x,
                        name:x,
                        type:"string"
                      }
                    })
                  }
                }
              }
              return [
                _getModuleFields(vs,_dataModel+".mappingKey","_data._item.code","_mappingKey"),
                // _stdComponent._getInputViewDef({
                  // _label:"_bzMessage._setting._objectLib._field.inputFormat",
                  // _dataModel:_dataModel+".inputFormat",
                  // _disabled:_disabled||"!_aiPageHandler._isCheckout()"
                // }),
                _getModuleFields(vs,_dataModel+".mapLabel","_data._item.code","_uiValue",()=>{
                  return d.sync||d.type
                })
              ]
            }
          }
        },
        //module relationship
        {
          _if:function(){
            return d.module&&(d.type=="module"||d.subtype=="module")
          },
          _label:"_bzMessage._setting._objectLib._field.moduleRelatineship",
          _type:"select",
          _value:"_data._key",
          _text:"_data._item",
          _disabled:_disabled,
          _dataRepeat:_bzMessage._setting._objectLib._field._relationships
        }
      ]))
    ]
    
    function _getModuleFields(vs,_dataModel,_value,_label,_if){
      //Label Field
      return _stdComponent._getSelectViewDef({
        _if:_if,
        _label:"_bzMessage._api."+_label,
        _type:"select",
        _disabled:_disabled||"!_aiPageHandler._isCheckout()",
        _dataModel:_dataModel,
        _empty:1,
        _value:_value,
        _text:"_data._item.data",
        _dataRepeat:vs,
        _resizeModelWindow:1
      })
    }
  },
  _exeTmpForm:function(as,c,i,_parameter){
    i=i||0
    let a=as[i]
    if(a){
      if(!i){
        _parameter=_aiPageHandler._buildTmpEnvData(as,c)
        // _extensionComm._setShareData({"$parameter":$parameter})
        // _extensionComm._setShareData({"$project":$project})
      }else{
        _setEnvData(_parameter)
      }
      if(a.group=="fields"){
        a=_aiGeneratorDataHandler._getFieldByCode(a.code)
        if(a.disable||_parameter.$parameter[a.data]=="bz-skip"){
          _aiPageHandler._exeTmpForm(as,c,i+1,_parameter)
        }else{
          _aiPageHandler._exeTmpSetInput(a,c,_parameter.$parameter[a.data],function(){
            setTimeout(()=>{
              _aiPageHandler._exeTmpForm(as,c,i+1,_parameter)
            },10)
          },0,i)
        }
      }else{
        _aiPageHandler._exeTmpForm(as,c,i+1,_parameter)
      }
    }else{
      _setBkEnvData()
    }
    
    function _setEnvData(_parameter){
      $parameter=_parameter.$parameter
      $project=_parameter.$project
    }
    
    function _setBkEnvData(){
      $parameter=_aiPageHandler._tmpParameterBk.$parameter
      $project=_aiPageHandler._tmpParameterBk.$project
    }
  },
  _buildTmpEnvData:function(as,c){
    $parameter={}
    _ideDataManagement._initTmpData()
    
    _aiPageHandler._tmpParameterBk={
      $parameter:$parameter,
      $project:$project
    }
/*
    as.forEach(x=>{
      if(x.group=="fields"||!x.group){
        if(!x.data){
          x=_aiGeneratorDataHandler._getFieldByCode(x.code,x.module)
        }
        
        $parameter[x.data]=_aiGenerator._getDefValue(x,c,0,1)
      }
    })
*/
    as.forEach(x=>{
      if(x.group=="fields"||!x.group){
        if(!x.data){
          x=_aiGeneratorDataHandler._getFieldByCode(x.code,x.module)
        }
        if(x){
          if(x.type.includes("module")&&x.module){
            xx=_aiGenerator._getRefField(x)
            if(xx){
              if(xx.demoValue){
                $parameter[x.data]=xx.demoValue
              }
            }
          }else{
            $parameter[x.data]=_aiGenerator._getDefValue(x,c,0,1)
          }
          
        }
      }
    })

    
    $parameter=_aiAPI._preHandleParameter($parameter)
    return {
      $project:$project,
      $parameter:$parameter
    }
  },
  _exeTmpSetInput:function(f,c,v,_fun,as,_noInitData){
    let _exe=!as
    as=as||[]
    if(!_noInitData){
      _aiModelHandler._buildTmpParameter()
    }
    v=v||f.demoValue
    if(!v){
      if(!_fun){
        v=$util.generateDataByRegex(f.inputFormat)
      }else{
        v=(($project||{})[_aiGeneratorDataHandler._getCurModuleDataName()]||{})[f.data]
      }
    }
    if(v){
      $parameter[f.data]=v
    }
    _aiStepHandler._stepsToActions(f,"preSteps",as,[])
    if(!f.fakeElement){
      if(f.type=="object"){
        if(!v){
          _aiPageHandler._buildTmpEnvData([f],c)
          v=$parameter[f.data]
        }
        f.fields.forEach(x=>{
          _aiPageHandler._exeTmpSetInput(x,c,v[x.data],0,as,1)
        })
      }else{
        // let p=(f.path&&_aiPageHandler._updateElementPathByDemoValue(f.path,1))||undefined
        v=v===undefined?_aiGenerator._getDefValue(f,c):v;

        as.push({
          type:1,
          element:_aiGeneratorDataHandler._getStdPath(c.path,f,1,c),
          event:{
            type:"change",
            autoBlur:"on",
            value:v
          }
        })
      }
    }

    _aiStepHandler._stepsToActions(f,"endSteps",as,[])
    
    as.forEach(a=>{
      a.element=_aiPageHandler._updateElementPathByDemoValue(a.element,1)
    })
    if(_exe){
      _ideTask._tryClickElements(as,0,0,1,_fun)
    }
  },
  _exeTmpClick:function(f,c,_fun){
    let as=[]
    _aiStepHandler._stepsToActions(f,"preSteps",as,[])
    // let p=(f.path&&_aiPageHandler._updateElementPathByDemoValue(f.path,1))||undefined

    as.push({
      type:1,
      element:_aiGeneratorDataHandler._getStdPath(c.path,f),
      event:{
        type:"mouse",
        action:"click"
      }
    })

    _aiStepHandler._stepsToActions(f,"endSteps",as,[])
    as.forEach(a=>{
      a.element=_aiPageHandler._updateElementPathByDemoValue(a.element,1)
    })
    _ideTask._tryClickElements(as,0,0,1,_fun)
  },
  _getPathViewDef:function(_data,_key,cm,_opts,_curOption,_parentData){
    _key=_key||"path"
    BZ._data._uiSwitch._tmpPathScheme=_curOption
    let d=_data[_key],
        _path="BZ._data._uiSwitch._curTmpElementPath",p

        
    BZ._data._uiSwitch._curTmpElementPath=(d&&_aiPageHandler._updateElementPathByDemoValue(d))||undefined
    if(_data.panel&&_data.panel[0]){
      p=_aiGeneratorDataHandler._getContentByCode(_data.panel[0],_data.module)
    }
    return [
      //Fake element
      {
        _tag:"div",
        _attr:{
          style:"display:flex;"
        },
        _items:[
          {
            _tag:"div",
            _attr:{
              style:"flex:1;"
            },
            _items:[
              {
                _data:_data,
                _tag:"label",
                _attr:{
                  style:"line-height:30px;display:table;"
                },
                _items:[
                  {
                    _tag:"input",
                    _attr:{
                      type:"checkbox"
                    },
                    _dataModel:"_data.fakeElement"
                  },
                  {
                    _text:"_bzMessage._aiDefinition._fakeElement"
                  }
                ]
              }
            ]
          },
          _stdComponent._getSelectViewDef({
            _if:function(){
              return !_data.fakeElement&&_opts
            },
            _label:"_bzMessage._model._pathOption._title",
            _boxStyle:"flex:1;",
            _dataModel:"BZ._data._uiSwitch._tmpPathScheme",
            _value:"_data._key",
            _text:"_data._item",
            _dataRepeat:_bzMessage._model._pathOption[_opts],
            _jqext:{
              change:function(){
                let cf=BZ._data._uiSwitch._curFormContent.formValues[_data.code]
                if(this.value=="cur"){
                  cf.path=[]
                }else if(BZ._data._uiSwitch._tmpPathScheme=="cur"){
                  delete _data.path
                }
                if(cf){
                  if(this.value=="view"){
                    cf.pathType="view"
                  }else if(this.value=="input"){
                    cf.pathType="input"
                  }else{
                    delete cf.pathType
                  }
                }else{
                  if(this.value=="view"){
                    _data.pathType="view"
                  }else if(this.value=="input"){
                    _data.pathType="input"
                  }else{
                    delete _data.pathType
                  }
                }
                _aiPageHandler._popFieldForm(BZ._data._uiSwitch._curField,_parentData)
              }
            }
          })
        ]
      },
      //element path
      {
        _if:function(){
          return !_data.fakeElement&&(_opts!="_view"||_curOption)
        },
        _tag:"div",
        _attr:{
          style:"width:calc(100% - 5px)"
        },
        _items:[
          _uiHandler._getElementPath(_path,[function(_pick){
            //for pick
            _aiPageHandler._pickElement(BZ._data._uiSwitch._curTmpElementPath,function(v){
              v=_aiPageHandler._updateElementPathWordByCode(v)
              BZ._data._uiSwitch._curTmpElementPath=v
              v=_Util._clone(v)
              _data[_key]=v
              _ideModuleManagement._save()
              _Util._resizeModelWindow()
            })
          },function(){
            //for delete
            _data[_key]=0
            delete _data[_key]
            _ideModuleManagement._save()
          }],"_bzMessage._common._aiElement",0,0,function(){
            //update on typing
            v=BZ._data._uiSwitch._curTmpElementPath
            v=_aiPageHandler._updateElementPathWordByCode(v)
            BZ._data._uiSwitch._curTmpElementPath=v
            v=_Util._clone(v)
            _data[_key]=v
            _ideModuleManagement._save(cm)
          },0,0,function(){
            return !_aiPageHandler._isCheckout()
          },0,p&&p.path)
        ]
      },
      //demo value
      {
        _tag:"div",
        _attr:{"class":"bz-note-text bz-nowrap"},
        _items:[
          {
            _html:function(){
              return _aiPageHandler._getDemoValueFromElementPath(BZ._data._uiSwitch._curTmpElementPath)
            }
          }
        ]
      },
      {
        _tag:"div",
        _attr:{
          style:"line-height: 30px;"
        },
        _items:[
          {
            //_if:"!_Util._isEmpty(BZ._data._uiSwitch._curTmpElementPath)",
            _tag:"a",
            _attr:{
              disabled:function(){
                return BZ._isPlaying()
              },
              class:"btn btn-icon-text btn-icon bz-right-space-10 bz-play bz-ai-try",
            },
            _text:"_bzMessage._method._tryPath",
            _jqext:{
              click:function(){
                var _this=this
                if(BZ._isRecording()){
                  _Util._confirmMessage(_bzMessage._aiDefinition._noTryInRecording,[{
                    _title:_bzMessage._method._yes,
                    _click:function(c){
                      c._ctrl._close()
                      _ideRecorder._end()
                      _doIt()
                    }
                  }])
                }else{
                  _doIt()
                }
                
                function _doIt(){
                  if(_IDE._data._curTest&&_IDE._data._curTest._data.code!="_try"){
                    return alert(_bzMessage._aiDefinition._tryLimit)
                  }
                  let d=BZ._data._uiSwitch._curModelItemPanel||BZ._data._uiSwitch._curModelPanel
                  _aiPageHandler._doTry(_data,d&&d.code)
                }
              }
            }
          },
          {
            // _if:function(){
            //   return !_data.fakeElement&&!_data.inputFormat&&!_Util._isEmpty(_data.panel)&&!["table","list"].includes(_data.type)
            //          && _aiGeneratorDataHandler._getContentByCode(_data.panel[0],_data.module)
            //          && !_Util._isEmpty(BZ._data._uiSwitch._curTmpElementPath)
            // },
            _if:!!p,
            _tag:"a",
            _attr:{
              class:"btn btn-icon-text btn-icon bz-mouse bz-ai-try",
            },
            _text:"_bzMessage._method._tryClick",
            _jqext:{
              click:function(){
                _aiPageHandler._exeTmpClick(_data,p)
              }
            }
          },
          //readonly
          _stdComponent._getCheckboxRadioViewDef({
            _if:function(){
              return _opts&&BZ._data._uiSwitch._curFormContent
            },
            _label:"_bzMessage._model._readonly",
            _dataModel:"BZ._data._uiSwitch._curFormContent.formValues[BZ._data._uiSwitch._curField.code].readonly",
            _boxStyle:"float:right"
          })
        ]
      }
    ]
  },
  _getDemoValueFromElementPath(p){
    let w=[],_error
    p=p||[]
    p.constructor==Array&&p.forEach(x=>{
      x=_descAnalysis._retrieveTextForElementPathItem(x)||""
      if(x){
        x=_aiPageHandler._getDemoFieldFromVariable(x)
        if(x&&x.demoValue){
          w.push(x.data+" = "+x.demoValue)
        }else{
          _error=x||""
        }
      }
    })
    
    if(_error){
      return `<span style='font-size:15px;' class='bz-error-msg'>${_error}</span>`
    }

    if(!_Util._isEmpty(w)){
      return _bzMessage._setting._objectLib._field.demoValue+": "+w.join(", ")
    }
  },
  _popAPIForm:function(d){
    _aiPageHandler._refreshWinData={_data:[d],_fun:"_popAPIForm"}
    let _uiSwitch=BZ._data._uiSwitch,
        _curModule=_IDE._data._curModule
    _uiSwitch._apiRequest=d
    let _testCode=_curModule._data.code+"."+d.testCode
    let _curTest=_ideObjHandler._getDataByPath(_testCode)
    _aiGenerator._generateAITest(_curTest,0,function(){
      
    })
    let _curAction=_curTest._data.actions[1]
    let _curRequest=_curAction.requests[0]
    let _tabs=["_auth","_header","_path","_query","_body","_preScript","_responseScript","_join","_try"],
        t=_uiSwitch._curDetailsTab
    _uiSwitch._apiAuth=_aiAuthHandler._data[_curTest._data.hostId]
    if(!_tabs.includes(t)){
      t="_try"
    }else if(d.method=="GET"){
//      _tabs.splice(4,1)
      if(t=="_body"){
        t="_query"
      }
    }else if(d.method!="GET"&&d.method!="DELETE"&&t=="query"&&_Util._isEmpty(d.query)){
      t="_body"
    }

    _uiSwitch._curDetailsTab=t
    let _curPanel=_CtrlDriver._buildProxy({
      _curTest:_curTest,
      _curAction:_curAction,
      _curRequest:_curRequest
    })

    var _view={
      _dataRoot:d,
      _messageRoot:"_bzMessage._model._api",
      _items:[
        //name
        {
          _name:"name",
          _btn:{
            _icon:"bz-api",
            _click:function(){
              BZ._setHash(_curTest)
              _Util._closeModelWindow()
            }
          }
        },
        //method, url
        {
          _src:{
            _if:function(){
              if(_curModule!=_IDE._data._curModule||_IDE._data._curAction){
                _Util._closeModelWindow()
              }
              return 1
            },
            _tag:"div",
            _attr:{
              "class":"bz-flex-tr",
              style:"margin:5px 0"
            },
            _items:[
              //method
              {
                _tag:"label",
                _attr:{"class":"input-group-addon"},
                _text:"_data.method"
              },
              //host
              {
                _tag:"select",
                _attr:{
                  "class":"form-control",
                  style:"flex:3;",
                  title:function(){
                    let _proxy=_IDE._data._setting.advanced[BZ._data._uiSwitch._apiRequest.host].apiProxy
                    return _proxy?_Util._formatMessage(_bzMessage._api._proxyWarning,_proxy):""
                  }
                },
                _items:[
                  {
                    _tag:"option",
                    _attr:{value:""}
                  },
                  {
                    _tag:"option",
                    _attr:{
                      value:"_data._idx"
                    },
                    _text:function(d){
                      let _proxy=_IDE._data._setting.advanced[d._idx].apiProxy;
                      if(_proxy){
                        return '['+d._item.name+' (Proxy: '+_proxy+')] '+d._item.host
                      }else{
                        return '['+d._item.name+'] '+d._item.host
                      }
                    },
                    _dataRepeat:function(){
                      return _IDE._data._setting.environments[_IDE._data._setting.curEnvironment].items
                    }
                  }
                ],
                _dataModel:"_data.host"
              },
              //As std-api function
              _ideTestManagement._getAsApiFunViewDef()
            ],
          }
        },
        //url
        {
          _src:{
            _tag:"div",
            _attr:{
              class:"input-group"
            },
            _items:function(){
              return [
                {
                  _tag:"label",
                  _attr:{
                    class:"input-group-addon"
                  },
                  _text:"URL"
                },
                _bzJSEditor._buildJSEditor({
                  _oneRow:1,
                  _model:"BZ._data._uiSwitch._apiRequest.url",
                  _insert:1,
                  _style:"margin-top: -1px;margin-left: -1px;border: 1px solid var(--input-border-color);",
                  _keydown:function(e){
                    let o=$(".bz-codePop")[0]
                    if(e.keyCode==13&&(!o||o.getBoundingClientRect().width<20)){
                      $(".bz-play-request").click()
                    }
                  }
                }),
                {
                  _tag:"label",
                  _attr:{
                    class:"input-group-addon"
                  },
                  _items:[
                    {
                      _tag:"input",
                      _attr:{
                        type:"checkbox"
                      },
                      _dataModel:"BZ._data._uiSwitch._apiRequest.async"
                    },
                    {
                      _tag:"span",
                      _attr:{
                        style:"position:relative;top:2px;"
                      },
                      _text:"_bzMessage._api._asyn"
                    }
                  ]
                }
              ]
            }
          }
        },
        //tabs
        {
          _src:{
            _tag:"div",
            _attr:{
              "class":"bz-h-h-tabs bz-std-tabs"
            },
            _items:[
              //tabs
              {
                _tag:"div",
                _attr:{"class":"bz-h-h-tab-items"},
                _items:[
                  //tabs
                  {
                    _tag:"div",
                    _attr:{
                      "class":function(t){
                        var c="bz-h-h-tab-item bz-tab-ex-info"

                        if(t._item==_uiSwitch._curDetailsTab){
                          c+=" white-active"
                        }

                        return c
                      },
                      "tab-info":"_apiHandler._getTabInfo(_data._item,BZ._data._uiSwitch._apiRequest)",
                      title:function(d){
                        if(d._item=="_join"){
                          d="_joinDesc";
                        }else if(d._item=="_preScript"){
                          d="_preScriptDesc";
                        }else if(d._item=="_responseScript"){
                          d="_responseScriptDesc";
                        }else if(d._item=="_auth"){
                          d="_authDesc";
                        }
                        return _bzMessage._api[d]
                      },
                      style:function(dd){
                        if(dd._item=="_path"){
                          if(_Util._hasCode(d.url)){
                            return "display:unset"
                          }else{
                            if(BZ._data._uiSwitch._curDetailsTab=='_path'){
                              BZ._data._uiSwitch._curDetailsTab='_query'
                            }
                            return "display:none"
                          }
                        }
                      },
                      onclick:"BZ._data._uiSwitch._curDetailsTab=this._data._item"
                    },
                    _html:function(_data){
                      _data=_data._item
                      let w=_bzMessage._api[_data],s
                      if(_data=="_try"||_data=="_responseScript"){
                        if(BZ._isPlaying()){
                          w=`<span>${w} <button class="btn btn-icon bz-small-btn bz-loading"></button></span>`
                        }else{
                          let r=_debugDataHandler._getCacheRequest(_curPanel._curTest,1,0)
                          if(r){
                            if(_data=="_try"){
                              if(_Util._isAPISucessStatus(r.status)){
                                s="bz-success"
                              }else{
                                s="bz-failed"
                              }
                            }else{
                              s="bz-"+_ideTask._getResultIconByType(r.actionResult)
                            }
                            w=`<span>${w} ${_data=="_try"?" ("+r.status+")":""}<button class="btn btn-icon bz-small-btn ${s}"></button></span>`
                          }
                        }
                      }else if(_data=="_auth"){
                        if(d.autoToken){
                          if(_aiAuthHandler._getToken(d.host)){
                            w=`<span>${w}<button class='btn btn-icon bz-small-btn bz-success' style='margin-left: -3px;margin-top: -7px;position: absolute;'></button></span>`
                          }else{
                            w=`${w} ?`
                          }
                        }else{
                          w=`<span style="color:#CCC">${w}</span>`
                        }
                      }
                      return w
                    },
                    _items:[
                      {
                        _tag:"button",
                        _attr:{
                          class:function(_data){
                            _data=_data._item
                            let w=_bzMessage._api[_data],c="btn btn-icon bz-small-btn "
                            if(_data=="_try"||_data=="_responseScript"){
                              if(BZ._isPlaying()){
                                return c+"bz-loading"
                              }else{
                                let r=_debugDataHandler._getCacheRequest(_curPanel._curTest,1,0)
                                if(r){
                                  if(_data=="_try"){
                                    if(_Util._isAPISucessStatus(r.status)){
                                      s="bz-success"
                                    }else{
                                      s="bz-failed"
                                    }
                                  }else{
                                    s="bz-"+_ideTask._getResultIconByType(r.actionResult)
                                  }
                                  return c+s
                                }
                              }
                            }else if(_data=="_auth"){
                              if(d.autoToken){
                                if(_aiAuthHandler._getToken(d.host)){
                                  return c+"bz-success"
                                }
                              }
                            }
                            return "bz-hide"
                          }
                        }
                      },
                      {
                        _tag:"span",
                        _items:[
                          {
                            _html:function(_data){
                              _data=_data._item
                              let w=_bzMessage._api[_data]
                              if(_data=="_try"||_data=="_responseScript"){
                                if(!BZ._isPlaying()){
                                  let r=_debugDataHandler._getCacheRequest()
                                  if(r){
                                    w=`${w} ${_data=="_try"?" ("+r.status+")":""}`
                                  }
                                }
                              }else if(_data=="_auth"){
                                if(d.autoToken){
                                  if(!_aiAuthHandler._getToken(d.host)){
                                    w=`${w} ?`
                                  }
                                }else{
                                  w=`<span style="color:#CCC">${w}</span>`
                                }
                              }
                              return w
                            }
                          }
                        ]
                      },
                      {
                        _if:"_data._item=='_try'",
                        _tag:"button",
                        _attr:{
                          class:function(){
                            let c="bz-play-blue"
                            if(BZ._isPlaying()){
                              c="bz-stop"
                            }else if(d.disable){
                              c="bz-disable"
                            }
                            return `btn btn-icon ${c} bz-play-request bz-small-btn bz-left-space-10`
                          },
                          title:"_bzMessage._method._exeRequestWithDebugData"
                        },
                        _jqext:{
                          click:function(){
                            if(BZ._isPlaying()){
                              _ideTask._end(1)
                            }else{
                              _playFun()
                            }
                            
                            function _playFun(){
                              _aiPageHandler._exeTmpAPIRequest(d)
                            }
                          }
                        }
                      }
                    ],
                    _dataRepeat:_tabs
                  }
                ]
              },
              //Content
              {
                _tag:"div",
                _attr:{
                  "class":"bz-h-h-tab-content bz-ex-tab-box",
                  style:"height:425px;"
                },
                _items:[
                  //token
                  {
                    _if:"BZ._data._uiSwitch._curDetailsTab=='_auth'",
                    _tag:"div",
                    _attr:{
                      class:"bz-v-panel",
                      style:"margin:10px;height:calc(100% - 20px)"
                    },
                    _items:function(){
                      return _apiTokenViewDef()
                    }
                  },
                  //headers
                  {
                    _if:"BZ._data._uiSwitch._curDetailsTab=='_header'",
                    _tag:"div",
                    _attr:{style:"margin:10px;height:calc(100% - 20px)"},
                    _items:[
                      //contentType
                      {
                        _if:"BZ._data._uiSwitch._apiRequest",
                        _tag:"div",
                        _attr:{"class":"input-group"},
                        _items:[
                          {
                            _tag:"label",
                            _attr:{"class":"input-group-addon"},
                            _text:"Content-Type"
                          },
                          {
                            _tag:"input",
                            _attr:{"class":"form-control",list:"contentTypeList"},
                            _dataModel:"BZ._data._uiSwitch._apiRequest.contentType"
                          }
                        ]
                      },
                      {
                        _tag:"div",
                        _attr:{
                          style:"height:calc(100% - 30px)"
                        },
                        _items:function(){
                          return [
                            _bzJSEditor._buildJSEditor({
                              _model:"BZ._data._uiSwitch._apiRequest.headers",
                              _noBtn:1,
                              _label:"",
                              _placeholder:_bzMessage._api._scriptDesc,
                              _style:"height:100%"
                            })
                          ]
                        }
                      }
                    ]
                  },
                  //path
                  {
                    _if:"BZ._data._uiSwitch._curDetailsTab=='_path'",
                    _tag:"div",
                    _attr:{style:"margin:10px;height:calc(100% - 20px)"},
                    _items:[
                      _getList("path")
                    ]
                  },
                  //query
                  {
                    _if:"BZ._data._uiSwitch._curDetailsTab=='_query'",
                    _tag:"div",
                    _attr:{style:"margin:10px;height:calc(100% - 20px)"},
                    _items:[
                      _getList("query")
                    ]
                  },
                  //body
                  {
                    _if:"BZ._data._uiSwitch._curDetailsTab=='_body'",
                    _tag:"div",
                    _attr:{style:"margin:10px;height:calc(100% - 20px)"},
                    _items:[
                      _getList("data.fields"),
                      {
                        _tag:"div",
                        _items:[
                          {
                            _tag:"label",
                            _items:[
                              {
                                _tag:"input",
                                _attr:{
                                  type:"checkbox"
                                },
                                _dataModel:"BZ._data._uiSwitch._apiRequest.data.inArray"
                              },
                              {
                                _text:"_bzMessage._aiDefinition._inArray"
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  },
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._apiRequest.preScript","_preScript"),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._apiRequest.responseScript","_responseScript"),
                  {
                    _if:"BZ._data._uiSwitch._curDetailsTab=='_join'",
                    _tag:"div",
                    _attr:{style:"margin:10px;height:calc(100% - 20px)"},
                    _items:_getJoinsViewDef(d)
                  },
                  //try
                  {
                    _if:"BZ._data._uiSwitch._curDetailsTab=='_try'",
                    _tag:"div",
                    _attr:{
                      style:"position: absolute;margin: 10px;height: 380px;width: calc(100% - 45px);border: 0;padding: 0;",
                      class:"bz-tab-body"
                    },
                    _items:[
                      {
                        _tag:"div",
                        _attr:{
                          class:"bz-v-panel",
                          style:function(d){
                            let c=0
                            if(BZ._data._uiSwitch._apiResultTab=="_debugData"){
                              c=26
                            }
                            return `padding: 0;margin: 0;flex: 1;width: unset;float: unset;height: calc(100% + ${c}px);overflow-y:hidden;`
                          }
                        },
                        _items:function(){
                          //try
                          let dd=_getApiResultViewDef(function(){
                            return _aiPageHandler._exeTmpAPIRequest(d)
                          },_curTest,1,0)
                          dd.unshift(
                            _stdComponent._getInputViewDef({
                              _if:"BZ._data._uiSwitch._apiRequest.joins&&BZ._data._uiSwitch._apiRequest.joins.length",
                              _type:"checkbox",
                              _dataModel:"BZ._data._uiSwitch._withJson",
                              _label:"_bzMessage._api._tryJoinTogether",
                              _update:function(){}
                            })
                          )
                          return dd
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          }
        }
      ]
    }
    _view=_uiHandler._buildFormView(_view,_addOnFormTemplate)
    _view._update=function(){
      _ideModuleManagement._save()
      let t=_ideObjHandler._getDataByPath(_curModule._data.code,d.testCode)
      if(t._data.name!=d.name){
        t._data.name=d.name
        _ideTestManagement._save(t,_curModule)
      }
      _aiGenerator._generateAIActions(_curTest)
    }
    _aiPageHandler._popInWin(d,_view,_bzMessage._setting._objectLib._operation._setting,"_api")
    //_Util._confirmMessage(_view,_aiPageHandler._getCopyPasteBtn(d),_bzMessage._setting._objectLib._operation._setting,600,"_close",0,1)

    function _getList(k){
      return {
        _tag:"table",
        _attr:{
          style:"width:100%;"
        },
        _items:[
          {
            _tag:"thead",
            _items:[
              {
                _tag:"tr",
                _attr:{
                  style:"display:flex;"
                },
                _items:[
                  {
                    _tag:"th",
                    _attr:{
                      style:"width:11px;text-align:center;",
                      title:"_bzMessage._common._required"
                    },
                    _items:[
                      {
                        _tag:"div",
                        _attr:{
                          style:"position: relative;top: 3px;font-size: 18px;"
                        },
                        _text:"*"
                      }
                    ]
                  },
                  {
                    _tag:"th",
                    _attr:{
                      style:"flex:3;text-align:center;"
                    },
                    _text:"_bzMessage._aiDefinition._mapField"
                  },
                  {
                    _tag:"th",
                    _attr:{
                      style:"flex:3;text-align:center;"
                    },
                    _text:"_bzMessage._common._name"
                  },
                  {
                    _tag:"th",
                    _attr:{
                      style:"width:20px;"
                    },
                    _items:[
                      {
                        _tag:"button",
                        _attr:{
                          class:"btn btn-icon bz-small-btn bz-plus"
                        },
                        _jqext:{
                          click:function(){
                            if(k=="data.fields"){
                              d.data=d.data||{}
                              d.data.fields=d.data.fields||[]
                              d.data.fields.push({})
                            }else{
                              d[k]=d[k]||[]
                              d[k].push({})
                            }
                          }
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            _tag:"hr"
          },
          {
            _tag:"div",
            _attr:{
              style:function(){
                let c=320
                if(k=="query"){
                  c=340
                }
                return `overflow-y:auto;height:${c}px;`
              }
            },
            _items:[
              {
                _tag:"table",
                _attr:{
                  style:"width:100%;",
                  class:""
                },
                _items:[
                  {
                    _tag:"tbody",
                    _attr:{
                      
                    },
                    _items:[
                      {
                        _tag:"tr",
                        _attr:{
                          style:"display:flex;"
                        },
                        _items:[
                          //required
                          {
                            _tag:"td",
                            _attr:{
                              style:"text-align:center;padding:6px 0;"
                            },
                            _items:[
                              {
                                _tag:"input",
                                _attr:{
                                  type:"checkbox"
                                },
                                _dataModel:function(d){
                                  return `BZ._data._uiSwitch._apiRequest.${k}[${d._idx}].required`
                                }
                              }
                            ]
                          },
                          //Field
                          {
                            _tag:"td",
                            _attr:{
                              style:"flex:3;display:flex;"
                            },
                            _items:[
                              {
                                _tag:"select",
                                _attr:{
                                  class:"form-control"
                                },
                                _focus:"_Util._isEmpty(_data._item)",
                                _items:[
                                  {
                                    _tag:"option"
                                  },
                                  {
                                    _tag:"option",
                                    _attr:{
                                      value:"_data._item.code"
                                    },
                                    _text:"_data._item.name",
                                    _dataRepeat:"_IDE._data._curModule._data.definition.fields"
                                  }
                                ],
                                _dataModel:function(d){
                                  return `BZ._data._uiSwitch._apiRequest.${k}[${d._idx}].code`
                                },
                                _jqext:{
                                  change:function(){
                                    let f=_aiGeneratorDataHandler._getFieldByCode(this.value),v
                                    if(f){
                                      if(k=="data.fields"){
                                        v=d.data.fields
                                      }else{
                                        v=d[k]
                                      }
                                      v=v[this._data._idx]

                                      v.name=f.data
                                      if(f.required&&d.method=="POST"&&k=="data.fields"){
                                        v.required="on"
                                      }else if(!["GET","POST","DELETE"].includes(d.method)){
                                        if(f.key){
                                          v.required="on"
                                        }
                                      }
                                    }
                                  }
                                }
                              },
                              {
                                _tag:"button",
                                _attr:{
                                  style:"margin:5px;width:15px;",
                                  class:"btn btn-icon bz-small-btn bz-settings"
                                },
                                _jqext:{
                                  click:function(){
                                    _aiPageHandler._popQuerySetting(this._data._item,k)
                                  }
                                }
                              }
                            ]
                          },
                          //name
                          {
                            _tag:"td",
                            _attr:{
                              style:"flex:3;"
                            },
                            _items:[
                              {
                                _tag:"input",
                                _attr:{
                                  class:"form-control",
                                  style:"height:25px"
                                },
                                _dataModel:function(d){
                                  return `BZ._data._uiSwitch._apiRequest.${k}[${d._idx}].name`
                                }
                              },
                            ]
                          },
                          //delete
                          {
                            _tag:"td",
                            _attr:{
                              style:"padding:5px 0;width:20px;"
                            },
                            _items:[
                              {
                                _tag:"button",
                                _attr:{
                                  class:"btn btn-icon bz-small-btn bz-delete"
                                },
                                _jqext:{
                                  click:function(){
                                    let dk=_Util._getDataByPath(d,k)
                                    dk.splice(this._data._idx,1)
                                    _ideModuleManagement._save()
                                  }
                                }
                              }
                            ]
                          }
                        ],
                        _dataRepeat:function(){
                          return _Util._getDataByPath(d,k)
                        }
                      }
                    ]
                  }
                ]
              }
            ]
          },
          {
            _tag:"hr"
          }
        ]
      }
    }
  },
  _getScriptPanel:function(_scriptModel,_tab,_noUpdate){
    let d={
      _tag:"div",
      _attr:{style:"margin:5px;height:calc(100% - 10px);border:0;padding:0;",class:"bz-no-border-select"},
      _items:function(){
        return [
          _bzJSEditor._buildJSEditor({
            _model:_scriptModel,
            _noBtn:1,
            _label:"",
            _placeholder:_bzMessage._action._loopDataDesc,
            _style:"height:100%",
            _noUpdate:_noUpdate,
            _disabled:"!BZ._isCheckout(_IDE._data._curModule)",
          })
        ]
      }
    }
    if(_tab){
      d._if="BZ._data._uiSwitch._curDetailsTab=='"+_tab+"'"
    }
    return d 
  },
  _exeTmpAPIRequest:function(d){
    let _curTest=_ideObjHandler._getDataByPath(_IDE._data._curModule._data.code+"."+d.testCode)
    _curTest._data.definition=d
    _aiGenerator._generateAIActions(_curTest)
    let _switch=BZ._data._uiSwitch,
        ai=1,
        dd=_debugDataHandler._getCurDebugData(_curTest,1,0),
        _hash=location.hash
    let ri=0
    _IDE._data._curTest=_curTest
    let r=_curTest._data.actions[1].requests[0]
    r=_Util._clone(r)
    r._idx=ri
    
    _ideTask._exeDebugRequest(1,r,_curTest._data,dd,function(v,_mutipleTran){
      _testTabHandler._data._curTab="config"
      _IDE._data._curTest=0
      BZ._setHash(_hash)
      BZ._data._uiSwitch._inTestListDiagram="model"
      setTimeout(()=>{
        v=v||{}
        _debugDataHandler._cacheRequestInTest(v._returnData[ri],ri,ai,_curTest);

        _switch._result=v._type
        BZ._data._uiSwitch._curDetailsTab=""
        if(!_mutipleTran){
          setTimeout(()=>{
            _aiPageHandler._popAPIForm(d)
            BZ._data._uiSwitch._apiResultTab="_result"
          },10)
        }
      },10)
    })    
  },
  // pop operation
  _popOperationForm:function(d){
    _aiPageHandler._refreshWinData={_data:[d],_fun:"_popOperationForm"}
    let _test=_ideObjHandler._getDataByPath(_IDE._data._curModule._data.code,d.testCode)
    if(_test._data.type=="api"){
      return _aiPageHandler._popAPIForm(d)
    }
    BZ._data._uiSwitch._curOperation=d
    d.fieldMap=d.fieldMap||{}
    BZ._data._uiSwitch._curDefElement=`:link(${d.name})`

    let m=_IDE._data._curModule._data;
    d.handleParameter=d.handleParameter||_aiActionHandler._getStdHandleParameterScript(d,m)
    d.handleData=d.handleData||_aiActionHandler._getStdHandleDataScript(d.type,m)

    var _view={
      _dataRoot:d,
      _messageRoot:"_bzMessage._setting._objectLib._page",
      _items:[
        //name
        {
          _src:{
            _if:function(){
              if(m!=_IDE._data._curModule._data){
                _Util._closeModelWindow()
              }
              return 1
            },
            _tag:"div",
            _update:function(){},
            _attr:{
              "class":"input-group col-xs-6",
              style:"float:left;margin:3px 0;"
            },
            _items:[
              {
                _tag:"div",
                _attr:{
                  "class":"input-group-addon"
                },
                _items:[
                  {
                    _tag:"label",
                    _text:"_bzMessage._common._name"
                  }
                ]
              },
              {
                _tag:"input",
                _attr:{
                  "class":"form-control",
                  value:function(){
                    var t=_ideObjHandler._getDataByPath(_IDE._data._curModule._data.code,d.testCode)
                    return t._data.name
                  },
                  disabled:"!_aiPageHandler._isCheckout()"
                },
                _jqext:{
                  change:function(){
                    let t=_ideObjHandler._getDataByPath(_IDE._data._curModule._data.code+"."+d.testCode)
                    t._data.name=this.value
                    _ideTestManagement._save(t,_IDE._data._curModule,0,1)
                  }
                }
              }
            ]
          }
        },
        //alias
        {
          _name:"alias",
          _dataModel:"_data.alias",
          _col:6,
        },
        //Type
        {
          _messageRoot:"_bzMessage._root._dictionary._options.operation",
          _name:"type",
          _dataModel:"_data.type",
          _options:_aiPageHandler._operationKeys,
          _col:6
        },
        //Level
        {
          _name:"level",
          _dataModel:"_data.level",
          _options:function(){
            return [{
              _tag:"option",
              _attr:{value:"_data._item"},
              _text:"_bzMessage._setting._objectLib._operation._level[_data._item]",
              _dataRepeat:function(){
                if(d.type=="add"||d.type=="search"){
                  return ["module"]
                }else if(d.type=="edit"){
                  return ["data"]
                }else if(d.type=="delete"){
                  return ["data","multiple"]
                }else{
                  return ["module","data","multiple"]
                }
              }
            }]
          },
          _col:6
        },
        //form
        {
          _name:"form",
          _label:"_bzMessage._model._openForm",
          _dataModel:"_data.lanuchPanel",
          _options:function(){
            var fs=[]
            _IDE._data._curModule._data.definition.contents.forEach(p=>{
              if(p.type=="form"){
                fs.push({
                  _tag:"option",
                  _attr:{value:p.code},
                  _text:_aiModelHandler._getPanelName(p)
                })
              }
            })
            fs.push({
              _tag:"optgroup",
              _attr:{
                label:"_bzMessage._setting._objectLib._operation._title"
              },
              _items:[{
                _tag:"option",
                _attr:{value:""},
                _text:"_bzMessage._method._newForm"
              }]
            })
            return fs
          },
          _jqext:{
            change:function(){
              _aiPageHandler._changeLanuchPanel(this._data,this.value)
            }
          },
          _btn:{
            _icon:"bz-entry",
            _click:function(){
              _aiPageHandler._popPanel(_aiModelHandler._getModelByCode(this._data.lanuchPanel))
            }
          }
        },
        //URL
        {
          _name:"url",
          _btn:{
            _if:"_data.url",
            _icon:"bz-popout",
            _click:function(){
              if(d.url){
                let v=_aiGenerator._getOperationUrl(d.url)
                v=_aiPageHandler._updateByDemoValue(v)
                _TWHandler._openUrl(v)
              }
            }
          }
        },
      ]
    }
    _view=_uiHandler._buildFormView(_view,_addOnFormTemplate)
    _view={
      _dataRoot:d,
      _messageRoot:"_bzMessage._setting._objectLib._page",
      _items:[
        // {
          // _src:_aiPageHandler._getOuterElementViewDef("BZ._data._uiSwitch._curOperation")
        // },
        {
          _src:_view
        },
        //Path
        {
          _src:{
            _tag:"div",
            _items:function(){
              return _aiPageHandler._getPathViewDef(BZ._data._uiSwitch._curOperation)
            }
          }
        },
        //multiple selector
        {
          _if:"_data.level=='multiple'",
          _name:"selector",
          _dataModel:"_data.selector",
          _required:1,
          _btn:{
            _icon:"bz-dompicker",
            _click:function(){
              _bzDomPicker._pickDetails(0,function(p){
                var v=p.pop()
                if(!v._css.includes(":Contains")&&!v._css.includes(":endContains")&&!v._css.includes(":near")){
                  p.push(v)
                }
                BZ._data._uiSwitch._tmpCssOptions=p;
                _Util._confirmMessage({
                  _tag:"div",
                  _items:[
                    {
                      _tag:"div",
                      _text:"_bzMessage._aiDefinition._selectPattern"
                    },
                    {
                      _tag:"div",_attr:{style:"margin:10px;"},
                      _text:"BZ._data._uiSwitch._curOperation.selector=BZ._data._uiSwitch._tmpCssOptions.map((v)=>{return v._key}).join('')||BZ._data._uiSwitch._curOperation.selector"
                    },
                    {
                      _tag:"label",_attr:{style:"display:block"},
                      _items:[
                        {
                          _tag:"input",
                          _dataModel:"_data._item._key",
                          _attr:{disabled:"!_aiPageHandler._isCheckout()",type:"checkbox",value:"_data._item._css"}
                        },
                        {
                          _text:"_data._item._css"
                        }
                      ],
                      _dataRepeat:"BZ._data._uiSwitch._tmpCssOptions"
                    }
                  ]
                },[])
              })
            }
          }
        },
        //Related action
        {
          _src:{
            _tag:"div",
            _attr:{
              "class":"bz-h-h-tabs bz-std-tabs bz-v-panel",
              style:"margin-top:10px;flex:1"
            },
            _items:[
              //tabs
              {
                _tag:"div",
                _attr:{"class":"bz-h-h-tab-items"},
                _items:[
                  //tabs
                  {
                    _tag:"div",
                    _attr:{
                      "class":function(t){
                        var c="bz-h-h-tab-item"

                        if(t._item==BZ._data._uiSwitch._curDetailsTab){
                          c+=" white-active"
                        }
                        return c
                      }
                    },
                    _text:"_bzMessage._setting._objectLib[_data._item]",
                    _dataRepeat:function(){

                      var _tabs=["_action","_handleParameter","_handleData"]

                      if(!d.fakeElement){
                        _tabs.splice(1,0,"_preScript","_endScript")
                        
                      }
                      _aiPageHandler._setCurTab(_tabs)
                      return _tabs
                    },
                    _jqext:{
                      click:function(){
                        let v=this._data._item
                        BZ._data._uiSwitch._curDetailsTab=v
                        if(_IDE._data._curAction){
                          let t=_IDE._data._curTest,_key
                          _testTabHandler._data._curTab="config"
                          if(t&&_aiGeneratorDataHandler._isAIGenerateTest(t)){
                            switch(v){
                              case "_handleParameter":
                                _key="tab:handleParameter"
                                break
                              case "_handleData":
                                _key="tab:handleData"
                                break
                              case "_action":
                                _testTabHandler._data._curCfgTab="main"
                                break
                              default:
                                _testTabHandler._data._curCfgTab="script"
                            }
                            let os=[]
                            t._data.actions.forEach(x=>{
                              if(_key&&x.ai.includes(_key)){
                                os.push(x)
                              }else if(!_key&&x.ai.includes("operations:"+d.code)&&!x.ai.includes("tab:handle")){
                                os.push(x)
                              }
                            })
                            if(os.length==1){
                              _ideActionManagement._setCurAction(os[0])
                            }else{
                              BZ._data._uiSwitch._selectedItems.push(...os)
                            }
                          }
                        }
                      }
                    }
                  }
                ]
              },
              //Content
              {
                _tag:"div",
                _attr:{
                  "class":"bz-h-h-tab-content",
                  style:function(d){
                    if(d.level=="multiple"){
                      return "height:130px"
                    }
                    return "height:160px;"
                  }
                },
                _items:[
                  //Pre-Steps
                  _aiPageHandler._getActionExpendContent(d,"BZ._data._uiSwitch._curOperation"),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curOperation.preScript","_preScript"),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curOperation.endScript","_endScript"),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curOperation.handleParameter","_handleParameter"),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curOperation.handleData","_handleData")
                ]
              }
            ]
          }
        }
      ]
    }
    _view=_uiHandler._buildFormView(_view,_addOnFormTemplate)
    
    _view._attr={class:"bz-v-panel",style:"flex:1"}

    _aiPageHandler._popInWin(d,_view,_bzMessage._setting._objectLib._operation._setting,"_api")
    // _Util._confirmMessage(_view,_aiPageHandler._getCopyPasteBtn(d),_bzMessage._setting._objectLib._operation._setting,500,"_close",0,1)
  },
  // pop content
  _popContentForm:function(d){
    _aiPageHandler._refreshWinData={_data:[d],_fun:"_popContentForm"}
    BZ._data._uiSwitch._curContent=d
    let _tabs=["_action","_preScript","_endScript"]
    /*
    if(_aiModelHandler._isEnterType(d.type)){
      _tabs.push()
    }else{
      _tabs.push("_relatedFields")
    }
    */
    _aiPageHandler._setCurTab(_tabs)
    BZ._data._uiSwitch._curDefElement=`:link(${d.name})`
    let _curModule=_IDE._data._curModule
    var _view={
      _dataRoot:"BZ._data._uiSwitch._curContent",
      _messageRoot:"_bzMessage._setting._objectLib._page",
      _items:[
        // {
          // _src:_aiPageHandler._getOuterElementViewDef("BZ._data._uiSwitch._curContent")
        // },
        //name
        {
          _src:{
            _tag:"div",
            _attr:{
              style:"display:flex;"
            },
            _items:[
              _stdComponent._getInputViewDef({
                _label:"_bzMessage._common._name",
                _dataModel:"BZ._data._uiSwitch._curContent.name",
                _boxStyle:"flex:1"
              }),
              _stdComponent._getInputViewDef({
                _label:"_bzMessage._common._alias",
                _dataModel:"BZ._data._uiSwitch._curContent.alias",
                _boxStyle:"flex:1"
              })
            ]
          }
        },
        //Start panel
        {
          _src:{
            _if:function(){
              return d.type=="enterModule"
            },
            _tag:"div",
            _attr:{"class":"input-group"},
            _items:[
              {
                _tag:"label",
                _attr:{
                  "class":"input-group-addon"
                },
                _text:"_bzMessage._module._general._startPanel",
              },
              {
                _tag:"select",
                _attr:{
                  "class":"form-control",
                  disabled:"!_aiPageHandler._isCheckout()"
                },
                _dataModel:"_IDE._data._curModule._data.definition.startPanel",
                _items:function(){
                  return _aiModelHandler._getStartOptions()
                },
                _jqext:{
                  change:function(){
                    if(!d.url){
                      setTimeout(()=>{
                        if(_IDE._data._curModule._data.definition.startPanel=="url"){
                          d.url=_IDE._data._curModule._data.rootUrl||"/"
                        }
                      },10)
                    }
                  }
                }
              }
            ]
          }
        },
        //URL
        {
          _name:"url"
        },
        //path
        {
          _src:{
            _tag:"div",
            _items:function(){
              return _aiPageHandler._getPathViewDef(BZ._data._uiSwitch._curContent)
            }
          }
        },
        {
          _src:{
            _tag:"div",
            _attr:{
              "class":"bz-h-h-tabs bz-std-tabs bz-v-panel",
              style:"margin-top:10px;flex:1"
            },
            _items:[
              //tabs
              {
                _tag:"div",
                _attr:{"class":"bz-h-h-tab-items"},
                _items:[
                  {
                    _tag:"div",
                    _attr:{
                      "class":function(d){
                        var c="bz-h-h-tab-item"

                        if(d._item==BZ._data._uiSwitch._curDetailsTab){
                          c+=" white-active"
                        }
                        return c
                      },
                      onclick:"BZ._data._uiSwitch._curDetailsTab=this._data._item"
                    },
                    _text:"_bzMessage._setting._objectLib[_data._item]",
                    _dataRepeat:function(){
                      if(d.fakeElement){
                        BZ._data._uiSwitch._curDetailsTab="_action"
                        return ["_action"]
                      }else{
                        return _tabs
                      }
                    },
                    _jqext:{
                      click:function(){
                        let v=this._data._item
                        BZ._data._uiSwitch._curDetailsTab=v
                        if(_IDE._data._curAction){
                          let t=_IDE._data._curTest,_key
                          _testTabHandler._data._curTab="config"
                          if(t&&_aiGeneratorDataHandler._isAIGenerateTest(t)){
                            switch(v){
                              case "_preScript":
                              case "_endScript":
                                _testTabHandler._data._curCfgTab="script"
                                break
                              default:
                                _testTabHandler._data._curCfgTab="main"
                            }
                            let os=[]
                            t._data.actions.forEach(x=>{
                              if(x.ai.includes(d.code)){
                                if(_testTabHandler._data._curCfgTab=="script"&&x.ai.includes("tab:action")){
                                }else{
                                  os.push(x)
                                }
                              }
                            })
                            if(os.length==1){
                              _ideActionManagement._setCurAction(os[0])
                            }else{
                              BZ._data._uiSwitch._selectedItems.push(...os)
                            }
                          }
                        }
                      }
                    }
                  },
                ]
              },
              //Content
              {
                _tag:"div",_attr:{"class":"bz-h-h-tab-content",style:"height:135px"},
                _items:[
                  //Pre-Step
                  _aiPageHandler._getActionExpendContent(d,"BZ._data._uiSwitch._curContent",1),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curContent.preScript","_preScript"),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curContent.endScript","_endScript")
                ]
              }
            ]
          }
        }
      ]
    }
    _view=_uiHandler._buildFormView(_view,_addOnFormTemplate)
    
    _view._attr={class:"bz-v-panel",style:"flex:1"}

    _aiPageHandler._popInWin(d,_view,_bzMessage._setting._objectLib._content._setting,"_content")
    // _Util._confirmMessage(_view,_aiPageHandler._getCopyPasteBtn(d),_bzMessage._setting._objectLib._content._setting,500,"_close",0,1)
  },
  //web page
  _popPageForm:function(d){
    BZ._data._uiSwitch._curWebPage=d
    let _tabs=["_action","_preScript","_endScript"];
    var m=_IDE._data._curModule._data
    BZ._data._uiSwitch._curDefElement=0

    _aiPageHandler._setCurTab(_tabs)

    let _curModule=_IDE._data._curModule
    var _view={
      _dataRoot:"BZ._data._uiSwitch._curWebPage",
      _messageRoot:"_bzMessage._setting._objectLib._page",
      _items:[
        {
          _name:"name",
          _col:6
        },
        {
          _name:"type",
          _messageRoot:"_bzMessage._model._page._options",
          _options:["page","download"],
          _col:6
        },
        {
          _src:{
            _if:function(){
              if(_curModule!=_IDE._data._curModule){
                _Util._closeModelWindow()
              }
              return 1
            },
            _tag:"div",
            _items:function(){
              return _aiPageHandler._getPathViewDef(BZ._data._uiSwitch._curWebPage)
            }
          }
        },
        {
          _src:{
            _tag:"div",
            _attr:{
              "class":"bz-h-h-tabs bz-std-tabs",
              style:"margin-top:10px;"
            },
            _items:[
              //tabs
              {
                _tag:"div",
                _attr:{"class":"bz-h-h-tab-items"},
                _items:[
                  {
                    _tag:"div",
                    _attr:{
                      "class":function(t){
                        var c="bz-h-h-tab-item"

                        if(t._item==BZ._data._uiSwitch._curDetailsTab){
                          c+=" white-active"
                        }
                        return c
                      },
                      onclick:"BZ._data._uiSwitch._curDetailsTab=this._data._item"
                    },
                    _text:"_bzMessage._setting._objectLib[_data._item]",
                    _dataRepeat:_tabs
                  }
                ]
              },
              //Content
              {
                _tag:"div",_attr:{"class":"bz-h-h-tab-content"},
                _items:[
                  _aiPageHandler._getActionExpendContent(d,"BZ._data._uiSwitch._curWebPage",1),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curWebPage.preScript","_preScript"),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curWebPage.endScript","_endScript")
                ]
              },
            ]
          }
        }
      ]
    }
    _view=_uiHandler._buildFormView(_view,_addOnFormTemplate)

    _aiPageHandler._popInWin(d,_view,_bzMessage._model._page._options.page,"_page")
    // _Util._confirmMessage(_view,_aiPageHandler._getCopyPasteBtn(d),_bzMessage._model._page._options.page,500,"_close",0,1)
  },
  analysis:function(e){
    let d;
    if(_aiPageHandler._isOperation(e)){
      d={
        _type:"_operation",
        _element:e
      }
    }else{
      
    }
    return d;
  },
  _getFieldPath:function(f,m){
    let c=f.code||f,n=[];
    m=_aiGeneratorDataHandler._getModuleObject(m)
    _getPath(m._data.definition.fields,c,n)
    
    function _getPath(fs,c,n){
      return fs.find(x=>{
        if(x.code==c){
          n.push(x)
          return 1
        }else if(x.type=="object"){
          n.push(x)
          if(_getPath(x.fields,c,n)){
            return 1
          }else{
            n.pop()
          }
        }
      })
    }
    return n
  },
  _getFieldRefPath:function(f,m){
    f=_aiPageHandler._getFieldPath(f,m)||[]
    return f.map(x=>x.data).join(".")
  },
  _retrieveOprElement:function(e){
    let s=_IDE._data._curVersion.setting.content.clickableElements;
    let os=$(e).find(s);
    if(!os.length&&$(e).is(s)){
      os=[e]
    }
  },
  _retrieveInputs:function(e){
    return _cssHandler._findAllInputs(e)
  },
  _pickTable:function(e){
    let _tables=_cssHandler._findDefinitedElement(e,"table");
    if(!_tables){
      _tables=[]
      let ts=e.tagName=="TABLE"?[e]:$(e).find("table")
      
      for(var i=0;i<ts.length;i++){
        var t=_cssHandler._getTableType(ts[i]);
        if(["editorTable","dataTable"].includes(t)){
          _tables.push(ts[i])
        }
      }
      if(!_tables.length){
        _tables=0
      }
    }
    return _tables
  },
  _parseOperations:function(e,oth,_operations,_subModules){
    let _btns=_cssHandler._findDefinitedElement(e,"button");
    let _links=_cssHandler._findDefinitedElement(e,"link");
    let os;
    
    if(_btns&&_links){
      for(var i=0;i<_links.length;i++){
        if(_btns.includes(_links[i])){
          _links.splice(i--,1)
        }
      }
      os=_btns.concat(_links)
    }else{
      os=_btns||_links||[]
    }
    let ws=[]
    for(var i=0;i<os.length;i++){
      var _found=0;
      if(_Util._isHidden(os[i])){
        continue
      }
      for(var ii=0;ii<oth.length;ii++){
        if(oth[ii]&&oth[ii].find(os[i]).length){
          _found=1
          break
        }
      }
      if(_found){
        continue
      }
      
      var _path=_cssHandler._findPath(os[i])
      let bz=_cssHandler._getBzPath(os[i])
      if(bz){
        let _type
        if(bz.bz.find(x=>{
          if(x.k.includes("-enter")){
            if(x.k=="$module-enter"){
              if(bz.bz.find(y=>y.v=="$sub-module")){
                _type="modulesub"
              }else{
                _type="enterModule"
              }
            }else if(x.k=="$ex-details-enter"){
              _type="exEnterDetails"
            }else{
              _type="enterDetails"
            }
            _subModules.push(_getData(_type,_path,os[i]))
          }else if(_aiFlagHandler._isOperation(x.k)){
            _type=_aiPageHandler._getBusinessTypeFromWord(x.k)
            _operations.push(_getData(_type,_path,os[i]))
          }
          
          return _type
        })){
          continue
        }
      }
      
      var _define=_descAnalysis._retrieveTextForElementPathItem(_path);
      if(_define){
        _define=_define.replace(/^\$/,"")
      }
      if(ws.includes(_define)){
        continue
      }
      ws.push(_define)
      _define=_aiPageHandler._getBusinessTypeFromWord(_define)
      if(_define){
        _operations.push(_getData(_define,_path,os[i]))
        continue
      }

      if(os[i].tagName!="A"){
        _operations.push(_getData("edit",_path,os[i]))
      }else{
        _subModules.push(_getData("enterDetails",_path,os[i]))
      }
    }
    
    function _getData(_type,_path,a){
      let _name
      if(_type=="enterDetails"){
        _name=_bzMessage._model._enter._options[_type]
      }else{
        _name=_descAnalysis._retrieveTextForElementPathItem(_path)||_descAnalysis._getDescFromPath(_path,1)
        if(_type=="exEnterDetails"){
          _type="enterDetails"
        }
      }
      return {
        name:_name,
        path:_path,
        type:_type,
        _element:a
      }
    }
  },
  _getBusinessTypeFromWord:function(w){
    w=_aiWordHandler._findKeyWordInWords(w)
    if(w&&w._dicDefine){
      var _type=w._dicDefine._type;
      if(_type&&(_type.includes("fun")||_type.includes("operation"))){
        if(_config._businessType.test.includes(w._dicDefine._key)){
          return w._dicDefine._key
        }
        return w._dicDefine._key
      }
    }
  },
  _pickList:function(e){
    let _lists=_cssHandler._findDefinitedElement(e,"list");
    if(!_lists){
      _lists=[]
      let vs=$(e).find("a").toArray()
      if(vs.length>1){
        while(1){
          var r;
          for(let i=0;i<vs.length;i++){
            v=vs[i];
            var rr=v.getBoundingClientRect()
            if(r){
              if(rr.top==r.top){
                return 
              }
            }else{
              r=rr
            }
            vs[i]=v.parentNode
          }
          if(!_isSameElements(vs)){
            return 0
          }
          if(vs[0]==vs[1]){
            return  [vs[0]]
          }
        }
      }
    }
    function _isSameElements(os){
      var t=os[0].tagName,_same=1;
      for(let n=1;n<os.length;n++){
        if(os[n].tagName!=t){
          _same=0
          break
        }
      }
      return _same
    }
  },
  _isForm:function(e){
    let t=_cssHandler._getTableType(e);
    if(t=="form"){
      return 1
    }
    let os=_cssHandler._findAllInputs(e);
    if(e&&e.tagName=="FORM"&&os.length||os.length>1){
      return 1;
    }
  },
  _getDependenceDesc:function(ds){
    return (ds.targetValue?(ds.targetValue+": "):"")+ds.items.map(d=>{
      var v=d.module
      
      if(!d.moduleData||d.moduleData=='specialData'){
        var m=_aiGeneratorDataHandler._getModuleObject(v)
        v=v&&v!=_IDE._data._curModule._data.code?m._data.name+' • ':''

        v+=_aiPageHandler._getFieldRefPath(d.field,m)
        
        if(!"01".includes(d.valueType)){
          v+=" ("+d.valueType+' '+d.value+")"
        }else{
          v+=" ("+_bzMessage._setting._objectLib._field._valueType[d.valueType].split(/ *\(/)[0]+")"
        }
      }else{
        var vv="("+_bzMessage._setting._objectLib._moduleData[d.moduleData]+")"
        if(v){
          v=_aiGeneratorDataHandler._getModuleObject(v)
          if(v){
            v=v._data.name+vv
          }
        }else{
          v="$module"+vv
        }
      }
      return v
    }).join(" "+_bzMessage._common._and+" ")
  },
  //Parse content
  _parseContent:function(_path,e,_fun){
    let os={
      _url:location.href,
      _subModules:[],
      _contents:[],
      _fields:[],
      _webpages:[],
      _operations:[]
    },es=[];
    //parse table
    let _tables=_aiPageHandler._pickTable(e);
    _Util._spliceAll(_tables,x=>_cssHandler._getTableType(x)=="editorTable")
    if(_tables){
      _fillResult(_tables,os._contents,"table",e,_path);
      _tables=$(_tables)
    }
    
    //parse tab
    let _tabs=_cssHandler._findDefinitedElement(e,"tab");
    if(_tabs){
      _tabs.forEach(function(v){
        var _items=_cssHandler._getDefinitionAttrInElement(v,"tab","item")
        _items=_items?_items.toArray():[]
        _fillResult(_items,os._subModules,BZ._data._uiSwitch._curModelPanel.code=="home"?"enterModule":"modulesub",e,_path);
      })
      _tabs=$(_tabs)
    }
    let _lists=_aiPageHandler._pickList(e);
    if((_tables||_tabs)&&_lists){
      for(var i=0;i<_lists.length;i++){
        if((_tables&&_tables.find(_lists[i]).length)||(_tabs&&_tabs.find(_lists[i]).length)){
          _lists.splice(i--,1)
        }
      }
      if(!_lists.length){
        _lists=0
      }
    }
    if(_lists&&_lists.length){
      _fillResult(_lists,os._contents,"list");
      _lists=$(_lists)
    }
    _aiPageHandler._parseOperations(e,[_tables,_tabs,_lists],os._operations,os._subModules)||[];
    os._contents.forEach(function(v){
      v.name=_bzMessage._setting._objectLib._options.component[v.type]

      os._operations.forEach(function(vv){
        if($(v._element).find(vv._element).length){
          vv.content=v.code
        }
      })
    })
    let _code=Date.now(),_hasItem;
    
    var _singleElement=0
    for(var k in os){
      os[k].forEach&&os[k].forEach(v=>{
        if(v._element==e){
          _singleElement=1
        }
        v.qpath=_Util._getQuickPath(v._element)
        es.push(v._element)
        delete v._element
        v.code=_code++
        _hasItem=1
      })
    }
    if(!_singleElement){
      var d={
        path:_cssHandler._findPath(e,0,_hasItem?4:3),
        qpath:_Util._getQuickPath(e),
        code:_code++
      }
      
      if(!_hasItem){
        var t=(e.innerText||"").trim().split("\n")
        d.type=t.length>1?"innerPanel":"viewData";
        d.name=t.length>1?_bzMessage._action._panel:_bzMessage._model._field._title
      }else{
        d.type="innerPanel"
        d.name=_bzMessage._action._panel
      }
      os._subModules.push(d)
    }

    _bzDomPicker._showTmpCover(es,3)
    _fun(os);
    setTimeout(()=>{
      _parseInputs()
    },10)
    function _parseInputs(){
      //parse Inputs
      let _inputs=_cssHandler._findAllInputs(e,0,1)||[],
          _last

      for(var i=0;i<_inputs.length;i++){
        var o=_inputs[i]
        if(_tables&&_tables.find(o).length){
          _inputs.splice(i--,1)
        }else if(_lists&&_lists.find(o).length){
          _inputs.splice(i--,1)
        }
      }
      _buildPath(_inputs,0)
    }
    
    function _buildPath(os,i,_last){
      let o=os[i],_time=Date.now()
      if(o){
        let rs={
          _fields:[]
        }
        _fillResult([o],rs._fields,0,0,0);
        if(rs._fields[0].path){
          let rr=rs._fields[0].path.join(",")
          if(_last!=rr){
            if(o.type=="radio"){
              let o2=os[i+1],oo
              if(o2&&o2.type=="radio"){
                let oo=_Util._getShareParent(o,o2)
                oo=$(oo).find("input[type=radio]").toArray().map(x=>x.value)
                rs._fields[0].inputFormat=`/${oo.join("|")}/`
              }
            }
            _fun(rs)
          }
          _last=rr
        }
        setTimeout(()=>{
          _buildPath(os,i+1,_last)
        },0)
      }
    }
    
    function _fillResult(ts,os,_type,_box,_boxPath){
      let t,ex;
      ts.forEach(function(v){
        var p;
        if(v==_box){
          p=_boxPath
        }else{
          if(["table","list"].includes(_type)){
            p=_cssHandler._findPath(v,0,4);
          }else{
            p=_cssHandler._findPath(v,0,3);
          }
        }
        var d={
          name:_descAnalysis._retrieveTextForElementPathItem(p)||_descAnalysis._getDescFromPath(p,1),
          path:p,
          type:_type,
          _element:v
        };
        d.name=_glossaryHandler._getVariableName(d.name)
        d.name=_Util._toCapitalWord(_Util._parseCamelWords(d.name))

        if(v.disabled||$(v).attr("readonly")){
          d.unedit="on"
        }
        if(!_type){//No type is for input
          t=_aiPageHandler._getDataTypeByElement(v)
          ex={
            alias:"",
            data:_glossaryHandler._getVariableName(d.name),
            type:t,
            inputFormat:_aiPageHandler._getFormat(d.name,t,v),
            required:_aiPageHandler._isRequiredInput(v)?"on":"",
            default:v.value
          }
        }
        if(ex){
          d=Object.assign(d,ex)
        }
        os.push(d)
      })
    }
  },
  _isRequiredInput:function(o){
    if(!_cssHandler._keyMap.required){
      return
    }
    var _css=_cssHandler._keyMap.required._css,oos=$(o.ownerDocument.body).find("*");
    var p=o.parentElement,_idx=oos.index(o);
    while(p){
      var rs=$(p).find(_css)
      var os=_cssHandler._findAllInputs(p)
      
      if(rs.length){
        if(os.length==1){
          return 1
        }
        for(var i=0;i<rs.length;i++){
          var ri=oos.index(rs[i])
          if(ri<_idx){
            for(var n=0;n<os.length;n++){
              var oi=oos.index(os[n])
              if(oi>ri&&oi<_idx){
                return
              }
            }
            return 1
          }
        }
        return
      }else if(os.length>1){
        return
      }
      p=p.parentElement
    }
  },
  _popItem:function(c,m){
    let d=_aiGeneratorDataHandler._getFieldByCode(c,m)
    if(d){
      let p=_aiPageHandler._getFieldPath(d)
      p.pop()
      return _aiPageHandler._popFieldForm(d,p.map(x=>x.code))
    }
    m=_aiGeneratorDataHandler._getModuleObject(m)
    d=m._data.definition
    for(var k in d){
      if(d[k].forEach){
        for(var i=0;i<d[k].length;i++){
          var dd=d[k][i]
          if(dd.code==c){
            BZ._data._uiSwitch._activeModelItem=dd
            if(k=="fields"){
              return _aiPageHandler._popFieldForm(dd)
            }else if(k=="contents"){
              return _aiPageHandler._popContentForm(dd)
            }else if(k=="webpages"){
              return _aiPageHandler._popPageForm(dd)
            }else if(k=="relatedModules"){
              return BZ._setHash(dd.module+"/moduleAndTest",undefined,undefined,undefined,()=>{
                setTimeout(()=>{_aiPageHandler._popItem(c,dd.module)},100)
              })
            }else if(k=="operations"){
              return _aiPageHandler._popOperationForm(dd)
            }
          }else if(dd.buttons){
            let bb=dd.buttons.find(b=>{
              return b.code==c
            })
            if(bb){
              BZ._data._uiSwitch._activeModelItem=bb
              return _aiPageHandler._popButton(bb)
            }
          }
        }
      }
    }
    var ts=_IDE._data._curModule._data.tests
    for(var i=0;i<ts.length;i++){
      var t=ts[i]
      if(t.definition&&c==t.definition.code){
        return _aiPageHandler._popOperationForm(t)
      }
    }
  },
  _getDependenceLevel:function(ds,c){
    if(c=="0"||!c){
      return 0
    }
    for(var i=0;i<ds.length;i++){
      var d=ds[i]
      if(d.code==c){
        if(d.andon==0||!d.andon){
          return 0
        }else{
          return _aiPageHandler._getDependenceLevel(ds,d.andon)+1
        }
      }
    }
  },
  _getDependencePanel(_curItem,_type){
    _curItem.dependencies=_curItem.dependencies||[]
    //Dependence
    return {
      _if:"BZ._data._uiSwitch._curDetailsTab=='_dependence'",
      _tag:"div",
      _attr:{
        style:"margin:10px;height:calc(100% - 20px);overflow:auto;"
      },
      _items:[
        // plus button
        {
          _tag:"button",
          _attr:{
            disabled:"!_aiPageHandler._isCheckout()",
            "class":"btn btn-icon bz-small-btn bz-plus pull-right"
          },
          _jqext:{
            click:function(){
              _aiPageHandler._popDependence(_type,0,_curItem.dependencies)
            }
          }
        },
        // Dependence list
        {
          _tag:"div",
          _attr:{
            "class":"bz-nowrap",
            style:function(_data){
              let c="line-height: 30px;"
              if(!_data._idx){
                c+="margin-top:20px;"
              }
              return c
            }
          },
          _items:[
            //desc
            {
              _tag:"A",
              _text:"_aiPageHandler._getDependenceDesc(_data._item)",
              _attr:{
                // class:"bz-definition-content-item-value",
                style:"width:calc(100% - 60px)"
              },
              _jqext:{
                click:function(){
                  _aiPageHandler._popDependence(_type,this._data._item)
                }
              }
            },
            //delete
            {
              _tag:"button",
              _attr:{
                disabled:"!_aiPageHandler._isCheckout()",
                "class":"btn btn-icon bz-small-btn bz-delete"
              },
              _jqext:{
                click:function(){
                  _curItem.dependencies.splice(this._data._idx,1)
                  _ideModuleManagement._save()
                }
              }
            }
          ],
          _dataRepeat:function(){
            return _curItem.dependencies
          }
        },
        {
          _if:function(){
            return _type=="_operation"&&_aiModelHandler._getParentDependenceTree(BZ._data._uiSwitch._curOperation).pds
          },
          _tag:"div",
          _items:[
            {
              _tag:"hr",
              _attr:{
                style:"width: 100%;margin: 10px 0 5px 0;float: left;"
              }
            },
            {
              _tag:"h3",
              _attr:{style:"margin-bottom: 5px;"},
              _text:"_bzMessage._aiDefinition._parentDependenceNode"
            }
          ]
        },
        {
          _if:function(){
            return _type=="_operation"
          },
          _tag:"div",
          _attr:{"class":"col-xs-12",style:"margin-top:0;"},
          _items:[
            {
              _tag:"div",
              _text:"_data._item._name"
            },
            {
              _tag:"div",
              _attr:{style:"text-indent:20px"},
              _text:"_data._idx+1+': '+_data._item",
              _dataRepeat:"_data._item._list"
            }
          ],
          _dataRepeat:function(){
            let pds=_aiModelHandler._getParentDependenceTree(BZ._data._uiSwitch._curOperation)
            let d=[]
            while(pds.pds){
              let dd={_name:pds.f.name,_list:[]}
              pds.pds.forEach(p=>{
                dd._list.push(_aiPageHandler._getDependenceDesc(p))
              })
              pds=pds.ds
              d.push(dd)
            }
            return d
          }
        }
      ]
    }
  },
  _doTry:function(d,_panel,_enter,_fun){
    if(d.type=="modulesub"){
      d=_aiGeneratorDataHandler._getContentByCode(d.code,d.module)
    }
    if(!d.path){
      if(d.data){
        d.path=[`:input(${d.name||d.data})`,0]
      }else{
        d=_aiGeneratorDataHandler._getContentByCode(d.code)||_aiGeneratorDataHandler._getItemByGroupAndCode("operations",d.code)||d
        if(!d.path){
          if(d.from&&d.from[0]){
            var dd="contents"
            if(d.type=="form"){
              dd=["operations","buttons"]
            }
            let f=d.from[0]
            f=_aiGeneratorDataHandler._getItemByGroupAndCode(dd,f.code,f.module)
            if(f){
              return _aiPageHandler._doTry(f,0,1,_finalFun)
            }
          }
        }
      }
    }
    var dd=_aiStepHandler._getAllSolutionsToElement(d,0,_panel)
    if(dd&&dd.length>1){
      var pm=_aiStepHandler._parseSolutionMap(dd)
      _Util._confirmMessage({
        _tag:"div",
        _items:[
          {
            _tag:"span",_attr:{style:"font-weight:bold;line-height:20px;margin-bottom:15px;display:block;"},
            _text:"_bzMessage._setting._objectLib._selectRoute"
          },
          {
            _tag:"a",_attr:{style:"display:block;margin-bottom:5px;"},
            _items:[
              {
                _text:"_data._idx+1+'. '+_data._item._name"
              },
              {
                _tag:"button",
                _attr:{
                  class:"btn btn-icon bz-small-btn bz-play-blue"
                }
              }
            ],
            _jqext:{
              click:function(){
                _aiStepHandler._exeSolution(this._data._item._data,d,_enter,_finalFun)
              }
            },
            _dataRepeat:pm
          }
        ]
      },0,_bzMessage._setting._objectLib._routes,0,0,0,1)
    }else{
      _aiStepHandler._exeSolution(dd[0],d,_enter,_finalFun)
    }
    
    function _finalFun(){
      _IDE._data._curTest=_ideTask._data._curTest=_ideTask._stayPlayTest=0
      _fun&&_fun()
    }
  },
  //e: lanuch button,
  //v: new panel code
  _changeLanuchPanel:function(e,v){
    var p=_aiGeneratorDataHandler._getContentByCode(e.lanuchPanel,e.lanuchModule),
        mc=_IDE._data._curModule._data.code
    p&&p.from&&p.from.find((f,i)=>{
      if(f.code==e.code){
        p.from.splice(i,1)
        return 1
      }
    })

    if(!v||v=="_newButton"){
      return setTimeout(function(){
        var pp=_aiModelHandler._getModelByCode(e.panel[0])
        if(v=="_newButton"){
          delete e.lanuchPanel
          _aiModelHandler._newModel(e,"buttons",pp)
        }else{
          _aiModelHandler._newModel(e,"operations",pp)
        }
        setTimeout(function(){
          _aiModelHandler._refreshGUI()
        },10)
      },10)
    }else if(v==-1){
      e.lanuchModule=e.lanuchPanel=0
      delete e.lanuchPanel
      delete e.lanuchModule
    }else{
      e.lanuchPanel=v;
      p=_aiGeneratorDataHandler._getContentByCode(e.lanuchPanel,e.lanuchModule)
      _aiPageHandler._addItemToFrom(p.from,e.code,mc)
    }
    _aiModelHandler._refreshGUI()
  },
  _addItemToFrom:function(fs,c,m){
    if(!fs.find(v=>{return v.code==c})){
      fs.push({code:c,module:m})
    }
  },
  _getActionExpendContent:function(d,_objKey,_noResult,_updateModule){
    let _keys=["preSteps","endSteps"]
    _keys.forEach(k=>{
      var tps=BZ._data._uiSwitch[k]=[]
      d[k]=d[k]||[]
      d[k].forEach(a=>{
        a=_Util._clone(a)
        tps.push(a)
      })
    })
    return {
      _if:"BZ._data._uiSwitch._curDetailsTab=='_action'",
      _tag:"div",_attr:{style:"margin:10px;height:calc(100% - 20px)"},
      _items:[
        {
          _tag:"div",
          _attr:{style:"line-height:25px;"},
          _items:[
            {
              _tag:"_data._item._fun?'a':'span'",
              _text:'_data._item._title',
              _attr:{
                class:function(d){
                  let c=d._item._class
                  if(BZ._data._uiSwitch._detailClass==c){
                    c+=" bz-active-detail"
                  }
                  return c
                }
              },
              _jqext:{
                click:function(){
                  BZ._data._uiSwitch._detailClass=this._data._item._class
                  this._data._item._fun()
                }
              }
            },
            {
              _if:"_data._item._value",
              _tag:"span",
              _attr:{style:"margin-left:10px"},
              _text:"_data._item._value()"
            },
            {
              _if:"_data._item._items",
              _tag:"span",
              _attr:{style:"margin-left:10px"},
              _items:"_data._item._items"
            }
          ],
          _dataRepeat:function(){
            let vs=[
              {
                _class:"preSteps",
                _title:_bzMessage._setting._objectLib.preSteps,
                _fun:function(){
                  _launchSteps("preSteps")
                },
                _value:function(){
                  if(d.preSteps.length){
                    return "("+d.preSteps.length+" "+_bzMessage._common._actions+")"
                  }
                }
              },
              {
                _class:"endSteps",
                _title:_bzMessage._setting._objectLib.endSteps,
                _fun:function(){
                  _launchSteps("endSteps")
                },
                _value:function(){
                  if(d.endSteps.length){
                    return "("+d.endSteps.length+" "+_bzMessage._common._actions+")"
                  }
                }
              }
            ]
            return vs
          }
        },
        {
          _if:function(){
            return !d.from&&d.type!="home"
          },
          _tag:"div",
          _attr:{style:"line-height:25px;"},
          _items:[
            {
              _tag:"label",
              _attr:{
                class:"bz-maybe-no-exist"
              },
              _items:[
                {
                  _tag:"input",
                  _attr:{disabled:"!_aiPageHandler._isCheckout()",type:"checkbox"},
                  _dataModel:_objKey+".maybeNoExist"
                },
                {
                  _text:"_bzMessage._aiDefinition._maybeNoExist"
                }
              ]
            }
          ]
        }
      ]
    }
    
    function _popResultHandlerForm(mp,o){
      let _btns=[{
        _title:_bzMessage._method._save,
        _click:function(c){
          o.value=_data._value;

          if(!o.field){
            o.field=_data._attribute
            mp.push(o)
          }
          _ideModuleManagement._save(_updateModule)
          c._ctrl._close()
        }
      }]
      if(o){
        _btns.push({
          _title:_bzMessage._method._delete,
          _class:"btn-warn",
          _click:function(c){
            mp.splice(mp.indexOf(o),1)
            _ideModuleManagement._save(_updateModule)
            c._ctrl._close()
          }
        })
      }
      o=o||{}
      let _data=_CtrlDriver._buildProxy({
            _attribute:o.field,
            _method:o.method,
            _module:o.module||_IDE._data._curModule._data.code,
            _value:o.value,
            _panel:o.panel,
            _element:o.element,
            _script:o.script
          })
      BZ._data._uiSwitch._curTmpEndStepsElementPath=_aiPageHandler._updateElementPathByDemoValue(o.element,1)
      var _view={
        _dataRoot:_data,
        _messageRoot:"_bzMessage._common",
        _items:[
          //attribute
          {
            _name:"_attribute",
            _required:1,
            _options:function(){
              return [{
                _tag:"option",
                _attr:{value:"_data._item.code"},
                _text:"_data._item.name",
                _dataRepeat:function(){
                  let m=_aiGeneratorDataHandler._getModuleObject()
                  return m._data.definition.fields
                }
              }]
            }
          },
          //select value
          {
            _name:"_value",
            _required:1,
          },
        ]
      }
      _view=_uiHandler._buildFormView(_view,_addOnFormTemplate)
      _Util._confirmMessage(_view,_btns,_bzMessage._model._result,500,"_close")
    }
    
    function _launchSteps(k){
      let _doc;
      let _viewDef={
        _tag:"div",
        _after:function(o){
          _doc=o.ownerDocument
        },
        _attr:{style:"margin-top:5px"},
        _items:[
          //control buttons
          {
            _if:function(){
              return d[k].length||BZ._isRecording()
            },
            _tag:"div",
            _items:[
              //delete button
              {
                _if:"!BZ._isRecording()",
                _tag:"button",
                _attr:{
                  title:"_bzMessage._method._delete",
                  "class":"btn btn-icon bz-delete pull-right"
                },
                _jqext:{
                  click:function(){
                    _Util._confirmMessage(
                      _bzMessage._setting._objectLib._content._cleanSteps,[
                      {
                        _title:_bzMessage._method._yes,
                        _click:function(c){
                          d[k]=[]
                          BZ._data._uiSwitch[k]=[]
                          _ideModuleManagement._save(_updateModule)
                          c._ctrl._close()
                        }
                      }
                    ])
                  }
                }
              },
              //record button
              {
                _if:"!BZ._isRecording()",
                _tag:"button",
                _attr:{
                  "class":"btn btn-icon bz-record pull-right",
                  title:"_bzMessage._setting._objectLib._recordSteps"
                },
                _jqext:{
                  click:function(){
                    _doRecord(this,k)
                  }
                }
              },
              //stop button
              {
                _if:"BZ._isRecording()",
                _tag:"button",
                _attr:{
                  "class":"btn btn-icon bz-stop pull-right",
                  title:"_bzMessage._method._stop"
                },
                _jqext:{
                  click:function(){
                    _ideRecorder._end()
                    _ideModuleManagement._save(_updateModule)
                  }
                }
              },
              //Script
              {
                _tag:"button",
                _attr:{
                  "class":"btn btn-icon bz-plus pull-right"
                },
                _jqext:{
                  click:function(){
                    _addAction(this)
                  }
                }
              }
            ]
          },
          //recorder button
          {
            _if:function(){
              return !BZ._isRecording()&&(!d[k]||!d[k].length)
            },
            _tag:"button",
            _attr:{"class":"btn btn-secondary bz-record btn-icon-text"},
            _text:"_bzMessage._setting._objectLib._recordSteps",
            _jqext:{
              click:function(){
                _doRecord(this,k)
              }
            }
          },
          {
            _if:"BZ._isRecording()",
            _tag:"button",
            _attr:{
              "class":"btn btn-secondary btn-icon-text bz-stop",
            },
            _text:"_bzMessage._method._stop",
            _jqext:{
              click:function(){
                _ideRecorder._end()
                _ideModuleManagement._save(_updateModule)
              }
            }
          },
          //Script
          {
            _if:function(){
              return !BZ._isRecording()&&(!d[k]||!d[k].length)
            },
            _tag:"button",
            _attr:{"class":"btn btn-secondary bz-plus btn-icon-text bz-left-space-10"},
            _text:"JS",
            _jqext:{
              click:function(){
                _addAction(this)
              }
            }
          },
          {
            _if:function(){
              return d[k].length
            },
            _tag:"div",
            _attr:{
              style:"max-height:420px;overflow:auto;margin-bottom:0;margin-top:-5px;",
              "class":"col-xs-12"
            },
            _items:[
              {
                _tag:"div",
                _attr:{style:"display:flex;margin:5px 0;"},
                _dragOrder:{
                  _getListData:function(){
                    return BZ._data._uiSwitch[k]
                  },
                  _after:function(){
                    d[k]=BZ._data._uiSwitch[k]
                    _ideModuleManagement._save(_updateModule)
                  }
                },
                _dataRepeat:function(){
                  _Util._resizeModelWindow(0,_doc)
                  return BZ._data._uiSwitch[k]
                },
                _items:[
                  //Delete action
                  {
                    _tag:"button",
                    _attr:{"class":"btn btn-icon bz-small-btn bz-cross",style:"margin:0 10px 0 0"},
                    _jqext:{
                      click:function(){
                        BZ._data._uiSwitch[k].splice(this._data._idx,1)
                        d[k].splice(this._data._idx,1)
                        _ideModuleManagement._save(_updateModule)
                      }
                    }
                  },
                  //Action description
                  {
                    _tag:"a",
                    _attr:{
                      style:"flex:1",
                      class:"bz-ai-ex-steps"
                    },
                    _items:[
                      {
                        _text:function(d){
                          return _ideActionManagement._getAutoDescription(d._item,1).trim()
                        }
                      }
                    ],
                    _jqext:{
                      click:function(){
                        if(BZ._isRecording()){
                          _ideRecorder._end()
                          _ideModuleManagement._save(_updateModule)
                        }
                        let i=this._data._idx;
                        if(this._data._item.type==3){
                          return _handleScriptAction(k,this._data._item,i)
                        }
                        BZ._data._uiSwitch._curAIAction=this._data._item
                        let a=BZ._data._uiSwitch._curAIAction
                        let _body=[
                          {
                            _tag:"div",
                            _attr:{
                              style:"flex:1"
                            },
                            _items:[
                              _uiHandler._getElementPath("BZ._data._uiSwitch._curAIAction.element",function(_data){
                                _aiPageHandler._pickElement(a.element,function(dd){
                                  a.element=dd
                                  // _ideModuleManagement._save(_updateModule)
                                })
                              },0,0,0,0,0,0,0,1)
                            ]
                          }
                        ]
                        
                        if(this._data._item.event.type=="change"){
                          _body.push({
                            _tag:"div",
                            _attr:{"class":"input-group"},
                            _items:[
                              {
                                _tag:"label",
                                _attr:{"class":"input-group-addon"},
                                _text:"_bzMessage._common._value"
                              },
                              {
                                _tag:"input",
                                _attr:{
                                  disabled:"!_aiPageHandler._isCheckout()",
                                  "class":"form-control",
                                },
                                _dataModel:"BZ._data._uiSwitch._curAIAction.event.value"
                              }
                            ]
                          })
                        }
                        _body.push(
                          ...["min","max"].map(x=>{
                            return _stdComponent._getInputViewDef({
                              _label:`_bzMessage._action.${x}`,
                              _dataModel:`BZ._data._uiSwitch._curAIAction.${x}`
                            })
                          }),
                          ...[{
                            _text:"_maybeNoExist",
                            _data:"maybeNoExist"
                          },{
                            _text:"_alwaysExe",
                            _data:"alwaysExe"
                          }].map(x=>{
                            return _stdComponent._getCheckboxRadioViewDef({
                              _label:`_bzMessage._aiDefinition.${x._text}`,
                              _dataModel:`BZ._data._uiSwitch._curAIAction.${x._data}`
                            })
                          })
                          // {
                          //   _tag:"div",
                          //   _attr:{
                          //     class:"col-xs-12"
                          //   },
                          //   _items:[
                          //     {
                          //       _tag:"label",
                          //       _attr:{
                          //         class:"bz-maybe-no-exist"
                          //       },
                          //       _items:[
                          //         {
                          //           _tag:"input",
                          //           _attr:{
                          //             type:"checkbox"
                          //           },
                          //           _dataModel:"BZ._data._uiSwitch._curAIAction.maybeNoExist"
                          //         },
                          //         {
                          //           _text:"_bzMessage._aiDefinition._maybeNoExist"
                          //         }
                          //       ]
                          //     }
                          //   ]
                          // }
                        )
                        //TODO: check button position
                        _Util._confirmMessage({
                          _tag:"div",
                          _attr:{
                            style:"display:flex;flex-direction: column;"
                          },
                          _items:_body
                        },[{
                            _title:_bzMessage._method._tryIt,
                            _class:"btn-secondary",
                            _click:function(c){
                              _ideTask._tryClickElements([a,0],{type:"follow"})
                            }
                          },{
                            _title:_bzMessage._common._save,
                            _click:function(c){
                              setTimeout(()=>{
                                let b=BZ._data._uiSwitch[k][i]
                                b.path=a.element
                                d[k][i].element=_aiPageHandler._updateElementPathWordByCode(_Util._clone(a.element))
                                if(a.event){
                                  b.event.value=a.event.value
                                }
                                b.min=a.min
                                b.max=a.max
                                b.maybeNoExist=a.maybeNoExist
                                eval(_objKey+"."+k+"[i]=BZ._data._uiSwitch[k][i]")
                                _ideModuleManagement._save(_updateModule)
                              },100)
                              c._ctrl._close()
                            }
                          },{
                          _title:_bzMessage._method._cancel,
                          _class:"btn-secondary",
                          _click:function(c){
                            c._ctrl._close()
                          }
                        }],0,0,1)
                      }
                    }
                  }
                ]
              }
            ]
          }
        ]
      }
      _Util._confirmMessage(_viewDef,[{
        _title:_bzMessage._method._tryIt,
        _class:"btn-secondary",
        _click:function(c){
          let as=Object.assign([],BZ._data._uiSwitch[k])
          as.push(0)
          _ideTask._tryClickElements(as,{type:"follow"})
        }
      },{
        _title:_bzMessage._method._close,
        _class:"btn-secondary",
        _click:function(c){
          c._ctrl._close()
        }
      }],_bzMessage._setting._objectLib[k],0,1,0,1)


      function _addAction(o){
        let _doc=o.ownerDocument
        let v=o._data._item
        setTimeout(()=>{
          _addScript(_doc)
          _Util._resizeModelWindow()
        },20)
      }

      function _addScript(_doc){
        let v={
          type:3,
          runInIDE:"on",
          script:_Util._formatMessage(_bzMessage._aiDefinition._defScript,[_aiGeneratorDataHandler._getCurSysCtrlDataName()])
        }
        _insertAction(k,v,(v)=>{
          _handleScriptAction(k,v,d[k].length-1,_doc.body)
        })
      }
    }
    
    function _insertAction(k,v,_fun){
      BZ._data._uiSwitch[k].push(v)
      _Util._resizeModelWindow(this)
      d[k].push(_Util._clone(v))
      _fun(v)
    }

    function _handleScriptAction(k,v,i,_body){
      BZ._data._uiSwitch._tmpScriptAction=v
      _Util._confirmMessage({
        _tag:"div",
        _attr:{class:"bz-model-script-dlg"},
        _items:function(){
          return [
            _bzJSEditor._buildJSEditor({
              _model:"BZ._data._uiSwitch._tmpScriptAction.script",
              _noBtn:1,
              _style:"height:calc(100% - 0px);",
              _label:"",
              _noUpdate:1
            }),
            {
              _tag:"div",
              _attr:{
                style:"position:absolute;display:flex;width:calc(100% - 20px);"
              },
              _items:[
                _stdComponent._getCheckboxRadioViewDef({
                  _label:"_bzMessage._aiDefinition._alwaysExe",
                  _dataModel:"BZ._data._uiSwitch._tmpScriptAction.alwaysExe",
                  _boxStyle:"flex:5;line-height:30px;"
                }),
                _stdComponent._getSelectViewDef({
                  _boxStyle:"flex:2;",
                  _label:"_bzMessage._action._exeScriptBrowser",
                  _dataModel:"BZ._data._uiSwitch._tmpScriptAction.runInIDE",
                  _dataRepeat:{IDE:"on",APP:""},
                  _text:"_data._key",
                  _value:"_data._item"
                })
              ]
            },
            {
              _tag:"div",
              _after:function(){
                setTimeout(()=>{
                  _Util._resizeModelWindow()
                },10)
              },
              _attr:{
                style:"height:20px"
              },
              _text:" "
            },
          ]
        }
      },[{
        _title:_bzMessage._method._done,
        _click:function(c){
          setTimeout(()=>{
            let o=BZ._data._uiSwitch._tmpScriptAction
            d[k][i].script=o.script
            d[k][i].runInIDE=o.runInIDE
            d[k][i].alwaysExe=o.alwaysExe
            c._ctrl._close()
            _ideModuleManagement._save(_updateModule)
            _Util._resizeModelWindow(0,c.ownerDocument)
          },100)
        }
      }],_bzMessage._method._addScript,600,0,0,1,_body) 
    }
    
    function _doRecord(o,k){
      o=_Util._getBox(o,".bz-modal-body")
      if(!d.path){
        d.path=[]
      }
      _doIt()
      
      function _doIt(){
        _ideRecorder._start(function(p){
          let pp={},ps=["element","event","qpath","type","method"]
          ps.forEach(v=>{
            if(p[v]!==undefined){
              pp[v]=p[v]
            }
          })
          
          if(p.event.type=="change"){
            _aiPageHandler._addDefindWord(p.event.value,function(e,m){
              e.field.demoValue=p.event.value
              pp.event.value="{{"+_aiGeneratorDataHandler._getCurSysCtrlDataName(e.module)+"."+e.field.data+"}}"
            })
          }
          pp.element=_aiPageHandler._updateElementPathWordByCode(_Util._clone(p.element))
          

          d[k].push(pp)
          BZ._data._uiSwitch[k].push(p)
          _Util._resizeModelWindow(o)
        })
      }
    }
  },
  _addDefindWord:function(w,_fun){
    let m=_IDE._data._curModule._data
    let d=_CtrlDriver._buildProxy({
      module:m.code,
      field:_aiGeneratorDataHandler._getLabelFields(m,1)
    })
    BZ._data._uiSwitch._defWordData=d
    _Util._confirmMessage({
      _tag:"div",
      _data:d,
      _items:[
        {
          _tag:"div",
          _attr:{
            "class":"col-xs-12",
            _text:function(){
              return _Util._formatMessage(_bzMessage._aiDefinition._isDataWord,[w])
            }
          },
        },
        _uiHandler._getModuleList({
          _dataModel:"BZ._data._uiSwitch._defWordData.module"
        }),
        _stdComponent._getInputViewDef({
          _type:"select",
          _dataModel:"_data.field",
          _dataRepeat:function(d){
            let m=_ideObjHandler._getDataByPath(d.module);
            if(m){
              return m._data.definition.fields
            }
          },
          _text:"_data._item.name",
          _value:"_data._item",
          _label:"_bzMessage._common._field"
        })
      ]
    },[{
      _title:_bzMessage._method._yes,
      _click:function(c){
        _fun(d)
        c._ctrl._close()
      }
    }])
    
  },
  _setCurTab:function(_tabs){
    if(!_tabs.includes(BZ._data._uiSwitch._curDetailsTab)){
      BZ._data._uiSwitch._curDetailsTab=_tabs[0]
    }
  },
  _popRelatedModuleForm:function(d){
    _aiPageHandler._refreshWinData={_data:[d],_fun:"_popRelatedModuleForm"}
    let rm=_aiGeneratorDataHandler._getModuleObject(d.module)._data
    let pd=_aiGeneratorDataHandler._getContentByCode(d.code,rm)
    BZ._data._uiSwitch._curRelatedModule=pd

    let _tabs=["_action","_preScript","_endScript"]
    var m=_IDE._data._curModule._data
    BZ._data._uiSwitch._curDefElement=0

    _aiPageHandler._setCurTab(_tabs)
    var _view={
      _dataRoot:d,
      _messageRoot:"_bzMessage._setting._objectLib._page",
      _items:[
        //Name
        {
          _src:{
            _tag:"div",
            _attr:{"class":"input-group col-xs-6",style:"float:left;margin:3px 0;"},
            _items:[
              {
                _tag:"label",
                _attr:{"class":"input-group-addon"},
                _required:"_data._item._text!='_tag'",
                _text:"_bzMessage._common[_data._item._text]"
              },
              {
                _tag:"input",
                _attr:{
                  "class":"form-control",
                  value:function(d){
                    return _ideObjHandler._getDataByPath(d._supData.module)._data[d._item._name]||""
                  },
                  required:"_data._item._text!='_tag'",
                  readonly:1,
                  value:function(d){
                    return rm[d._item._name]
                  }
                }
              }
            ],
            _dataRepeat:[
              {
                _text:"_name",
                _name:"name"
              },
              {
                _text:"_alias",
                _name:"alias"
              }
            ]
          }
        },
        //type
        // {
          // _name:"type",
          // _dataModel:"_data.type",
          // _messageRoot:"_bzMessage._model._module._options",
          // _options:(function(){
            // if(["modulesub"].includes(d.type)){
              // return [d.type]
            // }
            // return ["module"]
          // })(),
          // _col:6
        // },
        //element path
        {
          _src:{
            _tag:"div",
            _attr:{
              style:"float:left;width:100%;"
            },
            _items:function(){
              return _aiPageHandler._getPathViewDef(pd,0,rm)
            }
          }
        },
        {
          _src:{
            _tag:"div",
            _attr:{
              "class":"bz-h-h-tabs bz-std-tabs",
              style:"margin-top:10px;"
            },
            _items:[
              //tabs
              {
                _tag:"div",
                _attr:{"class":"bz-h-h-tab-items"},
                _items:[
                  {
                    _tag:"div",
                    _attr:{
                      "class":function(t){
                        var c="bz-h-h-tab-item"

                        if(t._item==BZ._data._uiSwitch._curDetailsTab){
                          c+=" white-active"
                        }

                        return c
                      },
                      onclick:"BZ._data._uiSwitch._curDetailsTab=this._data._item"
                    },
                    _text:"_bzMessage._setting._objectLib[_data._item]",
                    _dataRepeat:_tabs
                  }
                ]
              },
              //Content
              {
                _tag:"div",_attr:{"class":"bz-h-h-tab-content",style:"height:135px"},
                _items:[
                  _aiPageHandler._getActionExpendContent(pd,"BZ._data._uiSwitch._curRelatedModule",1,rm),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curRelatedModule.preScript","_preScript"),
                  _aiPageHandler._getScriptPanel("BZ._data._uiSwitch._curRelatedModule.endScript","_endScript")
                ]
              },
            ]
          }
        }
      ]
    }
    _view=_uiHandler._buildFormView(_view,_addOnFormTemplate)

    _aiPageHandler._popInWin(pd,_view,_bzMessage._setting._objectLib._relatedModuleSetting,"_relatedModule")
    // _Util._confirmMessage(_view,[],_bzMessage._setting._objectLib._relatedModuleSetting,500,"_close",0,1)
  },
  //When add a new dependency, auto fill field
  _assignDefDependField:function(fs,d){
    var t
    for(var i=fs.length-1;i>=0;i--){
      var f=fs[i]
      if(!t&&["boolean","enum"].includes(f.type)){
        t=f
      }
      if(f.dependencies){
        if(f.dependencies.find(ff=>{
          return ff.items.find(p=>{
            if(p.module==d.module){
              d.valueType=p.valueType
              d.value=p.value
              d.field=p.field
              return 1
            }
          })
        })){
          return 
        }
      }
    }
    if(t){
      d.field=t.code
      d.valueType=1
    }
  },
  _popDependence:function(t,_orgDependence,fds){
    var _curModule=_IDE._data._curModule._data,
        _curLevel,_parentObj=BZ._data._uiSwitch;
    var d=_CtrlDriver._buildProxy(_Util._clone(_orgDependence||{items:[{module:_curModule.code}]}))
    if(t=="_operation"){
      _parentObj=_parentObj._curOperation
      _curLevel=_parentObj.level
      if(!_orgDependence&&['data','multiple'].includes(_curLevel)){
        d.items[0].moduleData='specialData'
      }
    }else if(t=="_field"){
      d.targetValue=d.targetValue||"[true]"
      _parentObj=_parentObj._curField
    }else if(t=="_module"){
      _parentObj=_parentObj._curRelatedModule
    }else if(t=="_content"){
      _parentObj=_parentObj._curContent
    }else if(t=="_button"){
      _parentObj=_parentObj._curButton
    }
    
    BZ._data._uiSwitch._curTmpDependence=d

    var _view=_stdComponent._getBoxViewDef({
      _style:"height:230px",
      _data:d,
      _items:[
        //target field value (for field only)
        {
          _if:function(){
            return t=="_field"
          },
          _label:"_bzMessage._aiDefinition._targetField",
          _type:"select",
          _dataModel:"_data.targetValue",
          _value:"_data._key",
          _text:"_data._item",
          _disabled:"!BZ._isCheckout(_IDE._data._curModule)",
          _dataRepeat:_bzMessage._setting._objectLib._field._targetType
        },
        {
          _src:{
            _tag:"div",
            _attr:{style:"max-height:400px;overflow:auto;"},
            _items:[
              {
                _tag:"fieldset",
                _attr:{
                  style:"border:0;border-top:var(--bz-border);padding:0;padding:top:10px;margin:0;margin-top:0;"
                },
                _items:[
                  //legend 
                  {
                    _if:"_data._idx",
                    _tag:"legend",
                    _items:[
                      {_text:"_bzMessage._common._and"},
                    ],
                    _attr:{style:"margin-left:10px"}
                  },
                  {
                    _if:function(){
                      return d.items.length>1
                    },
                    _tag:"button",
                    _attr:{
                      "class":"btn btn-primary btn-icon bz-small-btn bz-cross bz-right-circle-btn",
                      style:"margin-top:-16px !important;float:right;"
                    },
                    _jqext:{
                      click:function(){
                        d.items.splice(this._data._idx,1)
                      }
                    }
                  },
                  ..._stdComponent._getInputViewDef([
                    //module
                    {
                      _label:"_bzMessage._common._module",
                      _type:"select",
                      _preOptions:[{
                        _if:function(){
                          if(t=="_content"){
                            return _parentObj.type!="enterModule"
                          }else if(t=="_operation"){
                            return _curLevel!="module"
                          }
                          return 1
                        },
                        _value:_curModule.code,
                        _text:"_bzMessage._aiDefinition._curModule"
                      }],
                      _value:"_data._item.code",
                      _text:"_Util._generateIndentation(_data._item.type=='modulesub'?1:0)+_ideObjHandler._getDataByPath(_data._item.code)._data.name",
                      _dataRepeat:"_aiGeneratorDataHandler._getRelatedModules()",
                      _dataModel:"_data._item.module",
                      _disabled:"!BZ._isCheckout(_IDE._data._curModule)"
                    },
                    //Data
                    {
                      _if:function(d){
                        return d._item.module!=_curModule.code|| ['_operation','_field'].includes(t)||(t=="_content"&&["enterModule"].includes(_parentObj.type))
                      },
                      _label:"_bzMessage._common._data",
                      _type:"select",
                      _disabled:function(d){
                        return !_aiPageHandler._isCheckout()||(_curLevel=='module'&&d._item.module==_curModule.code)
                      },
                      _empty:"_select",
                      _value:"_data._key",
                      _text:"_data._item",
                      _dataRepeat:function(d){
                        var vs=_Util._clone(_bzMessage._setting._objectLib._moduleData)
                        var rm=_aiGeneratorDataHandler._getRefInModule(d._item.module)
                        // if(_curLevel=="module"||!rm||rm.type=='modulesub'){
                          // delete vs.noRef
                          // delete vs.hasRef
                        // }
                        
                        var mm=_ideObjHandler._getDataByPath(d._item.module)
                        if(mm&&mm._data.bt=='account'){
                          vs={
                            specialData:vs.specialData
                          }
                          d._item.moduleData='specialData'
                        // }else if(d._item.module==_curModule.code){
                          // if(_curLevel=="data"){
                            // vs={
                              // specialData:vs.specialData
                            // }
                            // d._item.moduleData='specialData'
                          // }
                        }
                        setTimeout(function(){
                          var v=d._item.moduleData
                          d._item.moduleData=""
                          d._item.moduleData=v
                        },100)
                        return vs
                      },
                      _dataModel:"_data._item.moduleData"
                    },
                    //Field
                    {
                      _if:function(d){
                        return d._item.moduleData=='specialData'
                      },
                      _required:1,
                      _label:"_bzMessage._setting._objectLib._field._title",
                      _type:"select",
                      _dataModel:"_data._item.field",
                      _empty:"_select",
                      _value:"_data._item.code",
                      _disabled:"!BZ._isCheckout(_IDE._data._curModule)",
                      _text:function(d){
                        return _aiPageHandler._getFieldRefPath(d._item,d._supData._item.module)
                      },
                      _dataRepeat:function(d){
                        let m =_ideObjHandler._getDataByPath(d._item.module)
                        if(m&&m._data.definition){
                          var fs=[],cf=BZ._data._uiSwitch._curField
                          m._data.definition.fields.forEach(f=>{
                            if(f!=cf||t!='_field'){
                              if(f.type!="object"){
                                fs.push(f)
                              }else{
                                _insertFields(f,fs,cf)
                              }
                            }else{
                              if(!_orgDependence){
                                _aiPageHandler._assignDefDependField(fs,d._item)
                              }
                            }
                          })
                          return fs
                        }
                        return []

                        function _insertFields(f,fs,cf){
                          f.fields.forEach(x=>{
                            if(x.type=="object"){
                              _insertFields(x,fs,cf)
                            }else if(x!=cf){
                              fs.push(x)
                            }
                          })
                        }
                      }
                    },
                    //Value type
                    {
                      _required:1,
                      _label:"_bzMessage._setting._objectLib._field._valueTypeTitle",
                      _type:"select",
                      _readonly:"!_aiPageHandler._isCheckout()",
                      _dataModel:"_data._item.valueType",
                      _disabled:"!BZ._isCheckout(_IDE._data._curModule)",
                      _empty:"_select",
                      _value:"_data._key",
                      _text:"_data._item",
                      _dataRepeat:function(dd){
                        let vs=_Util._clone(_bzMessage._setting._objectLib._field._valueType)
                        if(dd._item.moduleData=="dataSize"){
                          delete vs[0]
                          delete vs[1]
                          delete vs.regex
                        }
                        setTimeout(function(){
                          var v=dd._item.valueType
                          dd._item.valueType=""
                          dd._item.valueType=v
                        },100)
                        return vs
                      },
                      _resizeModelWindow:1,
                      _jqext:{
                        change:function(){
                          let f=_aiGeneratorDataHandler._getFieldByCode(this._data._item.field,(this._data._item.module||"").split(".")[0])
                          if(this.value=="regex"&&f&&f.type=="enum"){
                            this._data._item.value=f.inputFormat
                          }
                        }
                      }
                    },
                    //Value
                    {
                      _if:function(d){
                        d=d._item
                        return d.moduleData&&(d.moduleData=='dataSize'||(d.field&&d.valueType&&!"01".includes(d.valueType)))
                      },
                      _required:1,
                      _label:"_bzMessage._common._value",
                      _options:[
                        {
                          _if:"_data._item.valueType!='script'",
                          _type:"_data._item.moduleData=='dataSize'?'number':'text'",
                          _required:1,
                          _disabled:"!BZ._isCheckout(_IDE._data._curModule)",
                          _readonly:"!_aiPageHandler._isCheckout()||'01'.includes(_data._item.valueType)",
                          _dataModel:"_data._item.value"
                        },
                        {
                          _if:"_data._item.valueType=='script'",
                          _tag:"textarea",
                          _disabled:"!BZ._isCheckout(_IDE._data._curModule)",
                          _required:1,
                          _placeholder:"_bzMessage._aiDefinition._scriptDesc",
                          _readonly:"!_aiPageHandler._isCheckout()",
                          _dataModel:"_data._item.value"
                        }
                      ]
                    }
                  ])
                ],
                _dataRepeat:"_data.items"
              },
            ]
          }
        },
        {
          _src:{
            _tag:"div",
            _attr:{"class":"col-xs-12"},
            _items:[
              {
                _if:"BZ._isCheckout(_IDE._data._curModule)",
                _tag:"a",
                _attr:{"class":"pull-right"},
                _items:[
                  {
                    _tag:"button",
                    _attr:{
                      "class":"btn btn-icon bz-small-btn bz-plus bz-right-space-5"
                    }
                  },
                  {_text:"_bzMessage._common._and"}
                ],
                _jqext:{
                  click:function(){
                    d.items.push({module:""})
                    _Util._resizeModelWindow(this)
                  }
                }
              }
            ]
          }
        }
      ]
    })

    _Util._confirmMessage(_view,[{
      _title:_bzMessage._common._ok,
      _click:function(c){
        if(_aiGeneratorDataHandler._validDependences(t,d,_parentObj)){
          d.code=d.code||Date.now()
          if(!_orgDependence){
            fds.push(d)
          }else{
            $.extend(_orgDependence,d)
          }
          d.items.forEach(a=>{
            if("01".includes(a.valueType)){
              delete a.value
            }
          })
          _ideModuleManagement._save(_IDE._data._curModule._data,function(){
            if(t=="_field"){
              _curModule.definition.operations.forEach(o=>{
                _aiGeneratorDataHandler._deepValidDependenceForOperation(o)
              })
            }
            _aiModelHandler._buildCurDependenceCondition()
          })
          c._ctrl._close()
        }
      }
    }],_bzMessage._setting._objectLib._dependence,0,0,0)
  },
  _getCurPanelData:function(){
    return _aiGeneratorDataHandler._getContentByCode(BZ._data._uiSwitch._curModelPanel.code)
  },
  _pickElement:function(_path,_fun){
    _path=_path||""
    if(bzTwComm._isIDE()){
      _bzDomPicker._back=_fun
      _path=_path||[]
      _extensionComm._exeFun("_pickElement","_bzDomPicker",_path,_path[0]);
    }else{
      var d={_type:_path};
      if(_path.constructor==Object){
        d=_Util._clone(_path)
        d._type=_path._path
      }
      d._id="_element"
      d._back=_fun
      
      _bzDomPicker._start(d);
    }
  },
  //m:module code, f: field code
  _getFieldName:function(m,f){
    m=_aiGeneratorDataHandler._getModuleObject(m);
    f=_aiGeneratorDataHandler._getFieldByCode(f,m)
    return f?(m!=_IDE._data._curModule?m._data.name+".":"")+f.name:""
  },
  _updateByDemoValue:function(v){
    let ps=v.match(_IDE._insertJSOnlyRegex)
    ps&&ps.forEach(x=>{
      let y=_aiPageHandler._getDemoFieldFromVariable(x)
      if(y&&y.demoValue){
        v=v.replace(x,y.demoValue)
      }
    })
    return v
  },
  //p:element path,m:module,d:data object,
  _updateElementPathByDemoValue:function(p,_assignDemoValue){
    if(p){
      p=_Util._clone(p);
      if(_assignDemoValue){
        p.forEach((x,i)=>{
          let xs=_JSHandler._parseCode(x+"")
          if(xs&&xs.constructor==Array){
            xs.forEach(x=>{
              if(x.code){
                x="{{"+x.code+"}}"
                let xx=_aiPageHandler._getDemoFieldFromVariable(x)
                if(xx&&xx.demoValue){
                  p[i]=p[i].replace(x,xx.demoValue)
                }else{
                  let v=_JSHandler._prepareData(x)
                  if(v){
                    p[i]=p[i].replace(x,v)
                  }
                }
              }
            })
          }
        })
      }
    }
    return p
  },
  _getDemoFieldFromVariable:function(x){
    x=x+""
    x=x&&x.match(_IDE._insertJSOnlyRegex)
    if(x){
      x=x[0].split(".")
      let ff=x.pop(),m;
      if("$project"!=x[0]){
        m=_IDE._data._curModule._data
      }else{
        m=x.pop()
        m=_IDE._data._curVersion.modules.find(mi=>{
          return _aiGeneratorDataHandler._getCurModuleDataName(mi)==m
        })
      }
      if(m){
        let bf=ff
        ff=_aiGeneratorDataHandler._getFieldByBindDataName(ff,m)
        if(ff){
          if(ff.demoValue){
            $project=$project||{}
            m=_aiGeneratorDataHandler._getCurModuleDataName(m)
            $project[m]=$project[m]||{}
            $project[m][ff.data]=ff.demoValue
            return ff
          }else if(!ff.type.includes("module")){
            return _Util._formatMessage(_bzMessage._aiDefinition._missingDemoValue,ff.name)
          }
        }else{
          return _Util._formatMessage(_bzMessage._aiDefinition._unexistField,bf)
        }
      }
    }
  },
  _getFieldByDemoValue:function(v,mm){
    let m=_aiGeneratorDataHandler._getModuleObject(mm)
    if(m&&m._data.definition&&m._data.definition.fields){
      let fs=m._data.definition.fields
      let x=fs.find(f=>{
        return f.demoValue==v
      })
      if(x){
        return {f:x,m:m}
      }
      if(!mm){
        _ideObjHandler._getSubModules(m).find(y=>{
          x=_aiPageHandler._getFieldByDemoValue(v,y)
          if(x){
            return x
          }
        })
        if(x){
          return x
        }
        while(m._data.parentModule){
          m=_ideObjHandler._getDataByPath(m._data.parentModule)
          x=_aiPageHandler._getFieldByDemoValue(v,m)
          if(x){
            return x
          }
        }
        _IDE._data._curVersion.modules.find(y=>{
          if(y!=m._data&&!y.parentModule){
            x=_aiPageHandler._getFieldByDemoValue(v,y)
            if(x){
              return x
            }
          }
        })
        if(x){
          return x
        }
      }
    }
  },
  //p:element path, w:registerWord
  _updateElementPathWordByCode:function(p){
    p&&p.forEach((pp,i)=>{
      var ww=_descAnalysis._retrieveTextForElementPathItem(pp)
      if(!ww||ww.match(/\{\{/)){
        return
      }
      let f=_aiPageHandler._getFieldByDemoValue(ww)
      if(f){
        p[i]=p[i].replace(ww,"{{$project."+_aiGeneratorDataHandler._getCurModuleDataName(f.m)+"."+f.f.data+"}}")
      }
    })
    return p
  },
  _getDataTypeByElement:function(e){
    let t=e.tagName.toLowerCase();
    if(t=="input"){
      t=e.type
    }else if(t=="select"){
      if(e.multiple){
        t="array"
      }
    }else{
      t="textarea"
    }
    if(t=="text"){
      let v=e.value.match(/[0-9]+/)
      if(v&&e.value==v[0]){
        t="number"
      }else{
        v=e.value.match(/[0-9]+\.[0-9]+/)
        if(v&&e.value==v[0]){
          t="float"
        }
      }
    }
    t=_aiPageHandler._inputTypeMap[t]
    return t
  },
  _inputTypeMap:{
    text:"string",
    textarea:"text",
    select:"enum",
    checkbox:"boolean",
    radio:"enum",
    date:"date",
    number:"number",
    array:"array"
  },
  //name
  _getFormat:function(n,t,e){
    if(t=="boolean"||(e&&e.type=="checkbox")){
      return "/true|false/"
    }else if(e&&e.type=="number"){
      return _aiWordHandler._getRegexByWord("number")
    }else if(e&&e.type=="decimal"){
      return _aiWordHandler._getRegexByWord("decimal")
    }else if(e&&e.type=="radio"){
      return "/"+_Util._getAllRadioValues(e).join("|")+"/"
    }else if((e&&e.tagName=="SELECT")||t=="enum"){
      return e&&e._ergodicValueList||"/{random}/"
    }else if(["string","text"].includes(t)){
      return _aiWordHandler._getRegexByWord(n)
    }else if(t=="date"){
      return "/{today}/" 
      //tomorrow, next-mon, this-mon, this-1, next-end, next-month-end
    }else if(window._attributeMap){
      t=_attributeMap.find(x=>x.key==t)
      if(t){
        return t.regex
      }
    }
  },
  _getErgodic:function(n){
    return _glossaryHandler._findSimilarWord(_IDE._data._setting.ergodicMap.map(a=>{return a.key}),n)
  },
  _switchUIElementType:function(_this,_from){
    let _msg=_Util._formatMessage(_bzMessage._setting._objectLib[1==_this.value?'_askSwitchToOperation':2==_this.value?'_switchToWebLink':'_switchToTrigger'],_this._data._item.name)
    if("123".includes(_this.value)){
      _Util._confirmMessage({
        _tag:"div",
        _items:[
          {
            _tag:"p",
            _html:"<div>"+_msg+"</div>"
          },
          {
            _if:_this.value==1,
            _tag:"select",
            _attr:{"class":"form-control",id:"tmpItem"},
            _items:[
              {
                _tag:"option",
                _attr:{
                  value:"_data._item",
                  selected:"_data._item=='edit'"
                },
                _text:"_bzMessage._setting._objectLib._options.operation[_data._item]",
                _dataRepeat:_aiPageHandler._operationKeys
              }
            ]
          },
          {
            _if:_this.value==2,
            _tag:"select",
            _attr:{"class":"form-control",id:"tmpItem"},
            _items:[
              {
                _tag:"optgroup",
                _attr:{
                  label:"_data._item._title"
                },
                _items:[
                  {
                    _tag:"option",
                    _attr:{value:"_data._key"},
                    _text:"_data._item",
                    _dataRepeat:"_data._item._options"
                  }
                ],
                _dataRepeat:function(){
                  var os=_bzMessage._model
                  var rs={}
                  if(BZ._data._uiSwitch._curModelPanel.code!="home"){
                    rs._module=os._module
                  }
                  rs._enter=os._enter,
                  rs._page=os._page,
                  rs._others=os._others
                  return rs
                }
              }
            ]
          },
          {
            _if:_this.value==3,
            _tag:"select",
            _attr:{"class":"form-control",id:"tmpItem"},
            _items:[
              {
                _tag:"option",
                _attr:{
                  value:"_data._key",
                  selected:"_data._key=='submit'"
                },
                _text:"_data._item",
                _dataRepeat:function(){
                  let vs=_Util._clone(_bzMessage._model._trigger._options)
                  delete vs.cancel
                  return vs
                }
              }
            ]
          }
        ]
      },[
        {
          _title:_bzMessage._common._ok,
          _click:function(c){
            _this._data._supData[_from].splice(_this._data._idx,1)
            if(_this.value==1){
              _this._data._item.fieldMap={}
              _this._data._supData._operations.push(_this._data._item)
            }else if(_this.value==2){
              _this._data._supData._subModules.push(_this._data._item)
            }else if(_this.value==3){
              _this._data._supData._buttons.push(_this._data._item)
            }
            _this._data._item.type=$("#tmpItem").val()
            c._ctrl._close()
          }
        },
        {
          _title:_bzMessage._method._cancel,
          _class:"btn-secondary",
          _click:function(c){
            c._ctrl._close()
          }
        }
      ],0,0,1)
    }
  },
  _chkItemNewName:function(o,_newName){
    var p=BZ._data._uiSwitch._curModelPanel
    for(var i=0;p.items&&i<p.items.length;i++){
      i=p.items[i]
      i=_aiGeneratorDataHandler._getItemByGroupAndCode(i.group,i.code)
      if(i.name==_newName){
        _newName+=1
      }
    }
    return _newName
  }
}

_aiPageHandler._contentViewDef={
  _tag:"div",
  _attr:{
    style:"display:flex;flex-direction:column;"
  },
  _items:[
    {
      _tag:"div",
      _items:[
        //pick element
        {
          _if:function(d){
            return !d._contents.length
                 &&!d._panel
                 &&!d._buttons.length
                 &&!d._subModules.length
                 &&!d._operations.length
                 &&!d._fields.length
                 &&!d._webpages.length
                 &&!BZ._data._uiSwitch._inBatchModels
          },
          _tag:"button",
          _attr:{
            class:"btn btn-icon bz-small-btn btn-icon-text bz-dompicker"
          },
          _text:"_bzMessage._method._pickElement",
          _jqext:{
            click:function(c){
              _aiModelHandler._addItemFromUI(BZ._data._uiSwitch._curModelPanel)
            }
          }
        },
        //Add element
        {
          _tag:"button",
          _attr:{
            class:"btn btn-icon bz-small-btn btn-icon-text bz-plus bz-right-space-20"
          },
          _text:"_bzMessage._method._addModel",
          _jqext:{
            click:function(c){
              this._data._subModules.push({code:_aiAPI._newId(),path:[]})
              _Util._resizeModelWindow()
            }
          }
        },
        //add fields
        {
          _if:function(d){
            return !d._contents.length
                 &&!d._panel
                 &&!d._buttons.length
                 &&!d._subModules.length
                 &&!d._operations.length
                 &&!d._fields.length
                 &&!d._webpages.length
                 &&!BZ._data._uiSwitch._inBatchModels
          },
          _tag:"button",
          _attr:{
            class:"btn btn-icon bz-small-btn btn-icon-text bz-plus bz-right-space-20"
          },
          _text:"_bzMessage._method._batchAddModels",
          _jqext:{
            click:function(c){
              BZ._data._uiSwitch._inBatchModels=1
              $(".bz-add-elements").hide()
              $(".bz-next-txt-to-fields").show()
              _Util._resizeModelWindow()
            }
          }
        }
      ]
    },
    {
      _if:function(d){
        return !(!d._contents.length
             &&!d._panel
             &&!d._buttons.length
             &&!d._subModules.length
             &&!d._operations.length
             &&!d._fields.length
             &&!d._webpages.length)
      },
      _tag:"div",
      _attr:{"class":"bz-flex-tr col-xs-12",style:"flex:1"},
      _items:[
        {
          _tag:"div",
          _attr:{"class":"input-group",style:"flex:1;padding-left:12px"},
          _text:"_bzMessage._common._type"
        },
        {
          _tag:"div",
          _attr:{"class":"input-group",style:"flex:2;padding-left:4px"},
          _text:"_bzMessage._common._name"
        },
        {
          _tag:"hr",
          _attr:{
            style:"position: absolute;left: 0;width: 100%;bottom: -10px;"
          }
        }
      ]
    },
    {
      _if:function(d){
        return !(!d._contents.length
             &&!d._panel
             &&!d._buttons.length
             &&!d._subModules.length
             &&!d._operations.length
             &&!d._fields.length
             &&!d._webpages.length)
      },
      _tag:"div",
      _attr:{"class":"pre-definition-list"},
      _items:[
        //panel
        {
          _if:"_data._panel",
          _tag:"div",
          _attr:{
            "class":"bz-flex-tr"
          },
          _items:[
            {
              _tag:"div",
              _attr:{
                "class":"input-group",style:"flex:1"},
              _items:[
                {
                  _tag:"select",
                  _attr:{
                    disabled:"!_aiPageHandler._isCheckout()",
                    "class":"form-control"
                  },
                  _dataModel:"_data._panel.type",
                  _items:[
                    {
                      _tag:"option",
                      _attr:{value:"_data._key"},
                      _text:"_data._item",
                      _dataRepeat:"_bzMessage._model._panel._options"
                    }
                  ],
                  _jqext:{
                    change:function(){
                      this._data._panel.name=_aiPageHandler._chkItemNewName(this,this.selectedOptions[0].text)
                    }
                  }
                }
              ]
            },
            {
              _tag:"div",
              _attr:{"class":"input-group",style:"flex:2"},
              _items:[
                {
                  _tag:"input",
                  _dataModel:"_data._panel.name",
                  _attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control"}
                },
                {
                  _tag:"div",_attr:{"class":"input-group-btn"},
                  _items:[
                    {
                      _tag:"button",
                      _attr:{
                        "class":"btn btn-icon bz-delete bz-small-btn",
                        title:"_bzMessage._method._delete"
                      },
                      _jqext:{
                        click:function(){
                          this._data._panel=0
                        }
                      }
                    }
                  ]
                }
              ]
            }
          ],
          _jqext:{
            click:function(){
              _bzDomPicker._flashTmpCover(this._data._panel.path,1);
            }
          },
        },
        //buttons
        {
          _tag:"div",
          _attr:{"class":"bz-flex-tr"},
          _dataRepeat:function(d){
            if(!d._buttons||!d._buttons.length){
              return d._buttons
            }
            d._buttons.forEach(b=>{
              if(!["submit","next","ex-insert","form-tab","confirm","outopr"].includes(b.type)){
                b.type="close"
              }
            })

            var mp=BZ._data._uiSwitch._curModelPanel;
            var c=_aiGeneratorDataHandler._getContentByCode(mp.code)
            if(c.from&&c.from[0]){
              let f=c.from[0]
              if(_aiGeneratorDataHandler._getItemByGroupAndCode(["operations","buttons"],f.code,f.module)){
                return d._buttons
              }
            }
          },
          _jqext:{
            click:function(){
              _bzDomPicker._flashTmpCover(this._data._item.path,1);
            }
          },
          _items:[
            {
              _tag:"div",
              _attr:{"class":"input-group",style:"flex:1"},
              _items:[
                {
                  _tag:"select",
                  _attr:{
                    disabled:"!_aiPageHandler._isCheckout()",
                    class:"form-control"
                  },
                  _dataModel:"_data._item.type",
                  _items:[
                    {
                      _tag:"option",
                      _attr:{value:"_data._item"},
                      _dataRepeat:["submit","next","confirm","outopr","close","insert","ex-insert","form-tab"],
                      _text:"_bzMessage._model._trigger._options[_data._item]"
                    },
                    {
                      _if:function(){
                        var mp=BZ._data._uiSwitch._curModelPanel;
                        var c=_aiGeneratorDataHandler._getContentByCode(mp.code)
                        return c.type!="form"
                      },
                      _tag:"optgroup",
                      _attr:{
                        label:"_bzMessage._setting._objectLib._operation._title"
                      },
                      _items:[
                        {
                          _tag:"option",_attr:{value:"1"},
                          _text:"_bzMessage._setting._objectLib._switchToOperation"
                        },
                        {
                          _tag:"option",_attr:{value:"2"},
                          _text:"_bzMessage._setting._objectLib._switchToWebLink"
                        }
                      ]
                    }
                  ],
                  _jqext:{
                    change:function(){
                      this._data._item._pickModule=0
                      this._data._item.module=0
                      _aiPageHandler._switchUIElementType(this,"_buttons")
                    }
                  }
                }
              ]
            },
            {
              _tag:"div",
              _attr:{"class":"input-group",style:"flex:2"},
              _items:[
                {
                  _tag:"input",
                  _attr:{
                    "class":"form-control",
                    disabled:"!_aiPageHandler._isCheckout()||!_data._item.type"
                  },
                  _dataModel:"_data._item.name",
                },
                {
                  _tag:"div",_attr:{"class":"input-group-btn"},
                  _items:[
                    {
                      _tag:"button",
                      _attr:{
                        "class":"btn btn-icon bz-delete bz-small-btn",
                        title:"_bzMessage._method._delete"
                      },
                      _jqext:{
                        click:function(){
                          this._data._supData._buttons.splice(this._data._idx,1)
                        }
                      }
                    }
                  ]
                }
              ]
            }
          ]
        },
        //subModule/contents
        {
          _tag:"div",_attr:{"class":"bz-flex-tr"},
          _dataRepeat:"_data._subModules",
          _items:[
            {
              _tag:"div",
              _attr:{"class":"input-group",style:"flex:1"},
              _items:[
                {
                  _tag:"select",
                  _attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control"},
                  _dataModel:"_data._item.type",
                  _items:[
                    {
                      _tag:"optgroup",
                      _attr:{
                        label:"_data._item._title"
                      },
                      _items:[
                        {
                          _tag:"option",
                          _attr:{value:"_data._key"},
                          _text:"_data._item",
                          _dataRepeat:"_data._item._options"
                        }
                      ],
                      _dataRepeat:function(d){
                        var os=_bzMessage._model
                        var rs={}
                        if(_aiGeneratorDataHandler._getContentByCode(BZ._data._uiSwitch._curModelPanel.code).type=="form"){
                          if(_Util._isEmpty(d._item.path)){
                            rs._field={
                              _title:os._field._title,
                              _options:_bzMessage._setting._objectLib._dataType
                            }
                            return rs
                          }
                        }
                        if(["innerPanel","curPanel"].includes(d._item.type)){
                          rs._panel=os._panel
                        }else{
                          rs._module={
                            _title:os._module._title,
                            _options:{
                              modulesub:os._module._options.modulesub
                            }
                          }
                          rs._enter=os._enter
                          rs._page=os._page
                          rs._table=os._table
                          rs._field=os._field
                        }
                        return rs
                      }
                    },
                    {
                      _tag:"optgroup",
                      _attr:{
                        label:"_bzMessage._setting._objectLib._operation._title"
                      },
                      _items:[
                        {
                          _if:function(){
                            var mp=BZ._data._uiSwitch._curModelPanel;
                            var c=_aiGeneratorDataHandler._getContentByCode(mp.code)
                            return c.type!="form"
                          },
                          _tag:"option",
                          _attr:{
                            value:"_data._item"
                          },
                          _text:"_bzMessage._setting._objectLib._options.operation[_data._item]",
                          _dataRepeat:["add","edit","delete"] 
                        },
                        {
                          _if:function(){
                            var mp=BZ._data._uiSwitch._curModelPanel;
                            var c=_aiGeneratorDataHandler._getContentByCode(mp.code)
                            return c.type=="form"
                          },
                           _tag:"option",
                           _attr:{value:"_data._item"},
                          _text:"_bzMessage._model._trigger._options[_data._item]",
                          _dataRepeat:["submit","next","confirm","close","outopr","insert","ex-insert","form-tab"]
                        }
                      ]
                    }
                  ],
                  _jqext:{
                    change:function(){
                      this._data._item._pickModule=0
                      this._data._item.module=0
                      this._data._item.name=this.selectedOptions[0].text
                      _aiPageHandler._switchUIElementType(this,"_subModules")
                    }
                  }
                }
              ]
            },
            {
              _tag:"div",
              _attr:{"class":"input-group",style:"flex:2"},
              _items:[
                {
                  _if:"!_data._item._pickModule",
                  _tag:"input",
                  _attr:{
                    "class":"form-control"
                  },
                  _dataModel:"_data._item.name",
                },
                {
                  _if:function(d){
                    if(!d._item._pickModule&&!d._item.module){
                      return 0
                    }
                    d=d._item.type;
                    
                    return d.startsWith("module")
                  },
                  _tag:"select",_attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control"},
                  _dataModel:"_data._item.module",
                  _items:[
                    {
                      _tag:"option",
                      _text:"'['+_bzMessage._method._newModule+' ...]'",
                      _attr:{value:"_new",style:'font-style: italic;'}
                    },
                    {
                      _tag:"option",
                      _attr:{value:"_data._item._data.code",style:function(d){
                        if(!d._item._data.bt){
                          return "display:none"
                        }
                      }},
                      _text:"_data._item._data.name",
                      _dataRepeat:function(d){
                        d=d._item.type;
                        if(d=="modulesub"){
                          // return _ideObjHandler._getSubModules(_ideObjHandler._getRootModule()._data.code)
                          return _ideObjHandler._getSubModules(_IDE._data._curModule._data.code)
                        }else{
                          return _ideObjHandler._getSubModules("")
                        }
                      }
                    }
                  ],
                  _jqext:{
                    change:function(){
                      if(this.value=='_new'){
                        var _this=this
                        setTimeout(function(){
                          _this._data._item._pickModule=0;
                          _this._data._item.module=0
                        },20)
                      }
                    }
                  }
                },
                {
                  _if:function(d){
                    if(d._item._pickModule||d._item.module){
                      return 
                    }
                    d=d._item.type;
                    return d&&d.startsWith("module")
                  },
                  _tag:"div",_attr:{"class":"input-group-btn"},
                  _items:[
                    {
                      _tag:"button",
                      _attr:{
                        "class":"btn btn-icon bz-small-btn pull-right",
                        title:"_bzMessage._model._selectModule"
                      },
                      _text:"...",
                      _jqext:{
                        click:function(){
                          this._data._item._pickModule=1
                        }
                      }
                    }
                  ]
                },
                {
                  _tag:"div",_attr:{"class":"input-group-btn"},
                  _items:[
                    {
                      _tag:"button",
                      _attr:{
                        "class":"btn btn-icon bz-delete bz-small-btn",
                        title:"_bzMessage._method._delete"
                      },
                      _jqext:{
                        click:function(){
                          var d=this._data._supData._subModules.splice(this._data._idx,1)
                        }
                      }
                    }
                  ]
                }
              ]
            }
          ],
          _jqext:{
            click:function(){
              _bzDomPicker._flashTmpCover(this._data._item.path,1);
            }
          },
        },
        //operations
        {
          _tag:"div",_attr:{"class":"bz-flex-tr"},
          _dataRepeat:"_data._operations",
          _items:[
            {
              _tag:"div",
              _attr:{"class":"input-group",style:"flex:1"},
              _items:[
                {
                  _tag:"select",
                  _attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control"},
                  _dataModel:"_data._item.type",
                  _items:[
                    {
                      _tag:"option",
                      _attr:{
                        value:"_data._item"
                      },
                      _text:"_bzMessage._setting._objectLib._options.operation[_data._item]",
                      _dataRepeat:_aiPageHandler._operationKeys
                    },
                    {
                      _tag:"optgroup",
                      _attr:{
                        label:"_bzMessage._setting._objectLib._operation._title"
                      },
                      _items:[
                        {
                          _tag:"option",_attr:{value:"2"},
                          _text:"_bzMessage._setting._objectLib._switchToWebLink"
                        }
                      ]
                    }
                  ],
                  _jqext:{
                    change:function(){
                      _aiPageHandler._switchUIElementType(this,"_operations")
                    }
                  }
                }
              ]
            },
            {
              _tag:"div",
              _attr:{"class":"input-group",style:"flex:2"},
              _items:[
                {
                  _tag:"input",_attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control"},
                  _dataModel:"_data._item.name",
                  _jqext:{
                    click:function(){
                      _bzDomPicker._flashTmpCover(this._data._item.path,1);
                    }
                  }
                },
                {
                  _tag:"div",_attr:{"class":"input-group-btn"},
                  _items:[
                    {
                      _tag:"button",
                      _attr:{
                        "class":"btn btn-icon bz-delete bz-small-btn pull-right"
                      },
                      _jqext:{
                        click:function(){
                          var d=this._data._supData._operations.splice(this._data._idx,1)
                        }
                      }
                    }
                  ]
                }
              ]
            }
          ]
        },
        //fields
        {
          _tag:"div",_attr:{"class":"bz-flex-tr"},
          _dataRepeat:"_data._fields",
          _items:[
            {
              _tag:"div",
              _attr:{"class":"input-group",style:"flex:1"},
              _items:[
                {
                  _tag:"select",
                  _attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control"},
                  _dataModel:"_data._item.type",
                  _items:[
                    {
                      _tag:"option",
                      _attr:{
                        value:"_data._item"
                      },
                      _text:"_bzMessage._setting._objectLib._dataType[_data._item]",
                      _dataRepeat:"Object.keys(_bzMessage._setting._objectLib._dataType)"
                    }
                  ],
                  _jqext:{
                    change:function(){
                      var sd=this._data._supData;
                      var d=this._data._item

                      if(this.value=="list"){
                        sd._subModules.push(d)
                        d.type="list"
                        sd._fields.splice(this._data._idx,1)
                      }
                      _Util._resizeModelWindow()
                    }
                  }
                }
              ]
            },
            {
              _tag:"div",
              _attr:{"class":"input-group",style:"flex:2"},
              _items:[
                {
                  _tag:"input",_attr:{disabled:"!_aiPageHandler._isCheckout()","class":"form-control"},
                  _dataModel:"_data._item.name",
                  _jqext:{
                    focus:function(){
                      _bzDomPicker._flashTmpCover(this._data._item.path,1);
                    }
                  }
                },
                {
                  _tag:"div",_attr:{"class":"input-group-btn"},
                  _items:[
                    {
                      _tag:"button",
                      _attr:{
                        "class":"btn btn-icon bz-delete bz-small-btn pull-right"
                      },
                      _jqext:{
                        click:function(){
                          var d=this._data._supData._fields.splice(this._data._idx,1)
                        }
                      }
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      _if:"BZ._data._uiSwitch._inBatchModels",
      _tag:"div",
      _attr:{
        class:"input-group"
      },
      _items:[
        {
          _tag:"label",
          _attr:{
            class:"input-group-addon"
          },
          _text:"_bzMessage._model._batchType"
        },
        {
          _tag:"select",
          _attr:{
            class:"form-control"
          },
          _dataModel:"BZ._data._uiSwitch._batchType",
          _items:[
            {
              _tag:"option",
              _attr:{
                value:"field"
              },
              _text:"_bzMessage._model._field._title"
            },
            {
              _tag:"option",
              _attr:{
                value:"edit"
              },
              _text:"_bzMessage._setting._objectLib._options.operation._title"
            },
            {
              _tag:"option",
              _attr:{
                value:"modulesub"
              },
              _text:"_bzMessage._model._module._options.modulesub"
            }
          ]
        }
      ]
    },
    {
      _if:"BZ._data._uiSwitch._inBatchModels",
      _tag:"div",
      _attr:{
        class:"bz-v-panel",
        style:"height:300px;"
      },
      _items:[
        {
          _tag:"textarea",
          _attr:{
            class:"bz-no-border-select bz-text-fields",
            style:"border: var(--bz-border);flex:1;"
          },
          _focus:1
        },
        {
          _tag:"div",
          _attr:{
            class:"bz-note-text",
            style:"margin-top:5px;"
          },
          _text:"You can typing fields name or data name, and split by enter."
        }
      ]
    }
  ]
};var _aiVisitHandler={
  _status:0,
  _data:[],
  _queue:[],
  _init:function(){
    this._status=0;
    this._data=[]
    this._queue=[]
  },
  _start:function(a){
    var q=this._queue
    if(q.length&&a==q[0]){
      this._doNext(q[0])
    }else if(!a._key){
      _aiVisitHandler._queue.unshift(a)
      _extensionComm._retrieveDataFromTW("location.href",function(v){
        a._rootUrl=v
        a._key=Date.now()
        a._steps=[]
        _aiVisitHandler._putPickAction(a)
        if(_aiVisitHandler._queue.length==1){
          _aiVisitHandler._handleAction({
            type:_ideActionData._type._refresh
          })
        }
      },1);
    }else{
      this._init()
    }
    return {_type:4}
  },
  _isInPlaying:function(){
    return _aiVisitHandler._queue.length
  },
  _handleAction:function(a){
    var aa=_aiVisitHandler._queue[0]
    a._supData=aa._supData
    a._orgData=aa._orgData
    a._inVisit=1
    if(!BZ._isAutoRunning()){
      _bzDomPicker._flashTmpCover(a.element)
    }
    _ideTask._data._taskQueue.unshift(a)
    return a
  },
  _doNext:function(a){
    var v=$project[a._key],_item=0,_steps=_Util._clone(a._steps);
    _searchItem("_bzTarget")
    var _bzTarget=_item
    _searchItem("_toggle")
    if(_item){
      this._putClickAction(a,_item,!_bzTarget)
    }else{
      _searchDeep("_bzTarget")
      if(!_item){
        _searchDeep("_toggle")
        if(_item){
          _aiVisitHandler._putClickAction(a,_item,1,1)
        }else{
          _aiVisitHandler._queue.shift()
          var q=_aiVisitHandler._queue[0]
          if(q){
            _aiVisitHandler._doNext(q)
          }
        }
      }else{
        _aiVisitHandler._putClickAction(a,_item,0,1)
      }
    }
    function _searchItem(kk){
      for(var k in v[kk]){
        o=v[kk][k]
        if(!o._done){
          if(!_item&&o._time==_aiVisitHandler._curTime){
            o._done=1
            _item=k
          }else if(o._time==_aiVisitHandler._curTime&&!o._path){
            o._path=_steps
          }
        }
      }
    }
    function _searchDeep(kk){
      for(var k in v[kk]){
        o=v[kk][k]
        if(!o._done){
          if(!_item){
            o._done=1
            _item=k
            return
          }
        }
      }
    }
  },
  //a: visit action
  //k: element key (quick path)
  _putClickAction:function(a,k,_toggle,_deep){
    this._putPickAction(a)
    if(!_toggle){
      if(a.plugin){
        _aiVisitHandler._handleAction({
          type:_ideActionData._type._ref,
          refOfSuccess:a.plugin+"/",
          successParameter:a.successParameter
        })
      }
      if(a.script){
        _aiVisitHandler._handleAction({
          type:_ideActionData._type._script,
          script:a.script
        })
      }
    }
    var o=$project[a._key][_toggle?'_toggle':'_bzTarget'][k]
    $project.curVisitItem=o
    var aa={
      type:_ideActionData._type._triggerEvent,
      element: [a.panel[0],k,0],
      event:{
        type: "mouse",
        action: "click",
      }
    }
    _aiVisitHandler._handleAction(aa)
    a._steps=_Util._clone(o._path||a._steps)
    if(_deep){
      for(var i=a._steps.length-1;i>=0;i--){
        _aiVisitHandler._handleAction({
          type:_ideActionData._type._triggerEvent,
          element: [a.panel[0],a._steps[i],0],
          event:{
            type: "mouse",
            action: "click",
          }
        })
      }
      _aiVisitHandler._handleAction({
        type:_ideActionData._type._refresh,
        loadURL:a._rootUrl
      })
    }
    a._steps.push(k)
  },
  _putPickAction:function(a){
    //put back visit action
    _aiVisitHandler._handleAction(a)
    this._curTime=Date.now()
    var _host=_Util._mergeURL(_IDE._data._setting.environments[_IDE._data._setting.curEnvironment||0].items[0].host,BZ._getCurTest()._data.enterPoint.value)
    _host=_host.split("/"+"/")[1].split("/")[0]
    var aa={
      min:1000,
      type:_ideActionData._type._script,
      script:"_aiVisitHandler._exePickItems("+JSON.stringify({_panel:a.panel,_toggle:a.toggle,_bzTarget:a.target,_key:a._key,_host:_host})+","+this._curTime+")"
    }
    _aiVisitHandler._handleAction(aa)
    if(a.panelToggle){
      var aa={
        type:_ideActionData._type._triggerEvent,
        element: [a.panel[0],a.panelToggle,0],
        event:{
          type: "mouse",
          action: "click",
        }
      }
      
      _aiVisitHandler._handleAction(aa)
    }
  },
  _exePickItems:function(a,t){
    if(!location.host.includes(a._host)){
      return
    }
    
    var p=$util.findDom(a._panel),
        ts,as,k,
        o=$project[a._key]=$project[a._key]||{_toggle:{},_bzTarget:{}};
    if(a._toggle){
      k="_toggle"
      Array.from($(p).find(a._toggle)).map(_doIt)
    }
    if(a._bzTarget){
      k="_bzTarget"
      Array.from($(p).find(a._bzTarget)).map(_doIt)
    }
    
    function _doIt(u){
      if(!_Util._isHidden(u)){
        var v=_Util._getQuickPath(u)
        var e=o[k][v]
        if(!e){
          e=o[k][v]={}
        }
        e._time=t
        e.text=$util.getElementText(u)
        e.href=u.href||0
        if(e.href.constructor==String&&e.href.startsWith("mailto")){
          e._done=1
        }
      }
    }
  }
};/*
word data constructor:
  W: word (plural)
  T: type
    1: o, operation name,
    2: f, function name,
    4: v, value, 
    8: m, module name,
    16: a, attribute name, 
    32: i, info,
    64: p, project name
    128: w, app word,
    0: 0, others
  P: from of appearance
    1: setting
    2: dictionary, 
    4: data, 
    8: input (change), 
    16: button/link (click),
    32: other
  L: level
    0, none
    1, label
    2, header
  IN: Include other words key
*/
var _aiWordHandler={
  /************************************************************************************************
  //
  //  o: operation name, 
  //  f: function name, 
  //  v: value, 
  //  m: module name, 
  //  a: attribute name, 
  //  i: info, 
  //  p: project name,
  //  w: app-word
  //  0: others,
  //
  ************************************************************************************************/
  _typeValue:{o:1, f:2, v:4, m:8, a:16, i:32,p:64,w:128},
  _fromValue:{
    _setting:1,
    _dictionary:2,
    _data:4,
    _input:8,
    _button:16,
    _other:32
  },
  _codeMap:{},
  _wordMap:{},
  _pluralMap:{},
  _noTypeWords:[],
  _typeWords:[],
  _getOrgWord:function(w,_inCapital){
    w=_aiWordHandler._pluralMap[w]||w
    if(_inCapital){
      w=_Util._toCapitalWord(w)
    }
    return w;
  },
  _preFix:function(w){
    if(!w){
      return
    }
    w=w.toLowerCase();
    w.split(" ").forEach(function(v){
      v=v.trim();
      if(v){
        var vv=v.plural().toString();
        if(v!=vv){
          _aiWordHandler._pluralMap[v]=vv;
        }
      }
    })
    var v= w.plural().toString()
    if(v!=w){
      _aiWordHandler._pluralMap[v]=w;
    }
    return v;
  },
  /*****************************************************
  //EXTRA: For data/attribute/module-name to retrieve from which module/test
  ******************************************************/
  _registerWord:function(w,_type,_from,_level,_extra){
    if(!w || w.length==1){
      return
    }
    var pw=_aiWordHandler._findWordDefine(w)
    if(pw&&pw.W){
      if(_extra&&_extra.code){
        pw.W.EXTRA=pw.W.EXTRA||[]
        for(var i=0;i<pw.W.EXTRA.length;i++){
          if(pw.W.EXTRA[i].code){
            _extra.code=pw.W.EXTRA[i].code
            return
          }
        }
        pw.W.EXTRA.push(_extra)
        _aiWordHandler._codeMap[_extra.code]={_word:w,_type:_type,_extra:_extra}
      }
      return
    }
    if(_extra&&_extra.code){
      _aiWordHandler._codeMap[_extra.code]={_word:w,_type:_type,_extra:_extra}
    }
    w=_aiWordHandler._preFix(w);
    
    _type=_aiWordHandler._typeValue[_type];
    var o=this._wordMap[w];
    if(!o){
      o={W:w,T:_type,P:_from,L:_level||0,IN:[]};
      if(_extra){
        o.EXTRA=[_extra]
      }
      this._wordMap[w]=o
      if(_type){
        _aiWordHandler._typeWords.push(o);
        //for assign type to no-type-word
        _aiWordHandler._matchInclude(_aiWordHandler._noTypeWords,o,false)
      }else{
        _aiWordHandler._noTypeWords.push(o);
        _aiWordHandler._matchInclude(_aiWordHandler._typeWords,o,true);
        _aiWordHandler._matchInclude(_aiWordHandler._noTypeWords,o,true);
      }
    }else if(_type!=o.T){
      if(!o.T){
        if(_extra){
          o.EXTRA=o.EXTRA||[]
          o.EXTRA.push(_extra)
        }
        _aiWordHandler._noTypeWords.splice(_aiWordHandler._noTypeWords.indexOf(o),1);
        _aiWordHandler._typeWords.push(o);

        _aiWordHandler._matchInclude(_aiWordHandler._noTypeWords,o,false)
      }
      o.T|=_type
    }else if(!o.EXTRA && _extra){
      o.EXTRA=[_extra];
    }
    
    o.P|=_from;
    o.L|=_level;

    return o;
  },
  _getDataByCode:function(c){
    return _aiWordHandler._codeMap[c]
  },
  _findKeyWordInWords:function(w){
    if(!w){
      return
    }
    w=_aiWordHandler._preFix(w);
    
    var o=this._wordMap[w],tw=0;
    if(!o){
      o={W:w,IN:[]};
      _aiWordHandler._matchInclude(_aiWordHandler._typeWords,o,true);
    }
    if(o && !o.WW && o.IN.length){
      var ww=new RegExp(o.IN.toString().replace(/,/g,"|"));
      ww=o.W.split(ww);
      var _best="";
      ww.forEach(function(v){
        v=v.trim();
        v=_dictionaryHandler._removeIgnoreWords(v)
        if(v.length>_best.length){
          _best=v;
        }
      })
      
      o.WW=_best; //set extra value
      o._dicType=o.T||0;
      if(!o._dicType){
        for(var i=0;i<o.IN.length;i++){
          tw=_aiWordHandler._findKeyWordInWords(o.IN[i]);
          if(!o._dicDefine && tw){
            o._dicType|=tw?tw.T||0:0;
            o._dicDefine=tw._dicDefine;
            o.EXTRA=tw.EXTRA
          }else if(tw){
            if(!o._dicDefine){
              if(tw._dicDefine){
                o._dicType|=tw?tw.T||0:0;
                o._dicDefine=tw._dicDefine;
              }else if(tw.EXTRA && !(o._dicType&8 || o._dicType&64) && (tw.T==8 || tw.T==64)){
                o._dicType|=tw?tw.T||0:0;
                o._dicDefine=tw._dicDefine;
                o.EXTRA=tw.EXTRA
              }
            }
          }
          if((!o.EXTRA && !o._dicDefine) || !tw || !(tw.T&tw.T&_aiWordHandler._typeValue.o)){
            if(!o.WW){
              o.WW=o.IN[i]
            }
          }
        }
      }else{
        o._dicDefine=_dictionaryHandler._findWordDefine(o.W);
      }
    }
    if(!o._dicDefine && o.T){
      o._dicDefine=_dictionaryHandler._findWordDefine(o.W)
    }
    return o;
  },
  _findWordDefine:function(w){
    w=_aiWordHandler._wordMap[_aiWordHandler._preFix(w)]
    var ws=[];
    if(w && w.IN.length){
      w.IN.forEach(function(v){
        ws.push(_aiWordHandler._wordMap[v])
      });
    }
    return {W:w,IN:ws};
  },
  _isLookingWord:function(w,_type,_keys){
    if(!w){
      return;
    }
    w=_aiWordHandler._preFix(w);
    if(_type && _type.constructor==Array){
      for(var i=0;i<_type.length;i++){
        var t=this._isLookingWord(w,_type[i],_keys);
        if(t){
          return t
        }
      }
      return 
    }
    var ww=this._wordMap[w];
    if(!ww){
      ww=_aiWordHandler._findKeyWordInWords(w).IN
      if(ww){
        var www=0,_best;
        for(var i=0;i<ww.length;i++){
          if(!_best || _best.length<ww[i].length){
            var v=_aiWordHandler._isLookingWord(ww[i],_type);
            if(v){
              www=v;
            }
          }
        }
        return www;
      }
    }
    w=ww;
    if(w){
      if(!_type){
        return _keys.includes(w.W);
      }
      if(w.T & _aiWordHandler._typeValue[_type]){
        if(!_keys){
          return w;
        }
        var d=_dictionaryHandler._wordMap[_aiWordHandler._preFix(w.W)];
        if(d){
          var ks=d._key;
          if(d._key.constructor==String){
            ks=[d._key]
          }
          for(var i=0;i<ks.length;i++){
            if(_keys.includes(ks[i])){
              return ks[i]
            }
          }
        }
      }
      if(w.IN){
        for(var i=0;i<w.IN.length;i++){
          var t=_aiWordHandler._isLookingWord(w.IN[i],_type,_keys);
          if(t){
            return t;
          }
        }
      }
    }
  },
  _findWordByExtra:function(e){
    var s=""
    for(var k in _aiWordHandler._wordMap){
      var ws=_aiWordHandler._wordMap[k].EXTRA
      if(ws){
        for(var i=0;i<ws.length;i++){
          var w=ws[i]
          if(w.tt==e.tt && w.m==e.m && w.t==e.t){
            s+="|"+_aiWordHandler._getOrgWord(k)
          }else if(w.code==e){
            s+="|"+_aiWordHandler._getOrgWord(k)
            break
          }
        }
      }
    }
    
    return s.substring(1)
  },
  _findDataInWords:function(w){
    let ww=_aiWordHandler._findKeyWordInWords(w)
    if(ww.EXTRA){
      return ww.EXTRA
    }else if(ww.WW){
      return _aiWordHandler._findDataInWords(ww.WW)
    }
  },
  _getMatchWords:function(w){
    var ws=w.split(/[^a-z0-9\u4E00-\u9FCC]/gi)
    //Chinese
    if(ws && BZ._data._curProject.language=="cn"){
      //pick all chinese
      var ss=w.match(/[\u4E00-\u9FCC]/g);
      if(ss && ws && ss.length==ws.length){
        return [w.replace(/\s/g,"")]
      }
    }
    for(var i=0;i<ws.length;i++){
      if(!ws[i]){
        ws.splice(i--,1)
      }
    }
    return ws
  },
  //g: word group (type/notype), 
  //o: new word
  //b: flag, for switch compare between 2 words length
  _matchInclude:function(g,o,b){
    g.forEach(function(v,i){
      if(v.W==o.W){
        return;
      }
      var B=v.W.length<o.W.length;
      if(B==b){
        var ch=o.W,ws=v.W,n,w;
        if(!b){
          ch=v.W;
          ws=o.W;
        }
        ws=_aiWordHandler._getMatchWords(ws)
        if(!ws.length){
          return
        }
        for(var i=0;i<ws.length;i++){
          w=ws[i];
          if(w){
            if(_aiWordHandler._includes(ch,w)){
              ch=_aiWordHandler._replace(ch,w)
            }else{
              return;
            }
          }
        }

        if(b){
          if(v.W){
            o.IN.push(v.W)
          }
        }else{
          if(o.W){
            v.IN.push(o.W)
          }
        }
      }
    })
  },
  _registerFromAction:function(_action){
    var w,hs,e,r={H:""};
    if(e=_action.element){
      if(!_action.css){
        _action.css=_descAnalysis._getAICssData(0,e)
      }
      if(hs=_action.css.HH){
        for(var i=0;i<hs.length;i++){
          w=_descAnalysis._retrieveTextForElementPathItem(e[hs[i].id])
          r.H+="|"+w.replace(/\|/g," ")
          _aiWordHandler._registerWord(w,0,32,2)
        }
      }
      if(_action.css.LL){
        r.L=w=_descAnalysis._retrieveTextForElementPathItem(e[_action.css.LL.id])
        _aiWordHandler._registerWord(w,0,!_action.event?32:_action.event.type=="mouse"?16:8,1);
      }
      if(_action.type==1 && _action.event && _action.event.type=="change"){
        //8: input
        var m=BZ._getCurModule(),t=BZ._getCurTest();
        
        _aiWordHandler._registerWord(_action.event.value,"v",8,0,{m:m.code,t:t.code});
      }
      if(r.H){
        r.H=r.H.substring(1)
      }
      return r
    }
  },
  //Replace word in element path by parameter
  _replaceElementPathInParameter:function(ep,w,p){
    for(var i=ep.length-1;i>=0;i--){
      var v=ep[i]
      if(v.includes && v.includes("("+w+")")){
        ep[i]=v.replace("("+w+")","("+p+")")
        break;
      }else if(v.includes && v.includes('"'+w+'"')){
        ep[i]=v.replace('"'+w+'"','"'+p+'"');
        break;
      }
    }
    return ep;
  },
  _includes:function(w,v){
    if(BZ._data._curProject.language=="cn"){
      return w.includes(v)
    }else{
      return w.match("(^| )"+v+"( |$)")
    }
  },
  _replace:function(w,v){
    if(BZ._data._curProject.language=="cn"){
      return w.replace(w,v)
    }else{
      return w.replace("(^| )"+v+"( |$)")
    }
  },
  _replaceAll:function(w,v){
    var ww=_aiWordHandler._replace(w,v);
    while(ww!=w){
      w=ww;
      ww=_aiWordHandler._replace(w,v);
    }
    return ww;
  },
  _isSamilarWords:function(w,v){
    return w.includes(v) || v.includes(w)
  },
  _analysisElementType:function(_action){
    var c=_action.css,w;
    if(c){
      var hs=c.HH||[];
      for(var i=0;i<hs.length;i++){
        w=_descAnalysis._retrieveTextForElementPathItem(_action.element[hs[i].id])
        hs[i].WT=[]
        _doWord(w,hs[i].WT)
        if(!hs[i].WT.length){
          delete hs[i].WT
        }
      }

      if(c.LL && Object.keys(c.LL).length){
        c.LL.WT=[];
        w=_descAnalysis._retrieveTextForElementPathItem(_action.element[c.LL.id])
        _doWord(w,c.LL.WT)
        _doCss(c.LL.C.css,c.LL.WT)
        _doCss(c.LL.C.subCss,c.LL.WT)
        if(!c.LL.WT.length){
          delete c.LL.WT
        }
      }
    }
    function _doWord(w,ws){
      if(!w){
        return
      }
      var _orgWord=w;
      w=_aiWordHandler._findKeyWordInWords(w);
      var o={}
      if(w._dicDefine){
        o.DD={T:w._dicDefine._type,K:w._dicDefine._key}
      }
      if(w.EXTRA){
        o.EXTRA=w.EXTRA
      }
      if(o.DD || o.EXTRA){
        var os=JSON.stringify(o),_found;
        
        for(var i=0;i<ws.length;i++){
          if(JSON.stringify(ws[i])==os){
            _found=1
            break
          }
        }
        if(!_found){
          ws.push(o)
        }
      }
      if(w.WW && w.WW!=_orgWord){
        _doWord(w.WW,ws)
      }
    }
    function _doCss(cs,ws){
      var ts=[]
      for(var i=0;cs && i<cs.length;i++){
        var cc=cs[i]
        if(cc=_cssHandler._cssMap["."+cc]){
          for(var k in cc){
            k=k.split("/")[0]
            var t=_cssHandler._keyMap[k]._type;
            if(t!="element"){
              _doWord(k,ws)
            }
          }
        }else if(!ws.length){
          cc=_glossaryHandler._splitWord(cs[i])
          cc.forEach(function(v){
            var o=_cssHandler._keyMap[v]
            if(!o || !o._css){
              _doWord(v,ts)
            }
          })
        }
      }
      if(!ws.length && ts.length){
        ts.forEach(function(v){
          ws.push(v)
        })
      }
    }
  },
  _analysisAction:function(v){
    _aiWordHandler._registerFromAction(v)
    _aiWordHandler._analysisElementType(v)
  },
  _analysisTest:function(t){
    t.actions.forEach(function(v){
      _aiWordHandler._analysisAction(v)
    })
  },
  _getRegexByWord:function(w){
    w=_aiWordHandler._findKeyWordInWords(w)._dicDefine
    if(w){
      w=w._key
      if(w.constructor==Array){
        w=w[0]
      }
      w="/BZ-"+w+"/"
    }
    return w||"/[a-z]+/"
  }
};var _cssHandler={
  _cssMap:{},
  _maxTextLength:100,
  _findElementKey:function(e){
    let p=_cssHandler._findPath(e)
    return _descAnalysis._retrieveTextForElementPathItem(p)
  },
  _priorityItems:[],
  /*
  _cssMap={
    "input[type=checkbox]":{
      _names:["BUTTON"],
      _items:["INPUT","[type=checkbox]"]
    }
  },
  _nameMap:{
    //item link to _cssMap
    "button":{
      _css:["BUTTON",".btn","INPUT[type=button]","INPUT[type=submit]","INPUT[type=reset]"],
      _key:"XXX"
    }
  },
  _keyMap:{
    "24234234":{
      _name:"button",
      _css:"BUTTON,.btn,INPUT[type=button],INPUT[type=submit],INPUT[type=reset]"
    }
  }
  */
  _init:function(){
    _cssHandler._cssMap={};
    _cssHandler._nameMap={};
    _cssHandler._keyMap={};
    _cssHandler._inputCss="";
    
    var _duplidates={};
    var os=_IDE._data._curVersion.setting.objectLib,_found;
    os.component.forEach(function(o){
      o.items.forEach(function(v){
        for(var i=0;i<os.element.length;i++){
          var vv=os.element[i]
          if(vv.key==v.name){
            var c=(v.toggle||v.panel||[]).join(" ")
            if(!vv.css.includes(c)){
              vv.css+=","+c
            }
            _found=1
            break
          }
        }
        if(!_found&&v.panel){
          os.element.push({key:v.name,value:v.name,css:(v.toggle||v.panel).join(" "),component:1,data:v,hide:1})
        }
      })
    })
    for(var k in os){
      if(k=="component"){
        continue
      }
      var es=os[k]
      for(var i=0;i<es.length;i++){
        var e=es[i];
        if(k=="operation"){
          e.value=_dictionaryHandler._getWordsByKey(e.key).join("/")
        }else if(!e.value){
          e.value=_bzMessage._setting._objectLib._options[k][e.key];
          if(!e.value){
            continue
          }
        }
        var v=e.value.toLowerCase();
        var vs=v.split("/");
        var cs=this._parseGroup(e.css);
        this._keyMap[e.key]={_name:vs,_css:e.css,_type:k};
        
        vs.forEach(function(a){
          var vm=_cssHandler._nameMap[a];
          if(vm){
            _duplidates[a]=_duplidates[a]||[vm._css];
//            _duplidates[a].push(cs);
          }else{
            _cssHandler._nameMap[a]={_css:cs,_key:e.key};
          }
        });
        
        cs.forEach(function(a){
          if(!a){
            return;
          }
          var x=a.match(/^[a-z]+/i);
          if(x){
            x=x[0].toUpperCase()
            a=x+a.substring(x.length);
          }
          a=_cssHandler._parseItems(a);
          
          for(var ii=0;ii<a.length;ii++){
            var vv=_cssHandler._cssMap[a[ii]];
            if(!vv){
              vv=_cssHandler._cssMap[a[ii]]={};
            }
            if(!vv[v]){
              vv[v]={_names:vs,_items:[],_same:cs.length}
            }
            vv[v]._items.push({_item:a,_size:a.length});
          }
        });
      }
    }
    if(Object.keys(_duplidates).length){
      var _msg=_bzMessage._setting._objectLib._duplicateKey+"\n\n";
      for(var k in _duplidates){
        _msg+=k+": "+_duplidates[k].toString().replace(/,/g,", ")+"\n\n";
      }
      return alert(_msg);
    }
    //ignore class
    this._ignoreClasses=_IDE._data._curVersion.setting.content.ignoreClasses.replace(/\s/g,"").replace(/,/g,"|");
    return 1;
  },
  _isDuplicateCssKey:function(k){
    var os=_IDE._data._curVersion.setting.objectLib.element;
    for(var i=0;i<os.length;i++){
      if(os[i].key==k){
        return 1
      }
    }
  },
/*
  _addCss:function(d,v){
    if(d){
      d=new Set(d.split(","))
    }else{
      d=new Set()
    }
    d.add(v)
    return [...d].join(",")
  },
  _removeCss:function(d,v){
    d=new Set(d.split(","))
    d.delete(v)
    return [...d].join(",")
  },
  _replaceCss:function(d,v,nv){
    d=new Set(d.split(","))
    d.delete(v)
    d.add(nv)
    return [...d].join(",")
  },
  */
  _hasWaitingElement:function(){
    var c=_cssHandler._keyMap.waiting
    if(c&&c._css){
      var os=$(c._css).toArray()
      for(var i=0;i<os.length;i++){
        if(!_Util._isHidden(os[i])){
          if(!BZ._isAutoRunning()){
            _bzDomPicker._removeTmpCover()
            setTimeout(function(){
              _bzDomPicker._flashTmpCover(os[i])
            },1)
          }
          return 1
        }
      }
    }
  },
  /**/
  //t: element type, _noText: not include contain css
  _selectForUI:function(t,w,_includesText,_fun){
    BZ._data._uiSwitch._tmpCssOptions=[]
    _Util._confirmMessage({
      _tag:"div",
      _items:[
        {
          _tag:"div",
          _attr:{"class":"input-group"},
          _items:[
            {
              _tag:"input",
              _attr:{
                "class":"form-control bz-definition-css",
                value:function(){
                  return BZ._data._uiSwitch._tmpCssOptions.map((v)=>{return v._key}).join("")||w
                }
              }
            },
            {
              _tag:"div",
              _attr:{"class":"input-group-btn"},
              _items:[
                {
                  _tag:"button",_attr:{"class":"btn btn-icon bz-small-btn bz-dompicker pull-right"},
                  _jqext:{
                    click:function(){
                      _bzDomPicker._pickDetails(0,function(p){
                        if(!_includesText){
                          var v=p.pop()
                          if(!v._css.includes(":Contains")&&!v._css.includes(":endContains")&&!v._css.includes(":near")){
                            p.push(v)
                          }
                        }
                        BZ._data._uiSwitch._tmpCssOptions=p;
                        
                        setTimeout("_Util._resizeModelWindow()",1)
                      })
                    }
                  }
                }
              ]
            }
          ]
        },
        {
          _tag:"label",_attr:{style:"display:table;margin:5px;"},
          _items:[
            {
              _tag:"input",
              _dataModel:"_data._item._key",
              _attr:{type:"checkbox",value:"_data._item._css","class":"bz-select-css"}
            },
            {_text:"_data._item._css"},
          ],
          _dataRepeat:"BZ._data._uiSwitch._tmpCssOptions"
        },
      ]
    },[{
      _title:_bzMessage._common._ok,
      _click:function(c){
        var v=$(".bz-definition-css").val();
        if(!v){
          return alert(_bzMessage._system._error._requiredField,"CSS "+_bzMessage._common._value)
        }
        _fun(v)
        c._ctrl._close()
      }
    }],_Util._formatMessage(_bzMessage._setting._objectLib._identifyCss,[t]));
    
    
    function _getSelectCss(vs){
      var w=""
      for(var i=0;i<vs.length;i++){
        if(vs[i]._key){
          w+=vs[i]._key||""
        }
      }
      return w
    }
  },
/*  */
  _setCurPanel:function(v){
    if(bzTwComm._isIDE()){
      _extensionComm._setShareData({"_cssHandler._curPanel":v})
    }else{
      _cssHandler._curPanel=v
    }
  },
  _isNatureCustomizeInput:function(e){
    return (e.tagName=="INPUT"&&(e.type=="text"&&($(e).css("opacity")==0||$(e).css("visibility")=="hidden"))||["submit","button","image"].includes(e.type))
          ||(!_Util._isInContentEditable(e)&&(!_Util._isStdInputElement(e)||$(e).attr("readonly"))&&!_cssHandler._isDefinitedCustomizeInput(e))
  },
  _isDefinitedCustomizeInput:function(e){
    var os=_cssHandler._getCustomizeInputs();
    for(var i=0;i<os.length;i++){
      var o=os[i]
      if(o=_cssHandler._keyMap[o.name]){
        if($(e).is(o._css)){
          return 1
        }
      }
    }
  },
  _getCustomizeInputs:function(){
    let os=[]
    var ss=_IDE._data._curVersion.setting.objectLib.component
    for(var i=0;i<ss.length;i++){
      var s=ss[i]
      if(["dropdownInput","rangeSlider"].includes(s.key)){
        os=os.concat(s.items)
      }
    }
    return os
  },
  _isOnCustomizePanel:function(e){
    var s=_cssHandler._getCustomizeInputs()
    for(var i=0;i<s.length;i++){
      var v=s[i]
      if(v.panel){
        if($(v.panel.join(" ")).find(e).length){
          return 1
        }
      }
    }
  },
  _getComponeDefinitionSetting:function(_type){
    let _setting=[{_text:"_panel",_value:"panel",_required:1}]
    if(["dropdownInput","menu"].includes(_type)){
      _setting.unshift({_text:"_value",_value:"value",_required:1})
      _setting.unshift({_text:"_toggle",_value:"toggle",_required:1})
    }
    if(["dropdownInput"].includes(_type)){
      _setting.push({_text:"_clear",_value:"clear",_required:0})
    }
    if(["container","popWindow","table","list"].includes(_type)){
      _setting.push(
        {_text:"_objTitle",_value:"title"},
        {_text:"_ctrlPanel",_value:"ctrlPanel"}
      )
    }
    if(_type=="table"){
      _setting.push(
        {_text:"_header",_value:"header"},
        {_text:"_row",_value:"row",_required:1},
        {_text:"_col",_value:"col",_required:1},
        {_text:"_paging",_value:"paging"}
      )
    }else if(["list","navigator","path","menu","tab"].includes(_type)){
      _setting.push({_text:"_item",_value:"item",_required:1})
      if(_type=="tab"){
        _setting.push({_text:"_content",_value:"content",_required:1})
      }
    }
    return _setting
  },
  _getInitCustomizeSetting:function(_type){
    let o={type:_type,steps:[],name:_bzMessage._setting._objectLib._options.component[_type]};
    if(_type=="table"){
      Object.assign(o,{
        row:["tr"],col:["td"],header:["thead"],title:["caption"]
      })
    }else if(["dropdownInput","rangeSlider"].includes(_type)){
      o.input=1
      if(_type=="dropdownInput"){
        o.clear=[".close|.remove|.clear|.clean|.cross"]
        o.format="$1"
      }
    }
    return o;
  },
  /**/
  _newCustomize:function(_type){
    BZ._data._uiSwitch.cc=_cssHandler._getInitCustomizeSetting(_type)
    _Util._confirmMessage({
      _tag:"div",
      _attr:{"class":"input-group"},
      _items:[
        {
          _tag:"label",
          _attr:{"class":"input-group-addon"},
          _text:"_bzMessage._common._name"
        },
        {
          _tag:"input",
          _attr:{"class":"form-control bz-key-input"},
          _dataModel:"BZ._data._uiSwitch.cc.name"
        }
      ]
    },[{
      _title:_bzMessage._common._ok,
      _click:function(c){
        let cc=BZ._data._uiSwitch.cc,
            _list=_IDE._data._setting.objectLib.component.find(v=>{return v.key==_type}).items
        
        if(!cc.name){
          return alert(_bzMessage._system._error._requiredField,_bzMessage._common._name)
        }
        _list.push(cc)
        _ideVersionManagement._autoSave(function(){
          cc=_list.find(v=>{
            return v.name==cc.name
          })
          if(cc){
            _extensionComm._setShareData({"_IDE._data._curVersion.setting.objectLib.component":_IDE._data._curVersion.setting.objectLib.component})
            _cssHandler._openCustomize(cc,_type,_list)
          }
        })
        c._ctrl._close()
      }
    }])
  },
  _openCustomize:function(_curData,_type,_items){
    if(!BZ.TW||BZ.TW.closed){
      BZ._launchCurEnvUrl(0)
    }
    BZ._data._uiSwitch.cc=_curData

    BZ._data._uiSwitch._showDefCssSource=0
    let _setting=_cssHandler._getComponeDefinitionSetting(_type);
    
    _Util._confirmMessage(
      {
        _tag:"div",
        _update:function(){
          _ideVersionManagement._autoSave(function(){
            _extensionComm._setShareData({"_IDE._data._curVersion.setting.objectLib.component":_IDE._data._curVersion.setting.objectLib.component})
          })
        },
        _items:[
          {
            _tag:"label",
            _attr:{style:"position: absolute;right: 20px;margin-top: -40px;"},
            _items:[
              {
                _tag:"input",
                _attr:{type:"checkbox"},
                _noUpdate:1,
                _dataModel:"BZ._data._uiSwitch._showDefCssSource"
              },
              {_text:"_bzMessage._setting._objectLib[BZ._data._uiSwitch._showDefCssSource?'_showSource':'_showDefUI']"}
            ]
          },
          {
            _if:"BZ._data._uiSwitch._showDefCssSource",
            _tag:"textarea",
            _noUpdate:1,
            _attr:{
              "class":"bz-editor",
              spellcheck:false,
              style:function(){
                return "height:"+$(".bz-modal-body pre")[0].getBoundingClientRect().height+"px"
              },
              onfocus:"this.select()"
            },
            _dataModel:"BZ._data._uiSwitch.cc",
            _formatSet:function(v){
              try{
                return JSON.parse(v)
              }catch(e){
                alert(_bzMessage._system._error._dataFormat)
              }
            },
            _formatGet:function(v){
              return JSON.stringify(v,0,2)
            }
          },
          {
            _if:"!BZ._data._uiSwitch._showDefCssSource",
            _tag:"div",
            _items:[
              //Name
              {
                _tag:"div",_attr:{"class":"input-group"},
                _items:[
                  {
                    _tag:"div",_attr:{"class":"input-group-addon"},
                    _items:[
                      {
                        _tag:"label",
                        _required:1,
                        _text:"_bzMessage._common._name"
                      }
                    ]
                  },
                  {
                    _tag:"input",_attr:{"class":"form-control",disabled:_curData},
                    _required:1,
                    _dataModel:"BZ._data._uiSwitch.cc.name"
                  }
                ]
              },
              //Toggle & Panel
              {
                _tag:"div",
                _items:[
                  {
                    _if:"['_toggle'].includes(_data._item._text)",
                    _tag:"fieldset",
                    _items:[
                      {
                        _tag:"legend",
                        _required:"_data._item._required",
                        _text:"_bzMessage._setting._objectLib[_data._item._text]"
                      },
                      {
                        _tag:"div",_attr:{"class":"input-group"},
                        _items:[
                          {
                            _tag:"div",_attr:{"class":"input-group-addon"},
                            _items:[
                              {
                                _tag:"label",
                                _required:"_data._item._required",
                                _text:"_bzMessage._setting._objectLib._path"
                              }
                            ]
                          },
                          {
                            _tag:"input",_attr:{"class":"form-control"},
                            _required:"_data._item._required",
                            _dataModel:"BZ._data._uiSwitch.cc[_data._item._value]",
                            _jqext:{
                              focus:function(){
                                var c=BZ._data._uiSwitch.cc
                                let v=_Util._clone(c[this._data._item._value])
                                v.forEach((w,i)=>{
                                  v[i]=w.replace("$label",c.$label).replace("$header",c.$header)
                                })
                                
                                _bzDomPicker._flashTmpCover([c.tmpTW].concat(v).concat(0))
                              }
                            },
                            _formatGet:function(d){
                              return d?d.join(" "):""
                            },
                            _formatSet:function(d){
                              return _cssHandler._parseElementPath(d)
                            }
                          },
                          {
                            _tag:"div",_attr:{"class":"input-group-btn"},
                            _items:[
                              {
                                _tag:"button",
                                _attr:{
                                  "class":"btn btn-icon bz-small-btn bz-dompicker"
                                },
                                _jqext:{
                                  click:function(){
                                    var c=BZ._data._uiSwitch.cc,_this=this
                                    
                                    var _this=this
                                    _bzDomPicker._pickElement({_path:0,_simple:1},function(p){
                                      _bzDomPicker._pickElement({_path:p},function(p){
                                        c.tmpTW=p.shift()
                                        p.pop()
                                        
                                        p.reverse()
                                        let _header,_label
                                        p.forEach((v,i)=>{
                                          if(!c.$label){
                                            c.$label=_descAnalysis._retrieveTextForElementPathItem(v)
                                            if(c.$label){
                                              p[i]=v.replace(c.$label,"$label")
                                            }
                                          }else{
                                            c.$header=_descAnalysis._retrieveTextForElementPathItem(v)
                                            if(c.$header){
                                              p[i]=v.replace(c.$header,"$header")
                                            }
                                          }
                                        })
                                        c.toggle=p.reverse()
                                      })
                                    })
                                  }
                                }
                              }
                            ]
                          }
                        ]
                      },
                      //Header, Label
                      {
                        _tag:"div",
                        _attr:{"class":"input-group"},
                        _items:[
                          {
                            _tag:"label",
                            _attr:{"class":"input-group-addon"},
                            _text:"_bzMessage._root._attributeMap._example"
                          },
                          {
                            _tag:"label",
                            _attr:{"class":"input-group-addon"},
                            _text:"$header"
                          },
                          {
                            _tag:"input",
                            _attr:{"class":"form-control"},
                            _dataModel:"BZ._data._uiSwitch.cc.$header",
                          },
                          {
                            _tag:"label",
                            _attr:{"class":"input-group-addon"},
                            _text:"$label"
                          },
                          {
                            _tag:"input",
                            _attr:{"class":"form-control"},
                            _dataModel:"BZ._data._uiSwitch.cc.$label",
                          }
                        ]
                      },
                    ]
                  },
                  {
                    _if:"!['_toggle'].includes(_data._item._text)",
                    _tag:"div",
                    _items:[
                      {
                        _tag:"div",_attr:{"class":"input-group"},
                        _items:[
                          {
                            _tag:"div",_attr:{"class":"input-group-addon"},
                            _items:[
                              {
                                _tag:"label",
                                _required:"_data._item._required",
                                _text:"_bzMessage._setting._objectLib[_data._item._text]"
                              }
                            ]
                          },
                          {
                            _tag:"input",_attr:{"class":"form-control"},
                            _required:"_data._item._required",
                            _dataModel:"BZ._data._uiSwitch.cc[_data._item._value]",
                            _jqext:{
                              focus:function(){
                                var c=BZ._data._uiSwitch.cc
                                
                                _bzDomPicker._flashTmpCover([c.tmpTW].concat(c[this._data._item._value]).concat(0))
                              }
                            },
                            _formatGet:function(d){
                              return d?d.join(" "):""
                            },
                            _formatSet:function(d){
                              return _cssHandler._parseElementPath(d)
                            }
                          },
                          {
                            _tag:"div",_attr:{"class":"input-group-btn"},
                            _items:[
                              {
                                _tag:"button",
                                _attr:{
                                  "class":"btn btn-icon bz-small-btn bz-dompicker"
                                },
                                _jqext:{
                                  click:function(){
                                    var c=BZ._data._uiSwitch.cc,_this=this
                                    
                                    if(c.toggle&&["dropdownInput","menu"].includes(_type)&&this._data._item._value=="panel"){
                                      _triggerToggle(c)
                                    }
                                    
                                    var _this=this
                                    _bzDomPicker._pickElement({_noText:1,_path:0,_simple:1},function(p){
                                      _bzDomPicker._pickElement({_path:p,_noText:1},function(p){
                                        c.tmpTW=p.shift()
                                        p.pop()
                                        
                                        c[_this._data._item._value]=p
                                        if(c.panel){
                                          _cssHandler._setCurPanel(c.panel.join(" "))
                                          _ideTask._triggerTmpClickAction(["BZ.TW.document","BODY",0]);
                                        }
                                      })
                                    })
                                  }
                                }
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ],
                _dataRepeat:_setting
              },
              //Value Format & Record/Stop & Steps
              {
                _if:function(d){
                  return ['dropdownInput','rangeSlider'].includes(_type)
                },
                _tag:"div",
                _items:[
                  //Value Format
                  {
                    _tag:"label",_attr:{"class":"col-xs-12"},
                    _items:[
                      {
                        _text:"_bzMessage._setting._objectLib._valueFormat"
                      },
                      {
                        _tag:"input",
                        _attr:{
                          "class":"form-control",
                          placeholder:"_bzMessage._setting._objectLib._valueFormatDesc",
                          style:"font-family: courier;"
                        },
                        _dataModel:"BZ._data._uiSwitch.cc.format"
                      }
                    ]
                  },
                  //extract data/record
                  {
                    _tag:"div",_attr:{"class":"col-xs-12"},
                    _items:[
                      {
                        _if:"!BZ._isRecording()",
                        _tag:"button",
                        _attr:{
                          "class":"btn btn-secondary bz-record btn-icon-text"
                        },
                        _jqext:{
                          click:function(){
                            var c=BZ._data._uiSwitch.cc;
                            if(!c.panel){
                              return alert(_bzMessage._setting._objectLib._missPanel)
                            }else if(!c.format){
                              return alert(_bzMessage._setting._objectLib._missFormat)
                            }else if(c.toggle&&c.toggle!=c.panel){
                              return _triggerToggle(c,function(){
                                _doIt()
                              })
                            }
                            _doIt()
                            function _doIt(){
                              _ideRecorder._start(function(p){
                                let cc=BZ._data._uiSwitch.cc
                                cc.tmpTW=p.element.shift();
                                while(1){
                                  let v=p.element.shift();
                                  if(!cc.panel.includes(v)){
                                    p.element.unshift(v)
                                    break
                                  }
                                }
                                delete p._tmpUrl
                                var f=c.format
                                if(f){
                                  if(f!="$1"){
                                    f=_cssHandler._getValiableParameterBySteps(f,c.steps)
                                  }
                                  if(f){
                                    if(p.event.type=="change"){
                                      if(f){
                                        p.event.value=f
                                      }
                                    }else{
                                      for(var i=p.element.length-1;i>=0;i--){
                                        var v=p.element[i]
                                        var vv=_descAnalysis._retrieveTextForElementPathItem(v)
                                        if(vv){
                                          v=v.replace(vv,f)
                                          p.element[i]=v
                                          break
                                        }
                                      }
                                    }
                                  }
                                }
                                c.steps.push(p)
                                
                                setTimeout("_Util._resizeModelWindow()",1)
                              })
                            }
                          }
                        },
                        _text:"_bzMessage._setting._objectLib._recordSteps"
                      },
                      {
                        _if:function(){
                          return BZ._isRecording()
                        },
                        _tag:"button",
                        _attr:{
                          "class":"btn btn-secondary bz-stop btn-icon-text"
                        },
                        _jqext:{
                          click:function(){
                            _ideRecorder._end()
                            _ideVersionManagement._autoSave(function(){
                              _extensionComm._setShareData({"_IDE._data._curVersion.setting.objectLib.component":_IDE._data._curVersion.setting.objectLib.component})
                            })
                          }
                        },
                        _text:"_bzMessage._method._stop"
                      },
                      {
                        _tag:"button",
                        _attr:{
                          "class":"btn btn-icon bz-small-btn bz-extract pull-right"
                        },
                        _jqext:{
                          click:function(){
                            var c=BZ._data._uiSwitch.cc;
                            if(!c.panel){
                              return alert(_bzMessage._setting._objectLib._missPanel)
                            }else if(c.toggle&&c.toggle!=c.panel){
                              return _ideTask._triggerTmpClickAction([c.tmpTW].concat(BZ._data._uiSwitch.cc.toggle).concat([0]),1,function(){
                                setTimeout(function(){
                                  _doIt()
                                },100)
                              });
                            }
                            var _this=this
                            _bzDomPicker._pickElement(0,function(p){
                              _bzDomPicker._pickElement(p,function(p){
                                c.tmpTW=p.shift()
                                BZ._data._uiSwitch.cc.steps.push({element:p,type:_ideActionData._type._extractData,method:0})
                                
                                setTimeout("_Util._resizeModelWindow()",1)
                              })
                            })
                          }
                        }
                      }, 
                    ]
                  },
                  //Steps
                  {
                    _tag:"div",_attr:{"class":"bz-steps"},
                    _items:[
                      {
                        _tag:"div",
                        _attr:{"class":"col-xs-12 input-group",style:"margin:0"},
                        _items:[
                          {
                            _tag:"div",
                            _attr:{"class":function(d){
                              if(d._item.type==_ideActionData._type._extractData||(d._item.type==_ideActionData._type._triggerEvent&&d._item.event.type=="change")){
                                return "col-xs-9"
                              }
                              return "col-xs-12"
                            },style:"margin:0"},
                            _items:[
                              {
                                _tag:"input",_attr:{"class":"form-control"},
                                _dataModel:"_data._item",
                                _formatSet:function(v,d){
                                  d._item.element=_cssHandler._parseElementPath(v)
                                  return d._item
                                },
                                _formatGet:function(d){
                                  return d.element.join(" ")
                                },
                                _jqext:{
                                  focus:function(){
                                    var c=BZ._data._uiSwitch.cc
                                    var v=_Util._clone(this._data._item.element)
                                    v.forEach(function(vv,i){
                                      if(vv.constructor==String){
                                        v[i]=v[i].replace(/\:[a-z]+[(]\$[0-9]+[)]/i,"")
                                      }
                                    })
                                    v.unshift(c.panel.join(" "))
                                    v.unshift(c.tmpTW)
                                    _bzDomPicker._flashTmpCover(v)
                                  }
                                }
                              }
                            ]
                          },
                          {
                            _if:"(_data._item.type==_ideActionData._type._triggerEvent&&_data._item.event.type=='change')||_data._item.type==_ideActionData._type._extractData",
                            _tag:"div",_attr:{"class":"col-xs-3",style:"margin:0"},
                            _items:[
                              {
                                _tag:"input",_attr:{"class":"form-control"},
                                _dataModel:"_data._item.event.value"
                              }
                            ]
                          },
                          {
                            _tag:"div",_attr:{"class":"input-group-btn"},
                            _items:[
                              {
                                _tag:"button",
                                _attr:{
                                  "class":"btn btn-icon bz-small-btn bz-edit"
                                },
                                _jqext:{
                                  click:function(){
                                    var v=_Util._clone(this._data._item.element)

                                    v.unshift(BZ._data._uiSwitch.cc.panel.join(" "))
                                    v.unshift(BZ._data._uiSwitch.cc.tmpTW)
                                    var _this=this
                                    _bzDomPicker._editPath(v,function(p){
                                      p.shift();
                                      let vs=_Util._clone(BZ._data._uiSwitch.cc.panel)
                                      while(1){
                                        let v=p.shift();
                                        let vv=vs.shift()
                                        if(vv!=v){
                                          p.unshift(v)
                                          break
                                        }
                                      }
                                      _this._data._item.element=p
                                    })
                                  }
                                }
                              },
                              {
                                _tag:"button",
                                _attr:{
                                  "class":"btn btn-icon bz-small-btn bz-delete"
                                },
                                _jqext:{
                                  click:function(){
                                    BZ._data._uiSwitch.cc.steps.splice(this._data._idx,1)
                                    setTimeout("_Util._resizeModelWindow()",1)
                                  }
                                }
                              }
                            ]
                          }
                        ],
                        _dataRepeat:"BZ._data._uiSwitch.cc.steps"
                      }
                    ]
                  },
                  //Try
                  {
                    _if:"BZ._data._uiSwitch.cc.steps.length",
                    _tag:"label",_attr:{"class":"col-xs-12"},
                    _items:[
                      {
                        _text:"_bzMessage._method._tryIt"
                      },
                      {
                        _tag:"div",
                        _attr:{"class":"input-group",style:"margin:0"},
                        _items:[
                          {
                            _tag:"input",
                            _attr:{
                              "class":"form-control",
                              placeholder:"_bzMessage._common._parameter"
                            },
                            _dataModel:"BZ._data._uiSwitch.cc.tryValue"
                          },
                          {
                            _tag:"div",_attr:{"class":"input-group-btn"},
                            _items:[
                              {
                                _tag:"button",
                                _attr:{
                                  "class":"btn btn-icon bz-small-btn bz-play"
                                },
                                _jqext:{
                                  click:function(){
                                    var c=BZ._data._uiSwitch.cc,ss=_IDE._data._curVersion.setting.customizeInputs,bk
                                    if(!_curData){
                                      if(_cssHandler._isDuplicateCssKey(c.name)){
                                        return alert(_bzMessage._system._error._duplicateName,c.name)
                                      }
                                      ss.push(c)
                                    }else{
                                      bk=_Util._clone(_curData);
                                      $.extend(_curData,c)
                                    }
                                    
                                    var p=[c.tmpTW].concat(_getTogglePath(c))
                                    p.push(0)
                                    _ideActionManagement._exeCurTask({type:1,element:p,event:{type:"change",value:BZ._data._uiSwitch.cc.tryValue}},function(){
                                      _ideTask._end()
                                      if(!_curData){
                                        ss.pop()
                                      }else{
                                        Object.assign(_curData,bk)
                                      }
                                    })
                                  }
                                }
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      },
      [
        {
          _title:_bzMessage._common._ok,
          _click:function(c){
            var cc=BZ._data._uiSwitch.cc,k
            _setting.forEach((v)=>{
              if(!cc[v._value]&&v._required&&!k){
                k=_bzMessage._setting._objectLib[v._text]
                alert(_bzMessage._system._error._requiredField,k)
              }
            })
            
            for(var k in BZ._data._uiSwitch.cc){
              _curData[k]=BZ._data._uiSwitch.cc[k]
            } 

            setTimeout(function(){_ideVersionManagement._autoSave()},1)
            if(BZ._isRecording()){
              _ideRecorder._end()
            }
            _cssHandler._setCurPanel()
            c._ctrl._close()
          }
        },
      ],_Util._formatMessage(_bzMessage._setting._objectLib._identifyCss,[_bzMessage._setting._objectLib._options.component[_type]]),500,0,function(){_cssHandler._setCurPanel()}
    )
    function _getTogglePath(c){
      let _toggle=_Util._clone(c.toggle)
      _toggle.forEach((v,i)=>{
        _toggle[i]=v.replace("$header",c.$header).replace("$label",c.$label)
      })
      return _toggle
    }
    function _triggerToggle(c,_fun){
      _ideTask._triggerTmpClickAction(["BZ.TW.document"].concat(_getTogglePath(c)).concat([0]));
      setTimeout(function(){
        _fun&&_fun()
      },100)
    }
  },
  _lookLikeInput:function(l,i){
    return !_Util._isHidden(i)&&(_Util._isInputObj(i)||(_isInputSize(i)&&_isInputPos(l,i)))
    function _isInputSize(o){
      o=o.getBoundingClientRect()
      return o.width/o.height>2
    }
    function _isInputPos(l,i){
      l=l.getBoundingClientRect()
      i=i.getBoundingClientRect()
      if(i.left<=l.left+10){
        return i.top>l.top-10&&i.top<l.bottom+30
      }else if(i.left>=l.right-10&&i.left<=l.right+30){
        return i.top>l.top-10&&i.top<l.bottom-10
      }
    }
  },
  _findSamilarElementByStyle:function(o,e){
    let c=e.tagName+" "+e.className.trim();
    c=c.split(/ +/).filter(x=>!x.match(/[0-9]/)).join(".")
    
    return $(o).find().toArray()
  },
  _findNodeByTxt:function(p,v,_removeSign){
    let ws=[],_fun;
    if(_Util._isRegexData(v)){
      _fun=_match
      v=_Util._eval(v)
    }else if(v.includes("|")){
      _fun=_match
      v=_Util._eval("/"+v+"/i")
    }else{
      v=v.toLowerCase()
    }
    let _txt=(p.innerText||"").replace(/[ \xa0]+/g," ")
    if(_removeSign){
      _txt=_Util._removeSign(_txt," ")
    }
    if(_fun){
    }else if(_include(_txt,v)){
      _fun=_include
    }else if(_include(_txt,v)){
      _fun=_advInclude
    }else{
      return ws
    }
    
    _doIt(p,v,ws)

    return ws
    
    function _doIt(p,v,ws){
      for(let n of p.childNodes){
        if(n.nodeType==3){
          let w=n.textContent
          
          if(_fun(w,v)){
            ws.push({e:n.parentElement,o:n.parentElement,w:w,n:n,ks:[]})
          }
        }else if(n.nodeType==1&&!["SVG","IMG"].includes(n.tagName)){
          let x=(n.innerText||"").replace(/[ \xa0]+/g," ")
          if(_removeSign){
            x=_Util._removeSign(x," ")
          }
          if(_fun(x,v)){
            if(!_Util._isHidden(n)){
              let ss=[]
              _doIt(n,v,ss)
              if(!ss.length){
                let ks=[]
                _removeTxtNode(n,v,ks)
                ks=ks.filter(y=>_cssHandler._lookLikeInput(n,y))
                ss.push({
                  e:n,w:x,ks:ks,o:n
                })
              }
              ws.push(...ss)
            }
          }
        }
      }
    }
    function _removeTxtNode(n,v,_keepNodes){
      for(let nn of n.childNodes){
        if(nn.nodeType==3){
          let _txt=nn.textContent.trim()
          if(_txt&&v.startsWith(_txt)){
            v=v.substring(_txt.length).trim()
          }
        }else if(nn.nodeType==1){
          if(!v){
            _keepNodes.push(nn)
          }else{
            v=_removeTxtNode(nn,v,_keepNodes)
          }
        }
      }
      return v
    }
    function _include(v1,v2){
      return (v1||"").toLowerCase().includes(v2)
    }
    function _advInclude(v1,v2){
      return _Util._removeSign((v1||"").toLowerCase()," ",0,1).includes(v2)
    }
    function _match(v1,v2){
      return v1.match(v2)
    }
  },
  /**/
  //remove $1,$2... from customize format by steps event.value or element
  //f:format ($1/$2), s:steps
  _getValiableParameterBySteps:function(f,s){
    if(f){
      f=f.match(/\$[0-9]+/g)
      if(f.length){
        s.forEach(function(v){
          if(v.event && v.event.value){
            var i=f.indexOf(v.event.value)
            if(i>=0){
              f.splice(i,1)
            }
          }else{
            v.element.forEach(function(vv){
              if(vv.match){
                vv=vv.match(/\$[0-9]+/)
                if(vv){
                  vv=vv[0]
                  var i=f.indexOf(vv)
                  if(i>=0){
                    f.splice(i,1)
                  }
                }
              }
            })
          }
        })
        return f[0]
      }
    }
  },
  //split css setting, like: "button,.btn" to ["button",".btn"]  
  _parseGroup:function(_css){
    _css=_css||""
    var _back=0,b=0,v="",vs=[];
    
    for(var i=0;_css&&i<_css.length;i++){
      var c=_css[i];
      
      if(c=="," && !b){
        v=v.trim();
        if(v){
          vs.push(v);
        }
        v="";
      }else{
        v+=c;
      }
      if(!b){
        var bi="\"'([".indexOf(c);
        if(bi>0){
          b="\"')]"[bi];
        }
      }else if(c==b && !_back){
        b=0;
      }else if(c=="\\"){
        _back=!_back;
      }else{
        _back=0;
      }
    }
    v=v.trim();
    if(v){
      vs.push(v)
    }
    return vs;
  },
  //split css like: "button.btn-add" to ["button",".btn-add"]
  _parseItems:function(_css){
    var _back=0,b=[],v="",vs=[];
    for(var i=0;i<_css.length;i++){
      var c=_css[i];
      if(".#[:".includes(c) && !b.length){
        v=v.trim();
        if(v){
          vs.push(v);
        }
        v=""
      }
      v+=c;
      var bi="\"'([{".indexOf(c);
      if(bi>0){
        b.unshift("\"')]}"[bi]);
      }
      if(c==b[0] && !_back){
        b.shift();
      }else if(c=="\\"){
        _back=!_back;
      }else{
        _back=0;
      }
    }
    v=v.trim();
    if(v){
      vs.push(v)
    }
    return vs;
  },
  //split element path from "BZ.TW.document DIV:Contains(lws ok) 0" --> ["BZ.TW.document","DIV:Contains(lws ok)",0]
  _parseElementPath:function(v){
    if(!v){
      return
    }
    v=_Util._parseExpression(v+" ",/ /)
    return v._headers
  },
  //from ["LABEL",":endContains(Name)"] to ["{LABEL}","\"Name\""]
  _cssToDesc:function(p){
    var ss=[],_css=[];

    for(var n=0;n<p.length;n++){
      var c=this._findDesc(p[n]);
      if(!c){
        continue;
      }else if('"'==c[0]){
        var s=_JSHandler._parseCode(c.substring(1,c.length-1));
        if(s.constructor==Array){
          var c=""
          for(var i=0;i<s.length;i++){
            if(s[i].txt){
              c+='"'+s[i].txt+'"'
            }else if(s[i].code){
              c+='('+s[i].code+')'
            }
          }
        }
        ss.push(c)
      }else if('{'==c[0]){
        if(!ss.includes(c)){
          ss.push(c)
        }
      }else if(c){
        var ks=[];
        for(var k in c){
          var cc=c[k];
          for(var m=0;m<p.length;m++){
            var pm=p[m];
            if(pm.match(/:has\(/)){
              pm=pm.substring(5,pm.length-1);
            }
            var _found=0;
            for(var ii=0;ii<cc._items.length;ii++){
              var _items=cc._items[ii];
              var _item=_items._item;
              
              var _idx=_item.indexOf(pm);
              if(_idx>=0){
                _item.splice(_idx,1);
                cc._find=cc._find||0;
                if(!_item.length){
                  if(!ks.includes(cc)){
                    ks.push(cc)
                  }
                  if(cc._find<_items._size){
                    cc._find=_items._size;
                  }
                }
              }
            }
          }
        }
        var k=0;
        for(var m=0;m<ks.length;m++){
          if(k){
            if(k._find<ks[m]._find){
              k=ks[m]
            }else if(k._find==ks[m]._find){
              if(k._names.length>ks[m]._names.length || k._same>ks[m]._same){
                k=ks[m]
              }
            }
          }else{
            k=ks[m]
          }
        }
        if(k){
          if(!ss.includes(k._names[0])){
            ss.push(k._names[0])
          }
        }else{
          ss.push("{"+p[n]+"}")
        }
      }
    }
    return ss;
  },
  /*From 
    Text: ":endContains(Sharing)" to "Sharing"
    Defined object: ".bz-delete" to "delete"
    un-defined object: "div" to {div}
  */
  _findDesc:function(v){
    if(!v){
      return
    }
    var _css=_cssHandler._cssMap[v];
    var _first;
    if(_css){
      return _Util._clone(_css);
    }else if(v[0]==":" && !v.startsWith(":attr(")){
      var si=v.indexOf("(")+1;
      if(si){
        var ei=v.lastIndexOf(")");
        if(ei<0){
          ei=v.length;
        }
        si=v.substring(si,ei);
        if(v.match(/^:has\(/)){
          return this._findDesc(si);
        }else{
          si="\""+si+"\"";
        }
        return si;
      }
    }else if(v.startsWith(":attr(")){
      v=v.match(/\=(\"|\'|)([^\"\'\)]+)/)
      if(v){
        return '"'+v[2]+'"'
      }
    }else if(v.startsWith("[")){
      var si=v.indexOf("=")+2;
      if(si){
        var ei=v.lastIndexOf("\"");
        if(ei>0){
          si="\""+v.substring(si,ei)+"\"";
          return si;
        }
      }
    }else if("#.".includes(v[0]) || v[0].match(/[a-z]/i)){
      return "{"+v+"}"
    }
  },
  _getRootShadowDom:function(e){
    let r=0;
    while(e&&(e.parentNode||(e.host&&e.host.constructor!=String))){
      if(e.host){
        r=e;
      }
      e=e.parentNode||e.host;
    }
    return r;
  },
  _isInShadowDom:function(e){
    e=_cssHandler._getRootShadowDom(e);
    return e&&e.host&&e.host.constructor!=String&&!_Util._isHidden(e.host)
  },
  _getRoot:function(e){
    let d=e.ownerDocument;
    while(e.parentNode){
      e=e.parentNode;
      if(e.host&&e.host.constructor!=String){
        return e
      }
    }
    return d
  },
  _addPanelOnPath:function(d){
    try{
      let ps=_cssHandler._keyMap.panel,
          s=d.oe.bzTmp
          
      ps=ps&&ps._css
      if(ps){
        if(s.constructor==String){
          s=s.split("\n")
        }
        if(s[0]!="BZ.TW.document"){
          s.unshift("BZ.TW.document")
        }
        ps=ps.split(",")
        return ps.find(p=>{
          let os=$(p)
          if(os.find(d.oe).length){
            if(!p.match(/[A-Z]/i)){
              os=os.toArray()
              os.find(o=>{
                if($(o).find(d.oe).length){
                  p=o.tagName+p
                  return 1
                }
              })
            }
            s.splice(1,0,p)
            
            d.oe.bzTmp=s
            return 1
          }
        })
      }
    }catch(e){}
  },
  _findLabelByInput:function(e,_retrieveElement){
    if(e.type=="radio"){
      return e.name
    }
    let _left="checkbox"!=e.type,_file=e.type=="file",_break
    return _doIt(e.parentElement,e)||_cssHandler._getElementTitle(e)

    function _doIt(p,e){
      let os=[],_start=_left,os2=[]
      let cs=os;
      for(let o of p.childNodes){
        if(o==e){
          if(_start){
            if(_file){
              cs=os2
            }else{
              break
            }
          }else{
            _start=1
          }
        }else if(_start&&"13".includes(o.nodeType)){
          cs.push(o)
        }
      }
      if(_left||_file){
        os.reverse()
      }
      if(os.length||os2.length){
        let w=_findInList(os)||_findInList(os2)
        
        if(w){
          return w
        }else if(_break||p.tagName=="BODY"){
          return
        }else{
          return _doIt(p.parentElement,p)
        }
      }else{
        return _doIt(p.parentElement,p)
      }
    }
    
    function _findInList(os){
      if(os.length){
        let w,oo;
        os.find(x=>{
          if(x.nodeType==3){
            w=_cleanWord(x.textContent||"")
            if(w){
              oo=x
            }
            return w
          }else if(x.nodeType==1){
            if(_Util._isEmpty(_cssHandler._findAllInputs(x))){
              w=_cleanWord(x.innerText||"")
              if(w){
                oo=x
              }
              return w
            }else{
              _break=1
              return 1
            }
          }
        })
        return _retrieveElement?oo:w
      }
    }
    
    function _cleanWord(w){
      return _Util._removeSign(w," ",["-"])
    }
  },
  _findInputPath:function(e){
    let _label=_cssHandler._findLabelByInput(e)
    if(_label){
      _label=["BZ.TW.document",`:input(${_label})`]
      let o=_Util._findDoms(_label)||[]
      if(o.length){
        if(o.includes(e)){
          _label.push(o.indexOf(e))
          return _label  
        }else if(e.children.length){
          for(let x of e.children){
            let i=o.indexOf(x)
            if(i>=0){
              _label.push(i)
              return _label
            }
            i=o.findIndex(y=>$(y).find(x)[0])
            if(i>=0){
              _label.push(i)
              return _label  
            }
          }
        }
      }
    }

    let _inHidden=_Util._isHidden(e)?":hidden":""
    let _type=["checkbox","radio","file"].includes(e.type)?`:attr(type=${e.type})`:""

    if(e.type=="radio"&&e.tagName=="INPUT"){
      if(e.name){
        return ["BZ.TW.document","INPUT"+_type+":text("+e.name+")",0]
      }
    }
    let pe=_findFirstElementWithLabel(e,$util.getElementText(e));
    if(!pe){
      if(e.placeholder){
        return ["BZ.TW.document",e.tagName+"[placeholder="+$(e).attr("placeholder")+"]",0]
      }
      return
    }

    if(e.type=="radio"&&e.tagName=="INPUT"){
      return _findSecondElementWithLabel(pe.p,e,pe.w)
    }
    
    //return ["BZ.TW.document",e.tagName+_inHidden+_type+":near("+_formatLabel(pe.w)+")",0]

    function _findFirstElementWithLabel(o,pw){
      let p=o,_last=o,_lastWord=(pw||"").trim(),_bkLabel
      while(p.tagName!="BODY"&&p.parentElement){
        _last=p
        p=p.parentElement
        let _innerInputs=_Util._findInputs(p)
        if(_innerInputs.length>1&&_innerInputs.find(x=>x!=o&&!_Util._isHidden(x))){
          if(_bkLabel){
            return _bkLabel
          }
          return
        }
        let cw=$util.getElementText(p)
        if(cw&&cw!=_lastWord){
          let _start=!["radio","checkbox","file"].includes(o.type),
              w=""
          if(_lastWord){
            cw=cw.split(_lastWord)
            if(_start&&cw[0]){
              return {p:p,w:cw[0].trim()}
            }else if(cw[1]){
              return {p:p,w:cw[1].trim()}
            }
          }
          _lastWord=cw
          if(_start){
            let pr=p.getBoundingClientRect()
            let or=o.getBoundingClientRect()
            if(or.top-pr.top<15&&or.left-pr.left<20){
              _bkLabel={p:p,w:cw}
              continue
            }
          }
          for(let x of p.childNodes){
            if(_start){
              if(x==_last){
                if(w.trim()){
                  return {p:p,w:w.trim()}
                }
                break
              }
              
              if(x.nodeType==3){
                w=w.trim()+" "+x.textContent.toString().trim()
              }else if(x.nodeType==1&&x.getBoundingClientRect().width){
                w=w.trim()+" "+$util.getElementText(x)
              }
            }else if(x==_last){
              _start=1
            }
          }
          w=w.trim()
          if(w){
            return {p:p,w:w}
          }
        }
      }
    }

    function _findSecondElementWithLabel(o,e,w){
      let p=o
      while($(p).find("input").length==1&&p.innerText.trim()==w&&p.tagName!="BODY"){
        p=p.parentElement
      }
      if(p.tagName=="BODY"){
        return
      }
      if($(p).find("input").toArray().find(x=>{
        return x.type!="radio"
      })){
        return
      }
      let oo=$(p).find("input[type=radio]")[0]
      if(oo!=e){
        w=_findFirstElementWithLabel(oo)
        if(!w){
          return 
        }
        w=w.w.trim()
      }
      let ww=p.innerText.trim()
      ww=ww.substring(0,ww.indexOf(w))
      while(!ww){
        p=p.parentElement
        if(p.tagName=="BODY"){
          return
        }
        if($(p).find("input").toArray().find(x=>{
          return x.type!="radio"
        })){
          return
        }
        ww=p.innerText.trim()
        ww=ww.substring(0,ww.indexOf(w))
      }

      return ["BZ.TW.document",`INPUT[type=radio]${_inHidden}:after(${ww.trim()})`,0]
    }
    
    function _formatLabel(ww){
      ww=ww.split("\n")
      let wx=""
      ww.forEach(x=>{
        if(x.length>wx.length){
          wx=x
        }
      })
      
      return _Util._toTrimSign(wx,30).replace(/\*+$/,"").trim()
    }
    
  },
  _hasAIFlag:function(e){
    return e.dataset.bz
  },
  _getButtonLabel:function(e){
    let v=_cssHandler._findLabel({e:e,oe:e})
    if(v){
      return v.w
    }
    return _cssHandler._findTitleAttribute(e)
  },
  _attachRealTargetElementCss:function(o,p){
    let v=_aiFlagHandler._parseBZFlag(o.dataset.bz||"")
    if(!v){
      return
    }
    let e=_getRealTargetElement(v,"$target"),
        c=_getRealTargetElement(v,"$css")
    if(e||c){
      let n;
      while(p.length){
        let i=p.pop()
        if($.isNumeric(i)){
          n=i
        }else{
          if(c){
            i=i.match(/\:(near|Contains|equal|endContains|before|after|text|endEqual).+/)
            if(i){
              i=i[0]
            }
            i=c+i
          }
          p.push(i)
          if(e){
            p.push(e,n||0)
          }
          return 1
        }
      }
    }
    function _getRealTargetElement(v,tk){
      if(v){
        let r;
        v.find(x=>{
          if(x[tk]){
            return r=x[tk]
          }else{
            for(let k in x){
              r=(((x[k]||{})[tk]||{}).value||[])[0]
              if(r){
                return r
              }
            }
          }
        })
        return r
      }
    }
  },
  _getOptionElementByBZFlag:function(e){
    v=_aiFlagHandler._parseBZFlag(e.dataset.bz||"")
    if(v){
      v.find(x=>{
        if(x.$option){
          e=$(e).find(x.$option).toArray()
          return 1
        }else{
          for(let k in x){
            let o=(((x[k]||{}).$option||{}).value||[])[0]
            if(o){
              e=$(e).find(o).toArray()
              return 1
            }
          }
        }
      })
    }
    return e.constructor==Array&&e
  },
  _findPathByAIFlag:function(ee,_force){
    if(!_force&&_aiFlagHandler._data.avoidBzFlagElement){
      return
    }
    
    let ps=[],e=ee
    while(e.tagName!="HTML"){
      let p=_cssHandler._getBzPath(e)
      if(p){
        if(!ps.length){
          if(p.bz.find(x=>{
            return x.k=="$field"&&!x.v&&_Util._isInputObj(e)
          })){
            return 
          }
        }
        ps.unshift(p)
        if(p.bz.find(x=>{_aiFlagHandler._isPanel(x.k)})){
          break
        }
      }
      e=e.parentElement
    }
    let pp=[],_hasModulePanel,_hasDetail,_hasRow;
    ps.forEach((x,i)=>{
      x.bz=x.bz.filter(y=>y.k)
    })
    ps=ps.filter(x=>x.bz.length)
    ps.forEach((x,i)=>{
      x.bz.find((y,j)=>{
        if(y.k=="$module"){
          _hasModulePanel=1
          pp=[]
        }else if(y.k=="$details"){
          _hasDetail=1
          pp=[]
        }
      })

      let _text="",_hasId
      if(i==ps.length-1){
        x.bz.find((y,j)=>{
          if(y.k=="$id"){
            _hasId=y
            return 1
          }
        })
        x.bz.find(y=>{
          if(_aiFlagHandler._isEnter(y.k)||_aiFlagHandler._isOperation(y.k)||y.k=="$field"){
            _text=_cssHandler._getButtonLabel(x.e)
            if(_text){
              if($util.getElementText(x.e)==_text){
                _text=":Contains("+_text+")"
              }else{
                _text=":text("+_text+")"
              }
            }
            
            if(_hasRow&&!_hasId&&y.k!="$field"){
              let w=_findFieldForElementPath(ee)
              if(w){
                pp.push(w)
              }
            }
            return 1
          }
        })
        _Util._spliceAll(x.bz,y=>{
          if(_hasId&&!(_aiFlagHandler._isEnter(y.k)||_aiFlagHandler._isOperation(y.k)||y.k=="$id")){
            return 1
          }
        })
      }
      
      let xx=x.bz.map(y=>{
        return `:bz(${y.k}${y.v?"="+y.v:""})`
      }).join("")+_text||"";
      if(i!=ps.length-1&&xx.match(/:bz *[\(:=] *\$(row|table|list)[ \)]*$/)&&(_hasModulePanel||_hasDetail)){
        _hasRow=_hasRow||xx.match(/:bz *[\(:=] *\$row[ \)]*$/);
        
        return 
      }
      pp.push(x.e.tagName+xx)
    })

    _cssHandler._attachRealTargetElementCss(ee,pp)

    pp=["BZ.TW.document",...pp,0]
    return pp
    
    function _getRowElement(e){
      let p=e.parentElement;
      let _row=p.dataset.bz
      if(_row&&_row.match(/\$row/)){
        return p
      }else{
        return _getRowElement(p)
      }
    }
    function _findFieldForElementPath(e){
      let p=_getRowElement(e),v;
      let os=$(p).find("*").toArray()
      os.find(o=>{
        let x=o.dataset.bz
        if(x){
          x=_aiFlagHandler._parseBZFlag(x)
          x=x&&x[0].$field
          if(x&&x.value){
            let w=$util.getElementText(o)
            if(w){
              if(x.value.length==1){
                w=":equal="+w
              }else{
                w=":Contains="+w
              }
              v= p.tagName+":include("+o.tagName+":bz=$field="+x.value[0]+w+")";
              return 1
            }
          }
        }
      })
      return v
    }
  },
  _getBzPath:function(e){
    let v=e.dataset.bz
    if(v){
      let _result=[]
      v=_aiFlagHandler._parseBZFlag(v)
      v.forEach(x=>{
        if(x.constructor==String){
          if(!_result.length){
            _result.push(x)
          }
        }else{
          let k=Object.keys(x)[0]
            
          _result.push(..._setValue(x[k],k))
          x=x[k]
          if(x.$id){
            _result.push(..._setValue(x.$id,"$id"))
          }else if(x.$field){
            _result.push(..._setValue(x.$field,"$field"))
          }
        }
      })
      _result=new Set(_result)
      return {e:e,bz:[..._result]}
    }
    function _setValue(x,k){
      let w=[]
      if(x.value){
        x.value.forEach(y=>{
          w.push({k:k,v:y})
        })
      }else{
        w.push({k:k})
      }
      return w
    }
  },
  _getComPath:function(e,_withAIAnalysis){
    let c=window._comCss
    if(c){
      let p=["BZ.TW.document"]
      if(Object.keys(c).find(x=>{
        if($(x).find(e)[0]){
          let t=(_cssHandler._findLabel({e:e,oe:e})||{w:""}).w||""
          p.push(":"+c[x]+"("+t+")",0)
          return 1
        }
      })){
        if(_withAIAnalysis){
          p={
            W:{HH:[],WW:[]},
            _elementPath:p
          }
        }
        return p
      }
    }
  },
  _getDefinitedPath:function(e,_withAIAnalysis){
    let p=["BZ.TW.document"]
    if(e.bzPath){
      if(e.bzPath.constructor==String){
        p.push(e.bzPath)
      }else{
        if(e.bzPath[0].includes("BZ.TW.")){
          p=e.bzPath
        }else{
          p.push(...e.bzPath)
        }
      }
      if(!$.isNumeric(p[p.length-1])){
        p.push(0)
      }
      _cssHandler._attachRealTargetElementCss(e,p)
      if(_withAIAnalysis){
        p={
          W:{HH:[],WW:[]},
          _elementPath:p
        }
      }
      return p
    }
    
  },
  _findStdTextElement:function(e,w){
    let _path=_Util._removeSign((w||e.innerText||e.value||"").trim().split("\n")[0]," ")
    if(_path){
      _path=["BZ.TW.document",`${e.tagName}:text(${_path})`,0]
      let ee=$util.findDom(_path)
      if(ee&&(ee==e||_cssHandler._findCellElement(ee)==_cssHandler._findCellElement(e))){
        return _path
      }
    }
  },
  _getTextPath:function(e){
    let t=(e.innerText||"").trim().split("\n")[0]
    if(t){
      let tw=`${e.tagName}:text(${t})`
      let os=$(tw).toArray()
      let i=os.indexOf(e)
      if(i>=0){
        if(i&&i==os.length-1){
          return ["BZ.TW.document",tw+":last",0]
        }
        return ["BZ.TW.document",tw,i]
      }
    }
  },
  //get element path
  //_simple: 1: only level 1, 2: ignore label, 3: only label, 4: class first (for panel)
  //_simple: 1: only level 1, 2: ignore label, 3: only label
  _findPath:function(e,_withAIAnalysis,_simple){
    try{
      if(e.bzShortCut&&e.tagName!="CANVAS"){
        if(_withAIAnalysis){
          return e.bzShortCut
        }
        return e.bzShortCut._elementPath
      }
      let _definitedPath=_cssHandler._getDefinitedPath(e,_withAIAnalysis)
      if(_definitedPath){
        return _definitedPath
      }

      _definitedPath=_cssHandler._getComPath(e,_withAIAnalysis)
      if(_definitedPath){
        return _definitedPath
      }

      e=this._findCellElement(e);
      if(!_isInput(e)){
        let w=e.innerText||e.value||_cssHandler._getElementTitle(e)
        if(w){
          let _path=_cssHandler._findStdTextElement(e,w)
          if(_path){
            if(_withAIAnalysis){
              return {
                W:{HH:[],WW:[]},
                _elementPath:_path
              }
            }else{
              return _path
            }
          }
        }
        if(_cssHandler._hasAIFlag(e)){
          let fe=_cssHandler._findPathByAIFlag(e)
          if(fe){
            if(_withAIAnalysis){
              return {
                W:{HH:[],WW:[]},
                _elementPath:fe
              }
            }else{
              return fe
            }
          }
        }
      }else{
        let _quickPath= _cssHandler._findInputPath(e)
        if(_quickPath){
          let _chkInput=_quickPath.find((x,i)=>{
            if(x.constructor==String&&x.match(/:input\(/)){
              if(_IDE._data._curAction&&"02".includes(_IDE._data._curAction.type)){
                _quickPath[i]=x.replace(":input(",":data(")
              }
              return 1
            }
          })

          let _attachFlag=_chkInput?0:_cssHandler._attachRealTargetElementCss(e,_quickPath)
          
          if(_chkInput||_chkPath(e,_quickPath,_attachFlag)){
            if(_simple!=3){
              if(_withAIAnalysis){
                return {
                  W:{HH:[],WW:[]},
                  _elementPath:_quickPath
                }
              }else{
                return _quickPath
              }
            }else{
              return _quickPath
            }
          }
        }else if(_simple==3&&_Util._isHidden(e)){
          return
        }
      }
      if(e.tagName=="TD"){
        let _table=_Util._getClosestElement(e,e,"table")
        if(_table&&_cssHandler._getTableType(_table)=="dataTable"){
          _table=_findRowColPath(e,_table)
          if(_table){
            e.bzTmp=_table
            if(_withAIAnalysis){
              return {
                _elementPath:_table,
                W:{}
              }
            }
            return _table
          }
        }
      }
      if ($(e).hasClass("BZIgnore") || $(e.ownerDocument).find(".BZIgnore").find(e).length || (e.tagName=="BODY" && !e.contentEditable)) {
        return;
      }

      if(!e.bzShortCut||e.tagName=="CANVAS"){
        var c=_cssHandler._getCustomizeInputCss(e)
        if(c&&c._head){
          let cc=c._css
          let _label=cc.includes("$label"),_header=cc.includes("$header");
          if(_label||_header){
            cc=cc.replace(_Util._attrRegex,":attr($1=*)").replace(/(\$label|\$header)/,"*")
          }

          let ccc=_cssHandler._parseElementPath(cc)[0]
          
          let cs=$(ccc).toArray()
          let ex=cs.find(o=>{
            return o==e||$(o).find(e)||$(e).find(o)
          })
          if(ex){
            e._customize=c
            let eo=$(ex).find(cc)[0]||ex
            e.bzTmp=["BZ.TW.document"]
            cc=_cssHandler._parseElementPath(c._css)
            while(cc.length){
              c=cc.pop()
              let f=c.match(_Util._attrRegex)
              if(f){
                while(!eo.attributes[f[1]].value&&eo.tagName!="BODY"){
                  eo=eo.parentElement
                }
                if(eo.tagName=="BODY"){
                  return
                }
                e._customize[f[3]]=eo.attributes[f[1]].value
              }else{
                f=c.match(_Util._bzJQFun)
                if(f){
                  while((!eo._bzJqVal||eo._bzJq!=f[1])&&eo.tagName!="BODY"){
                    eo=eo.parentElement
                  }
                  if(eo.tagName=="BODY"){
                    return
                  }
                  e._customize[f[2]]=eo._bzJqVal
                }
              }
            }
          }
        }else{
          e._customize=c
        }
      }
      
      let ep=_cssHandler._getTextPath(e)
      if(ep){
        if(_withAIAnalysis){
          return {
            W:{HH:[],WW:[]},
            _elementPath:ep
          }
        }
        return ep
      }
      if(!_simple&&e.tagName.match(/(DIV|PRE|P)/)&&$(e).find("button,a,input").length){
        _simple=4
      }
      var d={
        e:e,
        oe:e,
        ps:[],
        ee:1,
        _headers:[],
        _stopLabel:_simple==2,
        _labelOnly:_simple==3,
        _classFirst:_simple==4,
        _stopHeader:_cssHandler._curPanel
      },o,bk,_chkPanel;
      if(!e.bzShortCut||e.tagName=="CANVAS"){
        e.bzW=0
        var ee=d.ee;
  //      console.time("_findPath")
        while(d.e.ownerDocument){
          this._checkDescPath(d,_simple||_cssHandler._curPanel);
          if(_simple==1){
            break
          }
          if(_cssHandler._curPanel){
            var _tmp=d.oe.bzTmp
            if(d.ee.length>1){
              _tmp=_Util._clone(_tmp)
            }
            if(_tmp.constructor==String){
              _tmp=_tmp.split("\n")
            }
            _tmp.splice(1,0,_cssHandler._curPanel)
            if(d.ee.length>1){
              var os=_Util._findDoms(_tmp)
              if(os.length==1){
                d.oe.bzTmp=_tmp
                break
              }
            }else{
              d.oe.bzTmp=_tmp
              break
            }
          }else if(d._label&&_simple==3&&(d.oe==d.ee||d.ee.length==1)){
            break
          }else if(d._label&&!_chkPanel&&(_chkPanel=1)&&_cssHandler._addPanelOnPath(d)){
            break
          }else if(!_Util._isEmpty(d._headers)&&!_chkPanel&&(_chkPanel=1)&&_cssHandler._addPanelOnPath(d)){
            break
          }else if(d.ee&&(d.ee==d.oe||d.ee[0]==d.oe)&&(d._label||d._stopLabel)&&(d._stopHeader||!_Util._isEmpty(d._headers))){
            break
          }else if(d._label&&d._labelOnly){
            break
          }else if(d.e!=d.oe){
            var ee=$(d.e).find(d.ee);
            if(!d.e.ownerDocument || d.e==d.e.ownerDocument.body.parentElement){
              bk=d.oe.bzTmp;
              if(!bk){
                return _Util._getElementSimplePath(d.oe);
              }
              if(_Util._isInputObj(d.oe)){
                var s=bk.constructor==String?bk.split("\n"):bk;
                if(s.length==2 && d.e.innerText && ee.length<4){
                  continue;
                }
              }
              _descAnalysis._findElementIdx(d.oe);
              if($util.findDom(d.oe.bzTmp)==d.oe){
                break;
              }else{
                if(bk.constructor==String){
                  bk=bk.split("\n")
                }
                d.oe.bzTmp=bk;
              }
            }
          }
          if(d.e.tagName=="BODY"||(d.e.host&&d.e.host.constructor!=String)){
            break
          }
        }
        if(d.oe.bzTmp){
          if(d.oe.bzTmp.constructor==Array){
            d.oe.bzTmp=d.oe.bzTmp.join("\n")
            if(d.e.host&&d.e.host.constructor!=String){
              let tmp=d.e.bzTmp;
              if(tmp.constructor==Array){
                tmp=tmp.join("\n")
              }
              if(!d.oe.bzTmp.startsWith(tmp)){
                d.oe.bzTmp=tmp+"\n"+d.oe.bzTmp;
              }
            }
          }
          if(!d.oe.bzTmp.startsWith("BZ.TW.document")){
            d.oe.bzTmp="BZ.TW.document\n"+d.oe.bzTmp
          }
          _descAnalysis._findElementIdx(d.oe,_simple)
        }
        
  //      d.oe.bzTmp=this._optimizePath(d.oe.bzTmp,d.oe);
  //      console.timeEnd("_findPath")
      }
      if(d.oe.bzTmp.constructor==String){
        d.oe.bzTmp=d.oe.bzTmp.split("\n")
      }
      let p=_Util._clone(d.oe.bzTmp)
      if(_cssHandler._attachRealTargetElementCss(d.oe,p)){
        if(_chkPath(d.oe,p,1)){
          d.oe.bzTmp=p
        }
      }
      if(_withAIAnalysis){
        if(d.oe.bzShortCut){
          return d.oe.bzShortCut
        }
        if(!d.oe.bzW){
          d.oe.bzW=_descAnalysis._getAICssData(d.oe,d.oe.bzTmp,d._label)
        }
        return d.oe.bzShortCut={
          _elementPath:d.oe.bzTmp, 
          W:d.oe.bzW||{}
        }
      }
      if(d.oe.bzShortCut){
        return d.oe.bzShortCut._elementPath
      }
      _Util._setBlankIFramePath(d.oe.bzTmp,d.oe)
      
      return d.oe.bzTmp||_Util._getElementSimplePath(d.oe);
    }catch(exx){
      e.bzTmp=_Util._getElementSimplePath(e)
      return e.bzTmp
    }

    
    function _chkPath(e,p,_attachFlag){
      let fe=$util.findDom(p)
      if(_attachFlag){
        return fe&&(e==fe||$(e).find(fe)[0])
      }else{
        return fe==e||(fe&&fe.type=="radio"&&e.type=="radio"&&fe.name==e.name)
      }
    }
    
    function _isInput(e){
      let a=_IDE._data._curAction
      if(_Util._isInputObj(e)){
        return 1
      }
      if(a&&!BZ._isRecording()){
        if(a.type==1&&"change,key".includes(a.event.type)){
          return 1
        }else if(a.type==2||a.type==0){
          let ee= _cssHandler._findLabelByInput(e,1)
          return ee.tagName!=e.tagName&&(e.tagName!="A"||!$(ee).find(e.tagName)[0])
        }
      }
    }

    //o:TR cell,t: table (option)
    function _findRowColPath(o,t){
      if(["TD","TH"].includes(o.tagName)){
        let p=o,tr,th,rc,hc,x,y,s,or=o.getBoundingClientRect();
        while(p.parentElement){
          p=p.parentElement
          if(p.tagName=="TR"){
            tr=p
            if(t){
              break
            }
          }else if(p.tagName=="TABLE"){
            t=p
            break
          }
        }
        th=$(t).find("tr:eq(0)")[0]
        rc=$(tr).find("td,th")[0]
        if(!$util.getElementText(th)||!$util.getElementText(rc)){
          return
        }
        let trs=th.children
        x=$(tr).find("td,th").toArray().indexOf(o)

        if(x>=0){
          hc=trs[x]
          if(hc){
            if(!$util.getElementText(hc)){
              return
            }
            let rh=hc.getBoundingClientRect()
            if(rh.left-5<=or.left&&rh.right+5>or.right){
              return _getRCValue(rc,hc)
            }else if(rh.left>=or.right-5){
              x--
              s=-1
            }else{
              x++
              s=1
            }
          }else{
            x--
            s=-1
          }
        }

        for(;x<trs.length;x+=s){
          let hc=trs[x]
          if(hc){
            let rh=hc.getBoundingClientRect()
            if(rh.left-5<=or.left&&rh.right+5>or.right){
              return _getRCValue(rc,hc)
            }
          }else if(x<0){
            return
          }
        }
      }
      function _getRCValue(rc,hc){
        return ["BZ.TW.document",o.tagName+":RowCol("+$util.getElementText(rc)+"|"+$util.getElementText(hc)+")",0]
      }
    }

  },
  
  /*
  _optimizePath:function(ps,o){
    var ns=[],_found;
    if(ps.constructor==String){
      ps=ps.split("\n");
    }
    
    for(var i=ps.length-1;i>0;i--){
      var p=ps[i];
      if(p!=_cssHandler._curPanel&&p.match && p.match(/[.#]/) && !_found){
        var p1=p.match(/[.#][a-z0-9_-]+/ig)
        
        if(p1){
          var c=p.match(/:[a-z]+\([^)]+\)/gi)
          if(c){
            p1.forEach(function(v){
              var _include=0
              for(var i=0;i<c.length;i++){
                if(c[i].includes(v)){
                  _include=1
                  break
                }
              }
              if(!_include){
                _found=1
                p=p.replace(v,"")
              }
            })
          }else{
            _found=1
            p=p.replace(p1[0],"")
          }
        }
      }
      ns.unshift(p)
    }
    if(_found){
      ns.unshift(ps[0])
      var oo= $util.findDom(ns)
      if(oo==o){
        return _cssHandler._optimizePath(ns,o)
      }
    }
    return ps;
  },
  */
  _isIgnoreClass:function(c){
    return c.match(_cssHandler._ignoreClasses)
  },
  _getFormBtnType:function(b){
    b=["$submit","$cancel","$confirm","$next","$back"].find(x=>{
      return _cssHandler._isBtnByType(b,x)
    })
    return b
  },
  _isBtnByType:function(o,_type){
    let w=o.innerHTML.toLowerCase(),m=_bzMessage._method,s;
    switch(_type){
      case "$submit":
        s=`/${m._submit}|${m._save}|submit|save|store/i`
        break
      case "$cancel":
        s=`/${m._cancel}|${m._close}|close|cancel/i`
        break
      case "$confirm":
        s=`/${m._confirm}|confirm/i`
        break
      case "$next":
        s=`/${m._next}|${m._continue}|next|continue/i`
        break
      case "$back":
        s=`/${m._back}|${m._previous}|back|previous/i`
    }
    
    return w.match(_Util._eval(s))
  },
  _findForm:function(_root){
    _root=_root||document.body
    let wr=document.body.getBoundingClientRect();
    let w=wr.width*0.8,t=wr.height*0.4
    let p=$(_root).find("*").toArray().reverse().find(x=>{
      if(x.tagName=="BODY"){
        return 1
      }else if(x.tagName=="DIV"){
        let r=x.getBoundingClientRect();
        if(r.width>=w&&r.top<=t&&r.height>100){
          return _cssHandler._findAllInputs(x).length
        }
      }
    })
    if(!p){
      return _root
    }

    return _cssHandler._getBetterParent(p)

  },
  _getBetterParent:function(p){
    if(p.tagName=="BODY"||_cssHandler._isFixedAbsoluteElement(p)){
      return p
    }
    let r=p.getBoundingClientRect(),
        pr=p
    while(1){
      let pp=p.parentElement
      if(pp){
        let ppr=pp.getBoundingClientRect()
        if(ppr.width-r.width<=40){
          return _cssHandler._getBetterParent(p.parentElement)
        }
      }
      pr=pr.previousElementSibling
      if(!pr){
        return _cssHandler._getBetterParent(p.parentElement)
      }else if(!_Util._isHidden(pr)){
        let rr=pr.getBoundingClientRect()
        if(rr.width>r.width){
          if(rr.width==window.innerWidth){
            return p
          }
        }else if(rr.left<r.left||rr.left>r.right-10){
          return p
        }
      }
    }
  },
  _isFixedAbsoluteElement:function(o){
    return ["fixed","absolute"].includes($(o).css("position"))
  },
  _findCellElement:function(e,_root){
    if(["INPUT","TEXTAREA","SELECT","A","BUTTON","DIV","SPAN"].includes(e.tagName)){
      return e;
    }
    if(e.tagName=="SPAN"){
      return _Util._getParentElementByCss("button,a",e)||e
    }
    try{
      if($(e).is(_IDE._data._curVersion.setting.content.clickableElements)){
        return e
      }
    }catch(ee){}
    var es=$(_root||e.ownerDocument).find("SVG,[contenteditable=true],A,SELECT,"+_cssHandler._keyMap.button._css);
    if(es.is(e)){
      if(e.tagName=="svg"){
        if(!$("button,A").find(e).length){
          return e
        }
        while(!["A","BUTTON"].includes(e.tagName)){
          e=e.parentElement
        }
        return e
      }
      return e
    }else{
      es=es.filter(function(m,ee){
        var r=ee.getBoundingClientRect()
        if(!r.width || !r.height){
          return
        }
        if($(ee).find(e).length){
          if(["SVG","SELECT"].includes(ee.tagName.toUpperCase()) || (ee.innerText && ee.innerText.trim())){
            return ee;
          }else{
            return e;
          }
        }
      });
      if(es.length){
        return es[0]
      }
    }
    return e;
  },
  _isPriorityElementItem:function(v){
    if(v[0]=="["){
      v=v.split("=")[0]
    }
    var os=_cssHandler._priorityItems
    if(!os.length){
      os=_cssHandler._priorityItems=_IDE._data._curVersion.setting.content.priorityElementItems.replace(/[,; ]/g,",").split(",")
      os.forEach((a,i)=>{
        os[i]="^"+a.replace(/\./g,"").replace(/[*]/g,".+")+"$"
      })
    }
    return os.find(o=>{
      return v.match(new RegExp(o))
    })
  },
  //Sing element path description
  _checkDescPath:function(_data,_simple){
    this._findAttributes(_data);
    var o=_data._result,e=_data.e;

    //Clean text when the text to short and appear in multiple elements
    if(e.tagName!="CANVAS"){
      o._text=_Util._toTrimSign(o._text)
    }
    if(o._text && o._text.length==1 && e!=_data.oe && $(e.ownerDocument).find(":endEqual("+o._text+")").length>1){
      if(_data._label==o._text){
        _data._label=""
      }else if(_data._headers.length && _data._headers[_data._headers.length-1]._text==o._text){
        _data._headers.pop()
      }
      o._text="";
    }

    var _priorityItems=o._priorityItems||"", p=_cssHandler._cssToDesc(o._main);
    var cp=[],_css=[],_tag=_cssHandler._nameMap[p[0]];
    if(_tag){
      _tag=_tag._css
    }
    for(var i=1;i<p.length;i++){
      var v=p[i]
      if(v[0]!="{"){
        cp.push({_type:"element",_value:v,_css:_cssHandler._nameMap[v]._css});
      }else{
        v=v.substring(1,v.length-1)
        if(_cssHandler._isPriorityElementItem(v)){
          _priorityItems+=v;
        }else if(!v.match(/[0-9]+/)){
          _css.push({_type:"element",_css:[v]})
        }
      }
    }
    //give an empty value for loop
    _css.unshift(0);
    var _best,pps=[];
    for(var i=0;i<_css.length;i++){
      var c=_css[i];
      
      var _hasText=0;
      if(c){
        pps=pps.concat(cp.concat([]))
        if(_data.ee==1 || (c._css && _data.ee && _data.ee.length>1 && $(c._css[0]).find(_data.ee).length<_data.ee.length)){
          pps.unshift(c)
        }else{
          continue;
        }
      }

      if(!pps.length && !_data.ps.length || _tag){
        pps.push({_type:"element",_value:p[0],_css:_tag||[p[0].substring(1,p[0].length-1)]});
        if(o._text&&_simple!=4){
          _hasText=1;
          pps.unshift({_type:"text",_value:o._text});
        }
      }else if(o._text&&_simple!=4){
        _hasText=1;
        pps.unshift({_type:"text",_value:o._text});
      }
      if(_priorityItems){
        pps.push({_type:"element",_css:[_priorityItems]})
        _priorityItems=0
      }
      if(!pps.length){
        continue;
      }
      if(_data.ee && _data.ee.bzTmp && _data.ee.bzTmp.toString().endsWith(",0")){
        if(!_hasText){
          continue;
        }else{
          if(o._text.match(/^\[.+\|.+\]$/)){
            _data.ee.bzTmp.splice(1,0,_data.e.tagName+":RowCol("+o._text+")");
          }else{
            _data.ee.bzTmp.splice(1,0,_data.e.tagName+":Contains("+o._text+")");
          }
          break;
        }
      }
      pps=pps.concat(_data.ps);
      if(_css.length>1&&!i&&(!o._text||o._text.length<3||$.isNumeric(o._text))){
        continue
      }
      if(_doIt()){
        break
      }
    }
    _doFinal()
    if(_simple!=4&&_data.oe!=_data.ee&&o._text&&_data.oe.tagName!="CANVAS"&&!_cssHandler._isInShadowDom(_data.oe)){
      if(!pps.find(x=>{return x._type=="text"})){
        pps.unshift({_type:"text",_value:o._text});
      }
      _doIt()
      _doFinal()
    }
    if(_data.e.tagName!="BODY"){
      _data.e=_data.e.parentNode;
    }
    
    function _doIt(){
      _descAnalysis._clearTmpPath();
      let _root=_cssHandler._getRoot(e)
      if(!_root.bzTmp){
        _root.bzTmp=_cssHandler._getDocPath(_root);
      }
      var ee=_descAnalysis._findElement(pps,_root,0,_cssHandler._isCheckboxOrRadio(_data.oe),_data.oe);
//    console.log("_findPath --> _descAnalysis._findElement "+_data.oe.bzTmp);
      if(_data.oe.tagName=="BODY"){
        ee=_data.oe;
        ee.bzTmp=[_data.oe.bzTmp[0],"BODY",0]
      }
      if(ee && ee.bzTmp && ee!==_data.oe){
      }else if(ee && !ee.bzTmp && ((ee.is && !ee.is(_data.oe))||(ee.includes && !ee.includes(_data.oe)))){
      }else if(ee && (ee.bzTmp || (ee.length && (!_best || _best.es.length>ee.length)))){
        _best={es:ee,pp:pps};
        if(_best.es.bzTmp){
          if(_cssHandler._inTag(_data.e,"TR")){
            _best.es=[_best.es];
          }
          return 1;
        }
      }
    }
    
    function _doFinal(){
      if(_best && _best.es && (_data.ee==1 || _best.es.bzTmp || _data.ee.length>_best.es.length || (_data.ee.length==_best.es.length && o._text && (o._text==_data._label||(_data._headers.length && o._text==_data._headers[_data._headers.length-1]._text))))){
        _data.ps=_best.pp;
        _data.ee=_best.es;
      }
    }
  },
  _inTag:function(e,t){
    return e && e.parentNode && e.tagName!=="BODY" && (e.parentNode.tagName==t || this._inTag(e.parentNode,t))
  },
  _getDocPath:function(_doc){
    if(_doc==BZ.TW.document){
      return "BZ.TW.document"
    }else if(_doc.host&&_doc.host.constructor!=String){//shadow dom
      let ps="";
      if(_doc.host.bzTmp){
        ps=_doc.host.bzTmp
        if(ps.constructor==String){
          ps=ps.split("\n")
        }
      }else{
        ps=_cssHandler._findPath(_doc.host);
      }
      let id=ps.pop();
      if(!$.isNumeric(id)){
        ps.push(id)
        if(ps.length==1){
          let r=_Util._getElementRoot(_doc.host);
          if(r.bzTmp&&r.bzTmp.constructor==String){
            r.bzTmp=r.bzTmp.split("\n")
          }
          var v=_Util._clone(r.bzTmp);
          v.push(ps[0])
          ps=v
        }
        let os=_Util._findDoms(ps)
        id=os.indexOf(_doc.host)
      }
      let r=ps.shift();
      
      return "BZ.TW.document\n"+ps.join("\n").trim()+":eq("+(id||0)+")"+"\nshadowRoot"
    }
    var fs=$(BZ.TW.document).find('IFRAME');
    for(var i=0;i<fs.length;i++){
      if(fs[i]==_doc.defaultView.frameElement){
        var c=""
        if(!fs[i].src.startsWith("http")){
          c=".body";
        }
        return "$(BZ.TW.document"+c+").find('IFRAME:eq("+i+")')[0].contentDocument";
      }
    }
  },
  _isInputElementPath:function(e){
    for(var i=e.length-1;i<e.length;i--){
      let v=e[i]
      if(v.constructor==String){
        return _Util._isInputTag((v.match(/input/i)||[])[0])
      }
    }
  },
  /*
    To find element all features.
    e: current element
    ie: ignore element, last element parent
    oe: orignal element
  */
  _findAttributes:function(_data){
    var e=_data.e||_data.oe,oe=_data.oe,fs=0,ho=0,_noLabel=!_data._label,_headerLevel=_data._headers.length;
    
    if(oe!=e){
      fs=parseInt($(oe.ownerDocument.body).css("font-size"))
    }else{
      fs=this._getFontSize(e,oe);
    }
    
    var g={_text:""};
    this._findCss(e,g)
    if(oe==e){
      //Old button (input button)
      if(_data._stopLabel){
      }else if(e.tagName=="CANVAS"){
        if(e.bzTxtElement){
          g._text=e.bzTxtElement.t
        }
      }else if(_Util._isInputButton(e)){
        g._text=e.value;
      }else{
        if(!_Util._isInputObj(e)){
          _setHeader(_data,fs,g)
          if(!g._text){
            if(_data.e.tagName=="TD"){
              g._text=this._getRowColDesc(_data.e);
            }
          }
          
          if(!g._text){
            g._text=_cssHandler._filterText(_cssHandler._findInnerWords(_data.e,1)||_cssHandler._findInnerWords(_data.e))
          }
        }
        if(!g._text){
          g._text=this._findTitleAttribute(e)
        }
      }
      if(!_data._headers.length && !_Util._isInputObj(e)){
        _data._label=g._text;
      }else if(g._text && oe.placeholder==g._text){
        if(_cssHandler._isInPlaceholderForm(oe)){
          _data._label=g._text
        }
      }
      //_data.oeCss=_cssHandler._getElementCss(_data.oe)

    }else if(!_data._label && !_data._stopLabel){
      var p=_cssHandler._getParentSelect(e);
      if(!p){
        _setLabel(_data,g);
        if(_data._stopLabel && !g._text){
          if(_data._stopLabel){
            _data._label=_cssHandler._findTitleAttribute(_data.oe)
          }
          _setHeader(_data,fs)
          if(_data._headers[0] && _data._headers[0]._text==_data._label){
            _data._headers.pop()
          }
        }
        if(_data._label && _data.oe.placeholder && _data.oe.placeholder.length<_data._label.length){
          _data._label=_data.oe.placeholder;
          g._text=""
          _data._stopLabel=1
          _data.lCss=0
        }
      }
      _setHeader(_data,fs)
    }else if(e.tagName=="BODY"){
    }else if(_data.e.tagName=="TR" && _data._label && _data._label.match(/^(.+)\|(.+)$/)){
    }else{
      if(_data.e.tagName=="TD"){
        g._text=this._getRowColDesc(_data.e);
//        if(!_data._label && g._text){
      }
      if(g._text){
        _data._label=g._text.match(/^\[(.+)\|(.+)\]$/);
        if(_data._label){
          _data._label=_data._label[1]+"|"+_data._label[2]
        }else{
          _data._label=g._text
        }
        _data._stopHeader=1
      }else{
        if(!_Util._isInputObj(oe)){
          _setHeader(_data,fs,g)
        }
        if(!g._text){
          _setHeader(_data,["TR","TD","TH","LI"].includes(_data.e.tagName) || _data.oe.tagName=="IMG"?0:fs,g)
        }
      }
    }
    _data.ie=e;
    _data._result=g;

    if(_data.oe==_data.e){
      
    }else if(_noLabel && _data._label){
    }else if(_data._stopHeader){
    }else if(_data._headers.length==_headerLevel && _data.e.tagName!="BODY"){
      /*
      if(_data.ee.length){
        let t=_getText(_data)
        if(t){
          _data._result._text=t;
          return
        }
      }
      */
      if(_data.e.parentElement){
        _data.e=_data.e.parentNode;
        return _cssHandler._findAttributes(_data)
      }
    }
    function _setLabel(_data,g){
      var l=_cssHandler._findLabel(_data);
      if(l){
        _data._label=g._text=l.w;
        _data.lCss=_cssHandler._getElementCss(l.e)
      }
    }
    /*
    function _getText(_data){
      if(_data._result._main.length==1){
        let t=_Util._filterTxt(_data.e.innerText.toLowerCase());
        if(t){
          for(var i=0;i<_data.ps.length;i++){
            if(_data.ps[i]._type=="text"&&_data.ps[i]._value==t){
              return
            }
          }
          return t.substring(0,100)
        }
      }
    }
    */
    function _setHeader(_data,fs,g){
      if(_data._stopHeader||(_data._headers&&_data._headers.length)){
        return
      }
      var ho=_cssHandler._findHeader(_data,fs);
      if(ho && ho.t){
        var dw=_aiWordHandler._isLookingWord(ho.t,"v");
        if(dw && dw.EXTRA){
          var _break;
          if(!_IDE._data._curTest||(!_IDE._data._curTest._data.actions.length&&!BZ._isRecording())){
            return
          }
          for(var i=0;i<dw.EXTRA.length;i++){
            var ww=dw.EXTRA[i]
            if(ww.m!=_IDE._data._curModule._data.code||(ww.t!=_IDE._data._curTest._data.code&&ww.t)){
              _break=1
            }else{
              _break=0
              break
            }
          }
          if(_break){
            return
          }
        }
        var _css=_cssHandler._getHeaderCss(ho.e[0]||ho.e),_diff;
        
        if(_data._headers.length){
          var _last=_data._headers[_data._headers.length-1];
          for(var k in _last._css){
            if(_css[k]!=_last._css[k] && (!_css[k]||!_last._css[k]||(_last._css[k].toString()!=_css[k].toString()))){
              _diff=1
              break
            }
          }
          if(!_diff){
            for(var k in _css){
              if(_css[k]!=_last._css[k] && (!_css[k]||!_last._css[k]||(_last._css[k].toString()!=_css[k].toString()))){
                _diff=1
                break
              }
            }
          }
          if(!_diff){
            return
          }
        }
        if(g){
          g._text=ho.t;
        }
        _data._headers.push({_text:ho.t,e:ho.e,_css:_css});
      }
    }
  },
  _isInPlaceholderForm:function(e){
    
    e=e.parentNode;
    var os=$(e).find("INPUT")
    if(os.length>1){
      var n=0
      for(var i=0;i<os.length;i++){
        var o=os[i]
        if(!o.placeholder && !["button","image","submit","checkbox","radio","reset"].includes(o.type)){
          return 
        }else if(o.placeholder){
          n++
        }
      }
      if(n>1){
        return 1
      }
    }
    if(!e||e.tagName=="BODY"){
      return
    }
    return _cssHandler._isInPlaceholderForm(e)
  },
  _findInnerWords:function(e,_ignoreIconWord){
    if(_ignoreIconWord){
      if(this._isIcon(e)){
        return ""
      }
    }
    if(["SVG","TEXTAREA","SELECT","IMG"].includes(e.tagName.toUpperCase())){
      return ""
    }
    var es=e.childNodes,w=""
    for(var i=0;i<es.length;i++){
      e=es[i];
      if(e.nodeType==1){
        if(!_Util._isHidden(e)){
          var ww=this._findInnerWords(e,_ignoreIconWord);
          if(ww.trim()){
            w=ww.trim()
            break
          }
        }
      }else if(e.nodeType==3){
        var t=_Util._pickTextFromNode(es,i)
        i=t.i;
        if(t.t.length>w.length){
          w=t.t
        }
      }
    }

    
    return w
  },
  _isList:function(c,_forField){
    var _last,_hasMenu;
    if(c.tagName=="SELECT" || !c.children || !c.children.length){
      return;
    }else if(c.children.length<2){
      return _cssHandler._isList(c.children[0])
    }
    
    if(c.className && c.className.constructor==String){
      var vs=_glossaryHandler._splitWord(c.className);
      if(vs.includes("menu")){
        _hasMenu= 1;
      }
    }
    let dd=new Set(),os=[];
    for(let o of c.children){
      if(_Util._isHidden(o)){
        continue;
      }
      if(!_forField&&["TR","TD"].includes(o.tagName)){
        return;
      }
      var r=o.getBoundingClientRect();
      if("HR"==o.tagName || (r.height<=5 && _hasMenu)){
        continue;
      }
      var cc=[]
      if(o.className && o.className.constructor==String){
        cc=o.className.split(" ").filter(x=>x);
      }
      let w=$(o).find(":endEqual(/.+/)").toArray()
      w=w.map(x=>{
        return {x:x,s:parseInt($(x).css("fontSize"))}
      })
      w.sort((a,b)=>a.s-b.s)
      w=w.pop()
      if(!w){
        return
      }
      if(_last){
        if(_last.t!=o.tagName){
          return;
        }else if(_last.r.left==r.left && Math.abs(_last.r.bottom-r.top)>20){
          return;
        }else if(_last.r.top==r.top && Math.abs(_last.r.right-r.left)>20){
          return;
        }else{
          if(_last.c.length && cc.length){
            var d=_Util._getDiffArray(_last.c,cc);
            d.forEach(x=>{
              dd.add(x)
            })
            if(dd.size>2){
              return;
            }
          }
        }
      }
      _last={r:r,c:cc,t:o.tagName,s:w.s,o:w.x};
      os.push(_last)
    }
    if(os.length>1){
      return os.map(x=>x.o)
    }
  },
  _hasList:function(c){
    if(this._isList(c)){
      return 1
    }
    for(var i=0;i<c.children.length;i++){
      if(this._hasList(c.children[i])){
        return 1;
      }
    }
  },
  //e: element, oe: org element
  _getFontSize:function(e,oe){
    if(["A","BUTTON","INPUT","LABEL"].includes(e.tagName) && e==oe){
      return 0
    }else if(_cssHandler._isIcon(e)){
      return 0;
    }
    if(e.textContent.trim()){
      var w1=parseInt($(e.ownerDocument.body).css("font-weight"));
      var w2=parseInt($(e).css("font-weight"));
      var w3=parseInt($(oe).css("font-weight"));
      var c1=_Util._getBackgroundColor(e);
      var c2=_Util._getBackgroundColor(oe);
      return parseInt($(e).css("font-size"))+(w2>w1 && (w2>w3||c2!=c1)?0.5:0);
    }
    return 0;
  },
  /*
    pe: element,
    fs: min font size
    ie: ignore element
    _bRight: check element right words (checkbox and radio is 1)
  */
  _findHeader:function(_data,fs,_passInput){
    if(_data.e==_data.oe){
      return {}
    }
    var _isInput=_Util._isInputObj(_data.oe)
    let e=_data.ie||_data.oe
    let oer=e.getBoundingClientRect()
    
    for(let o of _data.e.children){
      if(o==e){
        return {}
      }else{
        let t=$util.getElementText(o)
        if(t&&!_Util._isHidden(o)){
          let r=o.getBoundingClientRect()
          if(r.top<oer.top&&r.left<oer.left){
            return {e:o,t:t}
          }
        }
      }
    }
    /*
    var _css=_cssHandler._keyMap.subHeading._css+","+_cssHandler._keyMap.mainHeading._css;
    
    var _children=$(_data.e.children).filter(":visible")
    if(_cssHandler._isList(_data.e)){
      var hs=0
      var a=$(_children[0]).find(_css).filter(":visible").length
      var b=$(_children[1]).find(_css).filter(":visible").length
      if(a==b || (a && b)){
        return {}
      }
    }
    var _ignores=[]
    for(var i=0;i<_children.length;i++){
      var e=_children[i]
      if(_data.ie==e){
        break
      }
    }
    _ignores=$(_ignores)
    var _headers=$(_data.e).find(_css).filter(":visible")
    
    if(_data.e.tagName.toUpperCase()=="SVG"){
      return {};
    }

    var w={fs:fs||0,ts:[]};
    for(var i=0;i<_headers.length;i++){
      var h=_headers[i]
      if($(_data.ie).find(h)[0]){
        break
      }
      if(_ignores.find(h)[0]){
        continue
      }
      var hr=h.getBoundingClientRect();
      if(hr.top-oer.top>300){
        break
      }else if(hr.top>oer.top && _data._headers && _data._headers.length){
        break
      }else if(hr.top>oer.bottom && _isInput){
        break
      }
      if(!w.ts || !w.ts.length || hr.top>=oer.top){
        var f=this._getFontSize(h,_data.oe);
        if(!w.fs || w.fs<f){
          //w={fs:f,ts:[{e:h,t:$(h).text()}]}
          w=this._findHeader({oe:_data.oe,e:h},w.fs)
        }
      }
    }
    if(w.ts && w.ts.length){
      var _found=0;
      for(var i=0;_data._headers && i<_data._headers.length;i++){
        if(_data._headers[i]._text==w.ts[0].t){
          _found=1
          break
        }
      }
      if(!_found){
        return {e:$(w.ts[0].e),t:w.ts[0].t}
      }
    }else{
      if(_data._headers && _data._headers.length){
        w={fs:Math.max(_data._headers[_data._headers.length-1].fontSize,fs)||0,ts:[]};
      }else{
        w={fs:fs||0,ts:[]};
      }
    }
    var _inCell=["A","BUTTON"].includes(_data.oe.tagName) && ($(_data.oe).find(_data.e).length || _data.oe==_data.e)
    var _startImage,_lastRect;
    var _inDataTable=_data.e.tagName=="TR" && ["editorTable","dataTable"].includes(_cssHandler._getTableType(_data.e.parentElement.parentElement));
    
    for(var i=0;i<_data.e.childNodes.length;i++){
      var e=_data.e.childNodes[i];
      if(e.nodeType==1 && !$(e).is(":visible")){
        continue
      }
      if(e.tagName=="TR" && (i || e.children.length>1)){
        break;
      }else if(["BUTTON","INPUT","IMG","SVG"].includes(e.tagName)){
        continue
      }
      if(e.nodeType==1){
        if(e==_data.ie){
          if(!w.ts || w.ts.length){
            break;
          }
          continue;
        }
        if(["DIV","P","FIELDSET"].includes(e.tagName)){
          var er=e.getBoundingClientRect();
          if(er.top-oer.top>300){
            break
          }else if(er.top>oer.bottom && _isInput){
            break
          }
          if((oer.width/2)+oer.left<er.left){
            continue
          }
        }
        var os=_Util._findInputs(e);
        if(os.length){
          if($(e).find("input[type=checkbox],input[type=radio]").length<os.length){
            var fs=$(e).find("input");
            var _hasSeach=0
            for(var m=0;m<fs.length;m++){
              var f=fs[m].placeholder;
              if(f && f.match(_dictionaryHandler._getRegexValueByKey("search"))){
                _hasSeach=1
              }
            }
            if(!_hasSeach){
              break;
            }
          }
        }
      }
      if(this._isButton(e) || _Util._isInputObj(e)){
        _passInput=1;
      }
      if(e.nodeType==3){
        if(_data.e==_data.oe && _data.oe.childNodes.length==1){
          return {}
        }
        var f=this._getFontSize(_data.e,_data.oe);
        var t=_Util._pickTextFromNode(_data.e.childNodes,i)
        i=t.i
        t=this._filterText(t.t)
        if(!_passInput || parseInt($(_data.e).css("font-weight"))>parseInt($(_data.e.ownerDocument.body).css("font-weight"))){
          if(t.length==1 && f>w.fs){
            f=w.fs;
          }
          if(t && f==w.fs && (_data.e==_data.oe || (_data.oe && $(_data.oe).find(_data.e).length))){
            w.ts.push({e:_data.e,t:t});
          }else if(t && f>w.fs){
            w.fs=f;
            w.ts=[{e:_data.e,t:t}];
          }
        }
      }else if(e.nodeType==1 && !_Util._isHidden(e) && (_Util._positionAfterElement(_data.oe,e)||!w.ts.length) && !_cssHandler._isIcon(e)){
        var nw;
        if(e.nextElementSibling && ($(e.nextElementSibling).find(_data.oe).length) && (_cssHandler._hasList(e.nextElementSibling)|| _Util._isForm(e.nextElementSibling))){
          nw=this._findHeader({e:e,oe:_data.oe},0,0);
        }else{
          nw=this._findHeader({e:e,oe:_data.oe},w.fs,_passInput);
        }
        
        if(nw.t){
          if(!_inCell && e.getBoundingClientRect){
            var _rect=e.getBoundingClientRect();
            if(_lastRect){
              if(!_Util._isInputObj(e) && _lastRect.top==_rect.top && _lastRect.height==_rect.height){
                if(!_inDataTable){
                  return {}
                }
              }
            }
            _lastRect=_rect;
          }
        }
        
    //not label level
    if(_data.ps && w.ts){
      var _best={};
      if(_startImage && _startImage.t){
        w.ts.unshift(_startImage)
      }
      if(!_inCell && !_inDataTable && w.ts.length>1){
        return {}
      }
      for(var i=0;i<w.ts.length;i++){
        var t =w.ts[i];
        if(!_inCell && !_inDataTable && !t){
          return {}
        }
        var n=$(_data.e.ownerDocument).find(_data.e.tagName+":Contains("+t.t+")");
        if(!_best.n || _best.n.length>n.length){
          _best={n:n,t:t.t,e:t.e};
          if(n.length==1){
            break;
          }
        }
      }
      return _best;
    }
    return w;
    */
  },
  _isIcon:function(e){
    return $(e).css("font-family").includes("Material Icons")
  },
  _findLabel:function(_data){
    var e=_data.e,_label,_labelE,_labelElement;
    var r=_data.oe.getBoundingClientRect();
    
    if(_data.oe.id&&!_data.oe.id.match(/[^a-zA-Z0-9:]/)){
      var t=$("[for="+_data.oe.id.replace(/:/g,"\\:")+"]")[0]
      if(t && $(e).find(t).length){
        var w=$(t).text().trim()||_cssHandler._findTitleAttribute(t);
        if(w){
          _data._stopLabel=1
          return {w:w,e:t}
        }
      }else if(t){
        return
      }
    }
    var _bRight=["checkbox","radio"].includes(_data.oe.type);
    if(e.innerText && e.innerText.trim()){
      var _bStart=!_bRight;
      for(var i=0;i<e.childNodes.length;i++){
        var c=e.childNodes[i];
        if(c.nodeType==1 && !$(c).is(":visible")){
          continue
        }
        if(c==_data.ie){
          if(_bStart){
            return _label||_cssHandler._getRightLabel(c)
          }
          _bStart=1
        }else if(_bStart){
          var v="";
          var o=e.childNodes[i-1];
          if(c.nodeType==1 && _Util._isHidden(c)){
            continue;
          }
          _labelE=0
          if(c.nodeType==1 && c.innerText && c.innerText.trim()){
            v=_cssHandler._handleContainText(_cssHandler._findLabelText(c,_bRight,_data.oe));
            _labelE=c
          }else if(c.nodeType==3){
            var t=_Util._pickTextFromNode(e.childNodes,i);
            i=t.i
            v=_cssHandler._handleContainText(t.t);
            _labelE=e
          }
          v=_Util._removeEndSign(v);
          var cc=this._hasInput(c);
          if(!_bRight){
            if(cc){
              _label="";
              _data._stopLabel=1
            }else if(v){
              if(_cssHandler._isLabel(_data.oe,c,_bRight)){
                if(c.nodeType==1&&_data.oe.type!="file"){
                  var rr=c.getBoundingClientRect();
                  if(_label && rr.top<r.top && rr.bottom-rr.height/2<r.top && rr.left-30>r.left){
                    continue
                  }
                }
                _label={w:v,e:_labelE};
              }else{
                _data._stopLabel=1;
              }
            }
          }else{
            if(!cc){
              if(_cssHandler._isLabel(_data.oe,c,_bRight)){
                _label={w:v,e:_labelE};
              }else{
                _data._stopLabel=1;
              }
            }
            break;
          }
        }
      }
    }
    return _label;
  },
  _getRightLabel:function(c){
    let p=c.parentElement
    let o=c.nextElementSibling
    if(p.children.length==2&&o&&_cssHandler._isTextElement(o)){
      let t=_Util._pickTextFromNode([o],0);
      return {w:t.t,e:o}
    }
  },
  _isTextElement:function(c){
    if(!c.children.length){
      return 1
    }else if(c.children.length==1){
      return _cssHandler._isTextElement(c.children[0])
    }
  },
  _isLabel:function(o,c,_bRight){
    if(c.nodeType==1){
      if($(c).find(o).length||o.type=="file"){
        return 1;
      }
      var p=_cssHandler._getParentSelect(o);
      if(p){
        o=p;
      }
      var r1=o.getBoundingClientRect(),r2=c.getBoundingClientRect();

      if(_bRight){
        return r2.left>r1.right && r2.top<r1.bottom && r2.bottom>r1.top
      }else if(r2.right<=r1.left){
        //label left and input right
        return r2.top<r1.bottom && r2.bottom>r1.top;
      }else if(r2.bottom-r1.top<5 && r1.top-r2.bottom<15){
        //label up and input down
        r2=r2.bottom-parseInt($(c).css("padding-bottom"))
        return r1.top-r2<25;
      }else if(r1.left>=r2.left&&r1.right<=r2.right&&r1.top>=r2.top&&r1.bottom<=r2.bottom){
        return 1
      }else{
        return;
      }
    }
    return 1;
  },
  _hasCheckboxOrRadio:function(e){
    if(e.nodeType==1){
      var c=_cssHandler._keyMap.checkbox._css+","+_cssHandler._keyMap.radio._css;
      return $(e).is(c) || $(e).find(c).length;
    }
  },
  _hasInput:function(e){
    if(e.nodeType==1){
      return _cssHandler._findAllInputs(e).length;
    }
  },
  _getInputCss:function(){
    var c=_cssHandler._inputCss;
    if(!c){
      _IDE._data._curVersion.setting.objectLib.element.forEach(function(v){
        if(v.key=="input"){
          c=_cssHandler._inputCss=v.css
        }
      })
    }
    
    let cc=_IDE._data._setting.content.aiApp;
    if(cc&&cc.customize.length){
      cc=cc.customize.join(",")
      cc=cc.replace(/,+/g,",").replace(/,$/,"")
      if(cc){
        c+=","+cc
      }
    }
    return c
  },
  _retrieveFontInfo:function(e){
    return {
      size:$(e).css("font-size"),
      weight:$(e).css("font-weight"),
      color:$(e).css("color"),
      family:$(e).css("font-family"),
    }
  },
  _getUniqueClass:function(e){
    let cs=[],_primary=[]
    for(var i=0;i<e.classList.length;i++){
      var m=e.classList[i]
      if(_cssHandler._isPriorityElementItem(m)){
        _primary.push(m)
        cs=0
      }else if(!_primary.length){
        var mc=m.match(/[^a-zA-Z-_]/)
        if(!m.match(/[^a-z-_\$]/i)&&!_cssHandler._isIgnoreClass(m)){
          cs.push(m)
        }
      }
    };
    cs=cs||_primary
    cs.sort((a,b)=>{
      return b.length-a.length
    })
    let _best,_bestClass;
    cs.find(x=>{
      let v=$("."+x).length
      if(!_best||_best>v){
        _best=v
        _bestClass=x
      }
      if(v==1){
        return 1
      }
    })
    return _bestClass
  },
  _findCss:function(e,g){
    g._priorityItems=""
    var _list=[e.tagName];
    if("BODY"!=e.tagName){
      if(e.classList){
        let cs=_cssHandler._getUniqueClass(e)
        if(cs){
          _list.push("."+cs);
        }
      }
      if(e.id && e.id.match && !e.id.match(/[0-9]/)){
        _list.push("#"+e.id.replace(/([^a-zA-Z0-9_-])/g,"\\$1"))
      }
      if(_Util._isStdInputElement(e) && e.tagName!="SELECT" && e.type){
        _list.push("[type="+e.type+"]")
      }else if(_Util._isInContentEditable(e)){
        _list.push("[contenteditable=true]")
      }
      
    }
    g._main=_list;
  },
  _isCustomizeInputCss:function(e){
    var os=_cssHandler._getCustomizeInputs(),v={},c;
    for(var i=0;i<os.length;i++){
      var o=os[i];
      v={_name:o.name}
      c=(o.toggle||o.panel||[]).join(" ")
      if($(e).is(c)){
        return 1
      }else if(o.value){
        c=o.value.join(" ")
        if($(e).is(c)){
          return 1
        }
      }
    }
  },
  _getCustomizeInputCss:function(e){
    var os=_cssHandler._getCustomizeInputs(),v={},c;
    let t=_IDE._data._curTest,a;
    if(t&&t._data.actions){
      a=_IDE._data._curAction
      if(a&&a.event&&a.event._customize){
        a=a.event._customize._name
      }else{
        a=0
      }
    }
    for(var i=0;i<os.length;i++){
      var o=_Util._clone(os[i]);
      if(a&&o.name!=a){
        continue
      }
      v={_name:o.name}
      if(!o.toggle){
        continue
      }
      
      c=(o.toggle||o.panel)
      let c1=c[0].replace(_Util._attrRegex,":attr($1=*)").replace(/(\$label|\$header)/,"*")
      c=c.join(" ")
      if($(e).is(c1)||$(c1).is(e)||$(c1).find(e).length){
        v._head=1
        v._css=c
        return v
      }
      for(var j=0;j<o.steps.length;j++){
        c=o.panel.concat(o.steps[j].element)
        var cc=c.pop()
        if(!$.isNumeric(cc)){
          c.push(cc)
        }
        let cx=c.join(" ")
        var _format=cx.match(/\$[0-9]+/),_value
        if(_format){
          _format=_format[0]
          _value=_cssHandler._filterText(e.innerText)
          c.forEach((cv,i)=>{
            c[i]=cv.replace(/\$[0-9]+/,_value)
          })
        }
        let ee=_getMatchElement(e,c)
        
        if(ee){
          v._step=j
          v._target=ee
          v._format=_format
          v._value=_value
          let _last=o.steps[o.steps.length-1]
          if(j==o.steps.length-1||(j==o.steps.length-2&&(!_last.element||!_last.element.length))){
            v._end=1
            if(!_value||_format!=o.format){
              v._fullValue=_retrieveFullValue(o.steps,o.format,o.panel,e.ownerDocument)
            }
          }
          return v
        }
      }
      if(v._head){
        return v
      }
    }
    
    function _getMatchElement(e,c){
      let cs=$(c[0]).toArray()
      let css=[],oe=e
      cs.forEach(x=>{
        if(!_Util._isHidden(x)){
          css.push(x)
        }
      })
      cs=css
      c.shift()
      c=c.join(" ")
      while(e&&e.tagName!="BODY"&&cs.length){
        let co=cs.find(ci=>{
          if((ci==e||$(ci).find(e)[0])&&(!c||$(ci).find(c)[0])){
            if(c){
              let cc=$(ci).find(c).toArray()
              if(cc.find(ccc=>{
                if(_Util._isOverlapping(ccc,oe)){
                  return 1
                }
              })){
                return 1
              }
            }else{
              return 1
            }
          }
        })
        if(co){
          return oe
        }
        e=e.parentElement
      }
    }
    function _retrieveFullValue(_steps,_value,_panel,_doc){
      _steps.forEach(function(v,i){
        if(v.event.type=="change"&&v.event.value.match(/\$[0-9]+/)){
          var p=_Util._clone(v.element)
          p=_panel.concat(p)
          p.unshift(_doc)
          var u=$util.findDom(p)
          if(u){
            let vv;
            if(u.tagName=="SELECT"){
              vv=u.selectedOptions[0].text
            }else{
              vv=u.value
            }
            if(vv!==undefined){
              _value=_value.replace(v.event.value,vv)
            }
          }
        }
      })
      return _value
    }
  },
  _getCustomizeGroupByElementPath:function(p,_customizeName){
    var os=_cssHandler._getCustomizeInputs();
    for(var i=0;i<os.length;i++){
      if(os[i].name==_customizeName){
        return os[i]
      }
      let t=os[i].toggle,m=0
      if(t){
        for(var j=1;j<p.length;j++){
          if(p[j].includes){
            if(p[j].match(new RegExp(t[m].replace(/([\.\:\(\)])/g,"\\$1").replace("$label",".+").replace("$header",".+")))){
              m++
            }
          } 
        }
        if(m==t.length){
          return os[i]
        }
      }
    }
  },
  _findTitleAttribute:function(e){
    var t="";
    for(var i=0;i<e.attributes.length;i++){
      var a=e.attributes[i];
      var _name=a.name;
      var v=a.value.trim();
      if(!v||v=="null"|| _Util._isDynamicValue(v)){
        continue
      }
      if("placeholder"==_name){
        t=v;
        if(_cssHandler._isInPlaceholderForm(e)){
          break
        }
      }else if(_name.match(/title|label/)){
        t=v;
        break
      }else if("alt"==_name){
        t=v;
        if(e.tagName=="IMG"){
          break
        }
      }else if("name"==_name && !t && v && !v.match(/[0-9]/)){
        t=v;
      }else{
        continue;
      }
    }
    
    return t;
  },
  _handleContainText:function(v){
    v=v.trim().split(/[\n\t\r\*$]/);
    var m="";
    for(var i=0;i<v.length;i++){
      var vv=v[i].trim();
      if(vv.length>m.length){
        m=vv;
      }
    }
    
    return m;
  },
  _getPanel:function(oe,e){
    if(oe.tagName=="BODY"){
      return oe;
    }
    if(!e){
      return this._getPanel(oe,oe.parentElement);
    }
    if(e.tagName!="BODY"){
      var p=e.parentElement;
      var _pBGColor=$(p).css("background-color");
      var _eBColor=$(p).css("border-color");
      var _eBWidth=parseInt($(e).css("border-width"))||0;
      var _eBGColor=$(e).css("background-color");
      if((_pBGColor!=_eBGColor && _eBGColor!="rgba(0, 0, 0, 0)") || (_eBWidth && _eBColor!=_eBGColor && _eBColor!="rgba(0, 0, 0, 0)")){
        return e;
      }
      return this._getPanel(oe,p);
    }
    return e
  },
  _findLabelText:function(nd,_first,oe){
    var t="";
    if(!_first){
      var ro=oe.getBoundingClientRect();
      var rn=nd.getBoundingClientRect();
      if(rn.bottom<ro.top){
        _first=true;
      }
    }
    
    for(var i=0;i<nd.childNodes.length;i++){
      var n=nd.childNodes[i];
      if(n.nodeType==3){
        var tt=_Util._pickTextFromNode(nd.childNodes,i)
        i=tt.i
        t=this._filterText(tt.t)||t;
      }else if(n.nodeType==1 && n.innerText && n.innerText.trim()){
        if(!_cssHandler._isButton(n)){
          t=this._findLabelText(n,_first,oe)||t
        }
      }else{
        continue;
      }
      if(_first && t){
        return t;
      }
    }
    return t;
  },
  _getCssByType:function(t){
    var d=this._typeCss
    if(!d){
      d=this._typeCss={}
    }
    if(!d[t]){
      switch(t){
        case "checkbox":
          d[t]="INPUT[type=checkbox]";
          break
        case "radio":
          d[t]="INPUT[type=radio]";
          break
        case "select":
          d[t]="SELECT";
          break
        case "input":
          d[t]="";
      }

      var os=_cssHandler._getCustomizeInputs();
      for(var i=0;i<os.length;i++){
        var o=os[i]
        if(t==o.type){
          d[t]+=","+(o.toggle||o.panel||[]).join(" ")
        }
      }
      if(t=="input"){
        d[t]=d[t].substring(1)
      }
    }
    return d[t]
  },
  _filterText:function(v){
    var vs=(v||"").trim().split(/[\*\n\[\]\,\(\)\}\{\:\|]/),_max="";
    for(var i=0;i<vs.length;i++){
      v=vs[i].trim()
      if(v.length>_max.length){
        if(v.length>=5){
          return v
        }
        _max=v
      }
    }
    return _max;
  },
  _findSimilar:function(n,c){
    var v={n:_cssHandler._nameMap[n],c:""},vs=[];
    if(v.n && v.n._css.includes(c)){
      v.c=c;
      v.n=n;
      return [v];
    }else if(v.n){
      v.n=n;
      vs=[v];
      v={}
    }
    for(var k in _cssHandler._nameMap){
      var o=_cssHandler._nameMap[k]._css;
      if(o.includes(c)){
        v.n=k;
        v.c=c;
        vs.push(v)
        v={}
      }
    }
    if(vs.length==1 && !vs[0].n){
      vs=[]
    }
    return vs;
  },
  _isButton:function(e){
    var es=$(e.ownerDocument).find(_cssHandler._keyMap.button._css);
    return es.is(e);
  },
  //frame,form,editor,data,dataForm
  _getTableType:function(e){
    let v=_cssHandler._findDefinitedElement(e,"table");
    if(v&&v[0]==e){
      return _cssHandler._hasInput(e)?"editorTable":"dataTable"
    }

    var _buttonCss=_cssHandler._keyMap.button._css,_hasHeader;
    if(!e||!e.tagName=="TABLE"){
      return;
    }
    var _tableRect=e.getBoundingClientRect();
    var _bodyHeight=e.ownerDocument.body.scrollHeight
    if(e.ownerDocument.body.scrollHeight-_tableRect.height<20 && e.ownerDocument.body.scrollWidth-_tableRect.width<20){
      return "frame";
    }
    
    var _form=_data=_editor=0,trs=$(e).find("tr");
    var _lastTr="";
    
    for(var i=0;i<trs.length;i++){
      var tr=trs[i];
      var tds=tr.children;
      var _curTr="";

      if($(tr).text().trim()){
        for(var m=0;m<tds.length;m++){
          var td=tds[m];
          if($(td).find(_buttonCss).length){
            if(_Util._findInputs(td).length){
              _curTr+="i"
            }else{
              _curTr+="b"
            }
          }else if(_Util._findInputs(td).length){
            _curTr+="i"
          }else if(td.tagName=="TH"){
            _curTr+="h"
          }else{
            _curTr+=$(td).text().trim()?"t":"o";
          }
        }
        if(_curTr.length>1){
          var t=_curTr.replace(/h|t/g,"");
          if(!t){
            var hs=_curTr.match(/h/g);
            if(hs && hs.length>2){
              _hasHeader=1
            }
            _data++;
          }else if(_curTr.endsWith("b")){
            var is=_curTr.match(/i/g);
            is=is?is.length:0;
            if(is>1 || (is==1 && !$(tr).find("input[type=check]").length)){
              _editor++;
            }else{
              _data++;
            }
          }else if(_curTr.match(/ht|tt|hh|th/g)){
            _data++;
          }else if(_curTr.match(/^ii+|^hii+|^tii+/)){
            _data++;
            _form++;
          }else if(["hi","ti"].includes(_curTr.substring(0,2))){
            _form++;
          }else if(_curTr.includes("b")){
            if(_curTr!=_lastTr){
              _form++;
            }
          }else if(_lastTr.length!=_curTr.length){
            _form++;
          }
        }
      }else if($(tr).find("input").length>0){
        _form++;
      }
      
      _lastTr=_curTr;
    }
    if(_form>_data){
      return _form>_editor && !_hasHeader?"form":"editorTable"
    }else{
      if(_form>_editor && _data-_form<3){
        return "dataForm"
      }
      return _data>_editor?"dataTable":"editorTable"
    }
  },
  _getEnableTDs:function(tr){
    var tds=[]
    _Util._filterOutHidden(tr.children,tds)
    return tds;
  },
  _getRowColDesc:function(e){
    try{
      var r=e.parentElement;//tr
      var t=r.parentElement.parentElement; //table
      var tt=this._getTableType(t);
      if(!["dataTable","dataForm","editorTable"].includes(tt)){
        return;
      }
      var hs=$(t).find("tr:eq(0) th");
      r=this._getEnableTDs(r)
      if(hs.length<2){
        hs=this._findTableOuterHeader(t,r);
        if(!hs){
          hs=this._getEnableTDs($(t).find("tr:eq(0)")[0]);
        }
      }else{
        hs=this._getEnableTDs(hs[0].parentElement);
      }
      if(hs.length!=r.length){
        if(this._getColCountWidth(hs)!=this._getColCountWidth(r)){
          return
        }
      }
      var h=hs[r.indexOf(e)]
      if($(h).text() && (h.tagName!=e.tagName || parseInt($(h).css("font-size"))>parseInt($(e).css("font-size")) || $(h).css("font-weight")!=$(e).css("font-weight"))){
        var m=0,_best;
        for(var i=0;i<r.length;i++){
          var c=r[i];
          if(c!=e){
            var tx=_cssHandler._filterText($util.getElementText(c));
            if(!tx){
              continue;
            }
            var n=$(t).find(c.tagName+":Contains("+tx+")").length
            if(n && (!m || n<m)){
              _best=tx;
              m=n;
            }
          }
        }
        if(_best){
          return "["+_best.trim().replace(/\|/g,"\\|")+"|"+$util.getElementText(h)+"]"
        }
      }
    }catch(ex){}
  },
  _getColCountWidth:function(cs){
    var n=0;
    for(var i=0;i<cs.length;i++){
      var c=cs[i];
      if(c.colspan){
        n+=parseInt(c.colspan)||1
      }else{
        n++;
      }
    }
    return n
  },
  _findTableOuterHeader:function(t,r){
    if(t.parentElement.children.length>1){
      return
    }
    var tp=t.parentElement.getBoundingClientRect()
    var hs=[],_diff=0;
    for(var i=0;i<r.length;i++){
      var d=r[i];
      var dp=d.getBoundingClientRect()
      var h=t.ownerDocument.elementFromPoint((dp.left+dp.right)/2,tp.top-20)
      var hp=h.getBoundingClientRect();
      if(hp.width-dp.width>30){
        return
      }else{
        while(dp.width-hp.width>30){
          h=h.parentElement;
          hp=h.getBoundingClientRect()
        }
        if(hp.tagName=="TD" && hp.parentElement.parentElement.children.length>1){
          return;
        }
        if(Math.abs(dp.width-hp.width)>10){
          _diff++;
        }
        hs.push(h)
      }
    }
    return hs
  },
  _isInput:function(e){
    var b=["INPUT","TEXTAREA","SELECT"].includes(e.tagName) && !["image","button","reset","submit"].includes(e.type)
    return b||_cssHandler._isDefinitedCustomizeInput(e)
  },
  _getInputMsg:function(o,_css){
    let p=o.parentElement,_final=0
    while(p){
      let os=_cssHandler._findAllInputs(p)
      if(_final&&os.length>_final-1){
        return
      }
      
      _final=os.includes(o)?os.length-1:os.length
      
      let _success=_css.success?$(p).find(_css.success):0,
          _error=$(p).find(_css.error),
          _msg={};
      if(_success&&_success[0]){
        _msg._success=_success.toArray()
      }
      
      if(_error[0]){
        _error=_error.toArray();
        for(var i=0;i<_error.length;i++){
          var eo=_error[i]
          if(_Util._isHidden(eo)){
            _error.splice(i--,1)
          }
        }
        if(_error[0]){
          _msg._error=_error
        }
      }
      
      if(_msg._error){
        let _txt=""
        if(!_final){
          for(var i=0;i<_msg._error.length;i++){
            _txt=_getTxt(_msg._error[i],_txt)
          }
        }else{
          for(var i=0;i<_msg._error.length;i++){
            let oo=_findCloserInput(_msg._error[i],os)
            if(oo.includes(o)){
              _txt=_getTxt(_msg._error[i],_txt)
            }
          }
        }
        if(!_txt){
          _txt={}
        }
        return _txt
      }else if(_msg._success){
        return
      }
      p=p.parentElement
    }
    function _getTxt(o,tt){
      var t=$(o).text().trim()||_cssHandler._getElementTitle(o)
      if(t.length>tt.length){
        tt=t
      }
      return tt
    }
    function _findCloserInput(m,os){
      var mr=m.getBoundingClientRect();
      let oo=[]
      for(var n=0;n<os.length;n++){
        let r=os[n].getBoundingClientRect();
        if(mr.bottom>r.top){
          for(var q=0;q<oo.length;q++){
            let rr=oo[q].getBoundingClientRect()
            if(r.top>=rr.bottom){
              oo.splice(q--,1)
            }else if(rr.top>=r.bottom){
              r=0
              break
            }
          }
          if(r){
            oo.push(os[n])
          }
        }
      }
      return oo
    }
  },
  _getActionMsgCss:function(a,_checkType){
    let _css={
      success:a.lineSuccess,
      error:a.lineError||"[class*=error],[class*=fail],[class*=warn]"
    }
    if(_checkType&2){
      _css={
        success:a.finalSuccess,
        error:a.finalError||_css.error
      }
    }
    return _css;
  },
  /*
  * _setting:
  *     _area,
  *     _cssMap(error,success,info),
  *     _data({dataName:{_element:[],_css:"",_type:"error/success/info",_value:""}})
  */
  _checkFillFormMsg:function(_setting,_fun){
    if(bzTwComm._isIDE()){
      bzTwComm._postToExt({_fun:"_checkFillFormMsg",_scope:"_cssHandler",_args:[_setting,_fun],_element:_setting.element});
      return
    }
    
    let _area=$(BZ.TW.document)
    if(_setting.element){
      var o=$util.findDom(_setting.element)
      if(o){
        _area=$(o)
      }
    }
    if(_setting._data){
      for(var k in _setting._data){
        var d=_setting._data[k],_css=0;
        var _curInput=_Util._getElementByQuickPath(d.qpath);
        let os=_Util._getVisibleElements(_area,d._lineErrCss||d._sumErrCss);

        if(os.length){
          if(d._lineErrCss){
            os=_getMatchElement(_area,os,_curInput)
            if(os){
              os=_getMatchMsg([os],d,_curInput)
            }
          }
        }else{
          os=0
        }
        d._result=!!os
        if(!d._type){
          d._result=!d._result
        }
      }
    }else{
      //work on final success
      
      let os=_Util._getVisibleElements(_setting._css)
      _setting._data={_result:1}
    }
    _fun(_setting._data)
    
    function _getMatchElement(_area,os,o){
      _area=$(_area).find("*")
      let _list=_area.toArray()
      _Util._spliceAll(_list,x=>{
        return x.tagName=="OPTION"
      })
      for(var i=0;i<os.length;i++){
        var _idx=_list.indexOf(os[i])
        var p=_Util._getShareParent(os[i],o)
        var us=_cssHandler._findAllInputs(p)
        var _min={_idx:null};
        for(var n=0;n<us.length;n++){
          var ii=Math.abs(_list.indexOf(us[n])-_idx)
          if(_min._idx===null||_min._idx>ii){
            _min._idx=ii
            _min._obj=us[n]
          }
        }
        if(_min._obj==o){
          return os[i]
        }
      }
    }
    
    
    function _isTopMsg(_area,_msg,_inputs){
      _area=_area.find("*")
      var mi=_area.index(_msg)
      for(var i=0;i<_inputs.length;i++){
        if(mi>_area.index(_inputs[i])){
          return
        }
      }
      return 1
    }
    function _getMatchMsg(_msgElements, _data,_inputElement){
      var s=_inputElement.parentElement,
          w=_data._msg,_foundMsg,
          _found=[]
      
      if(_msgElements&&_setting._checkType&2){
        if(!w){
          return 1
        }else{
          _msg=$util.getElementText(_msgElements)
          if(_msg){
            if(_chkMsg(_msg,w,_data)){
              return 1
            }
          }
        }
      }
      while(!_found.length&&s.tagName!="BODY"){
        let os=$(s).find(_msgElements);
        for(let i=0;i<os.length;i++){
          let o=os[i]
          if(_cssHandler._isCloserElement(_inputElement,o)){
            _found.push(o);
          }
        }
        s=s.parentElement
      }
      if(_found.length&&!w){
        return 1
      }
      for(var i=0;i<_found.length;i++){
        var _msg=$util.getElementText(_found[i])
        if(w&&!_msg){
          _msg=_cssHandler._getElementTitle(_found[i])
        }
        if(_msg){
          if(_chkMsg(_msg,w,_data)){
            return 1
          }
        }
      }
      return _foundMsg
    }
    
    function _chkMsg(_msg,w,_data){
      _foundMsg=!w||_Util._includesWordWithoutSign(_msg,w)
      if(_msg!=w){
        _data._updateMsg=_msg
      }else{
        _data._updateMsg=""
        return 1
      }
    }
  },
  _isCloserElement:function(o,c){
    var os=$(o.ownerDocument.body).find("*")
    var oi=os.index(o),
        ci=os.index(c),
        or=o.getBoundingClientRect(),
        cr=c.getBoundingClientRect();
    if(ci<oi){
      return _cssHandler._isCloserElement(c,o)
    }
    for(var i=oi+1;i<ci;i++){
      var oo=os[i];
      if(!$(oo).find(c).length){
        oor=oo.getBoundingClientRect()
        if(or.bottom<=oor.top&&oor.bottom<=cr.top&&($util.getElementText(oo)||_Util._isInputObj(oo))){
          return
        }
      }
    }
    return 1
  },
  _chkNoElement:function(ts,_fun){
    if(bzTwComm._isIDE()){
      bzTwComm._postToExt({_fun:"_chkNoElement",_scope:"_cssHandler",_args:[ts,_fun],_element:ts.element});
      return
    }
    
    let _area=$(BZ.TW.document)
    if(ts.element){
      var o=$util.findDom(ts.element)
      if(o){
        _area=$(o)
      }
    }    
    let os=_Util._getVisibleElements(_area,ts._css);
    _fun(t) 
  },
  _isElementReady:function(ts,_fun){
    if(bzTwComm._isIDE()){
      bzTwComm._postToExt({_fun:"_isElementReady",_scope:"_cssHandler",_args:[ts,_fun],_element:ts.ts[0]});
      return
    }
    var rs=[],_withElement=ts._withElement
    ts=ts.ts
    ts.forEach(t=>{
      var s=""

      t=$util.findDom(t)
      if(!t||_Util._isOpacity(t)){
        t=0
      }else if(t&&t.tagName=="INPUT"){
        if(!["text","number","date"].includes(t.type)||!t.value){
          s="empty"
        }
      }else if(t&&t.tagName=="TEXTAREA"&&!t.value){
        s="empty"
      }else if(t&&t.tagName=="SELECT"){
        s="empty"
      }
      t=t&&!t.disabled&&!$(t).attr("readonly")&&!_Util._isHidden(t)?"enable":!t||_Util._isHidden(t)?"":"disable"
      if(_withElement){
        rs.push({
          _withElement:_withElement,
          _value:t+s
        })
      }else{
        rs.push(t+s)
      }
    })
    _fun(rs)
  },
  _cleanCache:function(a,_fun){
    if(bzTwComm._isIDE()){
      bzTwComm._postToExt({_fun:"_cleanCache",_scope:"_cssHandler"});
      return
    }
    _timingInfo._end();
    _cssHandler._lastAllInputs=_cssHandler._lastAllInputsMap=0
    _fun()
  },
  _findNewInputsPath:function(a,_fun){
    if(bzTwComm._isIDE()){
      bzTwComm._postToExt({_fun:"_findNewInputsPath",_scope:"_cssHandler",_args:[a,_fun],_element:a?a.element:0});
      return
    }
    var _area=a?$util.findDom(a.element):0
    let os=_cssHandler._findAllInputs(_area),vs=[];
    _area=_area?$(_area):0;
    
    _cssHandler._lastAllInputs=_cssHandler._lastAllInputs||[]
    _cssHandler._lastAllInputsMap=_cssHandler._lastAllInputsMap||{}
    
    for(var i=0;i<os.length;i++){
      var o=os[i]
      if(!_cssHandler._lastAllInputs.includes(o)){
        _cssHandler._lastAllInputs.push(o)
        if(!_area||_area.find(o).length){
          var p=_cssHandler._findPath(o);
          _cssHandler._lastAllInputsMap[p.join(" ")]=o;
          vs.push(p)
        }
      }
    }
    _fun(vs);
  },
  _findInputByLabel:function(_panel,_name){
    if(_panel.constructor==Array){
      _panel=$util.findDom(_panel)
    }
    if(!_panel||_Util._isHidden(_panel)){
      return
    }
    _name=_name.replace(/_/g," ")
    
    let os,o,w,e,
        cs=_cssHandler._getCustomizeInputs()||[],
        ns=_name.split("=>")
        ns[1]=ns[1]||ns[0]
    //check in customize inputs
    if(cs.find((c,j)=>{
      let cc=[]
      c.toggle.forEach(ci=>{
        cc.push(ci.replace("$header",ns[0]).replace("$label",ns[1]))
      })
      e=$(_panel).find(cc.join(" "))[0]
      if(e){
        cc.unshift("BZ.TW.document")
        cc.push(0)
        e._bzPath=cc
        return e
      }
    })){
      return e
    }
    
    var ls=_IDE._data._curVersion.setting.content.contentAttribute.split("|")
    for(var i=0;i<ls.length;i++){
      var l=ls[i]
      os=$(_panel).find(":attr("+l+"="+_name+")").toArray()
      if(os.length){
        break
      }
    }
    
    if(!os.length){
      os=_Util._getTargetElement($(_panel).find(":endContains("+_name+")"))
    }
    if(!os.length){
      return
    }
    for(var i=0;i<os.length;i++){
      var v=$util.getElementText(os[i])
      if(_name==v){
        o=os[i]
        break
      }else if(!w||w.length>v.length){
        o=os[i]
      }
    }
    e=o
    while(o!=_panel.parentElement){
      os=_cssHandler._findAllInputs(o)
      if(!os.length){
        if(o.tagName=="LABEL"){
          if(o.htmlFor){
            os=$(os).find("#"+o.htmlFor)
            if(os.length){
              return os[0]
            }
          }
        }
        o=o.parentElement
      }else{
        if(os.length==1){
          return os[0]
        }else{
          var oo=$(o).find("*")
          var ei=oo.index(e),_readonly
          for(var i=0;i<os.length;i++){
            if(os[i].readOnly){
              _readonly=os[i]
            }else if(oo.index(os[i])>ei){
              if(!i){
                return os[i]
              }else if(os[i-1].type=="checkbox"){
                return os[i-1]
              }
              return os[i]
            }else if(i==os.length-1){
              return os[i]
            }
          }
          if(_readonly){
            return _readonly
          }
        }
        
        break
      }
    }
    
  },
  _findAllInputs:function(e,_noReadonly,_includeHidden){
    let _body=document.body
    
    e=e||$(_body).find(":bz($form)")[0]||_body
    var cs=_cssHandler._getInputCss();
    
    var vs=_Util._findInputs(e,$(":bz($form)").find(e)[0]),os=[];
    let _skip=$(":bz($skip)")
    for(var i=0;i<vs.length;i++){
      var v=vs[i];
      if(_skip.find(v)[0]){
        continue
      }
      if(($(v).attr("disabled")||$(v).attr("readonly"))&&_noReadonly){
        continue
      }
      if(!_Util._isHidden(v)||(_includeHidden&&["checkbox","radio"].includes(v.type))){
        os.push(v);
      }
    }
    if(!os.length){
      os=$(e).find(cs).toArray()
    }
    if(!os.length){
      if($(e).is(cs)){
        os.push(e)
      }
    }
    return os
  },
  //a: element, e: target css
  _findCloseElement:function(a,e){
    e=e.join(" ")
    while(!$(a).find(e).length&&a.tagName!="BODY"){
      a=a.parentElement
    }
    return $(a).find(e)[0]
  },
  _getOutestCover:function(e){
    let r=e.getBoundingClientRect();
    while(e.tagName!="BODY"){
      let pr=e.parentElement.getBoundingClientRect()
      if(pr.width<=r.width+50&&pr.width>=r.width&&pr.height<=r.height+20&&pr.height>=r.height&&pr.left<r.left+10&&pr.left>=r.left-50){
        e=e.parentElement
      }else{
        return e
      }
    }
  },
  //e:element path, c: customize
  _getCustomizeElement:function(e,c){
    if(c&&c.customize){
      let a=_cssHandler._getCustomizeInputs().find(o=>{
        return o.name==c.customize
      })
      if(a){
        let ee=_Util._clone(a.toggle)
        ee.forEach((v,i)=>{
          if(c.$label&&v.includes("$label")){
            ee[i]=v.replace("$label",c.$label)
          }
          if(c.$label&&v.includes("$header")){
            ee[i]=v.replace("$header",c.$label)
          }
        })
        ee.unshift(e[0])
        if($.isNumeric(e[e.length-1])){
          ee.push(e[e.length-1])
        }else{
          ee.push(0)
        }
        e=ee
      }
    }
    return e
  },
  //a:arround element
  //e:target element
  _findCloserElement:function(a,e,_fun){
    var x=$(a).find(e)
    if(x.length){
      return _fun(x[0])
    }
    _domActionTask._mouseoverItems(a,e,_fun)
  },
  _getParentSelect:function(e){
    var _css=_cssHandler._keyMap.dropdownList._css.split(",");
    for(var i=0;i<_css.length;i++){
      var o=$(BZ.TW.document).find(_css[i]);
      if(o.is(e).length ){
        return e;
      }else if(o.find(e).length){
        for(var n=0;n<o.length;n++){
          if($(o[n]).find(e).length){
            return o[n]
          }
        }
      }
    }
  },
  _isSelectOption:function(p,e){
    p=p.getBoundingClientRect();
    e=e.getBoundingClientRect();
    return p.top>=e.bottom || p.bottom<=e.top
  },
  _isDropdownlist:function(e){
    return e.tagName=="SELECT" || this._isLookingForElement(_cssHandler._keyMap.dropdownList._css,e);
  },
  _isCheckboxOrRadio:function(e){
    if(e.tagName=="INPUT" && ["checkbox","radio"].includes(e.type)){
      return 1;
    }
  },
  _getElementScope:function(e,_style){
    if($(e).is(_style)){
      return e
    }
    let r=e.getBoundingClientRect(),p=e,_txt=(e.innerText||"").trim(),pp=e
    while(p=p.parentElement){
      if(["BODY"].includes(p.tagName)){
        return pp
      }
      pp=p
      if(_style){
        if(!$(p).is(_style)){
          e=p
        }else{
          return p
        }
      }else{
        if((p.innerText||"").trim()==_txt||!_txt){
          for(var i=0;i<p.children.length;i++){
            let c=p.children[i]
            if(c!=e){
              c=c.getBoundingClientRect()
              if(c.width&&c.height&&(Math.abs(c.top-r.top)>20||Math.abs(c.bottom-r.bottom)>20)){
                return e
              }
            }
          }
          e=p
          if(!_txt){
            _txt=(p.innerText||"").trim()
          }
        }else{
          break
        }
      }
    }
    return _style?0:e
  },
  //////////////////////////////////////////
  //
  // analysis element css
  //
  //////////////////////////////////////////
  _getElementCss:function(e,_pickSubElement){
    if(!e){
      return
    }
    var c=e.className && e.className.constructor==String?e.className:"";
    c=new Set(c.match(/[^ ]+/g));
    if(e.id && !_Util._isDynamicValue(e.id)){
      c.add("#"+e.id)
    }
    if(!_pickSubElement){
      var cs=[...c];
      c={
        css:_filter(cs),
        eType:_cssHandler._getElementType(e)
      }
      if(!c.eType){
        c.tag=e.tagName
      }
      if(e.children.length==1 || ["A","BUTTON","LABEL","SPAN"].includes(e.tagName) || $(e).is(_IDE._data._curVersion.setting.content.clickableElements)){
        var ss=new Set();
        for(var i=0;i<e.children.length;i++){
          var v=_cssHandler._getElementCss(e.children[i],1);
          ss=new Set([...ss,...v])
        }
        if(ss.size){
          c.subCss=_filter([...ss])
        }
      }
    }else if(e.children.length==1 || ["SPAN","I"].includes(e.tagName)){
      for(var i=0;i<e.children.length;i++){
        var v=_cssHandler._getElementCss(e.children[i],1);
        c=new Set([...c,...v])
      }
    }
    if(c.css){
      _Util._spliceAll(c.css,x=>{
        return _cssHandler._isIgnoreClass(x)
      })
      c.css.sort(function(a,b){
        return b.length-a.length
      })
    }
    return c
    
    function _filter(cs){
      var cc=[]
      for(var i=0;i<cs.length;i++){
        if(cs[i][0]=="#"){
          cc.push(cs[i])
        }else if(!_Util._isDynamicValue(cs[i])){
          cc.push("."+cs[i])
        }
      }
      return cc
    }
  },
  _getElementTitle:function(e){
    var ws=new Set()
    for(var i=0;i<e.attributes.length;i++){
      var a=e.attributes[i]
      
//      if(a.name.toLowerCase().match(/(^|_|-)(title|label|placeholder|alt|name)($|_|-)/)){
      if(a.name.toLowerCase().match(new RegExp("(^|_|-)("+_IDE._data._setting.content.contentAttribute+")($|_|-)"))){
        var v=(a.value||"").trim()
        if(v && !_Util._isDynamicValue(v)){
          ws.add(a.value)
        }
      }
    }
    if(ws.size){
      ws=[...ws]
      ws.sort(function(a,b){return a.length>b.length?1:-1})
      return ws[0]
    }
    return ""
  },
  _getHeaderCss:function(oe){
    var e=oe,ts=[oe.tagName],f=_cssHandler._getFontSize(oe,oe);
    
    while(e.parentElement && (e.parentElement.tagName.match(/h[0-9]/) || e.parentElement.children.length==1)){
      e=e.parentElement
      if(!ts.includes(e.tagName)){
        ts.unshift(e.tagName)
      }
    }
    while(!e.className && e!=oe){
      e=e.children[0]
    }
    e=this._getElementCss(e)
//    e.tag=ts
    e.fontSize=f;
    return e
  },
  _findDefinitedElement:function(e,t){
    var es=_IDE._data._curVersion.setting.objectLib.element
    for(var i=es.length-1;i>=0;i--){
      var ee=es[i];
      if(!t||t==ee.key||(ee.data&&ee.data.type==t)){
        if($(e).is(ee.css)){
          if(t){
            return [e]
          }else{
            return {_elements:[e],_define:ee}
          }
        }else{
          var os=$(e).find(ee.css).toArray();
          for(var n=0;n<os.length;n++){
            if(_Util._isHidden(os[n])){
              os.splice(n,1)
            }
          }
          if(os.length){
            if(t){
              return os
            }else{
              return {_elements:os,_define:ee}
            }
          }
        }
      }
    }
  },
  _getElementDefinition:function(e,t){
    var es=_IDE._data._curVersion.setting.objectLib.element
    for(var i=es.length-1;i>=0;i--){
      if((!t||es[i].data.type==t)&&$(e).is(es[i].css)){
        return es[i]
      }
    }
  },
  _getDefinitionAttrInElement:function(e,t,a){
    var es=_IDE._data._curVersion.setting.objectLib.element
    for(var i=es.length-1;i>=0;i--){
      var o=es[i].data;
      if(o.type==t&&$(e).is(es[i].css)){
        return $(e).find(o[a].join(","))
      }
    }
  },
  _getElementType:function(e){
    e=_cssHandler._getElementDefinition(e)
    return e?e.key:""
  },
  _getInputTypeFromElementPath:function(ps){
    if(ps){
      for(var i=ps.length-1;i>0;i--){
        var p=(ps[i]+"").toLowerCase().replace(/"/g,"'");
        if(p.startsWith("input") && p.includes("[type=checkbox]")){
          return "checkbox"
        }else if(p.startsWith("input") && p.includes("[type=radio]")){
          return "radio"
        }
      }
    }
  },
  _isPanel:function(e){
    let r=e.getBoundingClientRect()
    if(r.width>200&&r.height>=150){
      return e.innerText
    }
  }
};var _descAnalysis={
  _syntaxMap:0,
  _syntaxKey:0,
  _syntaxList:0,
  _syntaxGroup:0,
  /*
  _contentKey={
    "new":{
      //use _value link with _cssHandler._nameMap
      _value:"new",
      _type:"element",
      _key:"add", 
    }
  }
  */
  _contentKey:0,
  _contentList:0,
  _contentGroup:0,
  _elementMap:0,
  _setting:0,
  _keyboardMap:{
    enter:13,tab:9,space:32,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,home:36,end:35,pageup:33,pagedown:34,arrowleft:37,arrowup:38,arrowright:39,arrowdown:40,capslock:20,esc:27,escape:27,insert:45,"delete":46
  },
  _codeToDesc:function(v,_simple){
    if(v){
      if(_simple){
        if(_Util._isFileData(v)){
          v=JSON.parse(v)
          return v[0].name+" ("+Math.ceil(v[0].size/1024)+"K)"
        }
        v=_JSHandler._formatInsertCodeToDisplay(v);
      }
      return '('+v+')';
    }
    return ""
  },
  _getDescOfElement:function(a){
    if(a.customize){
      return (a.$label||a.$header||"")+" "+a.customize
    }
    a=_descAnalysis._getCurLanguageElement(a.element||a.panel)
    
    return _descAnalysis._getDescFromPath(a,1)
  },
  _getCurLanguageElement:function(e){
    if(BZ._data._uiSwitch._curAppLanguage){
      let ee=[],
          wi=_IDE._data._setting.appLanguages.indexOf(BZ._data._uiSwitch._curAppLanguage)-1
      
      e.forEach((v,i)=>{
        if(v&&v.constructor==String){
          let w=_descAnalysis._retrieveTextForElementPathItem(v)
          let ww=_appWordHandler._wordMap[w]
          if(ww&&ww[wi]){
            ee.push(_descAnalysis._replaceElementWord(v,w,ww[wi]))
          }else{
            ee.push(v)
          }
        }else{
          ee.push(v)
        }
      })
      return ee
    }
    return e
  },
  //v:element path
  //w:old word
  //ww:new word
  _replaceElementWord:function(v,w,ww){
    let vv=v.split(w)
    if(vv.length>2){
      for(var i=0;i<vv.length-1;i++){
        let t=""
        vv.forEach((x,j)=>{
          t+=x
          if(j==i){
            t+=ww
          }else{
            t+=w
          }
        })
        t+=vv[vv.length-1]
        if(_descAnalysis._retrieveTextForElementPathItem(t)==ww){
          return t
        }
      }
    }else{
      return v.replace(w,ww)
    }
  },
  _getDescFromPath:function(ps,_simple){
    if(!ps){
      return
    }
    var s="",_customizeIdx=0;
    var g=_cssHandler._getCustomizeGroupByElementPath(ps)
    if(g&&g.toggle.length>1){
      let v=_filterForCustomize("toggle",ps)
      if(!v){
        v=_filterForCustomize("value",ps)
      }
      ps=v.ns
      _customizeIdx=v._customizeIdx
    }
    
    if(ps[0]&&ps[0].constructor==String&&!ps[0].includes("BZ.TW")){
      ps=_Util._clone(ps)
      ps.unshift("BZ.TW.document")
    }
    
    for(var i=1;i<ps.length;i++){
      var p1=ps[i];
      if(p1.constructor==String){
        p1=p1.replace(/:eq\([0-9]+\)$/,"")
      }
      if(i==ps.length-1 && $.isNumeric(p1)){
        if(!_simple && p1+""!=="0"){
          s+=" {"+p1+"}";
        }
      }else{
        if(_simple){
          p1=_JSHandler._formatInsertCodeToDisplay(p1)
        }
        var cs=_generateDesc(_cssHandler._cssToDesc(_cssHandler._parseItems(p1)),i==ps.length-1);
        if(_customizeIdx==i){
          cs+=" "+g.name
        }
        if(_simple && cs.match(/\"|\$(parameter|parentModule|test|module|project|loop|data)/)){
          var ss=cs.match(/(\"[^"]+\")( \"[0-9]+\")+/)
          if(ss){
            s=ss[1]
          }else{
            s=cs
          }
        }else if(!_simple || !s){
          s+=cs
        }
      }
    }
    return s.trim();
    
    function _filterForCustomize(k,ps){
      try{
        var ns=_Util._clone(ps),
            _customizeIdx=0
        g[k].forEach(function(v,i){
          for(var j=_customizeIdx;j<ns.length;j++){
            if(ns[j].includes(v)){
              if(i){
                ns.splice(j,1)
                break
              }else{
                ns[j]=ns[j].replace(v,"")
                _customizeIdx=j+1
                break
              }
            }
          }
        })
        if(_customizeIdx){
          _customizeIdx--
        }
        return {
          ns:ns,
          _customizeIdx:_customizeIdx
        }
      }catch(e){}
    }
    
    function _generateDesc(ss,_lastIdx){
      var cs=""
      if(ss[0] && ss[0][0]=="{"){
        if(_lastIdx){
          if(ss.length>2 || (ss.length==2 && ss[1][0]!='"')){
            ss.splice(0,1);
          }else{
            ss.push(ss.shift())
          }
        }else if(ss.length>1){
          ss.splice(0,1);
        }
      }else if(ss.length>1){
        ss.push(ss.shift())
      }
      
      for(var i=0;i<ss.length;i++){
        if(ss[i][0]=='"'){
          ss.unshift(ss.splice(i,1));
        }
      }
      
      var _last=""
      for(var n=0;n<ss.length;n++){
        //Merge two css blocks
        if(_last[0]=="{" && ss[n][0]=="{" && !ss[n][0].match(/^{[0-9]+}$/)){
          cs=s.substring(0,s.length-1)+ss[n].substring(1)
        }else{
          cs+=" "+ss[n];
        }
        _last=ss[n]
      }
      return cs
    }
  },
  _init:function(){
    var es=_bzMessage._syntax;
    if(!this._syntaxList||!this._syntaxList.length){
      this._syntaxList=[];
      this._syntaxKey={};
      this._syntaxGroup={};
      this._syntaxMap={};
      for(var k in es){
        this._syntaxGroup[k]=[]
        this._syntaxMap[k]={}
        for(var kk in es[k]){
          var t=es[k][kk];
          this._addKey(t,kk,k,this._syntaxKey,this._syntaxList,this._syntaxGroup,this._syntaxMap);
        }
      }
      this._syntaxList.sort(function(a,b){
        return a.length<b.length;
      });

      es=_bzMessage._syntaxOption;
      this._syntaxOptionKey={};
      this._syntaxOptionList=[];
      this._syntaxOptionGroup={};
      this._syntaxOptionMap={};
      for(var k in es){
        this._syntaxOptionGroup[k]=[]
        this._syntaxOptionMap[k]={}
        for(var kk in es[k]){
          var t=es[k][kk];
          this._addKey(t,kk,k,this._syntaxOptionKey,this._syntaxOptionList,this._syntaxOptionGroup,this._syntaxOptionMap);
        }
      }
      this._syntaxOptionList.sort(function(a,b){
        return a.length<b.length;
      });
      
    }
    
    this._contentKey={
      "$project":{_value:"$project",_type:"data"},
      "$module":{_value:"$module",_type:"data"},
      "$test":{_value:"$test",_type:"data"},
      "$loop":{_value:"$loop",_type:"data"},
      "$parameter":{_value:"$parameter",_type:"data"},
      "$data":{_value:"$data",_type:"data"},
    };
    this._contentList=["$project","$module","$test","$loop","$parameter","$data"];
    this._contentGroup={data:["$project","$module","$test","$loop","$parameter","$data"]}
    this._contentMap={data:{"$project":["$project"],"$module":["$module"],"$test":["$test"],"$loop":["$loop"],"$parameter":["$parameter"],"$data":["$data"]}}
    es=_bzMessage._syntaxExtra;
    for(var k in es){
      this._contentGroup[k]=[];
      this._contentMap[k]={}
      for(var kk in es[k]){
        var t=es[k][kk];
        this._addKey(t,kk,k,this._contentKey,this._contentList,this._contentGroup,this._contentMap);
      }
    }
    var os=_IDE._data._curVersion.setting.objectLib;
    this._elementMap={};
    this._contentGroup.element=[];
    this._contentMap.element={}
    for(var k in os){
      es=os[k];
      for(var i=0;i<es.length;i++){
        var e=es[i];
        this._elementMap[e.key]=e;
        v=(e.value||_bzMessage._setting._objectLib._options[k][e.key]||"").toLowerCase();
        this._addKey(v,e.key,"element",this._contentKey,this._contentList,this._contentGroup,this._contentMap)
      }
    }

    this._contentList.sort(function(a,b){
      return a.length<b.length;
    });
    
    return 1;
  },
  _clearTmpPath:function(_includeShortCut){
    if(window._BZDocumentsHandler){
      _BZDocumentsHandler.each(function(i,d){
        _doIt(d)
      });
    }else{
      _doIt(document)
    }
    function _doIt(d){
      $(d).find("*").filter(function(i,e){
        e.bzTmp=e.bzParent=0;
        
        if(_includeShortCut){
          delete e.bzShortCut;
          delete e.bzQuick
        }
      });
    }
  },
  _addKey:function(v,k,t,_kMap,_kList,_kGroup,_map){
    if(!v){
      return
    }
    var vs=v.split("/");
    _map[t][k]=vs;
    for(var i=0;i<vs.length;i++){
      v=vs[i];
      if(_kMap[v]){
        return 0
      }else{
        _kMap[v]={_value:v,_type:t,_key:k};
        _kGroup[t].push(v);
        
        _kList.push(v);
      }
    }
    return 1;
  },
  _mergeExpr:function(es){
    for(var i=0;i<es.length;i++){
      e=es[i];
      if(e._type=="element" && e._css && e._css[0] && e._css[0][0]==":"){
        for(var n=i+1;n<es.length;n++){
          var ee=es[n];
          if(ee._type=="element"){
            ee._css=this._mergePath(e._css,ee._css);
            es.splice(i--,1);
            break;
          }
        }
      }
    }
  },
  _mergePath:function(ps1,ps2){
    var ps=[];
    for(var i=0;i<ps1.length;i++){
      var p1=ps1[i];
      for(var ii=0;ii<ps2.length;ii++){
        var p2=ps2[ii];
        if(":.#[".includes(p1[0])){
          ps.push(p2+p1)
        }else if(":.#[".includes(p2[0])){
          ps.push(p1+p2);
        }else{
          ps.push(p2);
        }
      }
    }
    return ps;
  },
  _findFinalElement:function(cs,_root){
    if(!cs._element){
      return;
    }
    var e=this._findElement(cs._element,_root,["typing","check","set","uncheck"].includes(cs._action._key),cs._action._key.includes("check")),_first,ee;
    if(e && !e.bzTmp){
      for(var i=0;i<e.length;i++){
        if(!_Util._isHidden(e[i])){
          ee=this._findElementIdx(e[i]);
          if(!cs._action || cs._action._key!="click" || $(ee).css("cursor")=="pointer"){
            return ee;
          }
          if(!_first){
            _first=ee;
          }
        }
      }
      if(_first){
        return _first;
      }
    }
    return e;
  },
  _getAICssData:function(e,_path,_label){
    var d={HH:[]},_tag,_css;
    for(var i=_path.length-1;i>=1;i--){
      var p=_path[i]
      
      if(!$.isNumeric(p)){
        var t=_descAnalysis._retrieveTextForElementPathItem(p);
        if(!e){
          _tag=p.split(/[\:\.\#]/)[0];
          _css=p.split(":")[0].match(/[\.\#][^\.\#]+/g)
          if(_css){
            _css.sort(function(a,b){return b.length-a.length})
          }
        }
        if(_label && _label==t && d.LL){
          d.LL.id=i
        }
        if(!d.LL){
          if(t){
            d.LL={}
          }
          if(d.LL){
            d.LL.id=i;
            if(e){
              d.LL.C=_cssHandler._getElementCss(e)
            }else{
              d.LL.C={
                tag:_tag,
                css:_css
              }
            }
          }
        }else{
          if(t){
            if(e){
              var os=$(":endEqual("+t+")");
              if(os.length==1){
                os=os[0];
                os=_cssHandler._getHeaderCss(os)
                delete os.fontSize
                os.id=i
                d.HH.push(os)
              }
            }else{
              d.HH.push({
                tag:_tag,
                css:_css,
                id:i
              })
            }
          }
        }
      }
    }
    return d;
  },
  /*
  es:element path
  _root: like: BZ.TW.document or iframe
  _bSet: The search is for a set value on an input
  _bLeft: a label is at left of an input
  */
  _findElement:function(es,_root,_bSet,_bLeft,_orgElement){
    var e,_cssIdx,_reTry;
    for(var i=0;i<es.length;i++){
      e=es[i];
      if(!e._type){
        es.splice(i--,1);
      }else if(e._css&&e._css.length>1){
        e._css.forEach(function(v,j){
          es.splice(i,j?0:1,{_type:"element",_css:[v]})
        })
      }
    }
    for(var i=0;i<es.length;i++){
      e=es[i];
      if(e._type=="element" && e._css && e._css[0] && e._css[0].match(/^[0-9]+$/)){
        _cssIdx=parseInt(e._css[0]);
        es.splice(i,1);
      }else if(e._type=="text"){
        e._code=e._value
        e._value=window._JSHandler?_JSHandler._prepareData(e._value):e._value
      }
    }
    
    if(_bSet){
      var _bInput=0;
      for(var i=0;i<es.length;i++){
        e=es[i];
        if(e._type=="element" && ["input","textarea","select","dropdownList","checkbox","radio"].includes(e._key)){
          _bInput=1;
        }
      }
      if(!_bInput){
        _reTry=1
        es.push({_type:"element",_css:["INPUT","SELECT","TEXTAREA","[contenteditable=true]"]})
      }
    }
    
    this._mergeExpr(es);
    var _result={
      _path:[],
      _bLeft:_bLeft,
      _root:_root
    }
    var _limit={
      _path:[],
      _bLeft:_result._bLeft,
      _init:1
    };
    var e=0;
    //final search
    for(var i=es.length-1;i>=0;i--){
      e=es[i];
      var _tmpList=this._findElementInArea(e,_result,0,_orgElement);
      if(!_tmpList){
        continue
      }else if($(_tmpList).is(_orgElement) || !_orgElement){
        _result._endList=_tmpList
      }else{
        es.splice(i,1)
        _descAnalysis._clearTmpPath()
        return _descAnalysis._findElement(es,_root,_bSet,_bLeft,_orgElement)
      }
      if(i==es.length-1){
        _result._endList=_result._endList.not(".BZIgnore *");
        //_result._endList=this._removeParentItemFromResult(_result._endList);
        if(_orgElement && !_result._endList.is(_orgElement)){
          _result._endList.push(_orgElement)
        }
      }
      if(_result._endList){
        _descAnalysis._cleanTagName(_result._endList)
        if(i){
          this._cleanRootPath(_result._endList,_result._root)
        }
        if(_limit && _limit._init && ["text","group"].includes(e._type) && _result._endList.length>1 && _result._endList[0]!=_orgElement){
          for(var ii=0;ii<_result._endList.length;ii++){
            _result._endList[ii].bzOldTmp=_result._endList[ii].bzTmp;
            _result._endList[ii].bzTmp=_result._endList[ii].bzTmp.replace(/(\:)(contains|equal)(.+\))/i,"");
          }
          _limit._root=_result._root;
          _limit=this._findElementInArea(e,_limit,1,_orgElement);
          if(_limit){
            if(_limit.length==_result._endList.length){
              var _newList=[]
              for(var ii=0;ii<_result._endList.length;ii++){
                var o=_result._endList[ii];
                
                if(_limit[ii]==_result._endList[ii]){
                  _newList.push(o)
                }else{
                  o.bzTmp=_result._endList[ii].bzOldTmp;
                }
              }
              if(_orgElement && _newList.includes(_orgElement) && _newList.length<_result._endList.length){
                _result._endList=$(_newList)
              }else{
                for(var ii=0;ii<_newList.length;ii++){
                  _newList[ii].bzTmp=_newList[ii].bzOldTmp;
                }
              }
            }else if(i){
              if(_limit.length>_result._endList.length){
                for(var ii=0;ii<_result._endList.length;ii++){
                  _result._endList[ii].bzTmp=_result._endList[ii].bzOldTmp;
                }
              }
              this._cleanRootPath(_limit,_result._root)
            }
            _descAnalysis._cleanTagName(_limit)
          }
        }else if(_limit && _limit._init){
          _limit={_init:1,_endList:[]};
          for(var ii=0;ii<_result._endList.length;ii++){
            _limit._endList.push(_result._endList[ii])
          }
          _limit._endList=$(_limit._endList)
        }
      }else{
        break;
      }
    }
    
    e=_result._endList;
    if(e && e.length==1){
      if(e[0].bzTmp.constructor==String){
        e[0].bzTmp=e[0].bzTmp.split("\n")
      }
      return e[0];//this._findElementIdx(e[0]);
    }else if(e && e.length>1){
      var _list=[]
      if(_limit && !_limit._init){
        if(_limit.is(_orgElement) || !_orgElement){
          for(var i=0;i<e.length;i++){
            if(_limit.is(e[i])){
              _list.push(e[i])
            }
          }
        }
      }
      if(_list.length==1){
        return this._findElementIdx(_list[0]);
      }else if(_list.length){
        e=_list;
      }
      if(_cssIdx!==undefined && e.length>_cssIdx){
        return this._findElementIdx(e[_cssIdx]);
      }else if(_cssIdx!==undefined){
        e=null;
//      }else if(_orgElement){
        /*
        for(var i=0;i<e.length;i++){
          if(e[i]==_orgElement){
            return this._findElementIdx(e[i]);
          }
        }
        */
      }
    }else if(!e&&_reTry){
      es.pop()
      return _descAnalysis._findElement(es,_root,0,_bLeft,_orgElement)
    }
    return e;
  },
  _setSecondText:function(o,e,_path){
    var n;
    var s=o.bzTmp.split("\n");
    o.bzTmp=_path+"\n";
    for(n=0;n<s.length;n++){
      if(!s[n].startsWith("BZ.")){
        if(s[n].match(/\:(contains|Contains|textElement|endContains|after|before|endEqual|equal|RowCol|rowcol)\((.+)\)/)){
          
        }else{
          s[n]+=e
        }
        
        break;
      }
    }
    for(n=0;n<s.length;n++){
      o.bzTmp+=s[n];
      if(n<s.length-1){
        o.bzTmp+="\n";
      }
    }
  },
  _cleanTagName:function(_list){
    if(_list){
      for(var n=0;n<_list.length;n++){
        var v=_list[n], w="";
        if(!v.bzTmp.split){
          continue;
        }
        var ss=v.bzTmp.split("\n");
        if(ss.length>1){
          var s=w=ss[1];
          w=ss[0]+"\n"+w;
          for(var i=2;i<ss.length;i++){
            if(ss[i].match(/[:#.]/) || !s.startsWith(ss[i])){
              w+="\n"+ss[i]
            }
            s=ss[i];
          }
          v.bzTmp=w;
        }
      };
    }
  },
  _cleanRootPath:function(_list,_root){
    if(!_root[0] || !_list){
      _root=$(_root);
    }
    
    _list.each(function(i,a){
      if(!_root.is(a)){
        for(var i=0;i<_root.length;i++){
          if(a.bzTmp.startsWith && a.bzTmp.startsWith(_root[0].bzTmp+"\n")){
            a.bzTmp=a.bzTmp.replace(_root[0].bzTmp+"\n","");
            return;
          }
        }
      }
    });
  },
  _findElementIdx:function(ee,_simple){
    BZ._log("findElement")
    var e=ee;
    if(!e.bzTmp || e.bzTmp.constructor!=String){
      return;
    }
    var os,_root,p=e.bzTmp.split("\n");
    
    try{
      if (p && p.length>0 && (BZ._autoRecording || BZ._documents)) {
        
        if($.isNumeric(p[p.length-1])){
          p.pop()
        }

        var pp=p.pop();
        var ppp=pp
        if(!e.children.length){
          ppp=pp.replace(/\:contains\(/ig,":endContains(")
        }

        os=_search([].concat(p),ppp,e)
        if((!os.os.is(e)||os._solution)&&pp!=ppp){
          os=_search([].concat(p),pp,e)
        }
        
        var i=os.os.index(e);
        if(i>=0){
          if(i&&_simple!=3){//simple==3 is for label only. not try :last
            if(os.os.length==i+1){
              let _last=os.p.pop()
              if(!_last.endsWith(":last")){
                var oo=_Util._clone(os.p)
                oo.push(_last+":last")
                oo.push(0)
                if($util.findDom(oo)==e){
                  _last+=":last"
                  i=0
                }
              }
              os.p.push(_last)
            }
          }
          
          if(!i&&e.tagName=="CANVAS"&&e.bzTxtElement){
            i=_TWHandler._getCanvasTextElementIdx(e,e.bzTxtElement)||0
            // delete e.bzTxtElement
          }
          
          os.p.push(i)
          e.bzTmp=os.p
        }else{
          if(e.bzTmp.constructor==String){
            e.bzTmp=[e.bzTmp.split("\n")[0]]
          }else{
            e.bzTmp=[e.bzTmp[0]]
          }
          e.bzTmp.push(_Util._getQuickPath(e))
        }
        ee.bzTmp=e.bzTmp
        return ee;
        
        function _search(p1,exp,e){
          var p2=[].concat(p1),_solution=0;
          p2.push(exp)
          
          var os=$(_Util._findDoms(p2))
          while(!os.is(e)&&p2.length>2){
            p2.splice(p2.length-2,1)
            os=$(_Util._findDoms(p2))
          }
          if(!os.is(e)){
            p2=p1
//            p2.push(exp)
            p2.push(e.tagName)
            os=$(_Util._findDoms(p2))
            while(!os.is(e)&&p2.length>2){
              _solution=1
              p2.splice(p2.length-2,1)
              os=$(_Util._findDoms(p2))
            }
          }
          return {os:os,p:p2,_solution:_solution}
        }
      }
    }catch(ex){
    }
  },
  _filterTextInEndList:function(_result,e,_limit,_orgElement){
    var p,pl;
    pl=p=e._value;
    
    if(_result._endList && _result._endList[0]){
      var m=_result._endList[0].bzTmp.match(/\"(.)+\"/);
      if(m && m.includes(pl)){
        return;
      }
      
      var f=":equal("+_cssHandler._handleContainText(pl)+")";
      // if(_orgElement){
        // if(!$(_orgElement).is(f)){
          // f=":Contains("+_cssHandler._handleContainText(pl)+")";
        // }
      // }
      //var f=":Contains("+_cssHandler._handleContainText(pl)+")";
      var ff=_Util._getAttrPath("value",_cssHandler._handleContainText(pl));
      var kp=p,kpl=pl
      var _list=$([]),_lastNot,_startBZ=_result._endList[0]
      for(var i=0;i<_result._endList.length;i++){
        var e=_result._endList[i];
        if(!e.bzTmp || !e.bzTmp.startsWith){
          continue
        }
        if(_lastNot&&_lastNot.find(e).length){
          continue
        }
        var _bInput=_Util._isStdInputElement(e)
        if(!_bInput && ($(e).is(f).length || $(e).filter(f).length)){
          let vv=_getNewTmp(e,kp,kpl,f)
          if(!vv){
            return
          }
          e.bzTmp=vv
          _list=_list.add(e)
        }else if(_bInput){
          if($(e).filter(ff).length){
            if(_startBZ){
              e.bzTmp+=p==pl?ff:_Util._getAttrPath("value",p)
            }else{
              if(e.bzTmp.match(/value\*\=/i)){
                return 0;
              }
              e.bzTmp = this._getRootPath(_result._root,e)+"\n"+ e.bzTmp+(p==pl?ff:_Util._getAttrPath("value",p));
            }
            _list=_list.add(e)
          }
        }else{
          _lastNot=$(e)
        }
      }
      if(!_list.length){
        pl=pl.toLowerCase();
        for(var i=0;i<_result._endList.length;i++){
          var e=_result._endList[i];
          var _title=0;
          for(var a=0;e.attributes && a<e.attributes.length;a++){
            var aa=e.attributes[a];
            var n=aa.name.toLowerCase();
            if(n.match(/title|label/)){
              _title=aa;
            }else if(n.includes("alt")){
              _title=aa;
            }else if(n=="placeholder" || n=="name"){
              _title=aa;
            }else if(n=="value" && _Util._isInputButton(e)){
              _title=aa;
            }
            if(_title){
              var tl=_title.value.toLowerCase();
              if(tl && (tl==pl || (!_limit &&!BZ._isRecording() && tl.includes(pl)&& _Util._includesWord(tl,pl)))){
                c=_Util._getAttrPath(_title.name,p)
                if(e.bzTmp && e.bzTmp.startsWith("BZ.")){
                  e.bzTmp+=c;
                }else if(!e.bzTmp.includes(c)){
                  e.bzTmp=this._getRootPath(_result._root,e)+"\n"+e.bzTmp+c;
                }else{
                  e.bzTmp=this._getRootPath(_result._root,e)+"\n"+e.bzTmp;
                }
                _list=_list.add(e);
                break;
              }
              _title=0;
            }
          }
        }
      }
      if(_list.length && (!_orgElement || _list.is(_orgElement))){
        _result._endList=_list;
        return 1;
      }
    }
    
    function _getNewTmp(_startBZ,kp,kpl,f){
      let _newTmp
      if(_startBZ){
        if(_startBZ.bzTmp.startsWith("BZ.")){
          _newTmp=_startBZ.bzTmp+(kp==kpl?f:":Contains("+kp+")")
          _startBZ=1
        }else{
          if(_startBZ.bzTmp.match(/:contains|:endcontains|:endequal|:equal/i)){
            return 0
          }else{
            _newTmp=_descAnalysis._getRootPath(_result._root,_startBZ)+"\n"+ _startBZ.bzTmp+(kp==kpl?f:":Contains("+kp+")");
          }
        }
      }
      return _newTmp
    }
  },
  _getRootPath:function(_root,e){
    if(_root.bzTmp){
      return _root.bzTmp;
    }
    for(var i=0;i<_root.length;i++){
      var r=_root[i];
      if($(r).find(e) || r==e){
        return r.bzTmp;
      }
    }
  },
  _getTextList:function(_root,e,k,_limit){
    var p,ps,_path,pl;
    if(e._type=="text"){
      pl=p=e._value;
    }
    
    var f=":"+k+"("+_cssHandler._handleContainText(pl)+")";
    var cf=e._value==p?f:":"+k+"("+p+")";
    pl=pl.toLowerCase();

    if(!_root[0]){
      _root=[_root];
    }
    //find inner element
    for(var i=0;i<_root.length;i++){
      var pps="",r=_root[i];
      _path=r.bzTmp;
      r=r.body;
      pps=$(r).find(f);
      for(var n=0;n<pps.length;n++){
        _descAnalysis._setBzTmpPath(pps[n],_path,cf,_limit);
      }
      pps=pps.add($(r).find("*").filter(function(m,e){
        if(!pps.is(e)){
          return _descAnalysis._filterAttr(e,_path,p,pl,_limit)
        }
      }));
      if(!ps){
        ps=pps;
      }else{
        ps=ps.add(pps)
      }
    }
    
    //filter self
    if(!ps || !ps.length){
      for(var i=0;i<_root.length;i++){
        _path=_root[i].bzTmp;
        var _body=_root[i].body||_root[i];
        ps=ps.add($(_body).filter(f).filter(function(i,e){
          if(!e.bzTmp){
//            e.bzTmp=e.tagName;
          }
          if(!e.bzTmp.startsWith(_path)){
//            e.bzTmp=_path+"\n"+e.bzTmp;
          }
          
          _descAnalysis._setBzTmpPath(e,_path,cf,_limit);
          /*
          if(e.bzTmp.match(/:Contains\(.+\)$/)){
            e.bzTmp=e.bzTmp.replace(/:Contains\(.+\)$/,f);
          }else{
            e.bzTmp+=f;
          }
          */
          return e;
        }));
        
        ps=ps.add($(_body).filter(function(i,e){
          if(!ps.is(e)){
            return _descAnalysis._filterAttr(e,_path,p,pl,_limit)
          }
        }));
      }
    }
    
    if(ps.length){
      var os=[];
      
      for(var i=0;i<ps.length;i++){
//        if(ps[i].tagName!="OPTION" || (ps[i].parentElement && !["SELECT","OPTGROUP"].includes(ps[i].parentElement.tagName))){
        if(ps[i].tagName!="OPTION"){
          os.push(ps[i])
        }
      }
    }
    return $(os);
  },
  _filterAttr:function(e,_path,p,pl,_limit){
    if(e.bzTmp){
      var s;
      if(e.bzTmp.constructor==String){
        s=e.bzTmp.split("\n");
      }else{
        s=e.bzTmp
      }
      s=s[s.length-1];
      if(s.match(/[^a-z-]/i)){
        return;
      }
    }
    var c=_Util._getAttributeCss(e,pl,p)
    if(c){
      _descAnalysis._setBzTmpPath(e,_path,c);
      return e;
    }
  },
  _setBzTmpPath:function(e,_path,c,_limit){
    c=c.replace(/^[a-z0-9-~+ >]+/i,"");
    if(e.bzTmp && e.bzTmp.constructor==Array){
      var s=""
      for(var i=0;i<e.bzTmp.length;i++){
        s+="\n"+e.bzTmp[i];
      }
      e.bzTmp=s.substring(1)
    }
    if(!e.bzTmp || _limit){
      e.bzTmp=_path+"\n"+e.tagName+c;
    }else if(e.bzTmp==_path || e.bzTmp.includes(_path+"\n")){
      if(!e.bzTmp.replace(_path,"").includes(c)){
        e.bzTmp+=c
      }
    }else if(e.bzTmp.startsWith("BZ.")){
      if(c){
        var s=e.bzTmp.split("\n");
        s=s[s.length-1];
        if(!s.includes(c)){
          e.bzTmp+=c;
        }
      }
    }else if(!e.bzTmp.includes(c)){
      var t=c.match(/\((.+)\)/);
      if(t){
        t=t[1];
        var tt=e.bzTmp.match(/\((.+)\)/);
        if(tt){
          tt=tt[1];
          if(tt.toLowerCase().includes(t.toLowerCase())){
            _descAnalysis._setSecondText(e,":Contains("+t+")",_path);
            return
          }
        }
      }
      
      var cc=e.bzTmp.replace(/^[a-z0-9-~+ >]+/i,"");
      c=e.tagName+c;
      if(!c.includes(cc) && (!c.match(/:contains|:end/)||!cc.match(/:contains|:end/))){
        c+=cc;
      }
      e.bzTmp=_path+"\n"+c;
    }
  },
  _addCssIntoBZTmpPath:function(_path,_css,e){
    if(!_css.startsWith(e.tagName)){
      return _path+e.tagName+_css;
    }else{
      return _path+_css;
    }
  },
  _findInCss:function(_root,_css,_findWay){
    var ppp=$([]),_final=[];
    if(!_root[0]){
      _root=[_root];
    }
    for(var i=0;i<_root.length;i++){
      var r=_root[i];
      var _path=r.bzTmp;
      for(var n=0;n<_css.length;n++){
        var c=_css[n]
        var ps=$(r)[_findWay](c).filter(function(i,p){
          if(!ppp.is(p)){
            if(_findWay=="find"){
              _descAnalysis._setBzTmpPath(p,_path,c);
            }
            return p;
          }
        });
        ppp=ppp.add(ps);
      }
    }
    return ppp;
  },
  _retrieveTextForElementPathItem:function(o,_bInput){
    o=o||"";
    if(!o || $.isNumeric(o)){
      return
    }
    var s=o.constructor==String?o.split("\n"):o;
    for(let n=s.length-1;n>=0;n--){
      if(s[n].constructor==String&&!$.isNumeric(s[n])){
        var ss=s[n].match(/(\:|\[)(near|data|contains|input|panel|text|after|before|Contains|textElement|endContains|endEqual|equal|RowCol|rowcol|name|title|placeholder)(\(\[|\(|\"|\*\=|\=|\[)([^\"\'\]]+)(\)|\"|\])/);
        ss=ss||s[n].match(/(\:|\[)(attr)(\(|\"|\*\=|\=)(.+)(\)|\")/);
        ss=ss||s[n].match(/^(\:)([a-z0-9]+)\((.+)\)$/i);//for com
//        ss=ss||s[n].match(/\:bz\([^\)]+\)/g);
        if(ss){
          var r=ss[4]||ss[3]
          if(ss[2]=="attr"){
            r=r.split("=")
            if(["value","placeholder","name","title"].includes(r[0])||r[0].includes("label")){
              r=r[1];
              r=r.split(/\)\:[a-zA-Z]+\(/)[0]
              return r
            }
            /*
          }else if(ss[0].match(/^\:bz\(/)){
            let x=ss.find(x=>{
              x=x.match(/^\:bz\(([^\)]+)\)/)
              if(x){
                x=x[1]||""
                return x.includes("$id=")
              }
            })
            if(x){
              x=x.match(/^\:bz\(([^\)]+)\)/)
              if(x){
                x=x[1].split("=")
                let v=x[1]
                let k=x[0].trim()
                if(v){
                  return v
                  // if(k.match(/^\$(field|list|table|details|details-enter|ex-details-enter|module|module-enter|add|new|edit|update|modify|delete|remove)$/)){
                    
                  // }
                }else{
                  if(k.match(/^\$(add|new|edit|update|modify|delete|remove|submit|next|cancel|confirm|list|table)$/)){
                    return k
                  }
                }
              }
            }
            */
          }else{
            return r
          }
        }else if(!s[n].match(/[a-z]+/i)){
        }else if(_bInput||["INPUT","SELECT","TEXTAREA"].includes(s[n].match(/[a-z]+/i)[0])||s[n].includes("contenteditable=true")){
          continue
        }
        return "";
      }
    }
    
  },
  //Work only for setting event action. the element must have label. The function should be update after ai upgrade. TODO:
  _findLabelFromInputElementPath:function(s){
    s=s.constructor==String?s.split("\n"):s;
    for(n=s.length-1;n>=0;n--){
      if(s[n].constructor==String){
        var ss= s[n].match(/(\:|\[)(contains|Contains|after|before|endContains|endEqual|equal|RowCol|rowcol|name\*\=|title\*\=|placeholder\*\=)(\(|\")(.+)(\)|\")/);
        if(ss){
          return _glossaryHandler._getVariableName(ss[4]);
        }
      }
    }
  },
  _findElementInArea:function(e,_result,_limit,_orgElement){
    var p,_type,_text,r=_result._root,_endList=_result._endList;

    if(["group","text","data"].includes(e._type)){
      _text=1;
      
      if(_endList && _endList.length){
        var t=_descAnalysis._retrieveTextForElementPathItem(_endList[0].bzTmp);
        //TODO: parse e._value from data to value
        if(t && t.toLowerCase().includes(e._value.toLowerCase())){
          p=1
        }
      }
      // if(!p||(_orgElement&&_Util._getElementRoot(_orgElement)!=document.body) && this._filterTextInEndList(_result,e,0,_orgElement)){
      if(!p && this._filterTextInEndList(_result,e,0,_orgElement)){
        return _result._endList;
      }
      if(e._value.match(/^\[.+|.+\]$/)){
        p=_limit?"rowcol":"RowCol"
      }else if((_orgElement && _Util._isInputObj(_orgElement))||_result._endList && _result._endList[0] && _Util._isInputObj(_result._endList[0])){
        var o=(_orgElement||_result._endList[0]).bzTmp||0
        if(o.constructor==Array){
          o=o[o.length-1]
        }
        if(!o.includes||!o.includes(":near")){
          p="near"
        }else{
          p=_limit?"endEqual":"endContains"
        }
      }else{
        p=_limit?"endEqual":"endContains"
      }
      if(_orgElement&&_orgElement.tagName=="CANVAS"){
        p="textElement"
      }
      _type=p
      if(p=="near"){
        if(_result._endList && _result._endList.length){
          p=this._getTextList(_result._endList,e,p,_limit)
        }else{
          p=this._getTextList(r,e,p,_limit)
        }
        if(p.length && (!_orgElement || p.is(_orgElement))){
          for(var i=0;i<p.length;i++){
            if(!p[i].bzTmp.includes(r.bzTmp)){
              p[i].bzTmp=r.bzTmp+"\n"+p[i].bzTmp;
            }
          }
        }else{
          p=_limit?"endEqual":"endContains"
        }
      }
      if(p.constructor==String){
        p=this._getTextList(r,e,p,_limit)
      }
    }else{
      if(e._extraText){
        p=this._findInCss(this._getTextList(r,e._extraText,_limit?"contains":"Contains",_limit),e._css,"filter");
      }else{
        p=this._findInCss(r,e._css,"find");
        if(!p.length){
          p=this._findInCss(r,e._css,"filter");
        }
      }
    }
    if(_endList){
      var pp=$([]);
      //try to find _endList items in result item inner element
      for(var i=0;i<p.length;i++){
        var _path1=p[i];
        var _path2=p[i]
        _path2=_path1;
        var ps=$(p[i]).find(_endList).filter(function(n,e){
          if(!pp.is(e) && e.bzTmp.startsWith){
            if(!e.bzTmp.startsWith("BZ.")){
              if(e.bzParent==p[i]){
                e.bzTmp=p[i].bzTmp+e.bzTmp.replace(/^[a-z-]*/i,"");
              }else{
                e.bzTmp=p[i].bzTmp+"\n"+e.bzTmp;
              }
            }
            e.bzParent=p[i];
            return e;
          }
        });
        pp=pp.add(ps)
      }
      if(pp.length && _orgElement && pp.is(_orgElement)){
        return pp;
      }else if(pp.length && ["endEqual","endContains","textElement"].includes(_type)){
        return pp;
      }else if(!pp.length){
        pp=$([])
      }
      //try to find _endList items in result list
      for(var i=0;i<p.length;i++){
        var _path1=p[i].bzTmp;
        var _path2=_path1
        var ps=$(p[i]).filter(_endList).filter(function(i,e){
          if(!pp.is(e)){
            return e;
          }
        });
        pp=pp.add(ps)
      }
      if(pp.length && (!_orgElement || pp.is(_orgElement))){
        return pp;
      }else{
        pp=$([])
      }
      
      //header path
      pp=[];
      if(["group","text","data"].includes(e._type)){
        for(var i=0;i<p.length;i++){
          if(p[i].bzTmp.match(/endEqual|endContains/) && !["BUTTON","INPUT"].includes(p[i].tagName)){
            pp.push(p[i])
          }
        }
        p=pp;
      }
      pp=$([]);
      
      var po=p,ps=[];
      for(var i=0;i<p.length;i++){
        var p1=p[i].bzTmp.split("\n");
        var p3=p[i].bzTmp.replace(/\n.+$/,"");
        p1=p1[p1.length-1].replace(/^[a-z-0-9~+ >]+/i,"")
        if(p1.match(/:endContains|:endEqual/)){
          ps.push({e:p[i],o:p[i].parentNode,_parent:p3,_textMark:":Contains("+e._value+")"});
        }
      }
      
      var _remove=0;
      for(var i=0;i<ps.length;i++){
        p=ps[i];
        if(p.o){
          var ppp=$(p.o).find(_endList);
          if(!ppp.length || (_orgElement && !ppp.is(_orgElement))){
            if(_endList.filter(p.o)[0]==p.o){
              if(pp.has(p.o).length){
                if(!p.o.bzTmp.includes(p._parent)){
                  p.o.bzTmp=p._parent+"\n"+p.o.bzTmp+":has("+p._textMark+")";
                }
                pp=pp.add([p.o]);
              }
            }
          }else{
            if(_orgElement){
              ppp=[_orgElement];
            }else if(ppp.length>1 && ps.length==1){
              ppp=this._findNextInPos(po[0],ppp,_result._bLeft)
            }
            if(!ppp[0].bzTmp.startsWith){
              continue
            }else if(ppp[0].bzTmp.startsWith("BZ.")){
              
            }else if(p.o.bzTmp){
              if(p.o==ppp[0].bzParent){
                var s=_Util._insertInString(ppp[0].bzTmp,"\n",p._textMark);
                if(!s){
                  s=ppp[0].bzTmp+p._textMark;
                }
                ppp[0].bzTmp=p._parent+"\n"+s;
              }else if(p.o.bzTmp.endsWith(p._textMark)){
                ppp[0].bzTmp=p.o.bzTmp+"\n"+ppp[0].bzTmp
              }else if(p.o.bzTmp.match(/:contains|:end/i)){
                ppp[0].bzTmp=p.o.tagName+p._textMark+"\n"+ppp[0].bzTmp
              }else{
                ppp[0].bzTmp=p.o.bzTmp+p._textMark+"\n"+ppp[0].bzTmp
              }
              if(p._parent && !ppp[0].bzTmp.startsWith(p._parent)){
                ppp[0].bzTmp=p._parent+"\n"+ppp[0].bzTmp
              }
            }else{
              var s=ppp[0].bzTmp.split("\n");
              var ss=s[0].match(/\{\{(.+)\}\}/);
              if(ss){
                var sss=_Util._eval("sss="+ss[1])
                ss=s[0].replace(ss[0],sss);
              }else{
                ss=s[0]
              }
              if($(p.o).find($(p.o.ownerDocument).find(ss)).length){
                ppp[0].bzTmp=p._parent+"\n"+p.o.tagName+p._textMark+"\n"+ppp[0].bzTmp
              }else{
                ppp[0].bzTmp=p._parent+"\n"+s[0]+"\n"+p.o.tagName+p._textMark+ppp[0].bzTmp.replace(s[0],"")
              }
            }

            pp=pp.add(ppp);
          }
          
          if(p.o.bzTmp && p.o.bzTmp==p._parent){
            p.o=null;
            _remove++;
          }else{
            p.o=p.o.parentNode;
            if(p.o==p.o.ownerDocument.body.parentNode){
              p.o=null;
              _remove++;
            }
          }
        }
        
        if(_remove==ps.length){
          return pp;
        }else if(i==ps.length-1){
          if(pp.length){
            return pp;
          }
          i=-1;
        }
      }
    }else{
      if(_orgElement&&_orgElement.type!='file'&&!_Util._isHidden(_orgElement)){
        p=p.filter(":visible")
      }
      return p;
    }
  },
  _findNextInPos:function(po,ps,_bLeft){
    po=po.getBoundingClientRect();
    var _closer=0,_result="";
    for(var i=0;i<ps.length;i++){
      var p=ps[i].getBoundingClientRect();
      if(!_bLeft){
        if(p.top>po.top+20 || (p.top>po.top-10 && p.left>po.left)){
          if(!_closer || _closer.top<p.top-10 || _closer.top>p.top || (_closer.top==p.top && _closer.left>p.left)){
            _closer=p
            _result=ps[i];
          }
        }else if(!_closer || _closer.top<p.top || (_closer.top==p.top && _closer.left>p.left)){
          _closer=p;
          _result=ps[i];
        }
      }else{
        if(p.top>po.top-10 && p.left<po.left){
          if(!_closer || _closer.left<p.left){
            _closer=p
            _result=ps[i];
          }
        }else if(!_closer || _closer.top<p.top || (_closer.top==p.top && Math.abs(_closer.left-po.left)>Math.abs(p.left-po.left))){
          _closer=p;
          _result=ps[i];
        }
      }
    }
    return [_result]
  },
  _actionsToDesc:function(t){
    var s=this._getTestDesc(t)

    return s+_scriptActionHandler._doTestActionsToText(t)
  },
  _getTestDesc:function(t,_simple){
    var s="",l=t.loopData,st=_descAnalysis._syntaxMap.test,sl=_descAnalysis._syntaxOptionMap.loop,w;
    w=t.enterPoint.value||"";
    if(_simple){
      w=_JSHandler._formatInsertCodeToDisplay(w)
    }
    if(t.enterPoint.type=="newpage"){
      s+=st.link[0]
    }else if(t.enterPoint.type=="follow"){
      s+=st.follow[0]
    }else if(t.enterPoint.type=="followCheck"){
      s+=st.followCheck[0]
    }else if(t.enterPoint.type=="followSameURL"){
      s+=st.followSameURL[0]
    } 
    s="URL: "+w+" ("+s+")\n"
    
    if(l && l.loopValue){
      w=_ideDataHandler._getNamePathFromDataPath(l.loopValue);
      if(w){
        s+=st.loopData[0]+": "+w+" ["+sl.loopStart[0]+"="+l.loopStart;
        if(l.loopEnd){
          s+=", "+sl.loopEnd[0]+"="+l.loopEnd
        }
        if(l.exitLoop){
          s+=", "+sl.exitLoop[0]
        }
        s+="]\n"
      }
    }
    return _compressJSON._unConvert(s);
  }
};var _dictionaryHandler={
  _verbs:0,
  _ignores:0,
  _regexMap:{},
  _getRegexValueByKey:function(k){
    if(this._keyMap[k]&&!this._regexMap[k]){
      this._regexMap[k]=new RegExp(this._keyMap[k].toString().replace(/,/g,"|"),"i")
    }
    return this._regexMap[k]
  },
  _isIgnoreWord:function(w){
    var a=_dictionaryHandler._ignores;
    if(!a || !a.length){
      _dictionaryHandler._buildIgnoreSet()
    }
    return _dictionaryHandler._ignores.includes(w.toLowerCase())
  },
  _isVerb:function(w){
    var a=_dictionaryHandler._verbs;
    if(!a || !a.length){
      _dictionaryHandler._buildVerbSet()
    }
    return _dictionaryHandler._verbs.includes(w.toLowerCase())
  },
  _buildIgnoreSet:function(){
    this._ignores=_dictionaryConfig.ignore.split("|");
  },
  _buildVerbSet:function(){
    var ws=[];
    for(var t in _dictionaryConfig){
      if(!["fun","operation"].includes(t)){
        continue;
      }
      _dictionaryConfig[t].forEach(function(o,i){
        ws=ws.concat((o.value||"").toLowerCase().split("|"));
        ws.push(o.key)
      })
    }
    ws.forEach(function(v,n){
      v=v.split(/ |-/g)
      for(var i=0;i<v.length;i++){
        if(_dictionaryHandler._isIgnoreWord(v[i])){
          i--;
          v.splice(i,1)
        }else if(i){
          ws.push(v[i])
        }else{
          ws[n]=v[i]
        }
      }
    })
    this._verbs=ws
  },
  _init:function(){
    if(this._ignores&&this._ignores.length){
      return 1
    }
    this._buildIgnoreSet();
    this._buildVerbSet();
    this._keyMap={};
    this._wordMap={};
    this._wordList=[];

    
    //build type words
    _dictionaryConfig.attribute=_IDE._data._curVersion.setting.attributeMap
    _dictionaryConfig.attribute.forEach(function(v){
      if(v.ex){
        while(v.value.includes(v.ex)){
          v.value=v.value.replace(v.ex,"")
        }
        v.value+="|"+v.ex
        if(v.value.includes("||")){
          v.value=v.value.replace(/[\|]+/g,"|")
        }
      }
    })
    for(var t in _dictionaryConfig){
      if("ignore"==t){
        continue;
      }
      var _err=0
      _dictionaryConfig[t].forEach(function(o,i){
        var ws=(o.value||"").split("|");
        o.key=o.key.toLowerCase();
        if(_dictionaryHandler._keyMap[o.key]){
          _err=1
        }
        _dictionaryHandler._keyMap[o.key]=ws;
        ws.forEach(function(w,i){
          var k=w.plural();
          var x=_dictionaryHandler._wordMap[k];
          if(x){
            if(x._key!=o.key){
              x._key=[x._key,o.key];
            }
            if(!x._type.includes(t)){
              x._type.push(t)
            }
            if(w.replace("-","").includes(o.key)){
              x.regex=o.regex
            }
          }else{
            _dictionaryHandler._wordMap[k]={_type:[t],_key:o.key,regex:o.regex};
            if(w!=k){
              _dictionaryHandler._wordMap[k]._org=w;
            }
          }
          _dictionaryHandler._wordList.push(w);
        })
      })
      if(_err){
        return alert(_bzMessage._root._dictionary._duplicateKey)
      }
    }
    _dictionaryHandler._wordList.sort(function(a,b){return b.length-a.length});
    for(var k in _dictionaryHandler._wordMap){
      //To get first letter 
      //a:attribute, o:operation, f:function, m:module, v: value, i: info
      var t=_dictionaryHandler._wordMap[k]._type;

      t.forEach(function(tt){
        _aiWordHandler._registerWord(k,tt[0],_aiWordHandler._fromValue._dictionary);
      })
    }
    return 1;
  },
  _getFormatByValue:function(w){
    var os=_dictionaryConfig.attribute,v
    for(var i=0;i<os.length;i++){
      v=os[i].regex
      if(w.match(new RegExp(v.substring(1,v.length-1)))){
        return v
      }
    }
  },
  _getWordsByKey:function(k){
    return this._keyMap[k]
  },
  _findWordInType:function(v,t){
    if(!v){
      return;
    }
    v=v.toLowerCase()
    var ws=_dictionaryHandler._wordList,w;
    for(var i=0;i<ws.length;i++){
      w=ws[i];
      var ww=v.match("(^| )"+w+"( |$)");
      
      if(ww){
        if(_dictionaryHandler._wordMap[w.plural()]._type.includes(t)){
          return w;
        }
        var n=v.indexOf(ww[0]);
        var tt=_dictionaryHandler._findWordInType(v.substring(0,n),t);
        if(!tt){
          tt=_dictionaryHandler._findWordInType(v.substring(n+ww[0].length),t);
        }
        if(tt){
          return tt;
        }
        break
      }
    }
  },
  _findWordDefine:function(w){
    w=_aiDataHandler._miniMap[w]||w;
    w=w.plural();
    if(this._wordMap[w]){
      return this._wordMap[w]
    }
    w=_aiWordHandler._preFix(w);
    w=_aiWordHandler._findWordDefine(w)
    if(w.IN){
      for(var i=0;i<w.IN.length;i++){
        var c=w.IN[i];
        c=this._wordMap[c]
        if(c){
          return c
        }
      }
    }
    
  },
  _isCommonFun:function(k){
    return ["add","edit","delete"].includes(k)
  },
  _removeIgnoreWords:function(w){
    if(!this._ignore2){
      var v="";
      if(!window._dictionaryConfig){
        v=_dictionaryHandler._ignores.join("|");
      }else{
        v=_dictionaryConfig.ignore
      }
      if(BZ._data._curProject.language=="cn"){
        this._ignore2=new RegExp(v)
      }else{
        this._ignore2=new RegExp("(^| )("+v+")( |$)")
      }
    }
    var ww;
    if(BZ._data._curProject.language=="cn"){
      ww= w.replace(this._ignore2,"");
    }else{
      ww=w.replace(this._ignore2," ").trim();
    }
    if(ww==w){
      return ww
    }
    return _dictionaryHandler._removeIgnoreWords(ww)
  },
  //ds: options, k: the search key word
  //Ex.: ds=["username","password"],k="name", ---> "username"
  _getSimilarWord:function(ds,k){
    var ks=_Util._clone(_dictionaryHandler._getWordsByKey(k)||[k]);
    ks.forEach(function(v,i){
      ks[i]=_Util._toCompareableWord(v)
    })
    var v=0,vv="";
    for(var i=0;i<ds.length;i++){
      var d=_Util._toCompareableWord(ds[i])
      if(ks.includes(d)){
        return ds[i];
      }else if(_includes(ks,d)){
        if(!v||d.length<v.length){
          v=d
          vv=ds[i]
        }
      }
    }
    return vv
    function _includes(s,v){
      for(var j=0;j<s.length;j++){
        if(v.includes(s[j])){
          return 1
        }
      }
    }
  },
  _getSimilarWordIdx:function(ds,k,_ignoreFormatList){
    var ks=_Util._clone(_dictionaryHandler._getWordsByKey(k)||[k]);
    ks.forEach(function(v,i){
      ks[i]=_Util._toCompareableWord(v)
    })
    var v=0,vv="",_idx;
    for(var i=0;i<ds.length;i++){
      let d=ds[i]
      if(!_ignoreFormatList){
        d=_Util._toCompareableWord(d)
      }
      if(ks.includes(d)){
        return i
      }else if(_includes(ks,d)){
        if(!v||d.length<v.length){
          v=d
          vv=ds[i]
          _idx=i
        }
      }
    }
    return _idx
    function _includes(s,v){
      for(var j=0;j<s.length;j++){
        if(v.includes(s[j])){
          return 1
        }
      }
    }
  },
  _getKeyByMiniMap:function(k){
    
  }
};var _glossaryHandler={
  /***************************************
  //thisIsATest --> this, is, a, test
  //this.is.a.test --> this, is, a, test
  ***************************************/
  _splitWord:function(w){
    if(!w || w.constructor!=String){
      return [];
    }
    w=w.replace(/[\`\~\!\@\#\$\%\^\&\*\(\)\_\+\-\=\[\]\{\}\;\'\:\"\<\,\.\>\/\?]/g," ");
    var vv="";
    var ws=[];
    var _inUpper=false;
    for(var i=0;i<w.length;i++){
      var v=w[i];
      if(v!=" "){
        if(v.match(/[A-Z]/)){
          if(vv && !_inUpper){
            ws.push(vv.toLowerCase());
            vv="";
          }
          _inUpper=true;
        }else if(_inUpper && vv.length>1){
          v=vv[vv.length-1]+v;
          vv=vv.substring(0,vv.length-1);
          ws.push(vv.toLowerCase());
          vv="";
          _inUpper=false;
        }else{
          _inUpper=false;
        }
        vv+=v;
      }else if(vv){
        ws.push(vv.toLowerCase());
        vv="";
        _inUpper=false;
      }
    }
    if(vv){
      ws.push(vv.toLowerCase());
    }
    return ws;
  },
  _removeIgnore:function(w){
    var p= new RegExp("(^| |_|,)("+_bzMessage._root._dictionary._options.attribute.id+"|"+_bzMessage._root._dictionary._options.attribute.name+")($| |_|,)","i");
    return w.replace(p,BZ._data._curProject.language=='cn'?"":" ").trim()||w;
  },
  //check whether _textName similar to _dataName
  //return: _type=1 is match, _type=2, check size
  _getSimilarityRate:function(_textName, _dataName, _textGroup){
    //var _ignore=_glossaryHandler._getIgnoreParten()
    _textGroup=_textGroup||_glossaryHandler._splitWord(_textName);
    
    _textName=_textName.toLowerCase();
    _dataName=_dataName.toLowerCase()
    var _dataGroup=this._splitWord(_dataName);
    _dataName=_dataGroup.toString();
    _dataName=_glossaryHandler._removeIgnore(_dataName)
    if(_textName==_dataName){
      return {_type:1,_size:_dataName.length}
    }else if(_textName.includes(_dataName)){
      return {_type:2,_size:_dataName.length}
    }else if(_textName.replace(/ /g,"").includes(_dataName)){
      return {_type:2,_size:_dataName.length}
    }
    var _gMax=0
    for(var i=0;i<_textGroup.length;i++){
      var t=_textGroup[i],_max=0;
      for(var n=0;n<_dataGroup.length;n++){
        var d=_dataGroup[n];
        var m=this._getSameSize(t,d);
        if(m>_max){
          _max=m;
        }
      }
      _gMax+=_max;
    }
    return {_type:2,_size:_gMax};
  },
  //g: word list
  //w: to find word
  _findSimilarWord:function(g,w){
    var _max;
    for(var i=0;i<g.length;i++){
      var v=g[i]
      var p=_glossaryHandler._getSimilarityRate(w,v)
      if(p._type==1){
        return v
      }else if(!_max||p._size>_max._size){
        _max=p
        p._value=v
      }
    }
    if(_max&&_max._size>w.length*0.8){
      return _max._value
    }
  },
  _getSameSize:function(t,d){
    if(t.startsWith(d)){
      return d.length
    }else if(t.length>d.length){
      for(var i=0;i<d.length;i++){
        if(t[i]!=d[i]){
          return i;
        }
      }
    }
    return 0;
  },
  _isVariableLetter:function(v,_keepDash){
    try{
      if(!_keepDash||v!="-"){
        _Util._eval(v+"=1")
      }
    }catch(e){
      v="_"
    }
    return v
  },
  _getVariableName:function(w,_keepDash,_chkUpperCase){ 
    if(w){
      if(w.toUpperCase()==w){
        w=w.toLowerCase()
      }
      let v="";
      for(let i=0;i<w.length;i++){
        let l=w[i]
        v+=($.isNumeric(l)&&i)||l.match(/[a-zA-Z_\$]/)?l:_glossaryHandler._isVariableLetter(l,_keepDash)
      }
      if(_keepDash){
        return v.replace(" ","")
      }
      return _Util._toCamelWords(v.replace(/_+/g," "),_chkUpperCase)
    }else{
      return ""
    }
  }
};
/*
String.prototype.isEnglish=function(){
  if(!this.match(/a-z/i)){
    return false
  }
  w=this.replace(/[0-9]/g," ");
  
  var w=w.replace(/al|air|ar|ear|eir|er|ere|ight|ir|ong|or|oor|ore|ow|ur/gi,"a");
  w=w.replace(/ght|ng|ur|th|dr|sh|ch|tw|wh|ts|ds/gi,"");
  var ws=w.split(/\W/);
  for(var n=0;n<ws.length;n++){
    w=ws[n];
    if(!w){
      continue;
    }
    var v=0;
    var ok=false;
    var UP=true;
    for(var i=0;i<w.length;i++){
      var c=w[i];
      if(c.match(/a|e|i|o|u|y/gi)){
        v=1;
        ok=true;
      }else{
        v--;
        if(UP && !c.match(/[A-Z]/)){
          UP=false;
        }
      }
      if(v==-4 && !UP){
        return false
      }
    }
    if(!ok && !UP){
      return false;
    }
  }
  return true;
}
*/
Object.defineProperty(String.prototype,"plural", {enumerable: false,value:function(revert){
  //============================================================
  //BZ Code Start
  if(this.trim()!=this){
    return this.trim().plural(revert)
  }else if(this.match(/\s/)){
    var w=this.split(/\s/);
    w.forEach(function(v,i){
      w[i]=v.plural(revert).toString()
    });
    return w.toString().replace(/,/g," ");
  }else if(this.match(/[A-Z\-\`\~\!\@\#\%\^\&\*\(\)\+\=\{\}\[\]\:\;\"\'\<\>\?\,\.\/\\\|\：\，\。\（\）\？\！\；\‘\“\”\’]/)){
    var w=_Util._removeSign(this.toLowerCase()," ")
    return w.plural(revert);
  }else if(this.length<3){
    return this
  }else if(_dictionaryHandler._isIgnoreWord(this)||_dictionaryHandler._isVerb(this)){
    return this;
  }
  
  
  if(!this.match(/[a-z]/i)){
    return this
  }
  //BZ code end
  //============================================================
  
  var plural = {
    '(quiz)$'               : "$1zes",
    '^(ox)$'                : "$1en",
    '([m|l])ouse$'          : "$1ice",
    '(matr|vert|ind)ix|ex$' : "$1ices",
    '(x|ch|ss|sh)$'         : "$1es",
    '([^aeiouy]|qu)y$'      : "$1ies",
    '(hive)$'               : "$1s",
    '(?:([^f])fe|([lr])f)$' : "$1$2ves",
    '(shea|lea|loa|thie)f$' : "$1ves",
    'sis$'                  : "ses",
    '([ti])um$'             : "$1a",
    '(tomat|potat|ech|her|vet)o$': "$1oes",
    '(bu)s$'                : "$1ses",
    '(alias)$'              : "$1es",
    '(octop)us$'            : "$1i",
    '(ax|test)is$'          : "$1es",
    '(us)$'                 : "$1es",
    '([^s]+)$'              : "$1s"
  };

  var singular = {
    '(quiz)zes$'             : "$1",
    '(matr)ices$'            : "$1ix",
    '(vert|ind)ices$'        : "$1ex",
    '^(ox)en$'               : "$1",
    '(alias)es$'             : "$1",
    '(octop|vir)i$'          : "$1us",
    '(cris|ax|test)es$'      : "$1is",
    '(shoe)s$'               : "$1",
    '(o)es$'                 : "$1",
    '(bus)es$'               : "$1",
    '([m|l])ice$'            : "$1ouse",
    '(x|ch|ss|sh)es$'        : "$1",
    '(m)ovies$'              : "$1ovie",
    '(s)eries$'              : "$1eries",
    '([^aeiouy]|qu)ies$'     : "$1y",
    '([lr])ves$'             : "$1f",
    '(tive)s$'               : "$1",
    '(hive)s$'               : "$1",
    '(li|wi|kni)ves$'        : "$1fe",
    '(shea|loa|lea|thie)ves$': "$1f",
    '(^analy)ses$'           : "$1sis",
    '((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$': "$1$2sis",        
    '([ti])a$'               : "$1um",
    '(n)ews$'                : "$1ews",
    '(h|bl)ouses$'           : "$1ouse",
    '(corpse)s$'             : "$1",
    '(us)es$'                : "$1",
    's$'                     : ""
  };

  var irregular = {
    'move'   : 'moves',
    'foot'   : 'feet',
    'goose'  : 'geese',
    'sex'    : 'sexes',
    'child'  : 'children',
    'man'    : 'men',
    'tooth'  : 'teeth',
    'person' : 'people'
  };

  var uncountable = [
    'sheep', 
    'fish',
    'deer',
    'moose',
    'series',
    'species',
    'money',
    'rice',
    'information',
    'equipment'
  ];

  // save some time in the case that singular and plural are the same
  if(uncountable.indexOf(this.toLowerCase()) >= 0){
    return this;
  }
  // check for irregular forms
  for(word in irregular){

    if(revert){
      var pattern = new RegExp(irregular[word]+'$', 'i');
      var replace = word;
    } else{ 
      var pattern = new RegExp(word+'$', 'i');
      var replace = irregular[word];
    }
    if(pattern.test(this)){
      return this.replace(pattern, replace);
    }
  }

  if(revert) {
    var array = singular;
  }else{
    var array = plural;
  }

  // check for matches using regular expressions
  for(reg in array){

    var pattern = new RegExp(reg, 'i');

    if(pattern.test(this)){
      return this.replace(pattern, array[reg]);
    }
  }

  return this;
}});var _statusManagement={
  _getDataStatusByKey:function(k,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let v=m._data.definition
    return v.moduleDataStatus.find(x=>{return x.id==k})
  },
  _getDataStatusByName:function(n,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    let v=m._data.definition
    n=(n||"").toLowerCase()
    return v.moduleDataStatus.find(x=>{return x.name.toLowerCase()==n||(!n&&x.default)})
  },
  _isSimpleStatusModule:function(m){
    let s=_statusManagement._getModuleStatusList(m)
    return !s.find(x=>x.opr=="edit")
  },
  _getModuleStatusList:function(m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    if(m){
      return (m._data.definition&&m._data.definition.moduleDataStatus)||[]
    }
  },
  _getModuleDefStatus:function(m){
    return (_statusManagement._getModuleStatusList(m)||[]).find(x=>{
      return x.default
    })
  },
  _isDefStatus:function(s,m){
    if(!s){
      return 1
    }
    let _list=_statusManagement._getModuleStatusList(m)
    return _list.find(x=>{
      if(x.name==s){
        return x.default
      }
    })
  },
  _isRequestStatus:function(s,r,m){
    s=s||""
    r=r||""
    if(!s&&r.default){
      return 1
    }
    s=s.name||s
    r=r.name||r
    if(s.toLowerCase()==r.toLowerCase()||!r||r=="*"){
      return 1
    }
  },
  _assignDataStatus:function(d,m){
    m=_aiGeneratorDataHandler._getModuleObject(m)
    try{
      if(m._data.definition&&m._data.definition.identifyStatusScript){
        m._identifyStatusFun=m._identifyStatusFun||_Util._eval("m._identifyStatusFun="+m._data.definition.identifyStatusScript,{m:m})
        d.$status=m._identifyStatusFun(d)
      }else{
        let ds=_statusManagement._getModuleDefStatus(m)
        if(ds){
          d.$status=d.$status||ds.name
        }
      }
    }catch(e){
      alert(e.message)
    }
  },
  _popIdentifyScriptForm:function(d,_fun){
    BZ._data._uiSwitch._identifyScript=d
    let m=_IDE._data._curModule
    _Util._confirmMessage({
      _tag:"div",
      _attr:{
        class:"bz-h-h-tab-content",
        style:"height:300px;"
      },
      _items:[
        _bzJSEditor._buildJSEditor({
          _focus:1,
          _style:"width:100%;",
          _model:"BZ._data._uiSwitch._identifyScript",
          _label:"",
          _placeholder:_bzMessage._tools._suggestJsCodeFormat,
          _noBtn:1
        })
      ]
    },[{
      _title:_bzMessage._method._submit,
      _click:function(c){
        try{
          m._identifyStatusFun=_Util._eval(BZ._data._uiSwitch._identifyScript)
          m._data.definition.identifyStatusScript=BZ._data._uiSwitch._identifyScript;
          _ideModuleManagement._save()
          c._ctrl._close()
        }catch(e){
          alert(e.message)
        }
      }
    }],_bzMessage._aiDefinition._setting._status)
  },
  _popModuleDataStatusForm:function(d,_fun){
    d=_CtrlDriver._buildProxy(d||{opr:"edit"});
    _Util._confirmMessage({
      _tag:"div",
      _data:d,
      _items:[
        {
          _tag:"div",
          _attr:{
            "class":"input-group"
          },
          _items:[
            {
              _tag:"label",
              _attr:{
                "class":"input-group-addon required"
              },
              _text:"_bzMessage._common._status"
            },
            {
              _tag:"input",
              _attr:{
                "class":"form-control",
                required:1
              },
              _dataModel:"_data.name",
              _focus:1
            }
          ]
        },
        {
          _tag:"div",
          _attr:{
            "class":"input-group"
          },
          _items:[
            {
              _tag:"label",
              _attr:{
                "class":"input-group-addon required"
              },
              _text:"_bzMessage._root._dictionary._options.operation._title"
            },
            {
              _tag:"select",
              _attr:{
                "class":"form-control",
                required:1
              },
              _dataModel:"_data.opr",
              _items:[
                {
                  _tag:"option",
                  _attr:{
                    value:"_data._item"
                  },
                  _text:"_bzMessage._root._dictionary._options.operation[_data._item]",
                  _dataRepeat:["add","edit","delete"]
                }
              ]
            }
          ]
        },
        {
          _tag:"div",
          _attr:{
            "class":"col-xs-12"
          },
          _items:[
            {
              _tag:"label",
              _items:[
                {
                  _tag:"input",
                  _attr:{
                    type:"checkbox"
                  },
                  _dataModel:"_data.default"
                },
                {_text:"_bzMessage._common._default"}
              ]
            }
          ]
        }
      ]
    },[{
      _title:_bzMessage._method._submit,
      _click:function(c){
        let _def=_IDE._data._curModule._data.definition
        let ds=_def.moduleDataStatus
        if(!d.name){
          return alert(_bzMessage._system._error._requiredField,_bzMessage._common._name)
        }else if(_Util._isEmpty(d.opr)){
          return alert(_bzMessage._system._error._requiredField,_bzMessage._root._dictionary._options.operation._title)
        }else if(!d.id&&ds.find(x=>{
          return x.name==d.name
        })){
          return alert(_bzMessage._system._error._duplicateName,d.name)
        }
        if(d.default){
          ds.find(x=>{
            if(x.default){
              if(x!=d){
                x.default=0
                delete x.default
              }
              return 1
            }
          })
        }
        if(!d.id){
          d.id=Date.now()
          ds.push(d)
          _def.moduleDataFlow[d.id]={to:0}
        }else{
          if(!ds.find((x,i)=>{
            if(x.id==d.id){
              ds[i]=d
              return 1
            }
          })){
            ds.push(d)
          }
        }
        
        _ideModuleManagement._save()
        c._ctrl._close()
      }
    }],_bzMessage._aiDefinition._setting._status)
  },
  _getUIOptions:function(m,_value,_excepts){
    return [
      {
        _tag:"option",
        _attr:{
          value:"_data._item."+_value
        },
        _text:function(d){
          d=d._item
          let w=d.name
          if(d.default){
            w+=" ("+_bzMessage._common._default+")"
          }
          return w
        },
        _dataRepeat:function(){
          let vs=_statusManagement._getModuleStatusList(m),
              rs=[]
          
          if(_excepts){
            vs.forEach(x=>{
              if(!_excepts.includes(x.id+"")){
                if(_excepts.includes("start")){
                  if(x.opr!="add"){
                    return
                  }
                }
                rs.push(x)
              }
            })
            return rs
          }else{
            vs.forEach(x=>{
              if(x.opr!="delete"){
                rs.push(x)
              }
            })
          }
          return rs
        }
      }
    ]
  }
};;var _objGenerator={
  //m:module data: {name:"",defaultHostId:0,parentModule:parentModule,rootUrl:rootUrl} 
  //d:dataMap
  _generateModule:function(m,_fun){
    if(_ideModuleManagement._getItemByName(m.name)){
      return;
    }
    _ideModuleManagement._save(m,function(m){
      _fun(m)
    })
  },
  _addDataToObj:function(_manage,p,o,_dataType,_name,d,_fun){
    var oo=o||_IDE._data._setting
    var k=_ideDataHandler._newItem(oo.dataMap||oo.defaultData,_name,_dataType,d)
    if(!o){
      oo=_IDE._data._curVersion
    }
    if(curUser._id!=oo.lockBy){
      _manage._lock(oo,function(){
        _objGenerator._saveObj(_manage,p,o,_fun)
      },1,p)
    }else{
      _objGenerator._saveObj(_manage,p,o,_fun)
    }
    return k
  },
  _saveObj:function(_manage,p,o,_fun){
    var _name=[o?o.name:""]

    if(p){
      _manage._save(o,p,_fun)
    }else if(o){
      _manage._save(o,_fun,1)
    }else{
      _manage._save(_fun)
    }
  },
  /*
    m: module entity
    n: name,
    t: type (unit,cell,int),
    u: url,
    as: actions,
    _fun
  */
  _generateTest:function(m,d,as,_fun){
    if(m&&m.constructor==String){
      m=_ideObjHandler._getDataByPath(m)
    }
    _ideTestManagement._save(d,m,function(t){
      if(as){
        t.actions=as;
        _ideTestManagement._save(t,m,_fun,1)
      }else{
        _fun(t)
      }
    },1)
  }
};var BZ={
  _debug:0,
  eval:_eval,
  _timeoutMap:{},
  reportBZStatus:function(_callBack){
    if(name.includes("bz-client")){
      return _callBack({
        url:location.href
      })
    }
    _callBack()
  },
  trigger:function(v){
    console.log("called BZ.trigger:"+location.href)
    return _eval.exeGroupCode(v)
  },
  _focusTW:function(){
    if(!window.name){
      window.name="bz-client"
    }
    window.open("",window.name).focus()
  },
  responseIFrameId:function(vs,_sendResponse,element,retry){
    let id=bzTwComm.frameId
    if(!bzTwComm.appReady||!id||(window.innerHeight<10||window.innerWidth<10)){
      return
    }

    if(vs.find(x=>{
      if(!(""+x).match(/^[0-9]+$/)){
        return location.href.includes(x)
      }
    })){
      console.log("responseIFrameId url: "+id)
      return id
    }
    let v=BZ._findIframePath()
    if(vs.join(",")==v){
      console.log("responseIFrameId ids: "+id)
      return id
    }
  },
  _getCurTestPath:function(){
    return BZ._curTestPath||""
  },
  _setTimeout:function(_timeFun,_timeValue){
    let _bzTimer=setTimeout(function(){
      delete BZ._timeoutMap[_bzTimer]
      if(_timeFun.constructor==String){
        _Util._eval(_timeFun)
      }else{
        _timeFun()
      }
    },_timeValue)
    BZ._timeoutMap[_bzTimer]={f:_timeFun,t:_timeValue}
    return _bzTimer
  },
  _clearTimeout:function(v){
    delete BZ._timeoutMap[v]
    clearTimeout(v)
  },
  _log:function(o){
    if(BZ._debug){
//      console.log(o)
    }
  },
  _backFunMap:{},
  _userHabit:{toolbarPos:{}},
  TW:window,
  _data:_CtrlDriver._buildProxy({_status:0,_uiSwitch:{_testPlay:{}}}),
  _retrieveUserHabit:function(){
    try{
      this._userHabit=_CtrlDriver._buildProxy(JSON.parse(localStorage.getItem("bz-extension-habit"))||{toolbarPos:{}})
    }catch(e){}
  },
  _isPlugIn:function(){
    return 1
  },
  _hasCode:function(v){
    return v.match(/\$(loop|parameter|parentModule|test|module|project|data|util|script)/)
  },
  _findIframePath:function(){
    var p=parent,w=window,v=[];
    while(p!=w){
      for(var i=0;i<p.frames.length;i++){
        if(p.frames[i]==w){
          v.unshift(i)
          break
        }
      }
      w=p
      p=p.parent
    }
    return v.join(",")
  },
  _formatInIFramePath:function(e){
    let v=BZ._findIframePath()
    if(v){
      e[0]="$(BZ.TW.document).findIframe("+v+")"||""
    }
  },
  _showDemoWin:function(){
    _IDE._innerWin._showDemoWin()
  },
  _removeDemoWin:function(){
    _IDE._innerWin._removeDemoWin()
  },
  _storeUserHabit:function(){
    localStorage.setItem("bz-extension-habit",JSON.stringify(this._userHabit));
  },
  _isRecording:function(){
    return this._data._status=="record";
  },
  _getCurModule:function(){
    return _IDE._data._curModule;
  },
  _getCurTest:function(){
    return _IDE._data._curTest;
  },
  _getCurAction:function(){
    return _IDE._data._curAction;
  },
  _insertCss:function(_msg,_time){
    _time=_time||Date.now()
    if(document && document.body && document.body.innerHTML && (["complete","interactive"].includes(document.readyState) || Date.now()-_time>10000)){
      var o=document.createElement("style");
      o.id="bz-css"
  
      o.innerHTML=_msg;
      document.body.parentNode.append(o);
    }else{
      setTimeout(function(){
        BZ._insertCss(_msg,_time)
      },0)
    }
  },  
  _setShareData:function(d){
    if(_ideDataBind._autoFillTime){
      return
    }
    
    try{
      for(var k in d){
        console.log("set share data: "+k)
        var v=d[k]
        if(k=="_aiDataHandler"){
          _aiDataHandler._initData(v)
        }else if(k=="_TWHandler._curMode"){
          _TWHandler._curMode=v
          var o=document.createElement("script");
          o.innerHTML="window._TWHandler&&(window._TWHandler._curMode='"+v+"')";
        }else{
          if(BZ._isRecording()&&_Util._hasCode(k)&&v.constructor==Object){
            if(!window[k]||window[k].constructor!=Object){
              window[k]={}
            }
            _updateRegexData(window[k],v)
          }else{
            var dd=_Util._getSysObj(k);

            if(dd&&dd.constructor==Object&&k=="_ideDataManagement._tmpTaskDataMap"){
              for(var kk in v){
                if(["_app","_loop","_parameter","_env"].includes(kk)){
                  if(v[kk]){
                    if(_ideDataManagement._tmpTaskDataMap[kk]){
                      for(var ki in v[kk]){
                        _ideDataManagement._tmpTaskDataMap[kk][ki]=v[kk][ki]
                      }
                      // _Util._mergeDeep(_ideDataManagement._tmpTaskDataMap[kk],v[kk]);
                    }else{
                      _ideDataManagement._tmpTaskDataMap[kk]=v[kk]
                    }
                  }
                  if(kk=="_env"){
                    BZ._curEnv=_ideDataManagement._tmpTaskDataMap[kk]
                  }
                }else{
                  _ideDataManagement._tmpTaskDataMap[kk]=v[kk]
                }
              }
            }else{
              _Util._setSysObj(k,v)
            }
          }
          if(k=="_ideDataManagement._tmpTaskDataMap"){
            _ideDataManagement._retrieveTmpCurData()
          }
        }
      }
    }catch(e){
      console.log(e.stack)
    }
    
    function _updateRegexData(o,d){
      for(var x in d){
        if(d[x]!=o[x]){
          if(d[x].constructor==Object){
            o[x]=o[x]||{}
            _updateRegexData(o[x],d[x])
          }else if(d[x].constructor==String){
            if(!_Util._isRegexData(d[x])){
              o[x]=d[x]
            }
          }else{
            o[x]=d[x]
          }
        }
      }
    }
  },
  _getDocPath:function(_doc){
    if(BZ.TW.document==_doc){
      return "BZ.TW.document"
    }else{
      var os=$(BZ.TW.document).find("IFRAME");
      for(var i=0;i<os.length;i++){
        try{
          if(os[i].contentDocument==_doc){
            return "$(BZ.TW.document.body).find('IFRAME:eq("+i+")')[0].contentDocument"
          }
        }catch(e){}
      };

    }
  },
  retrieveWinSize:function(){
    var v={
      width:window.innerWidth,
      height:window.innerHeight
    }
    return v;
  },
  _isIgnoreReq:function(r){
    var s=BZ._ignoreReqs;
    if(!s){
      s=BZ._ignoreReqs=(_IDE._data._curVersion.setting.content.ignoreRequest||"").trim().split("\n")
    }
    for(var i=0;i<s.length;i++){
      if(s[i] && r.includes(s[i])){
        return 1
      }
    }
  },
  setDataBindSwitch:function(v){
    v=v?1:0;
    _IDE._innerWin._data._dataBind._showDataBind=v;
    $(".bz-db-menu").remove()
  },
  _generateFrameRoot:function(o,i,doc){
//    if(doc==BZ.TW.document){
//      return "$(BZ.TW.document).find('IFRAME:eq("+i+")')[0].contentDocument"
//    }
    if(!$.isNumeric(i)){
      i="'"+i+"'"
    }
    o.path="$(BZ.TW.document).findIframe("+i+")";
    o.path2=o.path+"|$(BZ.TW.document).find('IFRAME:eq("+i+")')[0].contentDocument"
    return i+1
  },
  refreshFramePath:function(v,doc,n){
    doc=doc||BZ.TW.document;
    var tm=Date.now();
    if(tm==doc.bzRefreshFramePathTime){
      return
    }
    doc.bzRefreshFramePathTime=tm;
    n=n||{n:0};
    var fs=[];
    _Util._findIFrames(doc,fs)
    var ws=[];
    for(var i=0;i<fs.length;i++){
      var f=fs[i];
      if(["bzTipFrame","bzInTimeInfo"].includes(f.id)){
        continue;
      }else if(BZ._isIgnoreReq(f.src)){
        continue;
      }
      var _found=0;
      var r=f.getBoundingClientRect();
      for(var k in v){
        try{
          if(f.contentWindow.location.href==v[k].url){
            _found=1
            n.n=BZ._generateFrameRoot(v[k],n.n,doc);
          }
        }catch(e){
          if(f.src==v[k].url&&!v[k].path){
            _found=1
            n.n=BZ._generateFrameRoot(v[k],n.n,doc);
          }
        }
      }
      if(!_found){
        if(r && r.width && r.height){
          var b=parseInt($(f).css("border"))*2;
          r.width-=b
          r.height-=b
          ws.push({i:(n.n++),r:r})
        }
      }
    }
    if(ws.length){
      var vs=[];
      for(var k in v){
        if(!v[k].path && v[k].size && v[k].size.width && v[k].size.height){
          vs.push(v[k])
        }
      }
      for(var i=0;i<ws.length;i++){
        for(var m=0;m<vs.length;m++){
          if(ws[i].r && vs[m].size && Math.round(ws[i].r.width)==Math.round(vs[m].size.width) && !vs[m].path){
            BZ._generateFrameRoot(vs[m],ws[i].i,doc);
          }
        }
      }
    }
    for(var i=0;i<fs.length;i++){
      try{
        var f=fs[i].contentDocument;
        if(f){
          BZ.refreshFramePath(v,f,n);
        }
      }catch(e){
      }
    }
    return v;
  },
  _hasTestWindow:function(){
    return 1;
  },
  _isCheckout:function(){
    var t=_IDE._data._curTest;
    if(t){
      return 1 //!t._data.lockBy || t._data.lockBy==curUser.id
    }
  },
  _triggerSetStatus:function(s){
    if(!s){
      if(BZ._isPlaying()){
        return bzTwComm._postToIDE({_fun:"_end",_scope:"_ideTask",_args:[1]})
      }else if(BZ._isRecording()){
        return bzTwComm._postToIDE({_fun:"_end",_scope:"_ideRecorder",_args:[s]})
      }
    }
    bzTwComm._postToIDE({_fun:"_setStatus",_scope:"BZ",_args:[s]})
  },
  _setStatus:function(s){
    var cs=BZ._data._status;
    var p=_IDE._innerWin._data._pos;
    _TWHandler._curMode=BZ._data._status=s||"";
    _infoManagement._removeImportantInfo()
    
    _TWHandler._setPlayMode(s)
    localStorage.setItem("playModel",s)
    if(!cs){
      if(s=="record"){
        _domRecorder._start();
        p._inMin=0;
      }else if(s=="play"){
        p._inMin=p._inMin?2:1;
      }
    }else if(!s){
      if(cs=="record"){
        p._inMin=0;
        _domRecorder._end();
      }else if(cs=="play"){
        _TWHandler._setBackTestPage()
        p._inMin=p._inMin==2?1:0;
      }
      window._tmpLoopData={}
    }
    if(s=="pause" && BZ._lastResult && ![4,3].includes(BZ._lastResult._type)){
      _domActionTask._showIssueInComment(BZ._lastResult);
    }else{
      BZ._lastResult=0
    }
    if(s=="record"){
      _descAnalysis._clearTmpPath(1);
    }
    _IDE._innerWin._refresh()
  },
  _isAutoRunning:function(){
    return BZ._data._autoRunning;
  },
  _isNothing:function(){
    return !BZ._data._status
  },
  _isPlaying:function(){
    return BZ._data._status=="play";
  },
  _isPausing:function(){
    return BZ._data._status=="pause";
  },
  _isRecording:function(){
    return BZ._data._status=="record";
  },
  _inProcessing:function(){
    return ['record','play','pause'].includes(BZ._data._status);
  },
  _prepareDocument:function(_fun){
    this._documents=_BZDocumentsHandler._buildMe()
    _fun&&_fun()
  },
  exeFun:function(_fun,_scope,_data,_bkFun){
    let v;
    v=_scope.split(".")
    _scope=window
    v.forEach(x=>{
      _scope=_scope[x]
    })
    _scope[_fun](_data)
    if(_bkFun){
      _bkFun(v)
    }
  }
};

var _IDE={
  _modulePathRegex:/(\/(m[0-9]+|bug|com))+/,
  _testPathRegex:/(\/(m[0-9]+|bug|com))+\/t[0-9]+/,
  _testKeyRegex:/(m[0-9]+|com)\.t[0-9]+/,
  _actionPathRegex:/(\/(m[0-9]+|bug|com))+\/t[0-9]+\/[0-9]+/,
  _exePathRegex:/(\/(m[0-9]+|bug|com))+\/t[0-9]+\/([0-9]+|actions|)/,
  _objRegex:/(\/(m[0-9]+|bug|com))+(\/t[0-9]+)*/,
  _insertJSRegex:/((\{\{).*\$(project|module|test|loop|data|group|action|parameter)((\.|\[)[a-zA-Z0-9\u4E00-\u9FCC_\$\'\"\[\]\.]+)*.*(\}\}))/g,
  _insertJSOnlyRegex:/(\$(project|module|test|loop|data|group|action|parameter)((\.|\[|$)[a-zA-Z0-9\u4E00-\u9FCC_\$\'\"\(\)]+(\])*)*)/g,
  _data:{
    _curVersion:{},
    _curTest:0,
    _curModule:0,
    _setting:{
      appLanguages:[""]
    }
  }
};
var _apiDataHandler={}
var _cooperatorHandler={}
var _appWordHandler={_wordMap:{}}

console.log("")

var _identifyIFrameHandler={
  _setIframePath:function(v){
    _identifyIFrameHandler._iframePath=v
  },
  _reportIFrame:function(_requestFlag){
    if(_identifyIFrameHandler._curJudgeIFrameFlag==-1){
      _identifyIFrameHandler._curJudgeIFrameFlag=0
      return
    }
    if(window.innerWidth>10&&window.innerHeight>10){
      let fs=[]
      $("IFRAME").toArray().forEach(x=>{
        x=_identifyIFrameHandler._getIFrameSize(x)
        if(x){
          fs.push(x)
        }
      })
      let d={
        _bzIframeId:bzTwComm.frameId,
        _path:_identifyIFrameHandler._iframePath,
        fs:fs,
        _requestFlag:_requestFlag,
        _time:Date.now(),
        _curJudgeIFrameFlag:_identifyIFrameHandler._curJudgeIFrameFlag
      }
      if(_identifyIFrameHandler._curJudgeIFrameFlag){
        _identifyIFrameHandler._curJudgeIFrameFlag=-1
      }
      if(parent!=window){
        d._width=Math.round(window.innerWidth)
        d._height=Math.round(window.innerHeight)
      }
      bzTwComm._postToIDE({_scope:"_iframeManagement",_fun:"_registerIframe",_args:[d]})
    }
  },
  _getIFrameSize:function(x){
    let r1=x.getBoundingClientRect()

    if(r1.width>10&&r1.height>10&&x.id!="bzInTimeInfo"&&!_Util._isBlankIFrame(x)){
      x.frameBorder=0
      let r=x.getBoundingClientRect()
      let w=r.width,h=r.height
      if(r.width!=r1.width){
        x.frameBorder=1
      }
      return {
        _width:Math.round(w),
        _height:Math.round(h),
        id:x.id,
        f:x
      }
    }
  },
  _setJudgeIFrameFlag:function(v){
    _identifyIFrameHandler._curJudgeIFrameFlag=v
  },
  _setPath:function(v){
    _identifyIFrameHandler._iframePath=v
  },
  _getBlankIFrameID:function(f){
    if(f.id){
      return f.id
    }
    let i=0;
    if($("IFRAME").toArray().find(x=>{
      try{
        let r=x.getBoundingClientRect()
        if(r.width>10&&r.height>10&&_Util._isBlankIFrame(x)){
          i++
          if(x==f||x.contentWindow==f){
            f=x
            return 1
          }
        }
      }catch(e){}
    })){
      return f.id||(i-1)
    }
  },
  _showInfo:function(){
    document.body.children[0].innerText=bzTwComm.frameId+":"+_identifyIFrameHandler._iframePath
  },
  _judgeIFrameByChangeSize:function(v){
    v=v||0
    let ws=[]
    $("IFRAME").toArray().forEach(x=>{
      x=_identifyIFrameHandler._getIFrameSize(x)
      if(x){
        ws.push(x)
      }
    })
    $(document.body).hide()
    ws.forEach(x=>{
      x.sw=$(x.f).css("width")
      x.sh=$(x.f).css("height")
    })
    $(document.body).show()
    ws.forEach((x,i)=>{
      $(x.f).css({height:parseInt(x._height)+(i+v)+"px"})
    })
    _identifyIFrameHandler._reportIFrame()
    setTimeout(()=>{
      ws.forEach((x,i)=>{
        $(x.f).css({height:x.sh})
      })
    },10)
  }
}
/* For Iframe report
if(window!=parent){
  window.onresize=function(){
    _identifyIFrameHandler._reportIFrame()
  }
  _identifyIFrameHandler._reportIFrame()

  let o=document.createElement("div")
  o.innerText=bzTwComm.frameId
  document.body.insertBefore(o,document.body.childNodes[0])
}
*/;//Response on send data from client web page to BZ extension package
var _transferMonitor={
  _config:{ attributes: true, childList: true, characterData: true,subtree:true,attributeOldValue:true,characterDataOldValue:true },
  _init:function(){
    if(_IDE._data._curVersion.setting.content.completeActionOnRender&&!_transferMonitor._pageObserver){
      _transferMonitor._pageObserver=new MutationObserver(function(_mutations) {
        var s=_IDE._data._curVersion.setting.content.ignoreRenderElement||""
        if(s){
          s=$(BZ.TW.document.body).find(s)
          for(var i=0;i<_mutations.length;i++){
            var o=_mutations[i].target
            
            if(!s.is(o)&&!s.find(o)[0]&&o.getBoundingClientRect){
              o=o.getBoundingClientRect()
              if(o.width&&o.height){
                return _transferMonitor._lastUIUpdate=Date.now()
              }
            }
          }
        }else{
          _transferMonitor._lastUIUpdate=Date.now()
        }
      })

      _transferMonitor._pageObserver.observe(BZ.TW.document.body,this._config);
      _transferMonitor._lastUIUpdate=Date.now()
    }
  },
  _chkUITimer:0,
  _reChkTimer:0,
  _getUICompleteTime:function(_fun,_retry){
    setTimeout(()=>{
      if(bzTwComm._isIDE()){
        _transferMonitor._chkUITimer=Date.now()
        bzTwComm._postToExt({_fun:"_getUICompleteTime",_scope:"_transferMonitor",_args:[function(v){
          clearTimeout(_transferMonitor._reChkTimer)
          _transferMonitor._reChkTimer=0
          _fun(v)
        }],_element:["BZ.TW.document"]})

        _transferMonitor._reChkTimer=setTimeout(()=>{
          if(_transferMonitor._chkUITimer){
            _transferMonitor._chkUITimer=0
            if(!_retry){
              _transferMonitor._getUICompleteTime(_fun,1)
            }else{
              _fun()
            }
          }
        },2000)
        return
      }

      _transferMonitor._lastUIUpdate=_transferMonitor._lastUIUpdate||Date.now()
      var t=_transferMonitor._lastUIUpdate
      if(Date.now()-t>500){
        _fun(t)
      }else{
        setTimeout(function(){
          _transferMonitor._getUICompleteTime(_fun)
        },10)
      }
    },1)
  }
};var _bzDomPicker={
  _data:(window._CtrlDriver&&_CtrlDriver._buildProxy({_autoRefresh:"on"}))||{_autoRefresh:"on"},
  _pdb:(window._CtrlDriver&&_CtrlDriver._buildProxy({_refreshShowList:1}))||{_refreshShowList:1},
  _textMethods:[
    "",
    ":text",
    ":input",
    ":panel",
    ":after",
    ":before",
    ":contains",
    ":Contains",
    ":equal",
    ":endEqual",
    ":endContains",
    ":near",
    ":RowCol",
    ":rowcol"
  ],
  _methods:[
    "",
    ":text",
    ":input",
    ":panel",
    ":after",
    ":before",
    ":near",
    ":RowCol",
    ":rowcol"
  ],
  _preRequire:null,
  _selectedItem:null,
  _selectedCover:null,
  _curDom:null,
  _getTWElementPathByCSS:function(c,_fun,_reTry){
    if(bzTwComm._isIDE()){
      bzTwComm._postToExt({_fun:"_getTWElementPathByCSS",_scope:"_bzDomPicker",_args:[c,_fun]});
      return
    }
    
    if(window.innerWidth>10&&window.innerWidth>10){
      let cc=c?$util.findDom(["BZ.TW.document",c,0]):0
      if(cc){
        c=_cssHandler._findPath(cc)
      }else if(!_reTry){
        return setTimeout(()=>{
          _bzDomPicker._getTWElementPathByCSS(c,_fun,1)
        },1000)
      }else{
        c=0
      }
    }else{
      return
    }
    _fun(c);
  },
  _hasChild:function(d){
    let os=d._dom.children;
    if(os&&d==_bzDomPicker._data._focusItem){
      for(let o of os){
        if(_bzDomPicker._data._items.find(x=>o==x._dom)){
          return
        }
      }
      return os.length
    }

  },
  _hasSibling:function(){
    let d=_bzDomPicker._data._items
    d=d[d.length-1]
    return d._dom.parentElement.children.length>1;
  },
  _getDomDesc:function(d){
    d=d||_bzDomPicker._data._focusItem
    let o=d._dom
    if(!o.tagName){
      return o
    }
    let w="<"+o.tagName.toLowerCase()
    if(o.id){
      w+=` id="${o.id}"`
    }
    if(o.classList.length){
      w+=` class="${o.className}"`
    }
    for(let i=0;i<o.attributes.length;i++){
      let a=o.attributes[i],v=a.value
      if(!a.name.match(/^(id|class|style|on.+)$/)&&v){
        w+=` ${a.name}="${v}"`
      }
    }
    w+=">"
    if(w.length>50){
      w=w.substring(0,45)+" ..."
    }
    return w
  },
  _getMethodByText:function(o,w){
    let os=_Util._getTargetElement($(`:endContains(${w})`)),m
    _Util._spliceAll(os,x=>_Util._isHidden(x))
    if(!os.length){
      os=$(`:Contains(${w})`)
      _Util._spliceAll(os,x=>_Util._isHidden(x))
      os=_Util._getCeilDom(os)
    }

    _Util._spliceAll(os,(x,j)=>{
      if($(o).find(x)[0]||o==x){
        m=":Contains"
      }
    })

    if(m&&($util.getElementText(o)==w||!os.length)){
      return m;
    }

    let as=$("*")
    let ss=os.map(x=>as.index(x)),_idx=as.index(o)
    os.sort((a,b)=>{
      return Math.abs(as.index(a)-_idx)-Math.abs(as.index(b)-_idx)
    })
    if(as.index(os[0])>_idx){
      m=":before"
    }else{
      m=":after"
    }
    return m
  },
  _getTextByMethod:function(o,m){
    let _txt=$util.getElementText(o),
        p=o.parentElement
    m=m.replace(":","")
    setTimeout(()=>{
      _bzDomPicker._setValue()
      _bzDomPicker._resetLastIdx()
    },1000)
    switch(m){
      case "near":
		return _Util._findNearTxt(o)
      case "after":
        while(p){
          let t=$util.getElementText(p),w=""
          if(t!=_txt){
            for(let n of p.childNodes){
              if(n==o){
                break
              }else{
                if(n.nodeType==3){
                  w=n.textContent.trim()||w
                }else if(n.nodeType==1){
                  w=$util.getElementText(n)||w
                }
              }
            }
            w=(w||"").trim()
            if(w){
              return w
            }
          }
          o=p
          p=p.parentElement
        }
      case "before":
        while(p){
          let t=$util.getElementText(p),w="",_start
          if(t!=_txt){
            for(let n of p.childNodes){
              if(n==o){
                _start=1
              }else if(_start){
                if(n.nodeType==3){
                  w=" "+n.textContent
                }else if(n.nodeType==1){
                  w=" "+$util.getElementText(n)
                }
                w=w.trim()
                if(w){
                  return w
                }
              }
            }
          }
          o=p
          p=p.parentElement
        }
      case "contains":
      case "Contains":
      case "equal":
        return _txt.trim().substring(0,30).trim()
      case "endContains":
      case "endEqual":
        for(let x of o.childNodes){
          if(x.nodeType==3&&x.textContent.length){
            return x.textContent
          }
        }
        return ""
      case "rowcol":
      case "RowCol":
        let _area
        if($("td,th").find(o)[0]){
          _area=_Util._getClosestElement(o,o,"table")
        }
        _area=_area||document.body
        let os=$(_area).find(":endContains(*)").toArray()
        while($util.getElementText(o.parentElement)==_txt){
          o=o.parentElement
        }
        let r=o.getBoundingClientRect(),_col,_row
        os.find(x=>{
          if(x==o){
            return 1
          }
          if(!_col||!_row){
            let xr=x.getBoundingClientRect()
            if(!_col){
              if(xr.left>=r.left-10&&xr.right<=r.right+10){
                _col=$util.getElementText(x)
              }
            }else{
              if(xr.top>=r.top-10&&xr.bottom<=r.bottom+10){
                _row=$util.getElementText(x)
                if(_row){
                  return 1
                }
              }
            }
          }
        })
        if(_col&&_row){
          return _row+"|"+_col
        }
        return ""
    }
  },
  _setMousedown:function(o){
    o.onmousedown=function(e){
      if(e&&e.button==2){
        if(this.children.length){
          return
        }
        bzTwComm._postToIDE({_fun:"_cancel",_scope:"_bzDomPicker"})
        _bzDomPicker._cancel()
        e.preventDefault();
        e.stopPropagation()
        let _fun=document.body.oncontextmenu
        document.body.oncontextmenu=function(e){
          e.preventDefault();
          e.stopPropagation()
          document.body.oncontextmenu=_fun
          return false
        }
        return false
      }
      if(!BZ._autoRecording){
        _IDE._innerWin._data._curDomPath=0
      }
      try{
        var _pos=e?_Util._getMouseXY(e):{x:0,y:0};
        if(e&&e.target.o&&e.target.o.tagName=="CANVAS"){
          e.target.o.bzTxtElement=_TWHandler._getCanvasTextElementByMousePos(e.target.o,_pos.x,_pos.y)
          delete e.target.o.bzTmp
        }
      }catch(e){}
      _bzDomPicker._popWin(this._orgDom,_pos)
    }
    o.onkeydown=function(e){
      if(27==e.keyCode){
        _bzDomPicker._endRequire()
      }
    }
    /*
    o.onblur=function(){
      this.focus()
    }
    */
    setTimeout(function(){
      o.focus()
    },1500)
  },
  _scrollSync:function(){
    if(BZ._documents){
      _bzDomPicker._resetPos(BZ._documents.find(".BZCover,.ErrBZCover"));
    }
    $(BZ.TW.document).find("IFRAME").each(function(i,o){
      try{
        if(!o.src.startsWith("http")){
          _bzDomPicker._resetPos($(o.contentDocument).find(".BZCover,.ErrBZCover"))
        }
      }catch(e){}
    });
    _bzDomPicker._resetPos($(BZ.TW.document).find(".BZCover,.ErrBZCover"));
  },
  _pickDetails:function(d,_fun){
    if(!BZ.TW||BZ.TW.closed){
      return BZ._launchCurEnvUrl(0,function(){
        _bzDomPicker._pickDetails(d,_fun)
      })
    }
    let _element=d&&d.constructor==Array&&d
    if(window._extensionComm){
      bzTwComm._postToExt({_fun:"_pickDetails",_scope:"_bzDomPicker",_args:[d,_fun],_element:_element});
    }else{
      _bzDomPicker._start({_id:"_element",_back:_back,_type:d=="_pageAnalysis"||d=="_path"?"":d});
    }
    function _back(_path,_pos,_element){
      var vs;
      //TODO: 2019-05-12
      if(d=="_pageAnalysis"){
        _aiPageHandler._parseContent(_path,_element,function(d){
          if(bzTwComm._isExtension()){
            for(var k in d){
              d[k].forEach&&d[k].forEach(e=>{
                if(e.name){
                  e.alias=_glossaryHandler._getVariableName(e.name)
                  e.name=_Util._toCapitalWord(_Util._parseCamelWords(e.alias))
                }
                BZ._formatInIFramePath(e.path)
              })
            }
          }
          _fun(d)
        })
        _bzDomPicker._endRequire()
        return 
      }else if(d=="_path"){
        vs=_cssHandler._findPath(_element)
      }else{
        vs=[{_css:_element.tagName}]
        var as=_element.attributes;
        for(var i=0;i<as.length;i++){
          var a=as[i]

          if(a.name=="class"){
            var v=a.value.split(/[ ]+/)
            v.forEach(function(vv){
              if(vv){
                vs.push({_css:"."+vv})
              }
            })
          }else if(a.name=="id"){
            vs.push({_css:"#"+a.value})
          }else{
            vs.push({_css:":attr("+a.name+"="+a.value+")"})
          }
        }
        if(!["SVG","SELECT","TEXTAREA"].includes(_element.tagName)){
          vs.push({_css:":Contains("+_Util._toTrimSign($util.getElementText(_element),100)+")"})
        }
      }
      _fun(vs)
      _bzDomPicker._endRequire()
    }
  },
  _pickElement:function(_path,_fun,_url){
    _path=_path||""
    var d={_type:_path},e;
    if(_path.constructor==Object){
      d=_Util._clone(_path)
      d._type=_path._path
    }
    if(d._type&&d._type.constructor==Array){
      e=d._type
    }
    if(bzTwComm._isIDE()){
      bzTwComm._postToIDE({_fun:"_pickElement",_scope:"_bzDomPicker",_element:e,_args:[_path]});
    }else{
      d._id="_element"
      d._back=_fun||_back
      _bzDomPicker._start(d,_url);
    }
    function _back(p,_pos,_element){
      if(_path._fun){
        p={_path:p,_result:window[_path._scope][_path._fun](_element,p)}
      }
      if(_path._requireUrl){
        if(p.constructor==Array){
          p={_path:p}
        }
        p._requireUrl=location.href
      }
      //for force open dom picker
      if(BZ._data._uiSwitch._tmpPath){
        BZ._data._uiSwitch._tmpPath=0
      }
      if(bzTwComm._isExtension()){
        BZ._formatInIFramePath(p._path||p)
        bzTwComm._postToIDE({_fun:"_pickElement",_scope:"_bzDomPicker",_args:[p]});
      }else{
        _fun(p)
      }
      _bzDomPicker._endRequire()
    }
  },
  _start:function(_require,_url){
    var w=this._domPickerWindow;
    if(w&&!w.closed){
      this._preRequire=this._curRequire
      w.close();
    }else{
      this._preRequire=0
    }

    if(!BZ.TW || BZ.TW.closed){
      BZ._setStatus("play");
      var _test={
        enterPoint:{
          type: "newpage",
          value:_url||_ideTask._test._getEnterPointValue()
        }
      };
      _ideTask._test._doTestEnterPage(_test,0,function(){
        _ideTask._end();
        _require._path=_require._type
        _popErr();
      });
      return 
    }

    function _popErr(){
      if(_extensionComm._pageReady){
        setTimeout(()=>{
          _bzDomPicker._pickElement(_require,_require._back)
        },1000)
      }else{
        setTimeout(()=>{
          _popErr()
        },1000)
      }
    }

    window._infoManagement&&_infoManagement._showImportantInfo(_bzMessage._picker._reminder,0,0,1)
    BZ._focusTW(BZ.TW);
    var _this=this;

    BZ._prepareDocument(function(){
      BZ.TW.focus();
      _this._curRequire=_require;
      BZ._data._domPickerStatus=_require._id;
      let _autoRefresh=_this._data._autoRefresh
      _this._data=_CtrlDriver._buildProxy({_autoRefresh:_autoRefresh});

      _this._removeTmpCover();
      _this._selectedCover=null;
      
      if(_require._type){
        _this._autoMarkSelect(_require);
      }else{
        _this._manualSelect();
      }
    });
  },
  _editPath:function(_path,_fun){
    if(bzTwComm._isIDE()){
      bzTwComm._postToExt({_fun:"_editPath",_scope:"_bzDomPicker",_args:[_path,_fun],_element:_path});
    }else{
      _bzDomPicker._start({_id:"_editPath",_back:_back,_type:_path});
    }
    function _back(p){
      if(bzTwComm._isExtension()){
        BZ._formatInIFramePath(p)
        _fun(d)
      }
    }
  },
  _autoMarkSelect:function(_require){
    var os=null,_type=_require._type;

    //manual re-select on old action
    if($.isArray(_type)){
      os = $util.findDom(_type);
      if(os){
        os=[os];
        BZ._data._uiSwitch._tmpPath=0
      }else{ // for lost old element from page
        _bzDomPicker._popWin()
        BZ._data._uiSwitch._tmpPath=_type
        //_infoManagement._showImportantInfo("The element wasn't found on the current page. Please be sure it is on the page and re-pick it.",0,0,1)
//        this._manualSelect();
        return;
      }
    }else{
      //filter, for form input, or user search dom
      this._data._filter=_require._filter;
      os = BZ._documents.find(_type);
    }
    
    if(!os || !os.length){
      _bzDomPicker._domPickerWindow.alert(_Util._formatMessage(_bzMessage._picker._noExpectedType,[_require._filter||_type]));
      
      _bzDomPicker._curRequire._type=_bzDomPicker._preType
      _bzDomPicker._start(_bzDomPicker._curRequire)
      return
    }
    var cs=this._showTmpCover(os);
    if(cs.length==1){
      cs[0].onmousedown();
    }else{
      this._curRequire._type=null;
    }
  },
  _isActionElementPicking:function(){
    return BZ._data._domPickerStatus=="_actionElementPick";
  },
  _isFormElementPicking:function(){
    return BZ._data._domPickerStatus=="_formElementPick";
  },
  _isDomRootElementPicking:function(){
    return BZ._data._domPickerStatus=="_domRootElementPick";
  },
  _isPicking:function(){
    return Boolean(BZ._data._domPickerStatus);
  },
  _manualSelect:function(){
    this._selectedCover=this._createTmpCover();

    $(this._selectedCover).mouseover(function(e){
      this._startPos = _Util._getMouseXY(e);
    });
    BZ._documents.find("body").mouseleave(function(e){
      setTimeout(function(){
        $(_bzDomPicker._selectedCover).hide();
      },100);
    });
    this._selectedCover.onmousemove=function(e){
      clearTimeout(this._removeTimer)
      var ca=_IDE._data._curAction;
      var at=_ideActionData._type;
      if(_bzDomPicker._curRequire && ["_actionElementPick","_element"].includes(_bzDomPicker._curRequire._id) && !ca){
        return _bzDomPicker._removeTmpCover();
//        return _bzDomPicker._endRequire();
      }
      if(this._orgDom && this._orgDom.tagName=="IFRAME"){
        BZ._prepareDocument();
        _bzDomPicker._defineDocMouseover();
        return _bzDomPicker._removeTmpCover();
      }
      if(!this._startPos){
        this._startPos = _Util._getMouseXY(e);
      }else{
        var _newPos = _Util._getMouseXY(e);
        var dx=_newPos.x-this._startPos.x;
        var dy=_newPos.y-this._startPos.y;
        if(dx<-2 || dx>2 || dy<-2 || dy>2){
          var o=_Util._getMouseOnChild(this.o,_newPos)
          if(o){
            _bzDomPicker._setTmpCoverPosByDom(o,this)
          }else if(this.o.tagName=="CANVAS"){
            this.o.bzTxtElement=0
            let pp=_TWHandler._getCanvasTextElementByMousePos(this.o,_newPos.x,_newPos.y)
            if(pp!=this.o.bzTxtElement){
              this.o.bzTxtElement=pp
              _bzDomPicker._setTmpCoverPosByDom(this.o,this)
            }
          }else{
            this._removeTimer=setTimeout(()=>{
              this.remove()
            },100)
          }
        }
      }
    };
    this._selectedCover.onmouseout=function(e){
      if(this._orgDom && this._orgDom.tagName=="IFRAME"){
        return
      }
      var o=_Util._getMouseOnParent(this.o,_Util._getMouseXY(e))
      if(o!=this.o){
        _bzDomPicker._setTmpCoverPosByDom(o,this)
      }
    }
    this._defineDocMouseover();
  },
  _defineDocMouseover:function(){
    BZ._documents.find("body").unbind("mouseover");
    BZ._documents.find("body").bind("mouseover",_bzDomPicker._mouseoverEvent);
    if(bzTwComm._isExtension()){
      $("IFRAME").each(function(i,o){
        if(!o.src.startsWith("http")){
          $(o.contentDocument).find("body").bind("mouseover",_bzDomPicker._mouseoverEvent);
        }
      })
    }
    function _doIt(e){ //document.body.mouseover event
    }
  },
  _mouseoverEvent:function(e){
    var _timeoutHandle=null;
    if(!_bzDomPicker._curRequire){
      return;
    }
    
    window.clearTimeout(_timeoutHandle);

    _timeoutHandle=window.setTimeout(function(){
      var o =_Util._getSouElementFromEvent(e)
      if(o.shadowRoot&&_Util._hasDeepContent(o.shadowRoot)){
        if(!o.shadowRoot._bindPicker){
          o.shadowRoot._bindPicker=1
          var os=$(o.shadowRoot).find("*").not("style,script"),oo;
          os.bind("mouseover",_bzDomPicker._mouseoverEvent)
          for(var i=0;i<os.length;i++){
            if($(os[i]).css("pointer-events")!="none"){
              oo=os[i]
            }
          }
          if(oo){
            _bzDomPicker._mouseoverEvent({target:oo})
          }
        }
        return
      }

      if(o!=_bzDomPicker._selectedCover){
        $(_bzDomPicker._selectedCover).hide();
        if(!$(o).hasClass("BZIgnore") && BZ._documents.find(".BZIgnore").find(o).length==0){
          _bzDomPicker._curDom=o;
          _bzDomPicker._setTmpCoverPosByDom(o,_bzDomPicker._selectedCover);
          if(!_IDE._innerWin._data._pos._inMin){
            clearTimeout(_bzDomPicker._showPathTimer)
            _bzDomPicker._showPathTimer=setTimeout(function(){_bzDomPicker._showPath(o)},300)
          }
        }
      }
    },100);
  },
  _showPath:function(o){
    if(BZ._autoRecording){
      return
    }
    let vs=_bzDomPicker._getElementOptions(o).map(x=>x._value),
        w=$util.getElementText(o)
    if(w){
      w=": "+w
    }
    vs.unshift(o.tagName+(w||""))
    _IDE._innerWin._data._curDomPath=vs
  },
  _endRequire:function(){
    if(BZ._isRecording()){
      setTimeout(function(){
        _bzDomPicker._removeTmpCover();
      },1000);
    }else{
      _bzDomPicker._removeTmpCover();
    }
    _bzDomPicker._curRequire=0

    // if(_bzDomPicker._curRequire){
      // BZ._data._domPickerStatus=_bzDomPicker._curRequire._id;
    // }else{
      // BZ._data._domPickerStatus=null;
    // }
//    BZ._setOperationInfo("");
  },
  _getFinalTargetElement:function(_path,o){
    let p=_Util._clone(_path)
    while(p.length){
      let x=p.pop()
      if(!$.isNumeric(x)){
        x=x.split(/[\:\.\#\[]/)
        if(x[0].toLowerCase()==o.tagName.toLowerCase()){
          return o
        }
        while(o.parentElement){
          if(o.parentElement.tagName.toLowerCase()==x[0].toLowerCase()){
            return o.parentElement
          }
          o=o.parentElement
        }
        break
      }
    }
  },
  _popWin:function(o,_pos){
    if(!this._curRequire){
      return;
    }
    if(o){
      if(o.bzTmp&&o.bzTmp.constructor==String){
        o.bzTmp=0
      }
      var _path = o.bzTmp||_cssHandler._findPath(o,0,_bzDomPicker._curRequire._simple);
      o=_bzDomPicker._getFinalTargetElement(_path,o)||o

      if(this._curRequire._type && this._curRequire._type.constructor==Array && this._curRequire._type.length){
        if(this._curRequire._type[0].startsWith("BZ.TW.document")){
          _path=_Util._clone(this._curRequire._type);
          var _idx=parseInt(_path[_path.length-1]);
          if(!_idx && _idx!=0){
            _path.push(0);
          }
        }
      }
      if(!_path){
        return
      }
      if(!BZ._data._uiSwitch._tmpPath&&!this._isDomRootElementPicking() && this._curRequire._id!="_domRoot" && !this._data._filter && (!this._curRequire._type || this._curRequire._type.constructor!=Array)){
        _bzDomPicker._curRequire._back(_path,_pos,o);
        _bzDomPicker._endRequire();
        return 1
      }
      BZ._data._uiSwitch._tmpPath=BZ._data._uiSwitch._tmpPath||1
      this._data._pos=_pos;
      _bzDomPicker._setNewPath(_path,o);
    }

    this._domPickerWindow =w= _Util._popWin("","_domPicker",null,800,500,_pickerTemplate,_bzMessage._picker._name);
    var d=w.document;
    this._document=d;
    
    if(o){
      this._testPath();
      o=_bzDomPicker._data._items[_bzDomPicker._data._items.length-1]
      _bzDomPicker._setFocusItem(o)
    }
  },
  _setNewPath:function(_path,o){
    _bzDomPicker._curDom=o||_bzDomPicker._curDom;
    this._data._items = this._getAllLayerElements(_bzDomPicker._curDom,_path);
  },
  _getAllLayerElements:function(o,ps){
    var _paths=[];
    var _body=$(_Util._eval(ps[0]));
    while(o.parentNode){
      if(o.tagName!="BODY"){
        _paths.unshift({_dom:o,_selected:false,_opened:true,_value:""});
        o=o.parentNode;
      }else{
        _paths.unshift({_dom:ps[0],_selected:true,_opened:false,_value:ps[0]});
        break;
      }
    }
    var _last=1;
    ps=ps.map(x=>x)
    let _idx=ps.pop()
    if(!$.isNumeric(_idx)){
      ps.push(_idx)
    }else{
      this._data._lastIdx=_idx
    }
    for(var i=1;i<ps.length;i++){
      if(i==ps.length-1){
        _paths[_paths.length-1]._selected=true;
        _paths[_paths.length-1]._value=ps[i];
        _paths[_paths.length-1]._opened=false;
        break;
      }
      
      var os=_body.find(_JSHandler._prepareData(ps[i]).trim());
      for(var ii=_last;ii<_paths.length;ii++){
        if(os.is(_paths[ii]._dom)){
          // if(_paths[ii+1]&&(os.is(_paths[ii+1]._dom) && $(_paths[ii+1]._dom).find(_body.find(ps[i+1])).length)){
          //   continue;
          // }
          _paths[ii]._selected=true;
          _paths[ii]._opened=false;
          _paths[ii]._value=ps[i];
          _last=ii+1;
          break;
        }
      }
    }

    _hideItems(_paths)
    return _paths;

    function _hideItems(ps){
      let s=[],_last,_pre
      for(var i=0;i<ps.length;i++){
        if(!ps[i]._selected&&!ps[i]._showHideItem){
          s.push(ps.splice(i--,1)[0])
        }else{
          if(_last&&s.length){
            _last._subHideItems=s
          }
          if(_last){
            _pre=_last
          }
          _last=ps[i]
          s=[]
        }
      }
      if(_pre&&_pre._subHideItems&&_pre._subHideItems.length){
        let i=3,_idx=ps.indexOf(_pre);
        while(i--&&_pre._subHideItems.length){
          ps.splice(_idx+1,0,_pre._subHideItems.pop())
        }
        if(!_pre._subHideItems.length){
          _pre._subHideItems=0
          _pre._showHideItem=1
        }
      }
    }
  },
  _showHiddenSubItems:function(o){
    let _idx=o._idx
    o._item._subHideItems.forEach(function(x){
      _bzDomPicker._data._items.splice(++_idx,0,x)
      x._showHideItem=1
    })
    o._item._subHideItems=null
  },
  _resetLastIdx:function(_force){
    if(!_force&&!_bzDomPicker._data._autoRefresh){
      return
    }
    
    _bzDomPicker._pdb._showSlowInfo=0
    _bzDomPicker._pdb._showResetInfo=1
    // _bzDomPicker._pdb._refreshShowList=0
    clearTimeout(_bzDomPicker._resetListIdxTimer)
    _bzDomPicker._resetListIdxTimer= setTimeout(function(){
      var v="",d=[],_lastDom=null,i;
      for(var i=1;i<_bzDomPicker._data._items.length;i++){
        var o=_bzDomPicker._data._items[i];
        if(o._selected){
          v+=" "+o._value;
          d.push(o._value)
          _lastDom=o._dom;
        }
      }
      _bzDomPicker._data._lastIdx="ERR";
      if(_lastDom){
        d.unshift(_bzDomPicker._data._items[0]._dom)
        var os=_Util._findDoms(d)
        if(os){
          var i=os.index?os.index(_lastDom):os.indexOf(_lastDom);;
          if(i>=0){
            _bzDomPicker._data._lastIdx=i;
          }
        }
      }
      _bzDomPicker._testPath();
       _bzDomPicker._pdb._refreshShowList=1
    },20)
  },
  _createTmpCover:function(_doc,bErr, _multiple){
    var o = null;
    _doc=_doc || (BZ._documents?BZ.TW.document:null);
    if(!_doc){
      return;
    }

    this._tmpBox = _doc.createElement("div");

    var s="position:fixed;border:1px solid "+(_IDE._innerWin._data._tools._inDark?'#FFF':'#007bff')+";filter:alpha(opacity=20);cursor:pointer;z-index:2147483646;";
    if (!_multiple){
      s+="box-shadow: 2px 2px 9px rgba(255, 255, 255, 1);"
    }
    let _tag=_multiple?"div":"canvas"

    this._tmpBox.innerHTML=`<${_tag} class='${bErr?'Err':''}BZCover BZIgnore' style='${s}background-color:rgb(255,105, 105,0.2);' title='${_bzMessage._method._rightClickToCancel}'></${_tag}>`;

    o=this._tmpBox.childNodes[0];

    $(o).insertAfter(_doc.body);
    _bzDomPicker._setMousedown(o);
    return o;
  },
  _removeTmpCover:function(){
    try{
      if(bzTwComm._isIDE()){
        _extensionComm._setCmd("_bzDomPicker._removeTmpCover()")
      }
      $(window.document).find(".BZCover,.ErrBZCover").remove();
      if(BZ._documents){
        BZ._documents.find(".BZCover,.ErrBZCover").remove();
      }
      $(BZ.TW.document).find("IFRAME").each(function(i,o){
        try{
          if(!o.src.startsWith("http")){
            $(o.contentDocument).find(".BZCover,.ErrBZCover").remove()
          }
        }catch(e){}
      });
      $(BZ.TW.document).find(".BZCover,.ErrBZCover").remove();
    }catch(e){}
  },
  _resetPos:function(cs){
    for(var i=0;i<cs.length;i++){
      var c=cs[i]
      _bzDomPicker._setTmpCoverPosByDom(c.o,c)
    }
  },
  _setTmpCoverPosByDom:function(o,c){    
    if(!c || !o){
      return;
    }else if(window.name!="bz-master" && BZ.TW && BZ.TW.document && (o==BZ.TW || o==BZ.TW.document)){
      o=BZ.TW.document.body;
    }else if(bzTwComm._isExtension() && o.tagName=="IFRAME" && o.src.startsWith("http")){
      return;
    }
    if(o.tagName=="IFRAME"){
      return;
    }
    c.o=o;
    c._orgDom=o;
    
    if(c.tagName=="CANVAS"){
      if(!["SELECT","BUTTON","A","INPUT","TEXTAREA"].includes(o.tagName)){
        $(o).attr("tabindex",0)
        o.focus()
        o.removeAttribute("tabindex")
      }
      o.focus()

    }
    //$(c).insertAfter(document.body);
    o.ownerDocument.body.appendChild(c);
    if(o.tagName=="INPUT"&&o.type=="file"){
      o=o.parentElement
    }
    var xy = _Util._getDomXY(o),w,h;
    c.style.top=xy.y+"px";
    c.style.left=xy.x+"px";
    if(o.offsetWidth===undefined){
      w=o.getBoundingClientRect().width
    }else if(o.offsetWidth>0){
      w=o.offsetWidth
    }else{
      w=(o.getBoundingClientRect().width||10)
    }
    if(o.offsetHeight===undefined){
      h=o.getBoundingClientRect().height
    }else if(o.offsetHeight>0){
      h=o.offsetHeight
    }else{
      h=(o.getBoundingClientRect().height||10)
    }
    if(c.tagName=="CANVAS"){
      c.width=w
      c.height=h
      // c.attributes.tabIndex=100
      // c.focus()
    }else{
      c.style.width=w+"px"
      c.style.height=h+"px"
    }
    if(o.tagName=="CANVAS"&&o.bzTxtElement){
      c.style.top=parseFloat(c.style.top)+o.bzTxtElement.y+"px";
      c.style.left=parseFloat(c.style.left)+o.bzTxtElement.x+"px";
      c.width=o.bzTxtElement.w
      c.height=o.bzTxtElement.h
      c.bzTxtElement=o.bzTxtElement
      o.bzTxtElement=0
      // c.style.marginTop="7px"
    }
    $(c).show();

    clearTimeout(window.bzScrollSetTime)
    window.bzScrollSetTime=setTimeout(function(){
      
      $(window).unbind("scroll")
      $(window).unbind("resize")
      $(window).scroll(_bzDomPicker._scrollSync)
      $(window).resize(_bzDomPicker._scrollSync)
      if(BZ.TW&&!BZ.TW.closed){
        $(BZ.TW).unbind("scroll")
        $(BZ.TW).unbind("resize")
        $(BZ.TW).scroll(_bzDomPicker._scrollSync)
        $(BZ.TW).resize(_bzDomPicker._scrollSync)
      }
      $(c.ownerDocument).find("*").unbind("scroll")
      $(c.ownerDocument).find("*").scroll(_bzDomPicker._scrollSync)
    },1000);
  },
  _flashMutipleTmpCover:function(_path){
    if(_path.constructor==String){
      _path=["BZ.TW.document",_path]
    }
    if(bzTwComm._isIDE()){
      return _extensionComm._exeFun("_flashMutipleTmpCover","_bzDomPicker",_path,_path[0]);
    }
    _bzDomPicker._removeTmpCover();
    let os=_Util._findDoms(_path)
    _bzDomPicker._showTmpCover(os,0,0,1)
  },
  //os: elements, t, flash times, _fun: update cover and element, 
  _showTmpCover:function(os,t,_fun,_keep){
    var _elementPath=0;
    if(!bzTwComm._isExtension()){
      _elementPath=os[0]
      if(!_elementPath){
        return
      }
      os.forEach((o,i)=>{
        if(o.constructor==Array){
          os[i]=_aiPageHandler._updateElementPathByDemoValue(o,0,1)
        }else{
          os[i].path=_aiPageHandler._updateElementPathByDemoValue(o.path,0,1)
          os[i].panels.forEach((p,n)=>{
            os[i].panels[n]=_aiPageHandler._updateElementPathByDemoValue(p,0,1)
          })
        }
      })
      if(_elementPath.constructor==Array){
        _elementPath=_elementPath[0]
      }else{
        _elementPath=_elementPath.path[0]
      }
    }
    if(bzTwComm._isIDE()){
      return _extensionComm._exeFun("_showTmpCover","_bzDomPicker",os,_elementPath);
    }
    if(!_keep){
      _bzDomPicker._removeTmpCover()
    }
    var cs=[];
    for(var i=0;i<os.length;i++){
      let o=os[i];
      if(o.constructor==Array){
        o=$util.findDom(o)
      }else if(o.constructor==Object&&o.path){
        o=_Util._findDomWithPanels(o.path,o.panels)
      }
      if(_Util._isHidden(o)){
        continue;
      }
      let c=this._createTmpCover(o.ownerDocument, 0, 1);
      $(c).click(function(e){
        if(e.target==this&&!this.children.length){
          _bzDomPicker._removeTmpCover()
        }else if(e.target.innerText){
          _bzDomPicker._copyElementPath(e.target.parentElement._orgDom)
        }
      })
      $(c).mouseover(function(e){
        if(_bzDomPicker._curRequire){
          _bzDomPicker._setMousedown(this)
        }
      })
      this._setTmpCoverPosByDom(o,c);
      if(!t&&_fun){
        _fun(o,c)
      }
      cs.push(c);
    }
    if(t&&!_keep){
      setTimeout(function(){
        _bzDomPicker._removeTmpCover()
        setTimeout(function(){
          _bzDomPicker._showTmpCover(os,t-1,_fun);
        },100)
      },500);
    }
    return cs;
  },
  _copyElementPath:function(o){
    _Util._copyData({
      level:"element",
      items:_cssHandler._findPath(o),
      time:Date.now()
    })
  },
  //d:{_path, offset}
  _showOffset:function(d){
    if(!bzTwComm._isExtension()){
      d={
        _element:_Util._clone(d._element),
        _offset:d._offset
      }
      _aiPageHandler._updateElementPathByDemoValue(d._element)
    }
    if(bzTwComm._isIDE()){
      return _extensionComm._exeFun("_showOffset","_bzDomPicker",d);
    }
    let c=_bzDomPicker._flashTmpCover(d._element,1)
    if(!c){
      return
    }
    let s=_bzDomPicker._createTmpCover(c.ownerDocument);
    let r=c.getBoundingClientRect()
    let p=_bzDomPicker._getOffsetPoint({
      x:r.left,
      y:r.top,
      h:r.height,
      w:r.width
    },d._offset)
    let cp={
      left:p.x-5+"px",
      top:p.y-5+"px",
      width:"11px",
      height:"11px",
      borderRadius:"5px",
      display:"block"
    }
    c.ownerDocument.body.appendChild(s);
    
    $(s).css(cp)
    $(s).click(function(){this.remove()})
  },
  //o: offset
  _getOffsetPoint:function(r,o){
    console.log("set offset: ",r,o)
    
    switch(o.origin){
      case "mc":
        r= {x:r.x+r.w/2,y:r.y+r.h/2}
        break
      case "lt":
        r={x:r.x,y:r.y}
        break
      case "t":
        r={x:r.x+r.w/2,y:r.y}
        break
      case "rt":
        r={x:r.x+r.w,y:r.y}
        break
      case "r":
        r={x:r.x+r.w,y:r.y+r.h/2}
        break
      case "rb":
        r={x:r.x+r.w,y:r.y+r.h}
        break
      case "b":
        r={x:r.x+r.w/2,y:r.y+r.h}
        break
      case "lb":
        r={x:r.x,y:r.y+r.h}
        break
      case "l":
        r={x:r.x,y:r.y+r.h/2}
    }
    return {
      x:parseInt(r.x)+parseInt(o.X),
      y:parseInt(r.y)+parseInt(o.Y)
    }
  },
  _flashTmpCover:function(_path,_chkCode){
    if(!_path){
      return
    }
    if(!bzTwComm._isExtension()&&!BZ._isPlaying()&&_IDE._data._curAction){
      _extensionComm._setCmd("_bzDomPicker._removeTmpCover()")
      _ideActionManagement._applyTmpValue()
    }
    var _elementPath=0;
    if(_path.constructor==Object){
      if(_path.path){
        _elementPath=_path.path[0]
        if(_chkCode){
          _path.path=_aiPageHandler._updateElementPathByDemoValue(_path.path,0,1)
          _path.panels.forEach((p,i)=>{
            if(p){
              _path.panels[i]=_aiPageHandler._updateElementPathByDemoValue(p,0,1)
            }
          })
        }
      }
    }else{
      if(_path.constructor==String){
        _path=["BZ.TW.document",_path]
      }
      _elementPath=_path[0]
      if(_chkCode){
        _path=_aiPageHandler._updateElementPathByDemoValue(_path,0,1)
      }
    }
    if(_ideDataBind._data._inSelectFillField){
      return
    }
    if(bzTwComm._isIDE()){
      if(_elementPath){
        return _extensionComm._setSelectElement(_path,_elementPath);
      }
      if(_path.constructor==Array){
        return _extensionComm._setSelectElement(_path);
      }
      return _extensionComm._exeFun("_flashTmpCover","_bzDomPicker",_path);
    }
    if($(".bz-help-question").length){
      return;
    }
    if(!_path || !BZ._documents){
      return;
    }
    _bzDomPicker._removeTmpCover();
    var o;
    if(_path.constructor==Object&&_path.path){
      o=_Util._findDomWithPanels(_path.path,_path.panels)
    }else if(_path.constructor!=Array&&_path.element){
      if(_path.mutipleElement){
        return _bzDomPicker._flashMutipleTmpCover(_path.element.filter(x=>!$.isNumeric(x)))
      }else{
        o=_domActionTask._findElement(_path)
      }
    }else if(_path.constructor==Array){
      o=$util.findDom(_path);
    }else{
      o=_path;
    }
    _ideActionManagement._showMissingElement(!o)
    if(o){
      var c=this._createTmpCover(o.ownerDocument);
      $(c).click(function(){
        $(this).remove()
      })
      this._setTmpCoverPosByDom(o,c);

      // _Util._focusElement(c)
      let a=_IDE._data._curAction
      if(a&&a.event){
        var ctx = c.getContext("2d");
        if(a.event.action=="dragdrop"&&a.event.element&&o.tagName!="CANVAS"){
          let o1=o.getBoundingClientRect()
          let o2=$util.findDom(a.event.element)
          if(o2){
            this._setTmpCoverPosByDom(BZ.TW.document.body,c);
            o2=o2.getBoundingClientRect()
            _Util._drawArrow(ctx,(o1.left+o1.right)/2,(o1.top+o1.bottom)/2,(o2.left+o2.right)/2,(o2.top+o2.bottom)/2)
            return
          }
        }
        if(a.event.action=="drag"){
          a=a.event
          setTimeout(()=>{
            ctx.beginPath();
            let x1=a.x,y1=a.y,
                x2=a.moveToX,y2=a.moveToY;
            
            ctx.arc(x1, y1,5, 0, 2 * Math.PI);
            ctx.fillStyle = "blue";

            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(x2, y2,3,0, 2 * Math.PI);
            ctx.fillStyle = "red";
            ctx.fill();
            ctx.strokeStyle="red"
            _Util._drawArrow(ctx,a.x,a.y,a.moveToX,a.moveToY)
          },10)
        }
      }
      setTimeout(function(){
        if(!_bzDomPicker._domPickerWindow || _bzDomPicker._domPickerWindow.closed){
          if(_bzDomPicker._curRequire){
            $(c).remove();
          }
        }
      },1000);
    }
    return c
  },
  _setErrCoverPosByDom:function(o){
    var c = this._createTmpCover(o.ownerDocument,true);
    this._setTmpCoverPosByDom(o,c);
    return c;
  },
  _pickPath:function(e){
    this._removeTmpCover();
    var _path=this._getFinalPaths();
    _bzDomPicker._curDom=$util.findDom(_path);
    _bzDomPicker._curRequire._back(_path,this._data._pos,_bzDomPicker._curDom);
    _bzDomPicker._endRequire();
    if(this._domPickerWindow){
      this._domPickerWindow.opener.focus();
      this._domPickerWindow.close();
    }else if(e){
      e.target.ownerDocument.defaultView.close()
    }
  },
  _getFinalPaths:function(){    
    var _paths=[];
    for(var i=0;this._data._items&&i<this._data._items.length;i++){
      var v=this._data._items[i];
      if (v._selected&&v._value) {
        _paths.push(v._value);
      }
    }
    if(_paths.length){
      _paths.push(this._data._lastIdx);
    }
    _bzDomPicker._data._fullPath=_paths
    return _paths;
  },
  _testPath:function(_fun){
    try{
      this._removeTmpCover();
      let _path=this._getFinalPaths()

      _bzDomPicker._pdb._showResetInfo=0
      var t=Date.now()
      var o = $util.findDom(_path);
      _bzDomPicker._pdb._showSlowInfo=Date.now()-t+"ms"
    }catch(e){
    }
  },
  _cancel:function(e){
    if(!bzTwComm._isExtension()){
      return _extensionComm._setCmd("_bzDomPicker._cancel()")
    }
    _bzDomPicker._endRequire()
    if(e){
      e.target.ownerDocument.defaultView.close()
    }else{
      _bzDomPicker._domPickerWindow&&_bzDomPicker._domPickerWindow.close();
    }
  },
  _reSelect:function(){
    _bzDomPicker._removeTmpCover();
    var a=this._curRequire,v=this._data._filter;
    _bzDomPicker._preType=a._type
    if(v){
      a._type=`${v},:endContains(${v}),:attr(value=${v})`;
    }else{
      a._type=v
    }
    a._filter=v
    this._start(a);
  },
  _setFocusItem:function(o){
    _bzDomPicker._data._focusItem=o
    _bzDomPicker._flashTmpCover(o._dom)

    let vs=[],s=[],ss=[]
    o._options=vs
    o._idxOptions=[]
    
    if(o._value){
      let v=o._value.replace(/^[a-z]+/i,"")
      let g="",cs="",lk
      for(let i=0;i<v.length;i++){
        let c=v[i]
        if(g.includes(c)){
          if(!v[i+1]||".#".includes(lk)||".#[:".includes(v[i+1])){
            if(")]".includes(g)){
              cs+=c
            }else{
              i--
            }
            s.push(cs)
            g=cs=""
            continue
          }
        }
        if(c==":"){
          if(!g){
            g=")"
            lk=c
          }
        }else if(c=="."){
          if(!g){
            g="#:[."
            lk=c
          }
        }else if(c=="#"){
          if(!g){
            g=".:["
            lk=c
          }
        }else if(c=="["){
          if(!g){
            g="]"
            lk=c
          }
        }
        cs+=c
      }
      if(cs){
        s.push(cs)
      }
    }
    
    let os=$(document.body)
    _bzDomPicker._data._items.find((x,i)=>{
      if(x._selected&&i){
        if(x==o){
          x=x._value.replace(/\:(eq\([0-9]+\)|last|first)$/,"")
          os=os.find(x)
          return 1
        }else{
          os=os.find(x._value)
        }
      }
      if(x==o){
        return 1
      }
    })
    os=os.toArray()
    let xos=[]
    while(os.length){
      let oo=os.shift()
      _Util._spliceAll(os,x=>$(x).find(oo).length)
      xos.push(oo)
    }
    o._idxOptions.push(":eq("+xos.indexOf(o._dom)+")")
    if(xos[0]==o._dom){
      o._idxOptions.push(":first")
    }
    if(xos[xos.length-1]==o._dom){
      o._idxOptions.push(":last")
    }

    s.find((x,j)=>{
      if(x[0]==":"){
        if(!x.match(/^\:(eq|first|last|attr|Attr)/)){
          let i=x.indexOf("(")
          if(i>0){
            o._textType=x.substring(0,i)
            o._textValue=x.substring(i+1,x.length-1)
            s.splice(j,1)
            return 1
          }
        }
      }
    })
    s.find((x,i)=>{
      if(o._idxOptions.includes(x)){
        o._index=x
        s.splice(i,1)
        return 1
      }
    })

    o=o._dom
    
    _bzDomPicker._getElementOptions(o,vs)

    s.forEach(x=>{
      if(!vs.find(y=>{
        if(y._value==x){
          y._chk="on"
          return 1
        }
      })){
        ss.push(x)
      }
    })
  },
  _getElementOptions:function(o,vs){
    vs=vs||[]
    if(o.id){
      vs.push({_value:"#"+o.id})
    }
    
    if(o.classList.length){
      for(let k of o.classList){
        vs.push({_value:"."+k})
      }
    }
    
    for(let i=0;i<o.attributes.length;i++){
      let a=o.attributes[i]
      if(!a.name.match(/^(id|class|style|on.+)$/)&&a.value){
        vs.push({_value:`:attr(${a.name}=${a.value})`})
      }
    }
    return vs   
  },
  _setValue:function(o){
    o=o||_bzDomPicker._data._focusItem
    let v=o._dom.tagName

    if(o._textType){
      v+=o._textType+"("+o._textValue+")"
    }
    o._options.forEach(x=>{
      if(x._chk){
        v+=x._value
      }
    })
    o._idxOptions.find(x=>{
      if(x._chk){
        v+=x._value
        return 1
      }
    })
    v+=_bzDomPicker._data._focusItem._index||""

    o._value=v
    _bzDomPicker._resetLastIdx()
  },
  _getItemView:function(_button,_dataRepeat){
    return {
      _tag:"pre",
      _attr:{
        style:"white-space: nowrap;word-break: break-all;margin:0;line-height: 20px;",
        class:function(d){
          if(d._item._selected){
            return "bz-ui-switch active"
          }
        }
      },
      _dataRepeat:_dataRepeat,
      _items:[
        //switcher
        {
          _if:function(d){
            return _button&&_bzDomPicker._hasChild(d._item)
          },
          _tag:"button",
          _attr:{
            class:"'btn bz-mini-switch bz-dropdown '+(_data._item._showChildren?'':'rotate-90')",
          },
          _jqext:{
            click:function(){
              this._data._item._showChildren=!this._data._item._showChildren
            }
          }
        },
        //node text
        {
          _tag:"span",
          _attr:{
            "class":function(d){
              let c="item";
              if(_bzDomPicker._data._focusItem==d._item){
                c+=" bz-focus-item"
              }else if(d._item._dom.tagName){
                c+=" disabled"
              }

              return c
            },
            style:function(d){
              if(d._item._dom.constructor!=String){
                return "cursor:pointer !important"
              }else{
                return "cursor:default !important"
              }
            }
          },
          _text:"_bzDomPicker._getDomDesc(_data._item)",
          _jqext:{
            click:function(){
              if(this._data._item._dom.constructor!=String){
                _bzDomPicker._setFocusItem(this._data._item)
              }
            },
            dblclick:function(){
              if(this._data._item._dom.constructor!=String){
                _bzDomPicker._selectItem(this._data._item)
              }
            }
          }
        },
        {
          _if:function(d){
            return d._item._subHideItems
          },
          _tag:"button",
          _attr:{
            style:function(d){
              let c="border: var(--bz-border);width: 30px;white-space: nowrap;border-radius: 5px;padding: 0;height: 10px;color: #999;cursor: pointer;display: block;margin: 2px 18px;"
              c+="margin-left:"+(d._idx+1)*8+"px"
              return c
            },
            title:"_bzMessage._picker._showSubItems"
          },
          _items:[
            {
              _tag:"span",
              _attr:{
                style:"position: relative;top: -13px;font-size: 20px;"
              },
              _text:"..."
            }
          ],
          _jqext:{
            click:function(){
              _bzDomPicker._showHiddenSubItems(this._data)
            }
          }
        }
      ]
    }
  },
  _selectItem:function(o){
    let os=_bzDomPicker._data._items,
        oo=os[os.length-1]
    _bzDomPicker._setFocusItem(o)
    o._selected=true
    if(!os.includes(o)){
      if(oo._siblings&&oo._siblings.includes(o)){
        os.pop()
      }
      os.push(o)
      os.forEach(x=>{
        x._showChildren=0
        x._showSibling=0
      })
    }

    setTimeout(()=>{
      _bzDomPicker._setValue()
    },100)

  },
  _generatePath:function(){
    let p=_bzDomPicker._getFinalPaths(),_best,_suggestion;
    if($.isNumeric(p[p.length-1])||p[p.length-1]=="ERR"){
      p.pop()
    }
    let o=_bzDomPicker._data._focusItem;
    let a=_IDE._data._curAction
    if(a){
      if(a.type==1){
        if(a.event.type=="mouse"){
          _suggestion=":text"
        }else{
          _suggestion=":input"
        }
      }else if(a.type==0||a.type==2){
        if(_Util._isPanel(o._dom)){
          _suggestion=":panel"
        }else{
          _suggestion=":data"
        }
      }
    }
    let _text=o._textValue||_descAnalysis._retrieveTextForElementPathItem(_cssHandler._findPath(o._dom))
    let ms=_Util._clone(_bzDomPicker._textMethods)

    if(_text){
      _findBest(ms,function(){
        if(_best){
          o._textValue=_text;
          o._value=o._dom.tagName+_best.x+"("+_text+")";
          _bzDomPicker._data._focusItem._textType=_best.x
          _bzDomPicker._data._lastIdx=_best._idx
          _bzDomPicker._pdb._showSlowInfo=_best._time+"ms"
          _bzDomPicker._getFinalPaths()
        }
        _bzDomPicker._data._tmpInfo=_bzMessage._common._done
      })
    }


    function _findBest(ms,_fun){
      if(ms.length){
        setTimeout(()=>{
          let x=ms.shift()
          try{
            if(!x||(x==":panel"&&_suggestion!=":panel")){
              return _findBest(ms,_fun)
            }
            _bzDomPicker._data._tmpInfo=x
            p.pop();
            p.push(o._dom.tagName+x+"("+_text+")")
            let _time=Date.now(),
                os=_Util._findDoms(p)||[]
                
            _time=Date.now()-_time
            if(os.toArray){
              os=os.toArray()
            }
            let _idx=os.indexOf(o._dom)
            if(_idx>-1){
              if(!_best){
                _best={
                  _size:os.length,
                  x:x,
                  _idx:_idx,
                  _time:_time
                }
              }else if(_best._idx>_idx||(_best._idx==_idx&&_best._size>os.length)){
                _best._size=os.length
                _best.x=x
                _best._idx=_idx
                _best._time=_time
              }else if(_best._idx==_idx&&_best._time>_time){
                if(_best.x==_suggestion&&_best._time-_time<100){
                  return _findBest(ms,_fun)
                }
                _best._size=os.length
                _best.x=x
                _best._time=_time
              }else if(x==_suggestion){
                if(_best._idx==_idx&&_time-_best._time<100){
                  _best.x=x
                  _best._time=_time
                  _best._size=os.length
                }
              }
            }
          }catch(ex){
            
          }
          return _findBest(ms,_fun)
        },100)
      }else{
        _fun()
      }
    }
  }
};


var _pickerTemplate={
  _if:"_bzDomPicker._pdb._refreshShowList",
  _tag:"div",
  _attr:{
    "class":"dom-picker"
  },
  _items:[
    {
      _tag:"div",
      _attr:{
        class:"disable-select",
        style:"display:flex;position:absolute;left:0px;right:0px;top:0px;bottom:90px;"
      },
      _items:[
        //list
        {
          _tag:"div",
          _attr:{
            style:"flex:1;margin-right: 5px;width: 50%;background: var(--editor-background-color);height: 100%;"
          },
          _items:[
            {
              _tag:"ul",
              _attr:{
                style:"font-size:13px;background-color: var(--editor-background-color);margin: 5px;padding:7px;list-style-type:none;height: calc(100% - 25px);overflow: auto;"
              },
              _after:function(o){
                setTimeout(()=>{
                  o.scrollTop=o.scrollHeight
                },100)
              },
              _items:[
                {
                  _tag:"li",
                  _attr:{
                    class:"row",
                    style:function(d){
                      let i=d._idx;
                      if(_bzDomPicker._hasChild(d._item)){
                        i-=1
                      }
                      let c= "text-indent:"+(i*8)+"px;"
                      
                      return c
                    }
                  },
                  _items:[
                    _bzDomPicker._getItemView(1),
                    {
                      _if:"_data._item._showChildren",
                      _tag:"div",
                      _attr:{
                        style:"margin-left:20px;margin-top: 5px;color:#999;"
                      },
                      _items:[
                        _bzDomPicker._getItemView(0,function(d){
                          if(!d._item._children||!d._item._children.length){
                            let os=_CtrlDriver._buildProxy([])
                            d._item._children=os
                            for(let o of d._item._dom.children){
                              os.push({
                                _dom:o,
                                _value:"",
                                _showChildren:false,
                                _selected:false,
                                _children:[]
                              })
                            }
                            if(os.length==1){
                              let oo=_bzDomPicker._data._items[_bzDomPicker._data._items.length-1]
                              oo._showSibling=0
                              oo._showChildren=0
                              _bzDomPicker._data._items.push(os[0])
                              return
                            }
                          }
                          return d._item._children
                        })
                      ]
                    }
                  ],
                  _dataRepeat:"_bzDomPicker._data._items"
                },
                {
                  _if:"_bzDomPicker._hasSibling()",
                  _tag:"div",
                  _attr:{
                    style:"'text-indent:'+(_bzDomPicker._data._items.length*8-8)+'px;color:#999;line-height: 15px;'"
                  },
                  _items:[
                    {
                      _if:"!_bzDomPicker._data._items[_bzDomPicker._data._items.length-1]._showSibling",
                      _tag:"a",
                      _attr:{
                        class:"bz-clickable bz-left-space-10"
                      },
                      _text:"_bzMessage._picker._showSibling",
                      _jqext:{
                        click:function(){
                          _bzDomPicker._data._items[_bzDomPicker._data._items.length-1]._showSibling=1
                        }
                      }
                    },
                    {
                      _if:"_bzDomPicker._data._items[_bzDomPicker._data._items.length-1]._showSibling",
                      _tag:"div",
                      _items:[
                        _bzDomPicker._getItemView(0,function(){
                          let d=_bzDomPicker._data._items[_bzDomPicker._data._items.length-1];
                          if(!d._siblings){
                            let os=_CtrlDriver._buildProxy([])
                            d._siblings=os
                            for(let o of d._dom.parentElement.children){
                              if(o!=d._dom){
                                os.push({
                                  _dom:o,
                                  _value:"",
                                  _showChildren:false,
                                  _selected:false,
                                  _children:[]
                                })
                              }
                            }
                          }
                          return d._siblings
                        })
                      ]
                    }
                  ]
                },
                {
                  _tag:"div",
                  _attr:{
                    style:"height:20px;"
                  }
                },
                //missing element info
                {
                  _if:"!_bzDomPicker._data._items||!_bzDomPicker._data._items.length",
                  _tag:"div",
                  _items:[
                    {
                      _html:function(){
                        return "<pre>"+_Util._formatMessage(_bzMessage._action._notFoundElement,JSON.stringify(BZ._data._uiSwitch._tmpPath))+"\n\n</pre>"
                      }
                    },
                    {
                      _tag:"div",
                      _items:[
                        {
                          _tag:"span",
                          _text:"_bzMessage._method._click"
                        },
                        {
                          _tag:"button",
                          _attr:{"class":"btn btn-none btn-icon bz-dompicker bz-small-btn"},
                          _jqext:{
                            click:function(){
                              _bzDomPicker._data._filter='';
                              _bzDomPicker._reSelect()
                            }
                          }
                        },
                        {
                          _tag:"span",
                          _text:"_bzMessage._action._reselect"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        //Details panel
        {
          _tag:"div",
          _attr:{
            style:"flex:1;font-size:13px;background-color: var(--editor-background-color);overflow:auto;list-style-type:none;width: 50%;"
          },
          _items:[
            {
              _if:"_bzDomPicker._data._focusItem",
              _tag:"div",
              _attr:{
                style:"padding:1rem;height: calc(100% - 2rem);display: flex;flex-direction: column;"
              },
              _update:function(){
                _bzDomPicker._setValue()
              },
              _items:[
                {
                  _tag:"div",
                  _items:[
                    //checkbox
                    {
                      _tag:"label",
                      _attr:{
                        style:"display: flex;margin-left:11px;width: calc(100% - 30px);"
                      },
                      _items:[
                        {
                          _tag:"input",
                          _attr:{
                            type:"checkbox",
                            value:true,
                            class:"!_data._idx?'pull-left':''"
                          },
                          _jqext:{
                            change:function(){
                              var _this=this;
                              setTimeout(function(){
                                let o=_bzDomPicker._data._focusItem
                                    
                                if(o._selected){
                                  _bzDomPicker._selectItem(o)
                                }else{
                                  o._value="";
                                  _bzDomPicker._resetLastIdx();
                                }
                              },1);
                            }
                          },
                          _dataModel:"_bzDomPicker._data._focusItem._selected"
                        },
                        {
                          _tag:"span",
                          _attr:{
                            class:"bz-nowrap",
                            style:"flex:1;"
                          },
                          _items:[
                            {
                              _text:"_bzMessage._action._assignToPath+': '"
                            },
                            {
                              _tag:"b",
                              _text:"_bzDomPicker._getDomDesc()"
                            }
                          ]
                        }
                      ]
                    },
                    {
                      _if:"_bzDomPicker._data._items.includes(_bzDomPicker._data._focusItem)",
                      _tag:"button",
                      _attr:{
                        class:"btn btn-none btn-icon bz-cross bz-small-btn pull-right",
                        style:"margin-top:-15px;"
                      },
                      _jqext:{
                        click:function(){
                          _bzDomPicker._data._items.splice(_bzDomPicker._data._items.indexOf(_bzDomPicker._data._focusItem))
                        }
                      }
                    }
                  ]
                },
                //attributes panel
                {
                  _tag:"fieldset",
                  _attr:{
                    style:"flex:1;overflow:auto;margin: 10px 0;"
                  },
                  _items:[
                    {
                      _tag:"legend",
                      _text:"_bzMessage._action._attrList"
                    },
                    {
                      _tag:"div",
                      _attr:{
                        class:"col-xs-12"
                      },
                      _items:[
                        {
                          _tag:"label",
                          _attr:{
                            style:"display:block;",
                            class:"bz-nowrap"
                          },
                          _items:[
                            {
                              _tag:"input",
                              _attr:{
                                disabled:"!_bzDomPicker._data._focusItem._selected",
                                type:"checkbox"
                              },
                              _dataModel:function(d){
                                return "_bzDomPicker._data._focusItem._options["+d._idx+"]._chk"
                              },
                            },
                            {
                              _text:"_data._item._value"
                            }
                          ]
                        }
                      ],
                      _dataRepeat:function(){
                        let o=_bzDomPicker._data._focusItem
                        return o?o._options:[]
                      }
                    }
                  ]
                },
                //text method
                {
                  _if:"_bzDomPicker._data._focusItem._selected",
                  _tag:"div",
                  _attr:{
                    class:"input-group"
                  },
                  _items:[
                    {
                      _tag:"label",
                      _attr:{
                        class:"input-group-addon"
                      },
                      _text:"_bzMessage._common._method"
                    },
                    {
                      _tag:"select",
                      _attr:{
                        class:"form-control"
                      },
                      _dataModel:"_bzDomPicker._data._focusItem._textType",
                      _items:[
                        {
                          _tag:"option",
                          _attr:{
                            value:"_data._item"
                          },
                          _text:"_bzMessage._picker._textOptions[_data._item]",
                          _dataRepeat:function(){
                            let vs=_bzDomPicker._textMethods
                            let o=_bzDomPicker._data._focusItem._dom
                            for(let n of o.childNodes){
                              if(n.nodeType==3&&n.textContent){
                                return vs
                              }
                            }
                            
                            if(o.innerText.trim()){
                              return vs
                            }else{
                              return _bzDomPicker._methods
                            }

                          }
                        }
                      ]
                    }
                  ]
                },
                //text
                {
                  _if:"_bzDomPicker._data._focusItem._selected",
                  _tag:"div",
                  _attr:{
                    class:"input-group"
                  },
                  _items:[
                    {
                      _tag:"label",
                      _attr:{
                        class:"input-group-addon"
                      },
                      _text:"_bzMessage._picker._text"
                    },
                    {
                      _tag:"input",
                      _attr:{
                        class:"form-control",
                        style:"width:100% !important;"
                      },
                      _dataModel:"_bzDomPicker._data._focusItem._textValue"
                    }
                  ]
                },
                //index
                {
                  _if:"_bzDomPicker._data._focusItem._selected",
                  _tag:"div",
                  _attr:{
                    class:"input-group"
                  },
                  _items:[
                    {
                      _tag:"label",
                      _attr:{
                        class:"input-group-addon",
                        style:"min-width:45px",
                      },
                      _text:"_bzMessage._picker._index"
                    },
                    {
                      _tag:"select",
                      _attr:{
                        class:"form-control"
                      },
                      _dataModel:"_bzDomPicker._data._focusItem._index",
                      _items:[
                        {
                          _tag:"option"
                        },
                        {
                          _tag:"option",
                          _attr:{
                            value:"_data._item"
                          },
                          _text:"_data._item",
                          _dataRepeat:"_bzDomPicker._data._focusItem._idxOptions"
                        }
                      ]
                    }
                  ]
                },
                {
                  _if:"_bzDomPicker._data._focusItem._selected",
                  _tag:"div",
                  _items:[
                    {
                      _if:function(){
                        let o=_bzDomPicker._data._focusItem
                        if(o._selected){
                          let os=_bzDomPicker._data._items.filter(x=>x._selected);
                          return os[os.length-1]==o
                        }
                      },
                      _tag:"button",
                      _attr:{
                        class:"btn btn-primary",
                        disabled:"!_bzDomPicker._data._focusItem._selected",
                        style:"margin-top:10px;"
                      },
                      _text:"_bzMessage._picker._generatePath",
                      _jqext:{
                        click:function(){
                          _bzDomPicker._generatePath()
                        }
                      }
                    },
                    {
                      _if:function(){
                        if(_bzDomPicker._data._tmpInfo){
                          setTimeout(()=>{
                            _bzDomPicker._data._tmpInfo=''
                          },2000)
                          return 1
                        }
                      },
                      _tag:"span",
                      _attr:{
                        style:"margin: 14px 20px;position: absolute;font-weight: bold;"
                      },
                      _text:"_bzMessage._cooperation._statusType.testing+': '+ _bzDomPicker._data._tmpInfo"
                    }
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    {
      _tag:"div",
      _attr:{
        style:"height:80px;position:absolute;left:0px;right:0px;bottom:0;display:flex;"
      },
      _items:[
        {
          _tag:"pre",
          _attr:{
            style:"font-size: 11px;flex:1;line-height: 20px;margin: 0 5px 0 0;overflow:auto;height:100%;"
          },
          _text:function(){
            return (_bzDomPicker._data._fullPath||[]).join('\n')
          }
        },
        {
          _tag:"div",
          _attr:{
            style:"flex:1;margin:0;display:flex;flex-direction:column;"
          },
          _items:[
            {
              _tag:"div",
              _attr:{
                style:"padding: 5px 10px;margin-bottom: 12px;"
              },
              _items:[
                {
                  _tag:"div",
                  _items:[
                    //unique
                    {
                      _if:function(){
                        return !_bzDomPicker._data._tmpInfo&&(!_bzDomPicker._data._lastIdx||_bzDomPicker._data._lastIdx=="0")
                      },
                      _tag:"span",
                      _attr:{
                        class:"pull-left bz-right-space-10"
                      },
                      _items:[
                        {
                          _tag:"div",
                          _attr:{
                            class:"bz-success pull-left",
                            style:"margin-top: 5px;"
                          }
                        },
                        {
                          _tag:"div",
                          _attr:{
                            class:"bz-dom-picker-note"
                          },
                          _text:"_bzMessage._action._unique"
                          
                        }
                      ]
                    },
                    //error
                    {
                      _if:function(){
                        return !_bzDomPicker._data._tmpInfo&&_bzDomPicker._data._lastIdx&&_bzDomPicker._data._lastIdx!="0"
                      },
                      _tag:"span",
                      _attr:{
                        class:"pull-left bz-right-space-10"
                      },
                      _items:[
                        {
                          _tag:"div",
                          _attr:{
                            class:"bz-dom-picker-note",
                            style:function(){
                              if(_bzDomPicker._data._lastIdx=="ERR"){
                                return "background-color:var(--bz-red);color:#FFF;padding:5px;border-radius:var(--bz-border-radius)"
                              }else{
                                return "background-color:var(--bz-yellow);color:#000;padding:5px;border-radius:var(--bz-border-radius)"
                              }
                            }
                          },
                          _text:function(){
                            if(_bzDomPicker._data._lastIdx=="ERR"){
                              setTimeout(()=>{
                                let v=_bzDomPicker._getFinalPaths()
                                v.pop()
                                v=_Util._findDoms(v)
                                v.forEach(x=>{
                                  _bzDomPicker._setErrCoverPosByDom(x)
                                })
                              })
                              return _bzMessage._picker._testFailed
                            }else{
                              return _bzMessage._action._noUnique+' (idx: '+_bzDomPicker._data._lastIdx+')'
                            }
                          }
                        }
                      ]
                    },
                    //speed
                    {
                      _if:"!_bzDomPicker._data._tmpInfo",
                      _tag:"span",
                      _attr:{
                        class:"pull-left bz-right-space-10 bz-dom-picker-note",
                        style:function(d){
                          let c=parseInt(_bzDomPicker._pdb._showSlowInfo)
                          if(c&&c<150){
                            c="background-color:transparent;color:var(--text-color);"
                          }else{
                            c="background-color:var(--bz-yellow);color:#000;padding:5px;border-radius:var(--bz-border-radius);"
                          }
                          return c
                        }
                      },
                      _items:[
                        {
                          _tag:"span",
                          _text:"_bzMessage._action._speed+': '"
                        },
                        {
                          _if:"_bzDomPicker._pdb._showSlowInfo",
                          _tag:"span",
                          _text:"_bzDomPicker._pdb._showSlowInfo"
                        },
                        {
                          _if:"!_bzDomPicker._pdb._showSlowInfo",
                          _tag:"button",
                          _attr:{
                            class:"btn bz-small-btn bz-loading btn-none btn-icon",
                          }
                        }
                      ]
                    }
                  ]
                },
                {
                  _tag:"div",
                  _attr:{
                    class:"pull-right",
                  },
                  _items:[
                    {
                      _tag:"a",
                      _text:"_bzMessage._picker._chkPath",
                      _attr:{
                        class:"bz-clickable pull-right",
                        style:"position: relative;top: 5px;font-size: 11px;"
                      },
                      _jqext:{
                        click:function(){
                          _bzDomPicker._resetLastIdx(1)
                        }
                      }
                    },
                    {
                      _tag:"label",
                      _attr:{
                        class:"pull-right",
                        style:"margin:5px 5px 5px 0px; font-size: 12px;"
                      },
                      _items:[
                        {
                          _tag:"input",
                          _attr:{type:"checkbox"},
                          _dataModel:"_bzDomPicker._data._autoRefresh"
                        },
                        {_text:"_bzMessage._picker._autoRefresh"}
                      ]
                    },
                  ]
                }
              ]
            },
            //buttons-panel
            {
              _tag:"div",
              _attr:{
                style:"flex:1;padding: 0 10px;"
              },
              _items:[
                //dom picker
                {
                  _tag:"button",
                  _attr:{
                    class:"btn btn-secondary btn-icon-text bz-dompicker"
                  },
                  _text:"_bzMessage._action._reselect",
                  _jqext:{
                    click:function(){
                      _bzDomPicker._data._filter='';
                      _bzDomPicker._reSelect()
                    }
                  }
                },
                //save
                {
                  _tag:"button",
                  _attr:{
                    "class":"btn btn-primary pull-right",
                    disabled:"_bzDomPicker._data._lastIdx=='ERR'"
                  },
                  _text:"_bzMessage._method._save",
                  _jqext:{
                    click:function(e){
                      _bzDomPicker._pickPath(e)
                    }
                  }
                },
                //close
                {
                  _tag:"button",
                  _attr:{
                    "style":"margin-right:30px;",
                    "class":"btn btn-secondary pull-right bz-right-space-10"
                  },
                  _text:"_bzMessage._method._close",
                  _jqext:{
                    click:function(e){
                      _bzDomPicker._cancel(e)
                    }
                  }
                }
              ]
            }

          ]
        }
      ]
    },
  ]
};var _tipHandler={
  _doAfterComment:function(d){
    if(bzTwComm._isExtension()){
      return bzTwComm._postExt({_fun:"_doAfterComment",_scope:"_tipHandler",_args:[d]});
    }
    
    if(d>0){
      _ideTask._data._lastResult._type=d;
      BZ._setStatus("play")
      _ideTask._doRefCall(_ideTask._data._lastResult,0,1);
    }else{
      _ideTestManagement._play();
    }
  },
  _removeAll:function(){
    if(BZ._documents){
      BZ._documents.find(".bz-tip-iframe").remove();
      BZ._documents.find(".bz-tip").remove();
    }
    $(document).find(".bz-tip-iframe").remove();
    $(document).find(".bz-tip").remove();
    _bzDomPicker._removeTmpCover();
  },
  _autoRemove:function(_doc){
    _doc=_doc||BZ._documents;
    if(_doc){
      var os=_doc.find(".bz-tip-iframe");
      os.each(function(i,o){
        if(_Util._isHidden(o._ctrl._dom,0,1)){
          o._ctrl._remove();
        }
      });
    }
  },
  _setIdx:function(){
    this._autoRemove();
    if(window.name=="bz-master"){
      var os=$(".bz-tip-iframe");
    }else{
      var os=BZ._documents.find(".bz-tip-iframe");
    }
  },
  _showItems:function(ds,_idx){
    var d=ds[_idx];
    _Util._eval(d._hash,{_idx:_idx})
    var dd={description:d.description};
    var _this=this;
    setTimeout(function(){
      dd._dom=_Util._eval("dd._dom="+d._dom,{d:d,dd:dd});
      if(dd._dom && dd._dom.ownerDocument && dd._dom.ownerDocument.defaultView && !dd._dom.ownerDocument.defaultView.closed){
        _tipHandler._showItem(dd,ds,_idx);
        dd._dom.ownerDocument.defaultView.focus()
      }else{
        alert(_bzMessage._help._missElement)
      }
    },500);
  },
  _selectItem:function(o){
    if(o._ctrl._dom){
      var _doc=o._ctrl._dom.ownerDocument;
      var os=$(_doc).find(".bz-tip-iframe");
      
      $(_doc).find(".ErrBZCover").hide();
      
      $(o._ctrl._dom.parentNode).append(o._ctrl._dom);
      $(o._ctrl._dom).show();
    }
  },
  _hasItem:function(a){
    if(!BZ._documents){
      return 0;
    }
    var os=BZ._documents.find(".bz-tip-iframe");
    for(var i=0;i<os.length;i++){
      var aa=os[i]._ctrl._data._action;
      if(aa && (aa==a || (aa._path && aa._path==a._path))){
        this._selectItem(os[i]);
        return true;
      }else if(aa && aa._path && !a._path && _IDE._data._curTest){
        var _idx=_IDE._data._curTest._data.actions.indexOf(a);
        if(aa._idx==_idx){
          this._selectItem(os[i]);
          return true;
        }
      }
    }
  },
  _resetDesc:function(v){
    try{
      let vs=v.split(/\[[^\]]+\]/),
          vv=v.match(/\[[^\]]+\]/g),
          w=""
      vv=vv.map(x=>{
        return JSON.stringify(JSON.parse(x),0,2)
      })
      vs.forEach((x,i)=>{
        w+=x
        if(vv[i]){
          w+="\n"+vv[i]
        }
        return w
      })
      v=w
    }catch(e){}
    return v
  },
  _insertItem:function(a,e,_list,_idx){
    if(!a.description){
      return
    }
    a.description=_tipHandler._resetDesc(a.description)
    if(a.type){
      var os=$(".bz-tip-iframe").remove();
      
      var _iframe=$("<iframe id='bzTipFrame' class='bz-tip-iframe' border='0' style='background-color: transparent;border:0;position:absolute !important;z-index:2000000000 !important;top:-300px;left:-500px;border:0;width:340px;height:280px;'></iframe>").appendTo(e.ownerDocument.body.parentNode)[0];
      _iframe.contentDocument.write("<link rel='stylesheet' href='"+SERVER_HOST+"/ide/css/bzInsert.css'/><link rel='stylesheet' href='"+SERVER_HOST+"/ide/css/insert.icons.css'/><div class='bz-timing-info'></div>")
      _iframe.contentDocument.body.style.backgroundColor="transparent";
      $(_iframe.contentDocument.body).addClass("BZIgnore")
      _iframe.contentDocument.body.style.overflow="hidden"
    }else{
      var _iframe=0
    }
    var _ctrl={
      _iframe:_iframe,
      _document:_iframe?_iframe.contentDocument:e.ownerDocument,
      _dom:e,
      _data:a.type?_CtrlDriver._buildProxy({
        _action:a,
        _test:_IDE._data._curTest._data,_list:_list,_curIdx:_idx,
        _moduleCode:_IDE._data._curModule._data.code
      }):_CtrlDriver._buildProxy({_value:(a.description||"").trim(),_list:_list,_curIdx:_idx}),
      _viewDef:_Util._clone(_tipHandler._viewDef),
      _isEditable:function(){
        return !BZ._isAutoRunning() && !BZ._isPlaying() && this._data._action && (!this._data._test.lockBy || this._data._test.lockBy==curUser._id);
      },
      _setPosition:function(){
        var _way=["bottom","right","top","left"];
        var _arrawWay=["left","top","left","top"];
        var d=this._dom._bzTipInfo;
        if(this._iframe){
          var _mark1=$(d._mark._dom);
          var _mark2=$(this._iframe)
          for(var i=0;i<4;i++){
            var rr=d._mark._rect[_way[i]]
            if(rr){
              _mark2.css(rr._rect);
              
              _tipHandler._insertArrawStyle(this._iframe.contentDocument,_way[i],d._mark._arraw[_arrawWay[i]])
              
              var _bodyRect=this._dom._orgDom.ownerDocument.body.getBoundingClientRect();
              if(d._dom.width>_bodyRect.width-d._dom.width*2 && d._dom.height>_bodyRect.height-d._dom.height*2){
                var h=window.innerHeight<d._dom.height?window.innerHeight:d._dom.height;
                this._iframe.style.top=parseInt(this._dom.style.top)+h/2-d._mark._rect.height/2+"px";
              }
              
              _mark1.css(rr._tipChange)
              var r=_mark1[0].getBoundingClientRect();
              //_mark2.css({width:r.width+7+parseInt(rr._tipChange.left)+rr._boxSize.w+"px",height:r.height+7+parseInt(rr._tipChange.top)+rr._boxSize.h+"px"})
              $(d._mark._dom).find("button.bz-close").blur()
              break;
            }
          }
        }else{
          for(var i=0;i<4;i++){
            if(d._mark._rect[_way[i]]){
              var _mark=$(d._mark._dom);
              _mark.css(d._mark._rect[_way[i]]._rect);
              
              
              _tipHandler._insertArrawStyle(document,_way[i],d._mark._arraw[_arrawWay[i]])
              d._mark._dom._bzTipDone=1
              break;
            }
          }
          var _bodyRect=this._dom._orgDom.ownerDocument.body.getBoundingClientRect();
          if(d._dom.width>_bodyRect.width-d._dom.width*2 && d._dom.height>_bodyRect.height-d._dom.height*2){
            var h=window.innerHeight<d._dom.height?window.innerHeight:d._dom.height;
            d._mark._dom.style.top=parseInt(this._dom.style.top)+h/2-d._mark._rect.height/2+"px";
          }

          setTimeout(function(){
            $(d._mark._dom).find("button.bz-close").blur()
          },500);
        }
      },
      _remove:function(){
        $(this._iframe).remove();
        $(this._dom).remove();
        $(this._mark).remove();
      },
      _showListItem:function(){
        this._remove();
        _tipHandler._showItems(this._data._list,this._data._curIdx);
      },
      _refresh:function(){
        var e=this._dom;
        var _this=this;
        setTimeout(function(){
          window.scrollTo(_scroll.x,_scroll.y);
          
          var _rectMark=_this._mark.getBoundingClientRect();
          e._bzTipInfo={
            _dom:e._orgDom.getBoundingClientRect(),
            _mark:{
              _dom:_this._mark,
              _rect:{
                width:_rectMark.width,
                height:_rectMark.height
              },
              _arraw:{
                left:(_rectMark.width/2-_rim/2),
                top:(_rectMark.height/2-_rim/2)
              }
            }
          };
          _tipHandler._setTipMark(e,_rim);
          _this._setPosition();
        },100)
        
      }
    };
    if(_iframe){
      _iframe._ctrl=_ctrl;
    }
    var _rim=24;
    var _scroll={y:window.scrollY,x:window.scrollX}
    _ctrl._mark=_CtrlDriver._execute(_ctrl,_ctrl._data,_ctrl._viewDef);
    _ctrl._refresh()
  },
  _insertArrawStyle:function(_doc,_way,v){
    if(!_doc){
      return
    }
    $("#bz-tip-style").remove()
    var s,a=_doc.createElement("style");
    if(_way=="left"){
      s="left:unset;bottom:unset;right:-6px;top:"+v+"px;border:0;border-top:var(--bz-tip-border);border-right:var(--bz-tip-border);"
    }else if(_way=="right"){
      s="bottom:unset;right:unset;left:-6px;top:"+v+"px;border:0;border-bottom:var(--bz-tip-border);border-left:var(--bz-tip-border);"
    }else if(_way=="top"){
      s="top:unset;right:unset;bottom:-6px;left:"+(5+v)+"px;border:0;border-bottom:var(--bz-tip-border);border-right:var(--bz-tip-border);"
    }else{
      s="bottom:unset;right:unset;top:-6px;left:"+(5+v)+"px;border:0;border-top:var(--bz-tip-border);border-left:var(--bz-tip-border);"
    }
    _doc.body.append(a);
    a.innerText=".bz-tip:before{"+s+"}"
    a.id="bz-tip-style"
  },
  _setTipMark:function(d,_rim){
    var _dom=d._bzTipInfo._dom;
    var _mark=d._bzTipInfo._mark;
    _mark._dom._target=d;
    var o=0;
    if(_dom.left+_dom.width+_mark._rect.width+_rim<this._winRect.width){
      o=_mark._rect.right={
        _rect:{
          top:_dom.top-(_mark._rect.height-_dom.height)/2+window.scrollY,
          left:_dom.left+_dom.width+_rim-13+window.scrollX
        },
        _tipChange:{
          left:"13px",
          top:0,
        },
        _boxSize:{
          w:0,
          h:0
        }
      };
      if(o._rect.top+_mark._rect.height>this._winRect.height){
        o._rect.top=this._winRect.height-_mark._rect.height-_rim;
      }
    }
    if(_dom.top-_mark._rect.height-_rim>0){
      o=_mark._rect.top={
        _rect:{
          top:_dom.top-_mark._rect.height-_rim+13+window.scrollY,
          left:_dom.left-(_mark._rect.width-_dom.width)/2+window.scrollX
        },
        _tipChange:{
          left:0,
          top:0,
        },
        _boxSize:{
          h:26,
          w:0
        }
      };
      if(o._rect.left+_mark._rect.width>this._winRect.width){
        o._rect.left=this._winRect.width-_mark._rect.width-_rim;
      }
    }
    if(_dom.left-_mark._rect.width-_rim>0){
      o=_mark._rect.left={
        _rect:{
          top:_dom.top-(_mark._rect.height-_dom.height)/2+window.scrollY,
          left:_dom.left-_mark._rect.width-_rim+13+window.scrollX
        },
        _tipChange:{
          left:0,
          top:0,
        },
        _boxSize:{
          w:26,
          h:0
        }
      };
      if(o._rect.top+_mark._rect.height>this._winRect.height){
        o._rect.top=this._winRect.height-_mark._rect.height-_rim;
      }
    }
    if((_dom.top+_dom.height+_mark._rect.height+_rim<this._winRect.height && !_mark._rect.top) || (_dom.top+_dom.height+_mark._rect.height+_rim<window.innerHeight) || (!_mark._rect.top && !_mark._rect.left && !_mark._rect.right)){
      o=_mark._rect.bottom={
        _rect:{
          top:_dom.top+_dom.height+_rim-13+window.scrollY,
          left:_dom.left-(_mark._rect.width-_dom.width)/2+window.scrollX
        },
        _tipChange:{
          top:"13px",
          left:0
        },
        _boxSize:{
          w:0,
          h:0
        }
      };
      if(o._rect.left+_mark._rect.width>this._winRect.width){
        var _newLeft=this._winRect.width-_mark._rect.width-_rim;
        _mark._arraw.left+=o._rect.left-_newLeft-_rim/2;
        o._rect.left=_newLeft;
      }else if(o._rect.left<0){
        _mark._arraw.left+=o._rect.left;
        if(_mark._arraw.left<10){
          _mark._arraw.left=10
        }
        o._rect.left=0;
      }
    }
  },
  _showItem:function(_data,_list,_idx){
    $(".bz-tip-iframe,.bz-tip").remove();
    var _dom=_data._dom || $util.findDom(_data.element||"document.body");
    if(!_dom){
      return 0;
    }
    if(this._hasItem(_data)){
      return 1;
    }
    var o = _bzDomPicker._setErrCoverPosByDom(_dom);

    var _body =_dom.ownerDocument.body,
    html = _dom.ownerDocument.documentElement;
    var height = Math.max( _body.scrollHeight, _body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight );
    
    this._winRect={
      width:_body.clientWidth>$(window).width()?_body.clientWidth:$(window).width(),
      height:height
    };
    
    this._insertItem(_data,o,_list,_idx);
    if(!_list){
      this._setIdx();
    }
    return true;
  }
};

_tipHandler._viewDef={
  _tag:"div",
  _attr:{
    "class":"bz-tip BZIgnore",
    style:function(d,c){
      if(d._test && (d._test.code!=_IDE._data._curTest._data.code || d._moduleCode!=_IDE._data._curModule._data.code)){
        c._remove();
      }else if(c._lastStatus===undefined){
        c._lastStatus=BZ._data._status
      }else if(c._lastStatus!=BZ._data._status){
        if(!c._lastStatus || !BZ._data._status){
          c._refresh()
        }else{
          c._lastStatus=BZ._data._status
        }
      }
      if(window.name=="bz-master"){
        return "top:-1000px"
      }
    }
  },
  _jqext:{
    click:function(){
      if(window._extensionComm){
        if(this._ctrl._data._action && this._ctrl._data._test==_IDE._data._curTest._data){
          if(this._ctrl._data._action._path){
            BZ._setHash(this._ctrl._data._action._path);
          }else{
            _ideActionManagement._setActionHash(this._ctrl._data._action);
          }
        }
      }
    }
  },
  _items:[
    {
      _if:"BZ._data._uiSwitch._testPlay._curMode!='_demo'",
      _tag:"input",
      _focus:true,
      _attr:{
        "class":"bz-close",
        type:"button"
      },
      _jqext:{
        click:function(d,c){
          this._ctrl._remove();
        }
      }
    },
    {
      _if:"_data._value||BZ._isPausing()||BZ._isPlaying()",
      _tag:"pre",
      _html:"_compressJSON._unConvert(_data._value || _data._action.description || '')"
    },
    {
      _if:function(d){
        return !d._value&&!BZ._isPausing()&&!BZ._isPlaying()
      },
      _tag:"textarea",
      _focus:true,
      _attr:{
        style:"overflow: auto;",
        class:"helptip",
        value:function(d){
          return d._value || d._action.description || "";
        }
      },
      _dataModel:function(d){
        if(d._value){
          return "_data._value"
        }else{
          return "_data._action.description"
        }
      },
      _jqext:{
        keyup:function(){
          if(bzTwComm._isExtension()){
            _ideActionManagement._updateActionCommentDesc(this._data._action)
          }
        },
        focus:function(){
          if(this._data._value){
            this.disabled=true;
          }else if(this._data._action!=_IDE._data._curAction){
            if(this._data._action && this._data._action._target && this._data._action._target==_IDE._data._curAction){
              return;
            }
            this.disabled=true;
          }
        }
      }
    },
    //In List
    {
      _if:"_data._list",
      _tag:"div",_attr:{style:"margin-bottom:10px;text-align:right;padding-right:10px;min-width:250px;"},
      _items:[
        {
          _tag:"div",_attr:{style:"font-size: 25px; padding: 0;position: absolute;bottom: 5px;left: 10px;"},
          _items:[
            {
              _tag:"a",_text:".",_attr:{
                href:"javascript:",
                style:function(d){
                  if(d._idx==d._supData._curIdx){
                    return "font-size:50px;color:yellow;margin:3px;"
                  }
                  return "margin:3px;"
                },
                title:function(d){
                  var t=d._item.description;
                  var tt=t.split("<")[0];
                  t=t==tt?t:tt+" ...";
                  return d._idx+1+'. '+t;
                }
              },_jqext:{
                click:function(){
                  this._data._supData._curIdx=this._data._idx;
                  this._ctrl._showListItem()
                }
              },
              _dataRepeat:"_data._list"
            },
          ]
        },
        {
          _if:"_data._curIdx>=0",
          _tag:"button",_attr:{
            "class":"bz-sbs-btn bz-back-xs",
            disabled:"_data._curIdx==0",
            onclick:"window._rootWin?_rootWin.focus():''"
          },
          _jqext:{
            click:function(){
              this._data._curIdx--;
              this._ctrl._showListItem();
            }
          }
        },
        {
          _tag:"button",_attr:{
            "class":function(d){
              if(d._list.length==d._curIdx+1){
                return "bz-sbs-btn bz-stop-xs"
              }else{
                return "bz-sbs-btn bz-step-xs"
              }
            },
            onclick:"window._rootWin?_rootWin.focus():''"
          },
          _focus:true,
          _jqext:{
            click:function(){
              if(this._data._list.length==this._data._curIdx+1){
                this._ctrl._remove();
              }else{
                this._data._curIdx++;
                this._ctrl._showListItem();
              }
            }
          }
        }
      ]
    },
    //In Execute
    {
      _if:"BZ._isPausing()",
      _tag:"div",_attr:{style:"margin-bottom:10px;text-align:right;padding-right:10px;min-width:250px;"},
      _items:[
        {
          _if:"_IDE._data._curAction.type==5 && _IDE._data._curAction.showJudge",
          _tag:"button",_attr:{style:"color:#000;font-size:10px;float:left;margin-left:20px;background-color: #CCC;border: 1px solid #FFF;padding:1px 5px;"},
          _text:"_bzMessage._method._pass",
          _jqext:{
            click:function(e){
              _tipHandler._doAfterComment(4);
              e.stopPropagation()
            }
          }
        },
        {
          _if:"_IDE._data._curAction.type==5 && _IDE._data._curAction.showJudge",
          _tag:"button",_attr:{style:"color:#000;font-size:10px;float:left;margin-left:20px;background-color: #CCC;border: 1px solid #FFF;padding:1px 5px;"},
          _text:"_bzMessage._method._fail",
          _jqext:{
            click:function(e){
              _tipHandler._doAfterComment(2);
              e.stopPropagation()
            }
          }
        },
        {
          _tag:"button",_attr:{
            "class":"bz-sbs-btn bz-step-xs"
          },
          _focus:true,
          _jqext:{
            click:function(e){
              _tipHandler._doAfterComment();
              e.stopPropagation()
            }
          }
        }
      ]
    }
  ]
};var _miniStopBtn={
  _if:function(){
    return BZ._inProcessing()
  },
  _tag:"button",
  _attr:{
    "class":function(){
      var c="bz-stop";
      if(BZ._isRecording()){
        var c="bz-stop-red"
      }
      return 'bz-btn-tb-icon '+c+' bz-active';
    },
    disabled:function(){
      return !BZ._data._status || !_IDE._data._curTest
    },
    title:function(){
      return _bzMessage._method._stop
    }
  },
  _jqext:{
    click:function(){
      BZ._triggerSetStatus(0)
    }
  }
};

var _miniRecordBtn={
  _if:function(){
    return !BZ._inProcessing()
  },
  _tag:"button",
  _attr:{
    "class":function(){
      return 'bz-btn-tb-icon bz-record'
    },
    title:function(){
      var t=_bzMessage._innerWin._tools._recordAdd;
      if(_IDE._data._curTest){
        t=_bzMessage._innerWin._tools._recordInsert;
      }
      return t;
    },
    disabled:function(){
      let t=_IDE._data._curTest
      return BZ._data._status || !t||['int','scenario','api'].includes(t._data.type) || !BZ._isCheckout()

    }
  },
  _jqext:{
    click:function(){
      BZ._triggerSetStatus("record")
    }
  }
};

_IDE._innerWin={
  _rootWin:window,
  _data:_CtrlDriver._buildProxy({
    _pos:{
      _top:0,
      _left:window.innerWidth/2-100,
      _timeStamp:Date.now(),
      _inMin:0,
      _recordMin:0,
      _playMin:0
    },
    _dataBind:{
      _showDataBind:0
    },
    _tools:{
      _monitorList:[],
      _scope:"body"
    }
  }),
  _switchUI:function(){
    _IDE._innerWin._data._pos._inMin=!_IDE._innerWin._data._pos._inMin;
    _IDE._innerWin._updatePosition()
    setTimeout(function(){
      _IDE._innerWin._setDrag();
    },100);
    _IDE._innerWin._refresh(1)
  },
  _exeTool:function(k){
    bzTwComm._postToIDE({_fun:"_exeTool",_scope:"_ideTask",_args:[k]})
  },
  _updatePosition:function(){
    try{
      var _win=BZ._documents.find("#BZ_Win");
      if(_win.length){
        this._data._pos._top=parseInt(_win.css("top"));
        this._data._pos._left=parseInt(_win.css("left"));

        if(this._data._pos._top>screen.height){
          this._data._pos._top=screen.height-100;
          _win.css({top:screen.height-this._data._pos._top});
        }
        BZ._userHabit.toolbarPos={top:this._data._pos._top,left:this._data._pos._left,inMin:this._data._pos._inMin};
        BZ._storeUserHabit();
      }
    }catch(e){
    }
  },
  _insertCtrls:function(bSwitch,bMax){ //insert controls into customer application window
    if(BZ._isAutoRunning()||parent!=window||bzTwComm._isIDE()){
      return
    }
    // console.log("Call page ready")
    if(bzTwComm._isExtension()){
      if(BZ._isRecording()){
        setTimeout(()=>{
          _domRecorder._handleFileInput()
        },100)
      }
    }

    if(!BZ._documents){
      return BZ._prepareDocument(function(){
        _IDE._innerWin._insertCtrls(true,bMax);
      });
    }
    this._document=BZ.TW.document;
    //Insert BZ-Style.css
    BZ.TW._rootWin=window;
    BZ._retrieveUserHabit();
    var _win;
    if(BZ.TW && BZ.TW.document && BZ.TW.document.defaultView && !BZ.TW.closed){
      _win=$(BZ.TW.document).find("#BZ_Win");
    }else{
      _win=BZ._documents.find("#BZ_Win");
    }
    
    var _top=parseInt(_win.css("top"));
    if(_win.length && _top<0 || _top>BZ.TW.innerHeight-100){
      this._data._pos._top=0;
      this._data._pos.left=0;
    }else if(_win.length){
      this._data._pos._top=parseInt(_win.css("top"));
      this._data._pos._left=parseInt(_win.css("left"));
    }else if(BZ._userHabit&&!bSwitch){
      var pos=BZ._userHabit.toolbarPos;
      if(pos && !this._data._pos._inMin){
        this._data._pos._inMin=pos.inMin===undefined?1:pos.inMin;
        this._data._pos._top=pos.top;
        if(this._data._pos._top>screen.height){
          this._data._pos._top=screen.height-100;
        }
        this._data._pos._left=pos.left;
        if(this._data._pos._top>screen.width){
          this._data._pos._top=screen.width-400;
        }
      }
    }
    if(bSwitch){
      _IDE._innerWin._storePersonData()
    }

    if(_win.length){
      if(bMax){
        if(_IDE._innerWin._data._pos._inMin){
          _IDE._innerWin._switchUI()
        }
      }
      return;
    }
    _TWHandler._setUnload();
    _IDE._innerWin._document=BZ.TW.document;
    var _data=_Util._clone(this._data);
    delete this._data;
    this._data=_CtrlDriver._buildProxy(_data);
    curUser=_CtrlDriver._buildProxy(curUser);
    _IDE._innerWin._curDom=_CtrlDriver._execute(this,this._data,this._viewDef,BZ.TW.document.body.parentNode);
    
    this._setDrag();
    
    if(bMax){
      if(_IDE._innerWin._data._pos._inMin){
        _IDE._innerWin._switchUI()
      }
    }
    if(BZ._isPlaying() && !BZ._isAutoRunning()){
      _timingInfo._init()
    }
  },
  _refresh:function(s){
    if(_IDE._innerWin._curDom){
      _IDE._innerWin._curDom.remove();
    }
    _IDE._innerWin._insertCtrls(s);
  },
  _setDrag:function(){
    _Util._setDrag([_IDE._innerWin._comps.BZ_Header,_IDE._innerWin._comps.BZ_Info],_IDE._innerWin._curDom)
  },
  _newAction:function(o,v){
    _ideActionManagement._newItem(v);
  },
  _showDemoWin:function(){
    if(!$("#bz-demo-window")[0]){
      var w=$("<pre id='bz-demo-window' class='BZIgnore' style='background-color:rgba(0,0,125,0.05);position:fixed;left:0;top:0;right:0;bottom:0;z-index:1000000000000000'><i style='background-color:#000;padding:5px;border-radius:5px;color:#FFF;position:fixed;'></i></pre>").insertAfter(document.body)
      let _did=0
      w.click(function(e){
        let _this=this
        setTimeout(()=>{
          if(_this._lastFocus){
            $(_this._lastFocus).focus()
          }
          bzTwComm._postToIDE({c:"_ideTask._demoHandler._exeNextStep()"});
        },10)
      })
      w.mouseover(function(e){
        this._lastFocus=$(":focus")[0]
      })
      $(BZ.TW.document.body).keydown(function(e){
        if(!_did&&(e.keyCode==40||e.keyCode==39||e.ctrlKey)){
          _did=1
          bzTwComm._postToIDE({c:"_ideTask._demoHandler._exeNextStep()"});
        }
      })
      $(BZ.TW.document.body).keyup(function(e){
        _did=0
      })
    }
  },
  _removeDemoWin:function(){
    $("#bz-demo-window").remove()
  },
  _showPlayMenu:function(){
    _IDE._innerWin._data._tools._showPlayMenu=!_IDE._innerWin._data._tools._showPlayMenu;
    if(_IDE._innerWin._data._tools._showPlayMenu && !BZ.TW.BZ_InnerWin_Play_Menu_Click){
      BZ.TW.BZ_InnerWin_Play_Menu_Click=true;
      $(BZ.TW.document).click(function(e){
        if(!$(e.target).hasClass("bz-dropdown") && _IDE._innerWin._data._tools._showPlayMenu){
          _IDE._innerWin._data._tools._showPlayMenu=0;
        }
      })
    }
  },
  _showToolsMenu:function(){
    _IDE._innerWin._data._tools._showToolsMenu=!_IDE._innerWin._data._tools._showToolsMenu;
    if(_IDE._innerWin._data._tools._showToolsMenu && !BZ.TW.BZ_InnerWin_Tools_Menu_Click){
      BZ.TW.BZ_InnerWin_Tools_Menu_Click=true;
      $(BZ.TW.document).click(function(e){
        if(!$(e.target).hasClass("bz-show-attribute") && _IDE._innerWin._data._tools._showToolsMenu){
          _IDE._innerWin._data._tools._showToolsMenu=0;
        }
      })
    }
  },
  _showElementFilter:function(){
    var v=_IDE._innerWin._data._tools._showElementFilter=!_IDE._innerWin._data._tools._showElementFilter
    if(v){
      if(!curUser._curProject.setting.elementFilters.length){
        curUser._curProject.setting.elementFilters.push({
          bz:1,
          chk:"on",
          filter:"[data-bz]"
        })
      }
      _CtrlDriver._execute(this,_CtrlDriver._buildProxy({}),{
        _tag:"div",
        _attr:{
          "class":"bz-tb-container BZIgnore",
          style:""
        },
        _items:[
          
        ]
      },BZ.TW.document.body.parentNode);
      
    }else{
      _IDE._innerWin._removeFilterElement()
    }
  },
  _showElementFilterSetting:function(o){
    let v=_IDE._innerWin._data._tools
    v._showElementFilterSetting=!v._showElementFilterSetting
    // if(v._showElementFilterSetting){
      // o.innerText=_bzMessage._method._hideSetting
    // }else{
      // o.innerText=_bzMessage._tools._setting
    // }
  },
  _removeFilterElement:function(){
    _bzDomPicker._removeTmpCover()
    _IDE._innerWin._data._tools._autoFilterElement=0
  },
  _doDark:function(){
    let v=_IDE._innerWin._data._tools
    v._inDark=!v._inDark
  },
  _doFilterElement:function(){
    let oo=[],_scope=_IDE._innerWin._data._tools
    _scope._scope=_scope._scope||"body"
    let _exObj
    if(_scope._scope.constructor==String){
      _scope=$(BZ.TW.document).find(_scope._scope)[0]
      if(!_scope){
        _scope=BZ.TW.document
      }else{
        _scope=_scope.parentNode||_scope
      }
    }else{
      oo=[_scope._scope]
      _exObj=_scope=_scope._scope
    }

    _bzDomPicker._removeTmpCover()
    curUser._curProject.setting.elementFilters.forEach(v=>{
      if(!v.chk){
        return
      }
      var os=[],_attr=v.filter.match(/^\[(.*)\]$/);
      if(_attr){
        _attr=_attr[1].split("=")[0]
      }
      os=$(_scope).find(v.filter).toArray()
      os.forEach(z=>{
        if(!oo.includes(z)){
          oo.push(z)
        }
      })
      if(_exObj){
        os.unshift(_exObj)
        _exObj=0
      }
      _IDE._innerWin._data._tools._autoFilterElement=1
      _bzDomPicker._showTmpCover(os,0,function(os,cs){
        $(cs).css({
          border:"var(--bz-flag-border"+(_IDE._innerWin._data._tools._inDark?'-dark':'')+")",
          "background-color":"rgba(0,0,0,0.1)"
        })
        let _filter=v.filter
        if(_attr){
          for(var j=0;j<os.attributes.length;j++){
            var a=os.attributes[j]
            if(a.name==_attr){
              _filter=a.name+"="+a.value
              break
            }
          }
        }
        let _top="-23px",cr=cs.getBoundingClientRect()
        if(cr.top<30){
          _top=cr.bottom-16+"px"
        }
        let _color=_IDE._innerWin._data._tools._inDark?'-dark':''
        $(cs).append("<span onmouseover='this.parentNode.style.zIndex=2147483647' onmouseout='this.parentNode.style.zIndex=2147483646' style='white-space:nowrap;background-color:var(--bz-flag-color"+_color+");position:absolute;color:var(--bz-flag-text-color"+_color+");padding:2px 6px;border-radius:var(--bz-border-radius);margin-top:"+_top+";font-size:12px;cursor:copy;'>"+_filter+"</span>")
        cs.onmouseover=function(){
          let o=this.children[0]
          let r=this.getBoundingClientRect()
          let _top="-23px"
          if(r.top<30){
            _top=r.bottom-12+"px"
          }
          $(o).css({
            "margin-top":_top
          })
          o.title=_bzMessage._method._copyElementPathByClick+": \n"+o.innerText;
          $(".BZCover").toArray().forEach(x=>{
            if(x!=o.parentElement&&!$(o.parentElement._orgDom).find(x._orgDom)[0]){
              $(x).css({visibility:"hidden"})
            }
          })
          
          this.title=this.innerText+"\n\n["+_bzMessage._method._closeByClick+"]"
          $(this).css({
            backgroundColor:"rgba(0, 0, 0, 0.05)",
            margin:"-2px",
            width:r.width+4+"px",
            height:r.height+4+"px",
            border:"var(--bz-flag-select-border"+(_IDE._innerWin._data._tools._inDark?'-dark':'')+")",
          })
          $(this).find("span").css({
            color:_color?"#009":"#FF0"
          })
        }
        cs.onmouseout=function(){
          let o=this.children[0],
              _dark=_IDE._innerWin._data._tools._inDark?'-dark':'';
              
          $(".BZCover").css({visibility:"unset"})

          let r=this.getBoundingClientRect()
          let _top="-23px"
          if(r.top<30){
            _top=r.bottom-18+"px"
          }
          $(o).css({        
            "margin-top":_top
          })

          $(this).css({
            backgroundColor:"rgba(0, 0, 0, 0.1)",
            margin:"0px",
            width:r.width-4+"px",
            height:r.height-4+"px",
            border:"var(--bz-flag-border"+(_dark)+")"
          })
          $(this).find("span").css({
            color:"var(--bz-flag-text-color"+_color
          })
        }
        cs.onclick=function(e){
          if(e&&e.target==this){
            this.remove()
            e.stopPropagation()
          }
        }
        cs.onmousedown=function(e){
          if(e.button==2){
            _IDE._innerWin._data._tools._scope=this._orgDom
            _IDE._innerWin._doFilterElement();
            e.stopPropagation()
          }
        }
      },1)
    })
  },
  _storePersonData:function(v){
    if(!window.curUser){
      return
    }
    let vv=curUser._curProject.setting.elementFilters
    if(bzTwComm._isExtension()){
      bzTwComm._postToIDE({_fun:"_storePersonData",_scope:"_IDE._innerWin",_args:[vv]})
    }else if(v){
      _personalSetting.elementFilters=_IDE._data._setting.elementFilters=curUser._curProject.setting.elementFilters=v||vv
      _ideVersionManagement._save()
    }
    if(_IDE._innerWin._data._tools._autoFilterElement&&!v){
      _IDE._innerWin._doFilterElement()
    }
  },
  _setUIData:function(d){
    $.extend(_IDE._innerWin._data,d)
  }
};

_IDE._innerWin._viewDef={
  _tag:"div",
  _attr:{
    id:"BZ_Win",
    "class":function(){
      return "bz-tb-container BZIgnore"
    },
    style:function(){
      var w=_IDE._innerWin._data._pos._inMin?BZ._isRecording()?'width:54px':"width:106px;":!BZ._isPlaying()?"width:271px":"width:203px";
      var t=parseInt(_IDE._innerWin._data._pos._top);
      t=t||0;
      var l=parseInt(_IDE._innerWin._data._pos._left);
      l=l||0;
      if(t+20>BZ.TW.innerHeight){
        t=0;
      }
      if(l+20>BZ.TW.innerWidth){
        l=0;
      }
      return "top:"+t+"px;left:"+l+"px;position:fixed;z-index:2147483647;font-size: 13px;font-weight: normal;color: #666;"+w;
    }
  },
  _items:[
    {
      _tag:"div",
      _attr:{
        class:function(){
          return "bz-tmp-body"
        },
        style:function(){
          return "white-space:nowrap;"
        }
      },
      _text:function(){
        return _bzMessage._method._loading
      }
    },
    {
      _tag:"div",
      _attr:{
        style:function(){
          return "display:none;"
        },
        class:function(){
          return "bz-main-body"
        }
      },
      _items:[
        //Header
        {
          id:"BZ_Header",
          _tag:"div",
          _attr:{
            "class":"bz-tb-header"
          },
          _items:[
            //icon
            {
              _tag:"div",
              _attr:{
                "class":"bz-btn-tb-icon bz-boozang-logo-small",
                style:function(){
                  return "width:19px;height:19px;cursor:pointer;float:left;margin:4px;padding:0;border:0;background-position:25px 25px;background-size: 34px !important;margin-bottom:0;";
                }
              }
            },
            //reload
            {
              id:"_reloadBtn",
              _tag:"button",
              _attr:{
                style:"display:none",
                onclick:"location.reload()"
              }
            },
            {
              _tag:"div",
              _attr:{
                style:"flex:1"
              }
            },
            //min
            {
              _if:function(){
                return !_IDE._innerWin._data._tools._showElementFilter
              },
              _tag:"div",
              _attr:{
                "class":function(){
                  if(!_IDE._innerWin._data._pos._inMin){
                    return "bz-btn-icon-tn bz-header-right bz-minimize-white"
                  }else{
                    return "bz-btn-icon-tn bz-header-right bz-plus-white"
                  }
                },
                style:"height:24px;"
              },
              _jqext:{
                click:function(e){
                  _IDE._innerWin._switchUI()
                  e.stopPropagation()
                  e.preventDefault()
                }
              }
            }
          ],
          _jqext:{
            click:function(){
              _rootWin._IDE._innerWin._updatePosition()
            },
            dblclick:function(){
              _rootWin._IDE._innerWin._switchUI()
            }
          }
        },
        {
          _if:function(){
            return !_IDE._innerWin._data._pos._inMin&&!_IDE._innerWin._data._tools._showElementFilter
          },
          _tag:"div",
          _items:[
            //Buttons
            {
              _tag:"div",
              _attr:{
                "class":"bz-tb-body"
              },
              _items:[
                {
                  _tag:"div",
                  _attr:{
                    "class":"bz-tb-buttons"
                  },
                  _items:[
                    //record
                    _miniRecordBtn,
                    _miniStopBtn,
                    //Play
                    {
                      _if:function(){
                        return !BZ._isPlaying()
                      },
                      _tag:"button",
                      _attr:{
                        class:"'bz_playBtn bz-btn-tb-icon bz-play'+(_IDE._data._curAction?'-blue':'')",
//                         "class":function(){
//                           var c="bz_playBtn bz-btn-tb-icon";
//                           var v=BZ._data._uiSwitch._testPlay._curMode;
//                           if(v=="_stepByStep"){
//                             return c+" bz-step"
//                           }else if(v=="_demo"){
//                             return c+" bz-demo"
//                           }else if(v=="_camera"){
//                             return c+" bz-camera"
// //                          }else if(v=="_debugging"){
// //                            return c+" bz-play-repair"
//                           }else if(v=="_auto"){
//                             return c+" bz-play-auto"
//                           }else{
//                             return c+" bz-play"
//                           }
//                         },
                        disabled:"(BZ._data._status && BZ._data._status!='pause') || !_IDE._data._curTest || !_IDE._data._curTest._data",
                        title:function(){
                          let c=_bzMessage._test._play;
                          if(_IDE._data._curAction){
                            c=c._fromAction
                          }else{
                            c=c._play
                          }
                          return c
                        },
                        disabled:function(){
                          return (BZ._data._status && BZ._data._status!='pause') || !_IDE._data._curTest
                        },
                        title:function(){
                          return _bzMessage._test._play[BZ._data._uiSwitch._testPlay._curMode||'_play']
                        }
                      },
                      _jqext:{
                        click:function(){
                          _rootWin._ideTestManagement._play(1)
                        }
                      }
                    },
                    /*
                    //dropdown
                    {
                      _if:function(){
                        return !BZ._isPlaying()
                      },
                      _tag:"button",
                      _attr:{
                        "class":"bz-btn-tb-icon bz-btn-tb-icon-half bz-dropdown",
                        disabled:function(){
                          return (BZ._data._status && BZ._data._status!='pause') || !_IDE._data._curTest
                        }
                      },
                      _jqext:{
                        click:function(){
                          _rootWin._IDE._innerWin._showPlayMenu()
                        }
                      }
                    },
                    //play menu
                    {
                      _if:function(){
                        return !BZ._isPlaying() && _IDE._innerWin._data._tools._showPlayMenu
                      },
                      _tag:"div",
                      _attr:{
                        style:"position: absolute; width: 220px;z-index: 100;background-color:#FFF;border:1px solid #CCC;cursor:pointer;top: 74px;left: 50px;"
                      },
                      _items:[
                        //Play
                        {
                          _tag:"div",_attr:{
                            "class":"bz-play-item"
                          },
                          _items:[
                            {
                              _tag:"button",
                              _attr:{
                                "class":function(d){
                                  return "bz-btn-tb-icon bz-btn-tb-icon-sm "+d._item._icon
                                }
                              }
                            },
                            {
                              _tag:"span",_attr:{style:"padding-left:10px;position: absolute;margin-top: 10px;"},
                              _text:function(d){
                                return _bzMessage._test._play[d._item._curMode]
                              }
                            }
                          ],
                          _dataRepeat:[
                            {_curMode:"_play",_icon:"bz-play"},
                            {_curMode:"_playgood",_icon:"bz-play-good"},
                            {_curMode:"_stepByStep",_icon:"bz-step"},
//                            {_curMode:"_debugging",_icon:"bz-play-repair"},
                            {_curMode:"_camera",_icon:"bz-camera"},
                            {_curMode:"_auto",_icon:"bz-play-auto"},
                          ]
                        }
                      ]
                    },
                    */
                    //pause
                    {
                      _if:function(){
                        return BZ._isPlaying()
                      },
                      _tag:"button",
                      _attr:{
                        "class":"bz-btn-tb-icon bz-pause",
                        title:function(){
                          return _bzMessage._method._pause
                        }
                      },
                      _jqext:{
                        click:function(){
                          _rootWin._ideTask._pause();
                        }
                      }
                    },
                    //validate
                    {
                      _tag:"button",
                      _attr:{
                        "class":function(){
                          var c='bz-btn-tb-icon bz-validate';
                          var a=_IDE._data._curAction;
                          if(a && a.type==_ideActionData._type._validation && _bzDomPicker._isActionElementPicking()){
                            c+=" bz-active"
                          }
                          return c;
                        },
                        title:function(){
                          return _bzMessage._method._validate
                        },
                        disabled:function(){
                          let t=_IDE._data._curTest
                          return (BZ._data._status && !BZ._isRecording()) || !t||['int','scenario','api'].includes(t._data.type) || !BZ._isCheckout()
                        }
                      },
                      _jqext:{
                        click:function(){
                          if(this.className.includes("bz-active")){
                            bzTwComm._postToIDE({_fun:"_removeCurItem",_scope:"_ideActionManagement",_args:[_ideActionData._type._validation]})
                            $(this).removeClass("bz-active")
                            this.blur()
                          }else{
                            bzTwComm._postToIDE({_fun:"_newItem",_scope:"_ideActionManagement",_args:[_ideActionData._type._validation]})
                          }
                        }
                      }
                    },
                    //comment
                    {
                      _tag:"button",
                      _attr:{
                        "class":function(){
                          var c='bz-btn-tb-icon bz-comment';
                          var a=_IDE._data._curAction;
                          if(a && a.type==_ideActionData._type._comment && _bzDomPicker._isActionElementPicking()){
                            c+=" bz-active"
                          }
                          return c;
                        },
                        title:function(){
                          return _bzMessage._method._comment
                        },
                        disabled:function(){
                          let t=_IDE._data._curTest
                          return (BZ._data._status && !BZ._isRecording()) || !t||['int','scenario','api'].includes(t._data.type) || !BZ._isCheckout()
                        }
                      },
                      _jqext:{
                        click:function(){
                          if(this.className.includes("bz-active")){
                            bzTwComm._postToIDE({_fun:"_removeCurItem",_scope:"_ideActionManagement",_args:[_ideActionData._type._comment]})
                            $(this).removeClass("bz-active")
                            this.blur()
                          }else{
                            bzTwComm._postToIDE({_fun:"_newItem",_scope:"_ideActionManagement",_args:[_ideActionData._type._comment]})
                          }
                        }
                      }
                    },
                    //tools
                    {
                      _tag:"button",
                      _attr:{
                        style:"border-right:0;",
                        class:'bz-btn-tb-icon bz-show-attribute',
                        title:function(){
                          return _bzMessage._method._showAttribute
                        }
                      },
                      _jqext:{
                        click:function(){
                          _rootWin._IDE._innerWin._showElementFilter()
                        }
                      }
                    }
                  ]
                }
              ]
            },
            //Info
            {
              id:"BZ_Info",
              _tag:"div",
              _attr:{
                "class":"bz-tb-body"
              },
              _items:[
                {
                  _tag:"div",
                  _attr:{
                    "class":"bz-tb-subheader"
                  },
                  _items:[
                    {
                      _if:function(){
                        return BZ._isRecording()
                      },
                      _tag:"label",_attr:{style:"font-weight:normal;position:absolute;padding:0;margin:0;top:100px;left:0;"},_items:[
                        {
                          _tag:"input",
                          _attr:{
                            type:"checkbox",
                            value:"1",
                            style:"-webkit-appearance: checkbox;opacity: 1;display: inline;vertical-align: initial;width: 15px;position: absolute;left:5px;bottom:5px;line-height:0 !important;visibility: visible;opacity: 1;max-width:15px !important;max-height:15px !important;height:15px !important;margin:0 !important","class":"bz-db-switch"
                          },
                          _dataModel:"_IDE._innerWin._data._dataBind._showDataBind",
                          _jqext:{
                            click:function(){
                              bzTwComm._postToIDE({_fun:'setDataBindSwitch',_scope:'BZ',_args:[this.checked]});
                            }
                          }
                        },
                        {
                          _tag:"span",_attr:{style:"font-size:10pt;color: #21242C;position: absolute;bottom:5px;left:22px;line-height:1;margin:0;padding:0 !important;height:13px;"},
                          _text:function(d){
                            return _bzMessage._innerWin._tools._dataBindInRecording
                          }
                        }
                      ]
                    },
                    {
                      _tag:"a",
                      _text:function(){
                        return _bzMessage._dataBind._autoFill
                      },
                      _attr:{
                        style:"position:absolute;right:5px;line-height:1;top:80px;font-size:10pt;text-decoration: underline;color:#66F;",
                        "href":"javascript:"
                      },
                      _jqext:{
                        click:function(){
                          bzTwComm._postToExt({_fun:'_autoFill',_scope:'_ideDataBind'})
                        }
                      }
                    },
                    {
                      _if:function(){
                        return BZ._isRecording()&&_IDE._data._curTest&&_IDE._innerWin._data._dataBind._showDataBind&&_ideDataBind._data._inSelectFillField
                      },
                      _tag:"a",
                      _text:function(d){
                        return _bzMessage._method._continue
                      },
                      _attr:{
                        style:"position:absolute;right:5px;line-height:1;top:80px;font-size:11px;text-decoration: underline;color:#66F;","href":"javascript:",
                      },
                      _jqext:{
                        click:function(){
                          bzTwComm._postToExt({_fun:'_autoFillContinue',_scope:'_ideDataBind'});
                        }
                      }
                    }
                  ]
                }
              ]
            },
            {
              _if:function(){
                return _IDE._innerWin._data._curDomPath
              },
              _tag:"div",
              _attr:{"class":"bz-tb-body"},
              _items:[
                {
                  _tag:"div",
                  _attr:{
                    "class":"bz-tb-header",
                    style:"'font-weight:bold;padding:0 6px;margin-top:'+(_IDE._innerWin._data._dataBind._showDataBind&&_IDE._data._curTest&&BZ._isRecording()?'32px':0)"
                  },
                  _items:[
                    {
                      _tag:"span",
                      _text:function(d){
                        return _bzMessage._innerWin._domPath
                      }
                    },
                    {
                      _tag:"a",
                      _text:function(d){
                        return _bzMessage._method._cancel
                      },
                      _attr:{
                        style:"cursor:pointer;color:#FF0;float:right;text-decoration:underline"
                      },
                      _jqext:{
                        click:function(){
                          _IDE._innerWin._data._curDomPath=0
                          _bzDomPicker._endRequire()
                        }
                      }
                    }
                  ]
                },
                {
                  _tag:"div",
                  _attr:{
                    "class":"bz-tb-subheader",
                    style:function(d){
                      if(d._idx){
                        return "text-indent:20px"
                      }
                    }
                  },
                  _text:function(d){
                    return d._item
                  },
                  _dataRepeat:function(){
                    return _IDE._innerWin._data._curDomPath
                  }
                }
              ]
            }
          ]
        },
        //Mini stop button
        {
          _if:function(){
            return !_IDE._innerWin._data._tools._showElementFilter&&_IDE._innerWin._data._pos._inMin && (BZ._isPlaying() || BZ._isRecording() || BZ._isPausing())
          },
          _tag:"div",
          _items:[
            {
              _tag:"div",
              _attr:{
                "class":"bz-tb-body",
              },
              _items:[
                {
                  _tag:"div",
                  _attr:{
                    "class":"bz-tb-buttons",style:function(){
                      return "padding-left:2px;"
                    }
                  },
                  _items:[
                    _miniStopBtn,
                    //pause
                    {
                      _if:function(){
                        return BZ._isPlaying()
                      },
                      _tag:"button",
                      _attr:{
                        class:"bz-btn-tb-icon bz-pause",
                        title:function(){
                          return _bzMessage._method._pause
                        }
                      },
                      _jqext:{
                        click:function(){
                          _rootWin._ideTask._pause();
                        }
                      }
                    },
                    //Play
                    {
                      _if:function(){
                        return BZ._isPausing()
                      },
                      _tag:"button",
                      _attr:{
                        "class":"bz-btn-tb-icon bz-play bz_playBtn",
                        title:function(){
                          return _bzMessage._method._play
                        }
                      },
                      _jqext:{
                        click:function(){
                          _rootWin._ideTestManagement._play(1);
                        }
                      }
                    },
                  ]
                }
              ]
            }
          ]
        },
        //element filter
        {
          _if:function(){
            return _IDE._innerWin._data._tools._showElementFilter
          },
          _tag:"div",
          _attr:{
            style:"padding:0 0 5px 0;background-color:#FFF;width:100%;float:left;"
          },
          _items:[
            {
              _tag:"a",
              _attr:{
                "class":"bz-element-filter",
                style:"cursor:pointer;float:right;height:0;position:relative;top:-25px;color:#FFF;"
              },
              _text:function(d){
                return _bzMessage._method._close
              },
              _jqext:{
                click:function(){
                  _IDE._innerWin._showElementFilter()
                }
              }
            },
            {
              _tag:"table",
              _attr:{
                style:"width:100%;margin:5px 0;"
              },
              _items:[
                {
                  _tag:"tbody",
                  _items:[
                    {
                      _tag:"tr",
                      _items:[
                        {
                          _tag:"td",
                          _attr:{
                            colspan:"100%",
                            style:"padding:0 5px 5px 5px;"
                          },
                          _items:[
                            {
                              _tag:"div",
                              _attr:{
                                style:"display:flex;"
                              },
                              _items:[
                                {
                                  _tag:"label",
                                  _attr:{
                                    style:"margin:5px;"
                                  },
                                  _text:function(d){
                                    return _bzMessage._common._scope
                                  }
                                },
                                {
                                  _tag:"input",
                                  _attr:{
                                    style:"flex:1;margin:3px 5px;"
                                  },
                                  _dataModel:"_IDE._innerWin._data._tools._scope",
                                  _text:function(d){
                                    return _bzMessage._method._addFreeFilter
                                  },
                                  _jqext:{
                                    change:function(){
                                      _rootWin._IDE._innerWin._doFilterElement()
                                    }
                                  }
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    },
                    {
                      _tag:"tr",
                      _items:[
                        {
                          _tag:"td",
                          _attr:{
                            colspan:"100%",
                            style:"padding:5px;"
                          },
                          _items:[
                            {
                              _tag:"a",
                              _attr:{
                                style:"margin:5px;cursor:pointer;color:#00F !important;"
                              },
                              _text:function(d){
                                return _bzMessage._method._addFlagFilter
                              },
                              _jqext:{
                                click:function(){
                                  curUser._curProject.setting.elementFilters.push({chk:"on",filter:"[data-bz]",bz:1})
                                }
                              }
                            },
                            {
                              _tag:"a",
                              _attr:{
                                style:"margin:5px;cursor:pointer;color:#00F !important;"
                              },
                              _text:function(d){
                                return _bzMessage._method._addFreeFilter
                              },
                              _jqext:{
                                click:function(){
                                  curUser._curProject.setting.elementFilters.push({chk:"on",filter:""})
                                }
                              }
                            }
                          ]
                        }
                      ]
                    },
                    {
                      _tag:"tr",
                      _attr:{
                        style:"height:0;"
                      },
                      _items:[
                        {
                          _tag:"td",
                          _attr:{
                            style:"vertical-align: middle;width:0;"
                          },
                          _items:[
                            {
                              _tag:"input",
                              _attr:{type:"checkbox",checked:"_data._item.chk"},
                              _jqext:{
                                change:function(){
                                  curUser._curProject.setting.elementFilters[this._data._idx].chk=this.checked?"on":""
                                  setTimeout("_rootWin._IDE._innerWin._storePersonData()",500)
                                }
                              }
                            }
                          ]
                        },
                        {
                          _tag:"td",
                          _attr:{
                            style:"vertical-align: middle;"
                          },
                          _update:function(){
                            setTimeout("_rootWin._IDE._innerWin._storePersonData()",500)
                          },
                          _items:[
                            {
                              _if:function(d){
                                return d._item.bz
                              },
                              _tag:"select",
                              _attr:{
                                style:"width:100%;height:20px;border:0;padding:0;margin:0;background-color:inherit;border-bottom:1px solid #CCC;",
                              },
                              _items:[
                                {
                                  _tag:"option",
                                  _attr:{
                                    value:"'[data-bz'+_data._item+']'",
                                  },
                                  _text:function(d){
                                    return '[data-bz'+d._item+']'
                                  },
                                  _dataRepeat:function(){
                                    return ["","*=field","*=module","*=enter","*=detail","*=add","*=edit","*=delete","*=skip"]
                                  }
                                }
                              ],
                              _dataModel:"_data._item.filter"
                            },
                            {
                              _if:function(d){
                                return !d._item.bz
                              },
                              _tag:"input",
                              _attr:{
                                style:"width:100%;height:20px;border:0;padding:0 3px;margin:0;border-bottom:1px solid #CCC;",
                                value:"_data._item.filter",
                              },
                              _jqext:{
                                change:function(){
                                  curUser._curProject.setting.elementFilters[this._data._idx].filter=this.value
                                  setTimeout("_rootWin._IDE._innerWin._storePersonData()",500)
                                }
                              }
                            }
                          ]
                        },
                        {
                          _tag:"td",
                          _attr:{
                            style:"padding:0;vertical-align: middle;width:0;"
                          },
                          _items:[
                            {
                              _tag:"button",
                              _attr:{
                                "class":"bz-btn-tb-icon bz-cross",
                                style:"height:20px;width:20px;background-size: 12px !important;border:0;"
                              },
                              _jqext:{
                                click:function(){
                                  curUser._curProject.setting.elementFilters.splice(this._data._idx,1)
                                  setTimeout(function(){
                                    _IDE._innerWin._data._tools._showElementFilterSetting=0
                                    setTimeout(function(){
                                      _IDE._innerWin._data._tools._showElementFilterSetting=1
                                      setTimeout("_rootWin._IDE._innerWin._storePersonData()",500)
                                    },10)
                                  },10)
                                }
                              }
                            }
                          ]
                        }
                      ],
                      _dataRepeat:"curUser._curProject.setting.elementFilters"
                    }
                  ]
                }
              ]
            },
            {
              _tag:"div",
              _attr:{
                style:"padding:5px 0;text-align:right;width:100%;"
              },
              _items:[
                {
                  _if:function(){
                    return _aiFlagHandler._data.tmpFlagScript||_aiFlagHandler._loadFlagScript()
                  },
                  _tag:"a",
                  _attr:{
                    class:"bz-assign-script",
                    style:"padding:5px;cursor:pointer;color:#00F !important;float:left;margin-top: -5px;"
                  },
                  _text:function(d){
                    return _bzMessage._aiDefinition._setTmpFlag
                  },
                  _jqext:{
                    click:function(){
                      _rootWin._aiFlagHandler._assignFlagByScript(2)
                    }
                  }
                },
                {
                  _tag:"a",
                  _attr:{
                    class:"bz-do-dark",
                    style:function(){
                      let c="cursor:pointer;color:#00F !important;margin-top:-7px;margin-left:5px;float:left;padding:2px;background-color:"

                      if(_IDE._innerWin._data._tools._inDark){
                        c+="#CCC;border:2px inset;"
                      }else{
                        c+="transparent;border:2px inset transparent;"
                      }
                      return c
                    }
                  },
                  _text:function(){
                    return _bzMessage._innerWin._darkModel
                  },
                  _jqext:{
                    click:function(){
                      _rootWin._IDE._innerWin._doDark()
                    }
                  }
                },
                {
                  _tag:"a",
                  _attr:{
                    "class":"bz-do-filter",
                    style:"margin-right:10px;cursor:pointer;color:#00F !important;"
                  },
                  _text:function(){
                    return _bzMessage._tools._showFilterElement
                  },
                  _jqext:{
                    click:function(){
                      _rootWin._IDE._innerWin._doFilterElement()
                    }
                  }
                },
                {
                  _tag:"a",
                  _attr:{
                    "class":"bz-remove-filter",
                    style:"cursor:pointer;margin-right:10px;",
                  },
                  _text:function(){
                    return _bzMessage._tools._removeFilterElement
                  },
                  _jqext:{
                    click:function(){
                      _rootWin._IDE._innerWin._removeFilterElement()
                    }
                  }
                }
              ]
            }
          ]
        },
      ]
    }
  ]
};var _ideActionData={
  _typeList:["validate","trigger","extract","js","plug","comment","refresh","group","visit","fillform"],
  _keys:[
    "_validation",
    "_triggerEvent",
    "_extractData",
    "_script",
    "_ref",
    "_comment",
    "_refresh",
    "_group",
    "_visit",
    "_fillForm",
    "_load"
  ],
  _type:{
    _validation:0,
    _triggerEvent:1,
    _extractData:2,
    _script:3,
    _ref:4,
    _comment:5,
    _refresh:6,
    _group:7,
    _visit:8,
    _fillForm:9,
    _load:"a"
  },
  _method:{
    _html:0,
    _script:1,
    _data:2
  },
  _functions:function(){
    return {
      _loadPage:{_code:"var newLink=\"{0}\";\nBZ.TW.location.href=newLink;\n",_parameters:["URL"]},
      _browserBack:{_code:"BZ.TW.history.back();\n"},
      _browserForward:{_code:"BZ.TW.history.forward();\n"},
      _scrollTop:{_code:"$element=$element||BZ.TW.document.documentElement;\n$element.scrollTop=0;\n"},
      _scrollBottom:{_code:"$element=$element||BZ.TW.document.documentElement;\n$element.scrollTop=$element.scrollHeight;\n"},
      _scrollPageDown:{_code:"$element=$element||BZ.TW.document.documentElement;\n$element.scrollBy($element.clientWidth,$element.clientHeight);"},
      _scrollPageUp:{_code:"$element=$element||BZ.TW.document.documentElement;\n$element.scrollBy(-$element.clientWidth,-$element.clientHeight);"},
      _retrieveUrl:{_code:"$test.curUrl=BZ.TW.location.href;"},
      _gotoFlag:{_code:"$util.gotoFlag()"},
      // _takeScreenshot:{_code:"$util.takeScreenshot()"},
      _asynFun:{_code:"(function(){\n  return function(callFun){\n    setTimeout(()=>{\n      console.log('ok');\n      /"+"/"+_bzMessage._task._callAtEnd+"\n      callFun();\n    },5000)\n  }\n})()"},
      _stdApiResponseScript:{_code:""}
    }
  },
  _failedReaction:{
    _default:0,
    _quick:1,
    _retry:2
  },
  _dataStatus:{
    _notReady:0,
    _warning:1,
    _ok:2
  },
  _dataStructure:{
    _validation:["monitorUrl","noLightAction","loopData","skipActionElement","failElement","cameraMd5","runInIDE","qpath","inGroup","min","max","method","element","errOnHidden","css","failedReaction","content","compareMark","expection","md5","refOfSuccess","successParameter","refOfFailed","failedParameter","refOfError","errorParameter","api","script"],
    _triggerEvent:["disableAISet","monitorUrl","noLightAction","withSubmit","withEntry","offset","loopData","$label","$header","customize","token","tokenHost","requests","apiReplaceEvent","skipActionElement","failElement","cameraMd5","qpath","inGroup","min","max","element","errOnHidden","css","failedReaction","event","expection","md5","refOfSuccess","successParameter","refOfError","errorParameter","refOfFailed","failedParameter"],
    _extractData:["monitorUrl","noLightAction","loopData","skipActionElement","failElement","cameraMd5","qpath","inGroup","min","max","method","element","errOnHidden","mutipleElement","css","failedReaction","content","refOfSuccess","successParameter","refOfError","errorParameter","refOfFailed","failedParameter","api","script","downloadAsFile"],
    _script:["monitorUrl","noLightAction","loopData","failElement","cameraMd5","runInIDE","qpath","inGroup","min","max","element","errOnHidden","mutipleElement","css","failedReaction","script","refOfSuccess","successParameter","refOfFailed","failedParameter","refOfError","errorParameter"],
    _ref:["monitorUrl","postToRemoteData","remoteResponseData","asyncRemote","remoteExe","remoteScope","specifyAppRole","loopData","stepKey","inGroup","min","max","refOfSuccess","refOfFailed","refOfError","successParameter","reTry"],
    _comment:["monitorUrl","failElement","cameraMd5","qpath","inGroup","min","max","element","errOnHidden","css","showJudge","refOfSuccess","successParameter","refOfFailed","failedParameter","img","md5"],
    _refresh:["monitorUrl","loopData","resultscript","refreshData","refreshType","inGroup","min","max","clearCookie","clearLocalStorage","loadURL","refOfSuccess","successParameter","refOfFailed","failedParameter","refOfError","errorParameter"],
    _group:["monitorUrl","speed","max","min","asOneAction","refOfSuccess","refOfFailed","refOfError","loopData","groupType","elseGroup","loopGroup"/*,"singleAction","items"*/],
    _visit:["monitorUrl","failElement","cameraMd5","qpath","inGroup","panel","min","max","panelToggle","toggle","target","script","plugin"],
    _fillForm:["monitorUrl","failElement","cameraMd5","qpath","inGroup","min","max","data","element","autoNext","nextBtn","submitBtn","autoSubmit","handleMsg","lineSuccess","lineError","finalSuccess","finalError","refOfSuccess","successParameter","refOfError","errorParameter"],
    _load:["monitorUrl","requests","inGroup","rampUp","repeatTimes","exeMethod","period"]
  }
};
(function(){
  //what is autoDelay? wait all request to complete, even the next action element is ready on page
  for(let k in _ideActionData._dataStructure){
    _ideActionData._dataStructure[k].push("key","autoDelay","resultscript","disable","description","type","ai","todo","note","flag","successGoto","failedGoto","errorGoto")
  }
  _ideActionData._typeKeys=_Util._swapKeyValue(_ideActionData._type);
})()

var _ideActionManagement={
  _getScreenshotPathByName:function(n){
    return SERVER_HOST+"/screenshot/"+pId+"/"+n+".jpg"
  },
  _getSearchData:function(a){
    let w=a.description||""
    w+=" "+(_bzMessage._action._type[_ideActionData._keys[a.type]]||"")
    w+=" "+(a.element||[]).join(" ")
    w+=" "+(a.skipActionElement||[]).join(" ")
    w+=" "+(a.script||"")
    w+=" "+(a.runInIDE?"ide runInIDE ":"")
    w+=" "+(a.loopData?"preScript":"")
    w+=" "+(a.resultscript?"resultScript":"")

    if(a.event){
      w+=" "+a.event.value
      if(a.event.download){
        w+=" "+_bzMessage._method._download
      }
      w+=" "+(a.event.responseElement||[]).join(" ")
      w+=" "+(a.event.type||"")
      w+=" "+(a.event.action||"")
      if(a.event._repElementOptions){
        w+=" "+_bzMessage._action._repElementOptions[a.event._repElementOptions]
      }
    }else if(a.content){
      w+=" "+(a.content.expection||"")
    }
    if(a.failedReaction==1){
      w+=" "+_bzMessage._action._failedReactionQuick
    }
    if(a.noLightAction){
      w+=" "+_bzMessage._action._noLightAction
    }
    if(a.errOnHidden){
      w+=" "+_bzMessage._action._markErrorOnHidden
    }
    if(a.resultscript){
      w+=" "+a.resultscript
    }
    if(a.requests){
      a.requests.forEach(r=>{
        w+=" "+r.url+" "+r.method+" "+(r.query||"").toString()+" "+(r.body||"").toString
      })
    }
    w+=" "+(a.refOfSuccess&&a.refOfSuccess.match(/m[0-9]/)?"success call ref":"")
    w+=" "+(a.refOfSuccess||"")
    w+=" "+(a.successParameter||"")
    w+=" "+(a.refOfFailed&&a.refOfFailed.match(/m[0-9]/)?"failed call ref":"")
    w+=" "+(a.refOfFailed||"")
    w+=" "+(a.failedParameter||"")
    w+=" "+(a.refOfError&&a.refOfError.match(/m[0-9]/)?"error call ref":"")

    w+=" "+(a.refOfError||"")
    w+=" "+(a.errorParameter||"")
    return w
  },
  _getTimerDesc:function(a){
    a=a||_IDE._data._curAction,s=""
    if(a.min||a.max){
      if(a.min){
        s=_bzMessage._action._delay+": "+a.min+"ms\n"
      }
      if(a.max){
        s+=_bzMessage._api._timeout+": "+a.max+"ms"
      }
      return s.trim()
    }else{
      return _bzMessage._action._setTimer
    }
  },
  _setActionItemForm:function(k,_form,_force,h){
    if(!BZ._data._uiSwitch[k]||_force){
      $(document.body).click()
      setTimeout(()=>{
        let os=$(".bz-action-list").children().toArray()
        os.find(o=>{
          if(o._data._item==_IDE._data._curAction){
            BZ._setTmpUISwitch(k,[o,_form.substring(1)])
            setTimeout(()=>{
              let f=$(_form)[0]
              o=o.getBoundingClientRect()
              let v=o.bottom-20
              if(window.innerHeight-v<h){
                v=o.top-h
              }

              $(f).css({
                top:v+"px",
                display:"block"
              }).find("input:eq(0)").focus()
            },100)
            return 1
          }
        })
      },10)
    }
  },
  _getFlagDesc:function(){
    let f=_IDE._data._curAction.flag
    if(f){
      return _bzMessage._common._flag+": "+f
    }else{
      return _bzMessage._action._setFlag
    }
  },
  _showRefMenu:function(d,e){
    d=d._data._item
    
    if(d.type==4&&!d.refOfSuccess){
      setTimeout(()=>{
        $(".bz-select-input").focus();
        $(".bz-select-input").focus()
      },100)
    }
    if(_IDE._data._curAction==d){
      e.stopPropagation()
    }
  },
  _setSubMenuPos:function(k){
    let c=$(".bz-action-menu")[0].getBoundingClientRect()
    c=`margin-left:${c.left+c.width*1.5}px;`
    return c+`top:${$(".pop-menu-item ."+k)[0].getBoundingClientRect().top-13}px`

  },
  _isHideElementTdInList:function(d){
    return ('467'.includes(d.type)||("02".includes(d.type)&&d.method==2)||((d.type==3||(!d.type&&d.method==1))&&(!d.element||!d.element.length)))
  },
  //a: action
  //k: refOfSuccess/refOfFailed/refOfError
  //t: test case key,
  //w: way, .,..,...,....
  //r: result: s,w,f,e
  //l: loop number
  _setCondition:function(a,k,t,w,r,l){
    let v=a[k]||""
    let tt=t===undefined?v.match(_IDE._testKeyRegex)||v.match(_IDE._insertJSRegex)||"":"",
        ww=!w?v.match(/(^|\/)(\.+)($|\/)/):"",
        rr=!r?v.match(/(^|\/)(c|s|f|e|w)($|\/)/):"",
        ll=l===undefined?v.match(/(^|\/)([0-9]+)($|\/)/):""
    if(tt&&tt.constructor==Array){
      tt=tt[0]
    }
    ww&&(ww=ww[2])
    rr&&(rr=rr[2])
    ll&&(ll=ll[2])
    w=w||ww||""
    r=r||rr||"";
    l=l||parseInt(ll)||""
    switch(k){
      case "refOfSuccess":
        if(w=="."){
          w=""
        }else{
          delete a.successGoto
        }
        if(r=="s"){
          r=""
        }
        break
      case "refOfFailed":
        if(w!="."){
          delete a.failedGoto
        }
        if(r=="f"){
          r=""
        }
        break
      case "refOfError":
        if(w==".."){
          w=""
        }
        if(w!="."){
          delete a.errorGoto
        }
        if(r=="e"){
          r=""
        }
    }
    t=t||tt||"";
    t&&(t+="/")
    w&&(w+="/")
    r&&(r+="/")
    l&&(l+="/")
    a[k]=t+w+r+l
    _ideActionManagement._refreshShowConditionInList()
  },
  _getTestFromRef:function(v){
    return (v||"").replace(/([\/]|^)[sfew]($|[\/])/g,"/")
            .replace(/([\/]|^)[\.]+($|[\/])/g,"/")
            .replace(/([\/]|^)[0-9]+($|[\/])/g,"/")
            .replace(/[\/]+/,"")
  },
  _refreshShowConditionInList:function(){
    if(BZ._data._uiSwitch._showActionParameter){
      BZ._data._uiSwitch._showActionParameter=0
      setTimeout(function(){
        BZ._data._uiSwitch._showActionParameter=1
      },150)
    }
  },
  _batchUpdateRef:function(_curAction,t,m,_value,_hideProcess,_fun){
    let _oldValue=((_curAction.refOfSuccess||"").match(_IDE._testKeyRegex)||[])[0],
        _txt=_curAction.description
    let _valTest,_refTest;
    _curAction.refOfSuccess=_curAction.refOfSuccess||""
    _value=_value||""
    if(_oldValue==_value){
      return
    }
    if(_oldValue){
      _curAction.refOfSuccess=_curAction.refOfSuccess.replace(_oldValue,_value)
    }else{
      _curAction.refOfSuccess+="/"+_value+"/"
    }
    _curAction.refOfSuccess=_curAction.refOfSuccess.replace(/[\/]+/g,"/").replace(/^[\/]$/,"")
    _ideTestManagement._save(t,m)
//_ideActionManagement._getRefDesc(_curAction,"refOfSuccess"),
    if(_txt&&_value){
      _valTest=_ideObjHandler._getDataByPath(_value)
      if(_valTest&&_oldValue){
        _refTest=_ideObjHandler._getDataByPath(_oldValue)
      }
    }else{
      return
    }
    $("._updateTestOneByOne").find("btn-cancel").click()
    BZ._data._uiSwitch._showBatchUpdateTests=[]

    _Util._confirmMessage({
      _tag:"div",
      _attr:{"class":"_updateTestOneByOne"},
      _items:[
        {
          _if:"!BZ._data._uiSwitch._showBatchUpdateTests.length",
          _tag:"div",
          _text:function(){
            if(_refTest){
              return _Util._formatMessage(
                _bzMessage._test._batchUpdateTest,
                [_txt,_refTest._data.name,_valTest._data.name]
              )
            }else{
              return _Util._formatMessage(
                _bzMessage._test._batchNewTest,
                [_txt,_valTest._data.name]
              )
            }
          }
        },
        {
          _if:"BZ._data._uiSwitch._showBatchUpdateTests.length",
          _tag:"div",
          _items:[
            {
              _tag:"div",
              _text:function(){
                if(BZ._data._uiSwitch._showBatchUpdateTests.length){
                  return _bzMessage._system._info._updateList
                }else{
                  return _bzMessage._system._info._updating
                }
              }
            },
            {
              _tag:"div",
              _items:[
                {
                  _tag:"a",
                  _attr:{"class":"bz-nowrap-item"},
                  _jqext:{
                    click:function(){
                      let d=this._data._item
                      BZ._setHash(d.m.code+"."+d.t.code)
                    }
                  },
                  _text:function(d){
                    let i=d._idx+1
                    d=d._item
                    return i+". ["+d.m.code+"."+d.t.code+"] "+ BZ._groupWords([d.m.name,d.t.name])
                  }
                }
              ],
              _dataRepeat:"BZ._data._uiSwitch._showBatchUpdateTests"
            }
          ]
        }
      ]
    },[{
      _title:_bzMessage._method._yes,
      _class:"btn-primary bz-ok",
      _click:function(c){
        if(_hideProcess){
          c._ctrl._close()
        }
        _ideVersionManagement._loadAllData(function(){
          _ideVersionManagement._updateTestOneByOne(function(t,m,_fun){
            if(t.type=="scenario"){
              let _update=0
              if(!_oldValue){
                t.actions.forEach(a=>{
                  if(a.type==4&&!a.refOfSuccess){
                    if(a.description==_txt){
                      a.refOfSuccess=_value
                      _update=1
                    }
                  }
                })
              }else{
                t.actions.forEach(a=>{
                  if(a.type==4&&a.refOfSuccess){
                    let mm=a.refOfSuccess.match(_IDE._testKeyRegex)||[]
                    if(mm[0]==_oldValue&&a.description==_txt){
                      a.refOfSuccess=a.refOfSuccess.replace(_oldValue,_value)
                      _update=1
                    }
                  }
                })
              }
              if(_update){
                BZ._data._uiSwitch._showBatchUpdateTests.push({t:t,m:m})
                _Util._resizeModelWindow()
                return _ideTestManagement._save(t,m,function(){
                  _fun&&_fun()
                })
              }
            }
            _fun&&_fun()
          },function(){
            if(!BZ._data._uiSwitch._showBatchUpdateTests.length){
              c._ctrl._close()
            }
          })
        })

        $(".bz-ok").remove()
        $(".btn-cancel").text(_bzMessage._method._close)
      }
    }])
  },
  _formatRefreshData:function(v){
    return (v||"").split(",").map(a=>{return a.trim()}).join(",")
  },
  _deleteScreenshot:function(){
    let a=_IDE._data._curAction
    if(a){
      a.cameraMd5=a._camera=0
    }
  },
  _isAdvAction:function(a){
    if(a.event){
      a=a.event
      return a.element||a.repElementMethod||a.action!="click"
    }
  },
  _setStepKey:function(a,t){
    var ga=_ideActionGroup._findGroupAction(a,t)
    var gi=t.actions.indexOf(ga)
    var i=t.actions.indexOf(a)
    if(i==gi+1){
      a.stepKey=ga.groupType;
    }else{
      a.stepKey="and"
    }
  },
  _groupItemsToActions:function(t,g){
    var i=t.actions.indexOf(g)+1
    while(g.items.length){
      t.actions.splice(i,0,g.items.splice(0,1)[0])
    }
    g.items=0
    delete g.items
  },
  _actionsToGroupItems:function(t,g){
    var i=t.actions.indexOf(g)+1
    g.items=[]
    for(;i<t.actions.length;i++){
      var a=t.actions[i];
      if(a.inGroup&&a.type!=7){
        t.actions.splice(i--,1)
        g.items.push(a)
      }
    }
  },
  _getStdAPIScript:function(m,_type){
    m=_aiGeneratorDataHandler._getModuleObject(m);
    let fk=_aiGeneratorDataHandler._getBestKeyFieldName(m)||"",c;
    if(fk){
      fk=', \"'+fk+'"'
    }
    m=m._data
    m=m.alias||m.code
    if(_type=="POST"||_type=="GET"){
      c=`      $aiAPI.addData(v,"${m}"${fk});\n`
    }else if(_type=="DELETE"){
      c=`    $aiAPI.deleteData($parameter,"${m}"${fk});\n`
    }else{
      c=`      $aiAPI.updateData(v,"${m}"${fk});\n`
    }
    if(_type=="DELETE"){
      return "(function(){\n"
            +"  let success = $result.status && $result.status < 400;\n"
            +"  if(success){\n"
            +c
            +"  }\n"
            +"  return success;\n"
            +"})()";
    }else{
      return "(function(){\n"
            +"  let success = $result.status && $result.status < 400;\n"
            +"  if(success){\n"
            +"    let v = $result.responseText;\n"
            +"    try{\n"
            +"      v=JSON.parse(v);\n"
            +c
            +"    }catch(e){}\n"
            +"  }\n"
            +"  return success;\n"
            +"})()";
    }
  },
  _getCurRefKey:function(t){
    if(_IDE._data._curAction.type==4){
      t="success"
    }
    if(t){
      t=t.toLowerCase()+'Parameter'
    }else{
      t="parameter"
    }
    return t
  },
  _getIframeIdxByElementPath:function(e){
    if(e){
      e=(e[0]||"").match(/findIframe\(([0-9])\)/)||[]
      return e[1]||0
    }else{
      return 0
    }
  },
  _showAPISetting:function(_curParameterKey){
    let s=BZ._data._uiSwitch,v,w;
    setTimeout(()=>{
      let d=s._apiRequest=_IDE._data._curAction.requests[_curParameterKey]
      if(!d){
        return
      }
      _testTabHandler._data._curCfgTab="details"
      
      s._apiTab=s._apiTab||"_try"

      s._apiAuth=_aiAuthHandler._data[_IDE._data._curTest._data.hostId]
      if(s._apiAuth.token&&s._apiAuth.token.constructor==String){
        s._tokenTest=_ideObjHandler._getDataByPath(s._apiAuth.module,s._apiAuth.token)
      }else if(s._apiAuth.token){
        s._tokenTest=s._apiAuth.token
      }
      
      v=w=d.data||""
      if(v&&v.match&&!_Util._hasCode(v)&&(!d.contentType||d.contentType.toLowerCase().includes("json"))){
        v=_Util._parameterToObj(v)
        v=_Util._strToJson(v)
        if(v.constructor==Object){
          v=JSON.stringify(v,0,2)
        }
      }
      // d._tmpParameter=v
      d.data=v

      var h=_Util._parseJSONWithRefDataToObj(d.headers)
      
      if(d.autoToken){
        var ks=_aiAuthHandler._getHostTokenNames(_IDE._data._curTest._data.hostId);
        if(ks){
          let token=_aiAuthHandler._data[d.host].tokenValue||{}

          ks.forEach(k=>{
            let tk=token[k]||BZ._bzTokenData
            if(!h.find(x=>{
              if(x._key==k){
                x._value=JSON.stringify(tk)
                return 1
              }
            })){
              h.push({
                _key:k,
                _value:JSON.stringify(tk)
              })
            }
          })
        }
      }
      h.find((x,i)=>{
        if(x._key=="Content-Type"){
          _Util._eval("d.contentType="+x._value,{d:d})
          // h.splice(i,1)
          return 1
        }
      })

      d.headers=_Util._refDataToJSON(h)
    },10)
  },
  _getWaitIcon:function(v,b){
    if(!v){
      return ""
    }
    var k = v.min?"bz-timer bz-red":v.max?"bz-timer bz-blue":"bz-timer bz-grey";
    var _curAdvanced=_ideTestManagement._getSysSetting()._curAdvanced;
    var _pTimer=parseInt(_curAdvanced.performanceReminder)
    
    if(parseInt(v.min||0)>parseInt(v.max||0)){
      v=v.min
    }else{
      v=v.max
    }
    v=v||0
    if(v>_pTimer+10000){
      k+=" bz-red-data-point"+(b||"")
    }else if(v-1000>_pTimer){
      k+=" bz-blue-data-point"+(b||"")
    }
    return k
  },
  _disbandGroup:function(a){
    if(!a||a.type!=7){
      return
    }
    let as=_IDE._data._curTest._data.actions
    let _idx=as.indexOf(a)
    for(let i=_idx+1;i<as.length;i++){
      if(as[i].inGroup&&as[i].type!=7){
        as[i].inGroup=0
        delete as[i].inGroup
      }else{
        break
      }
    }
    as.splice(_idx,1)
    _ideTestManagement._save()
  },
  _newGroup:function(vs){
    BZ._data._uiSwitch._newGroup={_validationType:1}
    _Util._confirmMessage({
      _tag:"div",
      _data:BZ._data._uiSwitch._newGroup,
      _items:[
        {
          _tag:"div",
          _attr:{
            "class":"input-group"
          },
          _items:[
            {
              _tag:"label",
              _attr:{
                "class":"input-group-addon required"
              },
              _text:"_bzMessage._common._description"
            },
            {
              _tag:"input",
              _attr:{
                "class":"form-control",
                required:1
              },
              _dataModel:"_data._name"
            }
          ],
        },
        {
          _tag:"div",
          _attr:{
            "class":"col-xs-12"
          },
          _items:[
            {
              _tag:"label",
              _attr:{
                style:"margin-left:10px;"
              },
              _items:[
                {
                  _tag:"input",
                  _attr:{
                    type:"checkbox"
                  },
                  _dataModel:"_data._asOneAction",
                  _jqext:{
                    click:function(e){
                      _Util._resizeModelWindow()
                    }
                  }
                },
                {
                  _text:"_bzMessage._com._asOneAction"
                }
              ]
            }
          ],
        },
        {
          _if:"_data._asOneAction",
          _tag:"div",
          _attr:{
            "class":"input-group"
          },
          _after:function(o,d){
            if(!d.speed){
              d.speed=100
            }
          },
          _items:[
            {
              _tag:"label",
              _attr:{
                "class":"input-group-addon"
              },
              _text:"_bzMessage._action._speed+' ('+_data.speed+'ms)'",
            },
            {
              _tag:"div",
              _attr:{
                "class":"form-control",
                style:"width:calc(100% - 14px);"
              },
              _items:[
                {
                  _tag:"input",
                  _dataModel:"_data.speed",
                  _attr:{
                    type:"range",
                    style:"padding:0;width:calc(100% - 10px);margin:5px;",
                    min:50,
                    max:1000,
                    step:50
                  }
                }
              ]
            }
          ]
        },
        {
          _tag:"div",
          _attr:{
            "class":"col-xs-12 bz-left-space-10",
            style:"_data._idx==3?'margin-bottom:15px;':''"
          },
          _items:[
            {
              _tag:"label",
              _items:[
                {
                  _tag:"input",
                  _attr:{
                    type:"radio",
                    value:"_data._idx?_data._item:''",
                    onclick:"_Util._resizeModelWindow()"
                  },
                  _dataModel:"_data._supData._type"
                },
                {
                  _html:"'<span>'+_Util._formatMessage(_bzMessage._action._asGroup,['<b>'+_data._item+'</b>'])+'</span>'"
                }
              ]
            },
            {
              _if:"_data._supData._type=='if'&&_data._item=='if'",
              _tag:"div",
              _attr:{
                style:"margin-top:10px;width:calc(100% - 10px);",
                "class":"input-group"
              },
              _items:[
                {
                  _tag:"label",
                  _attr:{
                    "class":"input-group-addon"
                  },
                  _text:"_bzMessage._action._validationType"
                },
                {
                  _tag:"select",
                  _attr:{
                    "class":"form-control"
                  },
                  _items:[
                    {
                      _if:function(){
                        return vs&&vs[0]&&vs[0].type==0
                      },
                      _tag:"option",
                      _attr:{value:"",style:"color:#999"},
                      _text:"_bzMessage._action._noInsert"
                    },
                    {
                      _tag:"option",
                      _attr:{
                        value:"_data._idx"
                      },
                      _text:"_data._item",
                      _dataRepeat:["HTML","Script"]
                    }
                  ],
                  _dataModel:"BZ._data._uiSwitch._newGroup._validationType"
                }
              ]
            },
            {
              _if:"_data._supData._type=='switch'&&_data._item=='switch'",
              _tag:"div",
              _attr:{
                style:"margin-top:10px;width:calc(100% - 10px);",
                "class":"input-group"
              },
              _items:[
                {
                  _tag:"label",
                  _attr:{
                    "class":"input-group-addon required"
                  },
                  _text:"_bzMessage._common._flag"
                },
                {
                  _tag:"input",
                  _attr:{
                    "class":"form-control",required:1
                  },
                  _focus:1,
                  _dataModel:"BZ._data._uiSwitch._newGroup._flag"
                }
              ]
            },
            {
              _if:"_data._item==_data._supData._type",
              _tag:"div",
              _attr:{
                "class":"col-xs-12 bz-note-text",
                style:"margin:10px 0 -5px 0"
              },
              _text:"_bzMessage._action._groupOptions[_data._item]"
            }
          ],
          _dataRepeat:[_bzMessage._action._general,"if","else","switch"]
        },
        {
          _tag:"br"
        },
        {
          _tag:"fieldset",
          _attr:{
            style:"border-left:0;border-right:0;border-bottom:0;padding:0 0 0 10px;"
          },
          _items:[
            {
              _tag:"legend",
              _text:"_bzMessage._action._loopOptions._title"
            },
            {
              _tag:"div",
              _attr:{
                "class":"col-xs-12"
              },
              _items:[
                {
                  _tag:"label",
                  _items:[
                    {
                      _tag:"input",
                      _attr:{
                        type:"radio",
                        value:"_data._idx?_data._item:''",
                        onclick:"_Util._resizeModelWindow()"
                      },
                      _dataModel:"_data._supData._loop"
                    },
                    {
                      _text:"_bzMessage._action._loopOptions[_data._item]"
                    }
                  ]
                },
                {
                  _if:"_data._supData._loop=='for'&&_data._item=='for'",
                  _tag:"div",
                  _attr:{
                    style:"margin-top:10px;"
                  },
                  _items:[
                    _bzJSEditor._buildJSEditor({
                      _model:"BZ._data._uiSwitch._newGroup._script",
                      _style: "height:100px;width:100%;",
                      _labelStyle:"right:0"
                    })
                  ]
                },
                {
                  _if:"_data._item==_data._supData._loop",
                  _tag:"div",
                  _attr:{
                    "class":"col-xs-12 bz-note-text",
                    style:"margin:10px 0 -5px 0"
                  },
                  _text:"_bzMessage._action._groupOptions[_data._item]"
                }
              ],
              _dataRepeat:["_noLoop","while","for"]
            }
          ]
        },
      ]
    },[
      {
        _title:_bzMessage._common._ok,
        _click:function(dlg){
          let g=BZ._data._uiSwitch._newGroup
          if(g._type=="switch"&&!g._flag){
            return alert(_Util._formatMessage(_bzMessage._system._error._requiredField,[_bzMessage._common._flag]))
          }
          
          _doIt(g)
          dlg._ctrl._close();
        }
      }
    ],_bzMessage._method._newGroup);
    function _doIt(g){
      var a={type:_ideActionData._type._group,description:g._name,flag:g._flag,asOneAction:g._asOneAction},
          as=_IDE._data._curTest._data.actions,_idx;
          
      if(a.asOneAction){
        a.speed=g.speed
      }

      if(g._type=="else"){
        a.elseGroup="on"
      }

      if(g._loop=="while"){
        a.loopGroup="on"
        a.refOfFailed=a.refOfError="./"
      }else if(g._loop=="for"){
        a.loopData=g._script
      }

      if(vs&&vs.length){
        _ideActionManagement._sortSelectItems(vs)
        _idx=as.indexOf(vs[0])
        as.splice(_idx,0,a)
        for(var i=0;i<vs.length;i++){
          var v=vs[i]
          if(v.type==7){
            as.splice(as.indexOf(v),1)
          }else{
            v.inGroup="on"
          }
        }
        _ideActionGroup._switchGroupOpen(a,1)
      }else{
        _idx=_IDE._data._curTest._data.actions.indexOf(_IDE._data._curAction)+1
        as.splice(_idx,0,a)
      }
      if(g._type=="if"&&g._validationType){
        a={type:0,method:g._validationType,refOfFailed:".../w/",refOfError:".../w/",inGroup:"on",compareMark:"==",script:""}
        if(g._validationType==0){
          a.content={type:"innerText"}
        }
        as.splice(_idx+1,0,a)
      }
      _ideTestManagement._save()
    }
  },
  _newGroupTest:function(vs){
    let _inGroup=vs[0].inGroup
    vs.forEach(v=>{delete v.inGroup})
    _ideActionManagement._sortSelectItems(vs);
    BZ._data._uiSwitch._newGroupTest={
      _module:_IDE._data._curModule._data.code
    }
    _Util._confirmMessage({
      _tag:"div",
      _items:[
        {
          _tag:"div",
          _attr:{"class":"input-group"},
          _items:[
            {
              _tag:"label",
              _attr:{"class":"input-group-addon"},
              _text:"_bzMessage._common._module"
            },
            {
              _tag:"select",
              _attr:{"class":"form-control"},
              _dataModel:"BZ._data._uiSwitch._newGroupTest._module",
              _items:[
                {
                  _tag:"option",
                  _attr:{value:"_data._item._code"},
                  _text:"_data._item._name",
                  _dataRepeat:"_ideObjHandler._treeList"
                }
              ]
            }
          ]
        },
        {
          _tag:"div",
          _attr:{"class":"input-group"},
          _items:[
            {
              _tag:"label",
              _attr:{"class":"input-group-addon"},
              _text:"_bzMessage._common._name"
            },
            {
              _tag:"input",
              _attr:{"class":"form-control"},
              _dataModel:"BZ._data._uiSwitch._newGroupTest._name"
            }
          ]
        }
      ]
    },[
      {
        _title:_bzMessage._common._ok,
        _click:function(dlg){
          let m=BZ._data._uiSwitch._newGroupTest
          if(!m._name){
            return alert(_Util._formatMessage(_bzMessage._system._error._requiredField,[_bzMessage._common._name]))
          }
          _doIt(m._module,m._name)
          dlg._ctrl._close();
        }
      }
    ],_bzMessage._method._newGroupTest,400);
    function _doIt(m,n){
      let _hash=location.hash,t=_IDE._data._curTest
      m=_ideObjHandler._getDataByPath(m)._data
      _ideTestManagement._save({
        name:n,
        type:"unit",
        hostId:m.defaultHostId,
        synActionDesc:"on",
        actions:vs,
        enterPoint:{type:"followCheck"}
      },m,function(v){
        BZ._setHash(_hash,undefined,undefined,function(){
          if(t==_IDE._data._curTest){
            var a=_CtrlDriver._buildProxy({type:_ideActionData._type._ref,inGroup:_inGroup});
            var as=t._data.actions;
            var i=as.indexOf(vs[0])
            vs.forEach(a=>{
              as.splice(as.indexOf(a),1)
            })
            if(i>=as.length){
              i=as.length-1
            }
            a.refOfSuccess= m.code+"."+v.code+"/"
            as.splice(i,0,a)
            _ideTestManagement._save()
            return 1
          }
        })
      })
    }
  },
  _sortSelectItems:function(vs){
    var as=_IDE._data._curTest._data.actions;
    vs.sort(function(a,b){
      return as.indexOf(a)-as.indexOf(b)
    })
  },
  _isGroupable:function(vs,_group){
    var as=_IDE._data._curTest._data.actions;
    _ideActionManagement._sortSelectItems(vs)
    for(var i=1;i<vs.length;i++){
      if(as.indexOf(vs[i])-as.indexOf(vs[i-1])!=1){
        return 
      }
    }
    return vs.length>1 || (_group && vs.length)
  },
  _setCurAction:function(a){
    BZ._data._uiSwitch._apiRequest=0
    if(!BZ._isPlaying()){
      let o=_IDE._data._curAction
      if(window._testTabHandler&&o&&a&&a.type==3&&o.type!=3){
        _testTabHandler._data._keepActionTab=a||0
        _IDE._data._curAction=0
        return setTimeout(()=>{
          _testTabHandler._data._keepActionTab=0
          _doIt()
        })
      }
    }
    _doIt()
    function _doIt(){
      _IDE._data._curAction=a||null;

      if(window._extensionComm && a){
        BZ._data._uiSwitch._selectedItems=[a];
      }
      if(bzTwComm._isIDE()){
        _extensionComm._setCurAction(a||0);
      }else if(a && a.element){
        if(a.type==_ideActionData._type._comment && !BZ._isPlaying()){
          _domActionTask._doComment(a);
        }
      }
    }
  },
  //mouse click on row of list or action card
  _selectAction:function(m,t,a,event){
    var ss=BZ._data._uiSwitch._selectedItems,_data=a;
    var as=t._data.actions;
    if(event.ctrlKey || event.metaKey || (event.shiftKey && !ss.length)){
      var i=ss.indexOf(a);
      if(i<0){
        ss.push(a);
        BZ._data._uiSwitch._lastItem=a
      }else{
        ss.splice(i,1);
      }
    }else if(event.shiftKey){
      var k=BZ._data._uiSwitch._lastItem || _IDE._data._curAction;
      var ki=as.indexOf(k);
      var ci=as.indexOf(a)
      BZ._data._uiSwitch._lastItem=a
      for(var i=ki;i!=ci;ci>ki?i++:i--){
        if(!ss.includes(as[i])){
          ss.push(as[i])
        }
      }
      if(!ss.includes(as[ci])){
        ss.push(as[ci])
      }
    }else{
      BZ._data._uiSwitch._selectedItems=ss=[a];
      BZ._data._uiSwitch._lastItem=0
      if(a&&a.type==7){
        _IDE._data._curAction=a;
      }
    }
    if(ss.includes(a)){
      for(var i=0;i<ss.length;i++){
        if(ss[i].type==7){
          for(var j=as.indexOf(ss[i])+1;j<as.length;j++){
            if(as[j].inGroup && as[j].type!=7){
              if(!ss.includes(as[j])){
                ss.push(as[j])
              }
            }else{
              break
            }
          }
        }
      }
    }else if(a.type==7){
      for(var j=as.indexOf(a)+1;j<as.length;j++){
        if(as[j].inGroup && as[i].type!=7 && ss.includes(as[j])){
          ss.splice(ss.indexOf(a),1)
        }else{
          break
        }
      }
    }else if(a.inGroup){
      for(var j=as.indexOf(a)-1;j>=0;j--){
        if(as[j].type==7 && ss.includes(as[j])){
          ss.splice(ss.indexOf(as[j]),1)
        }
      }
    }
    if(ss.length==1){
      if(m){
        BZ._setHash(_ideLocation._getPath(0,m._data,t._data,ss[0]));
      }else{
        _IDE._data._curAction=a
      }
    }else if(a.type!=7){
      _IDE._data._curAction=null;
    }

    if(a){
      if(a.type==4&&!_Util._hasCode(a.successParameter)){
        BZ._data._uiSwitch._curDefParameterFormatTab="_json"
      }
    }
  },
  _getIcon:function(o){
    if(o.apiReplaceEvent&&o.requests){
      return "bz-icon bz-api"
    }
    var v='bz-icon'
    if(o.type=="a"){
      v+=" bz-batch-api"
    }else if(o.type==4&&_ideObjHandler._getDataByPath(o.refOfSuccess)==_IDE._data._curTest){
      v+=' bz-plug-self'
    }else{
      v+=' bz-'+_ideActionData._typeList[o.type];
    }
    let c=_ideActionManagement._getComDataFromElement(o)
    if(c){
      v="bz-com"
    }else if(o.type==_ideActionData._type._triggerEvent){
      if(o.event.type=="mouse"){
        if(o.event.download){
          v="bz-download"
        }else{
          v="bz-mouse"
        }
      }else{
        v="bz-keyboard"
      }
      v="bz-icon "+v
    }else if("02".includes(o.type)){
      if(o.method==1){
        v+="-js"
      }else if(o.method==2){
        v+="-api"
      }
    }
    return v;
  },
  _setBreakpoint:function(a,t){
    var ds=BZ._data._uiSwitch._breakPoints.map(x=>x),
        c=_IDE._data._curModule._data.code+"."+t.code+"."+t.actions.indexOf(a)
    var _idx=ds.indexOf(c)
    if(_idx>=0){
      ds.splice(_idx,1);
    }else{
      ds.push(c);
    }
    BZ._data._uiSwitch._breakPoints=ds
    BZ._userHabit.breakPoints=ds
    BZ._storeUserHabit()
  },
  _switchContentType:function(o){
    _IDE._data._curAction.expection=''
    setTimeout(function(){
      _ideActionManagement._quickUpdateExpection();
    },1);    
  },
  _refreshDetail:function(){
    var v=_IDE._data._curAction;
    if(v){
      _IDE._data._curAction=0;
      setTimeout(function(){
        _IDE._data._curAction=v;
      },100);
    }
  },
  _detailsPos:{
    _left:"390px",
    _top:"270px"
  },
  _getIdxByPath:function(_path){
    _path= _path.split("/");
    _path.pop();
    return _path.pop();
  },
  _setActionHash:function(a){
    BZ._setHash(_IDE._data._curTest._data.actions.indexOf(a||_IDE._data._curAction));
  },
  _removeFromGroup:function(as){
    as.forEach(function(a){
      a.inGroup=""
      let ks=["refOfSuccess","refOfFailed","refOfError"]
      ks.forEach(k=>{
        let v=a[k]
        if(v&&v.match(/(^|\/)\.\.\.(\/|$)/)){
          v=v.replace("...","").replace("/"+"/","/").replace(/^\/$/,"")
          a[k]=v
        }
      })
    })
  },
  _deleteItems:function(_list,_actions){
    let t=_IDE._data._curTest
    _list=_list||BZ._data._uiSwitch._selectedItems;
    _actions=_actions||t._data.actions;
    var _newList=[],_curIdx;
    _list.forEach(function(o){
      if(o.type==7){
        var ss=_ideActionGroup._getAllGroupActions(0,o,_actions)
        _ideActionManagement._removeFromGroup(ss)
      }
    })
    for(var i=_actions.length-1;i>=0;i--){
      var a=_actions[i];
      if(t){
        if(!_list.includes(a)){
          _newList.unshift(a);
        }else if(a.ai){
          a.disable=true
          _newList.unshift(a);
          _curIdx=i;
        }else{
          _curIdx=i;
        }
      }else{
        if(_list.indexOf(a)>=0){
          if(a.ai){
            a.disable=true
          }else{
            _actions.splice(i,1);
          }
        }
      }
    }
    
    if(t){
      t._data.actions=_newList;
      if(t._data._curMethod){
        t._data[t._data._curMethod]=t._data.actions
      }
      if(_newList.length<=_curIdx){
        _curIdx=_newList.length-1;
      }
      if(_curIdx>=0){
        _curIdx=t._data.actions[_curIdx];
        BZ._data._uiSwitch._selectedItems=[_curIdx];
        BZ._setHash(_curIdx);
      }else{
        BZ._setHash(t);
      }
      t._result=[];
    }
    
    // _guiTestHandler._drawGUI()
    _ideTestManagement._save()
  },
  _getNewValidationAction:function(_type){
    var d={
      compareMark: "==",
      type:_type?_type:_ideActionData._type._validation,
      method:_ideActionData._method._html
    };
    this._buildDefaultData(d);
    return d;
  },
  _buildDefaultData:function(d,_type){
    var t=_ideActionData._type;
    if(!_type){
      _type=d.type;
    }
    if (t._validation==_type || t._extractData==_type){
      if(!d.method){
        d.method=_ideActionData._method._html;
      }
      if(t._validation==_type && d.method==_ideActionData._method._html && (!d.content || (d.content.type=="JSON" || !d.content.type))){
        d.content={type:"innerText"};
        d.compareMark= "==";
        delete d.content.filter;
      }else if(d.method==_ideActionData._method._data && (!d.api || !d.content || (d.content.type && d.content.type!="JSON"))){
        d.api={httpMethod:"GET",httpURL:_ideTestManagement._getCurDefaultRoot(undefined,1),autoToken:"on"};
        d.content={type:""};
      }
      if(t._extractData==_type&&d.method==_ideActionData._method._data){
        d.script="$test.tmpValue=$result.data"
      }
      
    }else if (_type==t._triggerEvent) {
      if(!d.event){
        d.event={
          type:"mouse",
          action:"click",
          button:1,
          x:0,
          y:0
        }
      }else if(d.event.type=="mouse"){
        d.event.action="click"
        d.event.button=1;
        if(!d.x){
          d.x=0;
        }
        if(!d.y){
          d.y=0;
        }
      }else if(d.event.type=="key"){
        d.event.action="group"
      }
    }else if(_type==t._comment){
      d.showJudge=0;
    }
    if(_type!=d.type){
      d.type=_type;
    }
  },
  _removeCurItem:function(_type){
    if(_IDE._data._curAction.type==_type&&!_IDE._data._curAction.element){
      _ideActionManagement._deleteItems(BZ._data._uiSwitch._selectedItems)
    }
    if(bzTwComm._isIDE()){
      _extensionComm._exeFun("_endRequire","_bzDomPicker");
    }else{
      _bzDomPicker._endRequire()
    }
  },
  _newItem:function(_type,_noAddToTest,_noPicker){
    var _curTest=_IDE._data._curTest
    if(!BZ._isPlaying()){
      _curTest._result=[];
    }
    var a=_CtrlDriver._buildProxy(this._getNewValidationAction(_type));
    if(_type==0){
      a.refOfFailed=_IDE._data._setting.content.defFailResponse+"/"
      if(BZ._isRecording()){
        _extensionComm._setShareData({"$parameter":$parameter})
      }
    }
    if(_type==8){
      a.target="A"
      a.panel=["BZ.TW.document","BODY",0]
    }else if(_type==3){
      a.runInIDE="on"
    }else if(_type==9){//fillform
      a.nextBtn=["BZ.TW.document",":endEqual("+_dictionaryHandler._getWordsByKey("next")[0]+")"]
      a.submitBtn=["BZ.TW.document",":endEqual("+_dictionaryHandler._getWordsByKey("submit")[0]+")"]
      a.autoSubmit="on"
      a.handleMsg="2"
    }else if(_type=="a"){
      a.requests=[]
      a.rampUp={
        users:100,
        up:120,
        totalTime:300
      }
      a.id=_aiAPI._newId()
    }else if(_type==5){
      a.description=_bzMessage._action._defComment;
    }
    if(!_noAddToTest){
      let ca=_IDE._data._curAction
      if(ca){
        let as=_IDE._data._curTest._data.actions
        as.splice(as.indexOf(ca)+1,0,a)
        if(_type!=7){
          a.inGroup=ca.type==7?"on":ca.inGroup
        }
      }else{
        _ideActionManagement._addItem(a);
      }
      if(_type==4&&_curTest._data.type=="scenario"){
        _ideActionManagement._setStepKey(a,_curTest._data)
      }
      var t=_ideActionData._type;
      if(!_noPicker && "0125".includes(_type)){
        setTimeout(function(){
          _IDE._data._curAction=a
          _ideActionManagement._pickElement(1);
        },100);
//        BZ._setOperationInfo(_bzMessage._system._operation._selectElement);
      }else if(_bzDomPicker._isActionElementPicking()){
        _bzDomPicker._endRequire();
      }
    }
    return a;
  },
  _newPlug:function(a){
    var n=this._newItem(_ideActionData._type._ref);
    a+="/";
    if(a==_IDE._data._curModule._data.code+"."+_IDE._data._curTest._data.code){
      a+="1"
    }
    n.refOfSuccess=a;
  },
  _updateAutoFillAction:function(b){
    if(_ideTestManagement._data._inAutoFill &&b.event){
      var a=_ideTestManagement._highlightItemByElementPath(b.element)
      if(a&&a.event.type==b.event.type){
        if(b.event.type=="change"){
          a.event.value=a.event.value
          if(b.event.value && b.event.value.match(/^\{\{(.)+\}\}$/)){
            _ideActionManagement._buildInputBindData(a,b.event.value,b.event.tmpValue,0,0,0,1);
          }else{
            var p=_Util._getTagNameFromElementPath(a.element)
            if(p.startsWith("SELECT")||p.includes("[type=checkbox]")||p.includes("[type=radio]")&&a.event.value.match(/^\{\{(.)+\}\}$/)){
              _ideActionManagement._buildInputBindData(a,a.event.value,b.event.value,0,0,0,1);
            }else{
              a.event.value=b.event.value;
            }
          }
          _extensionComm._setStatus(BZ._data._status)
          return 1
        }else if(b.element.toString().toUpperCase().includes("LABEL")){
          return 1
        }
      }
    }
    _ideTestManagement._data._inAutoFill=0
  },
  _updateAction:function(b){
    if(b._inUpload){
      return
    }
    if(_ideActionManagement._updateAutoFillAction(b)){
      return
    }
    var a=_IDE._data._curAction;
    if(!a){
      return
    }
    // if(a.element && a.element[0] && a.element[0]!==b.element[0]){
      // return;
    // }
    a.element=b.element;
    a.panel=b.panel
    if(a.event){
      a.event.element=b.event.element
    }
    if(a.type==_ideActionData._type._triggerEvent){
      if(b.event.value){
        if(b.event.value && b.event.value.match(/^\{\{(.)+\}\}$/)){
          _ideActionManagement._buildInputBindData(a,b.event.value,b.event.tmpValue,b.replace);
        }else{
          a.event.value=b.event.value;
          _extensionComm._setStatus(BZ._data._status)
        }
      }
    }else if(a.type==_ideActionData._type._validation){
      a.expection=b.expection?b.expection.trim():"";
      a.content.type=b.content.type
    }else if(a.type==_ideActionData._type._extractData && !a.script){
      a.script=b.script;
    }else if(a.type==_ideActionData._type._fillForm&&(!a.data||!a.data.length)){
      return _ideDataBind._generateFillFormActionData(a,function(ds){
        a.data=ds||[]
        a.data.forEach(v=>{
          var d=_ergodicSettingHandler._getItemByString(v.key)
          if(d){
            v.data=d.key
          }
        })
        _ideTestManagement._save()
      })
    }
    if(b.img){
      a.img=a.tmpImg=b.img;
    }
    if(BZ._isRecording()){
      BZ._setStatus("");
      setTimeout("BZ._setStatus('record')",100);
      return
    }
    _ideTestManagement._save()
  },
  //trigger by handleMsg
  _updateFillFormData:function(a){
    let d=0,nd;
    if(a.data){
      try{
        let d=_Util._eval("d="+a.data)
      }catch(e){}
    }
    
    if(d){
      if(_ideActionManagement._isSimpleData(d)){
        if(a.handleMsg){
          nd=_ideActionManagement._switchFillformDataToChkData(d)
        }
      }else if(!a.handleMsg){
        nd=_ideActionManagement._switchFillformDataToChkData(d)
      }
      if(nd){
        return _Util._confirmMessage({
          _tag:"div",
          _items:[
            {
              _tag:"h4",_text:_bzMessage._action._updateFillFormData
            },
            {
              _tag:"div",_attr:{"class":"col-xs-6"},
              _items:[
                {
                  _tag:"label",_text:"_bzMessage._common[_data._item._text]"
                },
                {
                  _tag:"textarea",_attr:{"class":"form-control"},
                  _text:"JSON.stringify(_data._item._data)"
                },
              ],
              _dataRepeat:[
                {_text:"_from",_data:d},
                {_text:"_toData",_data:nd}
              ]
            }
          ]
        },[
          {
            _title:_bzMessage._common._ok,
            _click:function(dlg){
              a.data=JSON.stringify(nd)
              dlg._ctrl._close();
            }
          }
        ])
      }
    }
  },
  _isSimpleData:function(d){
    for(var k in d){
      if(d[k].constructor==Object){
        return 
      }
    }
    return 1
  },
  _switchFillformDataToChkData:function(d){
    let nd={}
    for(var k in d){
      nd[k]=d[k].success||d[k]
    }
    return nd
  },
  _switchFillformDataToSimpleData:function(d){
    let nd={}
    for(var k in d){
      nd[k]={success:d[k],error:[]}
    }
    return nd
  },
  //_switchToSetValue
  _mergeToSetAction:function(d){
    let as=d._actions
    let tas=_IDE._data._curTest._data.actions
    tas.find((a,i)=>{
      if(a._mergeId==as[0]._action._mergeId){
        a.event={
          type:"change",
          value:d._data._name||d._data._value,
          valueStyle:d.valueStyle
          // fromPanel:d.fromPanel
        }
        a.element=d._data._inputPath||a.element
        if(d._data._name){
          _aiDataUpdateHandler._bindAndGenerateData(d._data._name,d._data._value)
        }
        BZ._setHash(i)
        while(as.length){
          let y=as.shift()
          for(var j=i+1;j<tas.length;j++){
            let e=tas[j]
            if(e&&e._mergeId&&e._mergeId==y._action._mergeId){
              tas.splice(j,1)
              i=j-1
              break
            }
          }
        }

        return 1
      }
    })
  },
  //Customize input,//_switchToSetValue
  _changeToSetAction:function(ds,_idx,a){
    if(a.event&&a.event._customize&&a.event._customize._end){
      a=a.event._customize;
      var vs=[a],i,to;
      for(i=_idx;i>=0;i--){
        to=ds[i]
        if(to.event &&to.event._customize){
          vs.unshift(to.event._customize)
        }
        if(vs[0]&&vs[0]._head&&vs[0]._name==a._name){
          break
        }
      }
      if(i<0){
        return
      }
      to.event.type="change"
      to.event.action=0
      delete to.event.action
      if(a._fullValue&&a._fullValue.match(/\$[0-9]+/)){
        vs.reverse()
        to.event.value=_buildValue(to.event._customize._name,vs,a._fullValue)
      }else{
        to.event.value=a._fullValue||a._value
      }
      if(_IDE._innerWin._data._dataBind._showDataBind){
        to.event.tmpValue=to.event.value
        to.event.value="{{"+_ideDataBind._data._scope
        if(_ideDataBind._data._scope!="$parameter"){
          to.event.value+="."+_ideDataBind._data._key
        }
        to.event._customize.$label=_glossaryHandler._getVariableName(to.event._customize.$label)
        to.event._customize.$header=_glossaryHandler._getVariableName(to.event._customize.$header)
        to.event.value+="."+ (to.event._customize.$label||to.event._customize.$header||_glossaryHandler._getVariableName(_descAnalysis._retrieveTextForElementPathItem(to.element)))+"}}"
        _ideActionManagement._buildInputBindData(to,to.event.value,to.event.tmpValue);
      }
      ds.splice(i+1,_idx-i)
      BZ._data._uiSwitch._selectedItems=[to]
      let _toggleBk=to.event._customize._toggleBk&&to.event._customize._toggleBk.pop()
      let _valueBk=to.event._customize._valueBk&&to.event._customize._valueBk.pop()

      if(_valueBk&&_toggleBk&&_valueBk!=_toggleBk){
        for(var i=to.element.length-1;i>=0;i--){
          let ev=to.element[i]
          if(ev==_toggleBk){
            break
          }else if(ev!=_toggleBk&&ev==_valueBk){
            to.element[i]=_toggleBk
            break
          }
        }
      }
      to.customize=a._name
      to.$label=to.event._customize.$label
      to.$header=to.event._customize.$header

      to.event._customize=0
       _ideActionManagement._setCurAction(to)
      return 1
    }
    function _buildValue(_name,vs,f){
      var os=_cssHandler._getCustomizeInputs()
      for(var i=0;i<os.length;i++){
        if(os[i].name==_name){
          vs.forEach(function(v){
            if(v._format){
              f=f.replace(v._format,v._value)
            }
          })
          return f
        }
      }
    }
  },
  _addItem:function(a){
    a=_CtrlDriver._buildProxy(a);
    if(a._inUpload){
      setTimeout(()=>{
        delete a._inUpload
        if(a._uploadFile){
          _uploadHandler._askHandleFile(a)
        }
      },200)
    }
    let ca=_IDE._data._curAction,_idx;
    if(_ideRecorder._isWithEntryAction(a)){
      return
    }
    if(a.event&&a.event.action=="click"){
      if(Date.now()-(_domRecorder._lastClickFileInput||0)<200){
        return
      }
      _domRecorder._lastNewActionTime={
        a:a,
        t:Date.now()
      }
    }
    if(a.type==7){
      return _ideActionManagement._newGroup()
    }
    if(_ideRecorder._addActionFun){
      return _ideRecorder._addActionFun(a)
    }
    if(_ideActionManagement._updateAutoFillAction(a)){
      return
    }
    if(ca && ca.element && a.element && ca.element.toString()==a.element.toString() && a.type==_ideActionData._type._triggerEvent && a.type==ca.type && a.event.type==ca.event.type && a.event.type=="change"){
      ca.event.value=a.event.value;
      return
    }

    //Set enter point on empty of action list
    var t=_IDE._data._curTest._data;
    var ds=t.actions,_tmpUrl=a._tmpUrl;
    var _curSelect = BZ._data._uiSwitch._selectedItems.length==1?BZ._data._uiSwitch._selectedItems[0]:0;
    _idx=ds.indexOf(_curSelect);
    if(_ideActionManagement._changeToSetAction(ds,_idx,a)){
      return
    }
    delete a._tmpUrl;
    if(!_curSelect || BZ._isPlaying()){
      if(BZ._data._uiSwitch._insertActionFromTop){
        ds.unshift(a)
      }else{
        ds.push(a)
      }
    }else{
      ds.splice(_idx+1,0,a);
    }
    _idx=ds.indexOf(a);
    if(a.type!=7&&ds[_idx-1] && (ds[_idx-1].inGroup || ds[_idx-1].type==7)){
      a.inGroup="on"
      _ideActionGroup._switchGroupOpen(a,1)
    }
    BZ._data._uiSwitch._selectedItems[0]=a;
    
    _ideDataManagement._assignCurDataForRecording(BZ._getCurTest(),a)
    _ideActionManagement._setActionHash(a);
    
    // _guiTestHandler._drawGUI()
    
    if(_tmpUrl&&a.type==1){
      for(var i=0;i<ds.length;i++){
        var ta=ds[i];
        if(ta==a){
          break
        }
        if(ta.type==1||ta.type==6){
          _tmpUrl=0
          break
        }
      }
      if(_tmpUrl){
        var h=h=_ideTestManagement._getCurHost();
        if(h){
          if(_tmpUrl.startsWith(h)&&_tmpUrl.substring(h.length,h.length+1)!=":"){
            _tmpUrl=_tmpUrl.substring(h.length)
          }
        }
        t.enterPoint.value = _tmpUrl=="#"?"":_tmpUrl;
      }
    }
    _aiWordHandler._analysisAction(a)
    _ideRecorder._addLastRecordedAction(a)
    return a;
  },
  _buildInputBindData:function(a,_value,_tmpValue,_replace){
    try{
      _aiDataUpdateHandler._bindAndGenerateData(_value,_tmpValue,_replace,function(v){
        a.event.value="{{"+v+"}}";
        _extensionComm._setStatus(BZ._data._status)
      })
    }catch(e){}
  },
  _cleanTmpData:function(d){
    var ds=_ideActionData._dataStructure[_ideActionData._keys[d.type]];
    if(!ds){
      return;
    }
    for(var k in d){
      if(ds.indexOf(k)<0){
        delete d[k];
      }
    }
    if(d.type==_ideActionData._type._validation){
      if(d.method==_ideActionData._method._html){
        delete d.script;
        delete d.api;
        if(["exist","unexist","dnexist"].includes(d.content.type)){
          delete d.md5
        }
      }else if(d.method==_ideActionData._method._script){
        delete d.api;
        delete d.content;
      }else if(d.method==_ideActionData._method._data){
        delete d.script;
        delete d.element;
        delete d.errOnHidden;
        delete d.failedReaction;
      }
    }else if(d.type==_ideActionData._type._triggerEvent&&!d.apiReplaceEvent){
      if(!d.event.popType){
        delete d.expection;
      }
      delete d.event._customize
      if(d.event.type!="mouse"){
        delete d.event.x;
        delete d.event.y;
        delete d.event.button;
        delete d.event.download
      }
      if(d.event.type!="key"){
        delete d.event.keyCode;
        delete d.event.charCode;
        delete d.event.groupKeys;
      }
      if(d.event.type!="change"){
        delete d.event.value;
      }
      if(["focus","blur","change"].indexOf(d.event.type)>=0){
        delete d.event.action;
        delete d.event.button;
        delete d.event.ctrl;
        delete d.event.alt;
        delete d.event.shift;
      }
    }else if(d.type==_ideActionData._type._extractData){
      if(d.method==_ideActionData._method._html){
        delete d.api;
      }else if(d.method==_ideActionData._method._data){
        delete d.element;
        delete d.errOnHidden;
        delete d.failedReaction;
      }
    }
    if(d.type!=_ideActionData._type._validation){
      delete d.content;
    }

    if (d.expection) {
      delete d.md5;
      if (d.content&&d.content.type!="data"&&d.expection.length>200) {
        d.md5=_calcMD5(d.expection);
        var ws=d.expection.split("\n");
        var fws="";
        for(var i=0;i<ws.length;i++){
          fws+=ws[i].trim();
        }
        if(fws.length>5120){
          delete d.expection;
        }
      }
    }else if(d.img){
      d.md5=_calcMD5(d.img);
    }
  },
  //as:actions, t: test case object
  _storeAISetting:function(as,t){
    as.forEach((a,i)=>{
      if(a.ai&&"01".includes(a.type)){
        let o=_aiPageHandler._getAIObjByAction(a)
        if(o){
          _addData(o,a,"refOfSuccess")
          _addData(o,a,"refOfFailed")
          _addData(o,a,"refOfError")
          _addData(o,a,"successParameter")
          _addData(o,a,"failedParameter")
          _addData(o,a,"errorParameter")
          _addData(o,a,"noLightAction")
          _addData(o,a,"failedReaction")
          _addData(o,a,"errOnHidden")
          _addData(o,a,"repElementMethod")
          _addData(o,a,"supportReadOnly")
          _addData(o,a,"skipActionElement")
          _addData(o,a,"failElement")
          // _addData(o,a,"finalElement")
          _addData(o,a,"offset")
          _addData(o,a,"monitorUrl")
          _addData(o,a,"event")
        }
      }
    });
    
    function _addData(o,a,k){
      if(a[k]||(k=="failedReaction"&&a[k]!==undefined)){
        if(k=="event"){
          if(!a.event||!_isUpdateEvent(a.event)){
            if(o.advanced){
              delete o.advanced.event
            }
            return
          }
        }
        o.advanced=o.advanced||{}
        o.advanced[k]=a[k]
      }else if(o.advanced){
        delete o.advanced[k]
      }
    }
    
    function _isUpdateEvent(e){
      for(let kk in e){
        if(kk=="autoBlur"){
          if(!e[kk]){
            return 1
          }
        }else if(kk=="type"){
          if(!["mouse","change"].includes(e[kk])){
            return 1
          }
        }else if(kk=="action"){
          if(e.action!="click"){
            return 1
          }
        }else if(!_Util._isEmpty(e[kk])){
          return 1
        }
      }
    }
  },
  _cleanByStdAction:function(d,s){
    for(var k in s){
      if(d[k]!==undefined){
        if(s[k].constructor==Object){
          _ideActionManagement._cleanByStdAction(d[k],s[k])
            
          if(!Object.keys(d[k]).length){
            delete d[k]
          }
        }else if(s[k].constructor==Array){
          if(d[k].join(",")==s[k].join(",")){
            delete d[k]
          }
        }else if(d[k]==s[k]&&k!="ai"){
          delete d[k]
        }
      }
    }
    if(Object.keys(d).length==1&&d.ai){
      delete d.ai
    }
  },
  _getStdAIAction:function(t,a){
    var as=t._data.actions,
       aas=t._actions,c=0;
    
    if(as.includes(a)){
      for(var i=0;i<as.length;i++){
        if(as[i]==a){
          break
        }else if(as[i].ai==a.ai){
          c++
        }
      }
      for(var i=0;i<aas.length;i++){
        if(aas[i].ai==a.ai){
          if(c){
            c--
          }else{
            return aas[i]
          }
        }
      }
    }
  },
  _checkFileSize:function(v){
    if(v.length-1600>1024*1024*2){
      return alert(_bzMessage._system._error._fileSizeIssue)
    }
    return 1;
  },
  _buildFileValue:function(_files,_text){
    _uploadHandler._inputFileToBase64Obj(_files,function(_result){
      _text=_text||_IDE._data._curAction.event;
      var v=JSON.stringify(_result,0,2);
      if(_ideActionManagement._checkFileSize(v)){
        _text.value=v;
        $(_text).change();
      }
    });
  },
  _takeMD5Resource:function(t,a,_purpose,_md5Type,fun){
    if(a[_purpose] || !a[_md5Type]){
      if(fun){
        return fun();
      }
    }
    var _url="/api/projects/"+BZ._data._curProject.code+"/docs/"+(t.doc._id||t.doc)+"/md5/"+a[_md5Type];
    _requestHandler._callService({
      _data:{
        method:"GET",
        url:_url
      },
      _success:function(d){
        d=d.result
        if (!d.message) {
          if(a.type==5){
            a.tmpImg=d
          }else{
            a[_purpose]=d;
            if(_purpose=="_camera"){
              a._oldImg=1
            }
          }
          if(fun){
            fun();
          }
        }else{
          BZ._sysAlert(d.message);
        }
      },
      _failed:function(r){
        if(r.result){
          if(r.result.message!="_NoResource"||a.type!=_ideActionData._type._comment){
            _Util._alertMessage(r.result.message);
            a[_md5Type]=0
          }
        }
        fun&&fun()
      }
    });
  },
  _isSkippedResult:function(r){
    return r._bzSkip||(r._data.type==4&&!r._data.refOfSuccess)
  },
  _paste:function(){
    let c=_IDE._data._clipData,
        _inCut=c.inCut,
        _items=c._cutSource||c.items,
        os=BZ._data._uiSwitch._selectedItems||[],
        o=os[os.length-1]
        
    c.inCut=c._cutSource=0
    return _ideActionManagement._move(_items,o,0,0,_inCut)
  },
  _move:function(_items,a,t,m,ft){
    if(ft){
      ft=_ideObjHandler._getDataByPath(ft)
      ft._result=[]
      let as=ft._data.actions;
      while(a&&_items.includes(a)){
        a=as[as.indexOf(a)-1]
      }
      ft._data.actions=ft._data.actions.filter(x=>!_items.includes(x));
      _ideTestManagement._save(ft,ft._parent,function(){
        _doIt();
      })
    }else{
      _doIt()
    }

    function _doIt(){
      t=t||_IDE._data._curTest._data
      m=_ideObjHandler._getModuleByTest(t,m)
      if(t.type=='scenario'&&_items.find(x=>!"74".includes(x.type))){
        return alert(_bzMessage._scenario._onlyGroupAndRefAction)
      }

      var _idx=t.actions.indexOf(a)+1,
          _newSelect=_Util._clone(_items),
          _set=new Set(t.actions.map(x=>x.id));

      _newSelect.forEach((a,i)=>{
        a.id=a.id||1
        while(_set.has(a.id)){
          a.id+=1
        }
        _set.add(a.id)
        t.actions.splice(i+_idx,0,a)
        _newSelect[i]=t.actions[i+_idx]
      })

      var ct=_IDE._data._curTest
      if(ct&&ct._data==t){
        ct._result=[];
        BZ._data._uiSwitch._selectedItems=_newSelect;
        _IDE._data._curAction=0
        if(_newSelect.length==1){
          _IDE._data._curAction=_newSelect[0]
        }
      }
      a=t.actions[_idx-1]
          
      let _stopChangeForGroup,
          _inGroup=a&&(a.type==7||a.inGroup)

      _newSelect.forEach(function(v){
        if(v.type==7||_stopChangeForGroup){
          _stopChangeForGroup=1
          return
        }
        if(_inGroup){
          v.inGroup="on"
        }else{
          _ideActionManagement._removeFromGroup([v])
        }
      })

      _ideTestManagement._save(t,m)
    }
  },
  _pickElement:function(_pick){
    if(bzTwComm._isIDE()){
      this._setCurAction(_IDE._data._curAction)
      let d=_pick||{element:_IDE._data._curAction.element}
      _extensionComm._exeFun("_pickElement","_ideActionManagement",d,(d.element||[])[0]);
//      _extensionComm._exePickElement(_IDE._data._curAction)
    }else if(_IDE._data._curAction){
      _descAnalysis._clearTmpPath(1);
      _bzDomPicker._start({_id:"_actionElementPick",_back:_back,_type:_IDE._data._curAction&&_pick!=1?_IDE._data._curAction.panel||_IDE._data._curAction.element:null});
    }else{
      return
    }
    function _back(_path,_pos,_element){
      var e=$util.findDom(_path),
          _curAction=_IDE._data._curAction;
      if(_curAction.type==8){
        _curAction.panel=_path;
      }else{
        let _com=_Util._clone(_curAction);
        _com=_ideActionManagement._getComDataFromElement(_com)
        if(_com){
          _curAction.element[1]=`:${_com.$fun}(${_descAnalysis._retrieveTextForElementPathItem(_path)})`;
        }else{
          _curAction.element=_path;
        }
        _ideDataBind._bindDataOnElement(_curAction,"element");
      }
      
      if(_curAction.type==_ideActionData._type._triggerEvent&&_pos){
        _curAction.event.x=_pos.x;
        _curAction.event.y=_pos.y;
      }
      _curAction.failedReaction=0;
      if(_curAction.type==_ideActionData._type._validation){
        var s=BZ._data._status;
        BZ._data._status=""
        setTimeout(function(){
          BZ._data._status=s;
        },500)
        return _domActionTask._exeAction(_curAction,{_force:1,_taskQueue:[]},function(){
          _IDE._data._curAction=_curAction
          if(_curAction.content){
            if(_curAction.content.type=="data"){
              var s=_ideDataBind._bindValidationData(e);
              if(s){
                _curAction.expection=s;
              }
            }else if(_curAction.content.type=="innerText"){
              var v=_ideDataBind._insertCode(_curAction.expection);
              if(v){
                _curAction.expection=v;
              }
            }
          }
          _sendData(_curAction)
        })
      }else if(_curAction.type==_ideActionData._type._extractData){
        if(!_curAction.script && e){
          var a=_curAction;
          let v=_glossaryHandler._getVariableName(_descAnalysis._retrieveTextForElementPathItem(a.element))||"tmpValue"
          a.script="$parameter."+v+" = $util.getElementText($element);"
        }
      }else if(_curAction.type==_ideActionData._type._comment){
        var a=_curAction
        _element.bzTmp=_path
        return _screenshotHandler._getScreenshot(_Util._findTextElement(_element),1,function(c){
          _IDE._data._curAction=a;
          a.img=c
          _domActionTask._doComment(a,true);
          _sendData(a)
        })
      }
      
      _sendData(_IDE._data._curAction)
    }
    
    function _sendData(a){
      if(bzTwComm._isExtension()){
        BZ._formatInIFramePath(a.panel||a.element)
        $(".BZIgnore .bz-tb-buttons .bz-active").removeClass("bz-active")
        bzTwComm._postToIDE({_fun:"_updateAction",_args:[a],_scope:"_ideActionManagement"});
      }else{
        _ideTestManagement._save()
      }
    }
  },
  _getDescExtra:function(d,_simple){
    if(_simple){
      return ""
    }
    var k="";
    if(d.event.ctrl){
      k+="+ctrl"
    }
    if(d.event.alt){
      k+="+alt"
    }
    if(d.event.shift){
      k+="+shift"
    }
    if(d.event.type=="mouse"){
      if(d.event.download){
        k+=","+_descAnalysis._syntaxOptionKey.download._value
      }
      if(d.event.button==2){
        k+="+"+_bzMessage._action._right
      }else if(d.event.button==1){
        k+="+"+_bzMessage._action._left
      }
      if(parseFloat(d.event.x)>=0){
        k+=",x="+d.event.x
      }
      if(parseFloat(d.event.y)>=0){
        k+=",y="+d.event.y
      }
    }else if(d.event.type=="key"){
      if(d.event.keyCode){
        if(d.event.charCode){
          k+="+"+String.fromCharCode(d.event.charCode)
        }else{
          var mp=_descAnalysis._keyboardMap;
          for(var v in mp){
            if(mp[v]==d.event.keyCode){
              k+="+"+v.toUpperCase();
              break
            }
          }
        }
      }
    }
    if(k){
      return "["+k.substring(1)+"]"
    }
    return ""
  },
  _getCurIdx:function(a){
    return _IDE._data._curTest._data.actions.indexOf(a||_IDE._data._curAction)
  },
  _getPreAction:function(a,t){
    t=t||_IDE._data._curTest._data
    t=t._data||t
    t=t.actions
    return t[t.indexOf(a)-1]
  },
  _getNextAction:function(a,t){
    t=t||_IDE._data._curTest._data
    t=t._data||t
    t=t.actions
    return t[t.indexOf(a)+1]
  },
  _getValidateDesc:function(d){
    if(d.method==2){
      let a=d.api
      let _host=BZ._curEnv.items[a.host],_url=a.httpURL;
      if(_host){
        _host=_host.host
        _url=_Util._mergeURL(_host,_url)
      }
      if(_url){
        _url= a.httpMethod+ " "+_url+" == "+d.expection
        if(_url.length>100){
          _url=_url.substring(0,100)+" ..."
        }
        return _url
      }
    }else if(d.content){
      let w=_bzMessage._action._content,
          dd=(d.expection||_bzMessage._method._not)
      switch(d.content.type){
        case "exist":return w._exist;
        case "unexist":return w._unexist;
        case "dnexist":return w._dnexist+" ("+dd+")";
        case "data":return d.expection;
        case "disable":return w._disable+" ("+dd+")";
        case "checked":return w._checked+" ("+dd+")";
        case "enable":return w._enable+" ("+dd+")";
      }
      return this._getExpectionDesc(d,1)
    }
  },
  _getExpectionDesc:function(d,_simple){
    var s="";
    if(!["exist","unexist","dnexist"].includes(d.content.type)){
      s=" "+d.compareMark;
      if(d.expection){
        var v=d.expection;
        if([Object,Array].includes(v.constructor)){
          d.expection=v=JSON.stringify(v,0,2)
        }
        if(d.content.type=="data"){
          v="{{"+v.trim()+"}}"
        }
        if(_simple){
          s+=" "+_JSHandler._formatInsertCodeToDisplay(v)
        }else{
          if(v.includes("\n")){
            s+=" (\n"+v+"\n)";
          }else{
            s+=" ("+v+")";
          }
        }
      }else if(d.md5){
        s+=" ("+"MD5:"+d.md5+")";
      }
    }
    return s;
  },
  _getAPIOption:function(d){
    var r=_bzMessage._syntaxOption.response;
    var s=r.httpMethod+": "+d.api.httpMethod+"\n";
    var _ignore="";
    
    if(d.api.httpHeaders){
      s+="headers: "+d.api.httpHeaders+"\n"
    }
    if(d.api.httpMethod.toLowerCase()!="get" && d.api.httpData){
      s+=r.httpData+": "+d.api.httpData+"\n";
    }else if(d.api.httpMethod.toLowerCase()=="get"){
      if(d.api.downloadAsFile && d.type==_ideActionData._type._extractData){
        s+=_bzMessage._syntaxOption.response.downloadAsFile
      }
    }
    if(d.content && d.content.type){
      s+=_bzMessage._syntaxOption.response.type+": JSON\n";
      
      ["type","jsonKey","jsonValue"].forEach(function(v,i){
        if(d.content.ignore[v]){
          s+=_bzMessage._syntaxOption.response[v]+": "+d.content.ignore[v]+"\n"
        }
      });
      
      ["status","data","nullValue","emptyValue"].forEach(function(v,i){
        if(d.content.ignore.attrs[v]){
          _ignore+=","+_bzMessage._syntaxOption.response[v]
        }
      });
      if(_ignore){
        s+=_bzMessage._syntaxOption.response.ignore+": "+_ignore.substring(1);
      }
    }
    s=s.trim();
    if(s.includes("\n")){
      s="[\n"+s+"\n]";
    }else{
      s="["+s+"]"
    }
    return s;
  },
  _getConditionOptions:function(a){
    var vs=[{_type:"loopdata"},{_type:"resultscript"},{_type:"Success"},{_type:"Failed"},{_type:"Error"},{_type:"note"}];
    var t=a.type;
    //group,plug/comment
    if(t==5){
      if(!a.showJudge){
        vs.forEach(function(v){
          v._disabled=1
        })
      }else{
        vs[2]._disabled=1
      }
    }else if(t==7){
    }else if(t==4){
      //vs[2]._disabled=1
    //Not script and refresh
    }else if(t && ![1,3,6].includes(t)){
      vs[2]._disabled=1
    }
    return vs
  },
  _getTabOptions:function(aa){
    var a=_ideActionManagement._getConditionOptions(aa)
    for(var i=0;i<a.length;i++){
      if(a[i]._disabled){
        a.splice(i--,1)
      }else{
        a[i]=a[i]._type
      }
    }
    return a
  },
  _gotoRefTest:function(v){
    v=v.match(_IDE._testKeyRegex)
    if(v){
      v=v[0].replace(".","/")
      BZ._setHash(v)
    }
  },
  // _getUIDescription:function(i,a,_inHtml){
    // var w;
    // if(a.description){
      // w=a.description;
    // }else{
      // w=_ideActionManagement._getAutoDescription(a,1);
      // try{
        // if(a.type==4&&_IDE._data._curTest&&_IDE._data._curTest._data.type=="scenario"){
          // w="["+a.refOfSuccess.match(_IDE._testKeyRegex)[0]+"] "+w
        // }
      // }catch(e){}
    // }
    // w=w.replace(/</g,"&lt;").replace(/>/g,"&gt;")
    // w=i+", "+w.trim()
    // var ws=w.split(/\([^\)\}]+\)|\{\{[^\}]+\}\}/g);
    // var ms=w.match(/\([^\)\}]+\)|\{\{[^\}]+\}\}/g);
    // var ww=""
    // if(ms && ms.constructor==Array){
      // for(var i=0;i<ms.length;i++){
        // ww+=ws[i]
        // if(_Util._hasCode(ms[i])){
          // ww+="<span class='param'><i>"+ms[i]+"</i></span>"
        // }else{
          // ww+=ms[i]
        // }
      // }
      // ww+=ws[i]
    // }else if(ms){
      // ww=ws[0]+ms+ws[1]
    // }else{
      // ww=w
    // }
    // if(a.type==_ideActionData._type._ref && a.refOfSuccess && _IDE._data._curAction==a){
      // var v=a.refOfSuccess.match(/(^|\/)(m|\{)([^\/]+)([0-9]|\})($|\/)/);
      // if(v){
        // v=v[2]+v[3]+v[4]
        // if(v[0]=="m"){
          // if(_inHtml){
            // return "<a style='text-decoration:underline;' href='javascript:_ideActionManagement._gotoRefTest(\""+a.refOfSuccess+"\")'>"+ww+"</a>"
          // }
        // }else{
          // ww=_JSHandler._formatInsertCodeToDisplay(ww)
        // }
      // }
    // }
    // if(a.event && a.event.download && _inHtml){
      // ww=ww.replace("[","<b>[<span class='bz-action-ref bz-cloud-download'>").replace("]","</span>]</b>")
    // }
    // if(_inHtml){
      // ww="<span>"+ww+"</span>";
    // }
    // return ww
  // },
  //
  _getFinalDisplayDesc:function(a,t){
    var v=a.description
    if(v || a.type==_ideActionData._type._comment){
      v=v||"";
    }else{
      v= _ideActionManagement._getAutoDescription(a,1,t);
      if(!v){
        v=$("._action"+t._data.actions.indexOf(a)).val()||"";
      }
    }
    v=v
    return v.replace("\n"," ").trim();
  },
  _hasCondition:function(a){
    let dr=_IDE._data._setting.content.defFailResponse||".."
    return _chkItem(a.refOfSuccess,1)||_chkItem(a.refOfFailed,2)||_chkItem(a.refOfError,3)

    function _chkItem(r,_type){
      if(r){
        if(r.match(/(^|\/)(m[0-9]+\.t[0-9]+|\{\{.+\}\}|[wc]|\.\.\.)(\/|$)/)){
          return 1
        }else if(_type==1){
          return r.match(/[ef]|\.\./)
        }else if(_type==3){
          return r.match(/[sf]|(\/|^)\.(\/|$)/)
        }else if(_type==2){
          if(r.match(/[se]|(\/|^)\.(\/|$)/)){
            return 1
          }
          if(dr=="."){
            return r.includes("..")
          }else{
            return !r.includes("..")
          }
        }
      }
    }
  },
  _getValueDesc:function(a,_test){
    switch(a.type){
      case 0:return this._getValidateDesc(a);
      case 1:
        let _msg=_descAnalysis._codeToDesc((a.event&&a.event.value)||(a.event&&a.event.groupKeys)||(a.event&&a.event.keyCode&&_bzMessage._common._key+": "+a.event.keyName)||"",1);
        if(a.withEntry){
          _msg +=" + "+_bzMessage._common._enter
        }else if(a.withSubmit){
          _msg +=" + "+_bzMessage._method._submit
        }
        return _msg
      case 2:case 3: return a.script;
      case 4: return this._refTestPathToDisplay(a,0,_test);
      case 5:case 6:return a.description||a.url||"";
      case 7:return (a.description||"")+(a.loopGroup?"("+_bzMessage._action._loop+")":a.elseGroup?"("+_bzMessage._action._else+")":"");
      case 9: return a.data?a.data.map(a=>{return a.key}).join(", "):""
    }
  },
  _loadDataForLoadTest:function(){
    let _timer;
    _ideVersionManagement._loadAllData(function(){
      _ideTestManagement._inBatchCreate=1
      _IDE._data._curVersion.modules.forEach(m=>{
        m.tests.forEach(t=>{
          if(t.type=="api"){
            let _update=0,ai=_aiGeneratorDataHandler._isAIGenerateTest(t,m)
            if(ai&&(!t.actions.length||_Util._isEmpty(t.actions[0]))){
              _aiGenerator._generateAIActions(t,m)
            }
            t.actions.forEach((a,i)=>{
              if(a.apiReplaceEvent){
                if(!a.id){
                  a.id=i+10
                  _update=1
                }
              }
            })
            if(_update){
              _ideTestManagement._save(t,m,function(){
                clearTimeout(_timer)
                _timer=setTimeout(()=>{
                  _ideTestManagement._inBatchCreate=0
                },1000)
              })
            }
          }
        })
      })
      BZ._data._uiSwitch._showBatchList=1
    })
  },
  _getActionMethod:function(a){
    let w=_bzMessage._action._methodDesc
    let _key=_ideActionData._keys[a.type]
    if(a.type=="a"){
      return _bzMessage._action._methodDesc._load
    }else if(a.apiReplaceEvent){
      return "API"
    }
    switch(a.type){
      case 0: return a.method==2?w._validateResponse:a.method==1?w._validateJS:w._validateContent;
      case 1: 
        w=w._trigger
        a=a.event
        if(a.type=='change'){
          if(["radio","checkbox"].includes(_cssHandler._getInputTypeFromElementPath(a.element))){
            if(!a.event.value){
              w=w._uncheck
            }else{
              w=w._check
            }
          }else{
            w=w._change
          }
        }else if(a.type=="key"){
          w=w._typing
        }else if(a.type=="mouse"){
          if(a.action=="click"){
            if(a.download){
              w=_bzMessage._method._download
            }else if(a.button==2){
              w=w._rightclick
            }else{
              w=w._click
            }
          }else if(a.action=="dblclick"){
            w=w._dblclick
          }else{
            w=a.action
          }
        }
        return w
      case 2: return a.method==2?w._extractResponse:w._extractData;
    }
    return w[_key]
  },
  _getAutoDescription:function(d,_simple,_test){
    var t=_ideActionData._type;
    var _fType=d.type;
    var _script="";
    var _title="";
    var _desc=_bzMessage._action._description;
    var es=d.element||d.panel;
    if(d.type=="a"){
      return _Util._formatMessage(_bzMessage._action._description._load,d.requests.length+"")
    }

    if(d.requests&&d.requests.length&&d.apiReplaceEvent){
      var _method=d.requests[0].method||BZ._curEnv.items[d.requests[0].host||0].host
      return _method+": "+d.requests[0].url
    }
    
    if (![t._ref,t._refresh].includes(d.type) && (![t._validation,t._extractData].includes(d.type) || d.method!=2) && es && es.length) {
      _title=_descAnalysis._getDescOfElement(d);

      if(_fType==t._validation){
        if(d.method==1 || d.method==2){
          
        }else{
          _title=_Util._formatMessage(_desc._validateContent,["["+d.content.type+"]",_title]);
          _title+=this._getExpectionDesc(d,_simple);
        }
      }else if(_fType==t._triggerEvent){
        var et=d.event.type;
        var ea=d.event.action;
        if(et=="change"){
          if(["radio","checkbox"].includes(_cssHandler._getInputTypeFromElementPath(es))){
            if(!d.event.value){
              _title=_Util._formatMessage(_desc._trigger._uncheck,[_title]);
            }else{
              _title=_Util._formatMessage(_desc._trigger._check,[_title]);
            }
          }else{
            _title+=" = "+_descAnalysis._codeToDesc(d.event.value,_simple);
            _title=_Util._formatMessage(_desc._trigger._change,[_title]);
          }
          if(d.withEntry){
            _title+=" + "+_bzMessage._common._enter
          }else if(d.withSubmit){
            _title+=" + "+_bzMessage._method._submit
          }
        }else if(ea=="dblclick"){
          _title=_Util._formatMessage(_desc._trigger._dblclick,[_title]);
        }else if(et=="mouse"){
          if(["group","click"].includes(ea)){
            if(d.event.button==2){
              _title=_Util._formatMessage(_desc._trigger._rightclick,[_title]);
            }else{
              if(d.event.download){
                _title="["+_descAnalysis._syntaxOptionMap.mouse.download[0]+"] "+_title
              }
              _title=_Util._formatMessage(_desc._trigger._click,[_title]);
            }
          }else if(ea.startsWith("mouse") || ea=="dragdrop"){
            _title=ea+" "+_ideActionManagement._getDragdropDesc(d)
          }
        }else if(et=="key"){
          if(ea=="group"){
            if(d.event.groupKeys){
              _title+=" = "+_descAnalysis._codeToDesc(d.event.groupKeys,_simple);
              _title=_desc._trigger._typing+" "+_title;
            }else{
              _title="keygroup"+this._getDescExtra(d)+" "+_title;
            }
          }else{
            _title="key"+ea+this._getDescExtra(d)+" "+_title;
          }
        }
      }else if(_fType==t._comment){
        _title=_Util._formatMessage(_desc._comment,[_title,d.description]);
      }else if(_fType==t._visit){
        _title=_desc._visit+_title
      }else if(d.type==t._fillForm){
        _title=_getFillFormItemNameList(_title,d)
      }
    }else if (_fType==t._ref) {
      _title=this._refTestPathToDisplay(d,0,_test);
    }else if(d.type==t._group){
      _title=_desc._group+(d.description?'"'+d.description+'"':"");
    }else if(d.type==t._refresh){
      if(d.refreshType){
        _title=d.refreshData?d.refreshData.join(", "):"";
        _title=_Util._formatMessage(_desc._refreshData,[_title]);
      }else{
        _title="";
        if(d.clearCookie){
          _title+=", cookie"
        }
        if(d.clearLocalStorage){
          _title+=", localstorage"
        }
        if(d.loadURL){
          _title+=", "+d.loadURL
        }
        if(_title){
          _title="["+_title.substring(2)+"]";
        }
        
        _title=_Util._formatMessage(_desc._refresh,[_title]);
      }
    //validation data/api
    }else if(d.type==t._validation && d.method==_ideActionData._method._data){
      var o=this._getAPIOption(d);
      _title=_Util._formatMessage(_desc._validateResponse,[d.api.httpURL||"",o]);
      _title+=this._getExpectionDesc(d);
    }else if(d.type==t._fillForm){
      _title=_getFillFormItemNameList(_title,d)
    }
    if(d.script){
      if(_simple){
        if(d.script.includes("\n") || d.script.length>60){
          _script="{{...}}"
        }else{
          _script="{{"+(d.script||"").trim()+"}}"
        }
      }else{
        if(d.script.includes("\n")){
          _script="{{\n"+d.script+"\n}}";
        }else{
          _script="{{"+d.script+"}}"
        }
      }
      if(_fType==t._script){
        _title=_desc._exeScript+" "+_title+" "+_script;
      }else if(_fType==t._extractData){
        if(d.method==_ideActionData._method._data){
          var o=this._getAPIOption(d);
          _title=_Util._formatMessage(_desc._extractResponse,[d.api.httpURL,o])
                +" "+_script;
        }else{
          _title=_desc._extractData+_title+" "+_script;
        }
      }else{
        _title=_Util._formatMessage(_desc._validateContent,["",_title])+_script;
      }
    }else if(d.method=="data"){
      _title="[\n"+2+":]"
    }
    
    if(_title){
      _title=_title[0].toUpperCase()+_title.substring(1);
    }
    if(!_simple && d.type!=_ideActionData._type._ref){
      ["Success","Failed","Error"].forEach(function(v){
        if(d["refOf"+v]){
          _title+="\n  "+_bzMessage._syntax.advance["refOf"+v].split("/")[0]+":"+_ideActionManagement._refTestPathToDisplay(d,v,_test)
        }
      })
    }
    _title= "\n"+_JSHandler._formatInsertCodeToDisplay(_compressJSON._unConvert(_title));
    if(!_simple && d.inGroup){
      _title=_title.replace(/\n/g,"\n  ");
    }
    return _title
    
    function _getFillFormItemNameList(_title,d){
      return _Util._formatMessage(_desc._fillForm,[_title||""]);
    }
  },
  _getDragdropDesc:function(d){
    let to="[x = "+d.event.x+", y = "+d.event.y+"]"
    let _from=_descAnalysis._getDescOfElement(d)
    if(d.event.element){
      to=_descAnalysis._getDescOfElement({element:d.event.element})
    }
    return _Util._formatMessage(_bzMessage._syntaxOption.mouse.dragdrop,[_from,to])
  },
  _getRefDesc:function(a,k){
    var v=a?(a[k]||"").match(_IDE._testKeyRegex):""
    if(v){
      v=v[0]
      var vv=_ideObjHandler._getDataByPath(v);
      if(vv){
        return _compressJSON._unConvert(_ideTestManagement._getPathNameByPath(v)||_JSHandler._formatInsertCodeToDisplay(v))
      }
    }else if(a&&a[k]){
      v=a[k].match(/\{\{(.+)\}\}/)
      if(v){
        return _JSHandler._formatInsertCodeToDisplay(v[0])
      }
    }
  },
  _getBatchRequestDesc:function(d){
    d=_ideActionManagement._getBatchRequestRefData(d)
    if(d){
      return `[${d.m._data.code}.${d.t._data.code}] `+_ideActionManagement._getAutoDescription(d.a,1)
    }
  },
  _getActionUrlIdxByBatchRequest:function(d){
    d=_ideActionManagement._getBatchRequestRefData(d.action)
    if(d){
      return d.m._data.code+"/"+d.t._data.code+"/"+(d.t._data.actions.indexOf(d.a)+1)
    }
  },
  _getBatchRequestRefData:function(d,_fun){
    if(d){
      d=d.split(".")
      let m=_ideObjHandler._getDataByPath(d[0])
      let t=_ideObjHandler._getDataByPath(d[0],d[1]),a
      if(t){
        if(d[2]==1){
          a=t._data.actions[1]
          if(_Util._isEmpty(a)){
            _aiGenerator._generateAITest(t,m)
          }
        }
        let rd={t:t,m:m}
        if(!t._data.actions.length){
          _ideModuleManagement._loadItem(m,function(){
            rd.a=t._data.actions.find(a=>a.id==d[2])
            _fun&&_fun(rd.a&&rd)
          })
          if(!_fun){
            return rd
          }
        }else{
          rd.a=t._data.actions.find(a=>a.id==d[2])
          if(rd.a){
            if(_fun){
              return _fun(rd)
            }
            return rd
          }
        }
      }
    }
  },
  _showBatchRequestScript:function(dd,_forceKey){
    let d=dd._item,_idx=dd._idx,_save,s;
    let o=_ideActionManagement._getBatchRequestRefData(d.action)
    let r=o.a.requests[0]
    if(_forceKey=="preScript"){
      let s=_buildRequestPreScript(o)
      if(s!=d.preScript){
        d.preScript=s
        _save=1
      }
    }else if(_forceKey=="endScript"){
      s=_buildRequestEndScript(o)
      if(d.endScript!=s){
        d.endScript=s
        _save=1
      }
    }else if(!d.preScript&&!d.endScript){
      d.preScript=_buildRequestPreScript(o)
      d.endScript=_buildRequestEndScript(o)
      _save=1
    }
    if(_save){
      if(_forceKey){
        _CtrlDriver._refreshData(d,"_open")
      }
      _ideTestManagement._save()
    }
    function _buildRequestPreScript(o){
      let s=`(()=>{\n${_bzMessage._api._prepareParameter}\n{0}\n})();`,ss=""
      if(o){
        let p=_Util._strToJson(o.t._data.defParameter)||{};
        ss=_debugDataHandler._retrieveDataFromRequest(o.a.requests[0])
        ss=ss.map(xx=>{
          let v;
          if(!_idx){
            let x=xx.split(".")
            x=x[1]||x[0]
            v=p[x]
            return `${xx} = ${(JSON.stringify(v,0,2)+"").split("\n").join("\n  ")};`
          }else{
            v=xx.replace("$parameter","$result")
            return `${xx} = ${v};`
          }
        }).join("\n  ")
        return _Util._formatMessage(s,"  "+ss)
      }
    }

    function _buildRequestEndScript(o){
      if(r.method!="DELETE"){
        return `(()=>{\n${_bzMessage._api._batchRequestEndScriptDesc}\n  $parameter.$result[$result.idx] = $result.responseJSON;\n  return $result.status && $result.status < 400;\n})()`
      }else{
        return "(()=>{\n  return $result.status && $result.status < 400;\n})()"
      }
    }
  },
  //a:action, v: success,failed,error
  _refTestPathToDisplay:function(a,v,t){
    v=v||"Success"
    let ps=a["refOf"+v]
    if (!ps) {
      return _bzMessage._system._error._noImplement+" - "+(a.description||"");
    }
    let _parameter=a[v.toLowerCase()+"Parameter"]
    ps=ps.split("/");
    var _names=[];
    var r=_bzMessage._syntaxOption.process,_ref="";
    for(var i=0;i<ps.length;i++){
      var p=ps[i];
      _names[i]="";
      if(!p){
      }else if(p=="BZ-Refresh"){
        _names[i]=r._refresh.split("/")[0];
      }else if(p=="...."){
        _names[i]=r._stop.split("/")[0];
      }else if(p=="..."){
        _names[i]=r._breakGroup.split("/")[0];
      }else if(p==".."){
        _names[i]=r._break.split("/")[0];
      }else if(p=="."){
        _names[i]=r._continue.split("/")[0];
      }else if($.isNumeric(p)){
      }else if("cefws".includes(p)){
        _names[i]=_bzMessage._syntaxOption.result[_taskInfo._valueMap[p]].split("/")[0]
      }else if("cm{".includes(p[0])){
        var s=p
        if(p[0]=="m"||p[0]=="c"){
          var d=_ideObjHandler._getDataByPath(p)
          if(d&&a.stepKey){
            return _bzScenario._getActionDescOfRefLinkTest(a,t)
          }else{
            s=_ideTestManagement._getPathNameByPath(p);
          }
          if(!s){
            s="("+_bzMessage._system._error._refError+")"
          }
          s= "["+p+"] "+s;
        }else if(p[0]=="{"){
          s=_JSHandler._formatInsertCodeToDisplay(p)
        }
        _ref=_bzMessage._syntax.action.plug.split("/")[0]+": "+s;
        _ref=_Util._toCapitalWord(_ref)
      }
    }
    p="";
    for(var i=0;i<_names.length;i++){
      if(_names[i]){
        p+=", "+_names[i];
      }
    }
    if(p){
      p=p.substring(2);
    }
    if(_ref){
      return _ref
    }
    if(_parameter){
      p+=" ($parameter = "+_parameter+")"
    }
    if(p[0]==","){
      p=p.substring(1).trim()
    }
    return p;
  },
  _getExActionViewDef:function(_if){
    return {
      _if:_if,
      _tag:"div",
      _attr:{
        style:function(d,c,o){
          return "flex:1;display:block;margin:0;"
        },
        "class":"col-xs-12 bz-action-in-details"
      },
      _after:function(o){
        setTimeout(()=>{
          if(!o.innerText){
            o.style.display="none"
          }
        },10)
      },
      _items:[
        //loopData($action,$group)
        {
          _if:"_data._item.loopData",
          _tag:"div",
          _attr:{"class":"bz-pre-box","type-label":"_Util._formatMessage(_bzMessage._action._preScript,_data._item.type==7?'$group':'$action')"},
          _items:[
            {
              _tag:"pre",
              _attr:{"class":"bz-pre"},
              _text:"_data._item.loopData"
            }
          ],
          _jqext:{
            click:function(e){
              let _this=this
              setTimeout(()=>{
                 _testTabHandler._openTab("script",_this,e)
                 BZ._data._uiSwitch._showActionNote='_loopData'
              },100)
            }
          }
        },
        //Script
        {
          _if:"_data._item.script",
          _tag:"div",
          _attr:{"class":"bz-pre-box","type-label":"_bzMessage._action._script"},
          _items:[
            {
              _tag:"pre",
              _attr:{"class":"bz-pre"},
              _text:"_data._item.script"
            }
          ],
          _jqext:{
            click:function(e){
              _testTabHandler._openTab("main",this,e)
            }
          }
        },
        //Result Script
        {
          _if:"_data._item.resultscript",
          _tag:"div",
          _attr:{"class":"bz-pre-box","type-label":"_bzMessage._test._tab.resultscript"},
          _items:[
            {
              _tag:"pre",
              _attr:{"class":"bz-pre"},
              _text:"_data._item.resultscript"
            }
          ],
          _jqext:{
            click:function(e){
              _testTabHandler._openTab("script",this,e)
            }
          }
        },
        //Conditions
        {
        //condition
          _tag:"div",
          _after:function(o){
            setTimeout(()=>{
              if(!o.children.length){
                o.remove()
              }
            },10)
          },
          _jqext:{
            click:function(e){
              _testTabHandler._openTab("condition",this,e)
            }
          },
          _items:[
            {
              _if:function(d){
                return d._supData._item[d._item.toLowerCase()+"Parameter"]||d._supData._item[d._item.toLowerCase()+"Goto"]||d._supData._item['refOf'+d._item]&&(d._item!="Success"||d._supData._item.type!=4||(d._supData._item.refOfSuccess&&d._supData._item.refOfSuccess.match(/(^|\/)([swfec])(\/|$)/)))
              },
              _tag:"div",
              _attr:{
                style:"margin:5px 0 0 0;"
              },
              _items:[
                {
                  _tag:"div",
                  _attr:{"class":"bz-flex-all"},
                  _after:function(o){
                    setTimeout(()=>{
                      if(!o.children.length){
                        $(o).hide()
                      }
                    },10)
                  },
                  _items:[
                    {
                      _if:function(d){
                        let s=d._supData._item.refOfSuccess
                        return d._item!='Success'||d._supData._item.type!=4||(s&&s.match(/(^|\/)([swfec])(\/|$)/))||(d._supData._item.successGoto)
                      },
                      _tag:"span",
                      _after:function(o){
                        $(o.parentElement).show()
                      },
                      _items:[
                        {
                          _tag:"span",
                          _text:"_bzMessage._test._tab[_data._item.toLowerCase()]+': '"
                        },
                        //report result
                        {
                          _tag:"span",
                          _items:[
                            {
                              _tag:"span",
                              _attr:{
                                "class":function(d){
                                  return "bz-"+d._item.toLowerCase()+"";
                                }
                              }
                            },
                            {
                              _if:function(d){
                                let p=d._supData._item["refOf"+d._item]
                                p=p.match(/(^|\/)[sfecw](\/|$)/)
                                if(p){
                                  return !p[0].includes(d._item[0].toLowerCase())
                                }
                              },
                              _tag:"span",
                              _attr:{
                                "class":"bz-assign"
                              }
                            },
                            {
                              _if:function(d){
                                let p=d._supData._item["refOf"+d._item]
                                p=p.match(/(^|\/)[sfecw](\/|$)/)
                                if(p){
                                  return !p[0].includes(d._item[0].toLowerCase())
                                }
                              },
                              _tag:"span",
                              _attr:{
                                "class":function(d){
                                  let p=d._supData._item["refOf"+d._item].match(/(^|\/)[sfecw](\/|$)/)
                                  if(p){
                                    p=p[0].replace(/[\/]/g,"")
                                    switch(p){
                                      case "s":p="success";break;
                                      case "f":p="failed";break;
                                      case "e":p="error";break;
                                      case "w":p="warning";break;
                                      case "c":p="crash";break;
                                    }
                                    return "bz-"+p
                                  }
                                }
                              }
                            },
                          ]
                        }
                      ]
                    },
                    {
                      _if:"(_data._item!='Success'||_data._supData._item.type!=4)&&(_data._supData._item['refOf'+_data._item].match(/[\{m]/))",
                      _tag:"span",
                      _items:[
                        {
                          _tag:"span",
                          _attr:{
                            "class":"bz-assign"
                          }
                        },
                        {
                          _if:"_data._supData._item['refOf'+_data._item].match(/[m]/)",
                          _tag:"span",
                          _attr:{
                            "class":function(d){
                              let c="bz-assign "
                              let t=d._supData._item['refOf'+d._item]
                              t=_ideObjHandler._getDataByPath(t)
                              if(t){
                                c+="bz-"+t._data.type
                              }
                              return c
                            }
                          }
                        },
                      ]
                    },
                    {
                      _if:"(_data._item!='Success'||_data._supData._item.type!=4)&&(_data._supData._item['refOf'+_data._item].match(/[\{m]/))",
                      _tag:"a",
                      _attr:{
                        style:"'text-decoration: underline;overflow: hidden;white-space: nowrap;flex-shrink:200;direction:'+(_data._supData._item['refOf'+_data._item].match(/[\{]/)?'ltr':'rtl')"
                      },
                      _text:function(d){
                        return _ideActionManagement._getRefDesc(d._supData._item,"refOf"+d._item)||""
                      },
                      _jqext:{
                        click:function(){
                          let d=this._data
                          d=_ideObjHandler._getDataByPath(d._supData._item["refOf"+d._item])
                          BZ._setHash(d)
                        }
                      }
                    },
                    {
                      _if:function(d){
                        return d._supData._item["refOf"+d._item].match(/(^|\/)[\.]+(\/|$)/)
                      },
                      _tag:"span",
                      _attr:{
                        "class":"bz-assign "
                      }
                    },
                    {
                      _if:function(d){
                        return d._supData._item["refOf"+d._item].match(/(^|\/)[\.]+(\/|$)/)
                      },
                      _tag:"span",
                      _attr:{
                        "class":"_data._supData._item['refOf'+_data._item].includes('..')?'bz-break-test-box':'bz-next-action-box'"
                      }
                    },
                    {
                      _if:function(d){
                        return d._supData._item["refOf"+d._item].match(/(^|\/)[\.]+(\/|$)/)
                      },
                      _tag:"span",
                      _attr:{
                        style:"overflow: hidden;white-space: nowrap;direction: rtl;flex-shrink:200;margin-left:5px;"
                      },
                      _text:function(d){
                        d=d._supData._item["refOf"+d._item].match(/(^|\/)[\.]+(\/|$)/)
                        d=d[0].replace(/[\/]/g,"")
                        return _bzMessage._ref[d]
                      }
                    },
                    {
                      _if:function(d){
                        return d._supData._item[d._item.toLowerCase()+"Goto"]
                      },
                      _tag:"span",
                      _attr:{
                        style:"overflow: hidden;white-space: nowrap;",
                      },
                      _items:[
                        {
                          _tag:"span",
                          _attr:{
                            "class":"bz-assign"
                          }
                        },
                        {
                          _tag:"button",
                          _attr:{
                            "class":"bz-flag btn btn-icon"
                          }
                        },
                        {
                          _text:function(d){
                            return d._supData._item[d._item.toLowerCase()+"Goto"]
                          }
                        }
                      ]
                    }
                  ]
                },
                {
                  _if:function(d){
                    return d._supData._item[d._item.toLowerCase()+'Parameter']
                  },
                  _tag:"div",
                  _attr:{"class":"bz-pre-box","type-label":"_bzMessage._common._parameter"},
                  _after:function(o){
                    setTimeout(()=>{
                      if($(o.previousSibling).css("display")=="none"){
                        $(o).css({"margin-top":0})
                      }
                      $(".row-selected").click()
                    },10)
                  },
                  _items:[
                    {
                      _tag:"pre",
                      _attr:{"class":"bz-pre"},
                      _text:function(d){
                        d=d._supData._item[d._item.toLowerCase()+'Parameter']
                        if(d&&[Object,Array].includes(d.constructor)){
                          d=JSON.stringify(d,0,2)
                        }
                        return d
                      }
                    }
                  ]
                }
              ]
            }
          ],
          _dataRepeat:function(){
            let vs=["Success","Failed","Error"]
            let t=_IDE._data._curTest
            if(!t){
              t=BZ._data._uiSwitch._curGuiTest.t
            }else{
              t=t._data
            }
            if(t.type=="int"){
              vs=["Success"]
            }
            return vs
          }
        }
      ]
    }
  },
  _exeCurTask:function(a,_fun,_askData){
    if(!a||_ideTask._needLanuchApp(a)){
      if(!BZ.TW||BZ.TW.closed){
        return BZ._launchCurEnvUrl(undefined,function(){
          _ideActionManagement._exeCurTask(a,_fun,_askData)
        })
      }else{
        BZ.TW.blur()
        BZ.TW.focus()
      }
    }
    _extensionComm._setShareData({"_cooperatorHandler._data":_cooperatorHandler._data})
    _apiDataHandler._askUseTmpData(_askData,function(){
      var b;
      BZ._setStatus("play")
      if(!a){
        a=_IDE._data._curAction;
      }
      if(a&&a==_IDE._data._curAction){
        _ideDataManagement._cleanActionTmpData(_IDE._data._curModule._data,_IDE._data._curTest._data)
      }
      
      b=_CtrlDriver._buildProxy(_Util._clone(a));
      b._orgData=a;

      let t=BZ._getCurTest()
      if(t){
        t._result=t._result||[];
        t._result[t._data.actions.indexOf(a)]=0

        _ideTask._setting._fromAction=0
        _ideTask._setting._exeSingleAction=1

        _ideTask._initData(0,function(){
          _ideTask._loadData([t._parent._data.code,t._data.code],function(m,tt){
            _ideTask._putTestIntoQueue(m,tt)
            b._supData=_ideTask._data._taskQueue.shift()
            b._level=""
            b._path=location.hash.substring(1)
            _ideActionManagement._applyTmpValue()
            
            if(b._orgData&&b._orgData._idx!==undefined){
              b._idx=b._orgData._idx
            }else if(_IDE._data._curTest){
              b._idx=_IDE._data._curTest._data.actions.indexOf(_IDE._data._curAction)
            }else{
              b._idx=0
            }
            _aiVisitHandler._init()
            if(b.element){
              _bzDomPicker._flashTmpCover(b.element);
            }
            setTimeout(()=>{
              _doTest(b,1,0,_fun);
            },b.element?100:0)
          })
        })
      }else{
        _doTest(b,1,0,_fun);
      }
    })

    function _doTest(a,b,c,_fun){
      _ideTask._action._doTest(a,b,c,function(){
        _fun&&_fun();
        BZ._data._uiSwitch._apiResultTab="_result"
        _CtrlDriver._refreshData(BZ._data._uiSwitch,"_refreshAPIResult")
      });
    }
  },
  _applyTmpValue:function(a){
    if(!_ideTask._isExeSingleAction()){
      return
    }
    let _key=_IDE._getShortcutKey()
    let vs=_debugDataHandler._tmpValueList[_key]||{},oo={}
    if(vs.length){
      vs.forEach(x=>{
        try{
          let o;
          let n=x._name.split(".")
          n.forEach(y=>{
            if(!o){
              _Util._eval(`o=window.${y}||{}`)
            }else{
              o[y]=o[y]||{}
              o=o[y]
            }
          })
          _Util._eval(x._name+"=x._value",{x:x})
          oo[n[0]]=eval(n[0])
        }catch(e){}
      })
      
      _extensionComm._setShareData(oo)
    }
  },
  _updateActionCommentDesc:function(a){
    if(bzTwComm._isExtension()){
      bzTwComm._postToIDE({_fun:"_updateActionCommentDesc",_scope:"_ideActionManagement",_args:[a]});
    }else if(_IDE._data._curAction.type==_ideActionData._type._comment){
      _IDE._data._curAction.description=a.description;
      _ideTestManagement._save()
    }
  },
  _quickUpdateExpection:function(a){
    if(!a){
      a=_IDE._data._curAction;
    }
    if(a.method==_ideActionData._method._html){
      if(bzTwComm._isIDE()){
        bzTwComm._postToExt({_fun:"_quickUpdateExpection",_scope:"_ideActionManagement",_args:[a]})
      }else{
        _domActionTask._exeAction(a,{_force:1,_taskQueue:[]},function(){
          if(bzTwComm._isExtension()){
            BZ._formatInIFramePath(a.element)
            bzTwComm._postToIDE({_fun:"_updateAction",_scope:"_ideActionManagement",_args:[a]})
          }
        })
      }
    }
  },
  _getMissElement:function(d){
    if(_ideActionManagement._hasElement(d)){
      d=d.panel||d.element
      if(!d||!d.length){
        return "_element"
      }
      d=d[d.length-1]
      if(d!=0&&$.isNumeric(d)){
        return "_warn"
      }
    }
  },
  _getMissValue:function(d){
    if(d.apiReplaceEvent){
      return (!d.requests||!d.requests.length)&&"_requests"
    }
    //script
    if((!d.type && d.method==_ideActionData._method._script)||("23".includes(d.type))){
      return !d.script&&"_script";
    }
    //plugin
    if(d.type==4){
      var c=d.refOfSuccess&&d.refOfSuccess.match(_IDE._testKeyRegex)
      return (!c||!_ideObjHandler._getDataByPath(c[0]))&&(!d.refOfSuccess||!d.refOfSuccess.match(/\{\{.+\}\}/))
    }else if("02".includes(d.type)&&d.method==_ideActionData._method._data){
      if(!d.api||(!d.api.host&&(!d.api.httpURL||d.api.httpURL=="/"))){
        return "_url"
      }
    }
    
    if(!d.type){
      return (d.content &&["data"].includes(d.content.type)&&!d.expection&&!d.md5)&&"_expection"
    }else if(d.type==5&&!d.description){
      return "_description"
    }else if(d.type==9&&!d.data){
      return "_data"
    }
  },
  _getMissSetting:function(d){
    return _ideActionManagement._getMissElement(d)||_ideActionManagement._getMissValue(d)
  },
  _getDataStatus:function(d){
    var _msg=_ideActionManagement._getMissSetting(d);
    if(!_msg){
      return _ideActionData._dataStatus._ok;
    }else if(_msg=="_warn"){
      return _ideActionData._dataStatus._warning;
    }else{
      return _ideActionData._dataStatus._notReady;
    }
  },
  _hasElement:function(d){
    var tt=_ideActionData._type;
    return !d.apiReplaceEvent
           &&(((d.type==tt._validation ||d.type==tt._extractData) && d.method==_ideActionData._method._html)
           || d.type==tt._triggerEvent 
           || d.type==tt._comment
           || d.type==tt._visit
           || d.type==tt._fillForm);
  },
  _showMissingElement:function(s){
    if(bzTwComm._isExtension()){
      return bzTwComm._postToIDE({_fun:"_showMissingElement",_scope:"_ideActionManagement",_args:[s]});
    }
    if(_ideActionManagement._callBackMissingElementFun){
      _ideActionManagement._callBackMissingElementFun(s)
      _ideActionManagement._callBackMissingElementFun=0
    }else{
      var o=$(".bz-detail-element .bz-error")
      if(s&&o.css("display")=="none"){
        o.attr({"disabled":true})
      }else if(!s&&o.css("display")!="none"){
        o.hide()
        o.attr({"disabled":false})
      }
    }
  },
  _updateCurElementOnEditPath:function(_key,_this,_data){
    let g=_this._data._group(),
        _idx=_this._data._idx,_lastIdx
    let v=g[_idx]||"",
        dv=_this._viewDef._dataModel()
    dv=dv.replace(/\[[0-9]+\]$/,"")
    if(v){
      let ws=_ideActionManagement._splitElementBySpace(v)
      g.splice(_idx,1,...ws)
      _idx=""
      for(var i=g.length-1;i>=0;i--){
        let x=g[i]
        if($.isNumeric(x)){
          g.splice(i,1)
          _lastIdx=x
        }else if(x==""){
          g.splice(i,1)
        }else if(_idx===""){
          _idx=_lastIdx||0
        }
      }
      g.push(_idx||0)
    }else{
      g.splice(_idx,1)
    }
    _this._data._item=g[_this._data._idx]
      
    _Util._eval(dv+"=g")
    return _this._data._item

  },
  _splitElementBySpace:function(v){
    let km={
      '[':']',
      '{':'}',
      '(':')'
    },k,s="",w=[]
    
    for(let i=0;i<v.length;i++){
      let c=v[i]
      if(k==c){
        k=""
        s+=c
      }else if(c==" "&&!k){
        if(s){
          w.push(s)
        }
        s=""
      }else{
        k=k||km[c]
        s+=c
      }
    }
    if(s){
      w.push(s)
    }
    return w
  },
  _isSimplyRefData:function(v){
    return v&&v.constructor==String&&v.match(/^(\$project|\$module|\$test|\$loop|\$parameter)/)
  },
  _initMapParameterData:function(_curParameter,_doMap){
    //Get Ref-Test Parameters
    let p=_curParameter.split(".").pop().replace("Parameter","")
    p=_IDE._data._curAction["refOf"+p[0].toUpperCase()+p.substring(1)]
    p=p&&p.match(_IDE._testKeyRegex)
    if(p){
      p=p[0]
      p=_ideObjHandler._getDataByPath(p)
      if(p){
        p=_ideTestManagement._getRefDefParameterViewData(p._data.defParameter,p)
        for(var k in p){
          p[k]={_orgDefValue:p[k]}
        }
      }
    }
    
    if(!p){
      return
    }
    let vs={}
    let pp=_ideTestManagement._getFinalParameterData(_IDE._data._curTest._data.defParameter)
    pp=[{_path:"$parameter",_data:pp}]
    if($loop){
      pp.push({_path:"$loop",_data:$loop})
    }

    pp.forEach(v=>{
      if(v._data){
        if(v._data.constructor==Object){
          for(var k in v._data){
            vs[v._path+"."+k]=v._data[k]
          }
        }else{
          vs[v._path]=v._data
        }
      }
    })

    BZ._data._uiSwitch._mapRefParameterOptions=[]
    let _curData=_ideTestManagement._getDefParameterViewData(_curParameter)
    if(_ideActionManagement._isSimplyRefData(_curData)){
      try{
        d=_Util._eval("d="+_curData)
        _pickMapValue(p,d,vs,_curData)
      }catch(e){}
    }else if(_curData&&!_Util._isEmpty(_curData)){
      if(_curData&&_curData.constructor==Object){
        _pickMapValue(p,_curData,vs)
      }else{
        let vv=_Util._parseJSONWithRefDataToObj(_curData)
        vv.forEach(v=>{
          let k=v._key,x=v._value
          if(p[k]){
            p[k]._chk="on"
            p[k]._mapName=x.replace(/(^\"|\"$)/g,"")
            if(!vs[x]){
              vs[x]={_staticValue:1}
            }
          }
        })
      }
    }
    if(_doMap){
      if($loop){
        _pickMapValue(p,$loop,vs,"$loop")
      }else if($parameter){
        _pickMapValue(p,$parameter,vs,"$parameter")
      }
    }
    
    for(let k in vs){
      BZ._data._uiSwitch._mapRefParameterOptions.push({
        _name:k,
        _staticValue:vs[k]._staticValue,
        _value:!vs[k]._staticValue&&!vs[k]._new&&vs[k],
        _new:vs[k]._new||!vs[k]
      })
    }

    return p
    
    function _pickMapValue(p,o,vs,_rootPath){
      let ok=_Util._getDataKeyMap(o),
          pk=_Util._getDataKeyMap(p)
      
      for(let kk in ok){
        let k=pk[kk]
        if(k){
          p[k]._chk="on"
          if(!p[k]._mapName){
            if(_rootPath){
              p[k]._mapName=_rootPath+"."+ok[kk]
            }else if(v){
              p[k]._mapName=o[k]
            }
          }
        }
      }
    }
    
  },
  //_curParameter like = "_IDE._data._curAction.successParameter"
  _setParameterValue:function(k,_value,_curParameter){
    let vs=_ideTestManagement._getDefParameterViewData(_curParameter)
        
    if(vs.constructor==Object){
      if(_value.match(/^(\$parameter|\$loop)\./)){
        vs=JSON.stringify(vs,0,2)
        vs=JSON.stringify(vs,0,2).replace('"'+_value+'"',_value)
      }else{
        vs[k]=_value
        vs=JSON.stringify(vs,0,2).replace("\\"+_value.replace(/\"$/,"\\\""),_value.replace(/(^"|"$)/g,""))
        
        _Util._eval(_curParameter+"=vs",{vs:vs})
        
        return
      }
    }
    
    vs=_Util._parseJSONWithRefDataToObj(vs)
    let v=vs.find(x=>{
      return x._key==k
    })
    if(v){
      v._value=_value
    }else{
      vs.push({_key:k,_value:_value})
    }
    _ideActionManagement._generateStringParameterWithRefData(vs,_curParameter)
  },
  //Remove parameter map;
  _removeParameterValue:function(k,o,_curParameter){
    let v=o._mapName,vv;
    o._mapName=""
    delete o._mapName;

    if(v.includes("$parameter")){
      try{
        vv=_Util._eval("vv="+v)
      }catch(e){}

      if(!vv){
        delete $parameter[k]
      }
      _IDE._data._curTest._data.defParameter=JSON.stringify($parameter)
    }
    
    vs=_ideTestManagement._getDefParameterViewData(_curParameter)
    vs=_Util._parseJSONWithRefDataToObj(vs)
    vs.splice(vs.findIndex(vi=>{
      return vi._key==k
    }),1)
    _ideActionManagement._generateStringParameterWithRefData(vs,_curParameter)
  },
  _generateStringParameterWithRefData:function(vs,_curParameter){
    vs=_Util._refDataToJSON(vs)
    _Util._eval(_curParameter+"=vs",{vs:vs})
  },
  _getComDataFromElement:function(a){
    if(a.refCom&&BZ._isPlaying()){
      return a.refComParameter
    }
    if(!_Util._isEmpty(a.element)){
      let cm=_ideObjHandler._getDataByPath("com")||{_data:{tests:[]}}
      cm=cm._data
      a.element.find(x=>{
        if(x&&x.constructor==String){
          x=x.match(/^\:([a-z0-9]+)(\((.*)\))?$/i)
          if(x){
            return cm.tests.find(t=>{
              let k="com."+t.code
              if(t.name==x[1]&&a.refCom!=k){
                a.refCom=k
                a.refComParameter={
                  $fun:x[1],
                  $document:a.element[0].includes("BZ.TW.document")?a.element[0]:"BZ.TW.document",
                  $label:x[3],
                  $value:_Util._strToJson(a.event?a.event.value:(a.expection||{}))
                }
                return 1
              }
            })
          }
        }
      })
      return a.refComParameter
    }
  }
};window._ideDataBind={
  _data:(window._CtrlDriver&&_CtrlDriver._buildProxy({_suggestList:[],_key:"",_scope:"$parameter"}))||{_suggestList:[],_key:"",_scope:"$parameter"},
  value:0,
  _buildDefParameter:function(df,d){
    d=_Util._strToJson(d);
    if(!_Util._isEmpty(d)){
      let ks=Object.keys(df)
      if(d.constructor==Array){
        d.forEach(x=>{
          if(x.constructor==Object){
            _ideDataBind._buildDefParameter(df,x)
          }
        })
        return d
      }
      for(let k in d){
        if(!ks.includes(k)){
          df[k]=d[k]
        }
        let kk=_glossaryHandler._getVariableName(k)
        if(kk==k){
          d[k]=`{{$parameter.${k}}}`
        }else{
          d[k]=`{{$parameter["${k}"]}}`
        }
      }
    }
    return d
  },
  _buildParameterOptions:function(){
    if(_IDE._innerWin._data._dataBind._showDataBind&&_IDE._data._curTest){
      return [_ideDataBind._data._scope]
    }else{
      var vs=new Set(["$test","$module","$project"]);
      if($parameter){
        vs.add("$parameter")
      }
      if(window.$loop){
        vs.add("$loop");
      }
      return vs
    }
  },
  // _showMe:function(ee,_refresh){
    // if(BZ._autoRecording||!_IDE._data._curTest||_ideDataBind._autoFillTime){
      // return
    // }
    // if(_ideDataBind._lockFocusTime && Date.now()-_ideDataBind._lockFocusTime<1000 &&ee==_ideDataBind._lastInput){
      // return
    // }

    // var _document=ee?ee.ownerDocument:BZ.TW.document;
    // var e=ee||$(_document).find(":focus")[0];
    // if($(_document).find(".BZIgnore").find(e).length){
      // return 
    // }
    
    // if(!e || (!_refresh && _ideDataBind._curInput==e && $(_document).find(".bz-db-menu").length)){
      // return;
    // }
    // _ideDataBind._hideMe();
    // if(!_IDE._innerWin._data._dataBind._showDataBind||!_IDE._data._curTest){
      // return
    // }
    // if(!_ideDataBind._data._limit){
      // this._suggestPath=_ideDataBind._getBindData(e);
    // }
    // if(ee || BZ._isRecording()){
      // if(e.tagName!="SELECT" && _cssHandler._getParentSelect(e)){
        // return;
      // }
      // _ideDataBind._curInput=e;
      // this._data._filterWord=_domRecorder._typed?(e.value||""):""
      // try{
        // if(!_ideDataBind._data._limit){
          // this._suggestValue=eval(this._suggestPath);
          // this._suggestValue2=0
          // if(e.type=="checkbox"){
            // this._suggestValue="on"
            // this._suggestValue2="off"
          // }
        // }
      // }catch(ex){}
      // var r=e.getBoundingClientRect()
      // _ideDataBind._document=e.ownerDocument;
      // $(".BZIgnore.bz-db-menu").remove()
      // this._curUI=_CtrlDriver._execute(this,this._data,_ideDataBind._viewDef);
      
      // _setMenuPos()
      // if(bzTwComm._isExtension()){
        // setTimeout(function(){
          // _ideDataBind._setEventFun()
        // },100)
      // }
    // }
    
    // function _setMenuPos(_time){
      // setTimeout(function(){
        // var o=$(".bz-db-menu");
        // if(!o[0] && _document){
          // o=$(_document).find(".bz-db-menu");
        // }
        // if(!o[0]){
          // if(!_time){
            // _time=100
          // }else if(_time==100){
            // _time=1000
          // }else{
            // return
          // }
          // return _setMenuPos(_time);
        // }
        // var t=r.top+r.height;
        // var re=o[0].getBoundingClientRect();
        // if(t+re.height>window.innerHeight){
          // o.css({left:r.left+"px",top:(r.top-re.height)+"px"});
        // }else{
          // o.css({left:r.left+"px",top:t+"px"});
        // }
      // },_time||50);
    // }
  // },
  _filter:function(e){
    if(BZ._autoRecording){
      return
    }
    if(e==BZ.TW.document.body){
      if(_ideDataBind._curInput){
        _ideDataBind._curInput.focus()
      }
      return
    }
    _ideDataBind._curInput=e;
    if(_ideDataBind._curInput){
      this._data._filterWord=_ideDataBind._curInput.value||""
    }else{
      this._data._filterWord="";
    }
    if(bzTwComm._isExtension()){
      setTimeout(function(){
        _ideDataBind._setEventFun()
      },100)
    }
  },
  _getBindData:function(e,_chkExistDataOnly,_getPath){
    if(_Util._isHidden(e)&&(e.tagName!="INPUT"||!["checkbox","radio"].includes(e.type))){
      return
    }
    var ds=_cssHandler._findInputPath(e)||_cssHandler._findPath(e),_name;
    if(!ds){
      return;
    }
    _name=_descAnalysis._retrieveTextForElementPathItem(ds)
    if(!_name){
      if(e.type=="file"){
        _name=_bzMessage._common._file.toLowerCase()
      }else{
        return _ideDataBind._generateData(e);
      }
    }
    _ideDataBind._data._tmpName=_glossaryHandler._getVariableName(_name);
    
    var o,s=_ideDataBind._data._scope,p,vs;
    try{
      o=_Util._eval(s)
    }catch(ee){}
    if(!o){
      o={}
    }

    if(!_getPath&&(!_IDE._innerWin._data._dataBind._showDataBind||!_IDE._data._curTest||!BZ._isRecording())){
      return _ideDataBind._generateData(e,_name)
    }else{
      if(s=="$parameter"&&BZ._isPlaying()){
        return `$parameter.${_name}`
      }else{
        p=this._getBindDataName(o, _name,s,e,ds,_chkExistDataOnly)
      }
      if(p && p._path){
        return p._path;
      }
    }
  },
  _getBindDataName:function(o,n,_path,e,_elementPath,_chkExistDataOnly){
    var _best,p,_key=_ideDataBind._data._key,v;

    if(["$test","$module","$project"].includes(_path)&&_key){
      _path+="."+_key
      
      if(!o[_key]){
        o[_key]={}
      }else if(o[_key].constructor!=Object){
        return alert(_Util._formatMessage(_bzMessage._dataBind._keyExist,[_key]))
      }
      o=o[_key]
    }
    _best=_ideDataBind._getMatchData(o,n,_path,_chkExistDataOnly)
    if(_best){
      try{
        v=_Util._eval("v="+_best._path)
        if(v=="on"&&e&&e.type!="checkbox"){
          _best=0
        }else if(e&&e.tagName=="SELECT"){
          let _found
          for(var i=0;i<e.options.length;i++){
            if(e.options[i].text==v){
              _found=1
              break
            }
          }
          if(!_found){
            _best=0
          }
        }
      }catch(ex){}
    }
    if(!_best){
      _best={}
    }
    if(_best._path){
      if(_ideDataBind._registered(_best._path,_elementPath)==1){
        _best._path=0
      }
    }
    if(_chkExistDataOnly){
      return _best
    }
    if(!_best._path&&!_path.startsWith("$loop")&&(!_ideDataBind._autoFillTime||_ideDataBind._emptyScopeData)){
      _best._path=_path+"."+_ideDataBind._data._tmpName

      v=_ideDataBind._generateData(e,n)
      if(_key&&["$test","$module","$project"].includes(_path)){
        if(!o[_key]){
          o[_key]={}
        }
        o=o[_key]
      }
      o[_ideDataBind._data._tmpName]=v
    }
    return _best;
  },
  //o: data map, like: {first_name:"ws",last_name:"li"}
  //n:name, like: first name
  //ns: name words in array, like: ["first","name"]
  //_path: data path, like: $test or $test.data
  _getMatchData:function(o,n,_path){
    n=_glossaryHandler._removeIgnore(n)
    var _best,p,ns=_glossaryHandler._splitWord(n);
    
    for(var k in o){
      var v=o[k];
      if(v===null||v===undefined){
        v=""
      }
      if(v.constructor==Object){
        p=this._getMatchData(v,n,_path+"."+k);
      }else if(v.constructor!=Array){
        p=_glossaryHandler._getSimilarityRate(n,k,ns)
      }else{
        continue;
      }
      
      if(!_best || (p && p._size && ((p._type <_best._type) || (p._type==_best._type && p._size>_best._size)))){
        _best=p;
        
        if(!p._path && p._size){
          
          var _bind=p._type==1||p._size>n.length/2;
          if(!_bind){
            var ks=_glossaryHandler._splitWord(k);
            _bind=1
            for(var i=0;i<ks.length;i++){
              if(!ns.includes(ks[i].toLowerCase())){
                _bind=0
                break;
              }
            }
          }
          if(_bind){
            if(p._type==1||k.length<=n.length+3){
              p._path=_path?_path+"."+k:k;
            }
          }
        }
      }
    }
    return _best
  },
  _generateData:function(e,n){
    if(e.dataset.bz){
      let bz=_aiFlagHandler._parseBZFlag(e.dataset.bz)
      let bzv;
      bz.find(x=>{
        bzv=x["$scan-data"]
        return bzv
      })
      
      if(!bzv){
        bz.find(x=>{
          if(x.$field){
            bzv=x.$field["$scan-data"]
            return bzv
          }
        })
      }
      if(bzv){
        return bzv.value&&bzv.value[0]
      }
    }
    var v=_cssHandler._getCustomizeInputCss(e)||_aiPageHandler._getFormat("text","string")
    if(v._head){
      return "*"
    }else if(e.tagName=="INPUT"){
      if(v.constructor!=String||_cssHandler._isOnCustomizePanel(e)){
        return ""
      }
    }
    if(e.tagName=="SELECT"){
      v=_aiFlagHandler._getErgodicValue(e)
      if(v!==undefined){
        return v
      }
      if(e.selectedOptions&&e.selectedOptions[0]&&e.selectedOptions[0].value&&!["0","none"].includes(e.selectedOptions[0].value)){
        v=e.selectedOptions[0].text
      }else{
        for(var i=0;i<e.options.length;i++){
          if(e.options[i].value&&!["0","none"].includes(e.options[i].value)){
            v=e.options[i].text
            break
          }
        }
      }
    }else if(e.type=="checkbox"){
      v="on"
    }else if(e.type=="radio"){
      return e.value
    }else if(!_Util._isInContentEditable(e)&&!_Util._isStdInputElement(e)){
      let ev= _aiFlagHandler._getErgodicValue(e)
      if(!ev){
        ev="/{random}/"
      }
      return ev
    }else{
      if(e.value){
        v=e.value
      }else if(e.type=="file"){
        let f=_Util._getAcceptFileType(e)
        if(!_domRecorder._uploadFileTypes.includes(f)){
          f="png"
        }
        v=SERVER_HOST+"/file/example."+f
      }else{
        if(e.type=="number"){
          v="/{random:1-10}/"
        }else if(n){
          let nn=_aiWordHandler._findKeyWordInWords(n)
          if(nn._dicDefine){
            v=nn._dicDefine.regex||v
          }
        }else{
          return _aiPageHandler._getFormat("text","string")
        }
        v=$util.generateWordsByRegex(v,n)
      }
    }
    return v
  },
  // _hideMe:function(e){
    // if(_ideDataBind._autoFillTime){
      // return
    // }
    // if(e){
      // _ideDataBind._lastInput=e
      // _ideDataBind._lockFocusTime=Date.now()
      // setTimeout(function(){
        // if(_ideDataBind._autoFillTime){
          // _ideDataBind._doFillForm(_ideDataBind._autoFillTime)
        // }else{
          // e=_Util._focusNextInput(e)
          // if(e && e.tagName!=="BUTTON"){
            // _ideDataBind._showMe(e)
          // }else{
            // _ideDataBind._hideMe()
          // }
        // }
      // },500)
    // }else{
      // $(".BZIgnore.bz-db-menu").remove()
      // _ideDataBind._curInput=0
    // }
  // },
  _insertBindInfo:function(e,w){
    w=_Util._formatMessage(_bzMessage._dataBind._bindDataInfo,[w])
    var r=e.getBoundingClientRect()
    var o=$("<div style='background-color:#FFF;padding:5px;font-size:13px;z-index:10000000000000000;border:1px solid #999;border-radius:5px;position:fixed;left:"+r.left+"px;top:"+(r.top-25)+"px;'>"+w+"</div>").insertAfter(BZ.TW.document.body)
    setTimeout(function(){
      o.remove()
    },3000)
  },
  //c: code
  _registerData:function(c,p){
    _ideDataBind._dataMap=_ideDataBind._dataMap||{}
    if(_ideDataBind._dataMap._test!=_IDE._data._curTest._data.code){
      _ideDataBind._dataMap._test=_IDE._data._curTest._data.code
      _ideDataBind._dataMap._data={}
    }
    _ideDataBind._dataMap._data[c]=p
  },
  //return 0: not register yet, 1: registered by other element, 2: registered by the element
  _registered:function(c,p){
    if(_ideDataBind._dataMap&&_ideDataBind._dataMap._test==_IDE._data._curTest._data.code){
      var o=_ideDataBind._dataMap._data[c];
      return !o?0:o==p?2:1
    }
  },
  _bindDataOnElement:function(a,_field){
    if(BZ._autoRecording||!_IDE._data._curTest){
      return
    }
    if(_field=="element"){
      _field=a.element
    }else{
      _field=a.event.target
    }
    if(_field && _IDE._innerWin._data._dataBind._showDataBind&&_IDE._data._curTest){
      
      for(var ii=0;ii<_field.length;ii++){
        var v=_field[ii];
        
        if(!v.match){
          return;
        }
        var vv=v.match(/\:(near|text|input|data|panel|contains|Contains|textElement|after|before|endContains|endEqual|equal|RowCol|rowcol)\((.+)\)/);
        if(vv){
          var vvv=_ideDataBind._insertCode(vv[2]);
          if(vvv){
            v=v.substring(0,vv.index)+":"+vv[1]+"("+vvv+")"+v.substring(vv.index+vv[0].length);
            _field[ii]=v;
            continue;
          }
        }else{
          //vv=v.match(/\[(title|placeholder|name|label)([\*\=\"\']+)(.+)[\"\']+/);
          vv=v.match(new RegExp("\\[("+_IDE._data._curVersion.setting.content.contentAttribute+")([\\*\\=\\\"\\']+)(.+)[\\\"\\']+"));
          if(vv){
            var vvv=_ideDataBind._insertCode(vv[3]);
            if(vvv){
              v=v.substring(0,vv.index)+"["+vv[1]+vv[2]+vvv+vv[4];
              _field[ii]=v;
              continue;
            }
          }else{
            if(!vv && (!_field[ii+1] || !_field[ii+1].match)){
              vv=v.match(/#([^.\[:]*)/);
              if(vv){
                var vvv=_ideDataBind._insertCode(vv[1]);
                if(vvv){
                  v=v.substring(0,vv.index)+"#"+vvv+v.substring(vv.index+v[0].length);
                  _field[ii]=v;
                  continue;
                }
              }
            }
          }
        }
      }
    }
  },
  _bindValidationData:function(e,s){
    s=s||"";
    if(curUser._curProject.setting.autoDataBind||(_IDE._innerWin._data._dataBind._showDataBind&&_IDE._data._curTest)){
      for(var i=0;i<e.childNodes.length;i++){
        var n=e.childNodes[i];
        if(n.nodeType==3){
          var t=_Util._pickTextFromNode(e.childNodes,i);
          i=t.i
          n=_ideDataBind._findDataPath(t.t);
          if(n && !s.includes(n)){
            s+=n
          }
        }else if(n.nodeType==1){
          s=_ideDataBind._bindValidationData(n,s);
        }
      }
      var vs=$(e).find("INPUT,SELECT,TEXTAREA")
      for(var i=0;i<vs.length;i++){
        v=vs[i];
        if(!["checkbox","radio"].includes(v.type) || v.checked){
          n=_ideDataBind._findDataPath(v.value);
          if(n && !s.includes(n)){
            s+=n
          }
        }
      }
    }
    
    return s;
  },
  _insertCode:function(w){
    var vs=_ideDataBind._buildParameterOptions();
    for(let p of vs){
      var o=_Util._eval("o="+p);
      var vv=_doIt(w,o,p);
      if(vv!=w){
        return vv
      }
    }
    function _doIt(ww,v,p){
      var rp="";
      if(!ww||!v||((v+"").length<3&&!ww.split(/ |\|/).includes(v))){
        return ""
      }else if(v==ww){
        rp= "{{"+p+"}}";
      }else if(v.constructor==Object){
        for(var k in v){
          var pp=_doIt(ww,v[k], p+"."+k);

          var _idx=pp.lastIndexOf("}}")
          if(_idx && ww!=pp){
            rp+=pp.substring(0,_idx+2);
            ww=pp.substring(_idx+2)
          }
        }
        if(rp){
          rp+=ww
        }
      }else if(v && ![Array,Function].includes(v.constructor)){
        try{
          rp=_Util._replaceWord(ww,v,"{{"+p+"}}")
        }catch(e){
        }
      }
      return rp||ww
    }
  },
  //w: word
  _findDataPath:function(w){
    var vs=_ideDataBind._buildParameterOptions();
    for(let p of vs){
      var o=_Util._eval(p);
      var vv=_doIt(w,o,p);
      if(vv){
        return vv
      }
    }

    function _doIt(w,v,p){
      var cs=""
      if(!w||!v){
        return
      }
      if(v.constructor!=Object && w.includes(v)){
        return p;
      }else if(v.constructor==Object){
        for(var k in v){
          if(k&&(v[k]||v[k]===0)){
            if(v[k].constructor==Array&&!v[k].length){
              continue
            }
            var pp=_doIt(w,v[k], p+"."+k);
            if(pp){
              cs+=pp+"\n";
            }
          }
        }
        return cs
      }
    }
  },  
  _bindEvent:function(_code,_value,_afterAutoFill){
    var e=_ideDataBind._curInput,_orgCode=_code,n,_sendAction;
    var d=_cssHandler._findPath(e,1);

    if(_code){
      if(_ideDataBind._data._replaceKeyByParameter && _ideDataBind._data._key){
        _code=_code.replace("[$parameter]","."+_ideDataBind._data._key)
      }
      _ideDataBind._insertBindInfo(e,_code)
      n="{{"+_code+"}}";
    }else if(_value==e.value&&e.tagName=="INPUT"){
      _sendAction=1
    }
    var a={
      element:d._elementPath,
      css:d.W,
      event:{type:_Util._isInContentEditable(e)?"blur":"change",autoBlur:"on",value:_value},
      type:1,
      bindData:""
    };
    if(e._requestErgodicList){
      a._requestErgodicDom=e
    }
    if(_value&&_value.length>2&&_code){
      _ideDataBind._registerData(_code,d._elementPath);
    }
    if(_domRecorder._lastAction && ["change","key"].includes(_domRecorder._lastAction.event.type) && _domRecorder._lastElement==e){
      _domRecorder._lastBindElement=0
      if(bzTwComm._isExtension()){
        if(_domRecorder._lastAction.event.type=="change"){
          _domRecorder._lastAction.event.value=n||_value;
        }else{
          _domRecorder._lastAction.event.groupKeys=n||_value;
        }
        _domRecorder._lastAction.event.tmpValue=_value;
        _domRecorder._lastAction.replace=_ideDataBind._data._replaceKeyByParameter;
        BZ._formatInIFramePath(_domRecorder._lastAction.element)

        bzTwComm._postToIDE({_fun:"_updateAction",_args:[_domRecorder._lastAction],_scope:"_ideActionManagement"});
        var $d=_code.startsWith("$test")?$test:_code.startsWith("$module")?$module:_code.startsWith("$project")?$project:$parameter||{};
        _code=_code.split(".");
        if(_code.length>1 && _code.length<4){
          if(_code.length==3){
            if(!$d[_code[1]]){
              $d[_code[1]]={}
            }
            $d=$d[_code[1]];
          }
          $d[_code[_code.length-1]]=_value;
        }
        _ideDataBind._data._scope=_code[0]
        if(_code.length>2){
          _ideDataBind._data._key=_code[1]
        }
      }else{
        _ideActionManagement._buildInputBindData(_domRecorder._lastAction,n,_value,_ideDataBind._data._replaceKeyByParameter)
      }
      setTimeout(function(){
        e.bzReady=1
      },10)
      _domRecorder._lastAction=0
      _domActionTask._curValueDataBind=0;
      // _ideDataBind._hideMe(e)
      if(_afterAutoFill){
        setTimeout(function(){
          _afterAutoFill()
        },1000)
      }
      return 
    }else if(_domRecorder._lastBindElement==e){
      if(!_domRecorder._lastBindElement2){
        _domRecorder._lastBindElement2=e
        a.event.type="key"
        a.event.action="group"
        a.event.groupKeys=_value
        delete a.event.value
      }else{
        _domRecorder._lastBindElement2=0
        return alert(_bzMessage._dataBind._bindFailed)
      }
    }

    _domRecorder._lastAction=0
    _domRecorder._lastElement=0
    if(_Util._isInContentEditable(e)||(e.type=='checkbox'&&((e.checked&&_value&&_value!="off")||(!e.checked&&(_value=="off"&&!_value))))){
      var ppp={
        _element: e,
        _type: 1,
        _paths: d._elementPath,
        _orgPath:d,
        css:d.W,
        _action: "change",
        _value: n||_value,
        _time: Date.now(),
        _tmpUrl: location.href
      }
      _domRecorder._addData(ppp);
      if(e.type!="checkbox"){
        e.innerHTML=_value
      }
      _domActionTask._curValueDataBind=0;
      if(_afterAutoFill){
        setTimeout(function(){
          _afterAutoFill()
        },1000)
      }
      return
    }else{
      _domActionTask._curValueDataBind=n;
      var _noTrigger=0

      return _domActionTask._trigger(a,function(r){
        if(r._customizeInputAction){
          if(_code){
            _Util._eval(_code+"=r._customizeInputAction._value")
            _code="{{"+_code+"}}"
            r._customizeInputAction._orgPath.event.value=_code
          }
          _domRecorder._addData(r._customizeInputAction);
          if(_code){
            _aiDataUpdateHandler._bindAndGenerateData(_code,r._customizeInputAction._value)
          }
          if(_afterAutoFill){
            setTimeout(function(){
              _afterAutoFill(r)
            },500)
          }
        }else if(_code){
          if(e.tagName=="INPUT"&&["checkbox","radio"].includes(e.type)){
            a.event.value=_code="{{"+_code+"}}"
            if(!bzTwComm._isExtension()){
              _ideActionManagement._addItem(a);
            }else{
              //Call background to set back recording action
              _domRecorder._sendData(a)
            }
            _aiDataUpdateHandler._bindAndGenerateData(_code,_value)
            // setTimeout(function(){
              // _ideDataBind._hideMe(e)
            // },100)
            if(_afterAutoFill){
              setTimeout(function(){
                _afterAutoFill(r)
              },1000)
            }
            return
          }
          _domRecorder._lastBindElement=e
          _ideDataBind._bindEvent(_orgCode,_value,_afterAutoFill)
        }else if(_afterAutoFill){
          if(_sendAction){
            if(!bzTwComm._isExtension()){
              _ideActionManagement._addItem(a);
            }else{
              //Call background to set back recording action
              _domRecorder._sendData(a)
            }
          }
          setTimeout(function(){
            _afterAutoFill(r)
          },e.tagName=="SELECT"||["checkbox","radio"].includes(e.type)?200:100)
        }
        
      });
    }
  },
  _setEventFun:function(){
    // _Util._setFun(".bz-db-menu .bz-db-close-btn","onmouseover",function(){
      // _ideDataBind._closeTime=setTimeout(function(){
        // _ideDataBind._hideMe();
      // },500)
    // });
    // _Util._setFun(".bz-db-menu .bz-db-close-btn","onclick",function(){
      // _ideDataBind._hideMe();
      // clearTimeout(_ideDataBind._closeTime)
    // });
    _Util._setFun(".bz-db-menu .bz-db-close-btn","onmouseout",function(){
      clearTimeout(_ideDataBind._closeTime)
    });
    _Util._setFun(".bz-db-menu-item a.bz-db-item-value","onclick",function(){
      _ideDataBind._bindEvent(this._data._item.p,this._data._item.v)
    });
    _Util._setFun(".bz-db-menu-item a.bz-db-item-value2","onclick",function(){
      _ideDataBind._bindEvent(this._data._item.p,'off')
    });
    // _Util._setFun(".bz-skip","onclick",function(){
      // _ideDataBind._hideMe(_ideDataBind._curInput)
    // });
  },
  _autoFill:function(){
    // _ideDataBind._hideMe()
    _ideDataBind._data._inSelectFillField=0
    var p=_ideDataBind._data._scope,d;
    if(!_IDE._innerWin._data._dataBind._showDataBind||!_IDE._data._curTest){
      return _ideDataBind._autoFillContinue()
    }else{
      _ideDataBind._emptyScopeData=1;
      _ideDataBind._doFillForm();
    }
  },
  _getCurBindData:function(){
    return _Util._eval(_ideDataBind._getCurBindDataPath())
  },
  _getCurBindDataPath:function(){
    var s=_ideDataBind._data._scope,
        k=_ideDataBind._data._key;
    if(s!="$parameter"&&s!="$loop"&&k){
      s+="."+k
    }
    return s
  },
  _autoFillContinue:function(){
    if(_ideDataBind._data._inSelectFillField){
      _ideDataBind._data._inSelectFillField=0
      if(bzTwComm._isExtension()){
        bzTwComm._postToIDE({_fun:"_updateData",_scope:"_aiDataUpdateHandler",_args:[{_data:_ideDataBind._getCurBindData(),_path:_ideDataBind._getCurBindDataPath()}]});
        return setTimeout(function(){
          _doIt()
        },100)
      }
    }
    _doIt()
    function _doIt(){
      _bzDomPicker._removeTmpCover()
      _ideDataBind._doFillForm()
    }
  },
  _getFillableFields:function(){
    var vs=$(BZ.TW.document).find("INPUT,TEXTAREA,SELECT,[contenteditable=true]");
    var os=[];
    for(var i=0;i<vs.length;i++){
      var v=vs[i];
      if(!["button","submit","reset","image","hidden","file"].includes(v.type)&&!_Util._isHidden(v)&&!$(v).attr("readonly")&&!$(v).attr("disabled")){
        os.push(v);
      }
    }
    return os
  },
  _generateFillFormActionData:function(a,_fun){
    if(bzTwComm._isIDE()){
      bzTwComm._postToExt({_fun:"_generateFillFormActionData",_scope:"_ideDataBind",_element:a.element,_args:[a,_fun]});
      return
    }
    let _element=$util.findDom(a.element)
    let ds=[],_css=_cssHandler._getActionMsgCss(a);
    if(_element){
      let os=_cssHandler._findAllInputs(_element,1)
      
      os.forEach((o,i)=>{
        if(o.type=="radio"&&!o.checked){
          return
        }
        let d=_ideDataBind._getInputData(o)
        if(d){
          ds.push({key:d._name})
        }
      })
    }
    _fun(ds)
  },
  _getInputData:function(o){
    let d=_cssHandler._findPath(o,0,3),v="",ds={};
    // if(!d.W||!d.W.LL){
      // return
    // }
    let _name=_descAnalysis._retrieveTextForElementPathItem(d)
    //ds._name=_glossaryHandler._getVariableName(_name)
    ds._name=_name
    if(["INPUT","TEXTAREA"].includes(o.tagName)){
      if(o.type=="checkbox"){
        if(o.checked){
          v="on"
        }
      }else if(o.type=="radio"){
        v=o.value
        ds._name=o.name
      }else{
        v=o.value
      }
    }else if(o.tagName=="SELECT"){
      v=o.selectedOptions[0].text
    }else if(o.contentEditable){
      v=o.innerHTML
    }
    ds._value=v
    return ds
  },
  _doFillForm:function(t,_scope,_noBindData,_fun){
    const _time=_ideDataBind._autoFillTime=t||Date.now();
    var _last=0,bzTmp2,
        vs=[],ls;
    let _allNew=[],
        _lastEnableList,
        _lastDisabledList

    let _observer=_buildObserver(_scope),_dependences=[];

    _doBind()

    function _doBind(_waiting){
      if(_TWHandler.BZ_sent){
        return setTimeout(function(){
          _doBind(_waiting)
        },100)
      }
      if(_last){
        if(!_last.bzReady){
          return setTimeout(function(){_doBind(_waiting)},100)
        }
      }
      // _ideDataBind._hideMe()
      _aiFlagHandler._assignFlagByScript()

      let ns=_cssHandler._findAllInputs(_scope),o=0,i;
      
      if(_fun){
        ns.forEach(x=>{
          _aiFlagHandler._setFieldInfo(x)
        })
      }
      o=ns.find(x=>{
        if(x.bzFillTime!=_time){
          if(x._failedTime&&x._failedTime>_time){
            x.bzFillTime=_time
            return
          }
          x.bzFillTime=0
          
          if(!_aiFlagHandler._hasNextErgodicValue(x)){
            x.bzFillTime=_time;
            if(vs.includes(x)){
              return
            }
            if(_isNew(x)){
              let v=vs.find(v=>{
                return _Util._isSameElement(v,x)
              })
              if(v){
                if(v==_last){
                  _last=x
                }
                vs.push(x)
                return 
              }
            }
          }
          return !(_Util._isHidden(x)||$(x).attr("readonly")||$(x).attr("disabled"))
        }
      })

      if(_last){
        _handleDependences(_last,o,ls,vs,ns)
      }
      ls=ns

      if(o){
        if(_last){
          _last.bzReady=0
        }
        
        _last=o;
        
        var p=_ideDataBind._getBindData(o),v;
        if(p!==undefined){
          try{
            _ideDataBind._curInput=o;
            bzTmp2=o.bzTmp
            o._setValues=o._setValues||new Set()

            o._setValues.add(_Util._getInputValue(o))
            o.bzReady=1
            vs.push(o);
            if(!_IDE._innerWin._data._dataBind._showDataBind||!_IDE._data._curTest||!BZ._isRecording()){
              v=p
              _ideDataBind._bindEvent(0,v,function(r){
                if(v=="/{random}/"&&o._ergodicValueList){
                  o._value=o._ergodicValueList[o._ergodicIdx]
                }else{
                  o._value=v
                }
                o._value=v
                if(r&&r._type!=4){
                  o._failedTime=Date.now()
                }
                _doBind(o)
              });
            }else{
              v=_Util._eval(p);
              if(!v&&o.type=='radio'){
                o.bzReady=1
                return _doBind(o)
              }
              _ideDataBind._bindEvent(p,v,function(){
                _doBind(o)
              });
            }
            return
          }catch(e){}
        }else{
          o.bzReady=1
        }
        _doBind(o)
      }else{
        _ideDataBind._autoFillTime=0;
        _end()
        if(_fun){
          return 
        }

        if(vs.length){
          if(_last){
            _last.bzReady=0
          }
          _bzDomPicker._showTmpCover(vs,2);
          _ideDataBind._emptyScopeData=0
          setTimeout(function(){
            _bzDomPicker._removeTmpCover();
            vs.length=0
          },2000)
          if(bzTwComm._isExtension()){
            bzTwComm._postToIDE({_fun:"_setInAutoFill",_scope:"_ideTestManagement",_args:[1]});
          }else{
            _ideTestManagement._setInAutoFill(1)
          }
        }else{
          alert(_bzMessage._dataBind._noData)
        }
        // _ideDataBind._hideMe()
      }
    }
    
    function _isNew(o){
      return _allNew.find(x=>{
        return x==o||$(x).find(o)[0]
      })
    }
    //ls: last input list,
    //vs: already did list
    //ns: current input list
    function _handleDependences(e,o,ls,vs,ns){
      let d={
        _oprElement:e,
        _value:_getValue(),
        _newElements:o?ns.filter(x=>!_existInList(ls,x)&&!_existInList(vs,x)):[],
        _removed:ls.filter(x=>!_existInList(ns,x)&&x!=e),
        _removedDependency:_last?{
          _field:_last,
          _values:_last._setValues?[..._last._setValues]:[]
        }:{}
      },_enableList=[],_disableList=[]

      d._newElements=d._newElements.filter(x=>!x.disabled);

      ns.forEach(x=>{
        if(x.disabled||x.readonly){
          _disableList.push(x)
        }else{
          _enableList.push(x)
        }
      });
      if(_lastEnableList){
        _enableList.forEach(x=>{
          if(!_lastEnableList.includes(x)){
            if(ls.includes(x)&&!d._newElements.includes(x)){
              d._newElements.push(x)
            }
          }
        });
        _disableList.forEach(x=>{
          if(!_lastDisabledList.includes(x)&&!d._removed.includes(x)){
            d._removed.push(x)
          }
        })
      }

      _lastEnableList=_enableList
      _lastDisabledList=_disableList

      _dependences.push(d)
      function _getValue(){
        if(e.tagName=="INPUT"&&e.type=="checkbox"){
          return e.checked
        }
        return e._value
      }
    }
    
    function _existInList(_list, v){
      return _list.find(x=>x==v||(x.bzShortCut&&v.bzShortCut&&x.bzShortCut._key==v.bzShortCut._key))
    }
    
    function _end(){
      _observer.disconnect();
      _fun&&_fun(_dependences)
    }
    
    function _buildObserver(_scope){
      let _observer=new MutationObserver(function(_mutations) {
        _mutations.forEach(m=>{
          let a=m.addedNodes[0]
          if(a&&a.nodeType==1){
            _allNew.push(a)
          }
        })
      })
      
      _observer.observe(BZ.TW.document.body,{
        childList:true,
        subtree:true,
        characterData: true,
        attributes:true,
        attributeFilter: ['style','class'],
        attributeOldValue:true
      });
      return _observer
    }
  }
};/*
  For get customer app info from extension
*/
window.bzTwComm={
  _reloadInfo:[],
  _tmpId:Date.now(),
  _list:[],_exeList:[],
  _doing:0,
  appReady:window.name.includes("bz-master"),
  //_world,_frameId,d,ev, _scope, _fun, _args, bktg, _bkfun, _bkscope
  // tg (target):
  //    1, app: page, 
  //    2, ext: extension
  //    3, ide: 
  // frameId:0: top, element path: iframe, *: all
  // operation options:
  //    1, d: to set data
  //    2, ev: to eval script
  //    3, scope, fun, args
  // bt (callback target): bt
  // _bkscope (callback function scope)
  // _bkfun (callback function): 
  //    1, Function
  //    2, script
  // _async:
  _postRequest:function(v){
    if(bzTwComm._isIDE()&&BZ._closed){
      return
    }
    v.org=JSON.stringify(v)
    if(bzTwComm._list[bzTwComm._list.length-1]&&bzTwComm._list[bzTwComm._list.length-1].org==v.org){
      return
    }
    bzTwComm._list.push(v)
    if(!bzTwComm._getExtensionId()){
      console.log("BZ-LOG:Missing extension id")
    }else if(!bzTwComm.ideId){
      console.log("BZ-LOG:Missing ide id")
    }else if(!bzTwComm.appId&&bzTwComm._isExtension()){
      console.log("BZ-LOG:Missing app id")
    }else{
      return _doIt()
    }

    return setTimeout(()=>{
      _doIt()
    },100)

    function _doIt(){
      if(bzTwComm._doing){
        return
      }
      bzTwComm._doing=v=bzTwComm._list.shift()
      if(!v){
        return
      }
      let vv=v
      v.bz=1
      v.bktg=bzTwComm._getWorld()
  
      let k,_ckTimer
      v._args=v._args||[]
      try{
        v._bkfun=v._bkfun||v._args.find(x=>x&&x.constructor==Function)
        if(v._bkfun&&v._bkfun.constructor==Function){
          let _idx=v._args.indexOf(v._bkfun)
          let f=v.bktg+bzTwComm._newId()
          let ff=v._bkfun
          window[f]=function(){
            clearTimeout(_ckTimer)
            delete window[f]
            ff(...arguments)          
          }
          v._bkfun=f
          if(_idx>=0){
            v._args[_idx]=f
          }
          if(v._ckTimer){
            _ckTimer=setTimeout(()=>{
              if(window[f]){
                delete window[f]
              }
            },v._ckTimer)
          }
        }

        if(bzTwComm._isIDE()){
          v.toId=bzTwComm.appId
          v.fromId=bzTwComm.ideId
        }else{
          v.toId=bzTwComm.ideId
          v.fromId=v.appId
          v.fromFrameId=bzTwComm.frameId
        }
        if(bzTwComm._isIDE()){
          return chrome.runtime.sendMessage(bzTwComm._getExtensionId(), v,r=>{
            if(!r){
              console.log("Missing response: "+r)
              console.log(vv)
            }

            bzTwComm._doing=0
            _doIt()
          });
        }else if(bzTwComm._isExtension()&&(v.tg=="ide"||v.tg=="bg")){
          chrome.runtime.sendMessage(v,r=>{
            if(!r){
              console.log("Missing response: "+r)
              console.log(vv)
            }
            bzTwComm._doing=0
            _doIt()
          });
          return
        }
        k=bzTwComm._isExtension()?"app":"ext"
        document.documentElement.setAttribute("bz-to-"+k+"-"+bzTwComm._newId(),JSON.stringify(v))
        bzTwComm._doing=0
        _doIt()
      }catch(ex){
        if(ex.message=="extension context invalidated"){
          console.log(ex.message)
          return
        }
        window.createErrMark&&window.createErrMark("Post data error")
        console.log(ex.stack)
        bzTwComm._list.unshift(vv)
        bzTwComm._doing=0
        _doIt()
      }
    }
  },
  _addFailActionInfo:function(a){
    let t=BZ._getCurTest()
    let o=bzTwComm._reloadInfo[bzTwComm._reloadInfo.length-1]
    if(o){
      o._failedTime=Date.now()
      o._failedTest=_IDE._getShortcutKey(".",t)
      o._failedAction=t._data.actions.indexOf(a)
    }
  },
  touchIDE:function(){
    if(!BZ._closed){
      let t=BZ._getCurTest(),
          a=_IDE._data._curAction
      bzTwComm._reloadInfo.push({
        _reloadTime:Date.now(),
        rt:t?_IDE._getShortcutKey(".",t):"",
        ra:a?t._data.actions.indexOf(a):-1
      })
      console.log("BZ-LOG: reload data for background")
      _extensionComm._setStartScript()
      _extensionComm._setShareData()
      chrome.runtime.sendMessage(bzTwComm._getExtensionId(),{status:BZ._data._status},r=>{})
      chrome.runtime.sendMessage(bzTwComm._getExtensionId(),{bzCode:1},r=>{})
      return {ideId:bzTwComm.ideId,appId:bzTwComm.appId}
    }
  },
  resendAction:function(){
    let d=_ideTask._exeActionBKFunParameters
    if(d&&d._data.exeTime&&d._fun=="_app"){
      console.log("BZ-LOG: redo action for load page issue")
      clearTimeout(_ideTask._retryTimer)
      _ideTask._retryTimer=0
      _ideTask._action._runAction(d._data,d._force,d._backFun)
    }else{
      if(d){
        console.log("BZ-LOG: exeActionBKFunParameters: "+d.exeTime+","+d._fun+","+d._data.runInIDE+","+d._data.description)
      }
      console.log("BZ-LOG: no action, app page ready: "+_extensionComm._pageReady)
    }
  },
  _newId:function(){
    return bzTwComm._tmpId++
  },
  setAppInfo:function(d){
    if(bzTwComm._isIDE()){
      delete d.frameId
    }
    Object.assign(bzTwComm,d)
  },
  _getWorld:function(){
    return bzTwComm._world=bzTwComm._world||(bzTwComm._isIDE()?"ide":bzTwComm._isExtension()?"ext":"app")
  },
  init:function(i){
    return this._init(i)
  },
  setRequest:function(v){
    if(bzTwComm._isIDE()&&BZ._closed){
      return
    }
    return bzTwComm._exeRequest(v)||1
  },
  _isIDE:function(){
    return window.name=="bz-master"&&!window.extensionContent
  },
  _isExtension:function(){
    return window.name!="bz-master"&&window.extensionContent
  },
  _isApp:function(){
    return bzTwComm._isTopApp()||bzTwComm.frameId
  },
  _isTopApp:function(){
    return window.name.includes("bz-client")
  },
  _getExtensionId:function(){
    return bzTwComm.bzExtensionId=bzTwComm.bzExtensionId||window.extensionContent||document.documentElement.getAttribute("bz-id")
  },
  _init:function(i){
    if(!bzTwComm.bzExtensionId){
      bzTwComm.bzExtensionId=bzTwComm._getExtensionId();
      if(!bzTwComm._isIDE()){
        bzTwComm.frameId=i||0
        console.log("_init comm .. "+window.extensionContent+":"+i)
        if(bzTwComm._isApp()){
         _TWHandler._takeoverAjax(window)
         _TWHandler._takeoverOpenWin()
         _TWHandler._takeoverCanvas()
        }
        console.log("monitor ...")
        console.log(bzTwComm._isExtension()?"ext":"app")
        bzTwComm._monitorInfo()

        if(bzTwComm._isExtension()){
          window.onhashchange=function(){
            bzTwComm._postToIDE({_fun:"_infoPageReady",_scope:"_extensionComm"})
          }

          setTimeout(function(){
            var as=document.getElementsByTagName("a");
            for(var i=0;i<as.length;i++){
              _Util._removeLinkTarget(as[i])
            }
          },100)
        }

        if(bzTwComm._isTopApp()){
          bzTwComm._postToIDE({_fun:"_setBZSent",_args:[{i:0,_root:1}],_scope:"_TWHandler"});
        }

        _postReady()
    
        function _postReady(){
          if(!window._domRecorder||(bzTwComm._isExtension()&&!window.curUser)||!bzTwComm.ideId||(bzTwComm._isExtension()&&(!window.BZ||!window._IDE||!window._IDE._data._setting||!window._IDE._data._setting.content))){
            bzTwComm._chkTime=bzTwComm._chkTime||Date.now()
            if(bzTwComm._isExtension()&&Date.now()-bzTwComm._chkTime>3000){
              bzTwComm._chkTime=0
              chrome.runtime.sendMessage({tg:"bg",reqData:1},r=>{
                if(!r){
                  console.log("Missing response: "+r)
                }
                BZ._setShareData(r)
              });
            }
            if(bzTwComm._isExtension()){
              window.createErrMark&&window.createErrMark("Page is not ready")
            }
            return setTimeout(()=>{
              _postReady()
            },100)
          }
          bzTwComm._chkTime=0
          bzTwComm.appReady=1
          window.removeErrMark&&window.removeErrMark()
          console.log("page is ready")
          if(bzTwComm._isExtension()){
            bzTwComm._postToIDE({_fun:"_infoPageReady",_scope:"_extensionComm"});
          }
        }
    
      }
    }
  },
  _monitorInfo:function(){
    //for content send code to app page
    if(!bzTwComm._infoObserver){
      bzTwComm._infoObserver= new MutationObserver(function(vs) {
        vs.forEach(function(v) {
          v=v.attributeName
          _handle(v)
        });
      })
      bzTwComm._infoObserver.observe(document.documentElement,{attributes: true});
      let os=document.documentElement.attributes
      for(let i=os.length-1;i>=0;i--){
        _handle(os[i].name)
      }
    }

    function _handle(v){
      if(v){
        bzTwComm._exeList.push(v)
      }
      if(!bzTwComm.appReady){
        return setTimeout(()=>{
          _handle()
        },10)
      }
      v=bzTwComm._exeList.shift()
  
      let d=document.documentElement.getAttribute(v)
      if(d){
        let vv=v.match(/^bz-to-(app|ext)-/)
        if(vv&&((vv[1]=="app"&&!bzTwComm._isExtension())||(vv[1]=="ext"&&bzTwComm._isExtension()))){
          document.documentElement.removeAttribute(v)
          try{
            d=JSON.parse(d)
            if(d.tg=="ide"){
              bzTwComm._postToIDE(d)
            }else{
              bzTwComm._exeRequest(d)
            }
          }catch(e){
            $util.log(JSON.stringify(d)+"\n\n"+e.stack)
          }
        }
      }
    }
  },
  _exeRequest:function(v){
    let r;
    if(v._scope){
      v._args=v._args||[]
      let d=_getPathData(v._scope+"."+v._fun)
      if(v._bkfun){
        let _idx=v._args.indexOf(v._bkfun)
        if(_idx>=0){
          v._args[_idx]=function(){
            _doCallback(...arguments)
          }
          return d.d[d.k](...v._args)
        }
      }
      if(!d.d[d.k]||d.d[d.k].constructor!=Function){
        console.log("Missing function")
        console.log(d)
        console.log(v)
      }
      r=d.d[d.k](...v._args)
    }else if(v.d){
      Object.keys(v.d).forEach(k=>{
        let vv=v.d[k],
            d=_getPathData(k)
        let o=d.d[d.k]
        if(!o||o.constructor!=Object||!vv||vv.constructor!=Object){
          d.d[d.k]=vv
        }else{
          Object.keys(vv).forEach(k=>{
            d.d[d.k]=vv[k]
          })
        }
      })
    }else{
      r=_Util._eval(v.c)
    }
    return _doCallback(r)

    function _doCallback(){
      if(v._bkfun){
        v={
          _scope:v._bkscope||"window",
          _fun:v._bkfun,
          _args:[...arguments],
          tg:v.bktg
        }
        bzTwComm._postRequest(v)
      }
      return arguments[0]
    }

    function _getPathData(k){
      let ks=k.split(".")
      k=ks.pop()
      let d=window
      ks.forEach(x=>{
        d=d[x]||{}
      })
      return {d:d,k:k}
    }
  },
  _postToApp:function(d){
    d.tg="app"
    bzTwComm._postRequest(d)
  },
  _postToGb:function(d){
    d.tg="bg"
    bzTwComm._postRequest(d)
  },
  //For recording alert/confirm message
  _postToIDE:function(d){
    d.tg="ide";
    bzTwComm._postRequest(d)
  },
  _postToExt:function(d){
    d.tg="ext";
    bzTwComm._postRequest(d)
  },
  _postToBg:function(d){
    d.tg="bg"
    bzTwComm._postRequest(d)
  },
  _postToPage:function(d){
    d.tg="app,ide"
    bzTwComm._postRequest(d)
  },
  _insertData:function(d){
    if(!document.body){
      return setTimeout(()=>{
        bzTwComm._insertData(d)
      },1)
    }
    var o = document.getElementById("bz-area");

    if(!o){
      o=document.createElement("div")
      o.id="bz-area"
      o.style.display="none"
      document.body.parentElement.append(o)
    }
    if(o){
      if(o.innerHTML){
        setTimeout(()=>{
          bzTwComm._insertData(d)
        },0)
      }else{
        o.innerText=JSON.stringify(d)
      }
    }
  }
};
if((window.name=="bz-master"&&!window.extensionContent)||(window.extensionContent&&window.name.includes("bz-client"))){
  bzTwComm._init()
};function initExtCode(i){
  if(!window._started){
    window._started=1
    if(!window.name.includes("bz-client")){
      bzTwComm._init(i)
    }
    _TWHandler.startInit();
    BZ._prepareDocument();
  }
}
if(window.name.includes("bz-client")){
  initExtCode()
};